# Milestone v1.5: Question and Exam UX

**Status:** ✅ SHIPPED 2026-02-19
**Phases:** 17
**Total Plans:** 7

## Overview

HC can manage multi-package test sets with Excel import, and workers take exams in a paged layout with per-user question/option randomization, pre-submit review, and ID-based grading. This milestone introduced a full package-based exam system on top of the existing assessment engine.

## Phases

### Phase 17: Question and Exam UX improvements

**Goal:** HC can manage multi-package test sets (with Excel import) and workers take exams in a paged layout with per-user question/option randomization, pre-submit review, and ID-based grading
**Depends on:** Phase 16 (v1.4 complete)
**Plans:** 7 plans

Plans:
- [x] 17-01: Data foundation: AssessmentPackage, PackageQuestion, PackageOption, UserPackageAssignment models + EF migration
- [x] 17-02: Package management UI: ManagePackages page (create/delete/preview), Packages button on manage view, HC preview of exam content
- [x] 17-03: Excel import: ImportPackageQuestions page with file upload and paste tabs (ClosedXML parser)
- [x] 17-04: Package assignment engine: StartExam GET extended with random package assignment + Fisher-Yates shuffle persistence
- [x] 17-05: Paged exam view: StartExam.cshtml redesigned with 10/page, Prev/Next, timer, collapsible panel, progress header
- [x] 17-06: Summary page + grading: ExamSummary view + SubmitExam updated for ID-based PackageOption grading
- [x] 17-07: Human verification: full HC + worker exam flow end-to-end

**Completed:** 2026-02-19

---

## Milestone Summary

**Key Decisions:**

- No Letter field on PackageOption — letters (A/B/C/D) are display-only at render time; grading uses PackageOption.Id
- UserPackageAssignment → AssessmentPackage FK uses Restrict (not Cascade) — assignments must survive package deletion post-exam
- Shuffle data stored as JSON strings on UserPackageAssignment, not as join table rows
- Unique index on UserPackageAssignment(AssessmentSessionId, UserId) — one assignment per session per user
- Radio buttons use `name=radio_{questionId}` separate from `name=answers[{questionId}]` hidden inputs — avoids double-submission on form POST
- Package path grading uses PackageOption.IsCorrect (ID-based) — UserResponse rows NOT inserted for package exams (FK constraint incompatibility with AssessmentQuestions table)
- TempData int/long unboxing switch pattern — CookieTempDataProvider deserializes JSON integers as long in .NET
- SubmitExam POST: if/else guards — package path and legacy path are mutually exclusive
- `id=page_@(page)` uses explicit parentheses to prevent Razor treating `@page` as a directive token
- Packages found via sibling session query (Title+Category+Schedule.Date) — packages are attached to representative session ID, not worker session ID
- Selected answer uses custom `.option-selected` class (not Bootstrap `.active`) — `.active` forces `color: white`, making text invisible

**Issues Resolved During Milestone:**

- Import Correct column format — parser originally required bare letter; extended to accept `D. text`, `OPTION D`, `d` (lowercase) via `ExtractCorrectLetter()` helper
- Packages not found for worker sessions — StartExam GET now queries sibling sessions by Title+Category+Schedule.Date before filtering packages
- Selected answer text invisible — Bootstrap `.active` class forced white text; replaced with custom `.option-selected` class

**Issues Deferred:**

- AllowAnswerReview not supported for package-based exams — UserResponse rows are not created for package path (FK constraint); answer review feature shows no responses for package exams
- CMPController is now ~2100+ lines — controller splitting deferred

**Technical Debt Incurred:**

- No UserResponse records for package exams — AllowAnswerReview feature is silently non-functional for package-based assessments; future milestone should add PackageUserResponse table or adjust AllowAnswerReview to work with PackageOption references
- Shuffle is re-randomized if UserPackageAssignment is deleted — no UI to manually re-assign; edge case with no workaround

---

*For current project status, see .planning/ROADMAP.md*
