---
phase: 42-session-resume
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Models/AssessmentSession.cs
  - Models/UserPackageAssignment.cs
  - Data/ApplicationDbContext.cs
autonomous: true

must_haves:
  truths:
    - "AssessmentSession table has ElapsedSeconds (int, default 0) and LastActivePage (int?, default null) columns in the database"
    - "UserPackageAssignment table has SavedQuestionCount (int?) column in the database"
    - "EF migration succeeds and dotnet build compiles with no errors"
  artifacts:
    - path: "Models/AssessmentSession.cs"
      provides: "ElapsedSeconds and LastActivePage fields"
      contains: "ElapsedSeconds"
    - path: "Models/UserPackageAssignment.cs"
      provides: "SavedQuestionCount field"
      contains: "SavedQuestionCount"
    - path: "Migrations/"
      provides: "AddSessionResumeFields migration"
      contains: "ElapsedSeconds"
  key_links:
    - from: "Models/AssessmentSession.cs"
      to: "Migrations/*_AddSessionResumeFields.cs"
      via: "dotnet ef migrations add"
      pattern: "ElapsedSeconds"
    - from: "Models/UserPackageAssignment.cs"
      to: "Migrations/*_AddSessionResumeFields.cs"
      via: "dotnet ef migrations add"
      pattern: "SavedQuestionCount"
---

<objective>
Add three new database fields required for session resume: ElapsedSeconds and LastActivePage on AssessmentSession (to track active exam time and last visited page), and SavedQuestionCount on UserPackageAssignment (to detect stale question sets on resume). Create and apply the EF migration.

Purpose: Phase 42 resume logic depends on these fields existing in the database before any endpoint or frontend code can use them.
Output: Updated model files + applied migration. AssessmentSessions and UserPackageAssignments tables have the new columns.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-session-resume/42-CONTEXT.md
@.planning/phases/42-session-resume/42-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ElapsedSeconds and LastActivePage to AssessmentSession</name>
  <files>Models/AssessmentSession.cs</files>
  <action>
Open Models/AssessmentSession.cs. Add two new properties after the existing `StartedAt` field (around line 37):

```csharp
/// <summary>
/// Total seconds the worker has actively spent in the exam (excludes offline time).
/// Updated on each page navigation and every 30 seconds via frontend polling.
/// Default 0 on session start.
/// </summary>
public int ElapsedSeconds { get; set; } = 0;

/// <summary>
/// Last page (0-based index) the worker was viewing before disconnect.
/// Null = never navigated (still on page 0). Used to resume on correct page.
/// </summary>
public int? LastActivePage { get; set; }
```

Place them immediately after `public DateTime? StartedAt { get; set; }` and before the ExamWindowCloseDate property. No other changes to the file.
  </action>
  <verify>Read Models/AssessmentSession.cs and confirm both properties exist with correct types (int with default 0, int? nullable). Check the file still compiles: `dotnet build C:/Users/rinoa/Desktop/PortalHC_KPB/PortalHC_KPB.csproj --no-restore 2>&1 | tail -5`</verify>
  <done>AssessmentSession.cs contains `public int ElapsedSeconds { get; set; } = 0;` and `public int? LastActivePage { get; set; }`. Build succeeds with 0 errors.</done>
</task>

<task type="auto">
  <name>Task 2: Add SavedQuestionCount to UserPackageAssignment and run migration</name>
  <files>Models/UserPackageAssignment.cs, Migrations/ (new file generated by dotnet ef)</files>
  <action>
**Step 1 — Add field to UserPackageAssignment:**

Open Models/UserPackageAssignment.cs. Add after the `IsCompleted` field (around line 43):

```csharp
/// <summary>
/// Number of questions in the assigned package at the time of first exam load.
/// Used on resume to detect stale question sets (HC changed package after session started).
/// Null = not yet recorded (sessions started before Phase 42).
/// </summary>
public int? SavedQuestionCount { get; set; }
```

No other changes to the file.

**Step 2 — Run migration:**

```bash
cd C:/Users/rinoa/Desktop/PortalHC_KPB && dotnet ef migrations add AddSessionResumeFields
```

This generates a migration file in Migrations/ with Up() adding columns:
- `ElapsedSeconds` (int, not null, defaultValue: 0) on AssessmentSessions
- `LastActivePage` (int, nullable) on AssessmentSessions
- `SavedQuestionCount` (int, nullable) on UserPackageAssignments

**Step 3 — Apply migration:**

```bash
cd C:/Users/rinoa/Desktop/PortalHC_KPB && dotnet ef database update
```

Verify it reports "Done" or "No pending migrations".
  </action>
  <verify>
1. Read Models/UserPackageAssignment.cs — confirms `SavedQuestionCount` property exists.
2. Run: `ls C:/Users/rinoa/Desktop/PortalHC_KPB/Migrations/ | grep AddSessionResume` — confirms migration file created.
3. Run: `dotnet build C:/Users/rinoa/Desktop/PortalHC_KPB/PortalHC_KPB.csproj --no-restore 2>&1 | tail -5` — 0 errors.
4. Run: `cd C:/Users/rinoa/Desktop/PortalHC_KPB && dotnet ef migrations list 2>&1 | tail -3` — AddSessionResumeFields shows as applied.
  </verify>
  <done>UserPackageAssignment.cs has SavedQuestionCount (int?). Migration AddSessionResumeFields is applied. Build succeeds with 0 errors. Database has the three new columns.</done>
</task>

</tasks>

<verification>
- `dotnet build` exits 0 with no errors
- `dotnet ef migrations list` shows AddSessionResumeFields as applied (no pending)
- Read Models/AssessmentSession.cs: contains `ElapsedSeconds` and `LastActivePage`
- Read Models/UserPackageAssignment.cs: contains `SavedQuestionCount`
- Grep Migrations/ for "ElapsedSeconds" confirms column added in migration Up()
</verification>

<success_criteria>
Three new nullable/defaulted columns in place in both models and database. Build green. Phase 42 backend implementation (Plan 02) can proceed immediately.
</success_criteria>

<output>
After completion, create `.planning/phases/42-session-resume/42-01-SUMMARY.md`
</output>
