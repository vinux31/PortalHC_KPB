---
phase: 45-cross-package-per-position-shuffle
plan: 02
type: execute
wave: 2
depends_on: ["45-01"]
files_modified:
  - Controllers/CMPController.cs
autonomous: true

must_haves:
  truths:
    - "StartExam renders questions using IDs from ShuffledQuestionIds — questions may come from different packages"
    - "Options are rendered in original DB order (q.Options.OrderBy(o => o.Id)) — no ShuffledOptionIdsPerQuestion lookup"
    - "SubmitExam grades all questions in ShuffledQuestionIds, spanning multiple packages"
    - "ExamSummary shows all questions by ShuffledQuestionIds order, spanning multiple packages"
    - "Results page loads questions by ShuffledQuestionIds IDs, spanning multiple packages"
    - "CloseEarly (force-complete) grades by loading questions from ShuffledQuestionIds IDs"
  artifacts:
    - path: "Controllers/CMPController.cs"
      provides: "Fixed StartExam ViewModel build + SubmitExam grading + ExamSummary + Results + CloseEarly"
      contains: "allPackageQuestions"
  key_links:
    - from: "StartExam ViewModel build (lines ~2912-2946)"
      to: "PackageQuestions across all sibling packages"
      via: "Load ALL sibling packages' questions then lookup by ID from ShuffledQuestionIds"
      pattern: "allPackageQuestions.*ToDictionary"
    - from: "SubmitExam package path (lines ~3362-3467)"
      to: "PackageQuestions loaded by ID from ShuffledQuestionIds"
      via: "Replace AssessmentPackageId filter with ID-based load"
      pattern: "shuffledIds.*Contains"
    - from: "ExamSummary package path (lines ~3171-3204)"
      to: "PackageQuestions loaded by ID"
      via: "Replace AssessmentPackageId filter with ID lookup"
      pattern: "shuffledQIds.*Contains"
    - from: "Results package path (lines ~3691-3758)"
      to: "PackageQuestions loaded by ShuffledQuestionIds IDs"
      via: "Replace AssessmentPackageId filter with ID-based load"
      pattern: "shuffledQuestionIds.*Contains"
    - from: "CloseEarly package path (lines ~862-894)"
      to: "PackageQuestions loaded per-session by ShuffledQuestionIds"
      via: "Load by question IDs from assignment.GetShuffledQuestionIds()"
      pattern: "GetShuffledQuestionIds"
---

<objective>
Fix all five consumers of UserPackageAssignment that currently load questions filtered by `AssessmentPackageId` — they must instead load questions by the specific IDs stored in `ShuffledQuestionIds` (which now spans multiple packages after Plan 01).

Purpose: After Plan 01, ShuffledQuestionIds contains IDs from multiple packages. Any code that loads `PackageQuestions.Where(q => q.AssessmentPackageId == assignment.AssessmentPackageId)` will miss questions from other packages and produce wrong exam display, wrong grading, and wrong results.

Output: Five consumers updated in CMPController.cs — all load questions by ID set from ShuffledQuestionIds.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Controllers/CMPController.cs
@Models/UserPackageAssignment.cs
@.planning/phases/45-cross-package-per-position-shuffle/45-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix StartExam ViewModel build + CloseEarly force-complete</name>
  <files>Controllers/CMPController.cs</files>
  <action>
**Fix 1 — StartExam ViewModel build** (lines ~2912–2946):

The current code loads questions only from the assigned package:
```csharp
var assignedPackage = packages.First(p => p.Id == assignment.AssessmentPackageId);
var questionLookup = assignedPackage.Questions.ToDictionary(q => q.Id);
var optionLookup = assignedPackage.Questions
    .SelectMany(q => q.Options)
    .ToDictionary(o => o.Id);
```

Replace with a lookup across ALL sibling packages (the `packages` list already has all sibling packages loaded with Questions+Options from the StartExam query at lines ~2838–2841):

```csharp
// Cross-package: build lookup across all packages (ShuffledQuestionIds may reference any package)
var allPackageQuestions = packages.SelectMany(p => p.Questions).ToDictionary(q => q.Id);
var allPackageOptions = packages.SelectMany(p => p.Questions).SelectMany(q => q.Options).ToDictionary(o => o.Id);
```

Then in the foreach loop building `examQuestions`, replace:
```csharp
if (!questionLookup.TryGetValue(qId, out var q)) continue;

var orderedOptIds = shuffledOptionIds.TryGetValue(qId, out var optIds)
    ? optIds
    : q.Options.Select(o => o.Id).ToList();

var opts = orderedOptIds
    .Where(oid => optionLookup.ContainsKey(oid))
    .Select(oid => new ExamOptionItem
    {
        OptionId = optionLookup[oid].Id,
        OptionText = optionLookup[oid].OptionText
    }).ToList();
```

with:
```csharp
if (!allPackageQuestions.TryGetValue(qId, out var q)) continue;

// Options in original DB order — option shuffle removed per user decision
var opts = q.Options.OrderBy(o => o.Id).Select(o => new ExamOptionItem
{
    OptionId = o.Id,
    OptionText = o.OptionText
}).ToList();
```

Also remove the `var shuffledOptionIds = assignment.GetShuffledOptionIds();` line (no longer needed).

**Fix 2 — CloseEarly force-complete package path** (lines ~862–894):

The current code loads the package from `packageMap[assignment.AssessmentPackageId]` and iterates `pkg.Questions`. The problem: `packageMap` is built from `assignments.Select(a => a.AssessmentPackageId).Distinct()`, so it only contains the sentinel package. Questions from other packages are missing.

Locate the block inside `CloseEarly` at Step 3:
```csharp
var packageIds = assignments.Select(a => a.AssessmentPackageId).Distinct().ToList();
var packages = await _context.AssessmentPackages
    .Include(p => p.Questions)
        .ThenInclude(q => q.Options)
    .Where(p => packageIds.Contains(p.Id))
    .ToListAsync();
foreach (var p in packages)
    packageMap[p.Id] = p;
```

Replace with loading ALL sibling packages (not just the sentinel ones):
```csharp
// Load ALL sibling packages (cross-package: ShuffledQuestionIds may reference any package)
var allSiblingPackages = await _context.AssessmentPackages
    .Include(p => p.Questions)
        .ThenInclude(q => q.Options)
    .Where(p => siblingIds.Contains(p.AssessmentSessionId))
    .ToListAsync();
// Build a flat question lookup by ID (spans all packages)
var allQuestionLookup = allSiblingPackages
    .SelectMany(p => p.Questions)
    .ToDictionary(q => q.Id);
```

Then, inside the force-complete loop where it currently does:
```csharp
if (!sessionAssignmentMap.TryGetValue(session.Id, out var assignment)) continue;
if (!packageMap.TryGetValue(assignment.AssessmentPackageId, out var pkg)) continue;

var responses = await _context.PackageUserResponses...
int totalScore = 0;
int maxScore = pkg.Questions.Sum(q => q.ScoreValue);

foreach (var q in pkg.Questions)
{
    if (responses.TryGetValue(q.Id, out var optId) && optId.HasValue)
    ...
}
```

Replace with:
```csharp
if (!sessionAssignmentMap.TryGetValue(session.Id, out var assignment)) continue;

// Get question IDs from this worker's assignment (cross-package)
var sessionShuffledIds = assignment.GetShuffledQuestionIds();
if (!sessionShuffledIds.Any()) continue;

var responses = await _context.PackageUserResponses
    .Where(r => r.AssessmentSessionId == session.Id)
    .ToDictionaryAsync(r => r.PackageQuestionId, r => r.PackageOptionId);

int totalScore = 0;
int maxScore = 0;

foreach (var qId in sessionShuffledIds)
{
    if (!allQuestionLookup.TryGetValue(qId, out var q)) continue;
    maxScore += q.ScoreValue;
    if (responses.TryGetValue(q.Id, out var optId) && optId.HasValue)
    {
        var selectedOption = q.Options.FirstOrDefault(o => o.Id == optId.Value);
        if (selectedOption != null && selectedOption.IsCorrect)
            totalScore += q.ScoreValue;
    }
}
```

Remove the `packageMap` variable (and `packageIds` variable) since they are no longer used. Also remove the old `var packageIds = assignments.Select(a => a.AssessmentPackageId).Distinct().ToList()` and `foreach (var p in packages) packageMap[p.Id] = p;` lines. Replace the `Dictionary<int, AssessmentPackage> packageMap = new();` declaration with `Dictionary<int, UserPackageAssignment> sessionAssignmentMap = new();` only (keep sessionAssignmentMap).
  </action>
  <verify>
`dotnet build` — zero errors.
Search for `assignedPackage.Questions.ToDictionary` — should NOT appear in StartExam ViewModel build.
Search for `allPackageQuestions` — appears in StartExam.
Search for `allQuestionLookup` — appears in CloseEarly.
Search for `GetShuffledOptionIds` — should NOT appear in StartExam (removed).
  </verify>
  <done>
StartExam renders questions from all packages using allPackageQuestions lookup. Options rendered in DB order (OrderBy Id). CloseEarly grades by iterating sessionShuffledIds against allQuestionLookup. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix SubmitExam, ExamSummary, and Results consumers</name>
  <files>Controllers/CMPController.cs</files>
  <action>
**Fix 3 — SubmitExam package path** (lines ~3362–3467):

Current code:
```csharp
var packageQuestions = await _context.PackageQuestions
    .Include(q => q.Options)
    .Where(q => q.AssessmentPackageId == packageAssignment.AssessmentPackageId)
    .ToListAsync();

int totalScore = 0;
int maxScore = packageQuestions.Count * 10;

foreach (var q in packageQuestions)
{
    int? selectedOptId = answers.ContainsKey(q.Id) ? answers[q.Id] : (int?)null;
    ...
}
```

Replace with:
```csharp
// Cross-package: load questions by IDs from ShuffledQuestionIds (spans multiple packages)
var shuffledIds = packageAssignment.GetShuffledQuestionIds();
var packageQuestions = await _context.PackageQuestions
    .Include(q => q.Options)
    .Where(q => shuffledIds.Contains(q.Id))
    .ToListAsync();
var questionLookupById = packageQuestions.ToDictionary(q => q.Id);

int totalScore = 0;
int maxScore = shuffledIds.Sum(qId =>
    questionLookupById.TryGetValue(qId, out var qq) ? qq.ScoreValue : 0);

foreach (var qId in shuffledIds)
{
    if (!questionLookupById.TryGetValue(qId, out var q)) continue;
    int? selectedOptId = answers.ContainsKey(q.Id) ? answers[q.Id] : (int?)null;

    if (selectedOptId.HasValue)
    {
        var selectedOption = q.Options.FirstOrDefault(o => o.Id == selectedOptId.Value);
        if (selectedOption != null && selectedOption.IsCorrect)
            totalScore += q.ScoreValue;
    }

    // Persist answer for package-based answer review (upsert)
    var existingResponse = await _context.PackageUserResponses
        .FirstOrDefaultAsync(r => r.AssessmentSessionId == id && r.PackageQuestionId == q.Id);
    if (existingResponse != null)
    {
        existingResponse.PackageOptionId = selectedOptId;
        existingResponse.SubmittedAt = DateTime.UtcNow;
    }
    else
    {
        _context.PackageUserResponses.Add(new PackageUserResponse
        {
            AssessmentSessionId = id,
            PackageQuestionId = q.Id,
            PackageOptionId = selectedOptId,
            SubmittedAt = DateTime.UtcNow
        });
    }
}

int finalPercentage = maxScore > 0 ? (int)((double)totalScore / maxScore * 100) : 0;
```

Note: `int maxScore = packageQuestions.Count * 10` is removed — replaced with `shuffledIds.Sum(...)` which correctly handles ScoreValue per question.

**Fix 4 — ExamSummary package path** (lines ~3175–3204):

Current code:
```csharp
var questions = await _context.PackageQuestions
    .Include(q => q.Options)
    .Where(q => q.AssessmentPackageId == assignment.AssessmentPackageId)
    .ToListAsync();

var qLookup = questions.ToDictionary(q => q.Id);
var optLookup = questions.SelectMany(q => q.Options).ToDictionary(o => o.Id);
```

Replace with:
```csharp
// Cross-package: load questions by IDs from ShuffledQuestionIds
var shuffledQIds = assignment.GetShuffledQuestionIds();
var questions = await _context.PackageQuestions
    .Include(q => q.Options)
    .Where(q => shuffledQIds.Contains(q.Id))
    .ToListAsync();

var qLookup = questions.ToDictionary(q => q.Id);
var optLookup = questions.SelectMany(q => q.Options).ToDictionary(o => o.Id);
```

Note: The existing `var shuffledQIds = assignment.GetShuffledQuestionIds();` call at the top of this block can be kept as-is. Remove the old `var shuffledQIds =` line if it was already there and reuse it for the Where clause.

**Fix 5 — Results package path** (lines ~3691–3710):

Current code:
```csharp
var packageQuestions = await _context.PackageQuestions
    .Include(q => q.Options)
    .Where(q => q.AssessmentPackageId == packageAssignment.AssessmentPackageId)
    .OrderBy(q => q.Order)
    .ToListAsync();
```

Replace with:
```csharp
// Cross-package: load questions by IDs from ShuffledQuestionIds
var shuffledQuestionIds = packageAssignment.GetShuffledQuestionIds();
var packageQuestions = await _context.PackageQuestions
    .Include(q => q.Options)
    .Where(q => shuffledQuestionIds.Contains(q.Id))
    .ToListAsync();
```

Then where Results uses `shuffledQuestionIds` further down:
```csharp
var questionLookup = packageQuestions.ToDictionary(q => q.Id);

// If shuffled IDs are empty (edge case), fall back to natural order
var orderedQuestionIds = shuffledQuestionIds.Any()
    ? shuffledQuestionIds.Where(qid => questionLookup.ContainsKey(qid)).ToList()
    : packageQuestions.Select(q => q.Id).ToList();
```

This already uses `shuffledQuestionIds` (the variable name), so it will correctly reference the cross-package IDs. Remove `.OrderBy(q => q.Order)` from the DB query (order comes from ShuffledQuestionIds list, not DB Order column).
  </action>
  <verify>
`dotnet build` — zero errors.
Search for `.Where(q => q.AssessmentPackageId == packageAssignment.AssessmentPackageId)` — should NOT appear in SubmitExam or Results.
Search for `.Where(q => q.AssessmentPackageId == assignment.AssessmentPackageId)` — should NOT appear in ExamSummary.
Search for `shuffledIds.Contains(q.Id)` — appears in SubmitExam.
Search for `shuffledQIds.Contains(q.Id)` — appears in ExamSummary.
Search for `shuffledQuestionIds.Contains(q.Id)` — appears in Results.
  </verify>
  <done>
SubmitExam grades all questions from ShuffledQuestionIds IDs (multi-package). ExamSummary shows questions from ShuffledQuestionIds IDs. Results loads questions from ShuffledQuestionIds IDs. All three use ID-based WHERE clauses, not AssessmentPackageId filter. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` passes with no errors.
2. No occurrence of `.Where(q => q.AssessmentPackageId == packageAssignment.AssessmentPackageId)` in SubmitExam, ExamSummary, or Results sections.
3. No occurrence of `assignment.GetShuffledOptionIds()` in StartExam ViewModel build (option shuffle removed).
4. All five consumers (StartExam ViewModel, CloseEarly, SubmitExam, ExamSummary, Results) use ID-based question loading.
</verification>

<success_criteria>
- StartExam exam page renders questions from the cross-package ShuffledQuestionIds list, options in DB order.
- SubmitExam grades using all question IDs from ShuffledQuestionIds (multi-package coverage).
- ExamSummary and Results both load questions by ShuffledQuestionIds IDs.
- CloseEarly force-grades by iterating per-session ShuffledQuestionIds against allQuestionLookup.
- Build passes.
</success_criteria>

<output>
After completion, create `.planning/phases/45-cross-package-per-position-shuffle/45-02-SUMMARY.md`
</output>
