---
phase: 46-attempt-history
plan: 02
type: execute
wave: 2
depends_on:
  - 46-01
files_modified:
  - Models/AllWorkersHistoryRow.cs
  - Models/RecordsWorkerListViewModel.cs
  - Controllers/CMPController.cs
  - Views/CMP/RecordsWorkerList.cshtml
autonomous: true
requirements:
  - HIST-02
  - HIST-03
must_haves:
  truths:
    - "History tab at /CMP/Records contains two sub-tabs: Riwayat Assessment and Riwayat Training"
    - "Riwayat Assessment shows both archived AttemptHistory rows AND current completed AssessmentSessions in one unified table"
    - "Attempt # column shows sequential per-worker per-title number (archived rows have stored number; current session shows count+1)"
    - "Riwayat Assessment has a worker name/NIP search input and an assessment title dropdown filter, both combinable"
    - "Rows within Riwayat Assessment are grouped by assessment title, then sorted date descending"
    - "Riwayat Training shows existing training records content unchanged"
    - "Table columns are: Nama Pekerja, NIP, Assessment Title, Attempt #, Score, Pass/Fail, Tanggal"
  artifacts:
    - path: "Models/AllWorkersHistoryRow.cs"
      provides: "Extended with AttemptNumber property"
      contains: "public int? AttemptNumber"
    - path: "Models/RecordsWorkerListViewModel.cs"
      provides: "Separate lists for AssessmentHistory and TrainingHistory"
      contains: "AssessmentHistory"
    - path: "Controllers/CMPController.cs"
      provides: "GetAllWorkersHistory() split into assessment+training; batch Attempt # computation"
      contains: "AssessmentAttemptHistory"
    - path: "Views/CMP/RecordsWorkerList.cshtml"
      provides: "History tab replaced with 2 Bootstrap sub-tabs; assessment table with filters"
      contains: "riwayat-assessment-pane"
  key_links:
    - from: "Controllers/CMPController.cs GetAllWorkersHistory()"
      to: "_context.AssessmentAttemptHistory"
      via: "Query archived rows; batch count existing archives per user+title"
      pattern: "AssessmentAttemptHistory"
    - from: "Views/CMP/RecordsWorkerList.cshtml"
      to: "Model.AssessmentHistory + Model.TrainingHistory"
      via: "Separate foreach loops in sub-tab panes"
      pattern: "Model\\.AssessmentHistory"
    - from: "Riwayat Assessment filter inputs"
      to: "table rows"
      via: "JavaScript client-side filter on tr elements"
      pattern: "workerFilter|assessmentFilter"
---

<objective>
Extend models and the GetAllWorkersHistory() helper to surface archived attempts + current completed sessions with batch Attempt # computation, then replace the History tab UI with two sub-tabs: Riwayat Assessment (with filters) and Riwayat Training (existing content moved).

Purpose: Delivers the HC/Admin view of complete attempt history per worker per assessment.
Output: Upgraded History tab at /CMP/Records with two sub-tabs and all required columns.
</objective>

<execution_context>
@C:/Users/Administrator/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Administrator/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-attempt-history/46-01-SUMMARY.md

<interfaces>
<!-- Extracted from codebase. No exploration needed. -->

From Models/AllWorkersHistoryRow.cs (current, to be extended):
```csharp
public class AllWorkersHistoryRow
{
    public string WorkerName { get; set; } = "";
    public string? WorkerNIP { get; set; }
    public string RecordType { get; set; } = "";
    public string Title { get; set; } = "";
    public DateTime Date { get; set; }
    public string? Penyelenggara { get; set; }
    public int? Score { get; set; }
    public bool? IsPassed { get; set; }
    // ADD: public int? AttemptNumber { get; set; }
}
```

From Models/RecordsWorkerListViewModel.cs (current):
```csharp
public class RecordsWorkerListViewModel
{
    public List<WorkerTrainingStatus> Workers { get; set; } = new();
    public List<AllWorkersHistoryRow> History { get; set; } = new();
    // SPLIT: History becomes AssessmentHistory + TrainingHistory
}
```

From Controllers/CMPController.cs — GetAllWorkersHistory() (current, lines 2622-2661):
- Query 1: AssessmentSessions where Status=Completed → project to AllWorkersHistoryRow (RecordType="Assessment Online")
- Query 2: All TrainingRecords → project to AllWorkersHistoryRow (RecordType="Manual")
- Returns combined list sorted by Date descending
- REPLACE with separate method returning (assessmentRows, trainingRows)

From Controllers/CMPController.cs — Records action (line ~2308-2314):
```csharp
return View("RecordsWorkerList", new RecordsWorkerListViewModel
{
    Workers = workers,
    History = await GetAllWorkersHistory()
});
```
Must be updated to use new ViewModel shape.

From AssessmentAttemptHistory model (created in Plan 01):
```csharp
public int Id { get; set; }
public int SessionId { get; set; }
public string UserId { get; set; }
public ApplicationUser? User { get; set; }
public string Title { get; set; }
public string Category { get; set; }
public int? Score { get; set; }
public bool? IsPassed { get; set; }
public DateTime? StartedAt { get; set; }
public DateTime? CompletedAt { get; set; }
public int AttemptNumber { get; set; }
public DateTime ArchivedAt { get; set; }
```

From Views/CMP/RecordsWorkerList.cshtml — current History tab pane (lines 284-361):
- Outer tab pane: `<div class="tab-pane fade" id="history-tab-pane" ...>`
- Currently renders one unified table using `@foreach (var row in Model.History)`
- Columns: Nama Pekerja, Nopeg, Tipe, Judul/Nama Pelatihan, Tanggal Mulai, Penyelenggara, Nilai, Pass/Fail
- History tab badge uses `@Model.History.Count`

Current History tab trigger button (line 64-69):
```html
<button class="nav-link" id="history-tab" data-bs-toggle="tab"
        data-bs-target="#history-tab-pane" ...>
    <i class="bi bi-clock-history me-1"></i> History
    <span class="badge bg-secondary ms-1">@Model.History.Count</span>
</button>
```
Tab button badge must be updated to `@(Model.AssessmentHistory.Count + Model.TrainingHistory.Count)`.

JavaScript tab persistence (line ~622-630):
`document.getElementById('history-tab')` and `?activeTab=history` — keep unchanged (outer tab id stays "history-tab").
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend models and rewrite GetAllWorkersHistory() with unified assessment query</name>
  <files>
    Models/AllWorkersHistoryRow.cs
    Models/RecordsWorkerListViewModel.cs
    Controllers/CMPController.cs
  </files>
  <action>
**Step A — Models/AllWorkersHistoryRow.cs:**
Add `AttemptNumber` property:
```csharp
// Phase 46: Attempt sequencing for Riwayat Assessment sub-tab
public int? AttemptNumber { get; set; }
```

**Step B — Models/RecordsWorkerListViewModel.cs:**
Replace `History` list with two separate lists:
```csharp
public class RecordsWorkerListViewModel
{
    public List<WorkerTrainingStatus> Workers { get; set; } = new();

    // Phase 46: Split History into Assessment + Training sub-tabs
    public List<AllWorkersHistoryRow> AssessmentHistory { get; set; } = new();
    public List<AllWorkersHistoryRow> TrainingHistory { get; set; } = new();

    // Distinct assessment titles for the filter dropdown
    public List<string> AssessmentTitles { get; set; } = new();
}
```

**Step C — Controllers/CMPController.cs:**

Replace the existing `GetAllWorkersHistory()` method (private async Task<List<AllWorkersHistoryRow>>) with a new private method returning both lists via a tuple. Also update the Records action that calls it.

New private method (replace old one entirely):
```csharp
// Phase 46: Split all-workers history into assessment and training — supports Attempt # computation
private async Task<(List<AllWorkersHistoryRow> assessment, List<AllWorkersHistoryRow> training)> GetAllWorkersHistory()
{
    // --- Assessment history ---

    // Batch count archived attempts per user+title to avoid N+1
    var archivedCounts = await _context.AssessmentAttemptHistory
        .GroupBy(h => new { h.UserId, h.Title })
        .Select(g => new { g.Key.UserId, g.Key.Title, Count = g.Count() })
        .ToListAsync();

    var archivedCountLookup = archivedCounts
        .ToDictionary(x => (x.UserId, x.Title), x => x.Count);

    // Query 1: Archived attempts (AttemptNumber already stored)
    var archivedAttempts = await _context.AssessmentAttemptHistory
        .Include(h => h.User)
        .ToListAsync();

    var assessmentRows = new List<AllWorkersHistoryRow>();

    assessmentRows.AddRange(archivedAttempts.Select(h => new AllWorkersHistoryRow
    {
        WorkerName    = h.User?.FullName ?? h.UserId,
        WorkerNIP     = h.User?.NIP,
        RecordType    = "Assessment Online",
        Title         = h.Title,
        Date          = h.CompletedAt ?? h.StartedAt ?? h.ArchivedAt,
        Score         = h.Score,
        IsPassed      = h.IsPassed,
        AttemptNumber = h.AttemptNumber
    }));

    // Query 2: Current completed sessions (Attempt # = archived count for that user+title + 1)
    var currentCompleted = await _context.AssessmentSessions
        .Include(a => a.User)
        .Where(a => a.Status == "Completed")
        .ToListAsync();

    assessmentRows.AddRange(currentCompleted.Select(a =>
    {
        var key = (a.UserId, a.Title ?? "");
        int archived = archivedCountLookup.TryGetValue(key, out var c) ? c : 0;
        return new AllWorkersHistoryRow
        {
            WorkerName    = a.User?.FullName ?? a.UserId,
            WorkerNIP     = a.User?.NIP,
            RecordType    = "Assessment Online",
            Title         = a.Title ?? "",
            Date          = a.CompletedAt ?? a.Schedule,
            Score         = a.Score,
            IsPassed      = a.IsPassed,
            AttemptNumber = archived + 1
        };
    }));

    // Sort: grouped by title then date descending
    assessmentRows = assessmentRows
        .OrderBy(r => r.Title)
        .ThenByDescending(r => r.Date)
        .ToList();

    // --- Training history ---
    var trainings = await _context.TrainingRecords
        .Include(t => t.User)
        .ToListAsync();

    var trainingRows = trainings.Select(t => new AllWorkersHistoryRow
    {
        WorkerName    = t.User?.FullName ?? t.UserId,
        WorkerNIP     = t.User?.NIP,
        RecordType    = "Manual",
        Title         = t.Judul ?? "",
        Date          = t.TanggalMulai ?? t.Tanggal,
        Penyelenggara = t.Penyelenggara
    })
    .OrderByDescending(r => r.Date)
    .ToList();

    return (assessmentRows, trainingRows);
}
```

Update the Records action call (the single place that calls GetAllWorkersHistory — around line 2308):
```csharp
var (assessmentHistory, trainingHistory) = await GetAllWorkersHistory();

return View("RecordsWorkerList", new RecordsWorkerListViewModel
{
    Workers           = workers,
    AssessmentHistory = assessmentHistory,
    TrainingHistory   = trainingHistory,
    AssessmentTitles  = assessmentHistory
        .Select(r => r.Title)
        .Where(t => !string.IsNullOrEmpty(t))
        .Distinct()
        .OrderBy(t => t)
        .ToList()
});
```

Note: Search for the old call with `History = await GetAllWorkersHistory()` to find the exact location.
  </action>
  <verify>
    dotnet build (0 errors). Any compile error about Model.History in the view is expected and fixed in Task 2.
  </verify>
  <done>Models extended; ViewModel has AssessmentHistory + TrainingHistory + AssessmentTitles; GetAllWorkersHistory() returns tuple; build passes (view errors acceptable until Task 2)</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite History tab in RecordsWorkerList.cshtml with two sub-tabs</name>
  <files>
    Views/CMP/RecordsWorkerList.cshtml
  </files>
  <action>
Make two targeted edits to RecordsWorkerList.cshtml:

**Edit 1 — History tab badge (line ~68):**
Change `@Model.History.Count` to `@(Model.AssessmentHistory.Count + Model.TrainingHistory.Count)`.

**Edit 2 — Replace entire History tab pane content** (the block from `<!-- History Tab Pane (Phase 40) -->` through its closing `</div>` at line ~361):

Replace with:
```html
<!-- History Tab Pane (Phase 46) — split into Riwayat Assessment + Riwayat Training -->
<div class="tab-pane fade" id="history-tab-pane" role="tabpanel" aria-labelledby="history-tab">

    <!-- Nested Sub-Tabs -->
    <ul class="nav nav-tabs mb-3" id="historySubTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="riwayat-assessment-tab" data-bs-toggle="tab"
                    data-bs-target="#riwayat-assessment-pane" type="button" role="tab">
                <i class="bi bi-file-text me-1"></i> Riwayat Assessment
                <span class="badge bg-secondary ms-1">@Model.AssessmentHistory.Count</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="riwayat-training-tab" data-bs-toggle="tab"
                    data-bs-target="#riwayat-training-pane" type="button" role="tab">
                <i class="bi bi-book me-1"></i> Riwayat Training
                <span class="badge bg-secondary ms-1">@Model.TrainingHistory.Count</span>
            </button>
        </li>
    </ul>

    <div class="tab-content" id="historySubTabsContent">

        <!-- Riwayat Assessment Sub-Tab -->
        <div class="tab-pane fade show active" id="riwayat-assessment-pane" role="tabpanel">

            @if (!Model.AssessmentHistory.Any())
            {
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-inbox fs-1 d-block mb-3"></i>
                    <h5>Belum ada riwayat assessment</h5>
                    <p class="small">Data akan muncul setelah ada sesi assessment yang diselesaikan atau direset.</p>
                </div>
            }
            else
            {
                <!-- Filters -->
                <div class="row g-2 mb-3 pt-3 px-3">
                    <div class="col-md-4">
                        <input type="text" class="form-control form-control-sm" placeholder="Cari nama pekerja / NIP..."
                               id="assessmentWorkerFilter" oninput="filterAssessmentRows()">
                    </div>
                    <div class="col-md-4">
                        <select class="form-select form-select-sm" id="assessmentTitleFilter" onchange="filterAssessmentRows()">
                            <option value="">-- Semua Assessment --</option>
                            @foreach (var title in Model.AssessmentTitles)
                            {
                                <option value="@title">@title</option>
                            }
                        </select>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="assessmentHistoryTable">
                        <thead class="sticky-header">
                            <tr>
                                <th class="p-3">Nama Pekerja</th>
                                <th class="p-3">NIP</th>
                                <th class="p-3">Assessment Title</th>
                                <th class="p-3 text-center">Attempt #</th>
                                <th class="p-3 text-center">Score</th>
                                <th class="p-3 text-center">Pass/Fail</th>
                                <th class="p-3">Tanggal</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var row in Model.AssessmentHistory)
                            {
                                <tr class="assessment-history-row"
                                    data-worker="@row.WorkerName.ToLower() @(row.WorkerNIP?.ToLower() ?? "")"
                                    data-title="@row.Title">
                                    <td class="p-3 fw-semibold">@row.WorkerName</td>
                                    <td class="p-3 text-muted">@(row.WorkerNIP ?? "—")</td>
                                    <td class="p-3"><span class="fw-semibold">@row.Title</span></td>
                                    <td class="p-3 text-center">
                                        <span class="badge bg-secondary">@(row.AttemptNumber.HasValue ? $"#{row.AttemptNumber}" : "—")</span>
                                    </td>
                                    <td class="p-3 text-center">
                                        @if (row.Score.HasValue)
                                        { <strong>@row.Score</strong> }
                                        else
                                        { <span class="text-muted">—</span> }
                                    </td>
                                    <td class="p-3 text-center">
                                        @if (row.IsPassed.HasValue)
                                        {
                                            if (row.IsPassed == true)
                                            { <span class="badge bg-success">Pass</span> }
                                            else
                                            { <span class="badge bg-danger">Fail</span> }
                                        }
                                        else
                                        { <span class="text-muted">—</span> }
                                    </td>
                                    <td class="p-3">@row.Date.ToString("dd MMM yyyy")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>

        <!-- Riwayat Training Sub-Tab (existing content moved here) -->
        <div class="tab-pane fade" id="riwayat-training-pane" role="tabpanel">
            @if (!Model.TrainingHistory.Any())
            {
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-inbox fs-1 d-block mb-3"></i>
                    <h5>Belum ada riwayat training</h5>
                    <p class="small">Data akan muncul setelah ada Training Record yang dicatat.</p>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="sticky-header">
                            <tr>
                                <th class="p-3">Nama Pekerja</th>
                                <th class="p-3">Nopeg</th>
                                <th class="p-3">Judul / Nama Pelatihan</th>
                                <th class="p-3">Tanggal Mulai</th>
                                <th class="p-3">Penyelenggara</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var row in Model.TrainingHistory)
                            {
                                <tr>
                                    <td class="p-3 fw-semibold">@row.WorkerName</td>
                                    <td class="p-3 text-muted">@(row.WorkerNIP ?? "—")</td>
                                    <td class="p-3"><span class="fw-semibold">@row.Title</span></td>
                                    <td class="p-3">@row.Date.ToString("dd MMM yyyy")</td>
                                    <td class="p-3">@(row.Penyelenggara ?? "—")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>

    </div>
</div>
```

**Edit 3 — Add client-side filter function** in the existing `<script>` block (before the closing `</script>` tag):
```javascript
// Phase 46: Riwayat Assessment client-side filter
function filterAssessmentRows() {
    var workerFilter = document.getElementById('assessmentWorkerFilter').value.toLowerCase();
    var titleFilter = document.getElementById('assessmentTitleFilter').value.toLowerCase();
    var rows = document.querySelectorAll('#assessmentHistoryTable .assessment-history-row');
    rows.forEach(function(row) {
        var worker = row.getAttribute('data-worker') || '';
        var title = row.getAttribute('data-title') || '';
        var workerMatch = !workerFilter || worker.includes(workerFilter);
        var titleMatch = !titleFilter || title.toLowerCase() === titleFilter;
        row.style.display = (workerMatch && titleMatch) ? '' : 'none';
    });
}
```

Note: Do NOT change the outer tab's id ("history-tab"), the activeTab URL param logic, or the Workers tab content — those must remain intact.
  </action>
  <verify>
    dotnet build (0 errors). Navigate to /CMP/Records as HC/Admin → History tab → see two sub-tabs. Riwayat Assessment tab shows table with Nama Pekerja, NIP, Assessment Title, Attempt #, Score, Pass/Fail, Tanggal columns. Typing in worker filter hides non-matching rows. Selecting an assessment title in dropdown filters to that assessment. Riwayat Training tab shows training records table.
  </verify>
  <done>
    History tab has two sub-tabs; Riwayat Assessment shows columns HIST-03 specifies with Attempt # values; Riwayat Training shows existing training data; filters function; build is clean.
  </done>
</task>

</tasks>

<verification>
- `dotnet build` exits with 0 errors and 0 warnings about missing Model properties
- Navigate /CMP/Records as HC → History tab → Riwayat Assessment sub-tab is default active
- Table shows: Nama Pekerja, NIP, Assessment Title, Attempt #, Score, Pass/Fail, Tanggal
- Rows include both archived records (from prior resets) and current completed sessions
- Worker/NIP search filters rows client-side; assessment title dropdown filters rows
- Riwayat Training sub-tab shows training records (unchanged from Phase 40)
- Outer History tab badge = total of both sub-tab counts
</verification>

<success_criteria>
HC and Admin see complete assessment attempt history per worker at /CMP/Records. HIST-01: archival live from Plan 01. HIST-02: unified query surfaces archived + current completed with correct Attempt #. HIST-03: columns, filters, sub-tab structure all present. All three requirements satisfied.
</success_criteria>

<output>
After completion, create `.planning/phases/46-attempt-history/46-02-SUMMARY.md`
</output>
