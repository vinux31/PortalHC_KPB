---
phase: 01-assessment-results-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Models/AssessmentSession.cs
  - Data/ApplicationDbContext.cs
  - Migrations/*_AddAssessmentResultFields.cs
  - Migrations/*_AddAssessmentResultFields.Designer.cs
  - Migrations/ApplicationDbContextModelSnapshot.cs
autonomous: true

must_haves:
  truths:
    - "AssessmentSession model has PassPercentage property with default value 70"
    - "AssessmentSession model has AllowAnswerReview property with default value true"
    - "AssessmentSession model has IsPassed nullable bool property"
    - "AssessmentSession model has CompletedAt nullable DateTime property"
    - "Database migration runs successfully and schema is updated"
    - "Existing assessment data is preserved with default values applied"
  artifacts:
    - path: "Models/AssessmentSession.cs"
      provides: "Updated model with PassPercentage, AllowAnswerReview, IsPassed, CompletedAt properties"
      contains: "PassPercentage"
    - path: "Data/ApplicationDbContext.cs"
      provides: "Check constraint for PassPercentage range 0-100"
      contains: "CK_AssessmentSession_PassPercentage"
  key_links:
    - from: "Models/AssessmentSession.cs"
      to: "Data/ApplicationDbContext.cs"
      via: "EF Core model configuration"
      pattern: "PassPercentage"
---

<objective>
Add PassPercentage, AllowAnswerReview, IsPassed, and CompletedAt columns to the AssessmentSession model and database schema via EF Core migration.

Purpose: Foundation for all Phase 1 work. Other plans depend on these new properties to implement results display and assessment configuration UI.
Output: Updated model, updated DbContext constraints, successful migration applied to database.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-assessment-results-configuration/01-RESEARCH.md
@Models/AssessmentSession.cs
@Data/ApplicationDbContext.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add new properties to AssessmentSession model</name>
  <files>Models/AssessmentSession.cs</files>
  <action>
Add four new properties to the AssessmentSession class, placed after the existing `Score` property and before `IsTokenRequired`:

1. `PassPercentage` (int, default 70) with `[Range(0, 100)]` and `[Display(Name = "Pass Percentage (%)")]` data annotations
2. `AllowAnswerReview` (bool, default true) with `[Display(Name = "Allow Answer Review")]` annotation
3. `IsPassed` (bool?, nullable) - calculated on submission, no display annotation needed
4. `CompletedAt` (DateTime?, nullable) - set when exam is submitted

Add the required using statement for `System.ComponentModel.DataAnnotations` at the top of the file.

Follow existing code style: properties use PascalCase, defaults assigned inline, XML comments in Indonesian/English mix as seen in existing code. Use the same `namespace HcPortal.Models` block style (brace-enclosed, not file-scoped).
  </action>
  <verify>Build the project: `dotnet build` should succeed with no errors related to the new properties.</verify>
  <done>AssessmentSession.cs contains PassPercentage (int, default 70, Range 0-100), AllowAnswerReview (bool, default true), IsPassed (bool?), and CompletedAt (DateTime?) properties with appropriate data annotations.</done>
</task>

<task type="auto">
  <name>Task 2: Update DbContext and create EF Core migration</name>
  <files>Data/ApplicationDbContext.cs, Migrations/*_AddAssessmentResultFields.cs, Migrations/*_AddAssessmentResultFields.Designer.cs, Migrations/ApplicationDbContextModelSnapshot.cs</files>
  <action>
1. In `Data/ApplicationDbContext.cs`, inside the existing `builder.Entity<AssessmentSession>()` configuration block (around line 52-71), add:
   - Check constraint: `entity.HasCheckConstraint("CK_AssessmentSession_PassPercentage", "[PassPercentage] >= 0 AND [PassPercentage] <= 100");`
   - Default value for PassPercentage: `entity.Property(a => a.PassPercentage).HasDefaultValue(70);`
   - Default value for AllowAnswerReview: `entity.Property(a => a.AllowAnswerReview).HasDefaultValue(true);`

   Place these AFTER the existing check constraints (after line 67) but within the same entity configuration block.

2. Run EF Core migration command:
   `dotnet ef migrations add AddAssessmentResultFields`

3. Apply the migration:
   `dotnet ef database update`

If the migration fails due to existing data, the default values in the migration should handle it (PassPercentage=70, AllowAnswerReview=true, IsPassed=NULL, CompletedAt=NULL).
  </action>
  <verify>
Run `dotnet ef database update` - should succeed. Then run `dotnet build` to confirm the project compiles. Check that the generated migration file contains AddColumn calls for PassPercentage, AllowAnswerReview, IsPassed, and CompletedAt with correct types and defaults.
  </verify>
  <done>Database schema updated with four new columns on AssessmentSessions table. Existing rows have PassPercentage=70 and AllowAnswerReview=true. Check constraint enforces PassPercentage 0-100 range. Project builds and runs.</done>
</task>

</tasks>

<verification>
1. `dotnet build` passes with zero errors
2. `dotnet ef database update` succeeds
3. AssessmentSession model has all four new properties with correct types and defaults
4. ApplicationDbContext has check constraint for PassPercentage range
5. Migration file exists and contains correct schema changes
</verification>

<success_criteria>
- AssessmentSession.cs has PassPercentage (int, default 70), AllowAnswerReview (bool, default true), IsPassed (bool?), CompletedAt (DateTime?)
- Database schema is updated with new columns
- Existing data preserved with sensible defaults
- Project builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/01-assessment-results-configuration/01-01-SUMMARY.md`
</output>
