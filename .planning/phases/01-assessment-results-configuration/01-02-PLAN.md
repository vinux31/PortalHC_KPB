---
phase: 01-assessment-results-configuration
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - Views/CMP/CreateAssessment.cshtml
  - Views/CMP/EditAssessment.cshtml
  - Controllers/CMPController.cs
autonomous: true

must_haves:
  truths:
    - "HC can set PassPercentage (0-100) when creating a new assessment"
    - "HC can toggle AllowAnswerReview when creating a new assessment"
    - "HC can edit PassPercentage and AllowAnswerReview on existing assessments"
    - "PassPercentage defaults change based on selected category"
    - "Form validation prevents PassPercentage outside 0-100 range"
  artifacts:
    - path: "Views/CMP/CreateAssessment.cshtml"
      provides: "PassPercentage input and AllowAnswerReview toggle in create form"
      contains: "PassPercentage"
    - path: "Views/CMP/EditAssessment.cshtml"
      provides: "PassPercentage input and AllowAnswerReview toggle in edit form"
      contains: "PassPercentage"
    - path: "Controllers/CMPController.cs"
      provides: "Updated CreateAssessment and EditAssessment POST actions that persist new fields"
      contains: "PassPercentage"
  key_links:
    - from: "Views/CMP/CreateAssessment.cshtml"
      to: "Controllers/CMPController.cs"
      via: "form POST to CreateAssessment action"
      pattern: "asp-for=\"PassPercentage\""
    - from: "Views/CMP/EditAssessment.cshtml"
      to: "Controllers/CMPController.cs"
      via: "form POST to EditAssessment action"
      pattern: "asp-for=\"PassPercentage\""
    - from: "Views/CMP/CreateAssessment.cshtml"
      to: "Models/AssessmentSession.cs"
      via: "model binding"
      pattern: "PassPercentage"
---

<objective>
Add PassPercentage and AllowAnswerReview configuration fields to the CreateAssessment and EditAssessment forms, with category-based defaults and form validation.

Purpose: Enables HC staff to configure pass thresholds and answer review visibility per assessment (FR3, FR4).
Output: Updated Create/Edit forms with new fields, updated controller POST actions.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-assessment-results-configuration/01-RESEARCH.md
@.planning/phases/01-assessment-results-configuration/01-01-SUMMARY.md
@Models/AssessmentSession.cs
@Controllers/CMPController.cs
@Views/CMP/CreateAssessment.cshtml
@Views/CMP/EditAssessment.cshtml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PassPercentage and AllowAnswerReview to CreateAssessment form and controller</name>
  <files>Views/CMP/CreateAssessment.cshtml, Controllers/CMPController.cs</files>
  <action>
**CreateAssessment.cshtml changes:**

Add a new "Assessment Settings" section between the Security Token Section and the Form Actions section (after line 218, before line 220). This section should be styled as a Bootstrap card similar to the Security Token Section pattern used in EditAssessment.cshtml, containing:

1. **PassPercentage input** - number field with:
   - `asp-for="PassPercentage"` binding
   - `type="number"` with `min="0"` `max="100"` `required`
   - Label: "Pass Percentage (%)" with required asterisk
   - Helper text: "Minimum score required to pass this assessment (0-100)"
   - Validation span: `asp-validation-for="PassPercentage"`
   - Place in a `col-md-6` column

2. **AllowAnswerReview toggle** - checkbox switch with:
   - `asp-for="AllowAnswerReview"` binding
   - `form-check form-switch` styling (matching the IsTokenRequired pattern at lines 196-204)
   - Label: "Allow Answer Review"
   - Helper text: "When enabled, users can see which questions they answered correctly after completing the assessment"
   - Place in a `col-md-6` column alongside PassPercentage

3. **Category-based default JavaScript** - Add to the existing DOMContentLoaded script block:
   - Listen for `change` event on the category select element (already referenced as `categorySelect` on line 402)
   - When category changes, update PassPercentage input value using these defaults:
     - 'OJT': 70, 'IHT': 70, 'Training Licencor': 80, 'OTS': 70, 'Mandatory HSSE Training': 100, 'Proton': 85
   - Only update if user hasn't manually changed the value (track with a `passPercentageManuallySet` flag)

**CreateAssessment GET action (CMPController.cs ~line 360-367):**

Update the model pre-population to include:
```csharp
PassPercentage = 70,
AllowAnswerReview = true
```

**CreateAssessment POST action (CMPController.cs ~line 480-530, the batch session creation loop):**

In the loop where individual AssessmentSession objects are created for each user, ensure `PassPercentage` and `AllowAnswerReview` from the form model are copied to each created session. Find the section where `new AssessmentSession` is constructed (or where properties are assigned from `model`) and add:
```csharp
PassPercentage = model.PassPercentage,
AllowAnswerReview = model.AllowAnswerReview,
```

Also add validation in the POST action (before ModelState check): if `model.PassPercentage` somehow bypasses client validation and is outside 0-100, add a ModelState error.
  </action>
  <verify>
Run `dotnet build` - should compile successfully. Navigate to `/CMP/CreateAssessment` in browser - form should show PassPercentage (defaulting to 70) and AllowAnswerReview (defaulting to checked). Changing category should update PassPercentage default. Creating an assessment should persist both fields.
  </verify>
  <done>CreateAssessment form shows PassPercentage (number input, default 70) and AllowAnswerReview (toggle, default on). Category change updates PassPercentage default. POST action persists both fields to all created sessions.</done>
</task>

<task type="auto">
  <name>Task 2: Add PassPercentage and AllowAnswerReview to EditAssessment form and controller</name>
  <files>Views/CMP/EditAssessment.cshtml, Controllers/CMPController.cs</files>
  <action>
**EditAssessment.cshtml changes:**

Add a new "Assessment Settings" section between the "Schedule & Duration" row (line 144) and the "Security Token Section" card (line 147). Style as a Bootstrap card with header "Assessment Settings" using info/secondary color (to differentiate from the primary-colored Security Token card). Contains:

1. **PassPercentage input** - same pattern as CreateAssessment:
   - `asp-for="PassPercentage"` binding
   - `type="number"` with `min="0"` `max="100"` `required`
   - Label: "Pass Percentage (%)" with required asterisk
   - Helper text: "Minimum score required to pass (0-100)"
   - Validation span
   - Place in `col-md-6`

2. **AllowAnswerReview toggle** - same pattern as CreateAssessment:
   - `asp-for="AllowAnswerReview"` binding
   - `form-check form-switch` styling
   - Label: "Allow Answer Review"
   - Helper text: "Allow users to review correct/incorrect answers after completion"
   - Place in `col-md-6`

Match the existing view's styling conventions (uses `asp-for`, `asp-validation-for`, Bootstrap 5 classes, form-check form-switch pattern from token toggle).

**EditAssessment POST action (CMPController.cs ~line 182-236):**

In the "Update only allowed fields" section (after line 201), add:
```csharp
assessment.PassPercentage = model.PassPercentage;
assessment.AllowAnswerReview = model.AllowAnswerReview;
```

Note: The research suggested preventing PassPercentage changes after completion, but the existing code already blocks editing completed assessments (line 195-199: `if (assessment.Status == "Completed") { ... return; }`). So no additional guard is needed.
  </action>
  <verify>
Run `dotnet build` - should compile successfully. Navigate to `/CMP/EditAssessment/{id}` in browser - form should show current PassPercentage and AllowAnswerReview values. Saving should persist changes.
  </verify>
  <done>EditAssessment form shows PassPercentage and AllowAnswerReview fields populated with current values. Saving persists both fields. Editing completed assessments is already blocked by existing guard.</done>
</task>

</tasks>

<verification>
1. `dotnet build` passes with zero errors
2. CreateAssessment form shows PassPercentage (default 70) and AllowAnswerReview (default true)
3. Category change in CreateAssessment updates PassPercentage default value
4. EditAssessment form shows current PassPercentage and AllowAnswerReview values
5. Both forms persist new fields on save
6. Form validation prevents PassPercentage outside 0-100
</verification>

<success_criteria>
- HC can set PassPercentage and AllowAnswerReview when creating assessments
- HC can edit PassPercentage and AllowAnswerReview on existing assessments
- Category-based defaults work on CreateAssessment form
- Both fields persist correctly to database
</success_criteria>

<output>
After completion, create `.planning/phases/01-assessment-results-configuration/01-02-SUMMARY.md`
</output>
