---
phase: 01-assessment-results-configuration
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - Models/AssessmentResultsViewModel.cs
  - Controllers/CMPController.cs
  - Views/CMP/Results.cshtml
  - Views/CMP/Assessment.cshtml
autonomous: false

must_haves:
  truths:
    - "User is redirected to Results page after submitting an assessment"
    - "Results page shows score as percentage"
    - "Results page shows pass/fail status with green (pass) or red (fail) badge"
    - "Results page shows the passing threshold percentage"
    - "If AllowAnswerReview is true, user sees each question with their answer vs correct answer"
    - "If AllowAnswerReview is false, user sees message that review is not available"
    - "User can access past results from Assessment lobby via View Results link"
    - "Only assessment owner, Admin, or HC can view results (authorization enforced)"
    - "IsPassed and CompletedAt are set on exam submission"
  artifacts:
    - path: "Models/AssessmentResultsViewModel.cs"
      provides: "Strongly-typed ViewModel for results display with QuestionReviewItem list"
      contains: "AssessmentResultsViewModel"
    - path: "Views/CMP/Results.cshtml"
      provides: "Results page with score, pass/fail badge, conditional answer review"
      contains: "IsPassed"
    - path: "Controllers/CMPController.cs"
      provides: "Results GET action and updated SubmitExam POST action"
      contains: "Results"
    - path: "Views/CMP/Assessment.cshtml"
      provides: "Updated lobby with View Results link for completed assessments"
      contains: "Results"
  key_links:
    - from: "Controllers/CMPController.cs"
      to: "Views/CMP/Results.cshtml"
      via: "Results action returns View(viewModel)"
      pattern: "return View\\(.*viewModel\\)"
    - from: "Controllers/CMPController.cs"
      to: "Models/AssessmentResultsViewModel.cs"
      via: "ViewModel construction in Results action"
      pattern: "AssessmentResultsViewModel"
    - from: "Controllers/CMPController.cs SubmitExam"
      to: "Controllers/CMPController.cs Results"
      via: "RedirectToAction after submission"
      pattern: "RedirectToAction\\(\"Results\""
    - from: "Views/CMP/Assessment.cshtml"
      to: "Controllers/CMPController.cs Results"
      via: "View Results link for completed assessments"
      pattern: "Url.Action\\(\"Results\""
---

<objective>
Create the assessment Results page, update SubmitExam to redirect there after submission, and add "View Results" link to the Assessment lobby for completed assessments.

Purpose: Complete the core assessment workflow so users see their results immediately after submission (FR1, FR2, FR5). This is the primary user-facing deliverable of Phase 1.
Output: Results.cshtml view, AssessmentResultsViewModel, updated SubmitExam flow, updated lobby links.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-assessment-results-configuration/01-RESEARCH.md
@.planning/phases/01-assessment-results-configuration/01-01-SUMMARY.md
@Models/AssessmentSession.cs
@Models/AssessmentQuestion.cs
@Models/UserResponse.cs
@Controllers/CMPController.cs
@Views/CMP/Assessment.cshtml
@Views/CMP/Certificate.cshtml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AssessmentResultsViewModel and Results controller action</name>
  <files>Models/AssessmentResultsViewModel.cs, Controllers/CMPController.cs</files>
  <action>
**Create Models/AssessmentResultsViewModel.cs:**

Create a new file in the Models directory with two classes:

1. `AssessmentResultsViewModel`:
   - `int AssessmentId`
   - `string Title`
   - `string Category`
   - `string UserFullName` (the assessment taker's name)
   - `int Score` (0-100 percentage, from AssessmentSession.Score)
   - `int PassPercentage`
   - `bool IsPassed` (computed: Score >= PassPercentage)
   - `bool AllowAnswerReview`
   - `DateTime? CompletedAt`
   - `int TotalQuestions`
   - `int CorrectAnswers`
   - `List<QuestionReviewItem>? QuestionReviews` (only populated when AllowAnswerReview is true)

2. `QuestionReviewItem`:
   - `int QuestionNumber`
   - `string QuestionText`
   - `string? UserAnswer` (text of selected option, null if unanswered)
   - `string CorrectAnswer` (text of correct option)
   - `bool IsCorrect`
   - `List<OptionReviewItem> Options` (all options for the question)

3. `OptionReviewItem`:
   - `string OptionText`
   - `bool IsCorrect` (is this the correct answer)
   - `bool IsSelected` (did user select this)

Use `namespace HcPortal.Models` with traditional braces (matching existing files).

**Add Results GET action to CMPController.cs:**

Add after the Certificate action (around line 1020). Follow the authorization pattern from the Certificate action (lines 996-1019):

```csharp
[HttpGet]
public async Task<IActionResult> Results(int id)
{
    var assessment = await _context.AssessmentSessions
        .Include(a => a.User)
        .Include(a => a.Questions.OrderBy(q => q.Order))
            .ThenInclude(q => q.Options)
        .Include(a => a.Responses)
            .ThenInclude(r => r.SelectedOption)
        .FirstOrDefaultAsync(a => a.Id == id);

    if (assessment == null) return NotFound();

    // Authorization: owner, Admin, or HC
    var user = await _userManager.GetUserAsync(User);
    if (user == null) return Challenge();
    var userRoles = await _userManager.GetRolesAsync(user);
    bool isAuthorized = assessment.UserId == user.Id ||
                        userRoles.Contains("Admin") ||
                        userRoles.Contains("HC");
    if (!isAuthorized) return Forbid();

    // Must be completed
    if (assessment.Status != "Completed")
    {
        TempData["Error"] = "Assessment not completed yet.";
        return RedirectToAction("Assessment");
    }

    // Build ViewModel
    var correctCount = 0;
    List<QuestionReviewItem>? questionReviews = null;

    if (assessment.AllowAnswerReview)
    {
        questionReviews = new List<QuestionReviewItem>();
        int questionNum = 0;
        foreach (var question in assessment.Questions)
        {
            questionNum++;
            var userResponse = assessment.Responses
                .FirstOrDefault(r => r.AssessmentQuestionId == question.Id);
            var correctOption = question.Options.FirstOrDefault(o => o.IsCorrect);
            var selectedOption = userResponse?.SelectedOption;
            bool isCorrect = selectedOption != null && selectedOption.IsCorrect;
            if (isCorrect) correctCount++;

            questionReviews.Add(new QuestionReviewItem
            {
                QuestionNumber = questionNum,
                QuestionText = question.QuestionText,
                UserAnswer = selectedOption?.OptionText,
                CorrectAnswer = correctOption?.OptionText ?? "N/A",
                IsCorrect = isCorrect,
                Options = question.Options.Select(o => new OptionReviewItem
                {
                    OptionText = o.OptionText,
                    IsCorrect = o.IsCorrect,
                    IsSelected = userResponse?.SelectedOptionId == o.Id
                }).ToList()
            });
        }
    }
    else
    {
        // Still count correct for summary even when review disabled
        foreach (var question in assessment.Questions)
        {
            var userResponse = assessment.Responses
                .FirstOrDefault(r => r.AssessmentQuestionId == question.Id);
            if (userResponse?.SelectedOption != null && userResponse.SelectedOption.IsCorrect)
                correctCount++;
        }
    }

    var passPercentage = assessment.PassPercentage;
    var score = assessment.Score ?? 0;

    var viewModel = new AssessmentResultsViewModel
    {
        AssessmentId = assessment.Id,
        Title = assessment.Title,
        Category = assessment.Category,
        UserFullName = assessment.User?.FullName ?? "Unknown",
        Score = score,
        PassPercentage = passPercentage,
        IsPassed = score >= passPercentage,
        AllowAnswerReview = assessment.AllowAnswerReview,
        CompletedAt = assessment.CompletedAt,
        TotalQuestions = assessment.Questions.Count,
        CorrectAnswers = correctCount,
        QuestionReviews = questionReviews
    };

    return View(viewModel);
}
```

**Update SubmitExam action (CMPController.cs ~line 926-994):**

Modify the SubmitExam POST action:

1. After line 987 (`assessment.Progress = 100;`), add:
   ```csharp
   assessment.IsPassed = finalPercentage >= assessment.PassPercentage;
   assessment.CompletedAt = DateTime.UtcNow;
   ```

2. Change the redirect at line 993 from:
   ```csharp
   return RedirectToAction("Assessment");
   ```
   to:
   ```csharp
   return RedirectToAction("Results", new { id = id });
   ```
  </action>
  <verify>
Run `dotnet build` - should compile successfully. The Results action should be accessible at `/CMP/Results/{id}`. SubmitExam should now redirect to Results instead of Assessment lobby.
  </verify>
  <done>
AssessmentResultsViewModel.cs exists with all required properties. Results controller action loads assessment data, checks authorization, builds ViewModel with conditional answer review data. SubmitExam redirects to Results and sets IsPassed and CompletedAt.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Results.cshtml view and update Assessment lobby links</name>
  <files>Views/CMP/Results.cshtml, Views/CMP/Assessment.cshtml</files>
  <action>
**Create Views/CMP/Results.cshtml:**

Create a new Razor view following the styling patterns from Certificate.cshtml and the existing Bootstrap 5 usage. The view should use `@model HcPortal.Models.AssessmentResultsViewModel` and include:

1. **Page Header** - "Assessment Results" with back button to Assessment lobby (match CreateAssessment.cshtml header pattern)

2. **Results Summary Card** (Bootstrap card with shadow-sm):
   - Assessment title as card header (use `bg-success text-white` if passed, `bg-danger text-white` if failed)
   - Three-column row inside card body:
     - Column 1: "Your Score" with large `@Model.Score%` and smaller `(@Model.CorrectAnswers/@Model.TotalQuestions correct)` below
     - Column 2: "Pass Threshold" with large `@Model.PassPercentage%`
     - Column 3: "Status" with Bootstrap badge: `text-bg-success` with `bi-check-circle-fill` icon and "PASSED" text if passed, `text-bg-danger` with `bi-x-circle-fill` icon and "FAILED" text if not
   - Each column uses `text-center p-4 border rounded` styling
   - Below the columns: assessment details (Category badge, Completed date, User name)

3. **Motivational Message** - Alert box:
   - If passed: `alert-success` with "Congratulations! You passed the assessment."
   - If failed: `alert-warning` with "Keep trying. Review the material and try again."

4. **Answer Review Section** (conditional):
   - If `Model.AllowAnswerReview` and `Model.QuestionReviews` is not null:
     - Heading "Answer Review" with `bi-list-check` icon
     - For each question in `Model.QuestionReviews`:
       - List group item with:
         - Question number and text (bold)
         - All options listed, each with:
           - Green highlight (`list-group-item-success`) if the option IsCorrect
           - Red highlight (`list-group-item-danger`) if the option IsSelected but NOT IsCorrect
           - Normal styling otherwise
           - Icon: `bi-check-circle-fill text-success` next to correct option, `bi-x-circle-fill text-danger` next to incorrectly selected option
         - Badge on right: "Correct" (green) or "Incorrect" (red)
   - If `!Model.AllowAnswerReview`:
     - `alert-info` with `bi-info-circle` icon: "Answer review is not available for this assessment."

5. **Action Buttons** at bottom:
   - "View Certificate" button (primary, links to Certificate action with `target="_blank"`) - only shown if passed
   - "Back to Assessments" button (outline-secondary, links to Assessment action)

Use existing icons throughout (bi-check-circle-fill, bi-x-circle-fill, bi-award, bi-arrow-left are all already used in the codebase).

**Update Views/CMP/Assessment.cshtml:**

Find the "Completed" status block (lines 300-306). Change from showing only "View Certificate" to showing BOTH "View Results" (primary) and "View Certificate" (secondary):

Replace lines 300-306 with:
```razor
else if (item.Status == "Completed")
{
    var scoreText = item.Score.HasValue ? $" ({item.Score}%)" : "";
    <div class="d-flex flex-column gap-2">
        <a href="@Url.Action("Results", "CMP", new { id = item.Id })" class="btn btn-primary w-100">
            <i class="bi bi-bar-chart-line me-1"></i>View Results@scoreText
        </a>
        <a href="@Url.Action("Certificate", "CMP", new { id = item.Id })" class="btn btn-outline-secondary btn-sm w-100" target="_blank">
            <i class="bi bi-award me-1"></i>Certificate
        </a>
    </div>
}
```

This makes "View Results" the primary action and "Certificate" a secondary option, matching the research recommendation.
  </action>
  <verify>
Run `dotnet build` - should compile successfully. Navigate to `/CMP/Results/{id}` for a completed assessment - should display the full results page with score, pass/fail, and conditional answer review. Assessment lobby should show "View Results" button for completed assessments.
  </verify>
  <done>
Results.cshtml renders score, pass/fail status, passing threshold, conditional answer review, and action buttons. Assessment lobby shows "View Results" as primary action and "Certificate" as secondary for completed assessments.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Manual verification of complete assessment results workflow</name>
  <files>Views/CMP/Results.cshtml, Views/CMP/Assessment.cshtml, Controllers/CMPController.cs, Models/AssessmentResultsViewModel.cs</files>
  <action>
This is a human verification checkpoint. Present the user with the verification steps below. All implementation was completed in Tasks 1 and 2 -- this task confirms the end-to-end workflow functions correctly via manual testing.
  </action>
  <what-built>
Complete assessment results workflow:
1. Schema changes (PassPercentage, AllowAnswerReview, IsPassed, CompletedAt)
2. Create/Edit assessment forms with new configuration fields
3. Results page with score, pass/fail badge, conditional answer review
4. SubmitExam redirects to Results page
5. Assessment lobby shows "View Results" for completed assessments
  </what-built>
  <how-to-verify>
1. Navigate to the application at http://localhost:5000 (or your dev URL)
2. Log in as HC or Admin user
3. Create a new assessment - verify PassPercentage (default 70) and AllowAnswerReview toggle appear in the form
4. Change the category dropdown - verify PassPercentage default updates
5. Assign the assessment to a test user, create it
6. Edit the assessment - verify PassPercentage and AllowAnswerReview fields show with saved values
7. Log in as the assigned user
8. Take the assessment and submit
9. Verify you are redirected to the Results page (not the lobby)
10. Verify Results page shows: score percentage, pass/fail badge, passing threshold
11. If AllowAnswerReview was enabled: verify answer review section shows questions with correct/incorrect indicators
12. Click "Back to Assessments" to return to lobby
13. Verify completed assessment shows "View Results" button in the lobby
14. Click "View Results" - verify results page loads correctly
15. Try accessing another user's results URL directly - verify you get 403 Forbidden
  </how-to-verify>
  <verify>User confirms all 15 verification steps pass by typing "approved"</verify>
  <done>User has verified the complete assessment results workflow functions correctly end-to-end</done>
  <resume-signal>Type "approved" if everything works, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `dotnet build` passes with zero errors
2. SubmitExam redirects to Results page (not Assessment lobby)
3. Results page shows score, pass/fail badge, passing threshold
4. Answer review shows when AllowAnswerReview is true
5. "Answer review not available" message shows when AllowAnswerReview is false
6. Assessment lobby shows "View Results" for completed assessments
7. Authorization: non-owner gets 403, Admin/HC can view any results
8. IsPassed and CompletedAt are set correctly on submission
</verification>

<success_criteria>
- User completes assessment and immediately sees results with score and pass/fail status
- Answer review conditional on AllowAnswerReview setting
- Past results accessible from Assessment lobby
- Authorization enforced (owner/Admin/HC only)
</success_criteria>

<output>
After completion, create `.planning/phases/01-assessment-results-configuration/01-03-SUMMARY.md`
</output>
