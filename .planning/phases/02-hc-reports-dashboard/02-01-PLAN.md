---
phase: 02-hc-reports-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Models/ReportsDashboardViewModel.cs
  - Controllers/CMPController.cs
  - Views/CMP/ReportsIndex.cshtml
  - Views/Shared/_Layout.cshtml
autonomous: true

must_haves:
  truths:
    - "HC can view a dashboard page listing completed assessments with summary statistics (total completed, pass rate, average score)"
    - "HC can filter assessment results by category, date range, section, or specific user"
    - "Filtered results show paginated table of assessment results with user, score, pass/fail, and completion date"
    - "Filter selections persist across pagination (changing pages does not reset filters)"
    - "Non-HC/Admin users cannot access the reports dashboard (returns Forbid)"
  artifacts:
    - path: "Models/ReportsDashboardViewModel.cs"
      provides: "ViewModels for reports dashboard (ReportsDashboardViewModel, AssessmentReportItem, ReportFilters, CategoryStatistic)"
      contains: "class ReportsDashboardViewModel"
    - path: "Views/CMP/ReportsIndex.cshtml"
      provides: "Reports dashboard view with summary cards, filter form, and paginated results table"
      contains: "@model HcPortal.Models.ReportsDashboardViewModel"
    - path: "Controllers/CMPController.cs"
      provides: "ReportsIndex action with server-side filtering, aggregation, and pagination"
      contains: "public async Task<IActionResult> ReportsIndex"
    - path: "Views/Shared/_Layout.cshtml"
      provides: "Navigation link to Reports Dashboard under CMP dropdown (HC/Admin only)"
      contains: "ReportsIndex"
  key_links:
    - from: "Views/CMP/ReportsIndex.cshtml"
      to: "Models/ReportsDashboardViewModel.cs"
      via: "@model directive"
      pattern: "@model.*ReportsDashboardViewModel"
    - from: "Controllers/CMPController.cs"
      to: "Data/ApplicationDbContext.cs"
      via: "EF Core queries with GroupBy aggregation"
      pattern: "_context\\.AssessmentSessions"
    - from: "Views/Shared/_Layout.cshtml"
      to: "Controllers/CMPController.cs"
      via: "Navigation link to ReportsIndex"
      pattern: "asp-action=\"ReportsIndex\""
---

<objective>
Build the HC Reports Dashboard main page with summary statistics, server-side filtering, and paginated results table.

Purpose: Give HC staff a centralized view of all assessment results with filtering capabilities, enabling data-driven analysis of workforce competency performance.

Output: Working reports dashboard at /CMP/ReportsIndex accessible by HC/Admin with summary cards, filter form, and paginated results table.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-hc-reports-dashboard/02-RESEARCH.md
@.planning/phases/01-assessment-results-configuration/01-01-SUMMARY.md
@.planning/phases/01-assessment-results-configuration/01-03-SUMMARY.md
@Models/AssessmentSession.cs
@Models/ApplicationUser.cs
@Data/ApplicationDbContext.cs
@Views/CMP/Assessment.cshtml
@Views/CDP/Dashboard.cshtml
@Views/Shared/_Layout.cshtml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ViewModels and ReportsIndex controller action</name>
  <files>
    Models/ReportsDashboardViewModel.cs
    Controllers/CMPController.cs
  </files>
  <action>
    **Create `Models/ReportsDashboardViewModel.cs`** with these classes:

    1. `ReportsDashboardViewModel` - Main ViewModel:
       - `List<AssessmentReportItem> Assessments` - paginated results
       - `int TotalAssessments` - count of completed assessments matching filters
       - `int PassedCount` - count with IsPassed == true
       - `double PassRate` - percentage (PassedCount * 100.0 / TotalAssessments, or 0 if none)
       - `double AverageScore` - average Score of completed assessments
       - `int TotalAssigned` - total count of ALL assessment sessions (regardless of status)
       - `int CurrentPage`, `int TotalPages`, `int PageSize` - pagination
       - `ReportFilters CurrentFilters` - current filter state for form persistence
       - `List<string> AvailableCategories` - distinct categories for dropdown
       - `List<string> AvailableSections` - distinct sections for dropdown

    2. `AssessmentReportItem` - Table row:
       - `int Id`
       - `string Title`
       - `string Category`
       - `string UserName`
       - `string? UserNIP`
       - `string? UserSection`
       - `int Score`
       - `int PassPercentage`
       - `bool IsPassed`
       - `DateTime? CompletedAt`

    3. `ReportFilters` - Filter parameters:
       - `string? Category`
       - `DateTime? StartDate`
       - `DateTime? EndDate`
       - `string? Section`
       - `string? UserSearch` (search by user name or NIP)

    4. `CategoryStatistic` - For future chart data (create now, used in plan 02-03):
       - `string CategoryName`
       - `int TotalAssessments`
       - `int PassedCount`
       - `double PassRate`
       - `double AverageScore`

    Use `namespace HcPortal.Models` (file-scoped namespace syntax: `namespace HcPortal.Models;`). Follow existing naming conventions (PascalCase properties, nullable with `?`).

    **Add `ReportsIndex` action to `Controllers/CMPController.cs`:**

    Add a new GET action method `ReportsIndex` with these parameters:
    - `string? category`
    - `DateTime? startDate`
    - `DateTime? endDate`
    - `string? section`
    - `string? userSearch`
    - `int page = 1`
    - `int pageSize = 20`

    Authorization: `[Authorize(Roles = "Admin, HC")]` attribute on the action.

    Implementation:
    1. Get current user (standard pattern: `await _userManager.GetUserAsync(User)`)
    2. Base query: `_context.AssessmentSessions.Include(a => a.User).Where(a => a.Status == "Completed")`
    3. Apply filters conditionally:
       - `category`: `.Where(a => a.Category == category)`
       - `startDate`: `.Where(a => a.CompletedAt >= startDate.Value)`
       - `endDate`: `.Where(a => a.CompletedAt <= endDate.Value.Date.AddDays(1))` (include full end day)
       - `section`: `.Where(a => a.User != null && a.User.Section == section)`
       - `userSearch`: `.Where(a => a.User != null && (a.User.FullName.Contains(userSearch) || (a.User.NIP != null && a.User.NIP.Contains(userSearch))))`
    4. Calculate summary stats using the filtered query:
       - `totalCompleted = await query.CountAsync()`
       - `passedCount = await query.CountAsync(a => a.IsPassed == true)`
       - `avgScore = totalCompleted > 0 ? await query.AverageAsync(a => (double?)a.Score) ?? 0 : 0`
       - `totalAssigned = await _context.AssessmentSessions.CountAsync()` (all sessions, unfiltered)
    5. Paginate: `.OrderByDescending(a => a.CompletedAt).Skip((page - 1) * pageSize).Take(pageSize)`
    6. Project to `AssessmentReportItem` using `.Select()`
    7. Load filter dropdown options:
       - `categories = await _context.AssessmentSessions.Where(a => a.Status == "Completed").Select(a => a.Category).Distinct().OrderBy(c => c).ToListAsync()`
       - `sections = await _context.Users.Where(u => u.Section != null && u.Section != "").Select(u => u.Section!).Distinct().OrderBy(s => s).ToListAsync()`
    8. Build `ReportsDashboardViewModel` and return `View(viewModel)`

    Place the action near the end of the controller but before any private helper methods. Add a section comment `// ========== HC REPORTS ==========` before the action.

    **IMPORTANT:** Use `using HcPortal.Models;` (already present in controller). Do NOT create a separate service class - keep logic in the controller for consistency with the rest of the codebase.
  </action>
  <verify>
    Run `dotnet build` from project root. Expect 0 errors. The build confirms:
    - ReportsDashboardViewModel.cs compiles with all referenced types
    - CMPController.cs compiles with new ReportsIndex action
    - No namespace or type resolution issues
  </verify>
  <done>
    - ReportsDashboardViewModel.cs exists with all four classes (ReportsDashboardViewModel, AssessmentReportItem, ReportFilters, CategoryStatistic)
    - CMPController.cs has ReportsIndex action with [Authorize(Roles = "Admin, HC")] attribute
    - ReportsIndex applies all five filter types and returns paginated results
    - `dotnet build` passes with 0 errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ReportsIndex view and add navigation link</name>
  <files>
    Views/CMP/ReportsIndex.cshtml
    Views/Shared/_Layout.cshtml
  </files>
  <action>
    **Create `Views/CMP/ReportsIndex.cshtml`** with these sections:

    1. **Model directive and title:**
       ```
       @model HcPortal.Models.ReportsDashboardViewModel
       @{ ViewData["Title"] = "Assessment Reports"; }
       ```

    2. **Page header:** `<div class="container-fluid px-4 py-4">` wrapper (consistent with Assessment.cshtml pattern).
       - Title: "Assessment Reports" with `bi-clipboard-data` icon
       - Subtitle: "View and analyze assessment results across all users"

    3. **Summary statistics cards** - 4 cards in a `row g-4 mb-4`:
       - **Total Assigned** (bg-primary): `Model.TotalAssigned` with subtitle "All assessment sessions"
       - **Completed** (bg-info): `Model.TotalAssessments` with subtitle "Completed assessments"
       - **Pass Rate** (bg-success): `Model.PassRate.ToString("F1")%` with subtitle "`Model.PassedCount` passed"
       - **Average Score** (bg-warning text-dark): `Model.AverageScore.ToString("F1")` with subtitle "Out of 100"

       Follow the CDP Dashboard card pattern: `card border-0 shadow-sm text-white h-100`, with a large icon in top-right using `position-absolute end-0 top-0 p-3 opacity-25`.

    4. **Filter form** in a `card border-0 shadow-sm mb-4`:
       - Card header: "Filter Results" with `bi-funnel` icon
       - Form with `method="get"` and `asp-action="ReportsIndex"`
       - Row of filter inputs:
         - **Category** dropdown (`<select>` with `form-select`): "All Categories" default + loop over `Model.AvailableCategories`. Set `selected` based on `Model.CurrentFilters.Category`.
         - **Section** dropdown: "All Sections" default + loop over `Model.AvailableSections`. Set `selected` based on `Model.CurrentFilters.Section`.
         - **Start Date**: `<input type="date">` with value from `Model.CurrentFilters.StartDate?.ToString("yyyy-MM-dd")`
         - **End Date**: `<input type="date">` with value from `Model.CurrentFilters.EndDate?.ToString("yyyy-MM-dd")`
         - **User Search**: `<input type="text">` with placeholder "Search by name or NIP..." and value from `Model.CurrentFilters.UserSearch`
       - Buttons row: "Apply Filters" (btn-primary) submit button + "Clear" link (btn-outline-secondary) to `ReportsIndex` with no params

    5. **Results table** in a `card border-0 shadow-sm`:
       - Card header with "Assessment Results" title and count badge showing `Model.TotalAssessments`
       - Responsive table (`table-responsive` > `table table-hover mb-0`):
         - Headers: #, Assessment, User, NIP, Section, Category, Score, Pass %, Status, Completed
         - Body: Loop over `Model.Assessments` with index. Show:
           - Row number: `(Model.CurrentPage - 1) * Model.PageSize + index + 1`
           - Title
           - UserName
           - UserNIP (or "-" if null)
           - UserSection (or "-" if null)
           - Category as `<span class="badge bg-secondary">`
           - Score
           - PassPercentage with "%" suffix
           - IsPassed: `<span class="badge bg-success">Pass</span>` or `<span class="badge bg-danger">Fail</span>`
           - CompletedAt formatted as "dd MMM yyyy HH:mm"
         - Empty state if `Model.Assessments.Count == 0`: "No results found" message with icon
       - Card footer with pagination (reuse the exact pagination pattern from Assessment.cshtml):
         - "Showing X to Y of Z" text
         - Pagination controls with first/prev/page numbers/next/last
         - **CRITICAL:** All pagination links must include current filter parameters:
           ```
           href="?page=N&category=@Model.CurrentFilters.Category&section=@Model.CurrentFilters.Section&startDate=@Model.CurrentFilters.StartDate?.ToString("yyyy-MM-dd")&endDate=@Model.CurrentFilters.EndDate?.ToString("yyyy-MM-dd")&userSearch=@Model.CurrentFilters.UserSearch"
           ```

    6. **No custom CSS needed** - rely entirely on Bootstrap 5 utilities for consistency.

    **Update `Views/Shared/_Layout.cshtml`:**

    Add a navigation link to the Reports Dashboard in the CMP dropdown menu. Insert it after the "Create Assessment" link (which is already inside an `@if (User.IsInRole("Admin") || User.IsInRole("HC"))` block).

    Add a new divider and section header for "Reports", then the reports link, ALL inside the same Admin/HC role check. Specifically, add these lines after the closing `</li>` of the Create Assessment link (around line 66):

    ```html
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header text-uppercase small fw-bold">Reports</h6></li>
    <li><a class="dropdown-item" asp-controller="CMP" asp-action="ReportsIndex">
        <i class="bi bi-clipboard-data me-1"></i>Assessment Reports
    </a></li>
    ```

    Keep the new items INSIDE the existing `@if (User.IsInRole("Admin") || User.IsInRole("HC"))` block so only authorized users see it.
  </action>
  <verify>
    Run `dotnet build` from project root. Expect 0 errors. Then verify:
    1. `Views/CMP/ReportsIndex.cshtml` exists and contains `@model HcPortal.Models.ReportsDashboardViewModel`
    2. `Views/Shared/_Layout.cshtml` contains `asp-action="ReportsIndex"` inside the CMP dropdown
    3. Build passes confirming Razor view compiles against the ViewModel
  </verify>
  <done>
    - ReportsIndex.cshtml shows summary cards, filter form, paginated results table
    - Filter form submits via GET with all filter parameters
    - Pagination links preserve filter state across page changes
    - Navigation link appears in CMP dropdown for Admin/HC users only
    - `dotnet build` passes with 0 errors
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` passes with 0 errors
2. Navigate to `/CMP/ReportsIndex` as Admin/HC user - page loads with summary cards, filter form, and results table
3. Apply category filter - results update to show only that category, pagination reflects filtered count
4. Apply date range filter - results filtered to date range
5. Apply section filter - results filtered to users in that section
6. Search by user name - results filtered to matching users
7. Navigate to page 2 with filters applied - filters remain in URL and form
8. Navigate to `/CMP/ReportsIndex` as non-HC user - returns 403 Forbidden
9. Navigation dropdown shows "Assessment Reports" link only for Admin/HC roles
</verification>

<success_criteria>
- HC/Admin can access /CMP/ReportsIndex and see summary statistics for completed assessments
- Filter form works for category, date range, section, and user search (individually and combined)
- Results table shows paginated list of assessment results with all relevant columns
- Pagination preserves filter state
- Unauthorized users cannot access the reports page
- Reports link visible in CMP navigation dropdown for authorized users only
</success_criteria>

<output>
After completion, create `.planning/phases/02-hc-reports-dashboard/02-01-SUMMARY.md`
</output>
