---
phase: 02-hc-reports-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - HcPortal.csproj
  - Controllers/CMPController.cs
  - Models/ReportsDashboardViewModel.cs
  - Views/CMP/UserAssessmentHistory.cshtml
autonomous: true

must_haves:
  truths:
    - "HC can export filtered assessment results to an Excel file (.xlsx) that downloads immediately"
    - "Exported Excel file contains assessment title, category, user name, NIP, section, score, pass percentage, pass/fail status, and completion date"
    - "Export respects currently applied filters (same filters as the reports table)"
    - "HC can view an individual user's complete assessment history showing all their past results"
    - "User history page shows user info header and a table of all their completed assessments"
  artifacts:
    - path: "HcPortal.csproj"
      provides: "ClosedXML NuGet package reference"
      contains: "ClosedXML"
    - path: "Controllers/CMPController.cs"
      provides: "ExportResults and UserAssessmentHistory actions"
      contains: "public async Task<IActionResult> ExportResults"
    - path: "Views/CMP/UserAssessmentHistory.cshtml"
      provides: "Individual user assessment history page"
      contains: "@model HcPortal.Models.UserAssessmentHistoryViewModel"
  key_links:
    - from: "Controllers/CMPController.cs"
      to: "ClosedXML"
      via: "XLWorkbook for Excel generation"
      pattern: "new XLWorkbook"
    - from: "Views/CMP/ReportsIndex.cshtml"
      to: "Controllers/CMPController.cs"
      via: "Export button link to ExportResults action"
      pattern: "ExportResults"
    - from: "Views/CMP/ReportsIndex.cshtml"
      to: "Controllers/CMPController.cs"
      via: "View detail link per user row"
      pattern: "UserAssessmentHistory"
---

<objective>
Add Excel export functionality and individual user assessment history view to the HC Reports Dashboard.

Purpose: Enable HC staff to export assessment data for external analysis (Excel) and drill down into individual user performance history, completing the reporting workflow.

Output: Working Excel export at /CMP/ExportResults and user history page at /CMP/UserAssessmentHistory.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-hc-reports-dashboard/02-RESEARCH.md
@.planning/phases/02-hc-reports-dashboard/02-01-SUMMARY.md
@Models/ReportsDashboardViewModel.cs
@Models/AssessmentSession.cs
@Models/ApplicationUser.cs
@Controllers/CMPController.cs
@Views/CMP/ReportsIndex.cshtml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install ClosedXML and add ExportResults action</name>
  <files>
    HcPortal.csproj
    Controllers/CMPController.cs
  </files>
  <action>
    **Install ClosedXML NuGet package:**
    Run: `dotnet add package ClosedXML`

    **Add `ExportResults` action to CMPController.cs:**

    Add `using ClosedXML.Excel;` at the top of the file with other using statements.

    Add a new GET action `ExportResults` in the HC REPORTS section (after the ReportsIndex action) with these parameters:
    - `string? category`
    - `DateTime? startDate`
    - `DateTime? endDate`
    - `string? section`
    - `string? userSearch`

    Authorization: `[Authorize(Roles = "Admin, HC")]`

    Implementation:
    1. Build the same base query as ReportsIndex: `_context.AssessmentSessions.Include(a => a.User).Where(a => a.Status == "Completed")`
    2. Apply the same filters as ReportsIndex (category, startDate, endDate, section, userSearch) - extract or duplicate the filter logic.
    3. **No pagination** - get all matching results but cap at 10,000 rows:
       ```csharp
       var maxExportRows = 10000;
       var results = await query
           .OrderByDescending(a => a.CompletedAt)
           .Take(maxExportRows)
           .Select(a => new {
               AssessmentTitle = a.Title,
               Category = a.Category,
               UserName = a.User != null ? a.User.FullName : "",
               NIP = a.User != null ? a.User.NIP ?? "" : "",
               Section = a.User != null ? a.User.Section ?? "" : "",
               Score = a.Score ?? 0,
               PassPercentage = a.PassPercentage,
               Status = a.IsPassed == true ? "Pass" : "Fail",
               CompletedAt = a.CompletedAt
           })
           .ToListAsync();
       ```
    4. Generate Excel using ClosedXML:
       ```csharp
       using var workbook = new XLWorkbook();
       var worksheet = workbook.Worksheets.Add("Assessment Results");

       // Header row
       worksheet.Cell(1, 1).Value = "Assessment Title";
       worksheet.Cell(1, 2).Value = "Category";
       worksheet.Cell(1, 3).Value = "User Name";
       worksheet.Cell(1, 4).Value = "NIP";
       worksheet.Cell(1, 5).Value = "Section";
       worksheet.Cell(1, 6).Value = "Score";
       worksheet.Cell(1, 7).Value = "Pass Percentage";
       worksheet.Cell(1, 8).Value = "Status";
       worksheet.Cell(1, 9).Value = "Completed At";

       // Style header
       var headerRange = worksheet.Range(1, 1, 1, 9);
       headerRange.Style.Font.Bold = true;
       headerRange.Style.Fill.BackgroundColor = XLColor.LightBlue;

       // Data rows
       for (int i = 0; i < results.Count; i++)
       {
           var r = results[i];
           var row = i + 2;
           worksheet.Cell(row, 1).Value = r.AssessmentTitle;
           worksheet.Cell(row, 2).Value = r.Category;
           worksheet.Cell(row, 3).Value = r.UserName;
           worksheet.Cell(row, 4).Value = r.NIP;
           worksheet.Cell(row, 5).Value = r.Section;
           worksheet.Cell(row, 6).Value = r.Score;
           worksheet.Cell(row, 7).Value = r.PassPercentage;
           worksheet.Cell(row, 8).Value = r.Status;
           worksheet.Cell(row, 9).Value = r.CompletedAt?.ToString("yyyy-MM-dd HH:mm");
       }

       worksheet.Columns().AdjustToContents();
       ```
    5. Return as file download:
       ```csharp
       using var stream = new MemoryStream();
       workbook.SaveAs(stream);
       var content = stream.ToArray();
       var fileName = $"AssessmentResults_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";
       return File(content, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", fileName);
       ```

    **Also update ReportsIndex.cshtml** to add an "Export to Excel" button in the results table card header. Add it next to the "Assessment Results" title:
    ```html
    <a href="@Url.Action("ExportResults", new {
        category = Model.CurrentFilters.Category,
        startDate = Model.CurrentFilters.StartDate?.ToString("yyyy-MM-dd"),
        endDate = Model.CurrentFilters.EndDate?.ToString("yyyy-MM-dd"),
        section = Model.CurrentFilters.Section,
        userSearch = Model.CurrentFilters.UserSearch
    })" class="btn btn-success btn-sm">
        <i class="bi bi-file-earmark-excel me-1"></i>Export to Excel
    </a>
    ```

    Place the button in a `d-flex justify-content-between align-items-center` wrapper in the card header.
  </action>
  <verify>
    Run `dotnet build` from project root. Expect 0 errors. Verify:
    1. ClosedXML package is in HcPortal.csproj
    2. ExportResults action exists in CMPController with [Authorize(Roles = "Admin, HC")]
    3. Build passes with ClosedXML using statements
  </verify>
  <done>
    - ClosedXML NuGet package installed
    - ExportResults action generates .xlsx file with all columns (title, category, user, NIP, section, score, pass%, status, date)
    - Export respects same filters as ReportsIndex
    - Export capped at 10,000 rows
    - Export button visible on ReportsIndex page, passes current filters
    - `dotnet build` passes with 0 errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add UserAssessmentHistory action and view</name>
  <files>
    Models/ReportsDashboardViewModel.cs
    Controllers/CMPController.cs
    Views/CMP/UserAssessmentHistory.cshtml
    Views/CMP/ReportsIndex.cshtml
  </files>
  <action>
    **Add `UserAssessmentHistoryViewModel` to `Models/ReportsDashboardViewModel.cs`:**

    ```csharp
    public class UserAssessmentHistoryViewModel
    {
        public string UserId { get; set; } = "";
        public string UserFullName { get; set; } = "";
        public string? UserNIP { get; set; }
        public string? UserSection { get; set; }
        public string? UserPosition { get; set; }
        public int TotalAssessments { get; set; }
        public int PassedCount { get; set; }
        public double PassRate { get; set; }
        public double AverageScore { get; set; }
        public List<AssessmentReportItem> Assessments { get; set; } = new();
    }
    ```

    **Add `UserAssessmentHistory` action to CMPController.cs:**

    Add a GET action `UserAssessmentHistory` with parameter `string userId` in the HC REPORTS section.

    Authorization: `[Authorize(Roles = "Admin, HC")]`

    Implementation:
    1. Load the target user: `var targetUser = await _context.Users.FirstOrDefaultAsync(u => u.Id == userId)`
    2. If null, return `NotFound()`
    3. Query completed assessments for this user:
       ```csharp
       var assessments = await _context.AssessmentSessions
           .Where(a => a.UserId == userId && a.Status == "Completed")
           .OrderByDescending(a => a.CompletedAt)
           .Select(a => new AssessmentReportItem
           {
               Id = a.Id,
               Title = a.Title,
               Category = a.Category,
               UserName = targetUser.FullName,
               UserNIP = targetUser.NIP,
               UserSection = targetUser.Section,
               Score = a.Score ?? 0,
               PassPercentage = a.PassPercentage,
               IsPassed = a.IsPassed ?? false,
               CompletedAt = a.CompletedAt
           })
           .ToListAsync();
       ```
    4. Calculate stats:
       - `totalAssessments = assessments.Count`
       - `passedCount = assessments.Count(a => a.IsPassed)`
       - `passRate = totalAssessments > 0 ? passedCount * 100.0 / totalAssessments : 0`
       - `averageScore = totalAssessments > 0 ? assessments.Average(a => (double)a.Score) : 0`
    5. Build `UserAssessmentHistoryViewModel` and return `View(viewModel)`

    **Create `Views/CMP/UserAssessmentHistory.cshtml`:**

    Structure:
    1. Model directive: `@model HcPortal.Models.UserAssessmentHistoryViewModel`
    2. Title: `ViewData["Title"] = $"{Model.UserFullName} - Assessment History";`
    3. Container wrapper: `<div class="container-fluid px-4 py-4">`

    4. **Breadcrumb navigation:**
       ```html
       <nav aria-label="breadcrumb" class="mb-3">
           <ol class="breadcrumb">
               <li class="breadcrumb-item"><a href="@Url.Action("ReportsIndex")">Assessment Reports</a></li>
               <li class="breadcrumb-item active">@Model.UserFullName</li>
           </ol>
       </nav>
       ```

    5. **User info header card** - `card border-0 shadow-sm mb-4`:
       - Card body with user details in a row:
         - Left side: User icon (bi-person-circle, large), FullName (h4), Position
         - Right side: 4 mini stat badges in a row: NIP, Section, Total Assessments, Pass Rate

    6. **Summary stats row** - 3 cards:
       - Total Assessments (bg-primary): `Model.TotalAssessments`
       - Pass Rate (bg-success): `Model.PassRate.ToString("F1")%`
       - Average Score (bg-info): `Model.AverageScore.ToString("F1")`

    7. **Assessment history table** - `card border-0 shadow-sm`:
       - Table with columns: #, Assessment, Category, Score, Pass %, Status, Completed, Actions
       - Loop over `Model.Assessments` with row numbers
       - Category as badge, Status as pass/fail badge
       - Actions: "View Results" link to `Url.Action("Results", new { id = item.Id })`
       - Empty state if no assessments

    8. **Back button:** Link back to ReportsIndex

    **Update ReportsIndex.cshtml results table:**

    Add a "View" action column to the results table. In each row, add a link:
    ```html
    <a href="@Url.Action("UserAssessmentHistory", new { userId = item.UserId })"
       class="btn btn-sm btn-outline-primary" title="View user history">
        <i class="bi bi-person-lines-fill"></i>
    </a>
    ```

    This requires adding `UserId` to the `AssessmentReportItem` class. Add: `public string UserId { get; set; } = "";`

    Also update the ReportsIndex controller action's `.Select()` to include: `UserId = a.UserId`

    And add a "View Results" link per row: `<a href="@Url.Action("Results", new { id = item.Id })" class="btn btn-sm btn-outline-info" title="View results"><i class="bi bi-eye"></i></a>`

    Wrap both action links in a `<div class="btn-group btn-group-sm">` for clean layout.
  </action>
  <verify>
    Run `dotnet build` from project root. Expect 0 errors. Verify:
    1. UserAssessmentHistoryViewModel exists in ReportsDashboardViewModel.cs
    2. UserAssessmentHistory action exists in CMPController
    3. Views/CMP/UserAssessmentHistory.cshtml exists with correct @model directive
    4. ReportsIndex table includes UserId-based action links
  </verify>
  <done>
    - UserAssessmentHistoryViewModel class exists with user info and assessment list
    - UserAssessmentHistory action loads user's completed assessments with stats
    - UserAssessmentHistory.cshtml shows user profile header, summary stats, and assessment history table
    - ReportsIndex table has action links to view user history and individual results
    - Breadcrumb navigation from history page back to reports
    - `dotnet build` passes with 0 errors
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` passes with 0 errors
2. Click "Export to Excel" on ReportsIndex - .xlsx file downloads with correct columns and data
3. Apply filters on ReportsIndex, then click Export - exported data matches filtered results
4. Click user history link on a result row - navigates to UserAssessmentHistory page showing that user's data
5. User history page shows correct stats (total, pass rate, average score) and assessment list
6. Click "View Results" from user history - navigates to individual assessment results page (from Phase 1)
7. Breadcrumb on user history correctly links back to ReportsIndex
</verification>

<success_criteria>
- Excel export downloads a properly formatted .xlsx file with all assessment data columns
- Export respects current filter selections from the reports page
- Export is capped at 10,000 rows for performance safety
- Individual user history page shows user profile and all their completed assessments
- Navigation flow works: Reports -> User History -> Individual Results and back
</success_criteria>

<output>
After completion, create `.planning/phases/02-hc-reports-dashboard/02-02-SUMMARY.md`
</output>
