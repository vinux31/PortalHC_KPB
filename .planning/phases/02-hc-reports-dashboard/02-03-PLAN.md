---
phase: 02-hc-reports-dashboard
plan: 03
type: execute
wave: 3
depends_on: ["02-01", "02-02"]
files_modified:
  - Controllers/CMPController.cs
  - Views/CMP/ReportsIndex.cshtml
autonomous: false

must_haves:
  truths:
    - "HC can see a bar chart showing pass rate by category on the reports dashboard"
    - "HC can see a bar chart showing score distribution (0-20, 21-40, 41-60, 61-80, 81-100) of completed assessments"
    - "Charts update to reflect current filter selections (filtered data drives chart content)"
    - "Dashboard visual layout is clean and professional with charts below the results table"
  artifacts:
    - path: "Controllers/CMPController.cs"
      provides: "Category statistics and score distribution data passed to ReportsIndex view"
      contains: "CategoryStats"
    - path: "Views/CMP/ReportsIndex.cshtml"
      provides: "Chart.js bar charts for pass rate by category and score distribution"
      contains: "chart.js"
  key_links:
    - from: "Views/CMP/ReportsIndex.cshtml"
      to: "Controllers/CMPController.cs"
      via: "ViewBag.CategoryStats and ViewBag.ScoreDistribution serialized to JSON"
      pattern: "Json.Serialize"
    - from: "Views/CMP/ReportsIndex.cshtml"
      to: "Chart.js CDN"
      via: "script tag importing Chart.js library"
      pattern: "cdn.jsdelivr.net/npm/chart.js"
---

<objective>
Add performance analytics charts to the HC Reports Dashboard using Chart.js for visual data analysis.

Purpose: Enable HC staff to quickly identify performance trends across categories and understand score distributions, making the dashboard actionable for training decisions.

Output: Two interactive Chart.js charts on the Reports Dashboard page - pass rate by category and score distribution histogram.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-hc-reports-dashboard/02-RESEARCH.md
@.planning/phases/02-hc-reports-dashboard/02-01-SUMMARY.md
@.planning/phases/02-hc-reports-dashboard/02-02-SUMMARY.md
@Models/ReportsDashboardViewModel.cs
@Controllers/CMPController.cs
@Views/CMP/ReportsIndex.cshtml
@Views/CDP/Dashboard.cshtml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add chart data to controller and Chart.js visualization to view</name>
  <files>
    Controllers/CMPController.cs
    Views/CMP/ReportsIndex.cshtml
  </files>
  <action>
    **Update ReportsIndex action in CMPController.cs:**

    After the existing summary stats calculation (before building the ViewModel), add two data aggregation queries:

    1. **Category statistics** using EF Core GroupBy on the FILTERED query (same `query` variable that has filters applied):
       ```csharp
       var categoryStats = await query
           .GroupBy(a => a.Category)
           .Select(g => new CategoryStatistic
           {
               CategoryName = g.Key,
               TotalAssessments = g.Count(),
               PassedCount = g.Count(a => a.IsPassed == true),
               PassRate = g.Count() > 0
                   ? Math.Round(g.Count(a => a.IsPassed == true) * 100.0 / g.Count(), 1)
                   : 0,
               AverageScore = Math.Round(g.Average(a => (double?)a.Score) ?? 0, 1)
           })
           .OrderBy(c => c.CategoryName)
           .ToListAsync();
       ```

    2. **Score distribution** - calculate histogram buckets. Since EF Core may struggle with complex GroupBy bucketing, do this in memory from the filtered query (scores are just integers, no heavy load):
       ```csharp
       var allScores = await query.Select(a => a.Score ?? 0).ToListAsync();
       var scoreDistribution = new List<int>
       {
           allScores.Count(s => s >= 0 && s <= 20),
           allScores.Count(s => s >= 21 && s <= 40),
           allScores.Count(s => s >= 41 && s <= 60),
           allScores.Count(s => s >= 61 && s <= 80),
           allScores.Count(s => s >= 81 && s <= 100)
       };
       ```

    Pass both to the view via ViewBag:
    ```csharp
    ViewBag.CategoryStats = categoryStats;
    ViewBag.ScoreDistribution = scoreDistribution;
    ```

    **Update Views/CMP/ReportsIndex.cshtml:**

    1. Add Chart.js CDN script tag at the top of the file (after the @model directive, before the container div), matching the pattern in CDP Dashboard:
       ```html
       <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
       ```

    2. Add a charts section BELOW the results table card but still inside the container. Create a `row g-4 mt-4` with two chart cards:

       **Left card (col-lg-6): Pass Rate by Category**
       ```html
       <div class="col-lg-6">
           <div class="card border-0 shadow-sm h-100">
               <div class="card-header bg-white py-3">
                   <h6 class="fw-bold mb-0">
                       <i class="bi bi-bar-chart-fill me-2 text-primary"></i>Pass Rate by Category
                   </h6>
               </div>
               <div class="card-body">
                   <canvas id="categoryChart" height="300"></canvas>
               </div>
           </div>
       </div>
       ```

       **Right card (col-lg-6): Score Distribution**
       ```html
       <div class="col-lg-6">
           <div class="card border-0 shadow-sm h-100">
               <div class="card-header bg-white py-3">
                   <h6 class="fw-bold mb-0">
                       <i class="bi bi-graph-up me-2 text-info"></i>Score Distribution
                   </h6>
               </div>
               <div class="card-body">
                   <canvas id="scoreChart" height="300"></canvas>
               </div>
           </div>
       </div>
       ```

    3. Add Chart.js initialization in a `@section Scripts {}` block at the bottom of the file:

       ```html
       @section Scripts {
       <script>
           // Category Pass Rate Chart
           var categoryStats = @Html.Raw(Json.Serialize(ViewBag.CategoryStats));

           if (categoryStats && categoryStats.length > 0) {
               var ctxCategory = document.getElementById('categoryChart').getContext('2d');
               new Chart(ctxCategory, {
                   type: 'bar',
                   data: {
                       labels: categoryStats.map(c => c.categoryName),
                       datasets: [
                           {
                               label: 'Pass Rate (%)',
                               data: categoryStats.map(c => c.passRate),
                               backgroundColor: 'rgba(13, 110, 253, 0.7)',
                               borderColor: 'rgba(13, 110, 253, 1)',
                               borderWidth: 1
                           },
                           {
                               label: 'Avg Score',
                               data: categoryStats.map(c => c.averageScore),
                               backgroundColor: 'rgba(25, 135, 84, 0.7)',
                               borderColor: 'rgba(25, 135, 84, 1)',
                               borderWidth: 1
                           }
                       ]
                   },
                   options: {
                       responsive: true,
                       maintainAspectRatio: false,
                       scales: {
                           y: {
                               beginAtZero: true,
                               max: 100,
                               ticks: {
                                   callback: function(value) { return value + '%'; }
                               }
                           }
                       },
                       plugins: {
                           tooltip: {
                               callbacks: {
                                   label: function(context) {
                                       return context.dataset.label + ': ' + context.parsed.y + '%';
                                   }
                               }
                           }
                       }
                   }
               });
           } else {
               document.getElementById('categoryChart').parentElement.innerHTML =
                   '<div class="text-center text-muted py-5"><i class="bi bi-bar-chart text-muted" style="font-size:3rem;"></i><p class="mt-2">No data available for chart</p></div>';
           }

           // Score Distribution Chart
           var scoreDistribution = @Html.Raw(Json.Serialize(ViewBag.ScoreDistribution));
           var scoreLabels = ['0-20', '21-40', '41-60', '61-80', '81-100'];
           var scoreColors = [
               'rgba(220, 53, 69, 0.7)',   // red (very low)
               'rgba(255, 193, 7, 0.7)',    // yellow (low)
               'rgba(13, 202, 240, 0.7)',   // cyan (medium)
               'rgba(13, 110, 253, 0.7)',   // blue (good)
               'rgba(25, 135, 84, 0.7)'     // green (excellent)
           ];

           if (scoreDistribution && scoreDistribution.some(v => v > 0)) {
               var ctxScore = document.getElementById('scoreChart').getContext('2d');
               new Chart(ctxScore, {
                   type: 'bar',
                   data: {
                       labels: scoreLabels,
                       datasets: [{
                           label: 'Number of Assessments',
                           data: scoreDistribution,
                           backgroundColor: scoreColors,
                           borderColor: scoreColors.map(c => c.replace('0.7', '1')),
                           borderWidth: 1
                       }]
                   },
                   options: {
                       responsive: true,
                       maintainAspectRatio: false,
                       scales: {
                           y: {
                               beginAtZero: true,
                               ticks: {
                                   stepSize: 1,
                                   precision: 0
                               }
                           },
                           x: {
                               title: {
                                   display: true,
                                   text: 'Score Range'
                               }
                           }
                       },
                       plugins: {
                           tooltip: {
                               callbacks: {
                                   label: function(context) {
                                       return context.parsed.y + ' assessment(s)';
                                   }
                               }
                           }
                       }
                   }
               });
           } else {
               document.getElementById('scoreChart').parentElement.innerHTML =
                   '<div class="text-center text-muted py-5"><i class="bi bi-graph-up text-muted" style="font-size:3rem;"></i><p class="mt-2">No data available for chart</p></div>';
           }
       </script>
       }
       ```

    **Chart behavior:**
    - Charts reflect filtered data (since category stats and score distribution are calculated from the filtered `query`)
    - Empty state shown when no data matches filters
    - Colors follow Bootstrap 5 palette for consistency
    - Charts are responsive and contained within cards
  </action>
  <verify>
    Run `dotnet build` from project root. Expect 0 errors. Verify:
    1. CMPController ReportsIndex action passes CategoryStats and ScoreDistribution via ViewBag
    2. ReportsIndex.cshtml contains chart.js CDN and two canvas elements
    3. JavaScript initializes both charts from serialized JSON data
  </verify>
  <done>
    - Pass Rate by Category bar chart displays on reports dashboard
    - Score Distribution histogram displays with color-coded ranges
    - Charts reflect currently applied filters
    - Empty state shown when no data available
    - Charts use Chart.js CDN (consistent with CDP Dashboard pattern)
    - `dotnet build` passes with 0 errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete reports dashboard</name>
  <files>Views/CMP/ReportsIndex.cshtml, Controllers/CMPController.cs, Views/CMP/UserAssessmentHistory.cshtml, Views/Shared/_Layout.cshtml</files>
  <action>
This is a human verification checkpoint. Present the user with the verification steps below. All implementation was completed in Plans 02-01, 02-02, and Task 1 of this plan -- this task confirms the complete Phase 2 workflow functions correctly via manual testing.

Complete HC Reports Dashboard includes:
1. Summary statistics cards (total assigned, completed, pass rate, average score)
2. Filter form (category, section, date range, user search)
3. Paginated results table with action links
4. Excel export (downloads .xlsx with filtered data)
5. Individual user assessment history page
6. Performance analytics charts (pass rate by category, score distribution)
7. Navigation link in CMP dropdown (HC/Admin only)
  </action>
  <verify>
    1. Run the application: `dotnet run`
    2. Log in as an Admin or HC user
    3. Navigate to CMP dropdown in navbar - verify "Assessment Reports" link appears under "Reports" section
    4. Click "Assessment Reports" - verify dashboard loads with:
       - 4 summary cards showing correct counts
       - Filter form with category and section dropdowns populated from database
       - Results table with assessment data (if completed assessments exist)
       - Two charts at bottom: Pass Rate by Category and Score Distribution
    5. Test filters:
       - Select a category - table and charts update
       - Enter a date range - results filter to range
       - Search by user name - results filter to matching users
       - Clear filters - all results shown again
    6. Test pagination: If >20 results, verify page 2 keeps filter selections
    7. Click "Export to Excel" - .xlsx file downloads with correct data
    8. Click user history icon on a row - individual user assessment history page loads
    9. On user history page, click "View Results" - navigates to Phase 1 results page
    10. Log out and log in as a non-HC user (e.g., Coachee) - verify "Assessment Reports" link is NOT visible and direct URL access returns 403
  </verify>
  <done>
Complete HC Reports Dashboard verified: stats cards, filters, pagination, Excel export, user history drill-down, Chart.js analytics, and role-based authorization all working correctly.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` passes with 0 errors
2. Reports dashboard shows two properly rendered charts reflecting filtered data
3. Category chart shows bar for each category with pass rate and average score
4. Score distribution chart shows 5 score range buckets with assessment counts
5. Applying filters updates both charts and the results table
6. Full end-to-end flow works: Dashboard → Filters → Export → User History → Results
7. Authorization enforced on all reports endpoints
</verification>

<success_criteria>
- Pass Rate by Category chart displays with correct data per category
- Score Distribution chart displays histogram with color-coded score ranges
- Charts update when filters are applied (reflects filtered data, not all data)
- Complete reports workflow verified by user: stats, filters, table, export, user history, charts
- All reports pages accessible only to Admin/HC roles
</success_criteria>

<output>
After completion, create `.planning/phases/02-hc-reports-dashboard/02-03-SUMMARY.md`
</output>
