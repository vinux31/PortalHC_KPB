---
phase: 03-kkj-cpdp-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Models/Competency/AssessmentCompetencyMap.cs
  - Models/Competency/UserCompetencyLevel.cs
  - Models/Competency/CompetencyGapViewModel.cs
  - Data/ApplicationDbContext.cs
  - Helpers/PositionTargetHelper.cs
autonomous: true
must_haves:
  truths:
    - "New competency tracking models exist and are registered in DbContext"
    - "Position-to-KKJ-column mapping resolves target levels for all 15 positions"
    - "Database migration creates AssessmentCompetencyMaps and UserCompetencyLevels tables"
  artifacts:
    - path: "Models/Competency/AssessmentCompetencyMap.cs"
      provides: "Join table linking assessments to KKJ competencies"
      contains: "class AssessmentCompetencyMap"
    - path: "Models/Competency/UserCompetencyLevel.cs"
      provides: "Per-user competency level tracking with history"
      contains: "class UserCompetencyLevel"
    - path: "Models/Competency/CompetencyGapViewModel.cs"
      provides: "ViewModels for gap analysis dashboard"
      contains: "class CompetencyGapViewModel"
    - path: "Data/ApplicationDbContext.cs"
      provides: "DbSet registrations and relationship configuration for new entities"
      contains: "DbSet<AssessmentCompetencyMap>"
    - path: "Helpers/PositionTargetHelper.cs"
      provides: "Static helper to resolve target level from KkjMatrixItem based on user position"
      contains: "class PositionTargetHelper"
  key_links:
    - from: "Models/Competency/AssessmentCompetencyMap.cs"
      to: "Models/KkjModels.cs"
      via: "FK to KkjMatrixItem"
      pattern: "KkjMatrixItemId"
    - from: "Models/Competency/UserCompetencyLevel.cs"
      to: "Models/ApplicationUser.cs"
      via: "FK to ApplicationUser"
      pattern: "UserId"
    - from: "Data/ApplicationDbContext.cs"
      to: "Models/Competency/"
      via: "DbSet registration and OnModelCreating config"
      pattern: "AssessmentCompetencyMaps|UserCompetencyLevels"
---

<objective>
Create the data foundation for competency tracking by adding new EF Core models, DbContext configuration, database migration, and a position-to-target-level mapping helper.

Purpose: All subsequent plans (gap analysis, auto-update, CPDP tracking) depend on these models and the migration being in place. This is the horizontal foundation that enables the vertical feature slices.

Output: Three new model files, updated DbContext, position mapping helper, and a working database migration.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-kkj-cpdp-integration/03-RESEARCH.md
@Models/KkjModels.cs
@Models/AssessmentSession.cs
@Models/ApplicationUser.cs
@Models/IdpItem.cs
@Data/ApplicationDbContext.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create competency tracking models and ViewModels</name>
  <files>
    Models/Competency/AssessmentCompetencyMap.cs
    Models/Competency/UserCompetencyLevel.cs
    Models/Competency/CompetencyGapViewModel.cs
  </files>
  <action>
Create a `Models/Competency/` directory and add three model files:

**1. AssessmentCompetencyMap.cs** - Join table linking assessment categories to KKJ competencies:
- `int Id` (PK)
- `int KkjMatrixItemId` (FK to KkjMatrixItem)
- `KkjMatrixItem? KkjMatrixItem` (navigation)
- `string AssessmentCategory` - matches AssessmentSession.Category (e.g., "Assessment OJ", "IHT", "Licencor")
- `string? TitlePattern` - optional pattern match against AssessmentSession.Title for finer-grained mapping
- `int LevelGranted` - competency level awarded when assessment is passed (1-5 scale)
- `int? MinimumScoreRequired` - nullable; if null, uses assessment's PassPercentage
- Namespace: `HcPortal.Models.Competency`

**2. UserCompetencyLevel.cs** - Tracks each user's current level per competency:
- `int Id` (PK)
- `string UserId` (FK to ApplicationUser)
- `ApplicationUser? User` (navigation)
- `int KkjMatrixItemId` (FK to KkjMatrixItem)
- `KkjMatrixItem? KkjMatrixItem` (navigation)
- `int CurrentLevel` (0-5, default 0)
- `int TargetLevel` (0-5, denormalized from KKJ matrix at creation time)
- `string Source` - how level was achieved: "Assessment", "Manual", "Training"
- `int? AssessmentSessionId` (FK to AssessmentSession, nullable)
- `AssessmentSession? AssessmentSession` (navigation)
- `DateTime AchievedAt` = DateTime.UtcNow
- `DateTime? UpdatedAt`
- `string? UpdatedBy` - UserId of HC staff who manually adjusted
- Computed property: `int Gap => TargetLevel - CurrentLevel`
- Namespace: `HcPortal.Models.Competency`

**3. CompetencyGapViewModel.cs** - ViewModels for gap analysis:
- `CompetencyGapViewModel` class:
  - `string UserId`, `string UserName`, `string? Position`, `string? Section`
  - `List<CompetencyGapItem> Competencies`
  - `int TotalCompetencies`, `int CompetenciesMet`, `int CompetenciesGapped`
  - `double OverallProgress` (percentage 0-100)
- `CompetencyGapItem` class:
  - `int KkjMatrixItemId`, `string Kompetensi`, `string SkillGroup`
  - `int CurrentLevel`, `int TargetLevel`, `int Gap`
  - `string Status` ("Met", "Gap", "Not Started")
  - `DateTime? LastUpdated`, `string? LastAssessmentTitle`
  - `bool HasIdpActivity`, `string? SuggestedAction`
- Namespace: `HcPortal.Models.Competency`

Use `using HcPortal.Models;` at top of each file to reference existing models.
  </action>
  <verify>
    Build the project with `dotnet build` - no compilation errors.
    Verify all three files exist in Models/Competency/ directory.
  </verify>
  <done>
    Three model files compile successfully. AssessmentCompetencyMap has FK to KkjMatrixItem, UserCompetencyLevel has FKs to User/KkjMatrixItem/AssessmentSession, CompetencyGapViewModel has both ViewModel and Item classes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update DbContext, create position helper, and run migration</name>
  <files>
    Data/ApplicationDbContext.cs
    Helpers/PositionTargetHelper.cs
  </files>
  <action>
**1. Update ApplicationDbContext.cs:**

Add these using statements at top:
```
using HcPortal.Models.Competency;
```

Add DbSet properties after existing CpdpItems DbSet:
```csharp
// Competency Tracking
public DbSet<AssessmentCompetencyMap> AssessmentCompetencyMaps { get; set; }
public DbSet<UserCompetencyLevel> UserCompetencyLevels { get; set; }
```

Add relationship configuration in OnModelCreating after the CpdpItem configuration block:

For AssessmentCompetencyMap:
- `entity.ToTable("AssessmentCompetencyMaps")`
- HasOne to KkjMatrixItem with Cascade delete
- Index on AssessmentCategory
- Composite index on {AssessmentCategory, TitlePattern}

For UserCompetencyLevel:
- `entity.ToTable("UserCompetencyLevels")`
- HasOne(c => c.User).WithMany().HasForeignKey(c => c.UserId).OnDelete(Cascade)
- HasOne(c => c.KkjMatrixItem).WithMany().HasForeignKey(c => c.KkjMatrixItemId).OnDelete(Restrict)
- HasOne(c => c.AssessmentSession).WithMany().HasForeignKey(c => c.AssessmentSessionId).OnDelete(SetNull)
- Unique index on {UserId, KkjMatrixItemId} to enforce one level per user per competency
- Check constraints: CurrentLevel 0-5, TargetLevel 0-5
- Ignore the computed Gap property: `entity.Ignore(c => c.Gap)`

**2. Create Helpers/PositionTargetHelper.cs:**

Create `Helpers/` directory and add a static helper class:
- Namespace: `HcPortal.Helpers`
- Static class `PositionTargetHelper`
- Private static readonly `Dictionary<string, string> PositionColumnMap` mapping user Position strings to KkjMatrixItem property names. Include all 15 positions from KkjMatrixItem model:
  - "Section Head" -> "Target_SectionHead"
  - "Sr Supervisor GSH" -> "Target_SrSpv_GSH"
  - "Shift Supervisor GSH" -> "Target_ShiftSpv_GSH"
  - "Panelman GSH 12-13" -> "Target_Panelman_GSH_12_13"
  - "Panelman GSH 14" -> "Target_Panelman_GSH_14"
  - "Operator GSH 8-11" -> "Target_Operator_GSH_8_11"
  - "Operator GSH 12-13" -> "Target_Operator_GSH_12_13"
  - "Shift Supervisor ARU" -> "Target_ShiftSpv_ARU"
  - "Panelman ARU 12-13" -> "Target_Panelman_ARU_12_13"
  - "Panelman ARU 14" -> "Target_Panelman_ARU_14"
  - "Operator ARU 8-11" -> "Target_Operator_ARU_8_11"
  - "Operator ARU 12-13" -> "Target_Operator_ARU_12_13"
  - "Sr Supervisor Facility" -> "Target_SrSpv_Facility"
  - "Jr Analyst" -> "Target_JrAnalyst"
  - "HSE Officer" -> "Target_HSE"
- Static method `int GetTargetLevel(KkjMatrixItem competency, string? userPosition)`:
  - If position null/empty or not in map, return 0 (not applicable)
  - Use reflection to get property value from KkjMatrixItem by column name
  - Parse value: treat "-" as 0, parse numeric strings to int
  - Return parsed level or 0 if unparseable
- Static method `string? GetColumnName(string? position)` to expose the mapping lookup for testing
- Static method `List<string> GetAllPositions()` returning all valid position keys

**3. Create EF Core migration:**

Run: `dotnet ef migrations add AddCompetencyTracking`

This creates the migration files in the Migrations directory. Then apply:

Run: `dotnet ef database update`

If `dotnet ef` is not available globally, use: `dotnet tool install --global dotnet-ef` first, or use the project-level approach: the project may already be configured for migrations.

Note: If the migration fails because GETUTCDATE() is not supported (SQLite), check Program.cs for the DB provider and adjust. The existing codebase uses SQLite for development and SQL Server for production, so the migration should work with the correct provider.
  </action>
  <verify>
    1. `dotnet build` succeeds with no errors
    2. Migration files exist in Migrations/ directory
    3. `dotnet ef database update` succeeds (or the app starts without migration errors)
    4. Verify PositionTargetHelper resolves at least 3 known positions correctly by checking the dictionary has 15 entries
  </verify>
  <done>
    DbContext has new DbSets and relationship configuration. PositionTargetHelper correctly maps all 15 positions. Database migration creates AssessmentCompetencyMaps and UserCompetencyLevels tables with proper constraints and indexes.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` compiles without errors
2. Models/Competency/ directory contains 3 files
3. Helpers/PositionTargetHelper.cs exists with 15 position mappings
4. ApplicationDbContext.cs has DbSet<AssessmentCompetencyMap> and DbSet<UserCompetencyLevel>
5. Database migration exists and applies successfully
</verification>

<success_criteria>
- All new models compile and reference existing models correctly via navigation properties
- DbContext registers new entities with proper FK relationships, indexes, and constraints
- Position helper maps all 15 KkjMatrixItem target columns to user position strings
- Database migration creates tables without errors
- No existing functionality is broken (dotnet build succeeds, app starts)
</success_criteria>

<output>
After completion, create `.planning/phases/03-kkj-cpdp-integration/03-01-SUMMARY.md`
</output>
