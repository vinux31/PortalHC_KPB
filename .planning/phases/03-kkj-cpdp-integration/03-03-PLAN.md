---
phase: 03-kkj-cpdp-integration
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - Controllers/CMPController.cs
  - Views/CMP/CompetencyGap.cshtml
  - Views/CMP/Index.cshtml
autonomous: true
must_haves:
  truths:
    - "User can view their current competency level vs target level for each KKJ skill"
    - "System displays radar chart gap analysis visualization showing which competencies need development"
    - "System generates automatic IDP suggestions when competency gaps are detected"
    - "HC can view any user's competency gap analysis by selecting a user"
  artifacts:
    - path: "Views/CMP/CompetencyGap.cshtml"
      provides: "Gap analysis dashboard with radar chart and competency table"
      contains: "competencyRadarChart"
    - path: "Controllers/CMPController.cs"
      provides: "CompetencyGap action with gap calculation and IDP suggestion logic"
      contains: "CompetencyGap"
  key_links:
    - from: "Controllers/CMPController.cs"
      to: "Models/Competency/CompetencyGapViewModel.cs"
      via: "Builds CompetencyGapViewModel from database queries"
      pattern: "CompetencyGapViewModel"
    - from: "Controllers/CMPController.cs"
      to: "Helpers/PositionTargetHelper.cs"
      via: "Resolves target levels for gap calculation"
      pattern: "PositionTargetHelper.GetTargetLevel"
    - from: "Views/CMP/CompetencyGap.cshtml"
      to: "Chart.js CDN"
      via: "Radar chart for visual gap analysis"
      pattern: "chart.js.*type.*radar"
    - from: "Views/CMP/CompetencyGap.cshtml"
      to: "Models/Competency/CompetencyGapViewModel.cs"
      via: "Razor @model directive"
      pattern: "@model.*CompetencyGapViewModel"
---

<objective>
Build the gap analysis dashboard that shows users their current vs target competency levels with a radar chart visualization and automatic IDP suggestions for competency gaps.

Purpose: This plan delivers the core user-facing value of Phase 3 - making competency gaps visible and actionable. Users see where they stand, what they need to develop, and get specific suggestions. This closes Success Criteria 1 (view current vs target), 2 (gap analysis visualization), and 3 (automatic IDP suggestions).

Output: CompetencyGap controller action, CompetencyGap.cshtml view with radar chart and gap table, CMP navigation update.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-kkj-cpdp-integration/03-RESEARCH.md
@.planning/phases/03-kkj-cpdp-integration/03-01-SUMMARY.md
@Controllers/CMPController.cs
@Models/Competency/CompetencyGapViewModel.cs
@Models/Competency/UserCompetencyLevel.cs
@Models/KkjModels.cs
@Models/IdpItem.cs
@Helpers/PositionTargetHelper.cs
@Data/ApplicationDbContext.cs
@Views/CMP/Index.cshtml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CompetencyGap controller action with gap calculation and IDP suggestions</name>
  <files>
    Controllers/CMPController.cs
  </files>
  <action>
Add the following to CMPController.cs (ensure `using HcPortal.Models.Competency;` and `using HcPortal.Helpers;` are present - may already be added by Plan 02):

**1. CompetencyGap action (GET):**

```csharp
// --- COMPETENCY GAP ANALYSIS ---
public async Task<IActionResult> CompetencyGap(string? userId = null)
{
    var currentUser = await _userManager.GetUserAsync(User);
    if (currentUser == null) return Challenge();

    var userRoles = await _userManager.GetRolesAsync(currentUser);
    var isHcOrAdmin = userRoles.Contains("Admin") || userRoles.Contains("HC");

    // Determine target user: HC/Admin can view any user, others view themselves
    var targetUserId = (isHcOrAdmin && !string.IsNullOrEmpty(userId)) ? userId : currentUser.Id;
    var targetUser = await _userManager.FindByIdAsync(targetUserId);

    if (targetUser == null) return NotFound();

    // Get all KKJ competencies relevant to user's position
    var allCompetencies = await _context.KkjMatrices
        .OrderBy(k => k.No)
        .ToListAsync();

    // Filter to competencies that have a non-zero target for this position
    var relevantCompetencies = allCompetencies
        .Where(k => PositionTargetHelper.GetTargetLevel(k, targetUser.Position) > 0)
        .ToList();

    // Get user's current competency levels
    var userLevels = await _context.UserCompetencyLevels
        .Include(c => c.KkjMatrixItem)
        .Include(c => c.AssessmentSession)
        .Where(c => c.UserId == targetUserId)
        .ToListAsync();

    // Check existing IDP activities for gap items
    var userIdpItems = await _context.IdpItems
        .Where(i => i.UserId == targetUserId)
        .ToListAsync();

    // Load CPDP items for IDP suggestion generation
    var cpdpItems = await _context.CpdpItems.ToListAsync();

    // Build gap items
    var gapItems = relevantCompetencies.Select(comp =>
    {
        var userLevel = userLevels.FirstOrDefault(ul => ul.KkjMatrixItemId == comp.Id);
        int current = userLevel?.CurrentLevel ?? 0;
        int target = PositionTargetHelper.GetTargetLevel(comp, targetUser.Position);
        int gap = target - current;

        // Check for existing IDP activity matching this competency
        bool hasIdp = userIdpItems.Any(i =>
            i.Kompetensi != null && comp.Kompetensi.Contains(i.Kompetensi, StringComparison.OrdinalIgnoreCase));

        return new CompetencyGapItem
        {
            KkjMatrixItemId = comp.Id,
            Kompetensi = comp.Kompetensi,
            SkillGroup = comp.SkillGroup,
            CurrentLevel = current,
            TargetLevel = target,
            Gap = gap,
            Status = gap <= 0 ? "Met" : (current == 0 ? "Not Started" : "Gap"),
            LastUpdated = userLevel?.UpdatedAt ?? userLevel?.AchievedAt,
            LastAssessmentTitle = userLevel?.AssessmentSession?.Title,
            HasIdpActivity = hasIdp,
            SuggestedAction = gap > 0 ? GenerateIdpSuggestion(comp, gap, cpdpItems) : null
        };
    })
    .OrderByDescending(g => g.Gap)
    .ThenBy(g => g.Kompetensi)
    .ToList();

    var viewModel = new CompetencyGapViewModel
    {
        UserId = targetUserId,
        UserName = targetUser.FullName,
        Position = targetUser.Position,
        Section = targetUser.Section,
        Competencies = gapItems,
        TotalCompetencies = gapItems.Count,
        CompetenciesMet = gapItems.Count(c => c.Status == "Met"),
        CompetenciesGapped = gapItems.Count(c => c.Status != "Met"),
        OverallProgress = gapItems.Count > 0
            ? Math.Round(gapItems.Count(c => c.Status == "Met") * 100.0 / gapItems.Count, 1)
            : 0
    };

    // For HC/Admin: provide user list for dropdown
    if (isHcOrAdmin)
    {
        var allUsers = await _userManager.Users
            .OrderBy(u => u.FullName)
            .Select(u => new { u.Id, u.FullName, u.Position, u.Section })
            .ToListAsync();
        ViewBag.AllUsers = allUsers;
        ViewBag.SelectedUserId = targetUserId;
    }

    ViewBag.IsHcOrAdmin = isHcOrAdmin;

    return View(viewModel);
}
```

**2. IDP suggestion generator (private helper):**

```csharp
private string GenerateIdpSuggestion(KkjMatrixItem competency, int gap, List<CpdpItem> cpdpItems)
{
    // Try to find matching CPDP item for specific suggestion
    var matchingCpdp = cpdpItems.FirstOrDefault(c =>
        c.NamaKompetensi.Contains(competency.Kompetensi, StringComparison.OrdinalIgnoreCase) ||
        competency.Kompetensi.Contains(c.NamaKompetensi, StringComparison.OrdinalIgnoreCase));

    if (matchingCpdp != null && !string.IsNullOrEmpty(matchingCpdp.Silabus))
    {
        var target = !string.IsNullOrEmpty(matchingCpdp.TargetDeliverable)
            ? $" Target: {matchingCpdp.TargetDeliverable}"
            : "";
        return $"Complete training: {matchingCpdp.Silabus}.{target}";
    }

    // Fallback: generate based on gap size
    return gap switch
    {
        >= 3 => $"Large gap detected. Recommend structured training program for {competency.Kompetensi}.",
        2 => $"Consider intermediate-level assessment or on-the-job training for {competency.Kompetensi}.",
        _ => $"Schedule next-level assessment to advance in {competency.Kompetensi}."
    };
}
```

Place the private helper method near the bottom of the class, after the existing helper methods.
  </action>
  <verify>
    `dotnet build` succeeds. The CompetencyGap action exists in CMPController and returns a View with CompetencyGapViewModel. The GenerateIdpSuggestion helper method exists.
  </verify>
  <done>
    CompetencyGap controller action calculates gap data for any user (self for regular users, selectable for HC/Admin), generates IDP suggestions from CPDP data, and passes CompetencyGapViewModel to the view. GenerateIdpSuggestion produces actionable suggestions using CPDP syllabus data.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CompetencyGap view with radar chart and gap table</name>
  <files>
    Views/CMP/CompetencyGap.cshtml
    Views/CMP/Index.cshtml
  </files>
  <action>
**1. Create Views/CMP/CompetencyGap.cshtml:**

Build a full gap analysis dashboard following the project's Bootstrap 5 + Chart.js patterns (established in Phase 2).

Structure:
```
@model HcPortal.Models.Competency.CompetencyGapViewModel
@{ ViewData["Title"] = "Competency Gap Analysis"; }
```

**Header section:**
- Page title "Competency Gap Analysis" with bi-bar-chart-steps icon
- If HC/Admin: user selection dropdown (select element with onchange redirect to `/CMP/CompetencyGap?userId=...`)
- User info card showing: FullName, Position, Section

**Summary statistics row (4 columns on lg, 2 on md, 1 on sm):**
- Card 1: Total Competencies (bg-primary text)
- Card 2: Met (bg-success text, count of Met)
- Card 3: Gap (bg-warning text, count of Gap)
- Card 4: Overall Progress (progress bar, percentage)

Use Bootstrap cards with `border-0 shadow-sm` styling (consistent with existing views).

**Radar Chart section:**
- Card with header "Competency Profile"
- Canvas element `id="competencyRadarChart"` with height 400
- Include Chart.js via CDN: `https://cdn.jsdelivr.net/npm/chart.js`
- Two datasets: "Current Level" (blue, solid) and "Target Level" (red, dashed border)
- Take top 8 competencies with highest gaps for readability (Model.Competencies.Take(8))
- Radar scale: min 0, max 5, stepSize 1
- Responsive and maintainAspectRatio false
- If no competencies, show "No competency data available for your position" message instead of chart

**Gap Table section:**
- Card with header "Competency Details"
- Responsive Bootstrap table (`table-hover`)
- Columns: Competency, Skill Group, Current Level, Target Level, Gap, Status, Last Assessment, Suggested Action
- Status badges: "Met" = green badge, "Gap" = warning badge, "Not Started" = secondary badge
- Gap column: show gap number with color coding (red if >= 3, orange if 2, yellow if 1, green if 0)
- CurrentLevel and TargetLevel shown as progress-like indicators (e.g., "2/5")
- SuggestedAction shown in small text, only if gap > 0
- HasIdpActivity: show a small "IDP Active" badge next to the suggestion if true
- If no competencies at all, show empty state message: "No competency targets found for your position. Please contact HC."

**Chart.js script block:**
```javascript
const competencyData = {
    labels: @Html.Raw(Json.Serialize(Model.Competencies.Take(8).Select(c => c.Kompetensi))),
    current: @Html.Raw(Json.Serialize(Model.Competencies.Take(8).Select(c => c.CurrentLevel))),
    target: @Html.Raw(Json.Serialize(Model.Competencies.Take(8).Select(c => c.TargetLevel)))
};

// Only create chart if data exists
if (competencyData.labels.length > 0) {
    const ctx = document.getElementById('competencyRadarChart').getContext('2d');
    new Chart(ctx, {
        type: 'radar',
        data: {
            labels: competencyData.labels,
            datasets: [
                {
                    label: 'Current Level',
                    data: competencyData.current,
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    pointBackgroundColor: 'rgb(54, 162, 235)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgb(54, 162, 235)'
                },
                {
                    label: 'Target Level',
                    data: competencyData.target,
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    pointBackgroundColor: 'rgb(255, 99, 132)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgb(255, 99, 132)',
                    borderDash: [5, 5]
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    min: 0,
                    max: 5,
                    ticks: { stepSize: 1 }
                }
            },
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
}
```

**2. Update Views/CMP/Index.cshtml:**

Add a navigation link/card to the CMP index page for "Competency Gap Analysis". Look at the existing Index.cshtml structure and add a card or link matching the existing pattern. The link should point to `@Url.Action("CompetencyGap", "CMP")` with an appropriate icon (bi-bar-chart-steps or bi-radar) and description like "View your competency levels vs targets with gap analysis".
  </action>
  <verify>
    1. `dotnet build` succeeds
    2. CompetencyGap.cshtml exists in Views/CMP/
    3. Index.cshtml contains a link to CompetencyGap
    4. Run `dotnet run` and navigate to /CMP/CompetencyGap to verify page loads (may show empty state if no data)
  </verify>
  <done>
    CompetencyGap view displays radar chart comparing current vs target levels, summary statistics (total, met, gapped, progress %), detailed gap table with status badges, IDP suggestions with CPDP-sourced actions, and HC/Admin user selector. CMP index page links to the new view. Page handles empty state gracefully.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` compiles without errors
2. Navigate to /CMP/CompetencyGap - page loads with radar chart or empty state
3. Summary cards show correct counts (total, met, gap, progress)
4. Radar chart renders with two datasets (current blue solid, target red dashed)
5. Gap table shows competencies ordered by gap size (largest first)
6. IDP suggestions appear for gapped competencies
7. HC/Admin can select different users from dropdown
8. CMP Index page has navigation link to CompetencyGap
</verification>

<success_criteria>
- User sees their current competency levels compared to position targets (Success Criterion 1)
- Radar chart provides visual gap analysis (Success Criterion 2)
- IDP suggestions auto-generated from CPDP data for gapped competencies (Success Criterion 3)
- HC/Admin can view any user's gap analysis
- Page handles edge cases: no position, no competencies, no user levels
- Chart.js radar chart renders correctly with up to 8 competencies
</success_criteria>

<output>
After completion, create `.planning/phases/03-kkj-cpdp-integration/03-03-SUMMARY.md`
</output>
