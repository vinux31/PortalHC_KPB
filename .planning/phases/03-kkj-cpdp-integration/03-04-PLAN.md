---
phase: 03-kkj-cpdp-integration
plan: 04
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified:
  - Models/Competency/CpdpProgressViewModel.cs
  - Controllers/CMPController.cs
  - Views/CMP/CpdpProgress.cshtml
  - Views/CMP/CompetencyGap.cshtml
autonomous: false
must_haves:
  truths:
    - "CPDP progress tracking page shows assessment completions as evidence of competency development"
    - "Each CPDP competency displays linked assessment results and competency level achievement"
    - "User can navigate between gap analysis and CPDP progress tracking views"
    - "HC can track which assessments validate which skills for any user"
  artifacts:
    - path: "Models/Competency/CpdpProgressViewModel.cs"
      provides: "ViewModel for CPDP progress tracking with assessment evidence"
      contains: "class CpdpProgressViewModel"
    - path: "Views/CMP/CpdpProgress.cshtml"
      provides: "CPDP progress tracking page with assessment evidence per competency"
      contains: "CpdpProgress"
    - path: "Controllers/CMPController.cs"
      provides: "CpdpProgress action aggregating CPDP items with assessment and competency data"
      contains: "CpdpProgress"
  key_links:
    - from: "Controllers/CMPController.cs"
      to: "Models/Competency/CpdpProgressViewModel.cs"
      via: "Builds CpdpProgressViewModel from CPDP + assessment + competency queries"
      pattern: "CpdpProgressViewModel"
    - from: "Controllers/CMPController.cs"
      to: "Data/ApplicationDbContext.cs"
      via: "Queries CpdpItems, UserCompetencyLevels, AssessmentCompetencyMaps"
      pattern: "CpdpItems.*UserCompetencyLevels"
    - from: "Views/CMP/CpdpProgress.cshtml"
      to: "Views/CMP/CompetencyGap.cshtml"
      via: "Cross-navigation links between gap analysis and CPDP tracking"
      pattern: "CompetencyGap|CpdpProgress"
---

<objective>
Build the CPDP progress tracking view that shows how assessment completions and scores serve as evidence of competency development, linking CPDP framework items to actual assessment results and competency level achievements.

Purpose: This closes Success Criteria 4 (CPDP progress tracking reflects assessment completions) and 5 (assessment results linked to specific CPDP competencies). It provides HC with a unified view of which assessments validate which skills, completing the full integration loop.

Output: CpdpProgressViewModel, CpdpProgress controller action, CpdpProgress view with assessment evidence, cross-navigation links, and a visual verification checkpoint.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-kkj-cpdp-integration/03-RESEARCH.md
@.planning/phases/03-kkj-cpdp-integration/03-01-SUMMARY.md
@.planning/phases/03-kkj-cpdp-integration/03-02-SUMMARY.md
@.planning/phases/03-kkj-cpdp-integration/03-03-SUMMARY.md
@Controllers/CMPController.cs
@Models/Competency/CompetencyGapViewModel.cs
@Models/Competency/UserCompetencyLevel.cs
@Models/Competency/AssessmentCompetencyMap.cs
@Models/KkjModels.cs
@Data/ApplicationDbContext.cs
@Views/CMP/Mapping.cshtml
@Views/CMP/CompetencyGap.cshtml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CpdpProgress ViewModel and controller action</name>
  <files>
    Models/Competency/CpdpProgressViewModel.cs
    Controllers/CMPController.cs
  </files>
  <action>
**1. Create Models/Competency/CpdpProgressViewModel.cs:**

```csharp
namespace HcPortal.Models.Competency;

public class CpdpProgressViewModel
{
    public string UserId { get; set; } = "";
    public string UserName { get; set; } = "";
    public string? Position { get; set; }
    public string? Section { get; set; }

    public List<CpdpProgressItem> Items { get; set; } = new();

    // Summary
    public int TotalCpdpItems { get; set; }
    public int ItemsWithEvidence { get; set; }
    public double EvidenceCoverage { get; set; } // Percentage of CPDP items with at least one assessment
}

public class CpdpProgressItem
{
    public int CpdpItemId { get; set; }
    public string No { get; set; } = "";
    public string NamaKompetensi { get; set; } = "";
    public string IndikatorPerilaku { get; set; } = "";
    public string Silabus { get; set; } = "";
    public string TargetDeliverable { get; set; } = "";
    public string CpdpStatus { get; set; } = ""; // Original CPDP status

    // Competency tracking
    public int? CurrentLevel { get; set; }
    public int? TargetLevel { get; set; }
    public string CompetencyStatus { get; set; } = "Not Tracked"; // "Met", "Gap", "Not Started", "Not Tracked"

    // Assessment evidence
    public List<AssessmentEvidence> Evidences { get; set; } = new();

    // IDP activity
    public bool HasIdpActivity { get; set; }
    public string? IdpStatus { get; set; }
}

public class AssessmentEvidence
{
    public int AssessmentSessionId { get; set; }
    public string Title { get; set; } = "";
    public string Category { get; set; } = "";
    public int? Score { get; set; }
    public bool? IsPassed { get; set; }
    public DateTime? CompletedAt { get; set; }
    public int LevelGranted { get; set; }
}
```

**2. Add CpdpProgress action to CMPController.cs:**

```csharp
// --- CPDP PROGRESS TRACKING ---
public async Task<IActionResult> CpdpProgress(string? userId = null)
{
    var currentUser = await _userManager.GetUserAsync(User);
    if (currentUser == null) return Challenge();

    var userRoles = await _userManager.GetRolesAsync(currentUser);
    var isHcOrAdmin = userRoles.Contains("Admin") || userRoles.Contains("HC");

    var targetUserId = (isHcOrAdmin && !string.IsNullOrEmpty(userId)) ? userId : currentUser.Id;
    var targetUser = await _userManager.FindByIdAsync(targetUserId);

    if (targetUser == null) return NotFound();

    // Load all CPDP items
    var cpdpItems = await _context.CpdpItems.OrderBy(c => c.No).ToListAsync();

    // Load user's competency levels
    var userLevels = await _context.UserCompetencyLevels
        .Include(c => c.KkjMatrixItem)
        .Include(c => c.AssessmentSession)
        .Where(c => c.UserId == targetUserId)
        .ToListAsync();

    // Load all assessment-competency mappings to find linked assessments
    var competencyMaps = await _context.AssessmentCompetencyMaps
        .Include(m => m.KkjMatrixItem)
        .ToListAsync();

    // Load user's completed assessments for evidence
    var userAssessments = await _context.AssessmentSessions
        .Where(a => a.UserId == targetUserId && a.Status == "Completed")
        .OrderByDescending(a => a.CompletedAt)
        .ToListAsync();

    // Load user's IDP items for cross-referencing
    var userIdpItems = await _context.IdpItems
        .Where(i => i.UserId == targetUserId)
        .ToListAsync();

    // Load KKJ items for target level resolution
    var kkjItems = await _context.KkjMatrices.ToListAsync();

    // Build progress items
    var progressItems = cpdpItems.Select(cpdp =>
    {
        // Find matching KKJ competency by name
        var matchingKkj = kkjItems.FirstOrDefault(k =>
            k.Kompetensi.Contains(cpdp.NamaKompetensi, StringComparison.OrdinalIgnoreCase) ||
            cpdp.NamaKompetensi.Contains(k.Kompetensi, StringComparison.OrdinalIgnoreCase));

        // Get user's competency level for this KKJ item
        var userLevel = matchingKkj != null
            ? userLevels.FirstOrDefault(ul => ul.KkjMatrixItemId == matchingKkj.Id)
            : null;

        int? currentLevel = userLevel?.CurrentLevel;
        int? targetLevel = matchingKkj != null
            ? PositionTargetHelper.GetTargetLevel(matchingKkj, targetUser.Position)
            : null;

        // Determine competency status
        string compStatus = "Not Tracked";
        if (targetLevel.HasValue && targetLevel.Value > 0)
        {
            if (currentLevel.HasValue && currentLevel.Value >= targetLevel.Value)
                compStatus = "Met";
            else if (currentLevel.HasValue && currentLevel.Value > 0)
                compStatus = "Gap";
            else
                compStatus = "Not Started";
        }

        // Find assessment evidence: assessments mapped to this competency's KKJ item
        var evidences = new List<AssessmentEvidence>();
        if (matchingKkj != null)
        {
            var mappingsForCompetency = competencyMaps
                .Where(m => m.KkjMatrixItemId == matchingKkj.Id)
                .ToList();

            foreach (var mapping in mappingsForCompetency)
            {
                var matchingAssessments = userAssessments
                    .Where(a => a.Category == mapping.AssessmentCategory &&
                               (mapping.TitlePattern == null || a.Title.Contains(mapping.TitlePattern)))
                    .ToList();

                foreach (var assessment in matchingAssessments)
                {
                    // Avoid duplicate evidence entries
                    if (!evidences.Any(e => e.AssessmentSessionId == assessment.Id))
                    {
                        evidences.Add(new AssessmentEvidence
                        {
                            AssessmentSessionId = assessment.Id,
                            Title = assessment.Title,
                            Category = assessment.Category,
                            Score = assessment.Score,
                            IsPassed = assessment.IsPassed,
                            CompletedAt = assessment.CompletedAt,
                            LevelGranted = mapping.LevelGranted
                        });
                    }
                }
            }
        }

        // Check IDP activity
        var idpMatch = userIdpItems.FirstOrDefault(i =>
            i.Kompetensi != null && (
                cpdp.NamaKompetensi.Contains(i.Kompetensi, StringComparison.OrdinalIgnoreCase) ||
                i.Kompetensi.Contains(cpdp.NamaKompetensi, StringComparison.OrdinalIgnoreCase)));

        return new CpdpProgressItem
        {
            CpdpItemId = cpdp.Id,
            No = cpdp.No,
            NamaKompetensi = cpdp.NamaKompetensi,
            IndikatorPerilaku = cpdp.IndikatorPerilaku,
            Silabus = cpdp.Silabus,
            TargetDeliverable = cpdp.TargetDeliverable,
            CpdpStatus = cpdp.Status,
            CurrentLevel = currentLevel,
            TargetLevel = targetLevel > 0 ? targetLevel : null,
            CompetencyStatus = compStatus,
            Evidences = evidences.OrderByDescending(e => e.CompletedAt).ToList(),
            HasIdpActivity = idpMatch != null,
            IdpStatus = idpMatch?.Status
        };
    }).ToList();

    var viewModel = new CpdpProgressViewModel
    {
        UserId = targetUserId,
        UserName = targetUser.FullName,
        Position = targetUser.Position,
        Section = targetUser.Section,
        Items = progressItems,
        TotalCpdpItems = progressItems.Count,
        ItemsWithEvidence = progressItems.Count(i => i.Evidences.Any()),
        EvidenceCoverage = progressItems.Count > 0
            ? Math.Round(progressItems.Count(i => i.Evidences.Any()) * 100.0 / progressItems.Count, 1)
            : 0
    };

    if (isHcOrAdmin)
    {
        var allUsers = await _userManager.Users
            .OrderBy(u => u.FullName)
            .Select(u => new { u.Id, u.FullName, u.Position, u.Section })
            .ToListAsync();
        ViewBag.AllUsers = allUsers;
        ViewBag.SelectedUserId = targetUserId;
    }

    ViewBag.IsHcOrAdmin = isHcOrAdmin;

    return View(viewModel);
}
```
  </action>
  <verify>
    `dotnet build` succeeds. CpdpProgressViewModel.cs exists. CpdpProgress action exists in CMPController.
  </verify>
  <done>
    CpdpProgress action loads CPDP framework items, cross-references with KKJ competencies, user competency levels, completed assessments, and IDP items to produce a comprehensive progress tracking view. Each CPDP item shows assessment evidence and competency status.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CpdpProgress view and add cross-navigation links</name>
  <files>
    Views/CMP/CpdpProgress.cshtml
    Views/CMP/CompetencyGap.cshtml
  </files>
  <action>
**1. Create Views/CMP/CpdpProgress.cshtml:**

Full Razor view following project conventions (Bootstrap 5, shadow-sm cards, bi icons):

```
@model HcPortal.Models.Competency.CpdpProgressViewModel
@{ ViewData["Title"] = "CPDP Progress Tracking"; }
```

**Header:**
- Title "CPDP Progress Tracking" with bi-journal-check icon
- If HC/Admin: user selection dropdown (same pattern as CompetencyGap view)
- User info card showing FullName, Position, Section
- Navigation tabs/buttons: "Gap Analysis" (link to CompetencyGap) | "CPDP Progress" (active)

**Summary cards row (3 columns on lg):**
- Card 1: Total CPDP Items (count)
- Card 2: Items with Assessment Evidence (count, bg-success)
- Card 3: Evidence Coverage (percentage with progress bar)

**CPDP Items accordion/table:**
Use Bootstrap accordion pattern for each CPDP item. Each accordion item shows:

**Header (collapsed):** No | NamaKompetensi | CompetencyStatus badge | Evidence count badge

**Body (expanded):**
- Row 1: IndikatorPerilaku (label + value)
- Row 2: Silabus (label + value)
- Row 3: TargetDeliverable (label + value)
- Row 4: Competency Level Progress (CurrentLevel / TargetLevel with small progress bar, if tracked)
- Row 5: Assessment Evidence table:
  - If evidences exist: table with columns Title, Category, Score, Pass/Fail, Date, Level Granted
    - Score shown with color coding (green if passed, red if failed)
    - Each assessment title links to `/CMP/Results/{id}`
  - If no evidences: "No assessment evidence yet. Complete related assessments to track progress."
- Row 6: IDP Activity:
  - If HasIdpActivity: "IDP Active: {IdpStatus}" badge
  - If not: "No IDP activity for this competency"

**Status badges (consistent with CompetencyGap):**
- "Met" = success badge (green)
- "Gap" = warning badge (orange)
- "Not Started" = secondary badge (gray)
- "Not Tracked" = light badge (lighter gray)

**2. Update Views/CMP/CompetencyGap.cshtml:**

Add a navigation link to CpdpProgress at the top of the page, near the title or as a secondary navigation:

Add a row of navigation links/tabs above the content:
```html
<div class="mb-3">
    <a href="@Url.Action("CompetencyGap", "CMP", new { userId = Model.UserId })" class="btn btn-primary btn-sm active">
        <i class="bi bi-bar-chart-steps me-1"></i>Gap Analysis
    </a>
    <a href="@Url.Action("CpdpProgress", "CMP", new { userId = Model.UserId })" class="btn btn-outline-primary btn-sm">
        <i class="bi bi-journal-check me-1"></i>CPDP Progress
    </a>
</div>
```

Also add the same navigation in CpdpProgress.cshtml but with the active/outline reversed.
  </action>
  <verify>
    1. `dotnet build` succeeds
    2. CpdpProgress.cshtml exists in Views/CMP/
    3. CompetencyGap.cshtml has navigation link to CpdpProgress
    4. CpdpProgress.cshtml has navigation link back to CompetencyGap
    5. Run `dotnet run` and navigate to /CMP/CpdpProgress - page loads
  </verify>
  <done>
    CpdpProgress view shows CPDP framework items in accordion layout with assessment evidence, competency status, and IDP activity per item. Summary cards show evidence coverage. Cross-navigation links connect CompetencyGap and CpdpProgress views. HC/Admin can select users.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual verification of Phase 3 integration</name>
  <files>Views/CMP/CompetencyGap.cshtml, Views/CMP/CpdpProgress.cshtml, Controllers/CMPController.cs</files>
  <action>
This is a human verification checkpoint. All implementation was completed in Plans 01-04 Tasks 1-2. This task confirms the end-to-end KKJ/CPDP integration workflow functions correctly via manual testing.
  </action>
  <what-built>
    Complete KKJ/CPDP integration with:
    1. Competency tracking data models and database migration
    2. Automatic competency level updates on assessment completion
    3. Gap analysis dashboard with radar chart
    4. CPDP progress tracking with assessment evidence
    5. Cross-navigation between views
  </what-built>
  <how-to-verify>
    1. Start the app: `dotnet run`
    2. Login as any user
    3. Navigate to CMP > Competency Gap Analysis
       - Verify: Summary cards show competency counts
       - Verify: Radar chart shows current vs target levels (may be empty if no assessments completed)
       - Verify: Gap table lists competencies with status badges
       - Verify: IDP suggestions appear for gapped competencies
    4. Click "CPDP Progress" navigation tab
       - Verify: CPDP items listed in accordion
       - Verify: Assessment evidence shown for items with completed assessments
       - Verify: Competency status badges appear correctly
    5. If HC/Admin login: verify user dropdown appears and can switch between users
    6. Navigate back to CMP Index page
       - Verify: Link to Competency Gap Analysis exists
    7. (Optional) Take and submit an assessment, then verify competency levels updated in Gap Analysis view
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
  <verify>User visually confirms all pages load correctly, radar chart renders, gap table populates, CPDP progress shows assessment evidence, and navigation works.</verify>
  <done>All five Phase 3 success criteria verified: competency levels vs targets visible, gap analysis visualization works, IDP suggestions generate, CPDP progress reflects assessments, and assessment-competency links are traceable.</done>
</task>

</tasks>

<verification>
1. `dotnet build` compiles without errors
2. /CMP/CpdpProgress loads and shows CPDP items with assessment evidence
3. /CMP/CompetencyGap has link to CpdpProgress and vice versa
4. CPDP items show competency status (Met/Gap/Not Started/Not Tracked)
5. Assessment evidence table links back to individual assessment results
6. HC/Admin can view any user's CPDP progress
7. All five Phase 3 success criteria verified via visual inspection
</verification>

<success_criteria>
- CPDP progress tracking shows assessment completions as evidence (Success Criterion 4)
- Assessment results linked to specific CPDP competencies visible to HC (Success Criterion 5)
- Cross-navigation between CompetencyGap and CpdpProgress works bidirectionally
- Page handles edge cases: no CPDP data, no assessments, no competency tracking
- Visual verification confirms full Phase 3 integration works end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/03-kkj-cpdp-integration/03-04-SUMMARY.md`
</output>
