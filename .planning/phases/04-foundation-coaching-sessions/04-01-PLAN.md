---
phase: 04-foundation-coaching-sessions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Models/CoachingSession.cs
  - Models/ActionItem.cs
  - Models/CoachingViewModels.cs
  - Models/CoachingLog.cs
  - Data/ApplicationDbContext.cs
autonomous: true

must_haves:
  truths:
    - "CoachingSession and ActionItem models exist with correct properties and relationships"
    - "CoachCoacheeMapping is registered in DbContext and has a table in the database"
    - "TrackingItemId column is removed from CoachingLogs table and CoachingLog model"
    - "Application builds and migration applies without errors"
  artifacts:
    - path: "Models/CoachingSession.cs"
      provides: "Coaching session entity with date, topic, notes, status, coach/coachee IDs"
      contains: "public class CoachingSession"
    - path: "Models/ActionItem.cs"
      provides: "Action item entity with description, due date, status, FK to CoachingSession"
      contains: "public class ActionItem"
    - path: "Models/CoachingViewModels.cs"
      provides: "CoachingHistoryViewModel, CreateSessionViewModel, AddActionItemViewModel"
      contains: "public class CoachingHistoryViewModel"
    - path: "Data/ApplicationDbContext.cs"
      provides: "DbSets for CoachingSessions, ActionItems, CoachCoacheeMappings with relationship config"
      contains: "DbSet<CoachingSession>"
  key_links:
    - from: "Models/ActionItem.cs"
      to: "Models/CoachingSession.cs"
      via: "FK CoachingSessionId with Cascade delete"
      pattern: "public int CoachingSessionId"
    - from: "Data/ApplicationDbContext.cs"
      to: "Models/CoachingSession.cs"
      via: "DbSet registration and OnModelCreating config"
      pattern: "DbSet<CoachingSession>"
---

<objective>
Create the data foundation for coaching sessions: new CoachingSession and ActionItem models, ViewModels, DbContext registration (including orphaned CoachCoacheeMapping), CoachingLog cleanup, and a single EF Core migration.

Purpose: Establish the stable data layer that COACH-01, COACH-02, COACH-03 controller/view work depends on. Also fixes the broken TrackingItemId column and registers CoachCoacheeMapping for Phase 5.
Output: New model files, updated DbContext, applied migration. `dotnet build` passes.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-foundation-coaching-sessions/04-RESEARCH.md
@Data/ApplicationDbContext.cs
@Models/CoachingLog.cs
@Models/CoachCoacheeMapping.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CoachingSession, ActionItem models and ViewModels</name>
  <files>Models/CoachingSession.cs, Models/ActionItem.cs, Models/CoachingViewModels.cs</files>
  <action>
Create three new files in the Models directory:

**Models/CoachingSession.cs** — New entity for coaching sessions (COACH-01):
```csharp
namespace HcPortal.Models
{
    public class CoachingSession
    {
        public int Id { get; set; }
        public string CoachId { get; set; } = "";      // string ID, no FK — matches CoachingLog pattern
        public string CoacheeId { get; set; } = "";    // string ID, no FK
        public DateTime Date { get; set; }
        public string Topic { get; set; } = "";
        public string? Notes { get; set; }
        public string Status { get; set; } = "Draft";  // "Draft", "Submitted"
        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
        public DateTime? UpdatedAt { get; set; }
        public ICollection<ActionItem> ActionItems { get; set; } = new List<ActionItem>();
    }
}
```

**Models/ActionItem.cs** — Child entity for per-session action items (COACH-02):
```csharp
namespace HcPortal.Models
{
    public class ActionItem
    {
        public int Id { get; set; }
        public int CoachingSessionId { get; set; }
        public CoachingSession? CoachingSession { get; set; }
        public string Description { get; set; } = "";
        public DateTime DueDate { get; set; }
        public string Status { get; set; } = "Open";   // "Open", "In Progress", "Done"
        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    }
}
```

**Models/CoachingViewModels.cs** — ViewModels for the coaching views:
```csharp
namespace HcPortal.Models
{
    public class CoachingHistoryViewModel
    {
        public DateTime? FromDate { get; set; }
        public DateTime? ToDate { get; set; }
        public string? StatusFilter { get; set; }
        public List<CoachingSession> Sessions { get; set; } = new();
        public int TotalSessions => Sessions.Count;
        public int DraftSessions => Sessions.Count(s => s.Status == "Draft");
        public int SubmittedSessions => Sessions.Count(s => s.Status == "Submitted");
        public int TotalActionItems => Sessions.Sum(s => s.ActionItems?.Count ?? 0);
        public int OpenActionItems => Sessions
            .SelectMany(s => s.ActionItems ?? new List<ActionItem>())
            .Count(a => a.Status == "Open");
    }

    public class CreateSessionViewModel
    {
        public string CoacheeId { get; set; } = "";
        public DateTime Date { get; set; }
        public string Topic { get; set; } = "";
        public string? Notes { get; set; }
    }

    public class AddActionItemViewModel
    {
        public string Description { get; set; } = "";
        public DateTime DueDate { get; set; }
    }
}
```

Also update **Models/CoachingLog.cs** — Remove the `TrackingItemId` property (line 11: `public int TrackingItemId { get; set; }`). Keep all other properties unchanged. The column will be dropped in the migration.
  </action>
  <verify>Run `dotnet build` from project root — must compile with no errors.</verify>
  <done>Three new model files exist. CoachingLog.cs no longer has TrackingItemId property. Build succeeds.</done>
</task>

<task type="auto">
  <name>Task 2: Register entities in DbContext and run migration</name>
  <files>Data/ApplicationDbContext.cs</files>
  <action>
Update `Data/ApplicationDbContext.cs`:

**Add three DbSets** in the DbSets section (after the existing `DbSet<UserCompetencyLevel>` line):
```csharp
// Coaching Sessions (Phase 4)
public DbSet<CoachingSession> CoachingSessions { get; set; }
public DbSet<ActionItem> ActionItems { get; set; }
public DbSet<CoachCoacheeMapping> CoachCoacheeMappings { get; set; }
```

**Add OnModelCreating configuration** at the end of the `OnModelCreating` method, before the closing braces:

```csharp
// CoachingSession configuration
builder.Entity<CoachingSession>(entity =>
{
    entity.HasIndex(s => s.CoachId);
    entity.HasIndex(s => s.CoacheeId);
    entity.HasIndex(s => new { s.CoacheeId, s.Date });
    entity.Property(s => s.CreatedAt).HasDefaultValueSql("GETUTCDATE()");
});

// ActionItem configuration
builder.Entity<ActionItem>(entity =>
{
    entity.HasOne(a => a.CoachingSession)
        .WithMany(s => s.ActionItems)
        .HasForeignKey(a => a.CoachingSessionId)
        .OnDelete(DeleteBehavior.Cascade);
    entity.HasIndex(a => a.CoachingSessionId);
    entity.HasIndex(a => a.Status);
    entity.Property(a => a.CreatedAt).HasDefaultValueSql("GETUTCDATE()");
});

// CoachCoacheeMapping configuration
builder.Entity<CoachCoacheeMapping>(entity =>
{
    entity.HasIndex(m => m.CoachId);
    entity.HasIndex(m => m.CoacheeId);
    entity.HasIndex(m => new { m.CoachId, m.CoacheeId });
});
```

**Then run the migration** from the project root:
```bash
dotnet ef migrations add AddCoachingFoundation
dotnet ef database update
```

The migration should automatically:
1. Drop `TrackingItemId` column from `CoachingLogs` (detected from model change)
2. Create `CoachCoacheeMappings` table
3. Create `CoachingSessions` table
4. Create `ActionItems` table with FK to CoachingSessions (Cascade delete)

After migration applies, verify the migration file was generated correctly by reading it. If the migration does NOT include dropping `TrackingItemId`, the snapshot may be out of sync — in that case, check the generated migration and manually add `migrationBuilder.DropColumn(name: "TrackingItemId", table: "CoachingLogs")` to the Up method.
  </action>
  <verify>
Run `dotnet build` — must pass. Run `dotnet ef database update` — must apply without errors. Verify migration file exists in Migrations/ directory and contains CreateTable for CoachingSessions, ActionItems, CoachCoacheeMappings, and DropColumn for TrackingItemId.
  </verify>
  <done>
DbContext has DbSets for CoachingSessions, ActionItems, CoachCoacheeMappings. Migration applied successfully. Database has new tables. TrackingItemId column removed from CoachingLogs.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` passes with zero errors
2. Migration file exists in Migrations/ and includes all 4 operations (3 CreateTable + 1 DropColumn)
3. `dotnet ef database update` applies cleanly
4. DbContext has DbSet<CoachingSession>, DbSet<ActionItem>, DbSet<CoachCoacheeMapping>
5. CoachingLog.cs no longer has TrackingItemId property
</verification>

<success_criteria>
- CoachingSession.cs, ActionItem.cs, CoachingViewModels.cs created with correct properties
- CoachingLog.cs TrackingItemId property removed
- ApplicationDbContext.cs has 3 new DbSets with OnModelCreating configuration
- EF Core migration generated and applied — CoachingSessions, ActionItems, CoachCoacheeMappings tables exist; TrackingItemId column dropped from CoachingLogs
- `dotnet build` succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/04-foundation-coaching-sessions/04-01-SUMMARY.md`
</output>
