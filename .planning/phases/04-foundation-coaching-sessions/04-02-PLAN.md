---
phase: 04-foundation-coaching-sessions
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - Controllers/CDPController.cs
  - Views/CDP/Coaching.cshtml
autonomous: true

must_haves:
  truths:
    - "Coach can create a coaching session with date, topic, and notes for a coachee"
    - "Coach can add action items with due dates to a coaching session"
    - "User can view their coaching session history with date and status filtering"
    - "All existing v1.0 features remain functional (no regression)"
  artifacts:
    - path: "Controllers/CDPController.cs"
      provides: "Coaching GET with filters, CreateSession POST, AddActionItem POST"
      contains: "CreateSession"
    - path: "Views/CDP/Coaching.cshtml"
      provides: "Coaching history view with create form, filter controls, session list with action items"
      contains: "CoachingHistoryViewModel"
  key_links:
    - from: "Views/CDP/Coaching.cshtml"
      to: "Controllers/CDPController.cs"
      via: "form POST to CreateSession and AddActionItem actions"
      pattern: "asp-action=\"CreateSession\""
    - from: "Controllers/CDPController.cs"
      to: "Data/ApplicationDbContext.cs"
      via: "LINQ queries on CoachingSessions and ActionItems DbSets"
      pattern: "_context\\.CoachingSessions"
    - from: "Views/CDP/Coaching.cshtml"
      to: "Models/CoachingViewModels.cs"
      via: "@model directive"
      pattern: "@model.*CoachingHistoryViewModel"
---

<objective>
Build the controller actions and view for coaching session management: update CDPController.Coaching() GET with date/status filtering, add CreateSession and AddActionItem POST actions, and replace the stub Coaching.cshtml with a real form-backed view.

Purpose: Delivers COACH-01 (log sessions), COACH-02 (add action items), and COACH-03 (view history with filtering) — the three user-facing requirements for Phase 4.
Output: Working coaching page where coaches can create sessions with action items and all users can view/filter their history.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-foundation-coaching-sessions/04-RESEARCH.md
@.planning/phases/04-foundation-coaching-sessions/04-01-SUMMARY.md
@Controllers/CDPController.cs
@Views/CDP/Coaching.cshtml
@Models/UserRoles.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update CDPController with Coaching GET filters and POST actions</name>
  <files>Controllers/CDPController.cs</files>
  <action>
Modify `Controllers/CDPController.cs` — rewrite the `Coaching()` GET method and add two new POST methods. Keep ALL existing methods (Index, PlanIdp, Dashboard, Progress) unchanged.

**Replace the existing `Coaching()` method** with a version that:
1. Accepts optional filter parameters: `DateTime? fromDate`, `DateTime? toDate`, `string? status`
2. Queries `_context.CoachingSessions.Include(s => s.ActionItems)` instead of `_context.CoachingLogs`
3. Filters by role: Coach role (level 5) and Admin with Coach/Atasan/HC views see sessions they coach (`s.CoachId == userId`). Coachee role (level 6) and Admin with Coachee view see sessions about them (`s.CoacheeId == userId`). Admin with HC view sees all sessions.
4. Applies date range and status filters when provided
5. Orders by Date descending
6. Builds a coachee list for the create form dropdown: query `_context.Users` where `Section == user.Section && RoleLevel == 6`, ordered by FullName. Only populate for Coach role or Admin (non-Coachee view).
7. Returns `View(new CoachingHistoryViewModel { FromDate, ToDate, StatusFilter, Sessions })` with `ViewBag.CoacheeList` and `ViewBag.UserRole` and `ViewBag.IsCoach` (bool indicating if user can create sessions)

Follow the research example in 04-RESEARCH.md "Coaching GET with Filters" section. Key differences from existing code:
- Use `CoachingSessions` not `CoachingLogs`
- Include ActionItems via `.Include()`
- Return `CoachingHistoryViewModel` not `List<CoachingLog>`
- Add filter parameters

**Add `CreateSession` POST method** (COACH-01):
```csharp
[HttpPost]
[ValidateAntiForgeryToken]
public async Task<IActionResult> CreateSession(CreateSessionViewModel model)
```
- Get current user. If null, return Challenge().
- Remove "CoachId" from ModelState (set server-side).
- If ModelState invalid, set TempData["Error"] and RedirectToAction("Coaching").
- Create new CoachingSession with CoachId = user.Id, fields from model, Status = "Draft", CreatedAt = DateTime.UtcNow.
- Save to DB. Set TempData["Success"] = "Sesi coaching berhasil dicatat."
- RedirectToAction("Coaching").
- Only users with coaching role (Coach, SrSupervisor, SectionHead, Admin, HC) should be able to create sessions. Use role check: if user's RoleLevel > 5 (Coachee only), return Forbid().

**Add `AddActionItem` POST method** (COACH-02):
```csharp
[HttpPost]
[ValidateAntiForgeryToken]
public async Task<IActionResult> AddActionItem(int sessionId, AddActionItemViewModel model)
```
- Get current user. If null, return Challenge().
- Find session by sessionId where CoachId == user.Id. If not found, return NotFound().
- If ModelState invalid, set TempData["Error"] and RedirectToAction("Coaching").
- Create new ActionItem with CoachingSessionId = sessionId, fields from model, Status = "Open", CreatedAt = DateTime.UtcNow.
- Save to DB. Set TempData["Success"] = "Action item berhasil ditambahkan."
- RedirectToAction("Coaching").

Follow the patterns from 04-RESEARCH.md code examples. Use TempData for success/error messages (consistent with CMPController pattern). Use `[ValidateAntiForgeryToken]` on both POST actions.
  </action>
  <verify>Run `dotnet build` — must pass with zero errors. Verify the three methods exist: Coaching (GET with 3 optional params), CreateSession (POST), AddActionItem (POST).</verify>
  <done>CDPController has updated Coaching GET (with fromDate, toDate, status filters returning CoachingHistoryViewModel), CreateSession POST, and AddActionItem POST. Build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Replace Coaching.cshtml with real form-backed view</name>
  <files>Views/CDP/Coaching.cshtml</files>
  <action>
Replace the entire contents of `Views/CDP/Coaching.cshtml` with a proper view backed by `CoachingHistoryViewModel`. The view must have these sections:

**1. @model directive:** `@model HcPortal.Models.CoachingHistoryViewModel`

**2. Page header:** Title "Laporan Coaching & Mentoring" with a "Catat Sesi Baru" button (visible only for Coach role via `ViewBag.IsCoach`) that opens a Bootstrap modal.

**3. Summary cards row** (3-4 cards, same style as existing — use `border-start border-4` pattern from current stub):
- Total Sesi: `@Model.TotalSessions` (bi-journal-text icon, primary border)
- Submitted: `@Model.SubmittedSessions` (bi-check-circle icon, success border)
- Action Items: `@Model.TotalActionItems` with `@Model.OpenActionItems` open (bi-list-task icon, warning border)

**4. Filter bar** (collapsible card, same pattern as CMP Reports filters):
- Form with GET method, asp-action="Coaching"
- Date range: two `<input type="date">` for fromDate and toDate, pre-filled with `Model.FromDate?.ToString("yyyy-MM-dd")` and `Model.ToDate?.ToString("yyyy-MM-dd")`
- Status dropdown: `<select>` with options All/"Draft"/"Submitted", selected matching `Model.StatusFilter`
- Filter button + Reset link (href to Coaching without params)

**5. Session history list** — For each session in `Model.Sessions`, render a card:
- Card header: Date (dd MMM yyyy format), Status badge (Draft = warning, Submitted = success), Topic as title
- Card body: Notes text (if present), Coach/Coachee name display
- Action items sub-section: table or list showing each ActionItem with Description, DueDate (dd MMM yyyy), Status badge (Open = secondary, In Progress = info, Done = success)
- "Tambah Action Item" button (only if ViewBag.IsCoach is true) that shows an inline form or small modal with sessionId, Description textarea, DueDate input, and submit button posting to AddActionItem

For coach/coachee name display: use ViewBag to pass a dictionary of user IDs to names. In the controller, pre-fetch user names for all CoachIds and CoacheeIds in the session list. Alternatively, display the IDs and add a TODO comment for name resolution — but preferably, in the controller Coaching() GET method, build a `Dictionary<string, string>` mapping userId to FullName for all unique CoachIds/CoacheeIds in the returned sessions, and pass it via `ViewBag.UserNames`.

**6. Create Session Modal** (`#createSessionModal`):
- Form with POST method, asp-action="CreateSession"
- `@Html.AntiForgeryToken()`
- Coachee dropdown: `<select name="CoacheeId">` populated from `ViewBag.CoacheeList` (List<ApplicationUser>), displaying FullName and Position
- Date input: `<input type="date" name="Date">` defaulting to today
- Topic input: `<input type="text" name="Topic">` with placeholder "Contoh: Review Progress Bulanan"
- Notes textarea: `<textarea name="Notes">` with placeholder
- Submit button: "Simpan Sesi"

**7. TempData alerts** at the top of the page:
```razor
@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show">
        <i class="bi bi-check-circle me-2"></i>@TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show">
        <i class="bi bi-exclamation-circle me-2"></i>@TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}
```

**8. Empty state** — when `Model.Sessions.Count == 0`, show a centered message with icon: "Belum ada sesi coaching. Mulai catat sesi pertama Anda."

**Style notes:**
- Use Bootstrap 5 classes consistent with existing views (shadow-sm, border-0, rounded cards)
- Use Bootstrap Icons (bi-*) throughout — same CDN already loaded in _Layout.cshtml
- Use the same card styling patterns from the existing Coaching.cshtml stub (border-start border-4 pattern)
- Indonesian language for all user-facing text (consistent with existing views)
- Do NOT add any JavaScript beyond what Bootstrap 5 provides (modals, collapse, alerts are all native BS5)

**Add action item inline form approach:** For each session card, include a collapsed form (Bootstrap collapse) toggled by "Tambah Action Item" button. The form posts to AddActionItem with a hidden `sessionId` field:
```html
<form method="post" asp-action="AddActionItem">
    @Html.AntiForgeryToken()
    <input type="hidden" name="sessionId" value="@session.Id" />
    <div class="row g-2">
        <div class="col-md-6">
            <input type="text" name="Description" class="form-control form-control-sm" placeholder="Deskripsi action item" required />
        </div>
        <div class="col-md-4">
            <input type="date" name="DueDate" class="form-control form-control-sm" required />
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-sm btn-primary w-100">Tambah</button>
        </div>
    </div>
</form>
```
  </action>
  <verify>
Run `dotnet build` — must pass. Then run the application (`dotnet run`) and navigate to /CDP/Coaching in a browser. Verify:
1. Page loads without errors
2. Summary cards show correct counts (0 initially)
3. Filter form is visible and functional
4. "Catat Sesi Baru" button opens modal (for Coach role)
5. Creating a session works (form submits, success message appears, session shows in list)
6. Adding an action item to a session works (inline form submits, item appears under session)
7. Filtering by date range and status works
  </verify>
  <done>
Coaching.cshtml renders CoachingHistoryViewModel with summary cards, filter bar, session history with action items, create session modal, and add action item inline forms. Coach can create sessions and add action items. Users can view and filter their coaching history. All Indonesian text. Bootstrap 5 styling consistent with v1.0.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add user name resolution to Coaching GET for display</name>
  <files>Controllers/CDPController.cs</files>
  <action>
In the `Coaching()` GET method in CDPController, after fetching the sessions list, build a user name dictionary for display in the view:

```csharp
// Collect all unique user IDs from sessions for name display
var allUserIds = sessions.SelectMany(s => new[] { s.CoachId, s.CoacheeId })
    .Where(id => !string.IsNullOrEmpty(id))
    .Distinct()
    .ToList();

var userNames = await _context.Users
    .Where(u => allUserIds.Contains(u.Id))
    .ToDictionaryAsync(u => u.Id, u => u.FullName ?? u.UserName ?? u.Id);

ViewBag.UserNames = userNames;
```

This avoids N+1 queries — one batch query fetches all names needed for the page. The view uses `ViewBag.UserNames[session.CoachId]` and `ViewBag.UserNames[session.CoacheeId]` to display names.

Also verify that the existing `Index`, `PlanIdp`, `Dashboard`, `Progress` methods are completely unchanged — no regression to v1.0 features. Run the full application and confirm /CDP/Index, /CDP/Dashboard, /CDP/PlanIdp, /CDP/Progress all still load correctly.
  </action>
  <verify>
Run `dotnet build` — must pass. Run `dotnet run` and verify:
1. /CDP/Coaching displays coach and coachee names (not just IDs) in session cards
2. /CDP/Index loads correctly (no regression)
3. /CDP/Dashboard loads correctly (no regression)
4. /CDP/Progress loads correctly (no regression)
  </verify>
  <done>User names display correctly in coaching history. All existing CDP pages continue to function without regression.</done>
</task>

</tasks>

<verification>
1. `dotnet build` passes
2. /CDP/Coaching page loads with CoachingHistoryViewModel
3. Coach can create a session via modal form (COACH-01)
4. Coach can add action items to a session (COACH-02)
5. User can filter history by date range and status (COACH-03)
6. User names display correctly (not just IDs)
7. /CDP/Index, /CDP/Dashboard, /CDP/PlanIdp, /CDP/Progress all load correctly (no v1.0 regression)
8. TempData success/error messages display correctly after form submissions
</verification>

<success_criteria>
- Coach can create a coaching session with date, topic, notes, and coachee selection — session appears in history
- Coach can add action items with description and due date to any session they coach — items appear under the session
- User sees their coaching history filtered by role (coach sees coached sessions, coachee sees sessions about them)
- Date range and status filters work correctly on the history view
- All existing v1.0 CDP pages remain functional
- Indonesian language used for all user-facing text
</success_criteria>

<output>
After completion, create `.planning/phases/04-foundation-coaching-sessions/04-02-SUMMARY.md`
</output>
