---
phase: 04-foundation-coaching-sessions
plan: 03
type: execute
wave: 1
depends_on: ["04-01", "04-02"]
files_modified:
  - Models/CoachingSession.cs
  - Models/CoachingViewModels.cs
  - Controllers/CDPController.cs
  - Views/CDP/Coaching.cshtml
  - Migrations/*_UpdateCoachingSessionFields.cs
autonomous: true
gap_closure: true
must_haves:
  truths:
    - "Create coaching session modal has Kompetensi dropdown (populated from KkjMatrices), SubKompetensi text input, Deliverable text input"
    - "Create coaching session modal has CoacheeCompetencies and CatatanCoach multi-line textarea fields"
    - "Create coaching session modal has Kesimpulan dropdown (Kompeten / Perlu Pengembangan) and Result dropdown (Need Improvement / Suitable / Good / Excellence)"
    - "Topic and Notes/Catatan fields are completely removed from the modal, model, and card display"
    - "Session history cards display Kompetensi, SubKompetensi, Deliverable, Kesimpulan, and Result instead of Topic/Notes"
    - "EF Core migration drops Topic and Notes columns and adds 7 new columns to CoachingSessions table"
  artifacts:
    - path: "Models/CoachingSession.cs"
      provides: "7 domain-specific string properties replacing Topic/Notes"
      contains: "Kompetensi"
    - path: "Models/CoachingViewModels.cs"
      provides: "CreateSessionViewModel with 7 domain fields"
      contains: "CoacheeCompetencies"
    - path: "Controllers/CDPController.cs"
      provides: "CreateSession POST mapping 7 new fields; Coaching GET loading KkjMatrices into ViewBag"
      contains: "ViewBag.KompetensiList"
    - path: "Views/CDP/Coaching.cshtml"
      provides: "Modal with 7 domain fields; card display with new fields"
      contains: "Kesimpulan"
  key_links:
    - from: "Controllers/CDPController.cs"
      to: "KkjMatrices"
      via: "_context.KkjMatrices distinct Kompetensi query"
      pattern: "KkjMatrices.*Select.*Kompetensi"
    - from: "Views/CDP/Coaching.cshtml"
      to: "ViewBag.KompetensiList"
      via: "select dropdown options"
      pattern: "ViewBag.KompetensiList"
    - from: "Controllers/CDPController.cs CreateSession POST"
      to: "CoachingSession entity"
      via: "7-field property mapping"
      pattern: "Kompetensi = model.Kompetensi"
---

<objective>
Replace generic Topic/Notes fields on CoachingSession with domain-specific coaching fields matching the CoachingLog pattern: Kompetensi, SubKompetensi, Deliverable (dropdown/text), CoacheeCompetencies, CatatanCoach (multi-line), Kesimpulan (choice), and Result (choice).

Purpose: User reported the coaching session modal has the wrong fields. The domain requires competency-specific coaching logs, not generic topic/notes entries. This aligns CoachingSession with the existing CoachingLog data model.
Output: Updated model, viewmodel, controller, view, and EF Core migration. Modal shows domain fields; session cards display new field values.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-foundation-coaching-sessions/04-01-SUMMARY.md
@.planning/phases/04-foundation-coaching-sessions/04-02-SUMMARY.md
@.planning/phases/04-foundation-coaching-sessions/04-UAT.md

Key reference files (read before implementing):
@Models/CoachingSession.cs — Current entity: has Topic/Notes to remove, add 7 new props
@Models/CoachingViewModels.cs — Current VM: has Topic/Notes to remove, add 7 new props
@Models/CoachingLog.cs — Reference pattern: shows the 7 domain-specific fields (SubKompetensi, Deliverables, CoacheeCompetencies, CatatanCoach, Kesimpulan, Result)
@Controllers/CDPController.cs — CreateSession POST (line ~295) and Coaching GET (line ~180)
@Views/CDP/Coaching.cshtml — Modal (line ~282) and session cards (line ~170)
@Models/KkjModels.cs — KkjMatrixItem has Kompetensi field (line 11)
@Data/ApplicationDbContext.cs — KkjMatrices DbSet (line 28)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update CoachingSession model, CreateSessionViewModel, and controller mappings</name>
  <files>
    Models/CoachingSession.cs
    Models/CoachingViewModels.cs
    Controllers/CDPController.cs
  </files>
  <action>
**Models/CoachingSession.cs** — Remove `Topic` (string) and `Notes` (string?) properties entirely. Add 7 new string properties, all non-nullable with default "":

```csharp
public string Kompetensi { get; set; } = "";
public string SubKompetensi { get; set; } = "";
public string Deliverable { get; set; } = "";
public string CoacheeCompetencies { get; set; } = "";  // multi-line text
public string CatatanCoach { get; set; } = "";          // multi-line text
public string Kesimpulan { get; set; } = "";             // "Kompeten" or "Perlu Pengembangan"
public string Result { get; set; } = "";                 // "Need Improvement" / "Suitable" / "Good" / "Excellence"
```

Keep all other properties (Id, CoachId, CoacheeId, Date, Status, CreatedAt, UpdatedAt, ActionItems) unchanged.

**Models/CoachingViewModels.cs** — In `CreateSessionViewModel`, remove `Topic` and `Notes` properties. Add the same 7 new string properties with identical types and defaults:

```csharp
public string Kompetensi { get; set; } = "";
public string SubKompetensi { get; set; } = "";
public string Deliverable { get; set; } = "";
public string CoacheeCompetencies { get; set; } = "";
public string CatatanCoach { get; set; } = "";
public string Kesimpulan { get; set; } = "";
public string Result { get; set; } = "";
```

Leave CoacheeId and Date properties as-is. Leave CoachingHistoryViewModel and AddActionItemViewModel unchanged.

**Controllers/CDPController.cs** — Two changes:

1. In `Coaching()` GET action (around line 280-290, before `return View(viewModel)`): Add a query to load distinct Kompetensi values from KkjMatrices for the dropdown:

```csharp
var kompetensiList = await _context.KkjMatrices
    .Select(k => k.Kompetensi)
    .Distinct()
    .OrderBy(k => k)
    .ToListAsync();
ViewBag.KompetensiList = kompetensiList;
```

2. In `CreateSession()` POST action (around line 313-322): Replace `Topic = model.Topic, Notes = model.Notes` with the 7 new field mappings:

```csharp
var session = new CoachingSession
{
    CoachId = user.Id,
    CoacheeId = model.CoacheeId,
    Date = model.Date,
    Kompetensi = model.Kompetensi,
    SubKompetensi = model.SubKompetensi,
    Deliverable = model.Deliverable,
    CoacheeCompetencies = model.CoacheeCompetencies,
    CatatanCoach = model.CatatanCoach,
    Kesimpulan = model.Kesimpulan,
    Result = model.Result,
    Status = "Draft",
    CreatedAt = DateTime.UtcNow
};
```

Also add `ModelState.Remove("Kompetensi");` etc. is NOT needed — these come from the form. But DO keep the existing `ModelState.Remove("CoachId");` line.
  </action>
  <verify>
Run `dotnet build -c Release` from `C:/Users/rinoa/Desktop/PortalHC_KPB`. Must compile with 0 errors. Verify: CoachingSession.cs has no Topic/Notes properties, has 7 new properties. CoachingViewModels.cs same. CDPController.cs CreateSession maps 7 new fields, Coaching GET has ViewBag.KompetensiList assignment.
  </verify>
  <done>CoachingSession entity and CreateSessionViewModel have 7 domain-specific fields (no Topic/Notes). Controller maps all 7 fields on create and loads KompetensiList from KkjMatrices. Build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Update Coaching.cshtml modal and session card display</name>
  <files>
    Views/CDP/Coaching.cshtml
  </files>
  <action>
Read the current `Views/CDP/Coaching.cshtml` before modifying.

**Part A — Update the Create Session Modal** (currently around line 282-333):

Replace the modal body content (the `<div class="modal-body">` inner content). Remove the Topic `<input>` and Notes `<textarea>`. Replace with 7 new form fields in this layout:

Row 1 (existing): Coachee dropdown (col-md-6) + Tanggal Sesi date (col-md-6) — keep as-is.

Row 2: Kompetensi dropdown (col-md-4) + SubKompetensi text input (col-md-4) + Deliverable text input (col-md-4).

For Kompetensi dropdown, populate from ViewBag.KompetensiList:
```html
<div class="col-md-4">
    <label class="form-label fw-semibold">Kompetensi <span class="text-danger">*</span></label>
    <select name="Kompetensi" class="form-select" required>
        <option value="">-- Pilih Kompetensi --</option>
        @foreach (var k in (List<string>)(ViewBag.KompetensiList ?? new List<string>()))
        {
            <option value="@k">@k</option>
        }
    </select>
</div>
```

SubKompetensi and Deliverable are plain text inputs (free text, matching CoachingLog pattern):
```html
<div class="col-md-4">
    <label class="form-label fw-semibold">Sub Kompetensi <span class="text-danger">*</span></label>
    <input type="text" name="SubKompetensi" class="form-control" placeholder="Sub kompetensi" required />
</div>
<div class="col-md-4">
    <label class="form-label fw-semibold">Deliverable <span class="text-danger">*</span></label>
    <input type="text" name="Deliverable" class="form-control" placeholder="Target deliverable" required />
</div>
```

Row 3: CoacheeCompetencies textarea (col-md-6) + CatatanCoach textarea (col-md-6):
```html
<div class="col-md-6">
    <label class="form-label fw-semibold">Coachee Competencies <span class="text-danger">*</span></label>
    <textarea name="CoacheeCompetencies" class="form-control" rows="3" placeholder="Kompetensi yang ditunjukkan coachee..." required></textarea>
</div>
<div class="col-md-6">
    <label class="form-label fw-semibold">Catatan Coach <span class="text-danger">*</span></label>
    <textarea name="CatatanCoach" class="form-control" rows="3" placeholder="Catatan dan observasi coach..." required></textarea>
</div>
```

Row 4: Kesimpulan select (col-md-6) + Result select (col-md-6):
```html
<div class="col-md-6">
    <label class="form-label fw-semibold">Kesimpulan <span class="text-danger">*</span></label>
    <select name="Kesimpulan" class="form-select" required>
        <option value="">-- Pilih Kesimpulan --</option>
        <option value="Kompeten">Kompeten</option>
        <option value="Perlu Pengembangan">Perlu Pengembangan</option>
    </select>
</div>
<div class="col-md-6">
    <label class="form-label fw-semibold">Result <span class="text-danger">*</span></label>
    <select name="Result" class="form-select" required>
        <option value="">-- Pilih Result --</option>
        <option value="Need Improvement">Need Improvement</option>
        <option value="Suitable">Suitable</option>
        <option value="Good">Good</option>
        <option value="Excellence">Excellence</option>
    </select>
</div>
```

Each row is wrapped in `<div class="row mb-3">`.

**Part B — Update session history card display** (currently around line 180-203):

In the card header, replace `<h6 class="fw-bold d-inline mb-0">@session.Topic</h6>` with:
```html
<h6 class="fw-bold d-inline mb-0">@session.Kompetensi</h6>
```

In the card body, replace the Notes paragraph (`@if (!string.IsNullOrEmpty(session.Notes))` block) with a compact field summary:
```html
<div class="row mb-2">
    <div class="col-md-4">
        <small class="text-muted d-block">Sub Kompetensi</small>
        <span class="fw-semibold small">@session.SubKompetensi</span>
    </div>
    <div class="col-md-4">
        <small class="text-muted d-block">Deliverable</small>
        <span class="fw-semibold small">@session.Deliverable</span>
    </div>
    <div class="col-md-2">
        <small class="text-muted d-block">Kesimpulan</small>
        @{
            var kesimpulanClass = session.Kesimpulan == "Kompeten" ? "text-success" : "text-warning";
        }
        <span class="fw-semibold small @kesimpulanClass">@session.Kesimpulan</span>
    </div>
    <div class="col-md-2">
        <small class="text-muted d-block">Result</small>
        @{
            var resultClass = session.Result switch
            {
                "Excellence" => "text-success",
                "Good" => "text-primary",
                "Suitable" => "text-info",
                _ => "text-warning"
            };
        }
        <span class="fw-semibold small @resultClass">@session.Result</span>
    </div>
</div>
@if (!string.IsNullOrEmpty(session.CoacheeCompetencies))
{
    <p class="text-muted small mb-1">
        <i class="bi bi-person-check me-1"></i><strong>Coachee Competencies:</strong> @session.CoacheeCompetencies
    </p>
}
@if (!string.IsNullOrEmpty(session.CatatanCoach))
{
    <p class="text-muted small mb-2">
        <i class="bi bi-chat-left-quote me-1"></i><strong>Catatan Coach:</strong> @session.CatatanCoach
    </p>
}
```

Ensure there are NO remaining references to `session.Topic` or `session.Notes` anywhere in the view. Do a search after editing.
  </action>
  <verify>
Run `dotnet build -c Release`. Must compile with 0 errors. Grep the view file: `grep -c "Topic\|Notes" Views/CDP/Coaching.cshtml` should return 0 (no references to old fields). Verify the modal contains `name="Kompetensi"`, `name="SubKompetensi"`, `name="Deliverable"`, `name="CoacheeCompetencies"`, `name="CatatanCoach"`, `name="Kesimpulan"`, `name="Result"` — 7 form field names.
  </verify>
  <done>Modal shows 7 domain-specific form fields (3 selects/inputs for competency data, 2 textareas for notes, 2 selects for conclusion/result). Session history cards display Kompetensi as title, SubKompetensi/Deliverable/Kesimpulan/Result in summary row, and CoacheeCompetencies/CatatanCoach as detail text. No Topic or Notes references remain.</done>
</task>

<task type="auto">
  <name>Task 3: Create and apply EF Core migration for schema change</name>
  <files>
    Migrations/*_UpdateCoachingSessionFields.cs
    Migrations/ApplicationDbContextModelSnapshot.cs
  </files>
  <action>
Run the EF Core migration commands. Use `--configuration Release` flag since the Debug exe may be locked by a running process (established pattern from 04-01).

1. Create the migration:
```bash
dotnet ef migrations add UpdateCoachingSessionFields --project C:/Users/rinoa/Desktop/PortalHC_KPB --configuration Release
```

This migration should automatically generate:
- DropColumn: `Topic` from `CoachingSessions`
- DropColumn: `Notes` from `CoachingSessions`
- AddColumn: `Kompetensi` (nvarchar(max), NOT NULL, defaultValue: "")
- AddColumn: `SubKompetensi` (nvarchar(max), NOT NULL, defaultValue: "")
- AddColumn: `Deliverable` (nvarchar(max), NOT NULL, defaultValue: "")
- AddColumn: `CoacheeCompetencies` (nvarchar(max), NOT NULL, defaultValue: "")
- AddColumn: `CatatanCoach` (nvarchar(max), NOT NULL, defaultValue: "")
- AddColumn: `Kesimpulan` (nvarchar(max), NOT NULL, defaultValue: "")
- AddColumn: `Result` (nvarchar(max), NOT NULL, defaultValue: "")

2. Verify the generated migration file contains exactly these changes (read it).

3. Apply the migration:
```bash
dotnet ef database update --project C:/Users/rinoa/Desktop/PortalHC_KPB --configuration Release
```

4. Verify application still builds and runs:
```bash
dotnet build -c Release C:/Users/rinoa/Desktop/PortalHC_KPB
```

NOTE: If existing CoachingSessions rows have data in Topic/Notes, that data will be lost. This is acceptable since the system is in development (per UAT testing phase).
  </action>
  <verify>
Migration file exists and contains DropColumn for Topic/Notes and AddColumn for 7 new fields. `dotnet ef database update --configuration Release` completes without errors. `dotnet build -c Release` passes with 0 errors. The ApplicationDbContextModelSnapshot.cs no longer contains Topic/Notes properties for CoachingSession and includes all 7 new properties.
  </verify>
  <done>Database schema updated: CoachingSessions table has 7 new columns (Kompetensi, SubKompetensi, Deliverable, CoacheeCompetencies, CatatanCoach, Kesimpulan, Result) and Topic/Notes columns are dropped. Migration applied successfully.</done>
</task>

</tasks>

<verification>
1. `dotnet build -c Release` passes with 0 errors
2. No references to `Topic` or `Notes` in CoachingSession.cs, CoachingViewModels.cs, or Coaching.cshtml
3. `CreateSession` POST in CDPController maps all 7 new fields
4. `Coaching` GET in CDPController sets `ViewBag.KompetensiList` from KkjMatrices
5. Migration file has DropColumn Topic/Notes and AddColumn for 7 fields
6. Database updated — `dotnet ef database update` applied successfully
</verification>

<success_criteria>
- CoachingSession modal displays: Coachee + Date (row 1), Kompetensi dropdown + SubKompetensi + Deliverable (row 2), CoacheeCompetencies + CatatanCoach textareas (row 3), Kesimpulan + Result dropdowns (row 4)
- Topic and Notes fields completely removed from model, viewmodel, controller, view, and database
- Session history cards show Kompetensi as heading, SubKompetensi/Deliverable/Kesimpulan/Result in summary, CoacheeCompetencies/CatatanCoach as detail text
- Kompetensi dropdown populated from KkjMatrices master data
- Build compiles, migration applied, database schema matches new model
</success_criteria>

<output>
After completion, create `.planning/phases/04-foundation-coaching-sessions/04-03-SUMMARY.md`
</output>
