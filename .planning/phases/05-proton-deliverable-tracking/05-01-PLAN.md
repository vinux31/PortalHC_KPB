---
phase: 05-proton-deliverable-tracking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Models/ProtonModels.cs
  - Models/ProtonViewModels.cs
  - Data/ApplicationDbContext.cs
  - Data/SeedProtonData.cs
  - Program.cs
autonomous: true

must_haves:
  truths:
    - "Five new Proton tables exist in the database with correct schema and relationships"
    - "Seed data populates at least one complete track (Operator Tahun 1) with Kompetensi > SubKompetensi > Deliverable hierarchy"
    - "Application starts without errors after migration and seeding"
  artifacts:
    - path: "Models/ProtonModels.cs"
      provides: "ProtonKompetensi, ProtonSubKompetensi, ProtonDeliverable, ProtonTrackAssignment, ProtonDeliverableProgress entities"
      contains: "class ProtonKompetensi"
    - path: "Models/ProtonViewModels.cs"
      provides: "ProtonMainViewModel, ProtonPlanViewModel, DeliverableViewModel"
      contains: "class ProtonMainViewModel"
    - path: "Data/ApplicationDbContext.cs"
      provides: "5 new DbSets and OnModelCreating relationship config with DeleteBehavior.Restrict"
      contains: "DbSet<ProtonKompetensi>"
    - path: "Data/SeedProtonData.cs"
      provides: "Idempotent seed method for Operator Tahun 1 deliverable hierarchy plus placeholders"
      contains: "class SeedProtonData"
    - path: "Program.cs"
      provides: "SeedProtonData.SeedAsync call in startup pipeline"
      contains: "SeedProtonData.SeedAsync"
  key_links:
    - from: "Data/ApplicationDbContext.cs"
      to: "Models/ProtonModels.cs"
      via: "DbSet declarations and OnModelCreating FK config"
      pattern: "DbSet<ProtonKompetensi> ProtonKompetensiList"
    - from: "Data/SeedProtonData.cs"
      to: "Data/ApplicationDbContext.cs"
      via: "Uses ApplicationDbContext to insert seed data"
      pattern: "context\\.ProtonKompetensiList"
    - from: "Program.cs"
      to: "Data/SeedProtonData.cs"
      via: "Calls SeedAsync at startup"
      pattern: "SeedProtonData\\.SeedAsync"
---

<objective>
Create the Proton deliverable data foundation: 5 entity models, DbContext configuration, EF Core migration, seed data, and ViewModels.

Purpose: All Phase 5 features (PROTN-01 through PROTN-05) depend on the Proton master hierarchy tables and per-user tracking tables. This plan creates the entire data layer in one migration so subsequent plans can build controller actions and views on top.

Output: ProtonModels.cs, ProtonViewModels.cs, updated ApplicationDbContext.cs, SeedProtonData.cs, updated Program.cs, one new EF Core migration. Application builds and starts with seeded data.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-proton-deliverable-tracking/05-RESEARCH.md
@Data/ApplicationDbContext.cs
@Program.cs
@Models/CoachingSession.cs
@Models/CoachCoacheeMapping.cs
@Data/SeedMasterData.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Proton entity models and ViewModels</name>
  <files>Models/ProtonModels.cs, Models/ProtonViewModels.cs</files>
  <action>
Create `Models/ProtonModels.cs` with 5 entity classes in `namespace HcPortal.Models;`:

1. **ProtonKompetensi** — Master table (top level of hierarchy):
   - `int Id`, `string NamaKompetensi = ""`, `string TrackType = ""` (values: "Panelman" or "Operator"), `string TahunKe = ""` (values: "Tahun 1", "Tahun 2", "Tahun 3"), `int Urutan` (display order)
   - Navigation: `ICollection<ProtonSubKompetensi> SubKompetensiList = new List<ProtonSubKompetensi>()`

2. **ProtonSubKompetensi** — Master table (mid level):
   - `int Id`, `int ProtonKompetensiId` (FK), `ProtonKompetensi? ProtonKompetensi` (nav), `string NamaSubKompetensi = ""`, `int Urutan`
   - Navigation: `ICollection<ProtonDeliverable> Deliverables = new List<ProtonDeliverable>()`

3. **ProtonDeliverable** — Master table (leaf level):
   - `int Id`, `int ProtonSubKompetensiId` (FK), `ProtonSubKompetensi? ProtonSubKompetensi` (nav), `string NamaDeliverable = ""`, `int Urutan`

4. **ProtonTrackAssignment** — Per-user assignment:
   - `int Id`, `string CoacheeId = ""` (NO FK constraint — matches CoachingLog/CoachCoacheeMapping pattern), `string AssignedById = ""` (NO FK), `string TrackType = ""`, `string TahunKe = ""`, `bool IsActive = true`, `DateTime AssignedAt = DateTime.UtcNow`

5. **ProtonDeliverableProgress** — Per-user per-deliverable tracking:
   - `int Id`, `string CoacheeId = ""` (NO FK), `int ProtonDeliverableId` (FK), `ProtonDeliverable? ProtonDeliverable` (nav)
   - `string Status = "Locked"` (values: "Locked", "Active", "Submitted", "Approved", "Rejected")
   - `string? EvidencePath` (relative web path like "/uploads/evidence/{id}/{filename}"), `string? EvidenceFileName` (original display name)
   - `DateTime? SubmittedAt`, `DateTime? ApprovedAt`, `DateTime? RejectedAt`, `DateTime CreatedAt = DateTime.UtcNow`

Create `Models/ProtonViewModels.cs` with 3 ViewModel classes in `namespace HcPortal.Models;`:

1. **ProtonMainViewModel** — For ProtonMain page (PROTN-01):
   - `List<ApplicationUser> Coachees = new()` — coachees in section
   - `List<ProtonTrackAssignment> Assignments = new()` — existing active assignments

2. **ProtonPlanViewModel** — For PlanIdp Coachee view (PROTN-02):
   - `string TrackType = ""`, `string TahunKe = ""`
   - `List<ProtonKompetensi> KompetensiList = new()` — full hierarchy

3. **DeliverableViewModel** — For Deliverable detail page (PROTN-04/05):
   - `ProtonDeliverableProgress Progress { get; set; }` (nullable)
   - `ProtonDeliverable Deliverable { get; set; }` (nullable)
   - `string CoacheeName = ""`, `string TrackType = ""`, `string TahunKe = ""`
   - `bool IsAccessible` — computed from sequential lock logic
   - `bool CanUpload` — true if Status is "Active" or "Rejected"

Use `namespace HcPortal.Models;` (file-scoped). Follow existing property conventions (PascalCase, nullable reference types with `?`).
  </action>
  <verify>
`dotnet build -c Release` succeeds with 0 errors. Grep confirms all 5 entity class names exist in ProtonModels.cs. Grep confirms all 3 ViewModel class names exist in ProtonViewModels.cs.
  </verify>
  <done>All 5 Proton entity classes and 3 ViewModels exist with correct properties, navigation properties, and defaults.</done>
</task>

<task type="auto">
  <name>Task 2: Register entities in DbContext, create migration, seed data</name>
  <files>Data/ApplicationDbContext.cs, Data/SeedProtonData.cs, Program.cs</files>
  <action>
**ApplicationDbContext.cs** — Add 5 new DbSet properties (place after existing CoachCoacheeMapping DbSet):
```
public DbSet<ProtonKompetensi> ProtonKompetensiList { get; set; }
public DbSet<ProtonSubKompetensi> ProtonSubKompetensiList { get; set; }
public DbSet<ProtonDeliverable> ProtonDeliverableList { get; set; }
public DbSet<ProtonTrackAssignment> ProtonTrackAssignments { get; set; }
public DbSet<ProtonDeliverableProgress> ProtonDeliverableProgresses { get; set; }
```

In `OnModelCreating`, add relationship and index configuration:
- ProtonSubKompetensi: HasOne(ProtonKompetensi).WithMany(SubKompetensiList).HasForeignKey(ProtonKompetensiId).OnDelete(DeleteBehavior.Restrict). Index on ProtonKompetensiId.
- ProtonDeliverable: HasOne(ProtonSubKompetensi).WithMany(Deliverables).HasForeignKey(ProtonSubKompetensiId).OnDelete(DeleteBehavior.Restrict). Index on ProtonSubKompetensiId.
- ProtonDeliverableProgress: HasOne(ProtonDeliverable).WithMany().HasForeignKey(ProtonDeliverableId).OnDelete(DeleteBehavior.Restrict). Index on CoacheeId. Unique index on (CoacheeId, ProtonDeliverableId). Index on Status.
- ProtonTrackAssignment: Index on CoacheeId. Index on (CoacheeId, IsActive).

All FK relationships use `DeleteBehavior.Restrict` per project decision (SQL Server multiple cascade path limitation).

**SeedProtonData.cs** — Create `Data/SeedProtonData.cs` following the SeedMasterData pattern:
- `public static class SeedProtonData` with `public static async Task SeedAsync(ApplicationDbContext context)`
- Idempotent: `if (await context.ProtonKompetensiList.AnyAsync()) return;`
- Seed **Operator Tahun 1** with real data (3 Kompetensi, each with 2-3 SubKompetensi, each with 2-3 Deliverables):
  - K1: "Safe Work Practice & Lifesaving Rules" (Urutan 1)
    - SK1.1: "Safe Work Practice" — D1: "Mampu memahami 5 Tingkatan Budaya HSSE", D2: "Mampu memahami Pengertian Bahaya", D3: "Mampu memahami 9 Perilaku Wajib"
    - SK1.2: "Lifesaving Rules" — D1: "Mampu memahami Lifesaving Rules Pertamina", D2: "Mampu menerapkan Lifesaving Rules di area kerja"
  - K2: "Dasar Operasi Kilang" (Urutan 2)
    - SK2.1: "Pengenalan Proses" — D1: "Mampu menjelaskan proses distilasi", D2: "Mampu mengidentifikasi peralatan utama kilang"
    - SK2.2: "Parameter Operasi" — D1: "Mampu membaca parameter operasi", D2: "Mampu melaporkan anomali parameter"
  - K3: "Keselamatan Proses" (Urutan 3)
    - SK3.1: "Hazard Identification" — D1: "Mampu melakukan identifikasi bahaya", D2: "Mampu menggunakan JSA/HIRADC"
- Seed **Panelman Tahun 1** with placeholder data (1 Kompetensi, 1 SubKompetensi, 3 Deliverables) with comment `// TODO: Replace with actual Panelman data`
- Seed **Operator Tahun 2** and **Operator Tahun 3** with placeholder data (1 Kompetensi, 1 SubKompetensi, 2 Deliverables each) with comment `// TODO: Replace with actual Tahun 2/3 data`
- Console.WriteLine on skip and on success (matching SeedMasterData logging pattern)

**Program.cs** — Add `await SeedProtonData.SeedAsync(context);` after the existing `SeedCompetencyMappings.SeedAsync(context)` call.

**Migration** — Run: `dotnet ef migrations add AddProtonDeliverableTracking --configuration Release` then `dotnet ef database update --configuration Release`. Use `--configuration Release` flag (per Phase 4 pattern when dev server may be running).
  </action>
  <verify>
1. `dotnet build -c Release` succeeds with 0 errors
2. `dotnet ef database update --configuration Release` reports "already up to date" (migration already applied)
3. Run the application briefly and confirm console shows seed message (either "already seeded" or success message)
4. Verify migration file exists in Migrations/ directory containing all 5 CreateTable operations
  </verify>
  <done>5 new tables exist in the database. Seed data populates Operator Tahun 1 (3 Kompetensi, 6 SubKompetensi, 14 Deliverables) plus placeholder data for Panelman and other years. Application starts cleanly.</done>
</task>

</tasks>

<verification>
1. `dotnet build -c Release` — 0 errors, 0 warnings
2. Migration file contains CreateTable for all 5 Proton tables with correct column types
3. All FK relationships use DeleteBehavior.Restrict (grep migration file for "onDelete: ReferentialAction.Restrict")
4. Seed data inserts at least 14 deliverables for Operator Tahun 1
5. ProtonViewModels.cs contains ProtonMainViewModel, ProtonPlanViewModel, DeliverableViewModel
</verification>

<success_criteria>
- Application builds, migrates, and starts without errors
- Database contains 5 new Proton tables with correct schema
- Seed data is populated (ProtonKompetensiList has entries)
- ViewModels are ready for controller/view work in Plans 02 and 03
</success_criteria>

<output>
After completion, create `.planning/phases/05-proton-deliverable-tracking/05-01-SUMMARY.md`
</output>
