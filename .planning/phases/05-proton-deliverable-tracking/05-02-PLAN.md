---
phase: 05-proton-deliverable-tracking
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - Controllers/CDPController.cs
  - Views/CDP/ProtonMain.cshtml
  - Views/CDP/PlanIdp.cshtml
  - Views/CDP/Index.cshtml
autonomous: true

must_haves:
  truths:
    - "Coach or SrSpv can assign a coachee to a Proton track (Panelman or Operator, Tahun 1/2/3) from the Proton Main page"
    - "Coachee can view their full deliverable list on the IDP Plan page organized by Kompetensi > Sub Kompetensi > Deliverable (read-only, no status, no navigation links)"
    - "ProtonDeliverableProgress records are created eagerly when a track is assigned (first = Active, rest = Locked)"
    - "Coachee can navigate from PlanIdp to their active Deliverable page via a prominent button above the table"
    - "Coach can navigate from ProtonMain to any coachee's active Deliverable page via a link in the coachee row"
  artifacts:
    - path: "Controllers/CDPController.cs"
      provides: "ProtonMain GET, AssignTrack POST, updated PlanIdp GET with Coachee role path including ActiveProgress query"
      contains: "ProtonMain"
    - path: "Views/CDP/ProtonMain.cshtml"
      provides: "Track assignment page with coachee list table, assign modal, and Lihat Deliverable link per coachee"
      contains: "ProtonMainViewModel"
    - path: "Views/CDP/PlanIdp.cshtml"
      provides: "Hybrid view: DB-driven table for Coachee role with active deliverable navigation button, existing PDF path for other roles"
      contains: "ProtonPlanViewModel"
    - path: "Views/CDP/Index.cshtml"
      provides: "Navigation card linking to ProtonMain page"
      contains: "ProtonMain"
  key_links:
    - from: "Views/CDP/ProtonMain.cshtml"
      to: "Controllers/CDPController.cs"
      via: "form asp-action=AssignTrack POST"
      pattern: "asp-action=\"AssignTrack\""
    - from: "Views/CDP/ProtonMain.cshtml"
      to: "/CDP/Deliverable/{progressId}"
      via: "Lihat Deliverable link per coachee row using ActiveProgresses lookup"
      pattern: "Deliverable.*ActiveProgress"
    - from: "Views/CDP/PlanIdp.cshtml"
      to: "/CDP/Deliverable/{progressId}"
      via: "Lanjut ke Deliverable Aktif button using protonModel.ActiveProgress.Id"
      pattern: "Deliverable.*ActiveProgress\\.Id"
    - from: "Controllers/CDPController.cs"
      to: "Data/ApplicationDbContext.cs"
      via: "ProtonTrackAssignments and ProtonDeliverableProgresses queries"
      pattern: "_context\\.ProtonTrackAssignments"
    - from: "Views/CDP/PlanIdp.cshtml"
      to: "Models/ProtonViewModels.cs"
      via: "Model as ProtonPlanViewModel for Coachee role path"
      pattern: "ProtonPlanViewModel"
---

<objective>
Build the Proton Main page (PROTN-01) for track assignment and update the PlanIdp page (PROTN-02) to show a DB-driven deliverable hierarchy for Coachee role users. Both pages include navigation entry points to the Deliverable detail page (Plan 03).

Purpose: PROTN-01 is the entry point where coaches assign coachees to a Proton track. PROTN-02 shows coachees their assigned deliverable list. Both pages provide navigation links to the Deliverable page (Plan 03) which handles sequential lock, upload, and resubmit. Without these navigation links, the Deliverable page would be unreachable from the UI.

Output: ProtonMain.cshtml (new), updated PlanIdp.cshtml (hybrid), updated CDPController.cs (4 new/modified actions), updated Index.cshtml (nav link).
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-proton-deliverable-tracking/05-RESEARCH.md
@.planning/phases/05-proton-deliverable-tracking/05-01-SUMMARY.md
@Controllers/CDPController.cs
@Views/CDP/PlanIdp.cshtml
@Views/CDP/Index.cshtml
@Models/ProtonModels.cs
@Models/ProtonViewModels.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ProtonMain and AssignTrack controller actions with ProtonMain view</name>
  <files>Controllers/CDPController.cs, Views/CDP/ProtonMain.cshtml, Views/CDP/Index.cshtml</files>
  <action>
**CDPController.cs** — Add `IWebHostEnvironment` injection to the constructor (needed for Plan 03 file upload, but add now to avoid modifying constructor twice):
- Add `private readonly IWebHostEnvironment _env;` field
- Add `IWebHostEnvironment env` parameter to the existing constructor
- Assign `_env = env;`

Add two new actions:

**ProtonMain() GET** — Role check: only users with RoleLevel <= 5 OR role == SrSupervisor can access (same pattern as Coaching page). If unauthorized, return Forbid().
1. Get current user via `_userManager.GetUserAsync(User)`. If null, return Challenge().
2. Query coachees: `_context.Users.Where(u => u.Section == user.Section && u.RoleLevel == 6).OrderBy(u => u.FullName).ToListAsync()`
3. Query active assignments for those coachees: `_context.ProtonTrackAssignments.Where(a => coacheeIds.Contains(a.CoacheeId) && a.IsActive).ToListAsync()`
4. Query active progress records for those coachees: `_context.ProtonDeliverableProgresses.Where(p => coacheeIds.Contains(p.CoacheeId) && p.Status == "Active").ToListAsync()` — this provides one active progress per coachee (if they have an assignment), used to render "Lihat Deliverable" links
5. Build `ProtonMainViewModel { Coachees = coachees, Assignments = assignments, ActiveProgresses = activeProgresses }`
6. Return `View(viewModel)`

**AssignTrack(string coacheeId, string trackType, string tahunKe) POST** — `[HttpPost][ValidateAntiForgeryToken]`:
1. Same role check as ProtonMain (Forbid if unauthorized)
2. Validate inputs: if coacheeId/trackType/tahunKe are empty, TempData["Error"] = "Data tidak lengkap." and redirect to ProtonMain
3. Deactivate any existing active assignment: query `ProtonTrackAssignments.Where(a => a.CoacheeId == coacheeId && a.IsActive)`, set `IsActive = false` for each
4. Delete any existing ProtonDeliverableProgress for this coachee (from previous track): `_context.ProtonDeliverableProgresses.Where(p => p.CoacheeId == coacheeId)` — RemoveRange
5. Create new ProtonTrackAssignment with CoacheeId, AssignedById = user.Id, TrackType, TahunKe, IsActive = true, AssignedAt = DateTime.UtcNow
6. Save assignment first (so Id is generated)
7. Query all deliverables for the track: `_context.ProtonDeliverableList.Include(d => d.ProtonSubKompetensi).ThenInclude(s => s.ProtonKompetensi).Where(d => d.ProtonSubKompetensi.ProtonKompetensi.TrackType == trackType && d.ProtonSubKompetensi.ProtonKompetensi.TahunKe == tahunKe).OrderBy(d => d.ProtonSubKompetensi.ProtonKompetensi.Urutan).ThenBy(d => d.ProtonSubKompetensi.Urutan).ThenBy(d => d.Urutan).ToListAsync()`
8. Create ProtonDeliverableProgress for each deliverable: first one Status = "Active", rest = "Locked". Set CoacheeId, ProtonDeliverableId, CreatedAt = DateTime.UtcNow. Use `_context.ProtonDeliverableProgresses.AddRange(progressList)`.
9. SaveChangesAsync()
10. TempData["Success"] = "Track Proton berhasil ditetapkan."
11. RedirectToAction("ProtonMain")

**Views/CDP/ProtonMain.cshtml** — New file. Follow existing Coaching.cshtml layout pattern:
- `@model HcPortal.Models.ProtonMainViewModel`
- Page title: "Proton Main — Track Assignment"
- Bootstrap card container with a table showing coachees:
  - Columns: No, Nama, NIP, Current Track (from Assignments lookup), Action
  - For "Current Track" column: find matching assignment by CoacheeId, display "{TrackType} - {TahunKe}" or "-" if none
  - Action column: "Assign Track" button opens Bootstrap modal. ADDITIONALLY, if the coachee has an active progress record (look up Model.ActiveProgresses by CoacheeId), show a small "Lihat Deliverable" link button: `<a href="/CDP/Deliverable/@activeProgress.Id" class="btn btn-sm btn-outline-info ms-1">Lihat Deliverable</a>`. If no active progress for this coachee, do not show the link.
- Bootstrap modal (id="assignTrackModal") with:
  - Hidden input for coacheeId (set via JavaScript when button clicked)
  - Display coachee name in modal header (set via JS data attribute)
  - Dropdown for TrackType: options "Panelman", "Operator"
  - Dropdown for TahunKe: options "Tahun 1", "Tahun 2", "Tahun 3"
  - Submit button POSTs to AssignTrack
  - Form: `<form method="post" asp-action="AssignTrack">`
- Small JavaScript at bottom: when "Assign Track" button clicked, read data-coacheeid and data-coacheename from button, set hidden input value and modal title text
- TempData["Success"] and TempData["Error"] alert display at top (same pattern as Coaching.cshtml)

**Views/CDP/Index.cshtml** — Add a new navigation card for "Proton Main" linking to `/CDP/ProtonMain`. Place it after the existing coaching card. Use same card styling as existing cards (Bootstrap card with icon, title, description). Icon: `bi bi-clipboard-check`. Description: "Kelola track Proton dan deliverable coachee".
  </action>
  <verify>
1. `dotnet build -c Release` succeeds with 0 errors
2. Grep CDPController.cs for "ProtonMain" and "AssignTrack" — both action names found
3. Grep CDPController.cs for "ActiveProgresses" — found in ProtonMain action
4. Views/CDP/ProtonMain.cshtml exists and contains "assignTrackModal"
5. Grep ProtonMain.cshtml for "Lihat Deliverable" — found (navigation link to Deliverable page)
6. Grep ProtonMain.cshtml for "/CDP/Deliverable/" — found (href pattern)
7. Views/CDP/Index.cshtml contains link to ProtonMain
  </verify>
  <done>ProtonMain page renders with coachee list and track assignment modal. Each coachee row with an active deliverable shows a "Lihat Deliverable" link to /CDP/Deliverable/{progressId}. AssignTrack POST creates assignment and bulk-inserts progress records. CDP Index has navigation card to ProtonMain.</done>
</task>

<task type="auto">
  <name>Task 2: Update PlanIdp for hybrid Coachee view with DB-driven deliverable table and active deliverable navigation</name>
  <files>Controllers/CDPController.cs, Views/CDP/PlanIdp.cshtml</files>
  <action>
**CDPController.cs** — Modify the existing `PlanIdp()` GET action to add a Coachee role path BEFORE the existing PDF logic. The existing PDF logic must remain completely untouched for non-Coachee roles.

At the top of PlanIdp(), after getting the user and role:
1. Check if user is Coachee role: `(userRole == UserRoles.Coachee || (userRole == UserRoles.Admin && user.SelectedView == "Coachee"))`
2. If Coachee:
   a. Query active assignment: `_context.ProtonTrackAssignments.Where(a => a.CoacheeId == user.Id && a.IsActive).FirstOrDefaultAsync()`
   b. If no assignment: set `ViewBag.UserRole = userRole; ViewBag.NoAssignment = true;` and return `View()` (falls through to existing view which should handle this)
   c. If assignment exists: query full hierarchy `_context.ProtonKompetensiList.Include(k => k.SubKompetensiList).ThenInclude(s => s.Deliverables).Where(k => k.TrackType == assignment.TrackType && k.TahunKe == assignment.TahunKe).OrderBy(k => k.Urutan).ToListAsync()`
   d. Query active progress: `_context.ProtonDeliverableProgresses.Where(p => p.CoacheeId == user.Id && p.Status == "Active").FirstOrDefaultAsync()` — this is the coachee's current active deliverable progress record
   e. Build `ProtonPlanViewModel { TrackType = assignment.TrackType, TahunKe = assignment.TahunKe, KompetensiList = kompetensiList, ActiveProgress = activeProgress }`
   f. Set `ViewBag.UserRole = userRole; ViewBag.IsProtonView = true;`
   g. Return `View(viewModel)` — PlanIdp.cshtml will detect the ViewModel type or the ViewBag flag
3. The entire existing PlanIdp logic (PDF path, filters, etc.) remains AFTER this if-block, completely unchanged.

**Views/CDP/PlanIdp.cshtml** — Modify to support hybrid rendering. The view must handle two cases:

**CRITICAL: @model directive change.** Change the `@model` directive at the top of `PlanIdp.cshtml` to `@model object?` (or remove the `@model` directive entirely — Razor supports this and Model becomes `dynamic`). The existing PDF content block does not use the model. The Proton content block casts using `Model as HcPortal.Models.ProtonPlanViewModel`.

**Case 1: Coachee with Proton assignment** (ViewBag.IsProtonView == true):
- At the TOP of the file, after the @model directive, add a conditional block:
```razor
@if (ViewBag.IsProtonView == true)
{
    @{ var protonModel = Model as HcPortal.Models.ProtonPlanViewModel; }
    // Render active deliverable navigation + DB-driven deliverable table
}
else if (ViewBag.NoAssignment == true)
{
    // Show "Belum ada track Proton yang ditetapkan" message
}
else
{
    // EXISTING PDF CONTENT — completely unchanged
}
```

For the Proton view (Case 1), render:
- **Active deliverable navigation button (ABOVE the table):** If `protonModel.ActiveProgress != null`, show a Bootstrap alert-info with: `<a href="/CDP/Deliverable/@protonModel.ActiveProgress.Id" class="btn btn-primary">Lanjut ke Deliverable Aktif</a>`. Include text: "Anda memiliki deliverable aktif yang perlu dikerjakan." If `protonModel.ActiveProgress == null` (all deliverables approved or no active one), show a Bootstrap alert-success: "Semua deliverable telah selesai diproses." (completion message)
- Header: "IDP Plan — {protonModel.TrackType} {protonModel.TahunKe}"
- Read-only table with 3-level grouping using Bootstrap:
  - Level 1 (Kompetensi): Bold header row spanning all columns, with Urutan number
  - Level 2 (SubKompetensi): Indented sub-header row, slightly lighter background
  - Level 3 (Deliverable): Normal table row with just the deliverable name and Urutan number
  - Columns: No, Nama Deliverable (that's it — PROTN-02 says "read-only, no status, no navigation links")
- Table uses sequential numbering across all deliverables (1, 2, 3... not resetting per SubKompetensi)
- No links on deliverable names, no buttons on table rows, no status badges — purely read-only per PROTN-02 requirement. The ONLY navigation is the active deliverable button ABOVE the table.
- Style: Bootstrap table-bordered, table-hover, clean layout

For the "No assignment" case (between Cases 1 and existing):
- Bootstrap alert-info: "Belum ada track Proton yang ditetapkan. Hubungi coach Anda untuk penetapan track."
  </action>
  <verify>
1. `dotnet build -c Release` succeeds with 0 errors
2. Grep PlanIdp.cshtml for "ProtonPlanViewModel" — found
3. Grep PlanIdp.cshtml for "IsProtonView" — found
4. Grep PlanIdp.cshtml for "@model object" — found (confirms @model directive change)
5. Grep PlanIdp.cshtml for "Lanjut ke Deliverable Aktif" — found (active deliverable navigation button)
6. Grep PlanIdp.cshtml for "/CDP/Deliverable/" — found (href to deliverable page)
7. Grep CDPController.cs for "ActiveProgress" in PlanIdp context — found (query for active progress)
8. Existing PDF-related code in PlanIdp.cshtml is unchanged (grep for existing distinctive strings like PDF-related function names)
  </verify>
  <done>PlanIdp page shows DB-driven read-only deliverable table for Coachee role (grouped by Kompetensi > SubKompetensi > Deliverable, no status, no links on table rows). Above the table, a prominent "Lanjut ke Deliverable Aktif" button links to /CDP/Deliverable/{progressId} when an active progress exists, or shows a completion message when all are done. @model directive is set to `object?` to support hybrid rendering. Existing PDF path for HC/SrSpv/SectionHead is completely preserved.</done>
</task>

</tasks>

<verification>
1. `dotnet build -c Release` — 0 errors
2. ProtonMain page accessible at /CDP/ProtonMain — shows coachee list with assign buttons
3. ProtonMain shows "Lihat Deliverable" link per coachee who has an active progress record
4. AssignTrack POST creates ProtonTrackAssignment and bulk ProtonDeliverableProgress records
5. PlanIdp page for Coachee role shows "Lanjut ke Deliverable Aktif" button above the table (when active progress exists)
6. PlanIdp page for Coachee role shows deliverable hierarchy table (read-only, no links on rows)
7. PlanIdp page for non-Coachee roles shows existing PDF content (no regression)
8. CDP Index page has "Proton Main" navigation card
9. @model directive in PlanIdp.cshtml is `object?` (not tied to a specific ViewModel)
</verification>

<success_criteria>
- PROTN-01: Coach/SrSpv can assign a Proton track from ProtonMain page
- PROTN-02: Coachee sees read-only deliverable list on PlanIdp page
- Navigation: Coachee can reach Deliverable page from PlanIdp via "Lanjut ke Deliverable Aktif" button
- Navigation: Coach can reach any coachee's active Deliverable from ProtonMain via "Lihat Deliverable" link
- Existing PlanIdp functionality is preserved for HC/SrSpv/SectionHead roles
- Progress records are created eagerly on track assignment
</success_criteria>

<output>
After completion, create `.planning/phases/05-proton-deliverable-tracking/05-02-SUMMARY.md`
</output>
