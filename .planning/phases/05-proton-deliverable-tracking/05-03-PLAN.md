---
phase: 05-proton-deliverable-tracking
plan: 03
type: execute
wave: 3
depends_on: ["05-01", "05-02"]
files_modified:
  - Controllers/CDPController.cs
  - Views/CDP/Deliverable.cshtml
autonomous: true

must_haves:
  truths:
    - "Coachee can only access the next deliverable after the current one is approved — sequential lock is enforced server-side"
    - "Coach can upload evidence files (PDF, JPG, PNG, max 10MB) for an active deliverable on the Deliverable page"
    - "Coach can revise evidence and resubmit a rejected deliverable (new file replaces the EvidencePath, old file kept on disk)"
  artifacts:
    - path: "Controllers/CDPController.cs"
      provides: "Deliverable GET with sequential lock enforcement, UploadEvidence POST with file handling"
      contains: "UploadEvidence"
    - path: "Views/CDP/Deliverable.cshtml"
      provides: "Deliverable detail page with evidence display and upload form"
      contains: "DeliverableViewModel"
  key_links:
    - from: "Controllers/CDPController.cs (Deliverable GET)"
      to: "Sequential lock check"
      via: "Queries all progress records, checks if previous deliverable is Approved"
      pattern: "IsDeliverableAccessible|previousProgress.*Approved"
    - from: "Views/CDP/Deliverable.cshtml"
      to: "Controllers/CDPController.cs (UploadEvidence POST)"
      via: "multipart/form-data form with IFormFile"
      pattern: "enctype=\"multipart/form-data\""
    - from: "Controllers/CDPController.cs (UploadEvidence POST)"
      to: "wwwroot/uploads/evidence/"
      via: "IWebHostEnvironment.WebRootPath + Directory.CreateDirectory + FileStream"
      pattern: "_env\\.WebRootPath.*uploads.*evidence"
---

<objective>
Build the Deliverable detail page with server-side sequential lock enforcement (PROTN-03), evidence file upload (PROTN-04), and evidence revision/resubmit for rejected deliverables (PROTN-05).

Purpose: This is the core workflow page where coaches upload evidence for each deliverable. The sequential lock ensures coachees progress through deliverables in order. File upload is the first IFormFile usage in the codebase, establishing the pattern for future upload features.

Output: Updated CDPController.cs (Deliverable GET + UploadEvidence POST), new Deliverable.cshtml view. Coach can upload/revise evidence; sequential access is enforced server-side.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-proton-deliverable-tracking/05-RESEARCH.md
@.planning/phases/05-proton-deliverable-tracking/05-01-SUMMARY.md
@.planning/phases/05-proton-deliverable-tracking/05-02-SUMMARY.md
@Controllers/CDPController.cs
@Models/ProtonModels.cs
@Models/ProtonViewModels.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Deliverable GET action with sequential lock enforcement</name>
  <files>Controllers/CDPController.cs</files>
  <action>
Add `Deliverable(int id)` GET action to CDPController. The `id` parameter is the ProtonDeliverableProgress.Id (not the ProtonDeliverable.Id).

**Sequential lock logic (PROTN-03) — enforced server-side, never UI-only:**

1. Get current user. If null, return Challenge().
2. Query the progress record: `_context.ProtonDeliverableProgresses.Include(p => p.ProtonDeliverable).ThenInclude(d => d.ProtonSubKompetensi).ThenInclude(s => s.ProtonKompetensi).FirstOrDefaultAsync(p => p.Id == id)`
3. If not found, return NotFound().
4. **Access check:** The user must be either:
   - The coachee themselves (progress.CoacheeId == user.Id), OR
   - A coach/SrSpv/SectionHead/HC/Admin (RoleLevel <= 5) in the same section as the coachee
   - If neither, return Forbid().
5. **Sequential lock check:**
   a. Load ALL progress records for this coachee: `_context.ProtonDeliverableProgresses.Include(p => p.ProtonDeliverable).ThenInclude(d => d.ProtonSubKompetensi).ThenInclude(s => s.ProtonKompetensi).Where(p => p.CoacheeId == progress.CoacheeId).ToListAsync()`
   b. Load ALL deliverables for the track (using the Kompetensi TrackType and TahunKe from the current deliverable's parent hierarchy): order by Kompetensi.Urutan, SubKompetensi.Urutan, Deliverable.Urutan
   c. Find the index of the current deliverable in the ordered list
   d. If index == 0: always accessible (first deliverable)
   e. If index > 0: find the previous deliverable in the ordered list, look up its progress record, check if Status == "Approved"
   f. If NOT accessible: return a view with IsAccessible = false (show "Deliverable ini belum dapat diakses" message), do NOT return Forbid() (the user is authorized but the deliverable is locked)
6. Build `DeliverableViewModel`:
   - Progress = the progress record
   - Deliverable = progress.ProtonDeliverable
   - CoacheeName = look up the coachee's FullName from `_context.Users.Where(u => u.Id == progress.CoacheeId).Select(u => u.FullName).FirstOrDefaultAsync()`
   - TrackType = from the Kompetensi hierarchy
   - TahunKe = from the Kompetensi hierarchy
   - IsAccessible = true (passed the check)
   - CanUpload = (progress.Status == "Active" || progress.Status == "Rejected") AND current user is coach/authorized (RoleLevel <= 5 or is the coachee's coach)
7. Return View(viewModel).

**Important:** Load all progress records in ONE query (step 5a), then do the comparison in-memory. Do NOT query per-deliverable (N+1 pitfall from research).
  </action>
  <verify>
1. `dotnet build -c Release` succeeds with 0 errors
2. Grep CDPController.cs for "Deliverable" action method — found
3. Grep CDPController.cs for "IsAccessible" or sequential lock pattern (checking previous deliverable status) — found
4. No N+1 pattern: grep confirms progress records are loaded with a single `.Where(p => p.CoacheeId ==` query
  </verify>
  <done>Deliverable GET action loads progress with full hierarchy, enforces sequential lock server-side (returns locked view if previous not Approved), and builds DeliverableViewModel with accessibility flags.</done>
</task>

<task type="auto">
  <name>Task 2: Add UploadEvidence POST action and Deliverable view with file upload form</name>
  <files>Controllers/CDPController.cs, Views/CDP/Deliverable.cshtml</files>
  <action>
**CDPController.cs** — Add `UploadEvidence(int progressId, IFormFile evidenceFile)` POST action:
- Attributes: `[HttpPost]`, `[ValidateAntiForgeryToken]`
- Steps:
  1. Get current user. If null, return Challenge().
  2. Validate file is not null/empty: if null or Length == 0, TempData["Error"] = "File tidak boleh kosong." and redirect to Deliverable with id = progressId.
  3. Validate file extension: allowed = { ".pdf", ".jpg", ".jpeg", ".png" }. Check `Path.GetExtension(evidenceFile.FileName).ToLowerInvariant()`. If not allowed, TempData["Error"] = "Hanya PDF, JPG, dan PNG yang diperbolehkan."
  4. Validate file size: if `evidenceFile.Length > 10 * 1024 * 1024`, TempData["Error"] = "Ukuran file maksimal 10MB."
  5. Load progress record: `_context.ProtonDeliverableProgresses.FirstOrDefaultAsync(p => p.Id == progressId)`. If null, return NotFound().
  6. **Authorization check:** user must be RoleLevel <= 5 (coach/supervisor). If RoleLevel > 5, return Forbid(). This matches PROTN-04 requirement ("Coach can upload").
  7. **Status check:** progress.Status must be "Active" or "Rejected". If not, TempData["Error"] = "Deliverable ini tidak dapat diupload." and redirect.
  8. Build upload directory: `Path.Combine(_env.WebRootPath, "uploads", "evidence", progressId.ToString())`
  9. `Directory.CreateDirectory(uploadDir)` — idempotent, creates if not exists.
  10. Sanitize filename: `$"{DateTime.UtcNow:yyyyMMddHHmmss}_{Path.GetFileName(evidenceFile.FileName)}"` — Path.GetFileName strips directory components (prevents path traversal).
  11. Write file: `using var stream = new FileStream(Path.Combine(uploadDir, safeFileName), FileMode.Create); await evidenceFile.CopyToAsync(stream);`
  12. Update progress record:
      - `progress.EvidencePath = $"/uploads/evidence/{progressId}/{safeFileName}"`
      - `progress.EvidenceFileName = evidenceFile.FileName` (original name for display)
      - `progress.Status = "Submitted"`
      - `progress.SubmittedAt = DateTime.UtcNow`
      - If previous status was "Rejected": clear `progress.RejectedAt = null` (resubmit clears rejection)
  13. SaveChangesAsync()
  14. TempData["Success"] = "Evidence berhasil diupload. Menunggu review approver."
  15. RedirectToAction("Deliverable", new { id = progressId })

**PROTN-05 (resubmit):** The same UploadEvidence action handles resubmit because step 7 allows Status == "Rejected". When a rejected deliverable's evidence is re-uploaded, the status changes from "Rejected" to "Submitted" and RejectedAt is cleared. Old files remain on disk as audit trail (not deleted).

**Views/CDP/Deliverable.cshtml** — New file:
- `@model HcPortal.Models.DeliverableViewModel`
- Page title: "Deliverable — {Model.Deliverable.NamaDeliverable}"

Layout structure:
1. **Breadcrumb:** Proton > {TrackType} {TahunKe} > {Kompetensi name} > {SubKompetensi name} > {Deliverable name}
2. **TempData alerts:** Display TempData["Success"] and TempData["Error"] as Bootstrap alerts (same pattern as other pages)
3. **If Model.IsAccessible == false:** Show Bootstrap alert-warning: "Deliverable ini belum dapat diakses. Selesaikan deliverable sebelumnya terlebih dahulu." with a "Kembali" button linking to PlanIdp. Do NOT render the upload form or evidence details.
4. **If Model.IsAccessible == true:** Show deliverable detail card:

   **Card header:** Deliverable name, Status badge (color-coded: Active=primary, Submitted=warning, Approved=success, Rejected=danger, Locked=secondary)

   **Card body:**
   - Info row: Coachee = {Model.CoacheeName}, Track = {Model.TrackType} {Model.TahunKe}
   - If evidence exists (Model.Progress.EvidencePath is not null):
     - Show: "Evidence: {Model.Progress.EvidenceFileName}" with a download link `<a href="{Model.Progress.EvidencePath}" target="_blank">Download</a>`
     - Show: "Diupload: {Model.Progress.SubmittedAt:dd MMM yyyy HH:mm}"
   - If status is "Rejected":
     - Show Bootstrap alert-danger: "Deliverable ini ditolak. Silakan upload ulang evidence."
     - Show rejection date if available

   **Upload form** (only shown if Model.CanUpload == true):
   - `<form method="post" asp-action="UploadEvidence" enctype="multipart/form-data">` — **CRITICAL: enctype="multipart/form-data" must be present**
   - Hidden input: `<input type="hidden" name="progressId" value="@Model.Progress.Id" />`
   - File input: `<input type="file" name="evidenceFile" class="form-control" accept=".pdf,.jpg,.jpeg,.png" />`
   - Help text: "Format: PDF, JPG, PNG. Maksimal 10MB."
   - Submit button: "Upload Evidence" (btn-primary)
   - If status is "Rejected": change button text to "Upload Ulang Evidence"

   **If status is "Submitted":**
   - Show info text: "Evidence telah diupload dan menunggu review approver."

   **If status is "Approved":**
   - Show success text: "Deliverable ini telah disetujui pada {ApprovedAt:dd MMM yyyy}."

5. **Back link:** `<a asp-action="PlanIdp" class="btn btn-outline-secondary mt-3">Kembali ke IDP Plan</a>`
  </action>
  <verify>
1. `dotnet build -c Release` succeeds with 0 errors
2. Grep CDPController.cs for "UploadEvidence" — found
3. Grep CDPController.cs for "enctype" or "IFormFile" — IFormFile found in parameter
4. Views/CDP/Deliverable.cshtml exists and contains:
   - "enctype=\"multipart/form-data\"" — CRITICAL for file upload
   - "DeliverableViewModel" — model reference
   - "evidenceFile" — file input name matching controller parameter
5. Grep CDPController.cs for "_env.WebRootPath" — found (file storage path)
6. Grep CDPController.cs for "Path.GetFileName" — found (filename sanitization)
  </verify>
  <done>Deliverable page shows evidence details and upload form. Coach can upload PDF/JPG/PNG (max 10MB). Rejected deliverables show resubmit UI. Files stored to wwwroot/uploads/evidence/{progressId}/. Sequential lock prevents access to locked deliverables (server-enforced).</done>
</task>

</tasks>

<verification>
1. `dotnet build -c Release` — 0 errors
2. Sequential lock enforcement: Deliverable GET checks previous deliverable status, returns locked view if not Approved
3. File upload: UploadEvidence POST validates file (type, size), sanitizes filename, writes to wwwroot/uploads/evidence/
4. Resubmit: Rejected deliverable allows re-upload, status changes from Rejected to Submitted
5. No path traversal: Path.GetFileName used on evidenceFile.FileName
6. enctype="multipart/form-data" present on upload form (prevents null IFormFile)
</verification>

<success_criteria>
- PROTN-03: Sequential lock enforced server-side — accessing a locked deliverable shows "not accessible" message, not the upload form
- PROTN-04: Coach can upload evidence (PDF/JPG/PNG, max 10MB) for an Active deliverable
- PROTN-05: Coach can revise evidence for a Rejected deliverable, status returns to Submitted
- Files stored securely with sanitized filenames under wwwroot/uploads/evidence/{progressId}/
- Application builds and runs without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-proton-deliverable-tracking/05-03-SUMMARY.md`
</output>
