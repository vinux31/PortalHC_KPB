---
phase: 06-approval-workflow-completion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Models/ProtonModels.cs
  - Models/ProtonViewModels.cs
  - Data/ApplicationDbContext.cs
autonomous: true

must_haves:
  truths:
    - "ProtonDeliverableProgress has RejectionReason, ApprovedById, HCApprovalStatus, HCReviewedAt, HCReviewedById fields"
    - "ProtonNotification and ProtonFinalAssessment entities exist with correct schemas"
    - "DeliverableViewModel has CanApprove, CanHCReview, CurrentUserRole fields"
    - "ProtonPlanViewModel has FinalAssessment nullable property"
    - "HCApprovalQueueViewModel exists with PendingReviews, Notifications, UserNames, ReadyForFinalAssessment"
    - "Database migration applies cleanly with no cascade path errors"
  artifacts:
    - path: "Models/ProtonModels.cs"
      provides: "ProtonDeliverableProgress extended fields, ProtonNotification, ProtonFinalAssessment"
      contains: "HCApprovalStatus"
    - path: "Models/ProtonViewModels.cs"
      provides: "Extended DeliverableViewModel, ProtonPlanViewModel, new HCApprovalQueueViewModel, FinalAssessmentViewModel"
      contains: "HCApprovalQueueViewModel"
    - path: "Data/ApplicationDbContext.cs"
      provides: "ProtonNotifications and ProtonFinalAssessments DbSets with FK config"
      contains: "ProtonNotifications"
  key_links:
    - from: "Models/ProtonModels.cs"
      to: "Data/ApplicationDbContext.cs"
      via: "DbSet registration and OnModelCreating FK config"
      pattern: "DbSet<ProtonFinalAssessment>"
    - from: "Models/ProtonModels.cs"
      to: "Models/ProtonViewModels.cs"
      via: "ViewModels reference entity types"
      pattern: "ProtonFinalAssessment\\?"
---

<objective>
Add approval workflow data foundation: extend ProtonDeliverableProgress with 5 new fields (RejectionReason, ApprovedById, HCApprovalStatus, HCReviewedAt, HCReviewedById), create ProtonNotification and ProtonFinalAssessment entities, extend ViewModels, register DbSets, configure FK relationships, and apply EF Core migration.

Purpose: All Phase 6 controller actions and views depend on these models, DbSets, and ViewModels existing. This is the data layer that enables approval, HC review, notification, and final assessment features.
Output: Extended ProtonModels.cs, extended ProtonViewModels.cs, updated ApplicationDbContext.cs, applied migration
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-approval-workflow-completion/06-RESEARCH.md
@Models/ProtonModels.cs
@Models/ProtonViewModels.cs
@Data/ApplicationDbContext.cs
@Models/Competency/UserCompetencyLevel.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend ProtonDeliverableProgress and add ProtonNotification + ProtonFinalAssessment models</name>
  <files>Models/ProtonModels.cs</files>
  <action>
Extend the existing `ProtonDeliverableProgress` class in Models/ProtonModels.cs with 5 new fields after the existing `CreatedAt` property:

```csharp
// ===== Phase 6: Approval Workflow =====
/// <summary>Written rejection reason (APPRV-05). Set by SrSpv or SectionHead.</summary>
public string? RejectionReason { get; set; }

/// <summary>User ID of the approver who approved. No FK — matches pattern.</summary>
public string? ApprovedById { get; set; }

/// <summary>HC review channel — independent of main Status. "Pending" or "Reviewed". (APPRV-04)</summary>
public string HCApprovalStatus { get; set; } = "Pending";

/// <summary>When HC marked as reviewed.</summary>
public DateTime? HCReviewedAt { get; set; }

/// <summary>HC user ID who reviewed. No FK — matches pattern.</summary>
public string? HCReviewedById { get; set; }
```

Add two new classes to the same file:

1. `ProtonNotification` — in-app notification for HC when coachee completes all deliverables (PROTN-06):
   - `int Id` (PK), `string RecipientId` (HC user ID, no FK), `string CoacheeId`, `string CoacheeName` (denormalized), `string Message`, `string Type` ("AllDeliverablesComplete"), `bool IsRead` (default false), `DateTime CreatedAt` (default UtcNow), `DateTime? ReadAt`
   - No FK constraints on any string ID fields — matches CoachingLog/ProtonTrackAssignment pattern

2. `ProtonFinalAssessment` — final Proton Assessment record created by HC (PROTN-07):
   - `int Id` (PK), `string CoacheeId` (no FK), `string CreatedById` (no FK), `int ProtonTrackAssignmentId` (FK to ProtonTrackAssignment with Restrict), `ProtonTrackAssignment? ProtonTrackAssignment` (nav property), `string Status` (default "Completed"), `int CompetencyLevelGranted` (0-5), `int? KkjMatrixItemId` (nullable — HC selects competency from dropdown), `string? Notes`, `DateTime CreatedAt` (default UtcNow), `DateTime? CompletedAt`
   - IMPORTANT: Do NOT add navigation properties for ApprovedById/HCReviewedById on ProtonDeliverableProgress. Keep them as plain string fields to avoid cascade path issues.
   - Do NOT add a KkjMatrixItem navigation property on ProtonFinalAssessment — keep KkjMatrixItemId as a plain int? field to avoid cascade path conflicts. The dropdown will query KkjMatrices separately.

Follow existing ProtonModels.cs patterns: file-scoped namespace, XML doc comments, same coding style.
  </action>
  <verify>Build succeeds: `dotnet build` with 0 errors. Verify ProtonDeliverableProgress has HCApprovalStatus, ProtonNotification and ProtonFinalAssessment classes exist.</verify>
  <done>ProtonModels.cs contains extended ProtonDeliverableProgress (5 new fields), ProtonNotification class, and ProtonFinalAssessment class. Build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Extend ViewModels, register DbSets, configure FKs, and apply migration</name>
  <files>Models/ProtonViewModels.cs, Data/ApplicationDbContext.cs</files>
  <action>
**Step A — Extend ViewModels in Models/ProtonViewModels.cs:**

1. Add 3 fields to existing `DeliverableViewModel`:
   - `public bool CanApprove { get; set; }` — true for SrSpv/SectionHead when Status=="Submitted"
   - `public bool CanHCReview { get; set; }` — true for HC when HCApprovalStatus=="Pending"
   - `public string CurrentUserRole { get; set; } = "";` — for conditional view rendering

2. Add 1 field to existing `ProtonPlanViewModel`:
   - `public ProtonFinalAssessment? FinalAssessment { get; set; }` — null if no final assessment exists (PROTN-08)

3. Add new `HCApprovalQueueViewModel` class:
   - `public List<ProtonDeliverableProgress> PendingReviews { get; set; } = new();` — HCApprovalStatus=="Pending"
   - `public List<ProtonNotification> Notifications { get; set; } = new();` — unread notifications for this HC
   - `public Dictionary<string, string> UserNames { get; set; } = new();` — coachee display names
   - `public List<FinalAssessmentCandidate> ReadyForFinalAssessment { get; set; } = new();` — coachees ready for final assessment

4. Add new `FinalAssessmentCandidate` class (simple DTO):
   - `public string CoacheeId { get; set; } = "";`
   - `public string CoacheeName { get; set; } = "";`
   - `public int TrackAssignmentId { get; set; }`
   - `public string TrackType { get; set; } = "";`
   - `public string TahunKe { get; set; } = "";`

5. Add new `FinalAssessmentViewModel` class:
   - `public ProtonTrackAssignment? Assignment { get; set; }`
   - `public string CoacheeName { get; set; } = "";`
   - `public int TotalDeliverables { get; set; }`
   - `public int ApprovedDeliverables { get; set; }`
   - `public bool AllHCReviewed { get; set; }`
   - `public List<KkjMatrixItem> AvailableCompetencies { get; set; } = new();` — dropdown options for HC to select competency
   - `public ProtonFinalAssessment? ExistingAssessment { get; set; }` — null if no assessment yet

Add `using HcPortal.Models.Competency;` at top of file if not already present (needed for KkjMatrixItem reference).

**Step B — Register DbSets and configure FKs in Data/ApplicationDbContext.cs:**

1. Add after the ProtonDeliverableProgresses DbSet line:
   ```csharp
   // Approval Workflow & Completion (Phase 6)
   public DbSet<ProtonNotification> ProtonNotifications { get; set; }
   public DbSet<ProtonFinalAssessment> ProtonFinalAssessments { get; set; }
   ```

2. Add EF config inside `OnModelCreating` after the existing ProtonTrackAssignment config block:
   ```csharp
   // ProtonFinalAssessment -> ProtonTrackAssignment (Phase 6)
   builder.Entity<ProtonFinalAssessment>(entity =>
   {
       entity.HasOne(fa => fa.ProtonTrackAssignment)
           .WithMany()
           .HasForeignKey(fa => fa.ProtonTrackAssignmentId)
           .OnDelete(DeleteBehavior.Restrict);
       entity.HasIndex(fa => fa.CoacheeId);
       entity.HasIndex(fa => new { fa.CoacheeId, fa.Status });
   });

   // ProtonNotification indexes (Phase 6)
   builder.Entity<ProtonNotification>(entity =>
   {
       entity.HasIndex(n => n.RecipientId);
       entity.HasIndex(n => new { n.RecipientId, n.IsRead });
       entity.HasIndex(n => n.CoacheeId);
   });

   // ProtonDeliverableProgress HCApprovalStatus default (Phase 6)
   builder.Entity<ProtonDeliverableProgress>()
       .Property(p => p.HCApprovalStatus)
       .HasDefaultValue("Pending");
   ```

   IMPORTANT: Use DeleteBehavior.Restrict on the ProtonFinalAssessment FK — consistent with ALL Proton FK relationships. Do NOT use Cascade.

**Step C — Create and apply migration:**

Run: `dotnet ef migrations add AddApprovalWorkflow --project . --context ApplicationDbContext`
Then: `dotnet ef database update --project . --context ApplicationDbContext`

If the migration fails due to cascade path, check that no navigation properties were added for the string ID fields (ApprovedById, HCReviewedById, etc.).
  </action>
  <verify>
1. `dotnet build` succeeds with 0 errors
2. `dotnet ef database update` completes without errors
3. Migration file exists in Migrations/ directory containing AddColumn for HCApprovalStatus, CreateTable for ProtonNotifications and ProtonFinalAssessments
  </verify>
  <done>ViewModels extended with approval fields, DbSets registered, FK configured with Restrict, migration applied. Database has new columns on ProtonDeliverableProgresses and two new tables (ProtonNotifications, ProtonFinalAssessments).</done>
</task>

</tasks>

<verification>
- `dotnet build` passes with 0 errors
- Migration file in Migrations/ contains: AddColumn for RejectionReason/ApprovedById/HCApprovalStatus/HCReviewedAt/HCReviewedById on ProtonDeliverableProgresses, CreateTable for ProtonNotifications and ProtonFinalAssessments
- `dotnet ef database update` succeeds — no cascade path errors
- ProtonDeliverableProgress has HCApprovalStatus defaulting to "Pending"
- DeliverableViewModel has CanApprove, CanHCReview, CurrentUserRole properties
- ProtonPlanViewModel has FinalAssessment property
- HCApprovalQueueViewModel class exists with PendingReviews, Notifications, UserNames, ReadyForFinalAssessment
</verification>

<success_criteria>
- Database schema updated with 5 new columns on ProtonDeliverableProgresses + 2 new tables
- All models and ViewModels compile and are ready for controller use in Plans 02 and 03
- No cascade path errors in migration
- Build green
</success_criteria>

<output>
After completion, create `.planning/phases/06-approval-workflow-completion/06-01-SUMMARY.md`
</output>
