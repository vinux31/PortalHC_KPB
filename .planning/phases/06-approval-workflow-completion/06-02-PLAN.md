---
phase: 06-approval-workflow-completion
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - Controllers/CDPController.cs
  - Views/CDP/Deliverable.cshtml
autonomous: true

must_haves:
  truths:
    - "SrSpv or SectionHead can approve a Submitted deliverable — status transitions to Approved"
    - "Approval unlocks the next sequential deliverable (Locked -> Active)"
    - "SrSpv or SectionHead can reject a Submitted deliverable with a written reason"
    - "Rejection reason is visible to both coach and coachee on the Deliverable page"
    - "HC can mark a deliverable as reviewed (HCApprovalStatus Pending -> Reviewed)"
    - "Approve/Reject buttons show only for SrSpv/SectionHead when Status==Submitted"
    - "HC review button shows only for HC when HCApprovalStatus==Pending"
  artifacts:
    - path: "Controllers/CDPController.cs"
      provides: "ApproveDeliverable POST, RejectDeliverable POST, extended Deliverable GET with CanApprove/CanHCReview"
      contains: "ApproveDeliverable"
    - path: "Views/CDP/Deliverable.cshtml"
      provides: "Conditional approval/rejection forms, rejection reason display, HC review button"
      contains: "CanApprove"
  key_links:
    - from: "Views/CDP/Deliverable.cshtml"
      to: "Controllers/CDPController.cs"
      via: "form POST to ApproveDeliverable and RejectDeliverable"
      pattern: "asp-action=\"ApproveDeliverable\""
    - from: "Controllers/CDPController.cs"
      to: "Data/ApplicationDbContext.cs"
      via: "EF Core queries on ProtonDeliverableProgresses"
      pattern: "_context\\.ProtonDeliverableProgresses"
---

<objective>
Implement SrSpv/SectionHead approval and rejection actions with sequential unlock, extend the Deliverable page with role-conditional approve/reject/HC-review UI, and display rejection reasons visible to all roles (APPRV-02, APPRV-03, APPRV-05, APPRV-06).

Purpose: This is the core approval workflow — the main Status column transitions from "Submitted" to "Approved" or "Rejected" driven by SrSpv/SectionHead. Without this, deliverables remain stuck at "Submitted" forever.
Output: Working ApproveDeliverable/RejectDeliverable POST actions, extended Deliverable.cshtml with conditional forms
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-approval-workflow-completion/06-RESEARCH.md
@.planning/phases/06-approval-workflow-completion/06-01-SUMMARY.md
@Controllers/CDPController.cs
@Views/CDP/Deliverable.cshtml
@Models/ProtonModels.cs
@Models/ProtonViewModels.cs
@Models/UserRoles.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ApproveDeliverable, RejectDeliverable POSTs and extend Deliverable GET</name>
  <files>Controllers/CDPController.cs</files>
  <action>
Add three changes to CDPController.cs:

**1. Extend existing Deliverable GET action** to set the new CanApprove, CanHCReview, and CurrentUserRole fields on DeliverableViewModel.

Find where DeliverableViewModel is constructed in the Deliverable GET action. Add these fields:

```csharp
// Phase 6: approval context for the view
var viewModel = new DeliverableViewModel
{
    // ... existing fields stay unchanged ...
    CanApprove = (userRole == UserRoles.SrSupervisor || userRole == UserRoles.SectionHead)
                 && progress.Status == "Submitted",
    CanHCReview = userRole == UserRoles.HC && progress.HCApprovalStatus == "Pending",
    CurrentUserRole = userRole ?? ""
};
```

Also: ensure that HC role (RoleLevel 2) can access the Deliverable GET page. The current access check restricts by section for coaches. HC should have full access (no section check). Check the existing access guard and add:
- If `userRole == UserRoles.HC` → skip section check, allow access
- Existing section check remains for Coach/SrSupervisor/SectionHead

**2. Add ApproveDeliverable POST action** — follows research Pattern 1 exactly:

```csharp
[HttpPost]
[ValidateAntiForgeryToken]
public async Task<IActionResult> ApproveDeliverable(int progressId)
```

Logic:
- Get user and role. Only SrSupervisor or SectionHead can approve (Forbid otherwise).
- Load progress with full Include chain: ProtonDeliverable -> ProtonSubKompetensi -> ProtonKompetensi
- Guard: only "Submitted" status can be approved. TempData["Error"] + redirect if wrong status.
- Section check: load coachee user, verify same section as approver. Forbid if different section.
- Set: Status="Approved", ApprovedAt=DateTime.UtcNow, ApprovedById=user.Id
- **Unlock next deliverable:** Load ALL progress records for this coachee where the ProtonKompetensi has same TrackType AND TahunKe. Order by Kompetensi.Urutan -> SubKompetensi.Urutan -> Deliverable.Urutan. Find the index of the just-approved record. If next exists and is "Locked", set it to "Active".
- **Check all-approved:** After unlocking, check if ALL ordered progresses for this coachee+track are now "Approved". If yes, call `await CreateHCNotificationAsync(progress.CoacheeId)` (will be added in Plan 03). For now, wrap the call in a try/catch or guard with a method-exists check. Alternative: add the private helper stub NOW that just does nothing, and Plan 03 will fill in the implementation. PREFERRED: Add the full `CreateHCNotificationAsync` implementation here since it is simple — it queries HC users, checks for existing notification (deduplication), and creates ProtonNotification records. This avoids a stub.
- SaveChangesAsync(), TempData["Success"], redirect to Deliverable.

The `CreateHCNotificationAsync` private helper method:
```csharp
private async Task CreateHCNotificationAsync(string coacheeId)
{
    // Deduplication: check if notification already exists for this coachee
    bool alreadyNotified = await _context.ProtonNotifications
        .AnyAsync(n => n.CoacheeId == coacheeId && n.Type == "AllDeliverablesComplete");
    if (alreadyNotified) return;

    var coachee = await _context.Users
        .Where(u => u.Id == coacheeId)
        .Select(u => new { u.FullName, u.UserName })
        .FirstOrDefaultAsync();
    var coacheeName = coachee?.FullName ?? coachee?.UserName ?? coacheeId;

    var hcUsers = await _userManager.GetUsersInRoleAsync(UserRoles.HC);

    var notifications = hcUsers.Select(hc => new ProtonNotification
    {
        RecipientId = hc.Id,
        CoacheeId = coacheeId,
        CoacheeName = coacheeName,
        Message = $"{coacheeName} telah menyelesaikan semua deliverable Proton.",
        Type = "AllDeliverablesComplete",
        IsRead = false,
        CreatedAt = DateTime.UtcNow
    }).ToList();

    _context.ProtonNotifications.AddRange(notifications);
    // Note: caller already calls SaveChangesAsync, but we save here for notification atomicity
    await _context.SaveChangesAsync();
}
```

**3. Add RejectDeliverable POST action** — follows research Pattern 2:

```csharp
[HttpPost]
[ValidateAntiForgeryToken]
public async Task<IActionResult> RejectDeliverable(int progressId, string rejectionReason)
```

Logic:
- Get user and role. Only SrSupervisor or SectionHead can reject (Forbid otherwise).
- Validate rejectionReason is not empty. TempData["Error"] if empty.
- Load progress by Id.
- Guard: only "Submitted" status can be rejected.
- Section check: same as ApproveDeliverable.
- Set: Status="Rejected", RejectedAt=DateTime.UtcNow, RejectionReason=rejectionReason, ApprovedById=null (clear), ApprovedAt=null (clear)
- SaveChangesAsync(), TempData["Success"], redirect to Deliverable.

IMPORTANT: The all-approved check in ApproveDeliverable must account for the current record being mid-update. When checking if all are approved, the current record's Status has already been set to "Approved" in memory but not yet saved. Use the in-memory state (which reflects the update) for the check BEFORE SaveChangesAsync.
  </action>
  <verify>
1. `dotnet build` succeeds with 0 errors
2. CDPController.cs contains ApproveDeliverable POST, RejectDeliverable POST, and CreateHCNotificationAsync private method
3. Deliverable GET now sets CanApprove, CanHCReview, CurrentUserRole on the ViewModel
  </verify>
  <done>ApproveDeliverable transitions Submitted->Approved with sequential unlock and HC notification. RejectDeliverable transitions Submitted->Rejected with written reason. Deliverable GET populates approval context for the view.</done>
</task>

<task type="auto">
  <name>Task 2: Extend Deliverable.cshtml with approval/rejection UI and HC review button</name>
  <files>Views/CDP/Deliverable.cshtml</files>
  <action>
Extend the existing Deliverable.cshtml to add role-conditional approval UI. All additions go INSIDE the existing `@else` block (when IsAccessible is true), within the card-body.

**1. Rejection reason display (APPRV-06):**
Find the existing `@if (Model.Progress?.Status == "Rejected")` block. REPLACE it with an enhanced version that shows the RejectionReason text:

```razor
@if (Model.Progress?.Status == "Rejected")
{
    <div class="alert alert-danger">
        <i class="bi bi-x-circle me-2"></i>
        <strong>Deliverable ini ditolak.</strong>
        @if (!string.IsNullOrEmpty(Model.Progress.RejectionReason))
        {
            <div class="mt-2 p-2 bg-white rounded border">
                <small class="text-muted d-block mb-1">Alasan Penolakan:</small>
                <span>@Model.Progress.RejectionReason</span>
            </div>
        }
        @if (Model.Progress.RejectedAt.HasValue)
        {
            <div class="mt-1">
                <small class="text-muted">Ditolak pada: @Model.Progress.RejectedAt.Value.ToString("dd MMM yyyy HH:mm")</small>
            </div>
        }
        @if (Model.CanUpload)
        {
            <div class="mt-1">
                <small>Silakan upload ulang evidence.</small>
            </div>
        }
    </div>
}
```

**2. Approve/Reject section for SrSpv/SectionHead (APPRV-02, APPRV-03, APPRV-05):**
Add AFTER the existing Submitted notice block and BEFORE the upload form section. This section is conditionally shown only when `Model.CanApprove` is true:

```razor
@* Approval actions — SrSpv/SectionHead only, Status==Submitted *@
@if (Model.CanApprove)
{
    <hr class="my-3" />
    <h6 class="fw-semibold mb-3">
        <i class="bi bi-clipboard-check me-2"></i>Tindakan Approval
    </h6>
    <div class="d-flex gap-2 mb-3">
        <form method="post" asp-action="ApproveDeliverable" class="d-inline">
            @Html.AntiForgeryToken()
            <input type="hidden" name="progressId" value="@Model.Progress!.Id" />
            <button type="submit" class="btn btn-success"
                    onclick="return confirm('Yakin ingin menyetujui deliverable ini?')">
                <i class="bi bi-check-circle me-1"></i>Setujui
            </button>
        </form>
        <button type="button" class="btn btn-danger" data-bs-toggle="collapse" data-bs-target="#rejectForm">
            <i class="bi bi-x-circle me-1"></i>Tolak
        </button>
    </div>
    <div class="collapse" id="rejectForm">
        <div class="card card-body border-danger mb-3">
            <form method="post" asp-action="RejectDeliverable">
                @Html.AntiForgeryToken()
                <input type="hidden" name="progressId" value="@Model.Progress!.Id" />
                <div class="mb-3">
                    <label class="form-label fw-semibold">Alasan Penolakan <span class="text-danger">*</span></label>
                    <textarea name="rejectionReason" class="form-control" rows="3"
                              placeholder="Tuliskan alasan penolakan..." required></textarea>
                </div>
                <button type="submit" class="btn btn-danger"
                        onclick="return confirm('Yakin ingin menolak deliverable ini?')">
                    <i class="bi bi-x-circle me-1"></i>Tolak Deliverable
                </button>
            </form>
        </div>
    </div>
}
```

**3. HC Review button (APPRV-04):**
Add AFTER the approval actions section. Shown only when `Model.CanHCReview` is true:

```razor
@* HC Review — HC only, HCApprovalStatus==Pending *@
@if (Model.CanHCReview)
{
    <hr class="my-3" />
    <h6 class="fw-semibold mb-3">
        <i class="bi bi-person-check me-2"></i>Review HC
    </h6>
    <form method="post" asp-action="HCReviewDeliverable">
        @Html.AntiForgeryToken()
        <input type="hidden" name="progressId" value="@Model.Progress!.Id" />
        <button type="submit" class="btn btn-info text-white"
                onclick="return confirm('Tandai deliverable ini sebagai sudah diperiksa HC?')">
            <i class="bi bi-check2-square me-1"></i>Tandai Sudah Diperiksa
        </button>
    </form>
}
```

**4. HC review status indicator:**
In the existing Approved notice block (`@if (Model.Progress?.Status == "Approved")`), add an HC review status line after the existing approved message:

```razor
@if (Model.Progress?.HCApprovalStatus == "Reviewed")
{
    <div class="mt-1">
        <small class="text-success"><i class="bi bi-check2-circle me-1"></i>Sudah diperiksa HC</small>
    </div>
}
```

**Layout order inside card-body (after info row):**
1. Evidence display (existing)
2. Rejected notice with reason (enhanced)
3. Submitted notice (existing)
4. Approved notice with HC status (enhanced)
5. Approval actions (new — SrSpv/SectionHead)
6. HC Review button (new — HC)
7. Upload form (existing — Coach)
  </action>
  <verify>
1. `dotnet build` succeeds with 0 errors
2. Deliverable.cshtml contains `asp-action="ApproveDeliverable"`, `asp-action="RejectDeliverable"`, `asp-action="HCReviewDeliverable"`, `RejectionReason` display
3. Rejection reason is rendered inside the Rejected status block
  </verify>
  <done>Deliverable page shows approve/reject buttons for SrSpv/SectionHead when Status==Submitted, rejection reason text visible to all roles when Status==Rejected, HC review button for HC when HCApprovalStatus==Pending. All forms use POST with AntiForgeryToken.</done>
</task>

</tasks>

<verification>
- `dotnet build` passes with 0 errors
- CDPController has ApproveDeliverable POST (transitions Submitted->Approved, unlocks next), RejectDeliverable POST (transitions Submitted->Rejected with reason), CreateHCNotificationAsync helper
- Deliverable.cshtml conditionally shows approval actions for SrSpv/SectionHead, rejection reason for all roles, HC review button for HC
- Rejection reason (RejectionReason field) is displayed in the Rejected notice block — visible to both coach and coachee (APPRV-06)
- Section check enforced for approvers — cross-section approval is forbidden
</verification>

<success_criteria>
- APPRV-02: SrSpv can approve a submitted deliverable
- APPRV-03: SectionHead can approve a submitted deliverable (same action, either role)
- APPRV-05: Reject includes written rejection reason stored in RejectionReason
- APPRV-06: Rejection reason visible to coach and coachee on Deliverable page
- PROTN-06: HC notification created when all deliverables approved (deduplication guard)
- Sequential unlock: approving deliverable N sets deliverable N+1 from Locked to Active
</success_criteria>

<output>
After completion, create `.planning/phases/06-approval-workflow-completion/06-02-SUMMARY.md`
</output>
