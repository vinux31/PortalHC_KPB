---
phase: 06-approval-workflow-completion
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - Controllers/CDPController.cs
  - Views/CDP/HCApprovals.cshtml
  - Views/CDP/CreateFinalAssessment.cshtml
  - Views/CDP/PlanIdp.cshtml
autonomous: true

must_haves:
  truths:
    - "HC can see a queue of deliverables pending HC review on the HCApprovals page"
    - "HC can mark a deliverable as reviewed (HCApprovalStatus Pending -> Reviewed) from HCApprovals or Deliverable page"
    - "HC sees notifications when a coachee completes all deliverables"
    - "HC can create a final Proton Assessment only after all HC reviews for a coachee are complete"
    - "Final assessment creation updates the coachee's UserCompetencyLevel via upsert"
    - "Coachee's PlanIdp page shows the final assessment status and competency level granted"
  artifacts:
    - path: "Controllers/CDPController.cs"
      provides: "HCApprovals GET, HCReviewDeliverable POST, CreateFinalAssessment GET+POST"
      contains: "HCApprovals"
    - path: "Views/CDP/HCApprovals.cshtml"
      provides: "HC queue page with pending reviews, notifications, and ready-for-assessment list"
      contains: "PendingReviews"
    - path: "Views/CDP/CreateFinalAssessment.cshtml"
      provides: "Form for HC to create final Proton Assessment with competency level and KKJ selector"
      contains: "CompetencyLevelGranted"
    - path: "Views/CDP/PlanIdp.cshtml"
      provides: "Final assessment card in Coachee branch showing status and competency level"
      contains: "FinalAssessment"
  key_links:
    - from: "Views/CDP/HCApprovals.cshtml"
      to: "Controllers/CDPController.cs"
      via: "Links to HCReviewDeliverable POST and CreateFinalAssessment GET"
      pattern: "asp-action=\"CreateFinalAssessment\""
    - from: "Controllers/CDPController.cs"
      to: "Data/ApplicationDbContext.cs"
      via: "EF Core upsert on UserCompetencyLevels in CreateFinalAssessment POST"
      pattern: "_context\\.UserCompetencyLevels"
    - from: "Views/CDP/PlanIdp.cshtml"
      to: "Models/ProtonViewModels.cs"
      via: "Reads FinalAssessment property from ProtonPlanViewModel"
      pattern: "protonModel\\.FinalAssessment"
---

<objective>
Build the HC workflow: HCApprovals queue page, HCReviewDeliverable action, CreateFinalAssessment with UserCompetencyLevel upsert, and extend PlanIdp Coachee view with final assessment status card (APPRV-04, PROTN-06, PROTN-07, PROTN-08).

Purpose: This completes the Proton lifecycle — HC reviews deliverables, creates final assessments, and coachees see their resulting competency level. Without this, approved deliverables have no HC review path and no way to produce a final competency outcome.
Output: HCApprovals.cshtml (new), CreateFinalAssessment.cshtml (new), extended PlanIdp.cshtml, extended CDPController.cs
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-approval-workflow-completion/06-RESEARCH.md
@.planning/phases/06-approval-workflow-completion/06-01-SUMMARY.md
@.planning/phases/06-approval-workflow-completion/06-02-SUMMARY.md
@Controllers/CDPController.cs
@Views/CDP/PlanIdp.cshtml
@Models/ProtonModels.cs
@Models/ProtonViewModels.cs
@Models/Competency/UserCompetencyLevel.cs
@Data/ApplicationDbContext.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add HCReviewDeliverable POST, HCApprovals GET, CreateFinalAssessment GET+POST to CDPController</name>
  <files>Controllers/CDPController.cs</files>
  <action>
Add four new actions and one helper method to CDPController.cs. Also add `using HcPortal.Models.Competency;` at the top if not already present.

**1. HCReviewDeliverable POST action (APPRV-04):**

```csharp
[HttpPost]
[ValidateAntiForgeryToken]
public async Task<IActionResult> HCReviewDeliverable(int progressId)
```

Logic:
- Get user and role. Only HC can review (Forbid if not HC).
- Load progress by Id.
- Guard: HCApprovalStatus must be "Pending". TempData["Error"] if already reviewed.
- Set: HCApprovalStatus="Reviewed", HCReviewedAt=DateTime.UtcNow, HCReviewedById=user.Id
- SaveChangesAsync(), TempData["Success"] = "Deliverable telah ditandai sebagai sudah diperiksa HC."
- Redirect to HCApprovals (not back to Deliverable — HC workflow stays on queue page)

**2. HCApprovals GET action (PROTN-06 + APPRV-04 queue):**

```csharp
public async Task<IActionResult> HCApprovals()
```

Logic:
- Get user and role. Only HC can access (Forbid if not HC).
- Query pending HC reviews:
  ```csharp
  var pendingReviews = await _context.ProtonDeliverableProgresses
      .Include(p => p.ProtonDeliverable)
          .ThenInclude(d => d.ProtonSubKompetensi)
              .ThenInclude(s => s.ProtonKompetensi)
      .Where(p => p.HCApprovalStatus == "Pending"
               && (p.Status == "Submitted" || p.Status == "Approved" || p.Status == "Rejected"))
      .OrderBy(p => p.SubmittedAt)
      .ToListAsync();
  ```
- Query unread notifications for this HC user:
  ```csharp
  var notifications = await _context.ProtonNotifications
      .Where(n => n.RecipientId == user.Id && !n.IsRead)
      .OrderByDescending(n => n.CreatedAt)
      .ToListAsync();
  ```
- Build coachee names dictionary (batch query — avoids N+1):
  ```csharp
  var coacheeIds = pendingReviews.Select(p => p.CoacheeId).Distinct().ToList();
  var userNames = await _context.Users
      .Where(u => coacheeIds.Contains(u.Id))
      .ToDictionaryAsync(u => u.Id, u => u.FullName ?? u.UserName ?? u.Id);
  ```
- Query "Ready for Final Assessment" — coachees where ALL progress records have HCApprovalStatus=="Reviewed" AND all Status=="Approved" AND no ProtonFinalAssessment exists yet:
  ```csharp
  var allAssignments = await _context.ProtonTrackAssignments
      .Where(a => a.IsActive)
      .ToListAsync();

  var existingAssessments = await _context.ProtonFinalAssessments
      .Select(fa => fa.CoacheeId)
      .Distinct()
      .ToListAsync();

  var readyForAssessment = new List<FinalAssessmentCandidate>();
  foreach (var assignment in allAssignments)
  {
      if (existingAssessments.Contains(assignment.CoacheeId)) continue;

      var progresses = await _context.ProtonDeliverableProgresses
          .Where(p => p.CoacheeId == assignment.CoacheeId)
          .ToListAsync();

      if (progresses.Any() &&
          progresses.All(p => p.Status == "Approved") &&
          progresses.All(p => p.HCApprovalStatus == "Reviewed"))
      {
          var name = userNames.ContainsKey(assignment.CoacheeId)
              ? userNames[assignment.CoacheeId]
              : assignment.CoacheeId;
          // Add to userNames if not present
          if (!userNames.ContainsKey(assignment.CoacheeId))
          {
              var u = await _context.Users.FindAsync(assignment.CoacheeId);
              name = u?.FullName ?? u?.UserName ?? assignment.CoacheeId;
              userNames[assignment.CoacheeId] = name;
          }
          readyForAssessment.Add(new FinalAssessmentCandidate
          {
              CoacheeId = assignment.CoacheeId,
              CoacheeName = name,
              TrackAssignmentId = assignment.Id,
              TrackType = assignment.TrackType,
              TahunKe = assignment.TahunKe
          });
      }
  }
  ```
- Mark notifications as read (the act of visiting the page marks them):
  ```csharp
  foreach (var n in notifications)
  {
      n.IsRead = true;
      n.ReadAt = DateTime.UtcNow;
  }
  if (notifications.Any()) await _context.SaveChangesAsync();
  ```
  NOTE: Load notifications BEFORE marking read so the view can still display them. Save after building the viewModel.
  Actually — display them first, mark read after building viewModel but before returning. Or: load, build viewModel with the unread list, then mark read and save. The view shows them as "new" on first visit.

- Build and return HCApprovalQueueViewModel:
  ```csharp
  var viewModel = new HCApprovalQueueViewModel
  {
      PendingReviews = pendingReviews,
      Notifications = notifications,
      UserNames = userNames,
      ReadyForFinalAssessment = readyForAssessment
  };
  return View(viewModel);
  ```

**3. CreateFinalAssessment GET action (PROTN-07 form):**

```csharp
public async Task<IActionResult> CreateFinalAssessment(int trackAssignmentId)
```

Logic:
- Get user and role. Only HC can access (Forbid if not HC).
- Load the track assignment by Id where IsActive==true. NotFound if missing.
- Check if assessment already exists for this coachee: query ProtonFinalAssessments where CoacheeId matches. If exists, show it as read-only (set ExistingAssessment on viewModel).
- Count total deliverables and approved deliverables for the coachee.
- Check AllHCReviewed: all progress records for this coachee have HCApprovalStatus=="Reviewed".
- Load available KKJ competencies for the dropdown:
  ```csharp
  var availableCompetencies = await _context.KkjMatrices.OrderBy(k => k.SkillGroup).ThenBy(k => k.Kompetensi).ToListAsync();
  ```
- Get coachee name.
- Build and return FinalAssessmentViewModel:
  ```csharp
  var viewModel = new FinalAssessmentViewModel
  {
      Assignment = assignment,
      CoacheeName = coacheeName,
      TotalDeliverables = totalDeliverables,
      ApprovedDeliverables = approvedDeliverables,
      AllHCReviewed = allHCReviewed,
      AvailableCompetencies = availableCompetencies,
      ExistingAssessment = existingAssessment
  };
  return View(viewModel);
  ```

**4. CreateFinalAssessment POST action (PROTN-07 + competency update):**

```csharp
[HttpPost]
[ValidateAntiForgeryToken]
public async Task<IActionResult> CreateFinalAssessment(int trackAssignmentId, int competencyLevelGranted, int? kkjMatrixItemId, string? notes)
```

Logic:
- Get user and role. Only HC can create (Forbid if not HC).
- Load assignment by trackAssignmentId where IsActive. NotFound if missing.
- Guard: check no pending HC reviews for this coachee:
  ```csharp
  bool hasPendingHCReviews = await _context.ProtonDeliverableProgresses
      .AnyAsync(p => p.CoacheeId == assignment.CoacheeId
                  && p.HCApprovalStatus == "Pending"
                  && (p.Status == "Submitted" || p.Status == "Approved"));
  if (hasPendingHCReviews)
  {
      TempData["Error"] = "Selesaikan semua review HC sebelum membuat final assessment.";
      return RedirectToAction("CreateFinalAssessment", new { trackAssignmentId });
  }
  ```
- Guard: check no existing ProtonFinalAssessment for this coachee:
  ```csharp
  bool alreadyExists = await _context.ProtonFinalAssessments
      .AnyAsync(fa => fa.CoacheeId == assignment.CoacheeId);
  if (alreadyExists)
  {
      TempData["Error"] = "Final assessment sudah dibuat untuk coachee ini.";
      return RedirectToAction("HCApprovals");
  }
  ```
- Validate competencyLevelGranted is between 0 and 5.
- Create ProtonFinalAssessment:
  ```csharp
  var finalAssessment = new ProtonFinalAssessment
  {
      CoacheeId = assignment.CoacheeId,
      CreatedById = user.Id,
      ProtonTrackAssignmentId = trackAssignmentId,
      Status = "Completed",
      CompetencyLevelGranted = competencyLevelGranted,
      KkjMatrixItemId = kkjMatrixItemId,
      Notes = notes,
      CreatedAt = DateTime.UtcNow,
      CompletedAt = DateTime.UtcNow
  };
  _context.ProtonFinalAssessments.Add(finalAssessment);
  ```
- Update UserCompetencyLevel (upsert) — only if kkjMatrixItemId is provided:
  ```csharp
  if (kkjMatrixItemId.HasValue)
  {
      var existingLevel = await _context.UserCompetencyLevels
          .FirstOrDefaultAsync(l => l.UserId == assignment.CoacheeId
                                 && l.KkjMatrixItemId == kkjMatrixItemId.Value);
      if (existingLevel != null)
      {
          existingLevel.CurrentLevel = competencyLevelGranted;
          existingLevel.Source = "Proton";
          existingLevel.UpdatedAt = DateTime.UtcNow;
          existingLevel.UpdatedBy = user.Id;
      }
      else
      {
          var kkjItem = await _context.KkjMatrices.FindAsync(kkjMatrixItemId.Value);
          _context.UserCompetencyLevels.Add(new UserCompetencyLevel
          {
              UserId = assignment.CoacheeId,
              KkjMatrixItemId = kkjMatrixItemId.Value,
              CurrentLevel = competencyLevelGranted,
              TargetLevel = kkjItem?.TargetLevel ?? 5,
              Source = "Proton",
              AchievedAt = DateTime.UtcNow,
              UpdatedBy = user.Id
          });
      }
  }
  ```
  NOTE: Check if KkjMatrixItem has a TargetLevel property. If not, use a default value. The existing UserCompetencyLevel model uses TargetLevel. Load the KKJ item to get it, or default to 5 if not found.
  ACTUALLY: KkjMatrixItem does NOT have a TargetLevel property per se — check the actual model. The TargetLevel on UserCompetencyLevel is "denormalized from KKJ matrix at creation time" per the XML doc. Use a sensible default (e.g., 5) or derive from the KKJ matrix if a target column exists. If no column exists, set TargetLevel = competencyLevelGranted (since Proton is a targeted certification).

- SaveChangesAsync(), TempData["Success"] = "Final Proton Assessment berhasil dibuat.", redirect to HCApprovals.
  </action>
  <verify>
1. `dotnet build` succeeds with 0 errors
2. CDPController.cs contains HCReviewDeliverable POST, HCApprovals GET, CreateFinalAssessment GET and POST
3. CreateFinalAssessment POST creates ProtonFinalAssessment record and upserts UserCompetencyLevel
  </verify>
  <done>HC can review deliverables, see pending queue with notifications, create final assessment with competency level selection, and upsert UserCompetencyLevel. All guard conditions enforced server-side.</done>
</task>

<task type="auto">
  <name>Task 2: Create HCApprovals.cshtml, CreateFinalAssessment.cshtml, and extend PlanIdp.cshtml</name>
  <files>Views/CDP/HCApprovals.cshtml, Views/CDP/CreateFinalAssessment.cshtml, Views/CDP/PlanIdp.cshtml</files>
  <action>
**1. Create Views/CDP/HCApprovals.cshtml (new file):**

A Bootstrap 5 page with three sections:

```razor
@model HcPortal.Models.HCApprovalQueueViewModel

@{
    ViewData["Title"] = "HC Approvals — Proton";
}
```

Section A — Notifications (if any exist):
- Alert-style cards showing each notification message (coachee completed all deliverables)
- Each notification shows CoacheeName, Message, CreatedAt
- Style as dismissible info alerts

Section B — Pending HC Reviews table:
- Table columns: #, Coachee, Kompetensi, Sub Kompetensi, Deliverable, Status, Submitted At, Action
- Each row shows progress record details from PendingReviews list
- Coachee name from UserNames dictionary
- Action column: two buttons — "Periksa" (link to Deliverable page) and "Tandai Sudah Diperiksa" (POST form to HCReviewDeliverable)
- If PendingReviews is empty: show "Tidak ada deliverable yang menunggu review HC." in a muted alert

Section C — Ready for Final Assessment:
- Card-style list of coachees ready for final assessment (ReadyForFinalAssessment)
- Each card shows CoacheeName, TrackType + TahunKe, and a "Buat Final Assessment" button linking to CreateFinalAssessment GET with trackAssignmentId
- If empty: show "Belum ada coachee yang siap untuk final assessment." in a muted alert

Include TempData alerts at top (same pattern as Deliverable.cshtml). Add a back link to CDP Index.

**2. Create Views/CDP/CreateFinalAssessment.cshtml (new file):**

```razor
@model HcPortal.Models.FinalAssessmentViewModel

@{
    ViewData["Title"] = "Final Proton Assessment";
}
```

If ExistingAssessment is not null — show READ-ONLY view:
- Card displaying the existing assessment: CoacheeName, TrackType, CompetencyLevelGranted, Notes, CompletedAt
- "Kembali" button to HCApprovals

If ExistingAssessment is null AND AllHCReviewed is false:
- Warning alert: "Belum semua deliverable diperiksa HC. Selesaikan review terlebih dahulu."
- "Kembali" button to HCApprovals

If ExistingAssessment is null AND AllHCReviewed is true — show CREATE form:
- Header: "Buat Final Assessment — {CoacheeName}"
- Info section showing: TrackType + TahunKe, TotalDeliverables, ApprovedDeliverables (should match)
- Form with POST to CreateFinalAssessment:
  - Hidden input: trackAssignmentId = Model.Assignment.Id
  - Competency Level dropdown (select): options 1 through 5, label "Level Kompetensi Diberikan"
  - KKJ Competency dropdown (select, optional): options from AvailableCompetencies list, each option shows `{SkillGroup} — {Kompetensi}`, value is the KkjMatrixItem Id. Include an empty "-- Pilih Kompetensi (opsional) --" option
  - Notes textarea (optional): label "Catatan Assessment"
  - Submit button: "Buat Final Assessment"
  - All with AntiForgeryToken

Include TempData alerts at top. Add breadcrumb: HC Approvals > Final Assessment.

**3. Extend Views/CDP/PlanIdp.cshtml — Coachee branch (PROTN-08):**

Find the existing Coachee branch in PlanIdp.cshtml where `IsProtonView` is true and the `protonModel` is cast from Model. This section currently shows the deliverable table and "Lanjut ke Deliverable Aktif" button.

Add a FINAL ASSESSMENT card at the BOTTOM of the Coachee branch (after the deliverable table, before the closing of the Proton section), ONLY when `protonModel.FinalAssessment != null`:

```razor
@* Final Assessment result (PROTN-08) *@
@if (protonModel.FinalAssessment != null)
{
    var assessment = protonModel.FinalAssessment;
    <div class="card border-success shadow-sm mt-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">
                <i class="bi bi-award me-2"></i>Hasil Penilaian Akhir Proton
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4 text-center">
                    <div class="display-4 text-success fw-bold">@assessment.CompetencyLevelGranted</div>
                    <div class="text-muted">Level Kompetensi</div>
                </div>
                <div class="col-md-8">
                    <div class="mb-2">
                        <small class="text-muted">Status</small>
                        <div><span class="badge bg-success px-3 py-2">@assessment.Status</span></div>
                    </div>
                    @if (assessment.CompletedAt.HasValue)
                    {
                        <div class="mb-2">
                            <small class="text-muted">Tanggal Penilaian</small>
                            <div>@assessment.CompletedAt.Value.ToString("dd MMM yyyy")</div>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(assessment.Notes))
                    {
                        <div class="mb-2">
                            <small class="text-muted">Catatan</small>
                            <div>@assessment.Notes</div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}
```

Also: update the CDPController PlanIdp GET action (Coachee path) to load the FinalAssessment and pass it in ProtonPlanViewModel. Find where `protonViewModel` is constructed and add:

```csharp
// Phase 6: load final assessment for PROTN-08
var finalAssessment = await _context.ProtonFinalAssessments
    .Where(fa => fa.CoacheeId == user.Id)
    .OrderByDescending(fa => fa.CreatedAt)
    .FirstOrDefaultAsync();
```

Set `FinalAssessment = finalAssessment` on the ProtonPlanViewModel.

NOTE: This requires modifying CDPController.cs (shared with Task 1). Since tasks are sequential within a plan, Task 2 runs after Task 1 — so CDPController already has HCApprovals/CreateFinalAssessment actions when this task adds the PlanIdp modification.

Add a navigation link to HCApprovals from the CDP/Index page: find the existing Proton Main card and add a new card below it for HC users:
```razor
@* Only show for HC role *@
```
Actually — check if a role check is possible in Index.cshtml. If not straightforward, skip the Index link. HCApprovals can be accessed via URL directly or from a menu link added later. PREFERRED: add a simple card in Index.cshtml conditionally rendered for HC role. But this requires ViewBag.UserRole to be set in the Index action. If it already is, use it. If not, skip the Index link — HC can navigate via URL.
  </action>
  <verify>
1. `dotnet build` succeeds with 0 errors
2. Views/CDP/HCApprovals.cshtml exists with pending reviews table, notifications section, ready-for-assessment list
3. Views/CDP/CreateFinalAssessment.cshtml exists with competency level dropdown and KKJ selector
4. Views/CDP/PlanIdp.cshtml contains Final Assessment card in Coachee branch
5. CDPController PlanIdp GET loads FinalAssessment for Coachee path
  </verify>
  <done>HC has a complete workflow page (HCApprovals) with pending review queue, notifications, and final assessment candidates. CreateFinalAssessment form allows HC to grant competency level with optional KKJ mapping. Coachee's PlanIdp shows the final assessment result card with competency level. PROTN-06, PROTN-07, PROTN-08 satisfied.</done>
</task>

</tasks>

<verification>
- `dotnet build` passes with 0 errors
- HCApprovals page loads at /CDP/HCApprovals for HC role
- HCReviewDeliverable POST transitions HCApprovalStatus from Pending to Reviewed
- CreateFinalAssessment GET shows form with competency level dropdown and KKJ selector
- CreateFinalAssessment POST creates ProtonFinalAssessment and upserts UserCompetencyLevel
- CreateFinalAssessment POST guards: all HC reviews must be complete, no duplicate assessment
- PlanIdp Coachee branch shows "Hasil Penilaian Akhir Proton" card when FinalAssessment exists
- Coachee sees CompetencyLevelGranted, Status, CompletedAt, and Notes in the assessment card
</verification>

<success_criteria>
- APPRV-04: HC receives and reviews deliverables via HCApprovals queue; all HC approvals must complete before final assessment
- PROTN-06: HC sees notification when coachee completes all deliverables (displayed on HCApprovals page)
- PROTN-07: HC can create final Proton Assessment after completing all pending HC approvals; updates UserCompetencyLevel
- PROTN-08: Coachee's Proton view (PlanIdp) shows final assessment status and resulting competency level update
</success_criteria>

<output>
After completion, create `.planning/phases/06-approval-workflow-completion/06-03-SUMMARY.md`
</output>
