---
phase: 07-development-dashboard
plan: 02
type: execute
wave: 2
depends_on: [07-01]
files_modified:
  - Views/CDP/DevDashboard.cshtml
  - Views/Shared/_Layout.cshtml
autonomous: false

must_haves:
  truths:
    - "Navigating to /CDP/DevDashboard as a Coach/SrSpv/SectionHead/HC/Admin role renders the dashboard page"
    - "Dashboard shows summary cards: Total Coachees, Total Deliverables, Pending Spv Approvals, Pending HC Reviews, Completed (with final assessment)"
    - "Dashboard shows a per-coachee table with name, track, progress bar, deliverable counts, and final assessment status"
    - "Dashboard renders a line chart (trendChart) showing average CompetencyLevelGranted per month — or an alert-info empty state if no data"
    - "Dashboard renders a doughnut chart (statusChart) showing deliverable status distribution — or an alert-info empty state if no data"
    - "A 'Dev Dashboard' nav link is visible in _Layout.cshtml for Coach, SrSupervisor, SectionHead, HC, and Admin roles"
    - "The nav link is NOT visible when the current user has the Coachee role"
    - "ScopeLabel is displayed as a subtitle on the dashboard (e.g., 'Unit: RFCC NHT', 'Section: GAST', 'All Sections')"
  artifacts:
    - path: "Views/CDP/DevDashboard.cshtml"
      provides: "Development dashboard view with charts and coachee table"
      contains: "trendChart"
    - path: "Views/Shared/_Layout.cshtml"
      provides: "Nav link to DevDashboard for allowed roles"
      contains: "DevDashboard"
  key_links:
    - from: "Views/CDP/DevDashboard.cshtml"
      to: "Models/DevDashboardViewModel"
      via: "@model DevDashboardViewModel"
      pattern: "@model.*DevDashboardViewModel"
    - from: "DevDashboard.cshtml trendChart"
      to: "Model.TrendLabels / Model.TrendValues"
      via: "@Json.Serialize(Model.TrendLabels)"
      pattern: "Json.Serialize.*TrendLabels"
    - from: "DevDashboard.cshtml statusChart"
      to: "Model.StatusLabels / Model.StatusData"
      via: "@Json.Serialize(Model.StatusLabels)"
      pattern: "Json.Serialize.*StatusLabels"
    - from: "_Layout.cshtml nav"
      to: "CDPController.DevDashboard"
      via: "asp-controller='CDP' asp-action='DevDashboard'"
      pattern: "asp-action.*DevDashboard"
---

<objective>
Create the DevDashboard.cshtml view with Bootstrap summary cards, per-coachee progress table, Chart.js line chart (competency trend) and doughnut chart (deliverable status distribution). Add the nav link to _Layout.cshtml visible to all roles except Coachee.

Purpose: The user-facing development dashboard — supervisors and HC see their team's deliverable progress and competency trends at a glance.
Output: Views/CDP/DevDashboard.cshtml (new), Views/Shared/_Layout.cshtml (nav link added)
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/07-development-dashboard/07-01-SUMMARY.md
@.planning/phases/07-development-dashboard/07-RESEARCH.md
@Views/CDP/Dashboard.cshtml
@Views/Shared/_Layout.cshtml
@Models/DevDashboardViewModel.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DevDashboard.cshtml view</name>
  <files>Views/CDP/DevDashboard.cshtml</files>
  <action>
Create `Views/CDP/DevDashboard.cshtml`. Follow the Bootstrap card structure and Chart.js CDN pattern from `Views/CDP/Dashboard.cshtml`. Do NOT copy mock data — all data comes from Model.

**File structure:**

```razor
@model HcPortal.Models.DevDashboardViewModel
@{
    ViewData["Title"] = "Development Dashboard";
}

<div class="container-fluid px-4">
    <!-- Page header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-0">Development Dashboard</h2>
            <small class="text-muted">@Model.ScopeLabel &mdash; @Model.CurrentUserRole</small>
        </div>
    </div>

    <!-- Summary Cards Row -->
    <div class="row g-3 mb-4">
        <!-- Total Coachees -->
        <div class="col-6 col-md-4 col-lg-2">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <i class="bi bi-people-fill fs-3 text-primary mb-2"></i>
                    <h3 class="fw-bold mb-0">@Model.TotalCoachees</h3>
                    <small class="text-muted">Total Coachees</small>
                </div>
            </div>
        </div>
        <!-- Total Deliverables -->
        <div class="col-6 col-md-4 col-lg-2">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <i class="bi bi-file-earmark-check-fill fs-3 text-success mb-2"></i>
                    <h3 class="fw-bold mb-0">@Model.ApprovedDeliverables</h3>
                    <small class="text-muted">Approved / @Model.TotalDeliverables Total</small>
                </div>
            </div>
        </div>
        <!-- Pending Spv Approvals -->
        <div class="col-6 col-md-4 col-lg-2">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <i class="bi bi-hourglass-split fs-3 text-warning mb-2"></i>
                    <h3 class="fw-bold mb-0">@Model.PendingSpvApprovals</h3>
                    <small class="text-muted">Pending Spv Approval</small>
                </div>
            </div>
        </div>
        <!-- Pending HC Reviews -->
        <div class="col-6 col-md-4 col-lg-2">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <i class="bi bi-eye-fill fs-3 text-info mb-2"></i>
                    <h3 class="fw-bold mb-0">@Model.PendingHCReviews</h3>
                    <small class="text-muted">Pending HC Review</small>
                </div>
            </div>
        </div>
        <!-- Completed (with Final Assessment) -->
        <div class="col-6 col-md-4 col-lg-2">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <i class="bi bi-award-fill fs-3 text-success mb-2"></i>
                    <h3 class="fw-bold mb-0">@Model.CompletedCoachees</h3>
                    <small class="text-muted">Completed Track</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row g-3 mb-4">
        <!-- Competency Trend Chart (line) -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0 fw-semibold pt-3">
                    <i class="bi bi-graph-up me-2 text-primary"></i>Competency Level Granted Over Time
                </div>
                <div class="card-body">
                    @if (Model.TrendLabels.Any())
                    {
                        <canvas id="trendChart" style="max-height: 260px;"></canvas>
                    }
                    else
                    {
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle me-2"></i>No Proton final assessments completed yet in this scope.
                        </div>
                    }
                </div>
            </div>
        </div>
        <!-- Deliverable Status Distribution (doughnut) -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0 fw-semibold pt-3">
                    <i class="bi bi-pie-chart-fill me-2 text-primary"></i>Deliverable Status
                </div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    @if (Model.StatusData.Any(d => d > 0))
                    {
                        <canvas id="statusChart" style="max-height: 260px;"></canvas>
                    }
                    else
                    {
                        <div class="alert alert-info mb-0 w-100">
                            <i class="bi bi-info-circle me-2"></i>No deliverable data yet in this scope.
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Per-coachee progress table -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-transparent border-0 fw-semibold pt-3">
            <i class="bi bi-table me-2 text-primary"></i>Team Deliverable Progress
        </div>
        <div class="card-body p-0">
            @if (Model.CoacheeRows.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Coachee</th>
                                <th>Track</th>
                                <th>Progress</th>
                                <th class="text-center">Approved</th>
                                <th class="text-center">Pending</th>
                                <th class="text-center">Rejected</th>
                                <th class="text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var row in Model.CoacheeRows)
                            {
                                <tr>
                                    <td class="fw-semibold">@row.CoacheeName</td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(row.TrackType))
                                        {
                                            <span class="badge bg-secondary bg-opacity-10 text-secondary">@row.TrackType</span>
                                            <small class="text-muted ms-1">@row.TahunKe</small>
                                        }
                                        else
                                        {
                                            <span class="text-muted small">Not assigned</span>
                                        }
                                    </td>
                                    <td style="min-width: 160px;">
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="progress flex-grow-1" style="height: 8px;">
                                                <div class="progress-bar bg-success"
                                                     role="progressbar"
                                                     style="width: @row.ProgressPercent"
                                                     aria-valuenow="@(row.TotalDeliverables > 0 ? row.Approved * 100 / row.TotalDeliverables : 0)"
                                                     aria-valuemin="0"
                                                     aria-valuemax="100"></div>
                                            </div>
                                            <small class="text-muted text-nowrap">@row.ProgressPercent</small>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-success bg-opacity-10 text-success">@row.Approved</span>
                                    </td>
                                    <td class="text-center">
                                        @if (row.Submitted > 0)
                                        {
                                            <span class="badge bg-warning bg-opacity-10 text-warning">@row.Submitted</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">—</span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        @if (row.Rejected > 0)
                                        {
                                            <span class="badge bg-danger bg-opacity-10 text-danger">@row.Rejected</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">—</span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        @if (row.HasFinalAssessment)
                                        {
                                            <span class="badge bg-success">
                                                <i class="bi bi-award-fill me-1"></i>Level @row.CompetencyLevelGranted
                                            </span>
                                        }
                                        else if (row.TotalDeliverables == 0)
                                        {
                                            <span class="badge bg-light text-muted">No track</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary bg-opacity-25 text-secondary">In Progress</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="p-4 text-center text-muted">
                    <i class="bi bi-people fs-1 d-block mb-2"></i>
                    No coachees found in your scope.
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            // --- Trend Line Chart ---
            @if (Model.TrendLabels.Any())
            {
                <text>
                const trendLabels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.TrendLabels));
                const trendValues = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.TrendValues));
                const trendCtx = document.getElementById('trendChart').getContext('2d');
                new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: trendLabels,
                        datasets: [{
                            label: 'Avg Competency Level Granted',
                            data: trendValues,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'top' } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 5,
                                title: { display: true, text: 'Level (0-5)' },
                                grid: { borderDash: [5, 5] }
                            },
                            x: { grid: { display: false } }
                        }
                    }
                });
                </text>
            }

            // --- Status Doughnut Chart ---
            @if (Model.StatusData.Any(d => d > 0))
            {
                <text>
                const statusLabels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.StatusLabels));
                const statusData   = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.StatusData));
                const statusCtx = document.getElementById('statusChart').getContext('2d');
                new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: statusLabels,
                        datasets: [{
                            data: statusData,
                            backgroundColor: [
                                'rgba(40, 167, 69, 0.8)',
                                'rgba(23, 162, 184, 0.8)',
                                'rgba(255, 193, 7, 0.8)',
                                'rgba(220, 53, 69, 0.8)',
                                'rgba(173, 181, 189, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
                </text>
            }

        });
    </script>
}
```

Notes:
- Use `@Html.Raw(System.Text.Json.JsonSerializer.Serialize(...))` for chart data arrays — consistent with how other views handle JSON serialization in this project. (The research shows `@Json.Serialize()` is used in some views; use whichever is already imported in this project — check the existing Dashboard.cshtml for the exact pattern and match it.)
- The `@section Scripts { }` block integrates with the existing `_Layout.cshtml` `@RenderSection("Scripts", required: false)` call.
- Check if `_Layout.cshtml` uses `@RenderSection("Scripts", ...)` — if it does not, inline the script directly at the bottom of the file instead.
  </action>
  <verify>
1. `dotnet build` exits 0.
2. Navigate to `/CDP/DevDashboard` as a logged-in Coach/HC/Admin user — page renders without 500 errors.
3. `grep -n "trendChart\|statusChart" Views/CDP/DevDashboard.cshtml` shows both canvas IDs.
  </verify>
  <done>
DevDashboard.cshtml exists and renders a complete dashboard: 5 summary cards, per-coachee table, line chart or empty-state alert for trend, doughnut chart or empty-state alert for status distribution. Page loads without runtime errors for allowed roles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add DevDashboard nav link to _Layout.cshtml</name>
  <files>Views/Shared/_Layout.cshtml</files>
  <action>
Read the current `_Layout.cshtml` nav section (around lines 51-68). Add a "Dev Dashboard" nav link AFTER the existing CDP nav item and BEFORE the BP nav item. The link must only be visible to Coach, SrSupervisor, SectionHead, HC, and Admin roles — NOT Coachee.

The `userRole` variable is already computed at the top of `_Layout.cshtml` (line 7). Use it directly:

```razor
@if (userRole == UserRoles.Coach ||
     userRole == UserRoles.SrSupervisor ||
     userRole == UserRoles.SectionHead ||
     userRole == UserRoles.HC ||
     userRole == UserRoles.Admin)
{
    <li class="nav-item">
        <a class="nav-link text-dark" asp-controller="CDP" asp-action="DevDashboard">
            <i class="bi bi-speedometer2 me-1"></i>Dev Dashboard
        </a>
    </li>
}
```

Insert this block immediately after the `</li>` closing tag of the CDP nav item (the one with `asp-action="Index"` pointing to CDP/Index).

The `UserRoles` class is in `HcPortal.Models` which is already `@using`'d in `_Layout.cshtml` (line 2 shows `@using HcPortal.Models`). Use `UserRoles.Coach` etc. directly.
  </action>
  <verify>
1. `dotnet build` exits 0.
2. `grep -n "DevDashboard" Views/Shared/_Layout.cshtml` shows the new nav link.
3. In the running app, the "Dev Dashboard" nav link appears when logged in as Coach/HC/Admin and does NOT appear when logged in as Coachee.
  </verify>
  <done>
_Layout.cshtml has a "Dev Dashboard" nav link after the CDP nav item. Link is conditional on role (Coach, SrSupervisor, SectionHead, HC, Admin). Build succeeds. Coachee users do not see the link.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete development dashboard</name>
  <what-built>
    Complete Development Dashboard (Phase 7):
    - DevDashboardViewModel + CoacheeProgressRow (Plan 01)
    - CDPController.DevDashboard GET action with role-scoped queries (Plan 01)
    - DevDashboard.cshtml with summary cards, per-coachee table, line chart, doughnut chart (Plan 02)
    - _Layout.cshtml nav link visible to Coach/SrSpv/SectionHead/HC/Admin (Plan 02)
  </what-built>
  <how-to-verify>
1. Start the app (`dotnet run` or F5)
2. Log in as a Coach role user — verify the "Dev Dashboard" link appears in the top nav
3. Click "Dev Dashboard" — verify the page loads with the scope label "Unit: [unit name]"
4. Verify summary cards show (TotalCoachees, Approved/Total Deliverables, Pending Spv Approval, Pending HC Review, Completed Track)
5. Verify the per-coachee table lists coachees with progress bars, deliverable counts, and status badges
6. If there are ProtonFinalAssessment records: verify the trend line chart renders; if not, verify the "No Proton final assessments completed yet" alert-info appears
7. If there are any ProtonDeliverableProgress records: verify the doughnut chart renders; if not, verify the "No deliverable data yet" alert-info appears
8. Log in as an HC/Admin user — verify ScopeLabel shows "All Sections" and all coachees are visible
9. Log in as a Coachee role user — verify navigating to /CDP/DevDashboard returns a 403 Forbidden page
10. Verify the "Dev Dashboard" nav link does NOT appear when logged in as Coachee
  </how-to-verify>
  <resume-signal>Type "approved" if the dashboard works correctly, or describe any issues found.</resume-signal>
  <action>Human verification of the complete dashboard feature.</action>
  <verify>All steps in how-to-verify pass.</verify>
  <done>Dashboard approved by user — Phase 7 complete.</done>
</task>

</tasks>

<verification>
- `dotnet build` succeeds with 0 errors
- `/CDP/DevDashboard` renders for Coach, SrSpv, SectionHead, HC, Admin
- `/CDP/DevDashboard` returns 403 for Coachee role
- Summary cards, per-coachee table, and charts (or empty-state alerts) all render
- Nav link visible to allowed roles, hidden for Coachee
- Existing `CDPController.Dashboard` action and `Views/CDP/Dashboard.cshtml` are unchanged
</verification>

<success_criteria>
All 4 requirements satisfied:
- DASH-01: Access guarded — Coachee returns 403, all other roles (Coach, SrSpv, SectionHead, HC, Admin) get 200
- DASH-02: Role scoping correct — Coach sees unit, SrSpv/SectionHead see section, HC/Admin see all
- DASH-03: Table shows deliverable progress, pending approvals, and competency status per coachee
- DASH-04: Chart.js line chart shows competency level trend from ProtonFinalAssessment data; empty-state guard in place
</success_criteria>

<output>
After completion, create `.planning/phases/07-development-dashboard/07-02-SUMMARY.md` following the summary template.
</output>
