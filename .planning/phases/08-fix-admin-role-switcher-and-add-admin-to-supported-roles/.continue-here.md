---
phase: 08-fix-admin-role-switcher-and-add-admin-to-supported-roles
task: 0
total_tasks: TBD
status: in_progress
last_updated: 2026-02-18T03:36:02.349Z
---

<current_state>
Phase 8 planning is in progress. Research has just completed — RESEARCH.md is written.
The planner has NOT been spawned yet. We paused immediately after research returned.
Next step is to spawn gsd-planner with the research output.
</current_state>

<completed_work>

- Phase 8 added to ROADMAP.md via /gsd:add-phase
- Phase directory created: .planning/phases/08-fix-admin-role-switcher-and-add-admin-to-supported-roles/
- STATE.md updated with "Roadmap Evolution" section noting Phase 8 addition
- RESEARCH.md written: 08-RESEARCH.md — full deep analysis of the broken role-switcher

</completed_work>

<remaining_work>

- Spawn gsd-planner (run /gsd:plan-phase 8 to resume from planning step)
- gsd-plan-checker verification
- Execute Phase 8 once plans are approved

</remaining_work>

<decisions_made>

- Phase 8 description: "Fix admin role switcher and add Admin to supported roles"
- No CONTEXT.md created (no /gsd:discuss-phase was run) — planner has full discretion

</decisions_made>

<blockers>

None.

</blockers>

<context>
## What the feature is

The Admin user has a role-switcher UI (in _Layout.cshtml) that lets them temporarily view the app as a different role (HC, Atasan, Coach, Coachee). The switcher persists the selected view via `ApplicationUser.SelectedView` (a DB column), not a session cookie.

## What's broken (from RESEARCH.md)

1. **"Admin" is missing from the allowed roles list** — `AccountController.SwitchView` has `allowedViews = new[] { "HC", "Atasan", "Coach", "Coachee" }`. Adding "Admin" is a one-line change + dropdown item in _Layout.cshtml.

2. **Nine CDPController actions are completely broken for Admin simulation:**
   - `HCApprovals`, `HCReviewDeliverable`, `CreateFinalAssessment` (GET+POST) block Admin via `userRole != UserRoles.HC`
   - `ApproveDeliverable` and `RejectDeliverable` block Admin via supervisor role check
   - `Deliverable` fails because `isHC = userRole == UserRoles.HC` never includes Admin

3. **Admin's Section/Unit are null** — seeded Admin user has no Section or Unit. When Admin switches to "Atasan" or "Coach" view, section-scoped queries (coaching coachee list, ProtonMain) return empty results. Fix: fall back to all-access (HC-like) for null-section cases.

4. **`User.IsInRole()` and `[Authorize(Roles)]` are NOT broken** — These work correctly and should not be changed.

## Fix strategy (from research)

Three categories of fixes:
1. Add "Admin" to switcher allowed list + dropdown UI (trivial)
2. Update all blocking role checks to include Admin alongside HC/supervisor equivalents
3. Add null-section fallback for Admin in scoped queries

All fixes are targeted changes in AccountController.cs, CDPController.cs, and _Layout.cshtml.
No schema changes needed.
</context>

<next_action>
Resume /gsd:plan-phase 8 — the workflow will detect that RESEARCH.md already exists and skip research, going straight to spawning gsd-planner. The planner has all the context it needs from 08-RESEARCH.md.
</next_action>
