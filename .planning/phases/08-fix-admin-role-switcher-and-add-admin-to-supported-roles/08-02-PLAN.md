---
phase: 08-fix-admin-role-switcher-and-add-admin-to-supported-roles
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Controllers/CDPController.cs
autonomous: false

must_haves:
  truths:
    - "Admin in 'HC' view can access HCApprovals, HCReviewDeliverable, and CreateFinalAssessment"
    - "Admin in 'Atasan' view can approve and reject deliverables"
    - "Admin in 'HC' view sees the isHC flag as true in Deliverable page (canHCReview works)"
    - "Admin in 'Coach' view with null Section sees all coachees (not empty list)"
    - "Admin in 'Coachee' view is blocked from POST CreateSession"
    - "ProtonMain shows all coachees when Admin is in HC or has null Section"
  artifacts:
    - path: "Controllers/CDPController.cs"
      provides: "All role-simulation gate fixes for Admin SelectedView"
      contains: "SelectedView == \"HC\""
  key_links:
    - from: "CDPController.HCApprovals"
      to: "Admin access check"
      via: "isHCAccess bool combining HC role and Admin+SelectedView"
      pattern: "isHCAccess"
    - from: "CDPController.ApproveDeliverable"
      to: "Admin access check"
      via: "isAtasanAccess bool combining SrSupervisor/SectionHead role and Admin+SelectedView"
      pattern: "isAtasanAccess"
    - from: "CDPController.Coaching"
      to: "coachee list query"
      via: "null Section fallback to all coachees for Admin"
      pattern: "string.IsNullOrEmpty.*Section"
---

<objective>
Fix all CDPController actions that use hardcoded role checks instead of consulting SelectedView, so Admin-simulated views actually work.

Purpose: The switcher (plan 01) enables Admin to select a view, but without these fixes the underlying controller actions still check the real role (UserRoles.HC, UserRoles.SrSupervisor, etc.) and forbid or silently fall back to wrong behavior. These fixes make each simulated view fully functional for the Admin.
Output: Modified CDPController.cs where every gate that was broken for Admin now correctly includes Admin+SelectedView logic.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/08-fix-admin-role-switcher-and-add-admin-to-supported-roles/08-RESEARCH.md
@Controllers/CDPController.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix HC-gated actions and Deliverable isHC/canHCReview</name>
  <files>Controllers/CDPController.cs</files>
  <action>
    Apply the following targeted fixes to `Controllers/CDPController.cs`. Read the file first to confirm line numbers match before editing.

    **Fix A — HCApprovals GET (line ~1043):**
    Replace:
    ```csharp
    // Only HC can access
    if (userRole != UserRoles.HC) return Forbid();
    ```
    With:
    ```csharp
    // HC or Admin simulating HC view can access
    bool isHCAccess = userRole == UserRoles.HC ||
                      (userRole == UserRoles.Admin && user.SelectedView == "HC");
    if (!isHCAccess) return Forbid();
    ```

    **Fix B — HCReviewDeliverable POST (line ~1011):**
    Replace:
    ```csharp
    // Only HC can review
    if (userRole != UserRoles.HC) return Forbid();
    ```
    With:
    ```csharp
    // HC or Admin simulating HC view can review
    bool isHCAccess = userRole == UserRoles.HC ||
                      (userRole == UserRoles.Admin && user.SelectedView == "HC");
    if (!isHCAccess) return Forbid();
    ```

    **Fix C — CreateFinalAssessment GET (line ~1137):**
    Replace:
    ```csharp
    // Only HC can access
    if (userRole != UserRoles.HC) return Forbid();
    ```
    With:
    ```csharp
    // HC or Admin simulating HC view can access
    bool isHCAccess = userRole == UserRoles.HC ||
                      (userRole == UserRoles.Admin && user.SelectedView == "HC");
    if (!isHCAccess) return Forbid();
    ```

    **Fix D — CreateFinalAssessment POST (line ~1199):**
    Replace:
    ```csharp
    // Only HC can create
    if (userRole != UserRoles.HC) return Forbid();
    ```
    With:
    ```csharp
    // HC or Admin simulating HC view can create
    bool isHCAccess = userRole == UserRoles.HC ||
                      (userRole == UserRoles.Admin && user.SelectedView == "HC");
    if (!isHCAccess) return Forbid();
    ```

    **Fix E — Deliverable GET isHC and canHCReview (lines ~731, ~799):**
    Replace:
    ```csharp
    bool isHC = userRole == UserRoles.HC;
    ```
    With:
    ```csharp
    bool isHC = userRole == UserRoles.HC ||
                (userRole == UserRoles.Admin && user?.SelectedView == "HC");
    ```

    Then replace:
    ```csharp
    bool canHCReview = userRole == UserRoles.HC && progress.HCApprovalStatus == "Pending";
    ```
    With:
    ```csharp
    bool canHCReview = isHC && progress.HCApprovalStatus == "Pending";
    ```
    (This reuses the now-fixed isHC variable rather than repeating the role check.)
  </action>
  <verify>`dotnet build` succeeds with 0 errors after applying all five fixes.</verify>
  <done>HCApprovals, HCReviewDeliverable, CreateFinalAssessment (GET+POST), and Deliverable isHC/canHCReview all accept Admin+SelectedView=="HC". Build succeeds.</done>
</task>

<task type="auto">
  <name>Task 2: Fix Approve/Reject gates, null-Section coachee lists, and CreateSession Coachee gate</name>
  <files>Controllers/CDPController.cs</files>
  <action>
    Apply the following targeted fixes to `Controllers/CDPController.cs`. Read the file first to confirm line numbers before editing.

    **Fix F — ApproveDeliverable POST (line ~829):**
    Replace:
    ```csharp
    // Only SrSupervisor or SectionHead can approve
    if (userRole != UserRoles.SrSupervisor && userRole != UserRoles.SectionHead)
    {
        return Forbid();
    }
    ```
    With:
    ```csharp
    // SrSupervisor, SectionHead, or Admin simulating Atasan/HC view can approve
    bool isAtasanAccess = userRole == UserRoles.SrSupervisor ||
                          userRole == UserRoles.SectionHead ||
                          (userRole == UserRoles.Admin &&
                           (user.SelectedView == "Atasan" || user.SelectedView == "HC"));
    if (!isAtasanAccess) return Forbid();
    ```

    Also, ApproveDeliverable has a section check after the role gate:
    ```csharp
    if (coacheeUser == null || coacheeUser.Section != user.Section)
    {
        return Forbid();
    }
    ```
    Change it to skip the section check when Admin (Admin has null Section and should be able to approve cross-section):
    ```csharp
    if (userRole != UserRoles.Admin &&
        (coacheeUser == null || coacheeUser.Section != user.Section))
    {
        return Forbid();
    }
    ```

    **Fix G — RejectDeliverable POST (line ~921):**
    Replace:
    ```csharp
    // Only SrSupervisor or SectionHead can reject
    if (userRole != UserRoles.SrSupervisor && userRole != UserRoles.SectionHead)
    {
        return Forbid();
    }
    ```
    With:
    ```csharp
    // SrSupervisor, SectionHead, or Admin simulating Atasan/HC view can reject
    bool isAtasanAccess = userRole == UserRoles.SrSupervisor ||
                          userRole == UserRoles.SectionHead ||
                          (userRole == UserRoles.Admin &&
                           (user.SelectedView == "Atasan" || user.SelectedView == "HC"));
    if (!isAtasanAccess) return Forbid();
    ```

    Similarly fix RejectDeliverable's section check:
    ```csharp
    if (coacheeUser == null || coacheeUser.Section != user.Section)
    {
        return Forbid();
    }
    ```
    Change to:
    ```csharp
    if (userRole != UserRoles.Admin &&
        (coacheeUser == null || coacheeUser.Section != user.Section))
    {
        return Forbid();
    }
    ```

    **Fix H — ProtonMain GET null-Section coachee list (line ~608-611):**
    The current query:
    ```csharp
    var coachees = await _context.Users
        .Where(u => u.Section == user.Section && u.RoleLevel == 6)
        .OrderBy(u => u.FullName)
        .ToListAsync();
    ```
    Replace with:
    ```csharp
    var coachees = await _context.Users
        .Where(u => (string.IsNullOrEmpty(user.Section) || u.Section == user.Section)
                    && u.RoleLevel == 6)
        .OrderBy(u => u.FullName)
        .ToListAsync();
    ```
    When Admin has null Section, this returns all coachees. For regular users with a Section value, behavior is unchanged.

    **Fix I — Coaching GET null-Section coachee list for Admin (lines ~470-481):**
    The Admin branch currently uses:
    ```csharp
    else if (userRole == UserRoles.Admin && user.SelectedView != "Coachee")
    {
        isCoach = true;
        coacheeList = await _context.Users
            .Where(u => u.Section == user.Section && u.RoleLevel == 6)
            .OrderBy(u => u.FullName)
            .ToListAsync();
    }
    ```
    Replace the query inside to use the null-safe pattern:
    ```csharp
    else if (userRole == UserRoles.Admin && user.SelectedView != "Coachee")
    {
        isCoach = true;
        coacheeList = await _context.Users
            .Where(u => (string.IsNullOrEmpty(user.Section) || u.Section == user.Section)
                        && u.RoleLevel == 6)
            .OrderBy(u => u.FullName)
            .ToListAsync();
    }
    ```

    **Fix J — CreateSession POST Coachee gate (line ~525):**
    Replace:
    ```csharp
    // Only coaching roles can create sessions
    if (user.RoleLevel > 5)
    {
        return Forbid();
    }
    ```
    With:
    ```csharp
    // Only coaching roles can create sessions — block Coachee role and Admin in Coachee view
    var rolesForCreate = await _userManager.GetRolesAsync(user);
    var userRoleForCreate = rolesForCreate.FirstOrDefault();
    bool isCoacheeView = userRoleForCreate == UserRoles.Coachee ||
                         (userRoleForCreate == UserRoles.Admin && user.SelectedView == "Coachee");
    if (isCoacheeView)
    {
        return Forbid();
    }
    ```
    Note: the existing code at line ~525 reads `user` but does not yet have `userRole` in scope (that variable is declared in the GET action, not this POST). Use a fresh `GetRolesAsync` call with a local variable name `userRoleForCreate` to avoid name conflicts. Check the surrounding code context before applying to confirm whether `userRole` is already in scope at that point — if it is, reuse it instead of declaring `userRoleForCreate`.
  </action>
  <verify>`dotnet build` succeeds with 0 errors after all fixes applied.</verify>
  <done>ApproveDeliverable and RejectDeliverable accept Admin in Atasan/HC view and skip section check for Admin. ProtonMain and Coaching coachee lists return all coachees when Admin has null Section. CreateSession blocks Admin in Coachee view. Build succeeds with 0 errors.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify Admin role-switcher works end-to-end</name>
  <files>Controllers/AccountController.cs, Views/Shared/_Layout.cshtml, Controllers/CDPController.cs</files>
  <action>
This is a human verification checkpoint. All implementation was completed in Tasks 1 and 2 (and Plan 01 Tasks 1 and 2). This task confirms the end-to-end Admin role-switcher workflow functions correctly via manual testing.
  </action>
  <verify>Run the app and perform the 6 steps in how-to-verify below. All steps must pass.</verify>
  <done>All 6 verification steps pass: Admin View appears in dropdown, HC view actions load without 403, Atasan view shows approve/reject buttons, Coach view shows coachee list, Admin View checkmark appears, Coachee view blocks CreateSession POST.</done>
  <what-built>
    Complete Admin role-switcher fixes across all controller actions:
    - Plan 01: AccountController allows "Admin" in allowedViews; _Layout dropdown has Admin View option; SeedData defaults Admin to SelectedView="Admin"
    - Plan 02 Task 1: HCApprovals, HCReviewDeliverable, CreateFinalAssessment (GET+POST), Deliverable isHC/canHCReview all work for Admin in HC view
    - Plan 02 Task 2: ApproveDeliverable/RejectDeliverable work for Admin in Atasan/HC view; ProtonMain and Coaching show all coachees for null-section Admin; CreateSession blocks Admin in Coachee view
  </what-built>
  <how-to-verify>
    Run the app with `dotnet run` and log in as Admin (password: 123456).

    1. **Admin View dropdown**: Open the role-switcher dropdown — confirm "Admin View" appears with a shield icon and a divider above it.

    2. **Switch to HC View**: Click "HC View". Navigate to /CDP/HCApprovals — confirm page loads (not 403). Navigate to /CDP/DevDashboard — confirm all-sections data.

    3. **Switch to Atasan View**: Click "Atasan View". Navigate to any submitted deliverable — confirm the Approve and Reject buttons are visible (canApprove = true).

    4. **Switch to Coach View**: Click "Coach View". Navigate to /CDP/Coaching — confirm the coachee dropdown is populated (all coachees, not empty).

    5. **Switch to Admin View**: Click "Admin View". Confirm checkmark appears next to "Admin View". Confirm /CDP/DevDashboard still shows all-sections data.

    6. **Coachee view gate**: Switch to "Coachee View". Try to POST create a coaching session — confirm 403 Forbidden (or redirect to AccessDenied).
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe which step failed and what was observed.</resume-signal>
</task>

</tasks>

<verification>
`dotnet build` exits 0 with 0 errors.
CDPController.cs contains `isHCAccess` variable in HCApprovals, HCReviewDeliverable, and CreateFinalAssessment.
CDPController.cs contains `isAtasanAccess` variable in ApproveDeliverable and RejectDeliverable.
CDPController.cs contains `string.IsNullOrEmpty(user.Section)` in ProtonMain and Coaching coachee list queries.
CDPController.cs CreateSession contains an `isCoacheeView` or equivalent Admin-aware check.
</verification>

<success_criteria>
- `dotnet build` exits 0 with 0 errors
- Admin in HC view: HCApprovals, HCReviewDeliverable, CreateFinalAssessment all return 200 (not 403)
- Admin in Atasan view: ApproveDeliverable and RejectDeliverable accept the request (not 403)
- Admin in Coach/Atasan view with null Section: coachee lists are populated with all coachees
- Admin in Coachee view: CreateSession POST returns 403
- Admin in Admin view: DevDashboard shows all-sections data
- Human verification approved
</success_criteria>

<output>
After completion, create `.planning/phases/08-fix-admin-role-switcher-and-add-admin-to-supported-roles/08-02-SUMMARY.md`
</output>
