---
phase: 10-unified-training-records
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Models/UnifiedTrainingRecord.cs
  - Models/WorkerTrainingStatus.cs
  - Controllers/CMPController.cs
autonomous: true

must_haves:
  truths:
    - "GetUnifiedRecords() returns a combined, date-sorted list containing both completed AssessmentSessions and TrainingRecords for a given userId"
    - "Assessment rows have RecordType='Assessment Online', Score, IsPassed, Status='Passed'/'Failed' derived from IsPassed"
    - "Training Manual rows have RecordType='Training Manual', Penyelenggara, CertificateType, ValidUntil, Status as-is"
    - "SortPriority=0 for assessments, =1 for trainings; tie-break ordering works correctly"
    - "IsExpired computed property returns true only when ValidUntil is past DateTime.Now (no lookahead)"
    - "WorkerTrainingStatus has CompletedAssessments and CompletedTrainings integer fields and CompletionDisplayText computed property"
    - "GetWorkersInSection() batch-queries passed assessments per user using a single GroupBy query, not per-user queries"
    - "Admin in all SelectedView states routes to RecordsWorkerList; only Coach/Coachee routes to personal Records view"
    - "Completion count for assessments uses IsPassed==true only; for trainings uses Status=='Passed' or 'Valid' only (not 'Permanent')"
  artifacts:
    - path: "Models/UnifiedTrainingRecord.cs"
      provides: "Flat ViewModel bridging AssessmentSession and TrainingRecord for unified table rendering"
      exports: ["UnifiedTrainingRecord"]
    - path: "Models/WorkerTrainingStatus.cs"
      provides: "Extended WorkerTrainingStatus with CompletedAssessments, CompletedTrainings, CompletionDisplayText"
    - path: "Controllers/CMPController.cs"
      provides: "GetUnifiedRecords() helper, updated Records() role branch, updated GetWorkersInSection() with batch assessment query, updated WorkerDetail() action"
  key_links:
    - from: "Controllers/CMPController.cs Records()"
      to: "Models/UnifiedTrainingRecord.cs"
      via: "GetUnifiedRecords() return type"
      pattern: "List<UnifiedTrainingRecord>"
    - from: "Controllers/CMPController.cs GetWorkersInSection()"
      to: "_context.AssessmentSessions"
      via: "batch GroupBy query for passed assessments"
      pattern: "IsPassed == true.*GroupBy"
    - from: "Controllers/CMPController.cs"
      to: "Records/WorkerDetail views"
      via: "return View(\"Records\", unified) and return View(\"WorkerDetail\", unified)"
      pattern: "return View.*unified"
---

<objective>
Create the UnifiedTrainingRecord ViewModel, extend WorkerTrainingStatus, and rewrite the data layer in CMPController to merge AssessmentSessions and TrainingRecords into a single ordered list.

Purpose: Plans 01 and 02 are split cleanly — 01 owns the C# data layer (models + controller), 02 owns the Razor views. The views cannot be written until the ViewModel type and controller methods exist.

Output: `Models/UnifiedTrainingRecord.cs` (new), `Models/WorkerTrainingStatus.cs` (extended), `Controllers/CMPController.cs` (role branch + helpers rewritten).
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-unified-training-records/10-CONTEXT.md
@.planning/phases/10-unified-training-records/10-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UnifiedTrainingRecord ViewModel</name>
  <files>Models/UnifiedTrainingRecord.cs</files>
  <action>
    Create new file `Models/UnifiedTrainingRecord.cs` in namespace `HcPortal.Models`.

    Fields (all must be present):
    - `DateTime Date` — the sorting anchor; for assessments use `CompletedAt ?? Schedule`, for trainings use `Tanggal`
    - `string RecordType` = "" — "Assessment Online" or "Training Manual" (these exact strings, used by view for badge rendering)
    - `string Title` = "" — assessment Title or training Judul
    - `int? Score` — nullable; set for assessments only, null for trainings
    - `bool? IsPassed` — nullable; set for assessments only, null for trainings
    - `string? Penyelenggara` — null for assessments
    - `string? CertificateType` — null for assessments
    - `DateTime? ValidUntil` — null for assessments
    - `string? Status` — for assessments: "Passed" if IsPassed==true else "Failed" (NOT the literal "Completed" from AssessmentSession.Status); for trainings: value as-is from TrainingRecord.Status
    - `int SortPriority` — 0 for Assessment Online, 1 for Training Manual (used in ThenBy for same-date tie-break)
    - `bool IsExpired` computed property — `ValidUntil.HasValue && ValidUntil.Value < DateTime.Now` (no lookahead window; returns false if ValidUntil is null)

    No constructor needed — use object initializer pattern throughout.
  </action>
  <verify>Project builds without errors: `dotnet build`</verify>
  <done>
    `Models/UnifiedTrainingRecord.cs` exists in namespace `HcPortal.Models`.
    All 10 fields + IsExpired computed property present.
    Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend WorkerTrainingStatus and rewrite CMPController data layer</name>
  <files>Models/WorkerTrainingStatus.cs, Controllers/CMPController.cs</files>
  <action>
    **Step A — Extend `Models/WorkerTrainingStatus.cs`:**

    Add three new members to the class (keep all existing fields — do not remove TotalTrainings, CompletedTrainings, etc.):
    ```csharp
    public int CompletedAssessments { get; set; }
    public int CompletedTrainings { get; set; }
    public string CompletionDisplayText =>
        $"{CompletedAssessments + CompletedTrainings} completed " +
        $"({CompletedAssessments} assessments + {CompletedTrainings} trainings)";
    ```

    **Step B — Add `GetUnifiedRecords()` private helper to `Controllers/CMPController.cs`:**

    Add after the existing `GetPersonalTrainingRecords()` method (around line 710). The new helper replaces the role of `GetPersonalTrainingRecords()` for the Records and WorkerDetail actions:

    ```csharp
    private async Task<List<UnifiedTrainingRecord>> GetUnifiedRecords(string userId)
    {
        var assessments = await _context.AssessmentSessions
            .Where(a => a.UserId == userId && a.Status == "Completed")
            .ToListAsync();

        var trainings = await _context.TrainingRecords
            .Where(t => t.UserId == userId)
            .ToListAsync();

        var unified = new List<UnifiedTrainingRecord>();

        unified.AddRange(assessments.Select(a => new UnifiedTrainingRecord
        {
            Date = a.CompletedAt ?? a.Schedule,
            RecordType = "Assessment Online",
            Title = a.Title,
            Score = a.Score,
            IsPassed = a.IsPassed,
            Status = a.IsPassed == true ? "Passed" : "Failed",
            SortPriority = 0
        }));

        unified.AddRange(trainings.Select(t => new UnifiedTrainingRecord
        {
            Date = t.Tanggal,
            RecordType = "Training Manual",
            Title = t.Judul ?? "",
            Penyelenggara = t.Penyelenggara,
            CertificateType = t.CertificateType,
            ValidUntil = t.ValidUntil,
            Status = t.Status,
            SortPriority = 1
        }));

        return unified
            .OrderByDescending(r => r.Date)
            .ThenBy(r => r.SortPriority)
            .ToList();
    }
    ```

    **Step C — Rewrite the role branch in `Records()` action (lines ~643-659):**

    Replace the existing Admin + IsCoachingRole branches with the new logic. Admin always routes to worker list. Only literal Coach and Coachee roles see personal records:

    ```csharp
    // Role: Coach/Coachee - personal unified records
    bool isCoacheeView = userRole == UserRoles.Coach || userRole == UserRoles.Coachee;
    if (isCoacheeView)
    {
        var unified = await GetUnifiedRecords(user!.Id);
        return View("Records", unified);
    }
    // HC, Admin (all SelectedView values), Management, Supervisor -> worker list
    ```

    Remove the old Admin SelectedView block (lines ~643-653) and the old `GetPersonalTrainingRecords` call for IsCoachingRole.

    **Step D — Update `WorkerDetail()` action (line ~694):**

    Replace `GetPersonalTrainingRecords(workerId)` with `GetUnifiedRecords(workerId)` and update the View call:
    ```csharp
    var unified = await GetUnifiedRecords(workerId);
    return View("WorkerDetail", unified);
    ```
    The `@model` in the view will be updated in Plan 02.

    **Step E — Extend `GetWorkersInSection()` with batch assessment query:**

    After `var users = await usersQuery.ToListAsync();` (around line 735), add:
    ```csharp
    // Batch query: passed assessments per user (avoids N+1)
    var userIds = users.Select(u => u.Id).ToList();
    var passedAssessmentsByUser = await _context.AssessmentSessions
        .Where(a => userIds.Contains(a.UserId) && a.IsPassed == true)
        .GroupBy(a => a.UserId)
        .Select(g => new { UserId = g.Key, Count = g.Count() })
        .ToListAsync();
    var passedAssessmentLookup = passedAssessmentsByUser
        .ToDictionary(x => x.UserId, x => x.Count);
    ```

    Inside the `foreach (var user in users)` loop, update the statistics block:
    - Add: `int completedAssessments = passedAssessmentLookup.TryGetValue(user.Id, out var aCount) ? aCount : 0;`
    - Change `completedTrainings` to count only `Status == "Passed" || Status == "Valid"` — remove "Permanent" from the count (it was incorrect per research anti-patterns)
    - Set on the WorkerTrainingStatus object: `CompletedAssessments = completedAssessments`, `CompletedTrainings = completedTrainings`

    The existing `CompletedTrainings`, `TotalTrainings`, etc. fields on WorkerTrainingStatus remain — only adding the two new fields and removing "Permanent" from the status count.

    Keep all existing filter logic (section, search, statusFilter, category) — only the statistics calculation changes.
  </action>
  <verify>`dotnet build` passes with no errors or warnings about the changed methods.</verify>
  <done>
    `WorkerTrainingStatus.cs` has `CompletedAssessments`, `CompletedTrainings`, `CompletionDisplayText`.
    `CMPController.cs` has `GetUnifiedRecords()` returning `List&lt;UnifiedTrainingRecord&gt;`.
    `Records()` action: Coach/Coachee → `View("Records", unified)`; all others → `View("RecordsWorkerList", workers)`.
    `WorkerDetail()` action: calls `GetUnifiedRecords(workerId)` and passes result to view.
    `GetWorkersInSection()` has batch assessment lookup before the foreach loop.
    Build passes.
  </done>
</task>

</tasks>

<verification>
Run `dotnet build` — zero errors.
Confirm `Models/UnifiedTrainingRecord.cs` exists.
Confirm `Records()` action in CMPController no longer references `GetPersonalTrainingRecords`.
Confirm `GetUnifiedRecords()` private method exists in CMPController.
Confirm `passedAssessmentLookup` variable exists in `GetWorkersInSection()`.
</verification>

<success_criteria>
- `Models/UnifiedTrainingRecord.cs` created with all specified fields and IsExpired computed property
- `Models/WorkerTrainingStatus.cs` has CompletedAssessments, CompletedTrainings, CompletionDisplayText
- `GetUnifiedRecords()` exists in CMPController, returns merged+sorted list in memory after two separate DB queries
- `Records()` action: only Coach/Coachee roles get personal records; Admin gets worker list regardless of SelectedView
- `WorkerDetail()` action uses GetUnifiedRecords()
- `GetWorkersInSection()` has single batch assessment query using GroupBy before the foreach
- `dotnet build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/10-unified-training-records/10-01-SUMMARY.md`
</output>
