---
phase: 10-unified-training-records
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - Views/CMP/Records.cshtml
  - Views/CMP/RecordsWorkerList.cshtml
  - Views/CMP/WorkerDetail.cshtml
autonomous: true

must_haves:
  truths:
    - "A worker visiting /CMP/Records sees one table with both completed assessments and manual training records, sorted most-recent-first"
    - "Each row has a colored type badge — blue pill ('Assessment Online') or green pill ('Training Manual')"
    - "All 9 columns are always present; non-applicable cells display an em dash (—) not a blank"
    - "Assessment Online rows show Score and Pass/Fail values; Training Manual rows show Penyelenggara, Tipe Sertifikat, and Berlaku Sampai"
    - "Training Manual rows with ValidUntil in the past show an 'Expired' danger badge in the Berlaku Sampai cell"
    - "Worker with no records at all sees the text 'Belum ada riwayat pelatihan' (no call to action)"
    - "HC visiting /CMP/Records sees the worker list with a completion count column showing 'N completed (X assessments + Y trainings)'"
    - "WorkerDetail view stat cards show: Total Records (all unified rows), Completed (IsPassed==true assessments + Passed/Valid trainings), Pending (Wait Certificate trainings only)"
    - "Records.cshtml keeps search-by-title and year client-side filters; tab nav (PROTON/OTS/OJT/IHT/Mandatory) is removed"
  artifacts:
    - path: "Views/CMP/Records.cshtml"
      provides: "Unified single-table view for Coach/Coachee using @model List<UnifiedTrainingRecord>"
      contains: "UnifiedTrainingRecord"
    - path: "Views/CMP/RecordsWorkerList.cshtml"
      provides: "HC worker list with CompletionDisplayText replacing percentage-based Status column"
      contains: "CompletionDisplayText"
    - path: "Views/CMP/WorkerDetail.cshtml"
      provides: "Worker detail view using @model List<UnifiedTrainingRecord> with updated stat cards"
      contains: "UnifiedTrainingRecord"
  key_links:
    - from: "Views/CMP/Records.cshtml"
      to: "Models/UnifiedTrainingRecord.cs"
      via: "@model List<HcPortal.Models.UnifiedTrainingRecord> at top of file"
      pattern: "@model List<HcPortal.Models.UnifiedTrainingRecord>"
    - from: "Views/CMP/WorkerDetail.cshtml"
      to: "Models/UnifiedTrainingRecord.cs"
      via: "@model List<HcPortal.Models.UnifiedTrainingRecord> at top of file"
      pattern: "@model List<HcPortal.Models.UnifiedTrainingRecord>"
    - from: "Views/CMP/RecordsWorkerList.cshtml"
      to: "Models/WorkerTrainingStatus.cs"
      via: "worker.CompletionDisplayText in table cell"
      pattern: "CompletionDisplayText"
---

<objective>
Replace the three CMP views (Records, RecordsWorkerList, WorkerDetail) to use the unified data model introduced in Plan 01. Records.cshtml becomes a single merged table. RecordsWorkerList.cshtml shows the new completion count. WorkerDetail.cshtml updates stat cards and table columns.

Purpose: The view layer is entirely decoupled from Plan 01's data layer — it reads List&lt;UnifiedTrainingRecord&gt; and WorkerTrainingStatus.CompletionDisplayText, nothing more.

Output: Three updated Razor views.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-unified-training-records/10-CONTEXT.md
@.planning/phases/10-unified-training-records/10-RESEARCH.md
@.planning/phases/10-unified-training-records/10-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite Records.cshtml as unified single table</name>
  <files>Views/CMP/Records.cshtml</files>
  <action>
    Replace the entire file. The new view receives `@model List<HcPortal.Models.UnifiedTrainingRecord>`.

    **Top of file:**
    ```razor
    @model List<HcPortal.Models.UnifiedTrainingRecord>
    @{
        ViewData["Title"] = "Training Records";
        var totalRecords = Model.Count;
        var completedRecords = Model.Count(x =>
            (x.RecordType == "Assessment Online" && x.IsPassed == true) ||
            (x.RecordType == "Training Manual" && (x.Status == "Passed" || x.Status == "Valid")));
        var pendingRecords = Model.Count(x => x.Status == "Wait Certificate");
    }
    ```

    **Stat cards section (3 cards, drop "Expiring Soon" card):**
    - Card 1: "Total Records" — `totalRecords`
    - Card 2: "Selesai" (green, check-circle icon) — `completedRecords`
    - Card 3: "Pending" (warning, hourglass icon) — `pendingRecords`

    Remove the old 4-card row (had Total, Valid/Passed, Pending, Expiring Soon).

    **Filter bar (keep search + year, remove status filter dropdown and all tabs):**
    ```html
    <div class="card border-0 shadow-sm mb-3">
        <div class="card-body">
            <div class="row g-3 align-items-center">
                <div class="col-12 col-md-6">
                    <input type="text" id="searchInput" class="form-control" placeholder="Cari berdasarkan judul...">
                </div>
                <div class="col-12 col-md-3">
                    <select id="yearFilter" class="form-select">
                        <option value="">Semua Tahun</option>
                        @foreach (var year in Model.Select(r => r.Date.Year).Distinct().OrderByDescending(y => y))
                        {
                            <option value="@year">@year</option>
                        }
                    </select>
                </div>
                <div class="col-12 col-md-3">
                    <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                        <i class="bi bi-x-circle me-1"></i> Reset
                    </button>
                </div>
            </div>
        </div>
    </div>
    ```

    **Remove entirely:** The `<ul class="nav nav-pills ...">` tab navigation, the `<div class="tab-content">` with five tab panes, and the `void RenderTable()` local function block.

    **Add single unified table after the filter bar:**

    Table columns (always all visible — 9 columns):
    `Tanggal | Tipe | Nama/Judul | Score | Pass/Fail | Penyelenggara | Tipe Sertifikat | Berlaku Sampai | Status`

    Table header:
    ```html
    <table class="table table-hover mb-0 records-table" id="unifiedTable">
        <thead class="sticky-header">
            <tr>
                <th class="p-3">Tanggal</th>
                <th class="p-3">Tipe</th>
                <th class="p-3">Nama / Judul</th>
                <th class="p-3 text-center">Score</th>
                <th class="p-3 text-center">Pass/Fail</th>
                <th class="p-3">Penyelenggara</th>
                <th class="p-3">Tipe Sertifikat</th>
                <th class="p-3">Berlaku Sampai</th>
                <th class="p-3">Status</th>
            </tr>
        </thead>
    ```

    **Empty state** (when Model.Count == 0):
    ```html
    <tr>
        <td colspan="9" class="text-center p-5 text-muted">Belum ada riwayat pelatihan</td>
    </tr>
    ```
    No icon, no call to action — plain text only.

    **Row rendering** — add `data-title` and `data-year` attributes for client-side filter:
    ```razor
    @foreach (var item in Model)
    {
        <tr class="training-row" data-title="@item.Title.ToLower()" data-year="@item.Date.Year">
            <td class="p-3">@item.Date.ToString("dd MMM yyyy")</td>
            <td class="p-3">
                @if (item.RecordType == "Assessment Online")
                {
                    <span class="badge rounded-pill bg-primary">Assessment Online</span>
                }
                else
                {
                    <span class="badge rounded-pill bg-success">Training Manual</span>
                }
            </td>
            <td class="p-3"><span class="fw-semibold">@item.Title</span></td>
            <td class="p-3 text-center">
                @if (item.Score.HasValue) { <span>@item.Score</span> } else { <span class="text-muted">—</span> }
            </td>
            <td class="p-3 text-center">
                @if (item.IsPassed.HasValue)
                {
                    if (item.IsPassed == true)
                    { <span class="badge bg-success">Pass</span> }
                    else
                    { <span class="badge bg-danger">Fail</span> }
                }
                else { <span class="text-muted">—</span> }
            </td>
            <td class="p-3">@(item.Penyelenggara ?? "—")</td>
            <td class="p-3">@(item.CertificateType ?? "—")</td>
            <td class="p-3">
                @if (item.ValidUntil.HasValue)
                {
                    <div>@item.ValidUntil.Value.ToString("dd MMM yyyy")</div>
                    @if (item.IsExpired)
                    {
                        <span class="badge bg-danger mt-1"><i class="bi bi-x-circle me-1"></i>Expired</span>
                    }
                }
                else { <span class="text-muted">—</span> }
            </td>
            <td class="p-3">
                @{
                    var statusClass = item.Status switch {
                        "Passed" => "bg-success",
                        "Valid" => "bg-success",
                        "Failed" => "bg-danger",
                        "Wait Certificate" => "bg-warning text-dark",
                        _ => "bg-secondary"
                    };
                }
                @if (!string.IsNullOrEmpty(item.Status))
                {
                    <span class="badge @statusClass">@item.Status</span>
                }
                else { <span class="text-muted">—</span> }
            </td>
        </tr>
    }
    ```

    **Client-side filter script** — update `filterTable()` to match on `data-title` contains searchTerm AND `data-year` equals yearFilter:
    ```javascript
    function filterTable() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const yearFilter = document.getElementById('yearFilter').value;
        document.querySelectorAll('.training-row').forEach(row => {
            const title = row.getAttribute('data-title');
            const year = row.getAttribute('data-year');
            const matchSearch = !searchTerm || title.includes(searchTerm);
            const matchYear = !yearFilter || year === yearFilter;
            row.style.display = (matchSearch && matchYear) ? '' : 'none';
        });
    }
    document.getElementById('searchInput').addEventListener('input', filterTable);
    document.getElementById('yearFilter').addEventListener('change', filterTable);
    function clearFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('yearFilter').value = '';
        filterTable();
    }
    ```

    Remove all old certificate modal HTML, old download/view certificate JS functions, and the old `statusFilter` dropdown JS listener.

    Keep existing `<style>` block table hover styles; remove premium-tabs CSS that no longer applies.
  </action>
  <verify>
    `dotnet build` passes.
    Navigate to /CMP/Records as a Coachee role (or check that @model directive is `List&lt;HcPortal.Models.UnifiedTrainingRecord&gt;`).
    No references to `TrainingRecord` model remain in this file.
    No tab nav elements remain (`nav-pills`, `tab-pane`).
  </verify>
  <done>
    Records.cshtml `@model` is `List&lt;HcPortal.Models.UnifiedTrainingRecord&gt;`.
    Single table with 9 always-visible columns.
    Type badge: blue pill for Assessment Online, green pill for Training Manual.
    Em dash in non-applicable cells.
    Empty state is plain text "Belum ada riwayat pelatihan".
    Filter bar: search + year only (no tabs, no status filter).
    Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update RecordsWorkerList.cshtml and WorkerDetail.cshtml</name>
  <files>Views/CMP/RecordsWorkerList.cshtml, Views/CMP/WorkerDetail.cshtml</files>
  <action>
    **RecordsWorkerList.cshtml changes:**

    The `@model` stays `List<HcPortal.Models.WorkerTrainingStatus>` — no model change needed.

    Find the "Status" column in the workers table (currently showing SUDAH/BELUM badges based on `worker.CompletionPercentage`). Replace that cell with the new completion count display:

    Before (approximately lines 181-194):
    ```html
    <td class="p-3 text-center">
        @if (worker.CompletionPercentage == 100) { ... } else { ... }
    </td>
    ```

    After:
    ```html
    <td class="p-3">
        <small class="text-muted">@worker.CompletionDisplayText</small>
    </td>
    ```

    Update the column header from "Status" to "Completion":
    ```html
    <th class="p-3">Completion</th>
    ```

    Remove the old summary stat cards at the top that referenced `avgCompletionRate`, `totalExpiring`, `workersWithExpiring` — these are no longer meaningful (the model no longer drives a percentage). Keep the header section and filter form unchanged.

    Also update the `@{` code block at top to remove variables that reference `ExpiringSoonTrainings` and `HasExpiringCertificates` if present (those computed props still exist on the model, just not used in this view).

    **WorkerDetail.cshtml changes:**

    Change `@model` from `List<HcPortal.Models.TrainingRecord>` to `List<HcPortal.Models.UnifiedTrainingRecord>`.

    **Stat cards — replace the 4-card row with 3 cards:**
    - Card 1: "Total Records" — `@Model.Count`
    - Card 2: "Selesai" — `@Model.Count(x => (x.RecordType == "Assessment Online" && x.IsPassed == true) || (x.RecordType == "Training Manual" && (x.Status == "Passed" || x.Status == "Valid")))`
    - Card 3: "Pending" — `@Model.Count(x => x.Status == "Wait Certificate")`
    - Remove the 4th "Expiring Soon" card entirely

    **Filter section — remove** the "Filter by Category" and "Filter by Status" dropdowns. Keep only the search input (relabel to "Cari Judul"). Update `filterRecords()` JS to match on title only (remove category and status filter logic from the function).

    **Table — replace columns to match the unified schema:**

    Old columns: No | Nama Training | Kategori | Tanggal | Penyelenggara | Status | Valid Until | Certificate

    New columns: No | Tanggal | Tipe | Nama / Judul | Score | Pass/Fail | Penyelenggara | Tipe Sertifikat | Berlaku Sampai | Status

    Row rendering for the new table:
    ```razor
    @foreach (var item in Model.OrderByDescending(x => x.Date).ThenBy(x => x.SortPriority))
    {
        <tr class="training-row" data-title="@(item.Title.ToLower())">
            <td class="p-3 text-center">@rowNumber</td>
            <td class="p-3"><small>@item.Date.ToString("dd MMM yyyy")</small></td>
            <td class="p-3">
                @if (item.RecordType == "Assessment Online")
                { <span class="badge rounded-pill bg-primary">Assessment Online</span> }
                else
                { <span class="badge rounded-pill bg-success">Training Manual</span> }
            </td>
            <td class="p-3"><span class="fw-semibold">@item.Title</span></td>
            <td class="p-3 text-center">@(item.Score.HasValue ? item.Score.ToString() : "—")</td>
            <td class="p-3 text-center">
                @if (item.IsPassed.HasValue)
                {
                    if (item.IsPassed == true) { <span class="badge bg-success">Pass</span> }
                    else { <span class="badge bg-danger">Fail</span> }
                }
                else { <span class="text-muted">—</span> }
            </td>
            <td class="p-3"><small class="text-muted">@(item.Penyelenggara ?? "—")</small></td>
            <td class="p-3">@(item.CertificateType ?? "—")</td>
            <td class="p-3">
                @if (item.ValidUntil.HasValue)
                {
                    <div>@item.ValidUntil.Value.ToString("dd MMM yyyy")</div>
                    @if (item.IsExpired)
                    { <span class="badge bg-danger mt-1">Expired</span> }
                }
                else { <span class="text-muted">—</span> }
            </td>
            <td class="p-3">
                @{
                    var sc = item.Status switch {
                        "Passed" => "bg-success", "Valid" => "bg-success",
                        "Failed" => "bg-danger",
                        "Wait Certificate" => "bg-warning text-dark",
                        _ => "bg-secondary"
                    };
                }
                @if (!string.IsNullOrEmpty(item.Status))
                { <span class="badge @sc">@item.Status</span> }
                else { <span class="text-muted">—</span> }
            </td>
        </tr>
        rowNumber++;
    }
    ```

    Update `filterRecords()` in WorkerDetail.cshtml to match on `data-title` only (remove category/status filter JS — those dropdowns are removed). Remove the old `exportWorkerRecords()` CSV function references to old column indices (columns changed).

    Update `colspan` in the empty-state row to match the new column count (10 columns).

    Also update the `@{ int rowNumber = 1; }` counter to reset before the foreach.
  </action>
  <verify>
    `dotnet build` passes with no errors.
    RecordsWorkerList.cshtml: `@model` is still `WorkerTrainingStatus`, column header says "Completion", cell shows `CompletionDisplayText`.
    WorkerDetail.cshtml: `@model` is `List&lt;HcPortal.Models.UnifiedTrainingRecord&gt;`, no references to `TrainingRecord`, no "Expiring Soon" stat card.
  </verify>
  <done>
    RecordsWorkerList.cshtml completion column shows text like "5 completed (3 assessments + 2 trainings)" via `worker.CompletionDisplayText`.
    WorkerDetail.cshtml `@model` is `List&lt;HcPortal.Models.UnifiedTrainingRecord&gt;`.
    WorkerDetail stat cards: Total, Selesai, Pending (3 cards, no Expiring Soon).
    WorkerDetail table has 10 columns matching unified schema.
    WorkerDetail filter: title search only (no category/status dropdowns).
    Build passes.
  </done>
</task>

</tasks>

<verification>
`dotnet build` — zero errors.
Confirm `Views/CMP/Records.cshtml` line 1 is `@model List<HcPortal.Models.UnifiedTrainingRecord>`.
Confirm `Views/CMP/WorkerDetail.cshtml` line 1 is `@model List<HcPortal.Models.UnifiedTrainingRecord>`.
Confirm `Views/CMP/RecordsWorkerList.cshtml` contains `CompletionDisplayText`.
Confirm no file references `GetPersonalTrainingRecords` or `List<TrainingRecord>` in the three views.
Confirm Records.cshtml has no `nav-pills` or `tab-pane` elements.
</verification>

<success_criteria>
Phase goal fully achieved when:
1. TREC-01: Coach/Coachee visiting /CMP/Records sees one merged chronological table combining assessment and training records
2. TREC-02: Assessment Online rows show Score + Pass/Fail; Training Manual rows show Penyelenggara, Tipe Sertifikat, Berlaku Sampai; non-applicable cells show em dash
3. TREC-03: HC/Admin visiting /CMP/Records sees worker list with "N completed (X assessments + Y trainings)" per worker
4. Type badge distinguishes rows: blue pill for Assessment Online, green pill for Training Manual
5. Expired training certificates show danger badge; no "expiring soon" lookahead
6. Admin (any SelectedView) always sees worker list, never personal records
7. `dotnet build` passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/10-unified-training-records/10-02-SUMMARY.md`
</output>
