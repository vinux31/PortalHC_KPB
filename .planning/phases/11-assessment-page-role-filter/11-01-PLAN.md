---
phase: 11-assessment-page-role-filter
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Controllers/CMPController.cs
autonomous: true

must_haves:
  truths:
    - "Worker visiting Assessment page receives only Open and Upcoming assessments from the controller — no Completed rows in the model"
    - "HC or Admin visiting Assessment page receives two distinct data sets via ViewBag: ManagementData (all assessments) and MonitorData (Open+Upcoming only)"
    - "Admin in any SelectedView value always routes to the HC/Admin branch — never sees the worker-filtered view"
    - "Existing EditAssessment/DeleteAssessment redirects to view=manage still land correctly on the Assessment page"
  artifacts:
    - path: "Controllers/CMPController.cs"
      provides: "Assessment() action with role-gated status filter and dual ViewBag data sets"
      contains: "isHCAccess"
  key_links:
    - from: "Controllers/CMPController.cs Assessment()"
      to: "ViewBag.ManagementData"
      via: "HC/Admin branch populates ManagementData list"
      pattern: "ViewBag\\.ManagementData"
    - from: "Controllers/CMPController.cs Assessment()"
      to: "ViewBag.MonitorData"
      via: "HC/Admin branch populates MonitorData list"
      pattern: "ViewBag\\.MonitorData"
    - from: "Controllers/CMPController.cs Assessment()"
      to: "query.Where(a.Status)"
      via: "Worker branch filters to Open+Upcoming"
      pattern: 'Status == "Open" \|\| a\.Status == "Upcoming"'
---

<objective>
Rewrite CMPController.Assessment() to apply role-based data filtering: workers receive only Open and Upcoming assessments (Completed excluded at the query level), while HC and Admin receive two separate ViewBag data sets for Management (all assessments with pagination) and Monitoring (Open+Upcoming, flat list, no pagination).

Purpose: Workers should only see actionable assessments. Completed assessments now live in Training Records (/CMP/Records, shipped in Phase 10). HC/Admin need separate Management and Monitoring concerns served by distinct data sets so the view (Plan 02) can render two tabs.

Output: Modified CMPController.Assessment() action with isHCAccess gate, worker status filter, and dual ViewBag population for HC/Admin.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-assessment-page-role-filter/11-RESEARCH.md
@Controllers/CMPController.cs
@Models/UserRoles.cs
@Models/AssessmentSession.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add isHCAccess gate and worker status filter</name>
  <files>Controllers/CMPController.cs</files>
  <action>
In the Assessment() action (starts around line 75), apply these changes:

**Step A — Add isHCAccess bool after userRole is resolved (after line 86):**

```csharp
bool isHCAccess = userRole == UserRoles.Admin || userRole == UserRoles.HC;
```

Admin always gets management access regardless of SelectedView — this is consistent with the Phase 10 decision. Do NOT use `user.SelectedView == "HC"` branching.

**Step B — Replace the authorization check (lines 94-99):**

Change:
```csharp
if (view == "manage" && userRole != UserRoles.Admin && userRole != "HC")
```
To:
```csharp
if (view == "manage" && !isHCAccess)
```

This preserves the redirect behavior but uses the named bool pattern.

**Step C — Update the CanManage ViewBag (line 154):**

Change:
```csharp
ViewBag.CanManage = (userRole == UserRoles.Admin || userRole == "HC");
```
To:
```csharp
ViewBag.CanManage = isHCAccess;
```

Note: The existing code uses the string literal `"HC"` instead of `UserRoles.HC`. Both resolve to the same value, but use `UserRoles.HC` for consistency with the named constant pattern.

**Step D — Add status filter for workers in the personal view branch (after line 115):**

Inside the `else // view == "personal"` block, after `query = query.Where(a => a.UserId == userId);`, add:

```csharp
// Workers see only actionable assessments — Completed lives in Training Records (/CMP/Records)
query = query.Where(a => a.Status == "Open" || a.Status == "Upcoming");
```

This ensures Completed assessments are excluded at the DB query level for all non-HC/Admin users. The filter applies INSIDE the personal branch, so it only affects workers.
  </action>
  <verify>
Build the project: `dotnet build` — must compile with 0 errors.

Verify the filter exists: grep for `Status == "Open" || a.Status == "Upcoming"` in CMPController.cs — must appear in the worker branch.

Verify isHCAccess: grep for `bool isHCAccess = userRole == UserRoles.Admin || userRole == UserRoles.HC` in CMPController.cs.
  </verify>
  <done>
Worker branch of Assessment() applies .Where(Status == "Open" || Status == "Upcoming") after userId filter. Authorization gate and CanManage use isHCAccess named bool. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add dual ViewBag data sets for HC/Admin branch</name>
  <files>Controllers/CMPController.cs</files>
  <action>
In the Assessment() action, restructure the HC/Admin branch (`if (view == "manage")`) to populate two distinct ViewBag lists instead of returning a single model list.

**Step A — Replace the manage branch query logic (lines 107-111 area through to the return statement):**

The current flow applies search + pagination to a single query and returns `View(exams)`. For the HC/Admin branch, replace this with:

After the `if (view == "manage")` check, when isHCAccess is true, the action should:

1. Build the ManagementData query (all assessments, with search, with pagination):

```csharp
// Management tab: ALL assessments (CRUD operations)
var managementQuery = _context.AssessmentSessions
    .Include(a => a.User)
    .AsQueryable();

if (!string.IsNullOrEmpty(search))
{
    var lowerSearch = search.ToLower();
    managementQuery = managementQuery.Where(a =>
        a.Title.ToLower().Contains(lowerSearch) ||
        a.Category.ToLower().Contains(lowerSearch) ||
        (a.User != null && (
            a.User.FullName.ToLower().Contains(lowerSearch) ||
            (a.User.NIP != null && a.User.NIP.Contains(lowerSearch))
        ))
    );
}

ViewBag.SearchTerm = search;

var totalCount = await managementQuery.CountAsync();
var totalPages = (int)Math.Ceiling(totalCount / (double)pageSize);

var managementData = await managementQuery
    .OrderByDescending(a => a.Schedule)
    .Skip((page - 1) * pageSize)
    .Take(pageSize)
    .ToListAsync();

ViewBag.CurrentPage = page;
ViewBag.TotalPages = totalPages;
ViewBag.TotalCount = totalCount;
ViewBag.PageSize = pageSize;
ViewBag.ManagementData = managementData;
```

2. Build the MonitorData query (Open+Upcoming only, no pagination, sorted by Schedule ascending):

```csharp
// Monitoring tab: Open + Upcoming only, sorted by schedule (soonest first)
var monitorData = await _context.AssessmentSessions
    .Include(a => a.User)
    .Where(a => a.Status == "Open" || a.Status == "Upcoming")
    .OrderBy(a => a.Schedule)
    .ToListAsync();

ViewBag.MonitorData = monitorData;
```

3. Set view info and return:

```csharp
ViewBag.ViewMode = view;
ViewBag.UserRole = userRole;
ViewBag.CanManage = isHCAccess;

return View(managementData); // Model is Management data; Monitoring is in ViewBag
```

**Step B — For the worker (personal) branch, keep the existing flow:**

The worker branch continues to use the current `query` variable with search, pagination, and `return View(exams)`. The only addition from Task 1 is the status filter. Make sure the existing search filter, pagination, and ViewBag assignments still apply for the personal branch.

**Important structural note:** The manage branch should return EARLY with its own View() call. The worker branch follows after. This avoids tangling the two branches' search/pagination logic. The recommended structure is:

```csharp
if (view == "manage" && isHCAccess)
{
    // ... build managementQuery, monitorData, set ViewBags ...
    return View(managementData);
}

// Worker personal view (default)
var query = _context.AssessmentSessions
    .Include(a => a.User)
    .Where(a => a.UserId == userId)
    .Where(a => a.Status == "Open" || a.Status == "Upcoming");

// ... search, pagination, return View(exams) ...
```

**Step C — Verify existing redirects are unbroken:**

Confirm that `EditAssessment`, `DeleteAssessment`, and `RegenerateToken` all still redirect to `new { view = "manage" }`. Do NOT change these redirect targets. The view=manage entry point is preserved and lands on the Management tab by default.
  </action>
  <verify>
Build the project: `dotnet build` — must compile with 0 errors.

Grep for `ViewBag.ManagementData` and `ViewBag.MonitorData` in CMPController.cs — both must exist within the Assessment() action.

Grep for `RedirectToAction("Assessment", new { view = "manage" })` — must still appear in EditAssessment and DeleteAssessment (unchanged).
  </verify>
  <done>
HC/Admin branch of Assessment() populates ViewBag.ManagementData (all assessments, paginated, searchable) and ViewBag.MonitorData (Open+Upcoming, flat, sorted by Schedule ascending). Worker branch is unaffected except for the status filter from Task 1. Existing redirects from EditAssessment/DeleteAssessment to view=manage are preserved. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` passes with 0 errors
2. CMPController.cs contains `bool isHCAccess = userRole == UserRoles.Admin || userRole == UserRoles.HC`
3. Worker branch has `.Where(a => a.Status == "Open" || a.Status == "Upcoming")` after userId filter
4. HC/Admin branch sets `ViewBag.ManagementData` and `ViewBag.MonitorData`
5. `RedirectToAction("Assessment", new { view = "manage" })` appears in EditAssessment and DeleteAssessment (unchanged)
6. No new files created — pure modification of existing controller
</verification>

<success_criteria>
- Worker query excludes Completed assessments at the DB level
- HC/Admin gets two separate data sets via ViewBag (ManagementData: all, MonitorData: Open+Upcoming)
- isHCAccess named bool used for all role gates (Admin always gets management access)
- Existing redirects from EditAssessment/DeleteAssessment/RegenerateToken to view=manage are preserved
- Build compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/11-assessment-page-role-filter/11-01-SUMMARY.md`
</output>
