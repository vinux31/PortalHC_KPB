---
phase: 11-assessment-page-role-filter
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - Views/CMP/Assessment.cshtml
autonomous: true

must_haves:
  truths:
    - "Worker sees only Open and Upcoming tabs — no Completed tab in the DOM"
    - "Worker sees a visible callout linking to Training Records (/CMP/Records) above the tabs"
    - "HC/Admin sees Management tab with CRUD card grid (Edit, Questions, Delete, Regen Token actions)"
    - "HC/Admin sees Monitoring tab with Open+Upcoming assessments in a flat read-only list"
    - "Empty states display per tab when no assessments match the tab criteria"
  artifacts:
    - path: "Views/CMP/Assessment.cshtml"
      provides: "Role-branched tab structure with worker callout and HC/Admin Management+Monitoring tabs"
      contains: "ManagementData"
  key_links:
    - from: "Views/CMP/Assessment.cshtml"
      to: "ViewBag.ManagementData"
      via: "HC/Admin Management tab iterates ManagementData"
      pattern: "ViewBag\\.ManagementData"
    - from: "Views/CMP/Assessment.cshtml"
      to: "ViewBag.MonitorData"
      via: "HC/Admin Monitoring tab iterates MonitorData"
      pattern: "ViewBag\\.MonitorData"
    - from: "Views/CMP/Assessment.cshtml"
      to: "/CMP/Records"
      via: "Worker callout links to Training Records"
      pattern: 'Url\\.Action\\("Records", "CMP"\\)'
---

<objective>
Restructure Assessment.cshtml to render role-appropriate tab layouts: workers get Open and Upcoming tabs with a Training Records callout (no Completed tab); HC/Admin get Management and Monitoring tabs using the dual ViewBag data sets from Plan 01. Empty states per tab. All existing CRUD actions (Edit, Questions, Delete, Regen Token) preserved in Management tab.

Purpose: Workers see only actionable assessments with a clear path to their history. HC/Admin get a clean separation between assessment CRUD (Management) and system-wide status monitoring.

Output: Modified Assessment.cshtml with role-branched rendering and Training Records callout.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-assessment-page-role-filter/11-RESEARCH.md
@.planning/phases/11-assessment-page-role-filter/11-01-SUMMARY.md
@Views/CMP/Assessment.cshtml
@Controllers/CMPController.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restructure worker view — remove Completed tab, add Training Records callout</name>
  <files>Views/CMP/Assessment.cshtml</files>
  <action>
This task modifies the worker (personal) view path in Assessment.cshtml. The view already branches on `viewMode == "manage"` vs personal. Focus on the personal view sections.

**Step A — Add Training Records callout for workers (above the tab navigation, around line 77):**

Insert a callout BEFORE the tab `<ul>`, visible only for workers (non-manage view):

```html
@if (viewMode != "manage")
{
    <div class="alert alert-info d-flex align-items-center gap-2 mb-4" role="alert">
        <i class="bi bi-clock-history fs-5"></i>
        <span>
            Looking for completed assessments?
            <a href="@Url.Action("Records", "CMP")" class="alert-link fw-semibold">
                View your Training Records
            </a>
        </span>
    </div>
}
```

**Step B — Modify the tab navigation (lines 79-95) to branch by role:**

For workers, render only Open and Upcoming tabs (remove the Completed `<li>` entirely — do NOT just hide it):

```html
@if (viewMode != "manage")
{
    <!-- Worker tabs: Open and Upcoming only -->
    <ul class="nav nav-tabs mb-4" id="assessmentTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="open-tab" data-bs-toggle="tab"
                    data-bs-target="#open-tab-pane" type="button" role="tab" data-status="open">
                Open
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="upcoming-tab" data-bs-toggle="tab"
                    data-bs-target="#upcoming-tab-pane" type="button" role="tab" data-status="upcoming">
                Upcoming
            </button>
        </li>
    </ul>
}
```

The Completed `<li>` is fully removed from the DOM for workers — not hidden with CSS.

**Step C — In the card rendering loop (lines 131-317), remove the Completed action buttons block for workers:**

The `else if (item.Status == "Completed")` block (around lines 300-311) that renders "View Results" and "Certificate" buttons will never be reached for workers because the controller no longer sends Completed items. Leave the block in place — it does no harm (unreachable code for workers) and HC/Admin Management tab will still need it. No change needed here.

**Step D — Update the filterCards() JavaScript (lines 547-578):**

The existing JS handles all three status values. For workers, it only needs to handle "open" and "upcoming" since Completed cards are no longer in the DOM. The existing code already works correctly — when filterCards("open") runs on load, it shows Open and hides everything else. Since no Completed cards exist in the DOM, the JS just works.

However, remove the `completed` reference from the initial load comment for clarity. The JS can remain as-is since it is status-agnostic (it reads data-status from whatever cards exist).

No JS changes required — the existing filterCards function handles the reduced card set correctly.

**Step E — Update the empty state for workers:**

The existing empty state (lines 99-128) already handles the worker case ("No assessments assigned to you"). Keep as-is.

The tab-level empty state (line 322-326, `id="emptyTabState"`) already works — when filterCards finds 0 visible cards for a tab, it shows this div. Keep as-is.
  </action>
  <verify>
Read Assessment.cshtml and confirm:
1. The `alert-info` callout with `Url.Action("Records", "CMP")` exists inside `@if (viewMode != "manage")`
2. The tab `<ul>` for workers has exactly 2 `<li>` items (Open, Upcoming) — no Completed tab
3. The Completed tab `<li>` with `id="completed-tab"` does NOT appear inside the worker branch
  </verify>
  <done>
Workers see a Training Records callout above two tabs (Open, Upcoming). No Completed tab exists in the DOM for workers. The existing empty state and filterCards JS continue to work without modification.
  </done>
</task>

<task type="auto">
  <name>Task 2: Restructure HC/Admin view — Management and Monitoring tabs</name>
  <files>Views/CMP/Assessment.cshtml</files>
  <action>
This task replaces the HC/Admin (manage) view with a two-tab layout using Bootstrap 5 native tabs. The data comes from ViewBag.ManagementData and ViewBag.MonitorData (set by Plan 01).

**Step A — Restructure the manage view header (lines 12-53):**

For HC/Admin, update the header. Remove the "Personal View" / "Manage View" toggle buttons — HC/Admin now have Management and Monitoring tabs instead of switching between personal and manage. Keep a simple header:

```html
@if (viewMode == "manage")
{
    <div class="mb-4">
        <h2 class="fw-bold mb-1">
            <i class="bi bi-sliders me-2 text-primary"></i>Assessment Management
        </h2>
        <p class="text-muted mb-0">Manage assessments, monitor active and upcoming assessments across the system</p>
    </div>
}
```

For workers (personal view), keep the existing header but remove the "Manage View" button link since HC/Admin no longer use the personal view toggle. Actually — keep the button for HC/Admin who might want to see the personal view from the manage view. Preserve the existing toggle behavior: HC/Admin can switch to "Personal View" to see their own assignments.

Revised approach: Keep the existing header toggle as-is. HC/Admin can switch between personal (their own assignments) and manage (Management+Monitoring tabs). This preserves backward compatibility.

**Step B — Add Bootstrap 5 Management and Monitoring tabs for the manage view:**

After the search section (line 76), inside the manage view branch, replace the current tab navigation and card grid with:

```html
@if (viewMode == "manage")
{
    @{
        var managementData = ViewBag.ManagementData as List<HcPortal.Models.AssessmentSession> ?? new List<HcPortal.Models.AssessmentSession>();
        var monitorData = ViewBag.MonitorData as List<HcPortal.Models.AssessmentSession> ?? new List<HcPortal.Models.AssessmentSession>();
    }

    <!-- HC/Admin tabs: Management and Monitoring -->
    <ul class="nav nav-tabs mb-4" id="hcAssessmentTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="management-tab" data-bs-toggle="tab"
                    data-bs-target="#management-tab-pane" type="button" role="tab">
                <i class="bi bi-sliders me-1"></i> Management
                <span class="badge bg-secondary ms-1">@managementData.Count</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="monitor-tab" data-bs-toggle="tab"
                    data-bs-target="#monitor-tab-pane" type="button" role="tab">
                <i class="bi bi-binoculars me-1"></i> Monitoring
                <span class="badge bg-secondary ms-1">@monitorData.Count</span>
            </button>
        </li>
    </ul>

    <div class="tab-content" id="hcAssessmentTabsContent">
        <!-- Management Tab Pane -->
        <div class="tab-pane fade show active" id="management-tab-pane" role="tabpanel">
            <!-- Render management content here (Step C) -->
        </div>

        <!-- Monitoring Tab Pane -->
        <div class="tab-pane fade" id="monitor-tab-pane" role="tabpanel">
            <!-- Render monitoring content here (Step D) -->
        </div>
    </div>
}
```

**Step C — Management tab content (inside #management-tab-pane):**

Render the existing CRUD card grid using `managementData` instead of `Model`. This is the same card layout currently used in the manage view — all assessments with Edit, Questions, Delete, Regen Token actions. Copy the existing card rendering loop but iterate over `managementData`:

```html
<div class="row g-4">
    @if (managementData.Count == 0)
    {
        <div class="col-12">
            <div class="text-center py-5">
                <i class="bi bi-inbox text-muted mb-3" style="font-size: 4rem;"></i>
                <h5 class="text-muted">No assessments created yet</h5>
                <p class="text-muted small">Create your first assessment to get started.</p>
                <a asp-action="CreateAssessment" class="btn btn-primary mt-3">
                    <i class="bi bi-plus-circle me-1"></i> Create Assessment
                </a>
            </div>
        </div>
    }
    else
    {
        @foreach (var item in managementData)
        {
            <!-- Reuse the existing manage-view card markup (category badge, title, meta,
                 manage-info with assigned-to/token/schedule, and action buttons:
                 Edit, Questions, Regen Token, Delete) -->
        }
    }
</div>
```

Include the existing pagination below the Management card grid — pagination applies only to the Management tab. The pagination markup (lines 329-380) should be inside #management-tab-pane.

**Step D — Monitoring tab content (inside #monitor-tab-pane):**

Render a simpler read-only table/card list from `monitorData`. No CRUD actions, no pagination. Sorted by Schedule ascending (soonest first, set by controller). Show: Title, Category badge, Status badge, Schedule date, Assigned user, Duration.

Use a clean table layout for monitoring (not cards — monitoring is a dashboard-style overview):

```html
@if (monitorData.Count == 0)
{
    <div class="text-center py-5">
        <i class="bi bi-binoculars text-muted mb-3" style="font-size: 4rem;"></i>
        <h5 class="text-muted">No active or upcoming assessments</h5>
        <p class="text-muted small">All assessments are currently completed.</p>
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>Title</th>
                    <th>Category</th>
                    <th>Status</th>
                    <th>Schedule</th>
                    <th>Assigned To</th>
                    <th>Duration</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in monitorData)
                {
                    var statusBadgeClass = item.Status == "Open" ? "bg-success" : "bg-warning text-dark";
                    var categoryBadgeClass = item.Category switch
                    {
                        "OJT" => "bg-primary",
                        "IHT" => "bg-success",
                        "Training Licencor" => "bg-danger",
                        "OTS" => "bg-warning text-dark",
                        "Mandatory HSSE Training" => "bg-info",
                        "Proton" => "bg-purple",
                        _ => "bg-secondary"
                    };

                    <tr>
                        <td class="fw-semibold">@item.Title</td>
                        <td><span class="badge @categoryBadgeClass">@item.Category</span></td>
                        <td><span class="badge @statusBadgeClass">@item.Status</span></td>
                        <td>@item.Schedule.ToString("dd MMM yyyy")</td>
                        <td>@(item.User?.FullName ?? "Unknown")</td>
                        <td>
                            @{
                                var hrs = item.DurationMinutes / 60;
                                var mins = item.DurationMinutes % 60;
                            }
                            @(hrs > 0 ? $"{hrs}h {mins}m" : $"{mins}m")
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
```

**Step E — Ensure the worker personal view (non-manage) still uses the Model directly:**

The worker card grid should continue to iterate `Model` (which is the personal filtered list). The existing `@foreach (var item in Model)` loop (line 131) must remain for the worker path. Wrap the worker card grid and tab navigation in `@if (viewMode != "manage")` so it does not render when HC/Admin is on the manage view.

The overall page structure should be:

```
@if (viewMode == "manage" && canManage)
{
    // HC/Admin: Management + Monitoring tabs (Steps B-D)
}
else
{
    // Worker: Training Records callout + Open/Upcoming tabs + card grid from Model (Task 1)
}
```

**Step F — Keep all existing JavaScript functions:**

Do NOT remove or modify: `openTokenModal`, `verifyToken`, `startStandardAssessment`, `copyToken`, `regenerateToken`, `confirmDelete`. These are used by the Management tab CRUD actions.

The `filterCards()` function should only be initialized when the worker tabs exist. Wrap the DOMContentLoaded listener in a check:

```javascript
var workerTabs = document.getElementById('assessmentTabs');
if (workerTabs) {
    // existing filterCards setup...
}
```

This prevents errors when HC/Admin is on the manage view (where `#assessmentTabs` does not exist — the HC tabs use `#hcAssessmentTabs`).

**Step G — Keep all existing styles (lines 423-536):**

The `.assessment-card-item`, `.meta-item`, and tab styles still apply to the Management tab cards. Keep them.

Add one style for the monitoring tab if needed — the table uses Bootstrap defaults so no custom CSS is required.
  </action>
  <verify>
Build the project: `dotnet build` — must compile with 0 errors.

Read Assessment.cshtml and confirm:
1. `Url.Action("Records", "CMP")` appears in a callout for workers
2. Worker tab nav has only Open and Upcoming tabs (no Completed)
3. HC/Admin section has `#management-tab-pane` and `#monitor-tab-pane`
4. Management tab iterates `managementData` with Edit/Questions/Delete/Regen Token actions
5. Monitoring tab iterates `monitorData` in a read-only table
6. Pagination exists only inside `#management-tab-pane`
7. Existing JS functions (openTokenModal, verifyToken, etc.) are preserved
  </verify>
  <done>
Assessment.cshtml renders two distinct experiences: Workers see a Training Records callout + Open/Upcoming tabs with card grid from Model. HC/Admin see Management tab (CRUD card grid with pagination from ViewBag.ManagementData) and Monitoring tab (read-only table from ViewBag.MonitorData). Empty states show per tab. All existing JS functions preserved. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` passes with 0 errors
2. Worker view: Training Records callout with link to /CMP/Records above tabs
3. Worker view: Only Open and Upcoming tabs — no Completed tab in DOM
4. HC/Admin view: Management tab with CRUD card grid and pagination
5. HC/Admin view: Monitoring tab with read-only table of Open+Upcoming assessments
6. Management tab has Create Assessment link in empty state
7. Monitoring tab has appropriate empty state text
8. filterCards() JS guarded against missing #assessmentTabs element
9. All CRUD JS functions preserved (openTokenModal, verifyToken, startStandardAssessment, copyToken, regenerateToken, confirmDelete)
</verification>

<success_criteria>
- Worker sees Training Records callout + two tabs (Open, Upcoming) — no Completed tab
- HC/Admin sees Management tab (all assessments, CRUD actions, pagination) and Monitoring tab (Open+Upcoming, read-only table)
- Empty states render correctly per tab
- Existing CRUD actions (Edit, Questions, Delete, Regen Token) work from Management tab
- filterCards JS works for worker Open/Upcoming switching
- Build compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/11-assessment-page-role-filter/11-02-SUMMARY.md`
</output>
