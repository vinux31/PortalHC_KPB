---
phase: 12-dashboard-consolidation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Models/CDPDashboardViewModel.cs
  - Controllers/CDPController.cs
autonomous: true

must_haves:
  truths:
    - "CDPDashboardViewModel carries three nullable sub-models: CoacheeDashboardSubModel, ProtonProgressSubModel, AssessmentAnalyticsSubModel"
    - "Dashboard() populates CoacheeData for literal Coachee role only (early return)"
    - "Dashboard() populates ProtonProgressData for all non-Coachee roles with correct role scoping (HC/Admin=all, SrSpv/SectionHead=section, Coach=unit)"
    - "Dashboard() populates AssessmentAnalyticsData for HC and Admin regardless of SelectedView"
    - "ExportAnalyticsResults action exists on CDPController with Authorize(Roles=Admin,HC)"
    - "SearchUsers action exists on CDPController for Analytics autocomplete"
  artifacts:
    - path: "Models/CDPDashboardViewModel.cs"
      provides: "CDPDashboardViewModel wrapper with CoacheeDashboardSubModel, ProtonProgressSubModel, AssessmentAnalyticsSubModel, CoacheeProgressRow, AssessmentReportItem, ReportFilters, CategoryStatistic"
      contains: "class CDPDashboardViewModel"
    - path: "Controllers/CDPController.cs"
      provides: "Rewritten Dashboard() action, ExportAnalyticsResults(), SearchUsers()"
      contains: "BuildCoacheeSubModelAsync"
  key_links:
    - from: "Controllers/CDPController.cs"
      to: "Models/CDPDashboardViewModel.cs"
      via: "new CDPDashboardViewModel in Dashboard() action"
      pattern: "new CDPDashboardViewModel"
    - from: "Controllers/CDPController.cs"
      to: "Data/ApplicationDbContext.cs"
      via: "EF Core queries for role-scoped coachee data and analytics aggregation"
      pattern: "_context\\.Users|_context\\.AssessmentSessions"
---

<objective>
Create CDPDashboardViewModel with three nullable sub-models and rewrite CDPController.Dashboard() to populate them based on role. Also move ExportResults and SearchUsers from CMPController to CDPController.

Purpose: The ViewModel and controller form the data backbone for the consolidated Dashboard. Without correct role-branching and sub-model population, the view layer (Plan 12-02) has nothing to render.

Output: CDPDashboardViewModel.cs (new), CDPController.cs (Dashboard rewritten, ExportAnalyticsResults + SearchUsers added)
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-dashboard-consolidation/12-CONTEXT.md
@.planning/phases/12-dashboard-consolidation/12-RESEARCH.md
@.planning/phases/07-development-dashboard/07-01-SUMMARY.md
@.planning/phases/02-hc-reports-dashboard/02-01-SUMMARY.md
@Models/DevDashboardViewModel.cs
@Models/ReportsDashboardViewModel.cs
@Models/DashboardViewModel.cs
@Controllers/CDPController.cs
@Controllers/CMPController.cs
@Views/CDP/DevDashboard.cshtml
@Views/CMP/ReportsIndex.cshtml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CDPDashboardViewModel with three sub-models</name>
  <files>Models/CDPDashboardViewModel.cs</files>
  <action>
Create `Models/CDPDashboardViewModel.cs` in namespace `HcPortal.Models` with these classes:

1. **CDPDashboardViewModel** (wrapper):
   - `string CurrentUserRole` (default "")
   - `string ScopeLabel` (default "")
   - `CoacheeDashboardSubModel? CoacheeData` (nullable, populated for Coachee only)
   - `ProtonProgressSubModel? ProtonProgressData` (nullable, populated for non-Coachee roles)
   - `AssessmentAnalyticsSubModel? AssessmentAnalyticsData` (nullable, populated for HC/Admin only)

2. **CoacheeDashboardSubModel** (Coachee's personal view):
   - `string TrackType` (Panelman/Operator)
   - `string TahunKe` (1/2/3)
   - `int TotalDeliverables`
   - `int ApprovedDeliverables`
   - `int ActiveDeliverables`
   - `int? CompetencyLevelGranted` (from ProtonFinalAssessment)
   - `string CurrentStatus` ("In Progress" / "Completed")

3. **ProtonProgressSubModel** (supervisor/HC view):
   - Stat card fields: `int TotalCoachees`, `int TotalDeliverables`, `int ApprovedDeliverables`, `int PendingSpvApprovals`, `int PendingHCReviews`, `int CompletedCoachees`
   - `List<CoacheeProgressRow> CoacheeRows` (reuse the existing CoacheeProgressRow class from DevDashboardViewModel — copy it here, do NOT reference the old file since it will be deleted in 12-03)
   - Chart data: `List<string> TrendLabels`, `List<double> TrendValues`, `List<string> StatusLabels`, `List<int> StatusData` (same shape as DevDashboardViewModel)

4. **AssessmentAnalyticsSubModel** (HC/Admin Analytics tab):
   - KPI card fields: `int TotalAssigned`, `int TotalCompleted`, `int PassedCount`, `double PassRate`, `double AverageScore`
   - `List<AssessmentReportItem> Assessments` (copy the AssessmentReportItem class from ReportsDashboardViewModel — same fields)
   - Pagination: `int CurrentPage`, `int TotalPages`, `int PageSize`
   - Filters: `ReportFilters CurrentFilters` (copy ReportFilters from ReportsDashboardViewModel)
   - Dropdowns: `List<string> AvailableCategories`, `List<string> AvailableSections`
   - Chart data: `List<CategoryStatistic> CategoryStats` (copy CategoryStatistic from ReportsDashboardViewModel), `List<int> ScoreDistribution`

Copy the following supporting classes INTO this file (do not reference ReportsDashboardViewModel.cs or DevDashboardViewModel.cs — they will be deleted in 12-03):
- `CoacheeProgressRow` (from DevDashboardViewModel.cs — all fields: UserId, FullName, NIP, Section, Unit, TrackType, TahunKe, TotalDeliverables, ApprovedDeliverables, PendingApproval, CompetencyLevel, Status)
- `AssessmentReportItem` (from ReportsDashboardViewModel.cs — all fields)
- `ReportFilters` (from ReportsDashboardViewModel.cs — all fields)
- `CategoryStatistic` (from ReportsDashboardViewModel.cs — all fields)

All `List<T>` properties must initialize with `new()`. All `string` properties must initialize with `""`.
  </action>
  <verify>
Run `dotnet build` from project root. The new file must compile with 0 errors. Verify the file exists and contains all 8 classes (CDPDashboardViewModel, CoacheeDashboardSubModel, ProtonProgressSubModel, AssessmentAnalyticsSubModel, CoacheeProgressRow, AssessmentReportItem, ReportFilters, CategoryStatistic).
  </verify>
  <done>
CDPDashboardViewModel.cs exists with all 8 classes. `dotnet build` passes with 0 errors (warnings OK).
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite CDPController.Dashboard() and add ExportAnalyticsResults + SearchUsers</name>
  <files>Controllers/CDPController.cs</files>
  <action>
**Part A — Rewrite Dashboard() action:**

Replace the existing `Dashboard()` method in CDPController with the new consolidated version. The existing method uses `DashboardViewModel` — the new one uses `CDPDashboardViewModel`.

The new Dashboard() must accept Analytics filter parameters:
```
public async Task<IActionResult> Dashboard(
    string? analyticsCategory = null,
    DateTime? analyticsStartDate = null,
    DateTime? analyticsEndDate = null,
    string? analyticsSection = null,
    string? analyticsUserSearch = null,
    int analyticsPage = 1,
    int analyticsPageSize = 20)
```

**Role dispatch logic (in order):**

1. Get current user and role (same pattern as existing DevDashboard):
   ```csharp
   var user = await _userManager.GetUserAsync(User);
   if (user == null) return Challenge();
   var roles = await _userManager.GetRolesAsync(user);
   var userRole = roles.FirstOrDefault() ?? "";
   ```

2. Create model: `var model = new CDPDashboardViewModel { CurrentUserRole = userRole };`

3. **Coachee branch** (literal Coachee role, NOT Admin simulating Coachee):
   ```csharp
   bool isLiteralCoachee = userRole == UserRoles.Coachee;
   if (isLiteralCoachee)
   {
       model.CoacheeData = await BuildCoacheeSubModelAsync(user.Id);
       return View(model);
   }
   ```

4. **ProtonProgress branch** (all non-Coachee roles): Copy the role-scoping logic from the existing DevDashboard() method (lines ~247-281 in CDPController.cs). The scoping must produce `scopedCoacheeIds` and `scopeLabel`:
   - HC/Admin: all users with RoleLevel == 6
   - SrSpv/SectionHead: users in same Section with RoleLevel == 6
   - Coach: users in same Unit with RoleLevel == 6 (with null Unit fallback to Section)

   Set `model.ScopeLabel = scopeLabel;`

   Then copy the batch query logic from DevDashboard() to populate ProtonProgressSubModel:
   - Batch load users, assignments, deliverables, final assessments (same pattern as DevDashboard)
   - Build CoacheeProgressRow list (sorted by FullName — per locked decision: flat table sorted by name)
   - Build stat card values (TotalCoachees, TotalDeliverables, ApprovedDeliverables, PendingSpvApprovals, PendingHCReviews, CompletedCoachees)
   - Build trend chart data (TrendLabels/TrendValues from ProtonFinalAssessment.CompletedAt grouped by month)
   - Build status doughnut data (StatusLabels/StatusData from deliverable status counts)

   Assign to `model.ProtonProgressData`.

5. **Analytics branch** (HC and Admin ONLY — SelectedView IGNORED per locked decision):
   ```csharp
   bool isHCAccess = userRole == UserRoles.HC || userRole == UserRoles.Admin;
   ```
   IMPORTANT: Do NOT check `user.SelectedView`. The locked decision explicitly states Admin simulating Coachee/Atasan/Coach still sees the Analytics tab.

   If isHCAccess, call `model.AssessmentAnalyticsData = await BuildAnalyticsSubModelAsync(analyticsCategory, analyticsStartDate, analyticsEndDate, analyticsSection, analyticsUserSearch, analyticsPage, analyticsPageSize);`

6. `return View(model);`

**Part B — Create helper methods:**

1. `BuildCoacheeSubModelAsync(string userId)`: Query the user's ProtonTrackAssignment, count their deliverables (total, approved, active), get CompetencyLevelGranted from ProtonFinalAssessment, derive status. Return `CoacheeDashboardSubModel`.

2. `BuildProtonProgressSubModelAsync(ApplicationUser user, string userRole)`: Extract from the DevDashboard() method — scoping + batch queries + aggregation. Return `ProtonProgressSubModel`.

3. `BuildAnalyticsSubModelAsync(...)`: Copy the query logic from CMPController.ReportsIndex(). This is the assessment session query with category/date/section/user filters, pagination, stat cards, CategoryStats, and ScoreDistribution. Return `AssessmentAnalyticsSubModel`.

**Part C — Add ExportAnalyticsResults action:**

Copy `CMPController.ExportResults()` verbatim into CDPController. Rename to `ExportAnalyticsResults`. Keep `[HttpGet]` and `[Authorize(Roles = "Admin, HC")]`. Same parameters and ClosedXML logic. The only change: the action name and the fact it lives on CDPController now.

**Part D — Add SearchUsers action:**

First, grep for `SearchUsers` across all .cshtml files to check if any other CMP view uses it. If ONLY ReportsIndex uses it, copy `CMPController.SearchUsers()` into CDPController as-is. If other CMP views also use it, leave the original on CMPController AND add a copy to CDPController (the Analytics partial will call the CDPController one; other views keep using CMPController).

**Critical notes:**
- Do NOT delete the existing DevDashboard() action yet — that happens in Plan 12-03
- Do NOT delete the existing DashboardViewModel usage elsewhere — just replace it in Dashboard()
- Add `using HcPortal.Models;` at top if CDPDashboardViewModel is not already visible
- The old Dashboard() method's DashboardViewModel population can be removed entirely — that ViewModel is superseded
  </action>
  <verify>
Run `dotnet build` — must pass with 0 errors. Verify:
1. `Dashboard()` method signature accepts analytics filter params
2. Method body contains `new CDPDashboardViewModel`
3. Method body contains `isLiteralCoachee` branch
4. Method body contains `isHCAccess` check using `userRole == UserRoles.HC || userRole == UserRoles.Admin` (no SelectedView check)
5. `ExportAnalyticsResults` action exists with `[Authorize(Roles = "Admin, HC")]`
6. `SearchUsers` action exists on CDPController
7. Three private helper methods exist: BuildCoacheeSubModelAsync, BuildProtonProgressSubModelAsync (or inline), BuildAnalyticsSubModelAsync
  </verify>
  <done>
CDPController.Dashboard() returns CDPDashboardViewModel with role-branched sub-model population. Coachee gets CoacheeData only. Non-Coachee gets ProtonProgressData. HC/Admin get both ProtonProgressData + AssessmentAnalyticsData. ExportAnalyticsResults and SearchUsers actions are on CDPController. Build passes with 0 errors.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` passes with 0 errors
2. CDPDashboardViewModel.cs contains all 8 classes with correct property types
3. CDPController.Dashboard() creates CDPDashboardViewModel, branches on role correctly
4. Analytics gate uses `userRole == UserRoles.HC || userRole == UserRoles.Admin` — no SelectedView check
5. Coachee branch populates CoacheeData only and returns early
6. ProtonProgress scoping matches former DevDashboard rules (HC/Admin=all, SrSpv/SectionHead=section, Coach=unit)
7. ExportAnalyticsResults exists with HC/Admin authorization
</verification>

<success_criteria>
- CDPDashboardViewModel.cs is a self-contained file with all needed classes (no dependency on DevDashboardViewModel or ReportsDashboardViewModel)
- Dashboard() action serves all roles correctly with conditional sub-model population
- Analytics filter parameters flow through to BuildAnalyticsSubModelAsync
- Build succeeds; existing DevDashboard() action is untouched (still works until 12-03 deletes it)
</success_criteria>

<output>
After completion, create `.planning/phases/12-dashboard-consolidation/12-01-SUMMARY.md`
</output>
