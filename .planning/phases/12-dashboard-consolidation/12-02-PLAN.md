---
phase: 12-dashboard-consolidation
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - Views/CDP/Dashboard.cshtml
  - Views/CDP/Shared/_ProtonProgressPartial.cshtml
  - Views/CDP/Shared/_CoacheeDashboardPartial.cshtml
  - Views/CDP/Shared/_AssessmentAnalyticsPartial.cshtml
autonomous: true

must_haves:
  truths:
    - "Dashboard.cshtml renders two Bootstrap 5 tabs: Proton Progress (always visible) and Assessment Analytics (only rendered when AssessmentAnalyticsData is non-null)"
    - "Coachee sees Proton Progress tab with their own deliverable summary via _CoacheeDashboardPartial"
    - "Non-Coachee roles see Proton Progress tab with flat coachee table, stat cards, and Chart.js charts via _ProtonProgressPartial"
    - "HC/Admin see Assessment Analytics tab with KPI cards, filter form, paginated table, charts, and top-level Export to Excel button"
    - "Analytics tab is completely absent from the DOM for non-HC/non-Admin users"
    - "Analytics filter form posts to CDP/Dashboard (not CMP/ReportsIndex)"
    - "Export button links to CDP/ExportAnalyticsResults (not CMP/ExportResults)"
  artifacts:
    - path: "Views/CDP/Dashboard.cshtml"
      provides: "Two-tab layout with conditional Analytics tab, @model CDPDashboardViewModel"
      contains: "dashboardTabs"
    - path: "Views/CDP/Shared/_ProtonProgressPartial.cshtml"
      provides: "Stat cards, flat coachee table sorted by name, Chart.js trend + status charts"
      contains: "@model HcPortal.Models.ProtonProgressSubModel"
    - path: "Views/CDP/Shared/_CoacheeDashboardPartial.cshtml"
      provides: "Coachee personal deliverable progress with stat cards"
      contains: "@model HcPortal.Models.CoacheeDashboardSubModel"
    - path: "Views/CDP/Shared/_AssessmentAnalyticsPartial.cshtml"
      provides: "KPI cards, filter form, paginated assessment table, charts, export button"
      contains: "@model HcPortal.Models.AssessmentAnalyticsSubModel"
  key_links:
    - from: "Views/CDP/Dashboard.cshtml"
      to: "Views/CDP/Shared/_ProtonProgressPartial.cshtml"
      via: "partial tag helper"
      pattern: "<partial name=\"_ProtonProgressPartial\""
    - from: "Views/CDP/Dashboard.cshtml"
      to: "Views/CDP/Shared/_CoacheeDashboardPartial.cshtml"
      via: "partial tag helper"
      pattern: "<partial name=\"_CoacheeDashboardPartial\""
    - from: "Views/CDP/Dashboard.cshtml"
      to: "Views/CDP/Shared/_AssessmentAnalyticsPartial.cshtml"
      via: "partial tag helper"
      pattern: "<partial name=\"_AssessmentAnalyticsPartial\""
    - from: "Views/CDP/Shared/_AssessmentAnalyticsPartial.cshtml"
      to: "Controllers/CDPController.cs"
      via: "form asp-action=Dashboard and export link asp-action=ExportAnalyticsResults"
      pattern: "asp-action=\"Dashboard\"|asp-action=\"ExportAnalyticsResults\""
---

<objective>
Rewrite Dashboard.cshtml as a two-tab layout and create three partial views: _CoacheeDashboardPartial (Coachee personal view), _ProtonProgressPartial (supervisor/HC team view), and _AssessmentAnalyticsPartial (HC/Admin analytics). All form actions and links must point to CDPController, not CMPController.

Purpose: This is the visual consolidation — the user-facing result of Phase 12. The tab layout with conditional rendering is what makes the CDP Dashboard the single entry point.

Output: Dashboard.cshtml (rewritten), three new partial views in Views/CDP/Shared/
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-dashboard-consolidation/12-CONTEXT.md
@.planning/phases/12-dashboard-consolidation/12-RESEARCH.md
@.planning/phases/12-dashboard-consolidation/12-01-SUMMARY.md
@Models/CDPDashboardViewModel.cs
@Views/CDP/Dashboard.cshtml
@Views/CDP/DevDashboard.cshtml
@Views/CMP/ReportsIndex.cshtml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite Dashboard.cshtml with two-tab layout and create _CoacheeDashboardPartial</name>
  <files>
    Views/CDP/Dashboard.cshtml
    Views/CDP/Shared/_CoacheeDashboardPartial.cshtml
  </files>
  <action>
**Part A — Rewrite Dashboard.cshtml:**

Replace the entire contents of `Views/CDP/Dashboard.cshtml`. The new file must:

1. Set `@model HcPortal.Models.CDPDashboardViewModel` (replaces the old DashboardViewModel)
2. Set ViewData["Title"] = "Dashboard"
3. Render a page heading: `<h2><i class="bi bi-speedometer2 me-2"></i>Dashboard</h2>` followed by a scope subtitle: `<p class="text-muted">@Model.ScopeLabel</p>`
4. Render Bootstrap 5 tab navigation:

```html
<ul class="nav nav-tabs mb-4" id="dashboardTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="proton-tab" data-bs-toggle="tab"
                data-bs-target="#proton-pane" type="button" role="tab"
                aria-controls="proton-pane" aria-selected="true">
            <i class="bi bi-graph-up me-1"></i>Proton Progress
        </button>
    </li>
    @if (Model.AssessmentAnalyticsData != null)
    {
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="analytics-tab" data-bs-toggle="tab"
                    data-bs-target="#analytics-pane" type="button" role="tab"
                    aria-controls="analytics-pane" aria-selected="false">
                <i class="bi bi-clipboard-data me-1"></i>Assessment Analytics
            </button>
        </li>
    }
</ul>
```

5. Render tab content panes:

```html
<div class="tab-content">
    <div class="tab-pane fade show active" id="proton-pane" role="tabpanel" aria-labelledby="proton-tab">
        @if (Model.CoacheeData != null)
        {
            <partial name="Shared/_CoacheeDashboardPartial" model="Model.CoacheeData" />
        }
        else if (Model.ProtonProgressData != null)
        {
            <partial name="Shared/_ProtonProgressPartial" model="Model.ProtonProgressData" />
        }
    </div>
    @if (Model.AssessmentAnalyticsData != null)
    {
        <div class="tab-pane fade" id="analytics-pane" role="tabpanel" aria-labelledby="analytics-tab">
            <partial name="Shared/_AssessmentAnalyticsPartial" model="Model.AssessmentAnalyticsData" />
        </div>
    }
</div>
```

6. The Analytics tab `<li>` and pane `<div>` are wrapped in `@if (Model.AssessmentAnalyticsData != null)` — this is server-side enforcement. When the sub-model is null (non-HC/non-Admin), the tab is completely absent from the DOM. This is Claude's discretion choice: server-side enforcement (consistent with how the controller already gates the data).

7. Remove ALL old Dashboard content — the old DashboardViewModel's IDP cards, mock charts, etc. are fully replaced.

8. Do NOT include a `@section Scripts {}` block in Dashboard.cshtml itself — the Chart.js scripts go in the partials.

**Part B — Create _CoacheeDashboardPartial.cshtml:**

Create `Views/CDP/Shared/_CoacheeDashboardPartial.cshtml` with `@model HcPortal.Models.CoacheeDashboardSubModel`.

Layout (per locked decision — Coachee sees their own deliverable progress):

1. **Stat cards row** (Bootstrap grid, 3-4 cards):
   - Card 1: "Deliverables Completed" — `Model.ApprovedDeliverables` / `Model.TotalDeliverables` with a progress indicator
   - Card 2: "Current Status" — `Model.CurrentStatus` with appropriate badge color (success for Completed, primary for In Progress)
   - Card 3: "Competency Level" — `Model.CompetencyLevelGranted ?? "Pending"`
   - Card 4 (optional): "Active Deliverables" — `Model.ActiveDeliverables`

2. **Track info**: Display `Model.TrackType` and `Model.TahunKe` (e.g., "Proton Track: Panelman - Tahun 2")

3. **Progress bar**: Visual progress bar showing `ApprovedDeliverables / TotalDeliverables * 100`%

4. Use Bootstrap 5 card styling consistent with DevDashboard.cshtml stat cards.

No Chart.js needed for Coachee view — just stat cards and progress info. Per locked decision: "Assessment results stay in Training Records — no assessment summary on the Dashboard for Coachees."

Ensure the `Views/CDP/Shared/` directory is created if it does not exist.
  </action>
  <verify>
Run `dotnet build` — must pass with 0 errors. Verify:
1. Dashboard.cshtml contains `@model HcPortal.Models.CDPDashboardViewModel`
2. Dashboard.cshtml contains `id="dashboardTabs"` (tab navigation)
3. Dashboard.cshtml contains `@if (Model.AssessmentAnalyticsData != null)` for Analytics tab gate
4. Dashboard.cshtml contains `<partial name="Shared/_CoacheeDashboardPartial"`
5. _CoacheeDashboardPartial.cshtml exists and contains `@model HcPortal.Models.CoacheeDashboardSubModel`
6. No reference to old `DashboardViewModel` in Dashboard.cshtml
  </verify>
  <done>
Dashboard.cshtml renders a two-tab layout. Proton Progress tab shows _CoacheeDashboardPartial when CoacheeData is populated, or _ProtonProgressPartial when ProtonProgressData is populated. Analytics tab is absent from DOM when AssessmentAnalyticsData is null.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create _ProtonProgressPartial and _AssessmentAnalyticsPartial</name>
  <files>
    Views/CDP/Shared/_ProtonProgressPartial.cshtml
    Views/CDP/Shared/_AssessmentAnalyticsPartial.cshtml
  </files>
  <action>
**Part A — Create _ProtonProgressPartial.cshtml:**

Create `Views/CDP/Shared/_ProtonProgressPartial.cshtml` with `@model HcPortal.Models.ProtonProgressSubModel`.

Adapt the content from `DevDashboard.cshtml` with these modifications per locked decisions:

1. **Stat cards at top** (row of Bootstrap cards — same style as DevDashboard):
   - Total Coachees, Approved/Total Deliverables, Pending Spv Approvals, Pending HC Reviews, Completed Coachees
   - Use same color scheme as DevDashboard (primary, success, warning, info)

2. **Flat coachee table** (per locked decision: flat table sorted by name, NO section grouping headers, NO approval queue):
   - Table columns (Claude's discretion on exact set): No., Name, NIP, Section, Unit, Track, Tahun, Progress (approved/total with progress bar), Competency Level, Status
   - Sorted by FullName (the data arrives pre-sorted from controller)
   - Empty state: `<div class="alert alert-info">No coachees found in your scope.</div>`

3. **Chart.js trend charts preserved** (per locked decision): Place BELOW the stat cards and ABOVE the table (Claude's discretion on chart placement — above table provides quick visual overview before detail).
   - Line chart (competency trend over time) — copy from DevDashboard.cshtml
   - Doughnut chart (status distribution) — copy from DevDashboard.cshtml
   - Both wrapped in `@if (Model.TrendLabels.Any())` / `@if (Model.StatusData.Any(d => d > 0))` empty-state guards (same pattern as DevDashboard)
   - Place both charts in a `<div class="row mb-4">` with two `col-md-6` columns

4. Include `@section Scripts {}` block with Chart.js initialization. IMPORTANT: Since this is a partial view, use `<script>` tags directly within the partial (partials cannot use @section). The Chart.js CDN is already loaded in _Layout.cshtml. Use `document.addEventListener('DOMContentLoaded', ...)` or inline `<script>` at bottom of partial.

   Actually, check how DevDashboard.cshtml handles scripts. If it uses `@section Scripts`, the partial cannot. Instead, place `<script>` blocks directly at the bottom of the partial. The Chart.js CDN is loaded in the layout so the script will work.

**Part B — Create _AssessmentAnalyticsPartial.cshtml:**

Create `Views/CDP/Shared/_AssessmentAnalyticsPartial.cshtml` with `@model HcPortal.Models.AssessmentAnalyticsSubModel`.

Adapt the content from `ReportsIndex.cshtml` with these critical modifications:

1. **Export button at TOP LEVEL** (per locked decision — not only accessible from drill-down):
   ```html
   <div class="d-flex justify-content-end mb-3">
       <a asp-controller="CDP" asp-action="ExportAnalyticsResults"
          asp-route-category="@Model.CurrentFilters.Category"
          asp-route-startDate="@Model.CurrentFilters.StartDate?.ToString("yyyy-MM-dd")"
          asp-route-endDate="@Model.CurrentFilters.EndDate?.ToString("yyyy-MM-dd")"
          asp-route-section="@Model.CurrentFilters.Section"
          asp-route-userSearch="@Model.CurrentFilters.UserSearch"
          class="btn btn-success">
           <i class="bi bi-file-earmark-excel me-1"></i>Export to Excel
       </a>
   </div>
   ```

2. **KPI stat cards** (copy from ReportsIndex — same 4 cards: Total Assigned, Completed, Pass Rate, Average Score)

3. **Filter form** — copy from ReportsIndex.cshtml BUT update ALL form actions:
   - Form `asp-controller="CDP" asp-action="Dashboard"` (NOT CMP/ReportsIndex)
   - Clear button: `<a asp-controller="CDP" asp-action="Dashboard" class="btn btn-outline-secondary">Clear</a>` (NOT ReportsIndex)
   - User search autocomplete: Update fetch URL from `/CMP/SearchUsers` to `/CDP/SearchUsers`
   - All `asp-route-*` parameters prefixed with `analytics` to match Dashboard() signature: `asp-route-analyticsCategory`, `asp-route-analyticsStartDate`, `asp-route-analyticsEndDate`, `asp-route-analyticsSection`, `asp-route-analyticsUserSearch`, `asp-route-analyticsPage`
   - Add a hidden anchor `analytics` or use `asp-fragment="analytics-pane"` so that after filter submit, the page scrolls back to the analytics tab. Alternatively, add JavaScript to activate the analytics tab on page load when analytics filter params are present in the URL.

4. **Paginated assessment table** (copy from ReportsIndex — same columns and layout)
   - Pagination links must use `asp-controller="CDP" asp-action="Dashboard"` with `asp-route-analyticsPage` and all filter parameters preserved with `analytics` prefix

5. **Charts** (if ReportsIndex had Chart.js charts for category stats and score distribution — copy them):
   - Category pass rate chart and score distribution chart
   - Use inline `<script>` blocks (same approach as _ProtonProgressPartial)

6. **UserAssessmentHistory drill-down links**: If ReportsIndex table rows have links to UserAssessmentHistory, keep them. The action stays on CMPController (per research: UserAssessmentHistory has no dependency on ReportsIndex). Claude's discretion: keep UserAssessmentHistory as drill-down from Analytics tab — it provides useful per-user detail.

CRITICAL: Every `asp-action="ReportsIndex"` or `Url.Action("ReportsIndex")` in the adapted content must be changed to `asp-action="Dashboard"` with `asp-controller="CDP"`. Every `asp-action="ExportResults"` must become `asp-action="ExportAnalyticsResults"` with `asp-controller="CDP"`. Missing even one causes a 404 after Plan 12-03 deletes the CMP actions.

CRITICAL: Chart.js CDN must be loaded exactly ONCE. The CDN link is in _Layout.cshtml. Do NOT add another CDN `<script>` tag in any partial. If both _ProtonProgressPartial and _AssessmentAnalyticsPartial need Chart.js, both rely on the layout CDN — no double import.

Check: Does _Layout.cshtml already have the Chart.js CDN? If not, the existing Dashboard.cshtml or DevDashboard.cshtml must load it in @section Scripts. Since partials can't use @section, the Chart.js CDN must be added to _Layout.cshtml if not already present. Verify before writing the partials.
  </action>
  <verify>
Run `dotnet build` — must pass with 0 errors. Verify:
1. _ProtonProgressPartial.cshtml contains `@model HcPortal.Models.ProtonProgressSubModel`
2. _ProtonProgressPartial.cshtml contains a `<table` element for coachee rows
3. _ProtonProgressPartial.cshtml contains Chart.js `new Chart(` initialization
4. _AssessmentAnalyticsPartial.cshtml contains `@model HcPortal.Models.AssessmentAnalyticsSubModel`
5. _AssessmentAnalyticsPartial.cshtml contains `asp-action="Dashboard"` (NOT ReportsIndex)
6. _AssessmentAnalyticsPartial.cshtml contains `asp-action="ExportAnalyticsResults"` (NOT ExportResults)
7. _AssessmentAnalyticsPartial.cshtml contains `asp-controller="CDP"` on all form/link elements
8. No reference to `ReportsIndex` or `ExportResults` (without Analytics prefix) in any partial
9. No duplicate Chart.js CDN `<script>` tag
  </verify>
  <done>
Both partials render correctly: _ProtonProgressPartial shows stat cards + flat coachee table + Chart.js charts; _AssessmentAnalyticsPartial shows export button + KPI cards + filter form + paginated table + charts. All links and form actions point to CDPController. Build passes with 0 errors.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` passes with 0 errors
2. Dashboard.cshtml has @model CDPDashboardViewModel and two-tab layout
3. Analytics tab HTML is conditionally rendered (server-side gate via null check)
4. Three partial views exist in Views/CDP/Shared/ with correct @model directives
5. All form actions in _AssessmentAnalyticsPartial point to CDP/Dashboard
6. Export button is at top level of Analytics tab content
7. No references to CMP/ReportsIndex or CMP/ExportResults in any new/modified view file
8. Chart.js CDN is loaded exactly once (in layout, not duplicated in partials)
</verification>

<success_criteria>
- Dashboard.cshtml renders a working two-tab layout with conditional Analytics tab
- Coachee users see their personal deliverable progress in Proton Progress tab
- Non-Coachee users see the team coachee table with charts in Proton Progress tab
- HC/Admin see both tabs, with Analytics showing full filter/table/export functionality
- All links and forms target CDPController actions, not CMPController
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/12-dashboard-consolidation/12-02-SUMMARY.md`
</output>
