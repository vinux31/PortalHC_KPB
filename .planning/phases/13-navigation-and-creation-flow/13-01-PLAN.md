---
phase: 13-navigation-and-creation-flow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Views/CMP/Index.cshtml
  - Controllers/CMPController.cs
autonomous: true
must_haves:
  truths:
    - "HC/Admin visiting CMP Index sees a Manage Assessments card that links to /CMP/Assessment?view=manage"
    - "Workers visiting CMP Index see an Assessment Lobby card but NOT the Manage Assessments card"
    - "CMP Index no longer contains an embedded Create Assessment form for any role"
    - "The Index() controller action is synchronous and loads no user/section data into ViewBag"
    - "After HC submits a new assessment via CreateAssessment POST, they are redirected to /CMP/Assessment?view=manage (not CMP Index)"
    - "The Create Assessment button on the manage view already links to /CMP/CreateAssessment (CRT-01 pre-existing)"
  artifacts:
    - path: "Views/CMP/Index.cshtml"
      provides: "Clean CMP landing page with role-gated Manage Assessments card, no embedded form"
      contains: "Manage Assessments"
    - path: "Controllers/CMPController.cs"
      provides: "Sync Index() action, CreateAssessment POST redirecting to manage view"
      contains: "RedirectToAction(\"Assessment\""
  key_links:
    - from: "Views/CMP/Index.cshtml"
      to: "/CMP/Assessment?view=manage"
      via: "Manage Assessments card href"
      pattern: "Assessment.*view.*manage"
    - from: "Controllers/CMPController.cs"
      to: "/CMP/Assessment?view=manage"
      via: "CreateAssessment POST redirect"
      pattern: "RedirectToAction.*Assessment.*view.*manage"
---

<objective>
Clean up CMP Index page and fix the create assessment redirect flow.

Purpose: HC and Admin see a clean CMP Index with a dedicated "Manage Assessments" card (no embedded form), and after creating an assessment they land on the manage view instead of the CMP Index.
Output: Updated Views/CMP/Index.cshtml (clean, no form) and Controllers/CMPController.cs (sync Index, correct redirect)
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Views/CMP/Index.cshtml
@Controllers/CMPController.cs
@Views/CMP/Assessment.cshtml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove embedded form from CMP Index and redesign Assessments card section</name>
  <files>Views/CMP/Index.cshtml, Controllers/CMPController.cs</files>
  <action>
**Views/CMP/Index.cshtml — Remove embedded form and redesign cards:**

1. DELETE everything from `@* -- CREATE ASSESSMENT SECTION (HC / Admin only) -- *@` (line 125) through the closing `}` before `</div>` (line 354). This removes the entire embedded Create Assessment form, the success modal, and the HC/Admin role gate around them.

2. DELETE the entire `@section Scripts { ... }` block (lines 381-604). All that JS was for the embedded form which is being removed.

3. DELETE the `<style>` block containing `.form-switch .form-check-input` sizing (lines 375-379) — that was only for the form. Keep the `.icon-box` and `.card` hover styles (lines 357-373).

4. DELETE the `categories` variable at the top of the file (lines 4-12) — it was only used by the embedded form's Category dropdown.

5. REDESIGN the Assessments card section (currently lines 69-101). Replace the current single "Assessments" card with TWO role-branched cards:

   **For workers (non-HC, non-Admin):** Keep the existing "Assessment Lobby" card as-is — btn-info linking to `@Url.Action("Assessment", "CMP")`. This is the `else` branch.

   **For HC/Admin:** Show TWO cards:
   - Card A: "Assessment Lobby" — same as worker card (HC/Admin also have personal assessments). Icon: `bi-clipboard-check`, color: info. Button: btn-info, "Assessment Lobby", links to `@Url.Action("Assessment", "CMP")` (personal view).
   - Card B: "Manage Assessments" — NEW card for NAV-01/NAV-02. Icon: `bi-sliders`, color: warning. Description: "Create, edit, and manage assessment sessions for all employees". Two buttons in a `d-flex gap-2`:
     1. Green button (btn-success, flex-fill): `<i class="bi bi-plus-circle me-1"></i>Create New` linking to `@Url.Action("CreateAssessment", "CMP")`
     2. Primary button (btn-primary, flex-fill): `<i class="bi bi-sliders me-1"></i>Manage` linking to `@Url.Action("Assessment", "CMP", new { view = "manage" })`

   Implementation approach — use `@if (User.IsInRole("HC") || User.IsInRole("Admin"))` to gate the Manage Assessments card. The Assessment Lobby card should appear for ALL roles (including HC/Admin). The Manage Assessments card should appear ONLY for HC/Admin.

   For the existing Assessments card (lines 69-101), replace it with:
   - An Assessment Lobby card visible to ALL users (remove the @if role branching inside it — everyone gets the same card with btn-info "Assessment Lobby" button)
   - A new Manage Assessments card wrapped in `@if (User.IsInRole("HC") || User.IsInRole("Admin"))` — placed after the Assessment Lobby card, before the Training Records card

**Controllers/CMPController.cs — Revert Index() to sync:**

6. Replace the entire `Index()` method (lines 30-51) with:
```csharp
public IActionResult Index()
{
    return View();
}
```
This removes: async, Task<IActionResult>, user/role lookup, ViewBag.Users, ViewBag.Sections, ViewBag.SelectedUserIds, ViewBag.CreatedAssessment/TempData forwarding. The view no longer needs any of this data since the embedded form is gone.
  </action>
  <verify>
Build the project: `dotnet build` from the solution directory. Verify:
1. No compilation errors (no dangling ViewBag references in Index.cshtml)
2. Grep Index.cshtml for "createAssessmentForm" — should return 0 results
3. Grep Index.cshtml for "Manage Assessments" — should return results (the new card)
4. Grep Index.cshtml for "Assessment Lobby" — should return results (universal card)
5. Grep CMPController.cs for "public IActionResult Index()" — should find the sync method
6. Grep CMPController.cs for "ViewBag.Users" in Index method — should NOT be present (only in CreateAssessment actions)
  </verify>
  <done>
CMP Index.cshtml has no embedded form, no form JS, no form styles. All roles see an Assessment Lobby card. HC/Admin additionally see a Manage Assessments card with Create New (to /CMP/CreateAssessment) and Manage (to /CMP/Assessment?view=manage) buttons. Index() controller is synchronous returning View() with no data loading.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix CreateAssessment POST redirect to manage view</name>
  <files>Controllers/CMPController.cs</files>
  <action>
**CRT-02: Fix post-creation redirect.**

In `Controllers/CMPController.cs`, find the `CreateAssessment` POST action's success path (around line 673):

Change:
```csharp
return RedirectToAction("Index");
```

To:
```csharp
return RedirectToAction("Assessment", new { view = "manage" });
```

This ensures that after HC successfully creates an assessment, they land on the manage view where they can see it listed, rather than being sent back to the CMP Index.

**Also handle the TempData["CreatedAssessment"] cleanup:**
The `TempData["CreatedAssessment"]` serialization (lines 660-671) was consumed by the success modal in the embedded Index form which no longer exists. However, this data could still be useful on the manage view in the future. For now, KEEP the TempData serialization as-is — it does no harm sitting in TempData if the manage view does not read it. The redirect change is the only modification needed.

**NOTE: CRT-01 is already done.** The Create Assessment button on the manage view (Assessment.cshtml line 42) already uses `asp-action="CreateAssessment"` which routes to `/CMP/CreateAssessment`. No changes needed for CRT-01.

**Also update the error path redirect** in the CreateAssessment POST (around line 646-656): When the form submission fails and the error message is set, the action currently does `return View(model)` which renders CreateAssessment.cshtml — this is correct behavior (stay on the create form page to show errors). No change needed for error path.
  </action>
  <verify>
1. Grep CMPController.cs for the exact line: `return RedirectToAction("Assessment", new { view = "manage" });` — should exist in the CreateAssessment POST method
2. Grep CMPController.cs for `RedirectToAction("Index")` — should return ZERO results in the CreateAssessment method (may still exist elsewhere, which is fine)
3. Build: `dotnet build` — no errors
  </verify>
  <done>
After HC submits a new assessment via the CreateAssessment form, they are redirected to `/CMP/Assessment?view=manage` instead of `/CMP/Index`. CRT-01 confirmed already working (Create Assessment button on manage view links to /CMP/CreateAssessment).
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify the full phase success criteria:

1. **NAV-01**: Open Index.cshtml — HC/Admin role gate wraps a "Manage Assessments" card. Workers do not see it.
2. **NAV-02**: The Manage Assessments card's "Manage" button links to `/CMP/Assessment?view=manage`.
3. **NAV-03**: No `<form>` element exists in Index.cshtml. No `createAssessmentForm` ID. No `@section Scripts` block.
4. **CRT-01**: Assessment.cshtml line 42 has `asp-action="CreateAssessment"` (pre-existing, no change).
5. **CRT-02**: CMPController.cs CreateAssessment POST success path has `RedirectToAction("Assessment", new { view = "manage" })`.
6. **Index() controller**: Is `public IActionResult Index()` (sync, no async, no data loading).
7. **Build**: `dotnet build` succeeds with no errors or warnings related to CMP.
</verification>

<success_criteria>
- CMP Index page is clean: 4 nav cards (KKJ, CPDP, Assessment Lobby, Training Records) for workers; 5 cards (+ Manage Assessments) for HC/Admin
- No embedded form exists on CMP Index for any role
- Manage Assessments card has correct links: Create New to /CMP/CreateAssessment, Manage to /CMP/Assessment?view=manage
- CreateAssessment POST redirects to manage view, not Index
- Project builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-navigation-and-creation-flow/13-01-SUMMARY.md`
</output>
