---
phase: "14-bulk-assign"
plan: "01"
type: "execute"
wave: 1
depends_on: []
files_modified:
  - "Controllers/CMPController.cs"
  - "Views/CMP/EditAssessment.cshtml"
autonomous: false
must_haves:
  truths:
    - "EditAssessment page shows a list of currently assigned users (sibling sessions with same Title+Category+Schedule)"
    - "EditAssessment page includes a multi-select user picker to add additional users"
    - "Saving with new users selected creates new AssessmentSessions with identical settings without altering existing sessions"
    - "Users already assigned are excluded from the picker (cannot double-assign)"
  artifacts:
    - path: "Controllers/CMPController.cs"
      provides: "EditAssessment GET loads sibling sessions and user list into ViewBag; POST creates new AssessmentSessions for selected users"
      contains: "ViewBag.AssignedUsers"
    - path: "Views/CMP/EditAssessment.cshtml"
      provides: "Assigned users section and multi-select user picker with section filter and search"
      contains: "NewUserIds"
  key_links:
    - from: "Views/CMP/EditAssessment.cshtml"
      to: "Controllers/CMPController.cs EditAssessment POST"
      via: "form checkboxes named NewUserIds"
      pattern: 'name="NewUserIds"'
    - from: "Controllers/CMPController.cs EditAssessment GET"
      to: "ViewBag.AssignedUsers"
      via: "sibling session query (Title+Category+Schedule match)"
      pattern: "Title.*Category.*Schedule"
    - from: "Controllers/CMPController.cs EditAssessment POST"
      to: "_context.AssessmentSessions.AddRange"
      via: "bulk session creation for NewUserIds"
      pattern: "AddRange"
---

<objective>
Extend the EditAssessment page to support bulk user assignment. HC can see who is currently assigned to an assessment and add more users via a multi-select picker. Saving creates new AssessmentSessions for the newly selected users with identical settings, without modifying existing sessions.

Purpose: Fulfills BLK-01 and BLK-02 -- HC needs to assign additional users to an existing assessment directly from the edit page, rather than recreating assessments from scratch.
Output: Modified CMPController.cs (EditAssessment GET + POST) and EditAssessment.cshtml (assigned users list + picker UI)
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Controllers/CMPController.cs
@Views/CMP/EditAssessment.cshtml
@Views/CMP/CreateAssessment.cshtml
@Models/AssessmentSession.cs
@Models/OrganizationStructure.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend EditAssessment controller actions for bulk assign</name>
  <files>Controllers/CMPController.cs</files>
  <action>
Modify the EditAssessment GET action (around line 209) to:

1. After loading the session by id (existing code), query sibling sessions -- all AssessmentSessions where Title == session.Title AND Category == session.Category AND Schedule.Date == session.Schedule.Date, INCLUDING their User navigation property. Store in a variable `siblingUserIds` (List of string UserId values from siblings).

2. Set `ViewBag.AssignedUsers` to a list of objects with { Id (session id), FullName, Email, Section } built from the sibling sessions' User navigation properties. This shows who is already assigned.

3. Load all users (the existing `ViewBag.Users` query is already there at line 222-225 -- keep it). Also set `ViewBag.Sections = OrganizationStructure.GetAllSections();` (currently NOT set in EditAssessment GET but IS set in CreateAssessment GET -- add it).

4. Set `ViewBag.AssignedUserIds` to the `siblingUserIds` list so the view can exclude them from the picker.

Modify the EditAssessment POST action (around line 235) to:

1. Accept an additional parameter `List<string> NewUserIds` alongside the existing parameters. The signature becomes: `public async Task<IActionResult> EditAssessment(int id, AssessmentSession model, List<string> NewUserIds)`

2. After the existing update-and-save logic (keep ALL existing field update code unchanged), add a new block that handles bulk assignment:
   - Only execute if `NewUserIds != null && NewUserIds.Count > 0`
   - Rate limit: if NewUserIds.Count > 50, set TempData["Error"] and redirect (same pattern as CreateAssessment)
   - Load the SAVED assessment (after update) to get its current field values
   - Query existing sibling sessions (Title+Category+Schedule.Date match) to get already-assigned UserIds
   - Filter NewUserIds to exclude any already-assigned users (prevent duplicates)
   - If filtered list is empty, just continue with the normal redirect (no error needed)
   - Validate all NewUserIds exist in the Users table (prefetch with ToDictionaryAsync, same pattern as CreateAssessment POST line 546-548)
   - Get current user for CreatedBy audit field
   - Create new AssessmentSession objects for each valid new user, copying: Title, Category, Schedule, DurationMinutes, Status, BannerColor, IsTokenRequired, AccessToken, PassPercentage, AllowAnswerReview from the saved assessment. Set Progress = 0, UserId = the new user's id, CreatedBy = currentUser.Id
   - Use `_context.AssessmentSessions.AddRange(newSessions)` and wrap in a transaction (same pattern as CreateAssessment POST lines 592-619)
   - On success, update TempData["Success"] to include the count of newly assigned users: e.g., "Assessment updated. {N} new user(s) assigned."
   - On failure, log error and set TempData["Error"]

3. The redirect at the end stays the same: `RedirectToAction("Assessment", new { view = "manage" })`

IMPORTANT: Do NOT modify the existing field-update logic. The bulk assign block runs AFTER the existing save. Keep existing guard for Completed status. Do NOT remove ModelState handling or any validation.
  </action>
  <verify>
Build the project with `dotnet build` -- no compilation errors. Grep for `ViewBag.AssignedUsers` in CMPController.cs to confirm it exists. Grep for `NewUserIds` in the POST signature. Grep for `AddRange` in the EditAssessment POST to confirm bulk creation logic exists.
  </verify>
  <done>
EditAssessment GET populates ViewBag.AssignedUsers (sibling session users), ViewBag.Users (all users), ViewBag.Sections, and ViewBag.AssignedUserIds. EditAssessment POST accepts NewUserIds parameter and creates new AssessmentSessions for selected users after updating the existing session's fields. Project compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add assigned users list and user picker to EditAssessment view</name>
  <files>Views/CMP/EditAssessment.cshtml</files>
  <action>
Modify EditAssessment.cshtml to add two new sections BELOW the existing form fields but ABOVE the form action buttons (before the `d-flex gap-2 justify-content-end` div around line 213):

**Section A: Currently Assigned Users (read-only display)**

Add a card with header "Currently Assigned Users" (use `border-success` card style with `bg-success text-white` header, icon `bi-people-fill`). Inside:
- If ViewBag.AssignedUsers is not null and has items, render a scrollable table (max-height 250px) with columns: #, Name, Email, Section.
- Each row shows the assigned user's info from ViewBag.AssignedUsers.
- Below the table, show a badge: "{count} user(s) currently assigned"
- If no assigned users, show a muted text: "No users currently assigned to this assessment."

**Section B: Add More Users (multi-select picker)**

Add a card with header "Add More Users" (use `border-warning` card style with `bg-warning text-dark` header, icon `bi-person-plus-fill`). Inside, replicate the user picker pattern from CreateAssessment.cshtml but adapted:

1. Section filter dropdown (same pattern as CreateAssessment lines 89-99):
   - `<select id="sectionFilter">` with "Semua Bagian" default, iterate ViewBag.Sections, plus "__none__" option for "Lainnya (Tanpa Bagian)"

2. Search input (same pattern as CreateAssessment lines 100-105):
   - Text input with id="userSearchInput", clear button

3. Select All / Deselect All buttons + selected count badge (same pattern as CreateAssessment lines 106-108)

4. Scrollable checkbox container (max-height 300px, id="newUserCheckboxContainer"):
   - Iterate ViewBag.Users
   - For each user, check if their Id is in ViewBag.AssignedUserIds -- if YES, skip them (do not render in picker, they are already assigned)
   - For users NOT already assigned, render checkbox with: `name="NewUserIds"` value="@user.Id", label showing FullName + Email
   - Each item has data-name, data-email, data-section attributes for JS filtering

5. Helper text below: "Select users to add to this assessment. Already-assigned users are excluded."

**JavaScript (in the @section Scripts block):**

Add JS below existing scripts to handle the new picker:
- Section filter + search input combined filtering (same logic as CreateAssessment lines 487-518, but targeting `.new-user-check-item` class and `#newUserCheckboxContainer`)
- Select All / Deselect All for visible items only (same pattern)
- Selected count badge update (id="newSelectedCountBadge")

Use class `.new-user-check-item` and `.new-user-checkbox` to distinguish from any other elements. Target the container by id `newUserCheckboxContainer`.

IMPORTANT: The form already has `asp-action="EditAssessment"` and `method="post"`. The checkboxes with `name="NewUserIds"` will automatically be submitted as part of the existing form. Do NOT create a separate form. Keep the existing form structure intact.

IMPORTANT: The existing "Assessment Information" read-only card (lines 72-95) shows "Assigned to: {single user}". Keep it as-is -- it shows the specific session being edited. The new "Currently Assigned Users" section shows ALL users across sibling sessions.
  </action>
  <verify>
Open the file and verify: (1) "Currently Assigned Users" card exists with table markup. (2) "Add More Users" card exists with checkbox container using name="NewUserIds". (3) Section filter, search input, select all/deselect all buttons are present. (4) JavaScript for filtering and count is in the Scripts section. (5) No duplicate form tags -- all new elements are inside the existing form. Build with `dotnet build` to confirm no Razor compilation errors.
  </verify>
  <done>
EditAssessment view displays a read-only list of currently assigned users and a filterable multi-select picker for adding new users. Checkboxes submit as NewUserIds[] alongside the existing form. JS handles section filtering, text search, select all/deselect all, and selected count badge. The view compiles without errors.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify bulk assign flow end-to-end</name>
  <files>Views/CMP/EditAssessment.cshtml</files>
  <action>Human verification of the complete bulk assign feature on EditAssessment page.</action>
  <what-built>
Complete bulk assign feature on EditAssessment page: assigned users display + multi-select picker + backend session creation.
  </what-built>
  <how-to-verify>
1. Run the app and log in as HC or Admin
2. Navigate to Manage Assessments (/CMP/Assessment?view=manage)
3. Click "Edit" on any assessment that has at least one user assigned
4. Verify the EditAssessment page shows:
   a. The existing form fields (Title, Category, Status, etc.) -- unchanged
   b. A "Currently Assigned Users" section showing the user(s) already assigned to this assessment (matched by Title+Category+Schedule)
   c. An "Add More Users" section with a filterable user picker
   d. Already-assigned users are NOT shown in the picker
5. Select 1-2 additional users from the picker
6. Click "Save Changes"
7. Verify you are redirected to the manage view with a success message mentioning the new assignments
8. Click "Edit" on the same assessment again
9. Verify the newly assigned users now appear in the "Currently Assigned Users" list
10. Verify those users are no longer shown in the "Add More Users" picker
11. Verify the original assessment's settings (Title, Category, etc.) were not altered
  </how-to-verify>
  <verify>User confirms the feature works as expected.</verify>
  <done>User types "approved" confirming the bulk assign flow works end-to-end.</done>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `dotnet build` compiles without errors
2. EditAssessment GET loads ViewBag.AssignedUsers, ViewBag.Users, ViewBag.Sections, ViewBag.AssignedUserIds
3. EditAssessment POST accepts NewUserIds parameter and creates new AssessmentSessions
4. View shows assigned users table and user picker with filtering
5. New sessions are created with identical settings (Title, Category, Schedule, DurationMinutes, Status, PassPercentage, AllowAnswerReview, IsTokenRequired, AccessToken, BannerColor)
6. Existing sessions are never modified by the bulk assign operation
7. Already-assigned users are excluded from the picker
</verification>

<success_criteria>
- BLK-01 satisfied: Edit Assessment form includes a section to add more users to an existing assessment
- BLK-02 satisfied: Edit Assessment form shows currently assigned users alongside a picker for selecting additional ones; saving creates new AssessmentSessions with the same settings
- Phase 14 success criteria met: (1) assigned users visible, (2) picker allows selection, (3) new sessions created without altering existing ones
</success_criteria>

<output>
After completion, create `.planning/phases/14-bulk-assign/14-01-SUMMARY.md`
</output>
