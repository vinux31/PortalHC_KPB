---
phase: "15-quick-edit"
plan: "01"
type: "execute"
wave: 1
depends_on: []
files_modified:
  - "Controllers/CMPController.cs"
  - "Views/CMP/Assessment.cshtml"
autonomous: false
must_haves:
  truths:
    - "HC can change an assessment's status (Open, Upcoming, Completed) directly from the manage view card"
    - "HC can change an assessment's scheduled date directly from the manage view card"
    - "Both edits take effect immediately on ALL sibling sessions without visiting the full Edit page"
  artifacts:
    - path: "Controllers/CMPController.cs"
      provides: "QuickEdit POST action"
      contains: "public async Task<IActionResult> QuickEdit"
    - path: "Views/CMP/Assessment.cshtml"
      provides: "Quick Edit button on each manage card + Bootstrap modal with status/schedule fields"
      contains: "quickEditModal"
  key_links:
    - from: "Views/CMP/Assessment.cshtml"
      to: "/CMP/QuickEdit"
      via: "$.ajax POST from quickEditModal submit handler"
      pattern: "CMP/QuickEdit"
    - from: "Controllers/CMPController.cs QuickEdit"
      to: "AssessmentSessions"
      via: "sibling query (Title+Category+Schedule.Date) then bulk update Status+Schedule"
      pattern: "Title == rep.Title"
---

<objective>
Add inline Quick Edit capability to the assessment manage view: a "Quick Edit" button on each card opens a Bootstrap modal pre-populated with current status and schedule date. Saving posts to a new QuickEdit action that updates ALL sibling sessions (same Title+Category+Schedule.Date group), then reloads the page.

Purpose: HC can change status and reschedule assessments without navigating to the full Edit page. Satisfies QED-01 and QED-02.
Output: Working QuickEdit POST action + inline modal on manage view.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Controllers/CMPController.cs
@Views/CMP/Assessment.cshtml
@Models/AssessmentSession.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add QuickEdit POST action to CMPController</name>
  <files>Controllers/CMPController.cs</files>
  <action>
Add a new POST action `QuickEdit` to CMPController, placed after the `DeleteAssessmentGroup` action (around line 567) and before `RegenerateToken`. The action follows the exact same sibling-lookup pattern used by `DeleteAssessmentGroup`.

Signature:
```csharp
[HttpPost]
[Authorize(Roles = "Admin, HC")]
[ValidateAntiForgeryToken]
public async Task<IActionResult> QuickEdit(int representativeId, string status, DateTime schedule)
```

Implementation:
1. Get logger via `HttpContext.RequestServices.GetRequiredService<ILogger<CMPController>>()` (same pattern as DeleteAssessmentGroup).
2. Wrap in try/catch returning `Json(new { success = false, message = ... })` on error.
3. Load representative session: `await _context.AssessmentSessions.FirstOrDefaultAsync(a => a.Id == representativeId)`. If null, return JSON error.
4. Validate `status` is one of "Open", "Upcoming", "Completed" — if not, return JSON error "Invalid status value."
5. Store the representative's ORIGINAL `Schedule.Date` before any changes (needed for sibling lookup since the schedule is about to change).
6. Find all siblings: query `_context.AssessmentSessions.Where(a => a.Title == rep.Title && a.Category == rep.Category && a.Schedule.Date == originalScheduleDate)` and `.ToListAsync()`.
7. Loop through all siblings: set `a.Status = status`, `a.Schedule = schedule`, `a.UpdatedAt = DateTime.UtcNow`.
8. `await _context.SaveChangesAsync()`.
9. Log success with sibling count.
10. Return `Json(new { success = true, message = $"Assessment '{rep.Title}' updated: Status = {status}, Schedule = {schedule:dd MMM yyyy}. {siblings.Count} session(s) affected." })`.

Do NOT wrap in a transaction — this is a simple field update on existing rows, not a multi-table insert. Matches the simplicity of RegenerateToken, not the transactional pattern of bulk assign.

Do NOT validate schedule date (no past-date check) — HC may legitimately backdate assessments. Keep it simple.
  </action>
  <verify>
Run `dotnet build` in the project root. Confirm zero CS errors. Grep for `public async Task<IActionResult> QuickEdit` in CMPController.cs to confirm the action exists.
  </verify>
  <done>QuickEdit POST action exists on CMPController, accepts representativeId + status + schedule, updates all sibling sessions, returns JSON success/fail. Build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Add Quick Edit button and modal to manage view</name>
  <files>Views/CMP/Assessment.cshtml</files>
  <action>
Three changes to Assessment.cshtml:

**A. Add "Quick Edit" button to each manage card:**
In the Management Actions section of each card (around line 240-259), add a Quick Edit button in the FIRST button row (alongside Edit and Questions). Insert it between the Edit and Questions buttons:

```html
<button class="btn btn-sm btn-outline-success flex-fill"
        onclick="openQuickEditModal(@group.RepresentativeId, '@Html.Raw(((string)group.Title).Replace("'", "\\'"))', '@group.Status', '@((DateTime)group.Schedule).ToString("yyyy-MM-dd")')">
    <i class="bi bi-lightning"></i> Quick Edit
</button>
```

This means the first row will have 3 buttons (Edit, Quick Edit, Questions) and the second row keeps Regen Token + Delete. Adjust `flex-fill` on all — the three-button row works fine with Bootstrap flex.

**B. Add Bootstrap modal for Quick Edit (after the existing tokenModal, before the `<style>` block, around line 617):**

```html
<!-- Quick Edit Modal -->
<div class="modal fade" id="quickEditModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title fw-bold"><i class="bi bi-lightning me-2"></i>Quick Edit</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body py-4">
                <h6 class="fw-bold mb-3" id="quickEditTitle"></h6>
                <input type="hidden" id="quickEditRepId" />

                <div class="alert alert-danger small d-none mb-3" id="quickEditError"></div>

                <div class="mb-3">
                    <label for="quickEditStatus" class="form-label fw-semibold">Status</label>
                    <select id="quickEditStatus" class="form-select">
                        <option value="Open">Open</option>
                        <option value="Upcoming">Upcoming</option>
                        <option value="Completed">Completed</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="quickEditSchedule" class="form-label fw-semibold">Schedule</label>
                    <input type="date" id="quickEditSchedule" class="form-control" />
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-link text-decoration-none text-muted" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="btnQuickEditSave" class="btn btn-success px-4 fw-bold" onclick="submitQuickEdit()">
                    <i class="bi bi-check-lg me-1"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>
```

**C. Add JS functions in the `@section Scripts` block (inside the existing `<script>` tag, after the `confirmDelete` function, before the closing `</script>`):**

```javascript
// ========== QUICK EDIT FUNCTIONS ==========

var quickEditModalObj;

function openQuickEditModal(representativeId, title, currentStatus, currentSchedule) {
    document.getElementById('quickEditRepId').value = representativeId;
    document.getElementById('quickEditTitle').innerText = title;
    document.getElementById('quickEditStatus').value = currentStatus;
    document.getElementById('quickEditSchedule').value = currentSchedule;
    document.getElementById('quickEditError').classList.add('d-none');

    var modalEl = document.getElementById('quickEditModal');
    quickEditModalObj = new bootstrap.Modal(modalEl);
    quickEditModalObj.show();
}

function submitQuickEdit() {
    var repId = document.getElementById('quickEditRepId').value;
    var status = document.getElementById('quickEditStatus').value;
    var schedule = document.getElementById('quickEditSchedule').value;
    var errorEl = document.getElementById('quickEditError');
    var saveBtn = document.getElementById('btnQuickEditSave');

    // Basic validation
    if (!schedule) {
        errorEl.innerText = 'Please select a schedule date.';
        errorEl.classList.remove('d-none');
        return;
    }

    // Loading state
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Saving...';
    errorEl.classList.add('d-none');

    var token = $('input[name="__RequestVerificationToken"]').val();

    $.ajax({
        url: '/CMP/QuickEdit',
        type: 'POST',
        data: {
            representativeId: repId,
            status: status,
            schedule: schedule,
            __RequestVerificationToken: token
        },
        success: function(response) {
            if (response.success) {
                location.reload();
            } else {
                errorEl.innerText = response.message || 'Update failed.';
                errorEl.classList.remove('d-none');
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="bi bi-check-lg me-1"></i> Save Changes';
            }
        },
        error: function(xhr, status, error) {
            errorEl.innerText = 'Server error: ' + (xhr.responseText || error);
            errorEl.classList.remove('d-none');
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="bi bi-check-lg me-1"></i> Save Changes';
        }
    });
}
```

Note on the onclick for the Quick Edit button: the title must be JS-safe. Use `@Html.Raw(((string)group.Title).Replace("'", "\\'"))` to escape single quotes. The schedule uses `yyyy-MM-dd` format which is the native format for `<input type="date">`.
  </action>
  <verify>
Run `dotnet build` in the project root. Confirm zero CS/Razor errors. Visually inspect that the Quick Edit button appears in the manage card button area by searching for `openQuickEditModal` in Assessment.cshtml. Confirm the modal HTML contains `quickEditModal` id. Confirm the JS function `submitQuickEdit` exists.
  </verify>
  <done>Each manage view card has a "Quick Edit" button. Clicking it opens a modal with Status dropdown (Open/Upcoming/Completed) and Schedule date picker, pre-populated with current values. Saving posts to /CMP/QuickEdit and reloads the page on success.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify Quick Edit flow end-to-end</name>
  <files>Views/CMP/Assessment.cshtml</files>
  <action>Human verification of the complete Quick Edit feature on the manage view.</action>
  <what-built>Complete Quick Edit flow: "Quick Edit" button on each manage view card, Bootstrap modal with Status + Schedule fields, QuickEdit POST action updating all sibling sessions, page reload on success.</what-built>
  <how-to-verify>
    1. Navigate to /CMP/Assessment?view=manage (login as HC or Admin)
    2. On any assessment card, confirm you see a green "Quick Edit" button alongside Edit and Questions
    3. Click "Quick Edit" — confirm a modal opens with the assessment title, a Status dropdown (pre-selected to current status), and a Schedule date picker (pre-populated with current date)
    4. Change the status (e.g., from "Open" to "Upcoming") and/or change the schedule date
    5. Click "Save Changes" — confirm spinner appears briefly, then page reloads
    6. Verify the card now shows the updated status and schedule date
    7. (Optional) Click "Edit" on the same assessment to confirm all sibling sessions have the updated values in the full Edit page
    8. Test error case: open Quick Edit, clear the date field, click Save — confirm error message appears
  </how-to-verify>
  <verify>User confirms the feature works as expected.</verify>
  <done>User types "approved" confirming the Quick Edit flow works end-to-end.</done>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- `dotnet build` passes with zero errors
- CMPController.cs contains `QuickEdit` POST action with `[Authorize(Roles = "Admin, HC")]`
- Assessment.cshtml contains Quick Edit button, quickEditModal, and submitQuickEdit JS function
- Quick Edit modal pre-populates with current status + schedule from the card
- Saving updates all sibling sessions (same Title+Category+Schedule.Date group)
- Page reloads after successful save showing updated values
</verification>

<success_criteria>
- QED-01: HC can change an assessment's status directly from the manage view card without navigating to full Edit page
- QED-02: HC can reschedule an assessment directly from the manage view card
- Both edits affect all sibling sessions (Title+Category+Schedule.Date group) simultaneously
- Full page reload confirms changes are persisted
</success_criteria>

<output>
After completion, create `.planning/phases/15-quick-edit/15-01-SUMMARY.md`
</output>
