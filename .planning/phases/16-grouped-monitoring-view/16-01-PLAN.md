---
phase: 16-grouped-monitoring-view
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - Models/AssessmentMonitoringViewModel.cs
  - Controllers/CMPController.cs
autonomous: true

must_haves:
  truths:
    - "MonitorData in ViewBag is a grouped list (one item per Title+Category+Schedule.Date), not a flat per-user list"
    - "Each monitoring group carries TotalCount, CompletedCount, PassedCount, and a Sessions list for the detail page"
    - "Monitoring data includes Open, Upcoming, and Completed sessions closed within the last 30 days"
    - "AssessmentMonitoringDetail GET action exists and returns all sessions for a given Title+Category+ScheduleDate group"
    - "Groups are sorted: Open/Upcoming soonest-first, Closed most-recent-first"
  artifacts:
    - path: "Models/AssessmentMonitoringViewModel.cs"
      provides: "MonitoringGroupViewModel and MonitoringSessionViewModel classes"
      contains: "MonitoringGroupViewModel"
    - path: "Controllers/CMPController.cs"
      provides: "Updated Assessment() monitor query + new AssessmentMonitoringDetail() GET action"
      contains: "AssessmentMonitoringDetail"
  key_links:
    - from: "Controllers/CMPController.cs (Assessment action)"
      to: "Models/AssessmentMonitoringViewModel.cs"
      via: "ViewBag.MonitorData populated as List<MonitoringGroupViewModel>"
      pattern: "MonitoringGroupViewModel"
    - from: "Controllers/CMPController.cs (AssessmentMonitoringDetail action)"
      to: "_context.AssessmentSessions"
      via: "EF query filtered by title + category + scheduleDate.Date"
      pattern: "AssessmentMonitoringDetail"
---

<objective>
Build the server-side foundation for grouped assessment monitoring: a ViewModel class representing one monitoring group, updated query logic in Assessment() to include recently-closed sessions and produce grouped data, and a new AssessmentMonitoringDetail() GET action for the detail page.

Purpose: Plans 02 and 03 depend on this data shape. The monitoring tab view and detail page cannot be built until the controller emits grouped data and the detail action exists.
Output: Models/AssessmentMonitoringViewModel.cs (new), Controllers/CMPController.cs (updated monitor query + new action)
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Controllers/CMPController.cs
@Models/AssessmentSession.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MonitoringGroupViewModel and MonitoringSessionViewModel</name>
  <files>Models/AssessmentMonitoringViewModel.cs</files>
  <action>
Create a new file `Models/AssessmentMonitoringViewModel.cs` in namespace `HcPortal.Models` with two classes:

```csharp
namespace HcPortal.Models
{
    public class MonitoringGroupViewModel
    {
        public string Title { get; set; } = "";
        public string Category { get; set; } = "";
        public DateTime Schedule { get; set; }          // representative Schedule (with time)
        public string GroupStatus { get; set; } = "";   // "Open", "Upcoming", or "Closed"
        public int TotalCount { get; set; }             // all sessions in this group
        public int CompletedCount { get; set; }         // sessions where IsCompleted == true
        public int PassedCount { get; set; }            // sessions where IsPassed == true
        public List<MonitoringSessionViewModel> Sessions { get; set; } = new();
    }

    public class MonitoringSessionViewModel
    {
        public int Id { get; set; }
        public string UserFullName { get; set; } = "";
        public string UserNIP { get; set; } = "";
        public string UserStatus { get; set; } = "";    // "Not started" or "Completed"
        public int? Score { get; set; }
        public bool? IsPassed { get; set; }
        public DateTime? CompletedAt { get; set; }
    }
}
```

Derivation rules (applied in controller, not here — just documenting for reference):
- IsCompleted = session.Score != null || session.CompletedAt != null
- UserStatus = IsCompleted ? "Completed" : "Not started"
- GroupStatus: if any session is "Open" → "Open"; else if any is "Upcoming" → "Upcoming"; else → "Closed"
  </action>
  <verify>File exists at Models/AssessmentMonitoringViewModel.cs and `dotnet build` produces no CS errors referencing this file.</verify>
  <done>MonitoringGroupViewModel and MonitoringSessionViewModel are defined with correct properties; project builds without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Update Assessment() monitor query and add AssessmentMonitoringDetail GET action</name>
  <files>Controllers/CMPController.cs</files>
  <action>
Two changes to CMPController.cs, both within the `view == "manage" && isHCAccess` branch:

**Change 1 — Replace the existing monitorData query** (currently lines ~171-177, the block that builds `ViewBag.MonitorData` as a flat `List<AssessmentSession>`):

Replace:
```csharp
var monitorData = await _context.AssessmentSessions
    .Include(a => a.User)
    .Where(a => a.Status == "Open" || a.Status == "Upcoming")
    .OrderBy(a => a.Schedule)
    .ToListAsync();
ViewBag.MonitorData = monitorData;
```

With (using `MonitoringGroupViewModel` from `HcPortal.Models`):
```csharp
var cutoff = DateTime.UtcNow.AddDays(-30);
var monitorSessions = await _context.AssessmentSessions
    .Include(a => a.User)
    .Where(a => a.Status == "Open"
             || a.Status == "Upcoming"
             || (a.Status == "Completed" && a.CompletedAt != null && a.CompletedAt >= cutoff))
    .ToListAsync();

var monitorGroups = monitorSessions
    .GroupBy(a => (a.Title, a.Category, a.Schedule.Date))
    .Select(g =>
    {
        var sessions = g.Select(a =>
        {
            bool isCompleted = a.Score != null || a.CompletedAt != null;
            return new MonitoringSessionViewModel
            {
                Id           = a.Id,
                UserFullName = a.User?.FullName ?? "Unknown",
                UserNIP      = a.User?.NIP ?? "",
                UserStatus   = isCompleted ? "Completed" : "Not started",
                Score        = a.Score,
                IsPassed     = a.IsPassed,
                CompletedAt  = a.CompletedAt
            };
        }).ToList();

        // GroupStatus: Open > Upcoming > Closed (priority order)
        bool hasOpen     = g.Any(a => a.Status == "Open");
        bool hasUpcoming = g.Any(a => a.Status == "Upcoming");
        string groupStatus = hasOpen ? "Open" : hasUpcoming ? "Upcoming" : "Closed";

        int completedCount = sessions.Count(s => s.UserStatus == "Completed");
        int passedCount    = sessions.Count(s => s.IsPassed == true);

        return new MonitoringGroupViewModel
        {
            Title          = g.Key.Title,
            Category       = g.Key.Category,
            Schedule       = g.First().Schedule,
            GroupStatus    = groupStatus,
            TotalCount     = sessions.Count,
            CompletedCount = completedCount,
            PassedCount    = passedCount,
            Sessions       = sessions
        };
    })
    // Sort: Open/Upcoming soonest-first; Closed most-recent-first
    .OrderBy(g => g.GroupStatus == "Closed" ? 1 : 0)
    .ThenBy(g => g.GroupStatus != "Closed" ? g.Schedule : DateTime.MaxValue)
    .ThenByDescending(g => g.GroupStatus == "Closed" ? g.Schedule : DateTime.MinValue)
    .ToList();

ViewBag.MonitorData = monitorGroups;
```

**Change 2 — Add new AssessmentMonitoringDetail GET action** after the Assessment() action (before EditAssessment or at end of Assessment region):

```csharp
[HttpGet]
[Authorize(Roles = "Admin, HC")]
public async Task<IActionResult> AssessmentMonitoringDetail(string title, string category, DateTime scheduleDate)
{
    var sessions = await _context.AssessmentSessions
        .Include(a => a.User)
        .Where(a => a.Title == title
                 && a.Category == category
                 && a.Schedule.Date == scheduleDate.Date)
        .ToListAsync();

    if (!sessions.Any())
    {
        TempData["Error"] = "Assessment group not found.";
        return RedirectToAction("Assessment", new { view = "manage" });
    }

    var sessionViewModels = sessions.Select(a =>
    {
        bool isCompleted = a.Score != null || a.CompletedAt != null;
        return new MonitoringSessionViewModel
        {
            Id           = a.Id,
            UserFullName = a.User?.FullName ?? "Unknown",
            UserNIP      = a.User?.NIP ?? "",
            UserStatus   = isCompleted ? "Completed" : "Not started",
            Score        = a.Score,
            IsPassed     = a.IsPassed,
            CompletedAt  = a.CompletedAt
        };
    })
    .OrderBy(s => s.UserStatus)   // Not started before Completed
    .ThenBy(s => s.UserFullName)
    .ToList();

    var model = new MonitoringGroupViewModel
    {
        Title    = title,
        Category = category,
        Schedule = sessions.First().Schedule,
        Sessions = sessionViewModels,
        TotalCount     = sessionViewModels.Count,
        CompletedCount = sessionViewModels.Count(s => s.UserStatus == "Completed"),
        PassedCount    = sessionViewModels.Count(s => s.IsPassed == true),
        GroupStatus    = sessions.Any(a => a.Status == "Open") ? "Open"
                       : sessions.Any(a => a.Status == "Upcoming") ? "Upcoming" : "Closed"
    };

    ViewBag.BackUrl = Url.Action("Assessment", "CMP", new { view = "manage" });
    return View(model);
}
```

Add `using HcPortal.Models;` if not already present at the top (it is — check before adding).
  </action>
  <verify>
1. `dotnet build` produces 0 errors.
2. Navigate to `/CMP/Assessment?view=manage` — no runtime exceptions on the monitoring tab.
3. Confirm `ViewBag.MonitorData` is cast correctly by checking the monitoring tab renders without crash (view will still show old flat table — that's fixed in Plan 02).
  </verify>
  <done>
- Assessment() action emits `ViewBag.MonitorData` as `List&lt;MonitoringGroupViewModel&gt;` (not `List&lt;AssessmentSession&gt;`)
- AssessmentMonitoringDetail GET action exists, returns 200 when called with valid title/category/scheduleDate
- Project builds without errors
  </done>
</task>

</tasks>

<verification>
- `dotnet build` — 0 errors, 0 warnings about MonitoringGroupViewModel
- `Models/AssessmentMonitoringViewModel.cs` exists with both classes
- `Controllers/CMPController.cs` contains `AssessmentMonitoringDetail` action with `[Authorize(Roles = "Admin, HC")]`
- `ViewBag.MonitorData` assignment in Assessment() now uses `List<MonitoringGroupViewModel>` (grep confirms: `MonitoringGroupViewModel`)
- Cutoff logic: `DateTime.UtcNow.AddDays(-30)` for recently-closed sessions
</verification>

<success_criteria>
- MonitoringGroupViewModel and MonitoringSessionViewModel defined in Models/
- Assessment() monitor query includes Completed sessions within last 30 days
- Groups sorted: Open/Upcoming soonest-first, Closed most-recent-first
- AssessmentMonitoringDetail() GET action is authorized HC/Admin only, fetches by title+category+scheduleDate.Date, redirects with TempData["Error"] if group not found
- dotnet build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/16-grouped-monitoring-view/16-01-SUMMARY.md`
</output>
