---
phase: 16-grouped-monitoring-view
plan: "02"
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - Views/CMP/Assessment.cshtml
autonomous: true

must_haves:
  truths:
    - "Monitoring tab shows one table row per assessment group, not one row per user session"
    - "Each row shows a Bootstrap progress bar labeled 'X/Y completed'"
    - "Each row shows a pass rate indicator 'Z passed (N%)' — N% is based on completed sessions only"
    - "Each row has a 'View Details' link that navigates to /CMP/AssessmentMonitoringDetail"
    - "Empty state message reads 'No active, upcoming, or recently closed assessments' when monitorGroups is empty"
  artifacts:
    - path: "Views/CMP/Assessment.cshtml"
      provides: "Grouped monitoring tab with progress bar, pass rate, and View Details link per row"
      contains: "MonitoringGroupViewModel"
  key_links:
    - from: "Views/CMP/Assessment.cshtml (monitoring tab)"
      to: "/CMP/AssessmentMonitoringDetail"
      via: "Url.Action('AssessmentMonitoringDetail', 'CMP', new { title, category, scheduleDate })"
      pattern: "AssessmentMonitoringDetail"
---

<objective>
Replace the flat per-user monitoring table in Assessment.cshtml with a grouped summary table. Each row represents one assessment group (Title + Category + Schedule.Date) and shows a Bootstrap progress bar (X/Y completed), pass rate (Z passed N%), group status badge, and a "View Details" link.

Purpose: MON-01, MON-02, MON-03, MON-04, MON-06 are satisfied by this view update. The monitoring tab becomes useful for HC at a glance.
Output: Views/CMP/Assessment.cshtml — monitor tab pane replaced with grouped table
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Views/CMP/Assessment.cshtml
@.planning/phases/16-grouped-monitoring-view/16-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace flat monitor table with grouped summary table</name>
  <files>Views/CMP/Assessment.cshtml</files>
  <action>
In Assessment.cshtml, locate the `<!-- Monitoring Tab Pane -->` section (currently inside `<div class="tab-pane fade" id="monitor-tab-pane">`). Replace its entire contents with the grouped table below.

**Old code to replace** (the monitorData cast and everything inside the tab pane div):

```razor
var monitorData = ViewBag.MonitorData as List<HcPortal.Models.AssessmentSession> ?? new List<HcPortal.Models.AssessmentSession>();
```
(This cast is in the outer `@if (viewMode == "manage" && canManage)` block — update it too.)

**Step 1 — Update the cast near the top of the manage block** (where monitorData is currently cast):

Change:
```razor
var monitorData = ViewBag.MonitorData as List<HcPortal.Models.AssessmentSession> ?? new List<HcPortal.Models.AssessmentSession>();
```

To:
```razor
var monitorGroups = ViewBag.MonitorData as List<HcPortal.Models.MonitoringGroupViewModel> ?? new List<HcPortal.Models.MonitoringGroupViewModel>();
```

Also update the badge count on the Monitoring tab button:
```razor
<span class="badge bg-secondary ms-1">@monitorGroups.Count</span>
```

**Step 2 — Replace the monitor tab pane body** (inside `<div class="tab-pane fade" id="monitor-tab-pane" role="tabpanel">`):

```razor
<!-- Monitoring Tab Pane -->
<div class="tab-pane fade" id="monitor-tab-pane" role="tabpanel">
    @if (monitorGroups.Count == 0)
    {
        <div class="text-center py-5">
            <i class="bi bi-binoculars text-muted mb-3" style="font-size: 4rem;"></i>
            <h5 class="text-muted">No active, upcoming, or recently closed assessments</h5>
            <p class="text-muted small">Closed assessments older than 30 days are not shown.</p>
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Assessment</th>
                        <th>Schedule</th>
                        <th>Status</th>
                        <th>Completion</th>
                        <th>Pass Rate</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var group in monitorGroups)
                    {
                        var catBadgeClass = (string)group.Category switch
                        {
                            "OJT"                     => "bg-primary",
                            "IHT"                     => "bg-success",
                            "Training Licencor"        => "bg-danger",
                            "OTS"                     => "bg-warning text-dark",
                            "Mandatory HSSE Training"  => "bg-info",
                            "Proton"                  => "bg-purple",
                            _                         => "bg-secondary"
                        };
                        var statusBadgeClass = group.GroupStatus switch
                        {
                            "Open"     => "bg-success",
                            "Upcoming" => "bg-warning text-dark",
                            "Closed"   => "bg-secondary",
                            _          => "bg-secondary"
                        };

                        int completedPct = group.TotalCount > 0
                            ? (int)Math.Round(group.CompletedCount * 100.0 / group.TotalCount)
                            : 0;

                        int passRatePct = group.CompletedCount > 0
                            ? (int)Math.Round(group.PassedCount * 100.0 / group.CompletedCount)
                            : 0;

                        <tr>
                            <td>
                                <div class="fw-semibold">@group.Title</div>
                                <div class="mt-1">
                                    <span class="badge @catBadgeClass small">@group.Category</span>
                                </div>
                            </td>
                            <td class="text-nowrap">@group.Schedule.ToString("dd MMM yyyy")</td>
                            <td>
                                <span class="badge @statusBadgeClass">@group.GroupStatus</span>
                            </td>
                            <td style="min-width: 160px;">
                                <div class="d-flex align-items-center gap-2">
                                    <div class="progress flex-grow-1" style="height: 8px;" title="@group.CompletedCount of @group.TotalCount completed">
                                        <div class="progress-bar @(completedPct == 100 ? "bg-success" : "bg-primary")"
                                             role="progressbar"
                                             style="width: @completedPct%"
                                             aria-valuenow="@completedPct"
                                             aria-valuemin="0"
                                             aria-valuemax="100">
                                        </div>
                                    </div>
                                    <span class="text-muted small text-nowrap">@group.CompletedCount/@group.TotalCount</span>
                                </div>
                            </td>
                            <td class="text-nowrap">
                                @if (group.CompletedCount == 0)
                                {
                                    <span class="text-muted small">—</span>
                                }
                                else
                                {
                                    var passRateBadge = passRatePct >= 70 ? "text-success" : "text-danger";
                                    <span class="@passRateBadge fw-semibold small">@group.PassedCount passed (@passRatePct%)</span>
                                }
                            </td>
                            <td class="text-end">
                                <a href="@Url.Action("AssessmentMonitoringDetail", "CMP", new { title = group.Title, category = group.Category, scheduleDate = group.Schedule.Date })"
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-eye me-1"></i>View Details
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>
```

Note on pass rate color threshold: 70% is used as the green/red boundary because `PassPercentage` is 70 by default — this is a display heuristic only, not enforced against each group's PassPercentage config.
  </action>
  <verify>
1. `dotnet build` — 0 errors.
2. Navigate to `/CMP/Assessment?view=manage` as HC/Admin — monitoring tab shows a table with group rows (not per-user rows).
3. Confirm each row has a progress bar and a "View Details" button.
4. If no groups exist, confirm the empty state message appears instead of a blank tab.
  </verify>
  <done>
- Monitoring tab renders one row per assessment group (Title+Category+Schedule.Date)
- Each row shows a Bootstrap progress bar with "X/Y" label
- Each row shows pass rate ("Z passed N%") or em-dash when no completions
- "View Details" button links to AssessmentMonitoringDetail with correct route values
- Empty state shows when no groups are present
- Project builds without errors
  </done>
</task>

</tasks>

<verification>
- `dotnet build` — 0 errors
- Monitor tab renders group rows, not per-user rows
- `ViewBag.MonitorData` cast uses `List<HcPortal.Models.MonitoringGroupViewModel>` (not AssessmentSession)
- Progress bar visible per row with correct percentage math
- "View Details" link URL format: `/CMP/AssessmentMonitoringDetail?title=...&category=...&scheduleDate=...`
</verification>

<success_criteria>
- MON-01: One row per assessment group in monitoring tab
- MON-02: Progress bar with "X/Y completed" count per row
- MON-03: Pass rate "Z passed (N%)" per row, dashes when no completions
- MON-06: Groups sorted by schedule date (soonest-first for active, most-recent-first for closed — handled server-side in Plan 01)
- Empty state message correct for the expanded scope (includes recently closed)
</success_criteria>

<output>
After completion, create `.planning/phases/16-grouped-monitoring-view/16-02-SUMMARY.md`
</output>
