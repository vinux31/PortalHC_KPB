---
phase: 17-question-and-exam-ux-improvements
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - Models/AssessmentPackage.cs
  - Models/UserPackageAssignment.cs
  - Data/ApplicationDbContext.cs
  - Migrations/
autonomous: true

must_haves:
  truths:
    - "AssessmentPackage, PackageQuestion, PackageOption, and UserPackageAssignment tables exist in the database after migration"
    - "Each AssessmentSession can have 1-N packages; each package has its own questions and answer options"
    - "UserPackageAssignment stores the assigned package ID and the per-user shuffled question/option order as JSON"
  artifacts:
    - path: "Models/AssessmentPackage.cs"
      provides: "AssessmentPackage, PackageQuestion, PackageOption entity classes"
      contains: "class AssessmentPackage"
    - path: "Models/UserPackageAssignment.cs"
      provides: "UserPackageAssignment entity with ShuffledQuestionOrder and ShuffledOptionOrders JSON fields"
      contains: "class UserPackageAssignment"
    - path: "Data/ApplicationDbContext.cs"
      provides: "DbSets for all four new entities"
      contains: "AssessmentPackages"
  key_links:
    - from: "Models/AssessmentPackage.cs"
      to: "Models/AssessmentSession.cs"
      via: "FK AssessmentSessionId on AssessmentPackage"
      pattern: "AssessmentSessionId"
    - from: "Models/UserPackageAssignment.cs"
      to: "Models/AssessmentPackage.cs"
      via: "FK AssessmentPackageId on UserPackageAssignment"
      pattern: "AssessmentPackageId"
    - from: "Data/ApplicationDbContext.cs"
      to: "Migrations/"
      via: "dotnet ef migrations add + database update"
      pattern: "AddPackageSystem"
---

<objective>
Introduce the test package data layer: new entities for packages, package questions, package options, and per-user package assignments with shuffled order persistence.

Purpose: All exam features in Phase 17 depend on this foundation — packages must exist before HC can manage them and before users can be assigned one.
Output: Four new model classes, DbContext registrations, and an applied EF Core migration.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Models/AssessmentSession.cs
@Models/AssessmentQuestion.cs
@Models/UserResponse.cs
@Data/ApplicationDbContext.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AssessmentPackage, PackageQuestion, PackageOption models</name>
  <files>Models/AssessmentPackage.cs</files>
  <action>
Create `Models/AssessmentPackage.cs` with three classes:

**AssessmentPackage:**
- `int Id` (key)
- `int AssessmentSessionId` + `[ForeignKey]` nav to `AssessmentSession` (DeleteBehavior.Cascade)
- `string PackageName = ""` — e.g., "Paket A", "Paket B", "Paket C"
- `int PackageNumber` — 1, 2, 3 (for ordering display)
- `DateTime CreatedAt = DateTime.UtcNow`
- Nav: `ICollection<PackageQuestion> Questions = new List<>()`

**PackageQuestion:**
- `int Id` (key)
- `int AssessmentPackageId` + `[ForeignKey]` nav to `AssessmentPackage` (Cascade)
- `string QuestionText = ""`
- `int Order` — original import order; used as stable sort key
- `int ScoreValue = 10`
- Nav: `ICollection<PackageOption> Options = new List<>()`

**PackageOption:**
- `int Id` (key)
- `int PackageQuestionId` + `[ForeignKey]` nav to `PackageQuestion` (Cascade)
- `string OptionText = ""`
- `bool IsCorrect` — the correct answer key for this option

NOTE: Do NOT add a Letter field (A/B/C/D). Letters are display-only, assigned at render time based on shuffled position. Grading uses `PackageOption.Id`.
  </action>
  <verify>File compiles: `dotnet build` returns 0 errors after creation.</verify>
  <done>Models/AssessmentPackage.cs exists with all three classes and correct FK attributes; project builds.</done>
</task>

<task type="auto">
  <name>Task 2: Create UserPackageAssignment model and register all new entities in DbContext</name>
  <files>Models/UserPackageAssignment.cs, Data/ApplicationDbContext.cs</files>
  <action>
**Models/UserPackageAssignment.cs:**

Create with these fields:
- `int Id` (key)
- `int AssessmentSessionId` + `[ForeignKey]` nav to `AssessmentSession` (Cascade). Add unique index hint: one assignment per session.
- `int AssessmentPackageId` + `[ForeignKey]` nav to `AssessmentPackage` (Restrict — don't cascade delete assignments when package deleted, since package might be deleted after exam)
- `string UserId = ""` — string FK (no nav property, consistent with codebase pattern — see Phase 6 decision: "String IDs (no FK)")
- `string ShuffledQuestionIds = "[]"` — JSON array of PackageQuestion.Id in display order, e.g. `[42, 17, 33, ...]`. Use `System.Text.Json` to serialize/deserialize. Represents per-user question shuffle.
- `string ShuffledOptionIdsPerQuestion = "{}"` — JSON dictionary mapping `PackageQuestion.Id` (as string key) to ordered array of `PackageOption.Id`, e.g. `{"42": [101, 103, 102, 104], "17": [...], ...}`. Represents per-user option shuffle per question.
- `DateTime AssignedAt = DateTime.UtcNow`
- `bool IsCompleted = false` — set true on SubmitExam

Add two helper methods (not mapped to DB — mark with `[NotMapped]`):
- `List<int> GetShuffledQuestionIds()` — deserializes `ShuffledQuestionIds`
- `Dictionary<int, List<int>> GetShuffledOptionIds()` — deserializes `ShuffledOptionIdsPerQuestion`

**Data/ApplicationDbContext.cs:**

Add four new DbSets after the existing assessment DbSets:
```csharp
public DbSet<AssessmentPackage> AssessmentPackages { get; set; }
public DbSet<PackageQuestion> PackageQuestions { get; set; }
public DbSet<PackageOption> PackageOptions { get; set; }
public DbSet<UserPackageAssignment> UserPackageAssignments { get; set; }
```

In `OnModelCreating`, configure:
1. `AssessmentPackage` -> `AssessmentSession` FK with `DeleteBehavior.Cascade`
2. `PackageQuestion` -> `AssessmentPackage` FK with `DeleteBehavior.Cascade`
3. `PackageOption` -> `PackageQuestion` FK with `DeleteBehavior.Cascade`
4. `UserPackageAssignment` -> `AssessmentSession` FK with `DeleteBehavior.Cascade`
5. `UserPackageAssignment` -> `AssessmentPackage` FK with `DeleteBehavior.Restrict`
6. Unique index on `UserPackageAssignment (AssessmentSessionId)` — one assignment per session-user pair (the UserId is just stored as string, not FK)

Run: `dotnet ef migrations add AddPackageSystem` then `dotnet ef database update`

Verify migration file was created in Migrations/ folder.
  </action>
  <verify>
1. `dotnet build` exits 0
2. `dotnet ef migrations add AddPackageSystem` creates migration file
3. `dotnet ef database update` exits 0 (no errors)
4. Migration file in Migrations/ contains CreateTable for AssessmentPackages, PackageQuestions, PackageOptions, UserPackageAssignments
  </verify>
  <done>
- Models/UserPackageAssignment.cs exists with all fields and helper methods
- Data/ApplicationDbContext.cs has 4 new DbSets and FK configurations
- Migration AddPackageSystem created and applied
- `dotnet build` and `dotnet ef database update` both exit 0
  </done>
</task>

</tasks>

<verification>
Run `dotnet build` — zero errors. Run `dotnet ef database update` — exits 0. Check that the 4 new tables appear in the database (using `dotnet ef dbcontext info` or checking the snapshot).
</verification>

<success_criteria>
- All 4 new entity classes exist with correct FK relationships
- DbContext has all 4 DbSets registered with correct cascade behaviors
- EF migration created and applied cleanly
- Project builds with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-question-and-exam-ux-improvements/17-01-SUMMARY.md`
</output>
