---
phase: 17-question-and-exam-ux-improvements
plan: "02"
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - Controllers/CMPController.cs
  - Views/CMP/ManagePackages.cshtml
  - Views/CMP/Assessment.cshtml
autonomous: true

must_haves:
  truths:
    - "HC can navigate to a 'Manage Packages' page for any assessment from the Manage Assessments view"
    - "HC can create a new package (Paket A, Paket B, Paket C) for an assessment"
    - "HC can delete a package (and all its questions) from the manage page"
    - "HC can see how many questions each package currently has"
  artifacts:
    - path: "Controllers/CMPController.cs"
      provides: "ManagePackages GET, CreatePackage POST, DeletePackage POST actions"
      contains: "ManagePackages"
    - path: "Views/CMP/ManagePackages.cshtml"
      provides: "Package list with question counts, create form, delete buttons"
      contains: "Manage Packages"
  key_links:
    - from: "Views/CMP/Assessment.cshtml"
      to: "Controllers/CMPController.cs ManagePackages"
      via: "Packages button link per assessment group card"
      pattern: "ManagePackages"
    - from: "Views/CMP/ManagePackages.cshtml"
      to: "Controllers/CMPController.cs CreatePackage"
      via: "form asp-action=CreatePackage"
      pattern: "CreatePackage"
---

<objective>
Build the HC-facing package management page: create, view, and delete test packages for an assessment. This gives HC a home for organizing questions before the import step.

Purpose: HC needs to manage packages before importing questions into them. This plan creates the package scaffolding.
Output: ManagePackages controller actions + view; Packages button added to manage view cards.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@Controllers/CMPController.cs
@Models/AssessmentPackage.cs
@Models/UserPackageAssignment.cs
@Data/ApplicationDbContext.cs
@Views/CMP/ManageQuestions.cshtml
@Views/CMP/Assessment.cshtml
@.planning/phases/17-question-and-exam-ux-improvements/17-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ManagePackages GET, CreatePackage POST, DeletePackage POST controller actions</name>
  <files>Controllers/CMPController.cs</files>
  <action>
Add three actions inside `#region Question Management` (or a new `#region Package Management`) in CMPController.cs. All require `[Authorize(Roles = "Admin, HC")]`.

**ManagePackages GET:**
```csharp
[HttpGet]
[Authorize(Roles = "Admin, HC")]
public async Task<IActionResult> ManagePackages(int assessmentId)
{
    var assessment = await _context.AssessmentSessions
        .Include(a => a.User)
        .FirstOrDefaultAsync(a => a.Id == assessmentId);
    if (assessment == null) return NotFound();

    var packages = await _context.AssessmentPackages
        .Include(p => p.Questions)
        .Where(p => p.AssessmentSessionId == assessmentId)
        .OrderBy(p => p.PackageNumber)
        .ToListAsync();

    ViewBag.Packages = packages;
    ViewBag.AssessmentTitle = assessment.Title;
    ViewBag.AssessmentId = assessmentId;

    return View();
}
```

**CreatePackage POST:**
```csharp
[HttpPost]
[Authorize(Roles = "Admin, HC")]
[ValidateAntiForgeryToken]
public async Task<IActionResult> CreatePackage(int assessmentId, string packageName)
{
    if (string.IsNullOrWhiteSpace(packageName))
    {
        TempData["Error"] = "Package name is required.";
        return RedirectToAction("ManagePackages", new { assessmentId });
    }

    var assessment = await _context.AssessmentSessions.FindAsync(assessmentId);
    if (assessment == null) return NotFound();

    // Determine next package number
    var existingCount = await _context.AssessmentPackages
        .CountAsync(p => p.AssessmentSessionId == assessmentId);

    var pkg = new AssessmentPackage
    {
        AssessmentSessionId = assessmentId,
        PackageName = packageName.Trim(),
        PackageNumber = existingCount + 1
    };
    _context.AssessmentPackages.Add(pkg);
    await _context.SaveChangesAsync();

    TempData["Success"] = $"Package '{packageName}' created.";
    return RedirectToAction("ManagePackages", new { assessmentId });
}
```

**DeletePackage POST:**
```csharp
[HttpPost]
[Authorize(Roles = "Admin, HC")]
[ValidateAntiForgeryToken]
public async Task<IActionResult> DeletePackage(int packageId)
{
    var pkg = await _context.AssessmentPackages
        .Include(p => p.Questions)
            .ThenInclude(q => q.Options)
        .FirstOrDefaultAsync(p => p.Id == packageId);

    if (pkg == null) return NotFound();

    int assessmentId = pkg.AssessmentSessionId;

    // Cascade: options -> questions -> package
    foreach (var q in pkg.Questions)
        _context.PackageOptions.RemoveRange(q.Options);
    _context.PackageQuestions.RemoveRange(pkg.Questions);
    _context.AssessmentPackages.Remove(pkg);

    await _context.SaveChangesAsync();
    TempData["Success"] = $"Package '{pkg.PackageName}' deleted.";
    return RedirectToAction("ManagePackages", new { assessmentId });
}
```
  </action>
  <verify>
`dotnet build` exits 0. No ambiguous reference or missing using errors.
  </verify>
  <done>Three new actions in CMPController.cs; project builds.</done>
</task>

<task type="auto">
  <name>Task 2: Create ManagePackages.cshtml view and add Packages button to Assessment manage view</name>
  <files>Views/CMP/ManagePackages.cshtml, Views/CMP/Assessment.cshtml</files>
  <action>
**Views/CMP/ManagePackages.cshtml:**

Layout should match ManageQuestions.cshtml style. Model is untyped (data via ViewBag).

```html
@{
    ViewData["Title"] = "Manage Packages";
    var packages = ViewBag.Packages as List<HcPortal.Models.AssessmentPackage> ?? new List<HcPortal.Models.AssessmentPackage>();
    int assessmentId = (int)ViewBag.AssessmentId;
}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">Manage Packages</h1>
            <p class="text-muted">Assessment: <strong>@ViewBag.AssessmentTitle</strong></p>
        </div>
        <a asp-action="Assessment" asp-route-view="manage" class="btn btn-secondary">
            <i class="bi bi-arrow-left me-2"></i>Back to Manage
        </a>
    </div>

    <!-- TempData alerts -->
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show">@TempData["Success"]<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show">@TempData["Error"]<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>
    }

    <div class="row">
        <!-- Create Package Form -->
        <div class="col-md-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 fw-bold text-primary">Add New Package</h6>
                </div>
                <div class="card-body">
                    <form asp-action="CreatePackage" method="post">
                        <input type="hidden" name="assessmentId" value="@assessmentId" />
                        <div class="mb-3">
                            <label class="form-label">Package Name</label>
                            <input type="text" name="packageName" class="form-control" placeholder="e.g., Paket A" required />
                            <div class="form-text">Use "Paket A", "Paket B", "Paket C"</div>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-plus-circle me-2"></i>Create Package
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Package List -->
        <div class="col-md-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 fw-bold text-primary">Packages (@packages.Count)</h6>
                </div>
                <div class="card-body">
                    @if (!packages.Any())
                    {
                        <div class="text-center py-5 text-muted">
                            <i class="bi bi-collection display-4"></i>
                            <p class="mt-2">No packages yet. Create your first package.</p>
                        </div>
                    }
                    else
                    {
                        <div class="list-group list-group-flush">
                            @foreach (var pkg in packages)
                            {
                                <div class="list-group-item px-0">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-0 fw-bold">@pkg.PackageName</h6>
                                            <small class="text-muted">@pkg.Questions.Count questions</small>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <a asp-action="ImportPackageQuestions" asp-route-packageId="@pkg.Id"
                                               class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-upload me-1"></i>Import Questions
                                            </a>
                                            <form asp-action="DeletePackage" method="post"
                                                  onsubmit="return confirm('Delete @pkg.PackageName and all its questions?');">
                                                <input type="hidden" name="packageId" value="@pkg.Id" />
                                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>
```

**Views/CMP/Assessment.cshtml — add "Packages" button:**

In the HC/Admin manage view, each assessment group card already has "Edit", "Questions" (old ManageQuestions), and "Delete" buttons. Add a "Packages" button linking to `ManagePackages` using the `RepresentativeId`:

Find the section in Assessment.cshtml that renders the per-group card action buttons. Add alongside the existing buttons:

```html
<a asp-action="ManagePackages" asp-route-assessmentId="@group.RepresentativeId"
   class="btn btn-sm btn-outline-info">
    <i class="bi bi-collection me-1"></i>Packages
</a>
```

Place it between "Questions" and "Delete" buttons if they exist, or after "Edit" if not.
  </action>
  <verify>
1. `dotnet build` exits 0
2. Navigate to `/CMP/ManagePackages?assessmentId=1` — page renders without error
3. Create a package → success message, package appears in list
4. Delete a package → removed from list
  </verify>
  <done>
ManagePackages.cshtml renders with create form and package list. Assessment.cshtml manage view shows "Packages" button on each group card. All actions work end-to-end.
  </done>
</task>

</tasks>

<verification>
`dotnet build` exits 0. ManagePackages page accessible for HC role. Create and delete operations function correctly. Assessment manage view shows Packages button.
</verification>

<success_criteria>
- ManagePackages GET renders package list with question counts
- CreatePackage POST adds package and redirects back
- DeletePackage POST removes package with all questions/options (cascade)
- Assessment.cshtml shows "Packages" button on each manage view card
</success_criteria>

<output>
After completion, create `.planning/phases/17-question-and-exam-ux-improvements/17-02-SUMMARY.md`
</output>
