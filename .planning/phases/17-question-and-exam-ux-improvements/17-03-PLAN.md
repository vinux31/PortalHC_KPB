---
phase: 17-question-and-exam-ux-improvements
plan: "03"
type: execute
wave: 3
depends_on: ["17-02"]
files_modified:
  - Controllers/CMPController.cs
  - Views/CMP/ImportPackageQuestions.cshtml
autonomous: true

must_haves:
  truths:
    - "HC can upload a .xlsx file to import questions into a package — each row becomes one question with 4 options and a correct answer"
    - "HC can paste tab-separated rows from Excel into a text area and import them — same format, same result"
    - "Import shows clear error messages when rows are malformed (missing columns, blank question text, invalid Correct letter)"
    - "After successful import, HC sees a count of questions added and is redirected back to ManagePackages"
  artifacts:
    - path: "Controllers/CMPController.cs"
      provides: "ImportPackageQuestions GET, ImportPackageQuestions POST (file + paste)"
      contains: "ImportPackageQuestions"
    - path: "Views/CMP/ImportPackageQuestions.cshtml"
      provides: "Two-tab import form: file upload tab and paste tab"
      contains: "Import Questions"
  key_links:
    - from: "Views/CMP/ImportPackageQuestions.cshtml"
      to: "Controllers/CMPController.cs ImportPackageQuestions POST"
      via: "form asp-action=ImportPackageQuestions with IFormFile or PasteText"
      pattern: "ImportPackageQuestions"
    - from: "Controllers/CMPController.cs ImportPackageQuestions POST"
      to: "Data/ApplicationDbContext.cs PackageQuestions + PackageOptions"
      via: "context.PackageQuestions.Add + context.PackageOptions.Add"
      pattern: "PackageQuestions.Add"
---

<objective>
Build the Excel import feature for package questions: HC can upload a .xlsx file or paste tab-separated text, and the system parses rows into PackageQuestion + PackageOption records.

Purpose: Entering questions one by one is impractical for 30-question packages. HC workflows use Excel for question preparation.
Output: ImportPackageQuestions controller actions + view with file upload and paste tabs.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@Controllers/CMPController.cs
@Models/AssessmentPackage.cs
@Data/ApplicationDbContext.cs
@.planning/phases/17-question-and-exam-ux-improvements/17-01-SUMMARY.md
@.planning/phases/17-question-and-exam-ux-improvements/17-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ImportPackageQuestions GET and POST controller actions with parser</name>
  <files>Controllers/CMPController.cs</files>
  <action>
Add to CMPController.cs inside `#region Package Management`.

**Expected Excel/paste column format (per CONTEXT.md decision):**
`Question | Option A | Option B | Option C | Option D | Correct`

Where `Correct` is a letter: A, B, C, or D — identifies which option is the answer key.

**ImportPackageQuestions GET:**
```csharp
[HttpGet]
[Authorize(Roles = "Admin, HC")]
public async Task<IActionResult> ImportPackageQuestions(int packageId)
{
    var pkg = await _context.AssessmentPackages
        .Include(p => p.Questions)
        .FirstOrDefaultAsync(p => p.Id == packageId);
    if (pkg == null) return NotFound();

    ViewBag.PackageId = packageId;
    ViewBag.PackageName = pkg.PackageName;
    ViewBag.AssessmentId = pkg.AssessmentSessionId;
    ViewBag.CurrentQuestionCount = pkg.Questions.Count;
    return View();
}
```

**ImportPackageQuestions POST:**
```csharp
[HttpPost]
[Authorize(Roles = "Admin, HC")]
[ValidateAntiForgeryToken]
public async Task<IActionResult> ImportPackageQuestions(
    int packageId, IFormFile? excelFile, string? pasteText)
{
    var pkg = await _context.AssessmentPackages
        .Include(p => p.Questions)
        .FirstOrDefaultAsync(p => p.Id == packageId);
    if (pkg == null) return NotFound();

    List<(string Question, string OptA, string OptB, string OptC, string OptD, string Correct)> rows;
    var errors = new List<string>();

    if (excelFile != null && excelFile.Length > 0)
    {
        // Parse xlsx with ClosedXML
        rows = new List<(string, string, string, string, string, string)>();
        try
        {
            using var stream = excelFile.OpenReadStream();
            using var workbook = new ClosedXML.Excel.XLWorkbook(stream);
            var ws = workbook.Worksheets.First();
            int rowNum = 1;
            foreach (var row in ws.RowsUsed().Skip(1)) // skip header row
            {
                rowNum++;
                var q   = row.Cell(1).GetString().Trim();
                var a   = row.Cell(2).GetString().Trim();
                var b   = row.Cell(3).GetString().Trim();
                var c   = row.Cell(4).GetString().Trim();
                var d   = row.Cell(5).GetString().Trim();
                var cor = row.Cell(6).GetString().Trim().ToUpper();
                rows.Add((q, a, b, c, d, cor));
            }
        }
        catch (Exception ex)
        {
            TempData["Error"] = $"Could not read Excel file: {ex.Message}";
            return RedirectToAction("ImportPackageQuestions", new { packageId });
        }
    }
    else if (!string.IsNullOrWhiteSpace(pasteText))
    {
        // Parse tab-separated paste (skip first line if it looks like a header)
        rows = new List<(string, string, string, string, string, string)>();
        var lines = pasteText.Split('\n')
            .Select(l => l.TrimEnd('\r'))
            .Where(l => !string.IsNullOrWhiteSpace(l))
            .ToList();

        // Detect and skip header: if first row's last cell is "Correct" (case-insensitive)
        int startIndex = 0;
        if (lines.Count > 0)
        {
            var firstCells = lines[0].Split('\t');
            if (firstCells.Length >= 6 && firstCells[5].Trim().ToLower() == "correct")
                startIndex = 1;
        }

        for (int i = startIndex; i < lines.Count; i++)
        {
            var cells = lines[i].Split('\t');
            if (cells.Length < 6)
            {
                errors.Add($"Row {i + 1}: expected 6 columns (Question|OptA|OptB|OptC|OptD|Correct), got {cells.Length}.");
                continue;
            }
            rows.Add((
                cells[0].Trim(), cells[1].Trim(), cells[2].Trim(),
                cells[3].Trim(), cells[4].Trim(), cells[5].Trim().ToUpper()
            ));
        }
    }
    else
    {
        TempData["Error"] = "Please upload an Excel file or paste question data.";
        return RedirectToAction("ImportPackageQuestions", new { packageId });
    }

    // Validate and persist rows
    int order = pkg.Questions.Count + 1;
    int added = 0;
    for (int i = 0; i < rows.Count; i++)
    {
        var (q, a, b, c, d, cor) = rows[i];
        if (string.IsNullOrWhiteSpace(q))
        {
            errors.Add($"Row {i + 1}: Question text is empty. Skipped.");
            continue;
        }
        if (string.IsNullOrWhiteSpace(a) || string.IsNullOrWhiteSpace(b) ||
            string.IsNullOrWhiteSpace(c) || string.IsNullOrWhiteSpace(d))
        {
            errors.Add($"Row {i + 1}: One or more options are empty. Skipped.");
            continue;
        }
        if (!new[] { "A", "B", "C", "D" }.Contains(cor))
        {
            errors.Add($"Row {i + 1}: 'Correct' column must be A, B, C, or D. Got '{cor}'. Skipped.");
            continue;
        }

        var newQ = new PackageQuestion
        {
            AssessmentPackageId = packageId,
            QuestionText = q,
            Order = order++,
            ScoreValue = 10
        };
        _context.PackageQuestions.Add(newQ);
        await _context.SaveChangesAsync(); // flush to get ID

        // Correct index: A=0, B=1, C=2, D=3
        int correctIndex = cor == "A" ? 0 : cor == "B" ? 1 : cor == "C" ? 2 : 3;
        var opts = new[] { a, b, c, d };
        for (int oi = 0; oi < opts.Length; oi++)
        {
            _context.PackageOptions.Add(new PackageOption
            {
                PackageQuestionId = newQ.Id,
                OptionText = opts[oi],
                IsCorrect = (oi == correctIndex)
            });
        }
        await _context.SaveChangesAsync();
        added++;
    }

    if (errors.Any())
        TempData["Warning"] = $"Imported {added} question(s) with {errors.Count} error(s): " +
                              string.Join(" | ", errors.Take(5));
    else
        TempData["Success"] = $"Successfully imported {added} question(s) into {pkg.PackageName}.";

    return RedirectToAction("ManagePackages", new { assessmentId = pkg.AssessmentSessionId });
}
```

**Note:** ClosedXML is already in the project (used by CDPController for Excel export). Add `using ClosedXML.Excel;` if not already at top of file.
  </action>
  <verify>
`dotnet build` exits 0. No missing namespace errors.
  </verify>
  <done>ImportPackageQuestions GET and POST actions added; project builds without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Create ImportPackageQuestions.cshtml with file upload and paste tabs</name>
  <files>Views/CMP/ImportPackageQuestions.cshtml</files>
  <action>
Create the view with two Bootstrap tabs: "Upload Excel File" and "Paste from Excel".

```html
@{
    ViewData["Title"] = "Import Questions";
    int packageId = (int)ViewBag.PackageId;
}

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">Import Questions</h1>
            <p class="text-muted">Package: <strong>@ViewBag.PackageName</strong> — @ViewBag.CurrentQuestionCount existing question(s)</p>
        </div>
        <a asp-action="ManagePackages" asp-route-assessmentId="@ViewBag.AssessmentId" class="btn btn-secondary">
            <i class="bi bi-arrow-left me-2"></i>Back to Packages
        </a>
    </div>

    @if (TempData["Warning"] != null)
    {
        <div class="alert alert-warning alert-dismissible fade show">@TempData["Warning"]<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>
    }

    <!-- Format reference card -->
    <div class="card border-info mb-4">
        <div class="card-body py-2">
            <strong class="text-info">Required column format:</strong>
            <code class="ms-2">Question | Option A | Option B | Option C | Option D | Correct</code>
            <span class="ms-2 text-muted">— "Correct" must be A, B, C, or D (case insensitive)</span>
        </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-3" id="importTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="file-tab" data-bs-toggle="tab"
                    data-bs-target="#file-pane" type="button" role="tab">
                <i class="bi bi-file-earmark-excel me-1"></i>Upload Excel File
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="paste-tab" data-bs-toggle="tab"
                    data-bs-target="#paste-pane" type="button" role="tab">
                <i class="bi bi-clipboard me-1"></i>Paste from Excel
            </button>
        </li>
    </ul>

    <div class="tab-content">
        <!-- File Upload Tab -->
        <div class="tab-pane fade show active" id="file-pane" role="tabpanel">
            <div class="card shadow">
                <div class="card-body">
                    <form asp-action="ImportPackageQuestions" method="post"
                          enctype="multipart/form-data">
                        <input type="hidden" name="packageId" value="@packageId" />
                        <div class="mb-3">
                            <label class="form-label fw-bold">Excel File (.xlsx)</label>
                            <input type="file" name="excelFile" class="form-control"
                                   accept=".xlsx" required />
                            <div class="form-text">First row is treated as header and skipped automatically.</div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-upload me-2"></i>Import from File
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Paste Tab -->
        <div class="tab-pane fade" id="paste-pane" role="tabpanel">
            <div class="card shadow">
                <div class="card-body">
                    <form asp-action="ImportPackageQuestions" method="post">
                        <input type="hidden" name="packageId" value="@packageId" />
                        <div class="mb-3">
                            <label class="form-label fw-bold">Paste rows from Excel</label>
                            <textarea name="pasteText" class="form-control font-monospace"
                                      rows="12"
                                      placeholder="Paste rows here (Ctrl+V after copying from Excel)..."
                                      required></textarea>
                            <div class="form-text">Select and copy rows from Excel (including or excluding header), then paste here. Columns must match the format above.</div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-clipboard-check me-2"></i>Import from Paste
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
```
  </action>
  <verify>
1. `dotnet build` exits 0
2. Navigate to `/CMP/ImportPackageQuestions?packageId=1` — page renders with two tabs
3. File upload tab shows file input and import button
4. Paste tab shows textarea and import button
  </verify>
  <done>
ImportPackageQuestions.cshtml renders with both import tabs. File upload form posts to ImportPackageQuestions with enctype=multipart. Paste form posts with textarea. Format reference card visible.
  </done>
</task>

</tasks>

<verification>
`dotnet build` exits 0. Import page accessible. File upload with a valid .xlsx imports rows and shows success count. Paste import with tab-separated text also imports. Malformed rows (bad Correct letter, missing columns) show error warnings.
</verification>

<success_criteria>
- ImportPackageQuestions GET renders two-tab form with format reference
- File upload: .xlsx parsed with ClosedXML, skips header row, imports valid rows
- Paste: TSV parsed, header auto-detected and skipped, imports valid rows
- Invalid rows skipped with warning messages showing row number and reason
- Success: redirects to ManagePackages with count of questions added
</success_criteria>

<output>
After completion, create `.planning/phases/17-question-and-exam-ux-improvements/17-03-SUMMARY.md`
</output>
