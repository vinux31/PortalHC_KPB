---
phase: 17-question-and-exam-ux-improvements
plan: "05"
type: execute
wave: 5
depends_on: ["17-04"]
files_modified:
  - Views/CMP/StartExam.cshtml
autonomous: true

must_haves:
  truths:
    - "Exam displays 10 questions per page — navigated with Prev/Next page buttons, not one-at-a-time and not all-on-one-page"
    - "Header shows assessment name and answered count (e.g., '7/30 answered') — no other distractions"
    - "Countdown timer shows time remaining; turns red when 5 minutes remain; auto-submits when time is up"
    - "A collapsible panel shows question numbers for the current page (e.g., 1-10); can be toggled open/closed"
    - "User can skip unanswered questions and advance to the next page — no blocking"
    - "The last page shows a 'Review and Submit' button instead of 'Next Page'"
  artifacts:
    - path: "Views/CMP/StartExam.cshtml"
      provides: "Paged exam layout with timer, header, collapsible panel, page navigation"
      contains: "examCurrentPage"
  key_links:
    - from: "Views/CMP/StartExam.cshtml JS"
      to: "Views/CMP/StartExam.cshtml form"
      via: "JS page switching (show/hide question divs), form hidden inputs track answers per question ID"
      pattern: "examCurrentPage"
    - from: "Views/CMP/StartExam.cshtml form"
      to: "Controllers/CMPController.cs ExamSummary GET"
      via: "Navigate to ExamSummary page (not direct submit) from last page"
      pattern: "ExamSummary"
---

<objective>
Redesign the exam view with paged layout, countdown timer with warning state, progress header, and collapsible question number panel.

Purpose: The current StartExam view shows all questions on one page with no navigation. This plan replaces it with the user-decided paged UX.
Output: New StartExam.cshtml with 10-questions-per-page layout, JS-powered page switching, timer, and collapsible sidebar panel.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@Views/CMP/StartExam.cshtml
@Models/PackageExamViewModel.cs
@.planning/phases/17-question-and-exam-ux-improvements/17-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace StartExam.cshtml with paged exam layout</name>
  <files>Views/CMP/StartExam.cshtml</files>
  <action>
Completely replace Views/CMP/StartExam.cshtml. The new view model is `PackageExamViewModel`.

**Design decisions (Claude's discretion per CONTEXT.md):**
- 10 questions per page (fixed)
- Timer warning threshold: 5 minutes (300 seconds) — turns red
- Collapsible panel: right sidebar on desktop, toggleable via button; shows Q numbers for current page only
- Question number panel toggle button: placed above the question area, right-aligned

**Architecture:**
- All questions rendered in DOM as hidden divs grouped by page; JS shows/hides the active page
- Answers stored as hidden `<input type="hidden">` elements updated by JS when user selects a radio; this lets the final form POST contain all answers regardless of current page
- "answered" counter maintained in JS, updated on radio change
- Navigation: JS prev/next — no page reload
- On last page: "Review and Submit" button navigates to ExamSummary GET (GET request with all answers as query params is impractical for 30 questions; store answers in a temp area)

**IMPORTANT constraint:** The summary page needs the answers. Use a hidden form that is submitted (POST to ExamSummary) from the "Review and Submit" button. The form contains all answer hidden inputs. ExamSummary GET action stores them temporarily in TempData (see Plan 06).

```html
@model HcPortal.Models.PackageExamViewModel

@{
    ViewData["Title"] = "Exam In Progress";
    const int questionsPerPage = 10;
    int totalPages = (int)Math.Ceiling((double)Model.TotalQuestions / questionsPerPage);
}

<!-- Sticky Header -->
<div class="sticky-top bg-white shadow-sm py-2 px-3 border-bottom" id="examHeader">
    <div class="d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-3">
            <h6 class="mb-0 fw-bold text-primary">@Model.Title</h6>
            <span class="text-muted small" id="answeredProgress">0/@Model.TotalQuestions answered</span>
        </div>
        <div class="text-end">
            <span class="fw-bold fs-5" id="examTimer">--:--</span>
            <div class="small text-muted">Time Remaining</div>
        </div>
    </div>
</div>

@if (!Model.Questions.Any())
{
    <div class="container py-5 text-center">
        <div class="alert alert-warning">
            <h4>No Questions Available</h4>
            <p>This assessment has no questions configured yet.</p>
            <a asp-action="Assessment" class="btn btn-outline-dark">Return to List</a>
        </div>
    </div>
}
else
{
    <div class="container-fluid py-3">
        <div class="row">
            <!-- Main exam area -->
            <div class="col-lg-9">

                <!-- Hidden main answer form (stores all answers; submitted to ExamSummary) -->
                <form id="examForm" asp-action="ExamSummary" method="post">
                    <input type="hidden" name="id" value="@Model.AssessmentSessionId" />
                    @if (Model.HasPackages && Model.AssignmentId.HasValue)
                    {
                        <input type="hidden" name="assignmentId" value="@Model.AssignmentId.Value" />
                    }

                    <!-- Per-question hidden answer inputs (updated by JS on radio change) -->
                    @foreach (var q in Model.Questions)
                    {
                        <input type="hidden" id="ans_@q.QuestionId" name="answers[@q.QuestionId]" value="" />
                    }

                    <!-- Pages: groups of 10 questions -->
                    @for (int page = 0; page < totalPages; page++)
                    {
                        var pageQuestions = Model.Questions
                            .Skip(page * questionsPerPage)
                            .Take(questionsPerPage)
                            .ToList();

                        <div class="exam-page" id="page_@page"
                             style="display: @(page == 0 ? "block" : "none")">

                            @foreach (var q in pageQuestions)
                            {
                                <div class="card shadow-sm mb-3 border-0" id="qcard_@q.QuestionId">
                                    <div class="card-body p-3">
                                        <p class="fw-bold mb-3">
                                            <span class="badge bg-primary me-2">@q.DisplayNumber</span>
                                            @q.QuestionText
                                        </p>
                                        <div class="list-group">
                                            @{
                                                string[] letters = { "A", "B", "C", "D" };
                                            }
                                            @for (int oi = 0; oi < q.Options.Count; oi++)
                                            {
                                                var opt = q.Options[oi];
                                                var letter = oi < letters.Length ? letters[oi] : (oi + 1).ToString();
                                                <label class="list-group-item list-group-item-action d-flex align-items-center gap-3"
                                                       style="cursor: pointer;"
                                                       id="lbl_@(q.QuestionId)_@opt.OptionId">
                                                    <input class="form-check-input flex-shrink-0 exam-radio"
                                                           type="radio"
                                                           name="radio_@q.QuestionId"
                                                           value="@opt.OptionId"
                                                           data-question-id="@q.QuestionId"
                                                           style="transform: scale(1.2);">
                                                    <span class="fw-bold me-1 text-secondary">@letter.</span>
                                                    <span>@opt.OptionText</span>
                                                </label>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }

                            <!-- Page navigation -->
                            <div class="d-flex justify-content-between mt-3 mb-4">
                                <button type="button" class="btn btn-outline-secondary"
                                        onclick="changePage(@(page - 1))"
                                        @(page == 0 ? "disabled" : "")>
                                    <i class="bi bi-chevron-left me-1"></i>Previous Page
                                </button>

                                @if (page < totalPages - 1)
                                {
                                    <button type="button" class="btn btn-primary"
                                            onclick="changePage(@(page + 1))">
                                        Next Page<i class="bi bi-chevron-right ms-1"></i>
                                    </button>
                                }
                                else
                                {
                                    <button type="submit" class="btn btn-success fw-bold"
                                            id="reviewSubmitBtn">
                                        <i class="bi bi-clipboard-check me-2"></i>Review and Submit
                                    </button>
                                }
                            </div>
                        </div>
                    }
                </form>
            </div>

            <!-- Question Number Panel (collapsible sidebar) -->
            <div class="col-lg-3" id="questionPanelWrapper">
                <div class="sticky-top" style="top: 70px;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted fw-bold">Questions this page</small>
                        <button class="btn btn-sm btn-outline-secondary" id="togglePanelBtn"
                                onclick="togglePanel()">
                            <i class="bi bi-layout-sidebar-reverse"></i>
                        </button>
                    </div>
                    <div id="questionPanel" class="card shadow-sm">
                        <div class="card-body py-2 px-2">
                            <div id="panelNumbers" class="d-flex flex-wrap gap-2">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<script>
    // -------- Constants --------
    const TOTAL_QUESTIONS = @Model.TotalQuestions;
    const QUESTIONS_PER_PAGE = @questionsPerPage;
    const TOTAL_PAGES = @totalPages;
    const DURATION_SECONDS = @Model.DurationMinutes * 60;
    const WARNING_THRESHOLD = 300; // 5 minutes

    // -------- State --------
    let currentPage = 0;
    let timeRemaining = DURATION_SECONDS;
    let answeredQuestions = new Set(); // tracks which question IDs have been answered

    // Mapping: page index -> array of question IDs on that page
    const pageQuestionIds = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
        Enumerable.Range(0, totalPages).Select(p =>
            Model.Questions.Skip(p * questionsPerPage).Take(questionsPerPage)
                .Select(q => q.QuestionId).ToList()
        ).ToList()
    ));

    // -------- Timer --------
    function updateTimer() {
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        const display = (minutes < 10 ? '0' + minutes : minutes) + ':' +
                        (seconds < 10 ? '0' + seconds : seconds);
        const el = document.getElementById('examTimer');
        el.innerText = display;
        if (timeRemaining <= WARNING_THRESHOLD) {
            el.className = 'fw-bold fs-5 text-danger';
        } else {
            el.className = 'fw-bold fs-5 text-dark';
        }
        if (timeRemaining <= 0) {
            clearInterval(timerInterval);
            alert('Time is up! Submitting your exam automatically.');
            document.getElementById('examForm').submit();
        }
        timeRemaining--;
    }
    var timerInterval = setInterval(updateTimer, 1000);
    updateTimer();

    // -------- Page switching --------
    function changePage(newPage) {
        if (newPage < 0 || newPage >= TOTAL_PAGES) return;
        document.getElementById('page_' + currentPage).style.display = 'none';
        currentPage = newPage;
        document.getElementById('page_' + currentPage).style.display = 'block';
        updatePanel();
        window.scrollTo(0, 0);
    }

    // -------- Answer tracking --------
    document.querySelectorAll('.exam-radio').forEach(function(radio) {
        radio.addEventListener('change', function() {
            const qId = this.getAttribute('data-question-id');
            const optId = this.value;
            // Update hidden input
            document.getElementById('ans_' + qId).value = optId;
            answeredQuestions.add(qId);
            updateAnsweredCount();
            // Visual: highlight selected label
            document.querySelectorAll('[id^="lbl_' + qId + '_"]').forEach(function(lbl) {
                lbl.classList.remove('active', 'list-group-item-primary');
            });
            document.getElementById('lbl_' + qId + '_' + optId).classList.add('active', 'list-group-item-primary');
        });
    });

    function updateAnsweredCount() {
        document.getElementById('answeredProgress').innerText =
            answeredQuestions.size + '/' + TOTAL_QUESTIONS + ' answered';
        updatePanel();
    }

    // -------- Collapsible panel --------
    let panelVisible = true;
    function togglePanel() {
        const panel = document.getElementById('questionPanel');
        panelVisible = !panelVisible;
        panel.style.display = panelVisible ? 'block' : 'none';
    }

    function updatePanel() {
        const container = document.getElementById('panelNumbers');
        container.innerHTML = '';
        const ids = pageQuestionIds[currentPage] || [];
        ids.forEach(function(qId) {
            const btn = document.createElement('div');
            const answered = answeredQuestions.has(String(qId));
            btn.className = 'badge rounded-pill ' + (answered ? 'bg-success' : 'bg-secondary');
            btn.style.cssText = 'font-size:0.85rem; padding:6px 10px; cursor:default;';
            // Find display number: use Q number embedded in the card badge
            const qcard = document.getElementById('qcard_' + qId);
            let displayNum = qId;
            if (qcard) {
                const badge = qcard.querySelector('.badge.bg-primary');
                if (badge) displayNum = badge.innerText.trim();
            }
            btn.innerText = displayNum;
            container.appendChild(btn);
        });
    }

    // -------- Init --------
    updatePanel();

    // -------- Prevent accidental leave --------
    window.onbeforeunload = function() {
        return 'Are you sure you want to leave? Your progress will be lost.';
    };
    document.getElementById('examForm').addEventListener('submit', function() {
        window.onbeforeunload = null;
    });
</script>

<style>
    #examHeader { z-index: 1020; }
    .list-group-item-primary { background-color: #cfe2ff !important; border-color: #9ec5fe !important; }
    @@media (max-width: 991px) {
        #questionPanelWrapper { order: -1; margin-bottom: 1rem; }
    }
</style>
```

**Key design notes:**
- Radio buttons use `name="radio_{questionId}"` to allow JS change detection without interfering with the hidden form inputs
- Hidden inputs `name="answers[{questionId}]"` carry the actual answer option IDs for form POST
- Letters (A/B/C/D) are assigned at render time by index — NOT stored in model or DB
- Panel shows green badge for answered questions, grey for unanswered
- "Review and Submit" submits the form to `ExamSummary` POST (Plan 06 creates that action)
  </action>
  <verify>
1. `dotnet build` exits 0
2. Start an exam — page shows first 10 questions with page number header
3. Next Page button advances to page 2
4. Previous Page button goes back
5. Answered count updates in header as questions are selected
6. Timer counts down; turns red at 5 min mark
7. Panel shows question numbers for current page; toggleable
8. Last page shows "Review and Submit" button
  </verify>
  <done>
StartExam.cshtml replaced with paged layout. 10 questions/page. Prev/Next navigation works. Timer with red warning at 5 min. Header shows answered/total. Collapsible question panel. "Review and Submit" on last page. Project builds.
  </done>
</task>

</tasks>

<verification>
`dotnet build` exits 0. Exam page loads for an assessment with packages. Paging works. Timer counts down. Answered count updates. Panel toggles. Last page has Review and Submit button.
</verification>

<success_criteria>
- 10 questions per page, JS page switching (no reload)
- Header: assessment title + "X/N answered" counter
- Timer: countdown, turns red at 5 min, auto-submits at 0
- Collapsible question number panel for current page (green = answered, grey = unanswered)
- Prev/Next buttons, no blocking on unanswered questions
- Last page: "Review and Submit" button (submits to ExamSummary)
</success_criteria>

<output>
After completion, create `.planning/phases/17-question-and-exam-ux-improvements/17-05-SUMMARY.md`
</output>
