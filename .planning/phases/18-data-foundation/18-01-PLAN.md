---
phase: 18-data-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Models/TrainingRecord.cs
  - Data/ApplicationDbContext.cs
  - Controllers/CMPController.cs
  - Migrations/
  - wwwroot/uploads/certificates/.gitkeep
autonomous: true

must_haves:
  truths:
    - "TrainingRecord table has nullable TanggalMulai (DateTime?), TanggalSelesai (DateTime?), and NomorSertifikat (string?) columns"
    - "Existing TrainingRecord rows are not lost or corrupted after migration — all new columns are nullable so existing data remains intact"
    - "A file placed at wwwroot/uploads/certificates/test.pdf is reachable via /uploads/certificates/test.pdf in the browser"
    - "CMPController has IWebHostEnvironment injected and stored as _env — ready for Phase 19 file upload code"
    - "RecordsWorkerList page renders without error after migration"
    - "Personal Records page renders without error after migration"
    - "EF migration applies cleanly on a fresh database (dotnet ef database update from empty)"
  artifacts:
    - path: "Models/TrainingRecord.cs"
      provides: "TanggalMulai, TanggalSelesai, NomorSertifikat properties"
      contains: "TanggalMulai"
    - path: "Migrations/*AddTrainingRecordV16Fields*"
      provides: "EF Core migration adding 3 new columns"
    - path: "Controllers/CMPController.cs"
      provides: "IWebHostEnvironment _env field for file upload in Phase 19"
      contains: "_env"
    - path: "wwwroot/uploads/certificates/.gitkeep"
      provides: "Upload destination directory tracked in git"
  key_links:
    - from: "Models/TrainingRecord.cs"
      to: "Data/ApplicationDbContext.cs"
      via: "DbSet<TrainingRecord> already registered — no change needed"
      pattern: "DbSet<TrainingRecord>"
    - from: "Migrations/*AddTrainingRecordV16Fields*"
      to: "Models/TrainingRecord.cs"
      via: "EF Core migration generated from model diff"
---

<objective>
Add TanggalMulai, TanggalSelesai, and NomorSertifikat columns to the TrainingRecord model, generate the EF Core migration, create the certificate upload directory under wwwroot, and inject IWebHostEnvironment into CMPController — completing the data foundation for v1.6 Training Records Management.

Purpose: Phase 19 needs these schema fields and the upload infrastructure to build the Create Training Record form without any schema surprises or plumbing work.

Output: Updated TrainingRecord model, one new EF migration, CMPController with _env injection, wwwroot/uploads/certificates/ directory.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@Models/TrainingRecord.cs
@Data/ApplicationDbContext.cs
@Controllers/CMPController.cs (lines 1-29 — constructor and DI)
@Controllers/CDPController.cs (lines 14-27 — IWebHostEnvironment injection pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add v1.6 columns to TrainingRecord model and generate EF migration</name>
  <files>
    Models/TrainingRecord.cs
    Migrations/ (new migration files)
  </files>
  <action>
1. Open Models/TrainingRecord.cs and add three new nullable properties after the existing ValidUntil/CertificateType block:

```csharp
// v1.6 fields — start date, end date, certificate number
public DateTime? TanggalMulai { get; set; }    // Training start date
public DateTime? TanggalSelesai { get; set; }   // Training end date
public string? NomorSertifikat { get; set; }    // Certificate number
```

All three MUST be nullable — existing rows have no values for these fields and must not break.

2. No changes needed to ApplicationDbContext.cs — TrainingRecord is already registered as DbSet<TrainingRecord> and has no column-level Fluent API configuration that would need updating. The new nullable properties will be picked up automatically by convention.

3. Generate the EF Core migration:
```
dotnet ef migrations add AddTrainingRecordV16Fields
```

4. Apply the migration to the development database:
```
dotnet ef database update
```

5. Verify the migration SQL only adds columns (ALTER TABLE ADD COLUMN), does NOT drop or rename existing columns, and all new columns allow NULL.
  </action>
  <verify>
- `dotnet build` succeeds with no errors
- Migration file exists in Migrations/ with name containing "AddTrainingRecordV16Fields"
- `dotnet ef database update` completes without error
- Inspect the migration's Up() method: it should contain exactly 3 AddColumn calls for TanggalMulai, TanggalSelesai, NomorSertifikat — no DropColumn, RenameColumn, or data-loss operations
  </verify>
  <done>
TrainingRecord model has TanggalMulai (DateTime?), TanggalSelesai (DateTime?), and NomorSertifikat (string?) properties. EF migration is generated and applied. Existing data is intact.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire IWebHostEnvironment into CMPController and create certificate upload directory</name>
  <files>
    Controllers/CMPController.cs
    wwwroot/uploads/certificates/.gitkeep
  </files>
  <action>
1. Open Controllers/CMPController.cs and add IWebHostEnvironment to the constructor injection, following the exact pattern used in CDPController (lines 14-27):

- Add a private readonly field: `private readonly IWebHostEnvironment _env;`
- Add IWebHostEnvironment parameter to the constructor
- Assign `_env = env;` in the constructor body

The constructor should become:
```csharp
private readonly UserManager<ApplicationUser> _userManager;
private readonly SignInManager<ApplicationUser> _signInManager;
private readonly ApplicationDbContext _context;
private readonly IWebHostEnvironment _env;

public CMPController(
    UserManager<ApplicationUser> userManager,
    SignInManager<ApplicationUser> signInManager,
    ApplicationDbContext context,
    IWebHostEnvironment env)
{
    _userManager = userManager;
    _signInManager = signInManager;
    _context = context;
    _env = env;
}
```

Note: IWebHostEnvironment is in the Microsoft.AspNetCore.Hosting namespace, which is auto-imported via the ASP.NET Core implicit usings. No additional `using` statement needed.

2. Create the upload directory and .gitkeep file:
```
mkdir -p wwwroot/uploads/certificates
touch wwwroot/uploads/certificates/.gitkeep
```

The .gitkeep ensures the empty directory is tracked in git. Files served from wwwroot are already handled by app.UseStaticFiles() in Program.cs — no additional middleware configuration is needed. The existing StaticFileOptions in Program.cs already handles PDF Content-Disposition headers.

3. Verify the app builds and the existing Records pages still work:
```
dotnet build
dotnet run
```
Then confirm the RecordsWorkerList and personal Records views render without error by running the app.
  </action>
  <verify>
- `dotnet build` succeeds with no errors
- CMPController.cs contains `private readonly IWebHostEnvironment _env;` and constructor assigns it
- `wwwroot/uploads/certificates/.gitkeep` exists on disk
- Run `dotnet run`, navigate to `/CMP/Records` — page loads without 500 error (HC/Admin sees RecordsWorkerList, Coach/Coachee sees Records)
  </verify>
  <done>
CMPController has IWebHostEnvironment injected as _env. wwwroot/uploads/certificates/ directory exists and is tracked in git. A file placed in that directory would be served by the existing UseStaticFiles middleware. All pre-existing Training Records pages render without error.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` — compiles with zero errors and zero warnings related to TrainingRecord
2. Migration file in Migrations/ contains only AddColumn operations for the 3 new fields — no data-loss operations
3. `dotnet ef database update` succeeds on development database
4. CMPController has _env field of type IWebHostEnvironment
5. wwwroot/uploads/certificates/ directory exists with .gitkeep
6. `dotnet run` — app starts, `/CMP/Records` page loads for both HC and Coachee roles without error
</verification>

<success_criteria>
- TrainingRecord.cs has TanggalMulai (DateTime?), TanggalSelesai (DateTime?), NomorSertifikat (string?) properties
- EF migration AddTrainingRecordV16Fields exists and applies cleanly
- CMPController constructor accepts and stores IWebHostEnvironment as _env
- wwwroot/uploads/certificates/.gitkeep is present
- Existing RecordsWorkerList and Records pages render without error after all changes
</success_criteria>

<output>
After completion, create `.planning/phases/18-data-foundation/18-01-SUMMARY.md`
</output>
