---
phase: 20-edit-delete-recordsworkerlist-wiring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Models/UnifiedTrainingRecord.cs
  - Models/EditTrainingRecordViewModel.cs
  - Controllers/CMPController.cs
  - Views/CMP/WorkerDetail.cshtml
autonomous: true

must_haves:
  truths:
    - "HC sees Edit and Delete buttons only on Training Manual rows in WorkerDetail; Assessment Online rows have no such buttons"
    - "Clicking Edit opens a pre-populated Bootstrap modal on WorkerDetail — no page navigation occurs"
    - "Saving the edit modal POSTs to the server, updates the record, and redirects back to WorkerDetail with a success alert"
    - "Uploading a new file in the edit modal replaces the old file on disk and the new file is downloadable"
    - "Clicking Delete with confirm() removes the record and its certificate file from disk; the row is gone on next load"
  artifacts:
    - path: "Models/EditTrainingRecordViewModel.cs"
      provides: "Edit form binding model — all fields except UserId; includes WorkerId and WorkerName for redirect"
      contains: "EditTrainingRecordViewModel"
    - path: "Models/UnifiedTrainingRecord.cs"
      provides: "TrainingRecordId property for Edit/Delete action generation"
      contains: "TrainingRecordId"
    - path: "Controllers/CMPController.cs"
      provides: "EditTrainingRecord POST and DeleteTrainingRecord POST actions"
      exports: ["EditTrainingRecord", "DeleteTrainingRecord"]
    - path: "Views/CMP/WorkerDetail.cshtml"
      provides: "Edit/Delete action cells on Training Manual rows; one Bootstrap modal per manual row pre-populated via Razor; TempData success/error alerts"
      contains: "editModal-"
  key_links:
    - from: "Views/CMP/WorkerDetail.cshtml (pencil button)"
      to: "Bootstrap modal #editModal-@item.TrainingRecordId"
      via: "data-bs-toggle='modal' data-bs-target='#editModal-{id}' on button click"
      pattern: "editModal-@item\\.TrainingRecordId"
    - from: "Views/CMP/WorkerDetail.cshtml (modal form)"
      to: "/CMP/EditTrainingRecord"
      via: "form POST with enctype=multipart/form-data inside each modal"
      pattern: "EditTrainingRecord.*multipart"
    - from: "Views/CMP/WorkerDetail.cshtml (delete form)"
      to: "/CMP/DeleteTrainingRecord"
      via: "form POST with confirm() onclick guard on Training Manual rows"
      pattern: "DeleteTrainingRecord.*TrainingRecordId"
    - from: "Controllers/CMPController.cs EditTrainingRecord POST"
      to: "wwwroot/uploads/certificates/"
      via: "File replace: delete old file at _env.WebRootPath + old SertifikatUrl, save new file with timestamp prefix"
      pattern: "File\\.Delete|CopyToAsync"
    - from: "Controllers/CMPController.cs DeleteTrainingRecord POST"
      to: "wwwroot/uploads/certificates/"
      via: "File.Delete on record.SertifikatUrl physical path before removing DB row"
      pattern: "File\\.Delete.*SertifikatUrl"
---

<objective>
HC or Admin can edit any existing manual training record (all fields except Pekerja) and delete any manual training record, both from WorkerDetail. The edit form appears as a Bootstrap modal inside WorkerDetail — no page navigation. Assessment Online rows are unaffected.

Purpose: Completes v1.6 TRN-02 and TRN-03 requirements — training records are now fully manageable (create, edit, delete) by HC/Admin.
Output: EditTrainingRecordViewModel, EditTrainingRecord POST and DeleteTrainingRecord POST in CMPController, WorkerDetail updated with per-row modals and action buttons on manual rows.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/19-hc-create-training-record-certificate-upload/19-01-SUMMARY.md
@.planning/phases/18-data-foundation/18-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: EditTrainingRecordViewModel, controller POST actions, and UnifiedTrainingRecord.TrainingRecordId</name>
  <files>
    Models/EditTrainingRecordViewModel.cs
    Models/UnifiedTrainingRecord.cs
    Controllers/CMPController.cs
  </files>
  <action>
**Models/EditTrainingRecordViewModel.cs** — Create new file. Mirror CreateTrainingRecordViewModel but WITHOUT UserId (worker cannot be changed on edit). Properties:
- `int Id` (no validation attribute — populated from hidden input in modal)
- `string WorkerId` (no validation attribute — populated from hidden input; used by POST to redirect to WorkerDetail without extra DB lookup)
- `string WorkerName` (no validation attribute — populated from hidden input; used by POST to redirect to WorkerDetail without extra DB lookup)
- `[Required] string Judul`
- `[Required] string Penyelenggara`
- `string? Kota`
- `[Required] string Kategori`
- `[Required] DateTime Tanggal` (default DateTime.Today)
- `DateTime? TanggalMulai`
- `DateTime? TanggalSelesai`
- `[Required] string Status` (default "Passed")
- `string? NomorSertifikat`
- `DateTime? ValidUntil`
- `string? CertificateType`
- `IFormFile? CertificateFile`
- `string? ExistingSertifikatUrl` — hidden input in the modal form so POST can reference it if no new file is uploaded; also used by Razor to render the current certificate download link inside the modal

**Models/UnifiedTrainingRecord.cs** — Add one property:
```csharp
// TrainingRecord.Id — null for Assessment Online rows; used for Edit/Delete actions
public int? TrainingRecordId { get; set; }
```

**Controllers/CMPController.cs** — Three changes:

1. **GetUnifiedRecords helper** — In the `trainings.Select(t => new UnifiedTrainingRecord { ... })` block, add:
```csharp
TrainingRecordId = t.Id,
```

2. **EditTrainingRecord POST** — Add after the existing CreateTrainingRecord POST action. There is NO GET action — the modal is pre-populated inline via Razor in WorkerDetail.cshtml.
```
[HttpPost]
[ValidateAntiForgeryToken]
public async Task<IActionResult> EditTrainingRecord(EditTrainingRecordViewModel model)
    - GetUserAsync + GetRolesAsync → isHCAccess gate (Forbid if not HC/Admin)
    - Validate file type/size if model.CertificateFile != null && Length > 0:
        Allowed extensions: .pdf .jpg .jpeg .png; max 10 MB
        On validation failure: TempData["Error"] = first error message; return RedirectToAction("WorkerDetail", new { workerId = model.WorkerId, name = model.WorkerName });
    - if (!ModelState.IsValid):
        TempData["Error"] = first ModelState error message
        return RedirectToAction("WorkerDetail", new { workerId = model.WorkerId, name = model.WorkerName });
    - var record = await _context.TrainingRecords.FindAsync(model.Id); if null return NotFound();
    - If model.CertificateFile != null && Length > 0:
        - Delete old file: if (!string.IsNullOrEmpty(record.SertifikatUrl)) { var oldPath = Path.Combine(_env.WebRootPath, record.SertifikatUrl.TrimStart('/')); if (File.Exists(oldPath)) File.Delete(oldPath); }
        - Save new file: timestamp-prefixed filename → wwwroot/uploads/certificates/ (same pattern as CreateTrainingRecord POST)
        - record.SertifikatUrl = new URL
      Else: keep record.SertifikatUrl unchanged
    - Update all other record fields from model: Judul, Penyelenggara, Kota, Kategori, Tanggal, TanggalMulai, TanggalSelesai, Status, NomorSertifikat, ValidUntil, CertificateType
    - Do NOT update record.UserId — worker is immutable on edit
    - await _context.SaveChangesAsync();
    - TempData["Success"] = "Training record berhasil diperbarui.";
    - return RedirectToAction("WorkerDetail", new { workerId = model.WorkerId, name = model.WorkerName });
```

3. **DeleteTrainingRecord POST** — Add after EditTrainingRecord POST.
```
[HttpPost]
[ValidateAntiForgeryToken]
public async Task<IActionResult> DeleteTrainingRecord(int id, string workerId, string workerName)
    - GetUserAsync + GetRolesAsync → isHCAccess gate
    - var record = await _context.TrainingRecords.FindAsync(id); if null return NotFound();
    - Delete certificate file from disk if exists: if (!string.IsNullOrEmpty(record.SertifikatUrl)) { var path = Path.Combine(_env.WebRootPath, record.SertifikatUrl.TrimStart('/')); if (File.Exists(path)) File.Delete(path); }
    - _context.TrainingRecords.Remove(record);
    - await _context.SaveChangesAsync();
    - TempData["Success"] = "Training record berhasil dihapus.";
    - return RedirectToAction("WorkerDetail", new { workerId = workerId, name = workerName });
```
  </action>
  <verify>dotnet build — 0 errors. Confirm UnifiedTrainingRecord.cs has TrainingRecordId property. Confirm CMPController.cs has EditTrainingRecord POST and DeleteTrainingRecord POST actions but NO EditTrainingRecord GET. Confirm GetUnifiedRecords maps TrainingRecordId = t.Id. Confirm EditTrainingRecordViewModel has WorkerId, WorkerName, and ExistingSertifikatUrl properties.</verify>
  <done>Build succeeds with 0 errors. Two new controller actions present (POST only). TrainingRecordId wired through GetUnifiedRecords. WorkerId and WorkerName on ViewModel so no DB lookup needed in the POST redirect.</done>
</task>

<task type="auto">
  <name>Task 2: WorkerDetail.cshtml — per-row Bootstrap modals, action buttons, and TempData alerts</name>
  <files>
    Views/CMP/WorkerDetail.cshtml
  </files>
  <action>
**Views/CMP/WorkerDetail.cshtml** — Five changes. No separate EditTrainingRecord.cshtml is created; the edit form lives entirely inside modals rendered within this view.

1. **Add TempData alerts** — Immediately after the opening `<div class="container-fluid py-4">` tag and before the `<div class="row mb-4">` header row, insert:
```html
@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle me-2"></i>@TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>@TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}
```

2. **Add "Aksi" column header** — In the `<thead>` row, add after the existing Sertifikat `<th>`:
```html
<th class="p-3 text-center" style="width: 8%;">Aksi</th>
```
Reduce the Sertifikat column from `width: 6%` to `width: 5%` so total widths remain 100% (adjust one other narrow column if necessary to balance).

3. **Add action cell in the row loop** — In the `@foreach` loop, inside each `<tr>`, after the Sertifikat `<td>`, add:
```html
<td class="p-3 text-center">
    @if (item.RecordType == "Training Manual" && item.TrainingRecordId.HasValue)
    {
        <div class="d-flex gap-1 justify-content-center">
            <button type="button" class="btn btn-sm btn-outline-primary" title="Edit"
                    data-bs-toggle="modal" data-bs-target="#editModal-@item.TrainingRecordId">
                <i class="bi bi-pencil"></i>
            </button>
            <form method="post" action="@Url.Action("DeleteTrainingRecord", "CMP")" style="display:inline;">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@item.TrainingRecordId" />
                <input type="hidden" name="workerId" value="@workerId" />
                <input type="hidden" name="workerName" value="@workerName" />
                <button type="submit" class="btn btn-sm btn-outline-danger" title="Hapus"
                        onclick="return confirm('Hapus training record ini? Tindakan ini tidak dapat dibatalkan.')">
                    <i class="bi bi-trash"></i>
                </button>
            </form>
        </div>
    }
    else
    {
        <span class="text-muted">—</span>
    }
</td>
```

4. **Render one Bootstrap modal per Training Manual row** — After the closing `</table>` tag and before the closing `</div>` of the table-responsive wrapper, render modals. Each modal is unique per record using `item.TrainingRecordId` in its ID. Only Training Manual rows with a TrainingRecordId get a modal.

```html
@foreach (var item in Model.Where(x => x.RecordType == "Training Manual" && x.TrainingRecordId.HasValue))
{
    <div class="modal fade" id="editModal-@item.TrainingRecordId" tabindex="-1"
         aria-labelledby="editModalLabel-@item.TrainingRecordId" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold" id="editModalLabel-@item.TrainingRecordId">
                        <i class="bi bi-pencil-square me-2"></i>Edit Training Record
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" action="@Url.Action("EditTrainingRecord", "CMP")"
                      enctype="multipart/form-data">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="Id" value="@item.TrainingRecordId" />
                    <input type="hidden" name="WorkerId" value="@workerId" />
                    <input type="hidden" name="WorkerName" value="@workerName" />
                    <input type="hidden" name="ExistingSertifikatUrl" value="@item.SertifikatUrl" />
                    <div class="modal-body">
                        <div class="row g-3">
                            <!-- Judul -->
                            <div class="col-md-12">
                                <label class="form-label fw-bold small">Nama Pelatihan <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="Judul" value="@item.Title" required />
                            </div>
                            <!-- Penyelenggara & Kota -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold small">Penyelenggara <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="Penyelenggara" value="@item.Penyelenggara" required />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold small">Kota</label>
                                <input type="text" class="form-control" name="Kota" value="@item.Kota" />
                            </div>
                            <!-- Kategori -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold small">Kategori <span class="text-danger">*</span></label>
                                <select class="form-select" name="Kategori" required>
                                    @{
                                        var kategoriOptions = new[] { "Safety", "Technical", "Soft Skill", "Compliance", "Leadership", "Lainnya" };
                                        foreach (var opt in kategoriOptions)
                                        {
                                            if (item.Kategori == opt)
                                            { <option value="@opt" selected>@opt</option> }
                                            else
                                            { <option value="@opt">@opt</option> }
                                        }
                                    }
                                </select>
                            </div>
                            <!-- Status -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold small">Status <span class="text-danger">*</span></label>
                                <select class="form-select" name="Status" required>
                                    @{
                                        var statusOptions = new[] { "Passed", "Failed", "Wait Certificate", "Valid", "Expired" };
                                        foreach (var opt in statusOptions)
                                        {
                                            if (item.Status == opt)
                                            { <option value="@opt" selected>@opt</option> }
                                            else
                                            { <option value="@opt">@opt</option> }
                                        }
                                    }
                                </select>
                            </div>
                            <!-- Tanggal -->
                            <div class="col-md-4">
                                <label class="form-label fw-bold small">Tanggal <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" name="Tanggal"
                                       value="@item.Date.ToString("yyyy-MM-dd")" required />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold small">Tanggal Mulai</label>
                                <input type="date" class="form-control" name="TanggalMulai"
                                       value="@(item.TanggalMulai.HasValue ? item.TanggalMulai.Value.ToString("yyyy-MM-dd") : "")" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold small">Tanggal Selesai</label>
                                <input type="date" class="form-control" name="TanggalSelesai"
                                       value="@(item.TanggalSelesai.HasValue ? item.TanggalSelesai.Value.ToString("yyyy-MM-dd") : "")" />
                            </div>
                            <!-- Nomor Sertifikat & Berlaku Sampai & Certificate Type -->
                            <div class="col-md-4">
                                <label class="form-label fw-bold small">Nomor Sertifikat</label>
                                <input type="text" class="form-control" name="NomorSertifikat"
                                       value="@item.NomorSertifikat" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold small">Berlaku Sampai</label>
                                <input type="date" class="form-control" name="ValidUntil"
                                       value="@(item.ValidUntil.HasValue ? item.ValidUntil.Value.ToString("yyyy-MM-dd") : "")" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold small">Tipe Sertifikat</label>
                                <select class="form-select" name="CertificateType">
                                    <option value="">-- Pilih --</option>
                                    @{
                                        var certTypes = new[] { "Internal", "External", "International", "Regulator" };
                                        foreach (var opt in certTypes)
                                        {
                                            if (item.CertificateType == opt)
                                            { <option value="@opt" selected>@opt</option> }
                                            else
                                            { <option value="@opt">@opt</option> }
                                        }
                                    }
                                </select>
                            </div>
                            <!-- Certificate section -->
                            <div class="col-md-12">
                                <hr />
                                <label class="form-label fw-bold small">Sertifikat</label>
                                @if (!string.IsNullOrEmpty(item.SertifikatUrl))
                                {
                                    <div class="mb-2">
                                        <a href="@item.SertifikatUrl" target="_blank" class="btn btn-sm btn-outline-success">
                                            <i class="bi bi-download me-1"></i>Download Sertifikat Saat Ini
                                        </a>
                                        <small class="text-muted ms-2">Upload file baru di bawah untuk mengganti sertifikat ini.</small>
                                    </div>
                                }
                                <input type="file" class="form-control" name="CertificateFile"
                                       accept=".pdf,.jpg,.jpeg,.png" />
                                <div class="form-text">
                                    @(string.IsNullOrEmpty(item.SertifikatUrl)
                                        ? "Upload file sertifikat (PDF, JPG, PNG, maks. 10 MB)."
                                        : "Kosongkan jika tidak ingin mengganti sertifikat.")
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-floppy me-1"></i>Simpan Perubahan
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}
```

NOTE: UnifiedTrainingRecord must expose `Kota`, `NomorSertifikat`, `TanggalMulai`, `TanggalSelesai`, and `Kategori` properties for the modal pre-population. Check whether these exist on UnifiedTrainingRecord; if missing, add them (they exist on TrainingRecord and are needed by Razor). Map them in GetUnifiedRecords exactly as the other Training Manual fields are mapped.

5. **Update CSV export** — In the `exportWorkerRecords()` JS function, add "Aksi" to the CSV header string and an empty string cell for the new column (index 11, after Sertifikat at index 10). The action buttons contain no meaningful export data; an empty string is correct.

Change the header line from:
```js
let csv = 'No,Tanggal,Tipe,Nama/Judul,Score,Pass/Fail,Penyelenggara,Tipe Sertifikat,Berlaku Sampai,Status,Sertifikat\n';
```
To:
```js
let csv = 'No,Tanggal,Tipe,Nama/Judul,Score,Pass/Fail,Penyelenggara,Tipe Sertifikat,Berlaku Sampai,Status,Sertifikat,Aksi\n';
```

And in the row body, append `""` after the sertifikat cell:
```js
csv += `${no},"${tanggal}","${tipe}","${nama}","${score}","${passFail}","${penyelenggara}","${tipeSertifikat}","${berlakuSampai}","${status}","${sertifikat}",""\n`;
```
  </action>
  <verify>
dotnet build — 0 errors.
Navigate to /CMP/Records (as HC) → filter → click a worker → WorkerDetail loads.
Manual training rows show pencil (Edit) and trash (Delete) buttons in the Aksi column; Assessment Online rows show "—".
Click pencil on a manual row → Bootstrap modal opens with all fields pre-populated from that record's values; existing certificate download link shown if record has one.
Submit modal form → redirected to WorkerDetail; TempData success alert shows; changes visible in table row.
Click Delete → confirm() dialog appears → confirm → page reloads; row is gone; TempData success alert shows.
  </verify>
  <done>
- WorkerDetail renders with Aksi column; Training Manual rows have Edit (pencil) and Delete (trash) buttons; Assessment Online rows have "—"
- Edit pencil opens per-row Bootstrap modal pre-populated with current record values; no page navigation
- Modal shows current certificate download link if one exists
- Edit save: changes reflected in WorkerDetail on redirect; file replaced on disk if new file uploaded
- Delete with confirm(): record removed, certificate file deleted from disk, row gone from WorkerDetail on redirect
- dotnet build: 0 errors
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `dotnet build` — 0 errors
2. GET /CMP/WorkerDetail?workerId={id}&name={name} (as HC) — Aksi column present; manual rows have Edit+Delete buttons; assessment rows have "—"
3. Click pencil on manual row — Bootstrap modal opens pre-populated; no page navigation
4. POST /CMP/EditTrainingRecord (modal form submit) — fields updated in DB; new file replaces old file on disk; redirect to WorkerDetail with TempData success
5. POST /CMP/DeleteTrainingRecord — record removed from DB; certificate file deleted from disk; redirect to WorkerDetail with TempData success
6. Verify no EditTrainingRecord GET action exists in CMPController (modal approach is purely inline Razor + POST)
7. POST /CMP/EditTrainingRecord (as Coachee/Coach) — returns 403 Forbidden
8. POST /CMP/DeleteTrainingRecord (as Coachee) — returns 403 Forbidden
</verification>

<success_criteria>
- TRN-02 (Edit): HC can edit any manual training record via Bootstrap modal in WorkerDetail; all fields except Pekerja are editable; certificate replace works (old file physically deleted, new file saved and downloadable); no separate edit page exists
- TRN-03 (Delete): HC can delete any manual training record with browser confirm(); record row and certificate file both disappear
- Assessment Online rows in WorkerDetail have no Edit or Delete actions
- dotnet build: 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/20-edit-delete-recordsworkerlist-wiring/20-01-SUMMARY.md`
</output>
