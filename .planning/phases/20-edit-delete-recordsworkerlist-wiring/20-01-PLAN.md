---
phase: 20-edit-delete-recordsworkerlist-wiring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Models/UnifiedTrainingRecord.cs
  - Models/EditTrainingRecordViewModel.cs
  - Controllers/CMPController.cs
  - Views/CMP/WorkerDetail.cshtml
  - Views/CMP/EditTrainingRecord.cshtml
autonomous: true

must_haves:
  truths:
    - "HC sees Edit and Delete links only on Training Manual rows in WorkerDetail; Assessment Online rows have no such links"
    - "Clicking Edit navigates to a pre-populated form where HC can change any field except Pekerja"
    - "Saving the edit form updates the record and the change appears immediately when HC returns to WorkerDetail"
    - "Uploading a new file on the edit form replaces the old file on disk and the new file is downloadable"
    - "Clicking Delete with confirm() removes the record and its certificate file from disk; the row is gone on next load"
  artifacts:
    - path: "Models/EditTrainingRecordViewModel.cs"
      provides: "Edit form binding model — all fields except UserId"
      contains: "EditTrainingRecordViewModel"
    - path: "Models/UnifiedTrainingRecord.cs"
      provides: "TrainingRecordId property for Edit/Delete link generation"
      contains: "TrainingRecordId"
    - path: "Controllers/CMPController.cs"
      provides: "EditTrainingRecord GET+POST and DeleteTrainingRecord POST actions"
      exports: ["EditTrainingRecord", "DeleteTrainingRecord"]
    - path: "Views/CMP/EditTrainingRecord.cshtml"
      provides: "Pre-populated edit form with current certificate download link + new file upload"
      min_lines: 120
    - path: "Views/CMP/WorkerDetail.cshtml"
      provides: "Edit/Delete action cells on Training Manual rows; TempData success/error alerts"
      contains: "EditTrainingRecord"
  key_links:
    - from: "Views/CMP/WorkerDetail.cshtml"
      to: "/CMP/EditTrainingRecord"
      via: "Url.Action link on Training Manual rows using item.TrainingRecordId"
      pattern: "EditTrainingRecord.*TrainingRecordId"
    - from: "Views/CMP/WorkerDetail.cshtml"
      to: "/CMP/DeleteTrainingRecord"
      via: "form POST with confirm() onclick guard on Training Manual rows"
      pattern: "DeleteTrainingRecord.*TrainingRecordId"
    - from: "Controllers/CMPController.cs EditTrainingRecord POST"
      to: "wwwroot/uploads/certificates/"
      via: "File replace: delete old file at _env.WebRootPath + old SertifikatUrl, save new file with timestamp prefix"
      pattern: "File\\.Delete|CopyToAsync"
    - from: "Controllers/CMPController.cs DeleteTrainingRecord POST"
      to: "wwwroot/uploads/certificates/"
      via: "File.Delete on record.SertifikatUrl physical path before removing DB row"
      pattern: "File\\.Delete.*SertifikatUrl"
---

<objective>
HC or Admin can edit any existing manual training record (all fields except Pekerja) and delete any manual training record, both from WorkerDetail. Assessment Online rows are unaffected.

Purpose: Completes v1.6 TRN-02 and TRN-03 requirements — training records are now fully manageable (create, edit, delete) by HC/Admin.
Output: EditTrainingRecordViewModel, EditTrainingRecord GET/POST and DeleteTrainingRecord POST in CMPController, EditTrainingRecord.cshtml form, WorkerDetail updated with action links on manual rows.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/19-hc-create-training-record-certificate-upload/19-01-SUMMARY.md
@.planning/phases/18-data-foundation/18-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: EditTrainingRecordViewModel, controller actions, and UnifiedTrainingRecord.TrainingRecordId</name>
  <files>
    Models/EditTrainingRecordViewModel.cs
    Models/UnifiedTrainingRecord.cs
    Controllers/CMPController.cs
  </files>
  <action>
**Models/EditTrainingRecordViewModel.cs** — Create new file. Mirror CreateTrainingRecordViewModel but WITHOUT UserId (worker cannot be changed on edit). Add an `int Id` property (the TrainingRecord.Id being edited). All other fields identical to CreateTrainingRecordViewModel:
- `int Id` (no validation attribute — populated from route)
- `[Required] string Judul`
- `[Required] string Penyelenggara`
- `string? Kota`
- `[Required] string Kategori`
- `[Required] DateTime Tanggal` (default DateTime.Today)
- `DateTime? TanggalMulai`
- `DateTime? TanggalSelesai`
- `[Required] string Status` (default "Passed")
- `string? NomorSertifikat`
- `DateTime? ValidUntil`
- `string? CertificateType`
- `IFormFile? CertificateFile`
- `string? ExistingSertifikatUrl` — populated in GET so view can display current download link; not a form field, set by controller only

**Models/UnifiedTrainingRecord.cs** — Add one property:
```csharp
// TrainingRecord.Id — null for Assessment Online rows; used for Edit/Delete links
public int? TrainingRecordId { get; set; }
```

**Controllers/CMPController.cs** — Three changes:

1. **GetUnifiedRecords helper** — In the `trainings.Select(t => new UnifiedTrainingRecord { ... })` block, add:
```csharp
TrainingRecordId = t.Id,
```

2. **EditTrainingRecord GET** — Add after CreateTrainingRecord POST. Pattern matches CreateTrainingRecord GET exactly.
```
[HttpGet]
public async Task<IActionResult> EditTrainingRecord(int id)
    - GetUserAsync + GetRolesAsync → isHCAccess gate (Forbid if not HC/Admin)
    - var record = await _context.TrainingRecords.FindAsync(id);
    - if (record == null) return NotFound();
    - Build EditTrainingRecordViewModel from record fields (all fields including ExistingSertifikatUrl = record.SertifikatUrl)
    - return View(model);
```

3. **EditTrainingRecord POST** — Immediately after the GET.
```
[HttpPost]
[ValidateAntiForgeryToken]
public async Task<IActionResult> EditTrainingRecord(EditTrainingRecordViewModel model)
    - GetUserAsync + GetRolesAsync → isHCAccess gate
    - Validate file type/size (same as CreateTrainingRecord POST — allowed: .pdf .jpg .jpeg .png; max 10MB; add ModelState errors inline)
    - if (!ModelState.IsValid) { re-set model.ExistingSertifikatUrl from DB record; return View(model); }
    - var record = await _context.TrainingRecords.FindAsync(model.Id); if null return NotFound();
    - If model.CertificateFile != null && Length > 0:
        - Delete old file: if (!string.IsNullOrEmpty(record.SertifikatUrl)) { var oldPath = Path.Combine(_env.WebRootPath, record.SertifikatUrl.TrimStart('/')); if (File.Exists(oldPath)) File.Delete(oldPath); }
        - Save new file: timestamp-prefixed filename → wwwroot/uploads/certificates/ (same pattern as CreateTrainingRecord POST)
        - record.SertifikatUrl = new URL
      Else: keep record.SertifikatUrl unchanged
    - Update all other record fields from model (Judul, Penyelenggara, Kota, Kategori, Tanggal, TanggalMulai, TanggalSelesai, Status, NomorSertifikat, ValidUntil, CertificateType)
    - Do NOT update record.UserId — worker is immutable on edit
    - await _context.SaveChangesAsync();
    - TempData["Success"] = "Training record berhasil diperbarui.";
    - RedirectToAction("WorkerDetail", new { workerId = record.UserId, name = [fetch user name] })
      - Fetch name: var worker = await _context.Users.FindAsync(record.UserId); var workerName = worker?.FullName ?? "Worker";
```

4. **DeleteTrainingRecord POST** — Add after EditTrainingRecord POST.
```
[HttpPost]
[ValidateAntiForgeryToken]
public async Task<IActionResult> DeleteTrainingRecord(int id, string workerId, string workerName)
    - GetUserAsync + GetRolesAsync → isHCAccess gate
    - var record = await _context.TrainingRecords.FindAsync(id); if null return NotFound();
    - Delete certificate file from disk if exists: if (!string.IsNullOrEmpty(record.SertifikatUrl)) { var path = Path.Combine(_env.WebRootPath, record.SertifikatUrl.TrimStart('/')); if (File.Exists(path)) File.Delete(path); }
    - _context.TrainingRecords.Remove(record);
    - await _context.SaveChangesAsync();
    - TempData["Success"] = "Training record berhasil dihapus.";
    - return RedirectToAction("WorkerDetail", new { workerId = workerId, name = workerName });
```
  </action>
  <verify>dotnet build — 0 errors. Confirm UnifiedTrainingRecord.cs has TrainingRecordId property. Confirm CMPController.cs has EditTrainingRecord GET, EditTrainingRecord POST, and DeleteTrainingRecord POST actions. Confirm GetUnifiedRecords maps TrainingRecordId = t.Id.</verify>
  <done>Build succeeds with 0 errors. Three new controller actions present. TrainingRecordId wired through GetUnifiedRecords into UnifiedTrainingRecord.</done>
</task>

<task type="auto">
  <name>Task 2: EditTrainingRecord.cshtml form view and WorkerDetail.cshtml Edit/Delete links</name>
  <files>
    Views/CMP/EditTrainingRecord.cshtml
    Views/CMP/WorkerDetail.cshtml
  </files>
  <action>
**Views/CMP/EditTrainingRecord.cshtml** — Create new file. Model: `@model HcPortal.Models.EditTrainingRecordViewModel`. Structure mirrors CreateTrainingRecord.cshtml with these differences:
- Title: "Edit Training"
- Remove the "Data Pekerja" card entirely (worker is not editable on edit)
- Add hidden input: `<input type="hidden" asp-for="Id" />`
- Add hidden input: `<input type="hidden" asp-for="ExistingSertifikatUrl" />`
- Form action: `asp-action="EditTrainingRecord"` (POST to same action name)
- In the "Data Sertifikat" card, BEFORE the file upload input, add a "Sertifikat Saat Ini" display section:
  ```html
  @if (!string.IsNullOrEmpty(Model.ExistingSertifikatUrl))
  {
      <div class="col-md-12 mb-2">
          <label class="form-label fw-bold small text-muted">Sertifikat Saat Ini</label>
          <div>
              <a href="@Model.ExistingSertifikatUrl" target="_blank" class="btn btn-sm btn-outline-success">
                  <i class="bi bi-download me-1"></i>Download Sertifikat
              </a>
              <small class="text-muted ms-2">Upload file baru di bawah untuk mengganti sertifikat ini.</small>
          </div>
      </div>
  }
  ```
- File upload label text: "Ganti File Sertifikat (opsional)" with helper text "Kosongkan jika tidak ingin mengganti sertifikat."
- Back/Cancel link: `Url.Action("WorkerDetail", "CMP", new { workerId = ..., name = ... })` — since the ViewModel doesn't carry workerId, link back to Records instead: `Url.Action("Records", "CMP")`
- Card sections: "Data Training" (same fields as CreateTrainingRecord minus worker section) + "Data Sertifikat"

**Views/CMP/WorkerDetail.cshtml** — Four changes:

1. **Add TempData alerts** — After the outer `<div class="container-fluid py-4">` opening tag and before the header row, insert:
```html
@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle me-2"></i>@TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>@TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}
```

2. **Add "Aksi" column header** — In the `<thead>` row, add after the existing "Sertifikat" `<th>`:
```html
<th class="p-3 text-center" style="width: 8%;">Aksi</th>
```
Adjust the Sertifikat column from 6% to 5% to accommodate. Total widths must stay at 100%.

3. **Add action cell in the row loop** — In the `@foreach` loop, inside the `<tr>`, after the Sertifikat `<td>`, add a new `<td>`:
```html
<td class="p-3 text-center">
    @if (item.RecordType == "Training Manual" && item.TrainingRecordId.HasValue)
    {
        <div class="d-flex gap-1 justify-content-center">
            <a href="@Url.Action("EditTrainingRecord", "CMP", new { id = item.TrainingRecordId })"
               class="btn btn-sm btn-outline-primary" title="Edit">
                <i class="bi bi-pencil"></i>
            </a>
            <form method="post" action="@Url.Action("DeleteTrainingRecord", "CMP")" style="display:inline;">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@item.TrainingRecordId" />
                <input type="hidden" name="workerId" value="@workerId" />
                <input type="hidden" name="workerName" value="@workerName" />
                <button type="submit" class="btn btn-sm btn-outline-danger" title="Hapus"
                        onclick="return confirm('Hapus training record ini? Tindakan ini tidak dapat dibatalkan.')">
                    <i class="bi bi-trash"></i>
                </button>
            </form>
        </div>
    }
    else
    {
        <span class="text-muted">—</span>
    }
</td>
```

4. **Update CSV export** — In the `exportWorkerRecords()` JS function, add "Aksi" to the CSV header and an empty string cell for the new column (index 11) to keep the export aligned. The new column is action links so exporting as empty string is correct.
  </action>
  <verify>dotnet build — 0 errors. Navigate to /CMP/Records (as HC) → filter → click a worker → WorkerDetail loads. Manual training rows show pencil (Edit) and trash (Delete) buttons; Assessment Online rows show "—". Click Edit → EditTrainingRecord.cshtml renders with all fields pre-populated and existing certificate download link visible. Submit edit → redirected to WorkerDetail, TempData success alert shows, changes visible in row. Click Delete → confirm() appears → confirm → row gone and TempData success alert shows.</verify>
  <done>
- WorkerDetail renders with Aksi column; Training Manual rows have Edit and Delete buttons, Assessment Online rows have "—"
- EditTrainingRecord form loads pre-populated, shows current certificate download link
- Edit save: changes reflected in WorkerDetail on next load, file replaced on disk if new file uploaded
- Delete with confirm: record removed, certificate file deleted from disk, row gone from WorkerDetail
- dotnet build: 0 errors
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `dotnet build` — 0 errors
2. GET /CMP/WorkerDetail?workerId={id}&name={name} (as HC) — Aksi column present; manual rows have Edit+Delete buttons; assessment rows have "—"
3. GET /CMP/EditTrainingRecord?id={id} (as HC) — form renders with all fields pre-populated; "Sertifikat Saat Ini" download link shown if record has certificate
4. POST /CMP/EditTrainingRecord — fields updated in DB; new file replaces old file on disk; redirect to WorkerDetail with TempData success
5. POST /CMP/DeleteTrainingRecord — record removed from DB; certificate file deleted from disk; redirect to WorkerDetail with TempData success
6. GET /CMP/EditTrainingRecord?id={id} (as Coachee/Coach) — returns 403 Forbidden
7. POST /CMP/DeleteTrainingRecord (as Coachee) — returns 403 Forbidden
</verification>

<success_criteria>
- TRN-02 (Edit): HC can edit any manual training record; all fields except Pekerja are editable; certificate replace works (old file physically deleted, new file saved and downloadable)
- TRN-03 (Delete): HC can delete any manual training record with browser confirm(); record row and certificate file both disappear
- Assessment Online rows in WorkerDetail have no Edit or Delete actions
- dotnet build: 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/20-edit-delete-recordsworkerlist-wiring/20-01-SUMMARY.md`
</output>
