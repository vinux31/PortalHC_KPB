---
phase: 21-exam-state-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Models/AssessmentSession.cs
  - Migrations/{timestamp}_AddExamStateFields.cs
  - Controllers/CMPController.cs
  - Models/AssessmentMonitoringViewModel.cs
  - Views/CMP/AssessmentMonitoringDetail.cshtml
autonomous: true

must_haves:
  truths:
    - "When a worker loads StartExam for the first time, session Status changes to InProgress and StartedAt is recorded"
    - "Reloading the exam page does not reset StartedAt — the timestamp is only written when StartedAt is null"
    - "InProgress status is visible as a distinct badge in the monitoring detail view alongside Open and Completed"
  artifacts:
    - path: "Models/AssessmentSession.cs"
      provides: "StartedAt nullable DateTime property on AssessmentSession"
      contains: "DateTime? StartedAt"
    - path: "Controllers/CMPController.cs"
      provides: "Idempotent InProgress state write in StartExam GET"
      contains: "assessment.StartedAt == null"
    - path: "Models/AssessmentMonitoringViewModel.cs"
      provides: "InProgress status derivation in MonitoringSessionViewModel"
      contains: "InProgress"
    - path: "Views/CMP/AssessmentMonitoringDetail.cshtml"
      provides: "InProgress badge rendering in per-user status table"
      contains: "bg-warning"
  key_links:
    - from: "Controllers/CMPController.cs (StartExam GET)"
      to: "AssessmentSessions table"
      via: "_context.SaveChangesAsync() after setting Status=InProgress and StartedAt"
      pattern: "assessment\\.StartedAt\\s*==\\s*null"
    - from: "Controllers/CMPController.cs (AssessmentMonitoringDetail)"
      to: "Models/AssessmentMonitoringViewModel.cs"
      via: "UserStatus set to InProgress when StartedAt is set and CompletedAt is null"
      pattern: "InProgress"
    - from: "Views/CMP/AssessmentMonitoringDetail.cshtml"
      to: "MonitoringSessionViewModel.UserStatus"
      via: "statusClass switch/ternary renders InProgress as bg-warning badge"
      pattern: "InProgress"
---

<objective>
Add the InProgress exam state to the assessment session lifecycle: when a worker loads the StartExam page for the first time, the system records StartedAt and transitions their session status from Open to InProgress. The monitoring detail view surfaces this new status.

Purpose: Closes LIFE-01. Gives HC real-time visibility into who is actively taking an exam versus who has not started. Forms the foundation for Phase 22 lifecycle actions (abandon, force-close, server-side timer).

Output: EF Core migration adding StartedAt (nullable DateTime) to AssessmentSessions, idempotent state-write in StartExam GET, InProgress visible in monitoring detail.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Models/AssessmentSession.cs
@Controllers/CMPController.cs
@Models/AssessmentMonitoringViewModel.cs
@Views/CMP/AssessmentMonitoringDetail.cshtml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add StartedAt column — model property + EF migration</name>
  <files>Models/AssessmentSession.cs</files>
  <files>Migrations/{timestamp}_AddExamStateFields.cs (generated)</files>
  <action>
1. Open `Models/AssessmentSession.cs`. After the existing `CompletedAt` property (line 36), add:

```csharp
public DateTime? StartedAt { get; set; }
```

No annotation needed — nullable DateTime maps to datetime2 nullable in SQL Server by convention.

2. Run the EF migration to add the column:

```bash
dotnet ef migrations add AddExamStateFields
```

Verify the generated migration file contains:

```csharp
migrationBuilder.AddColumn<DateTime>(
    name: "StartedAt",
    table: "AssessmentSessions",
    type: "datetime2",
    nullable: true);
```

3. Apply the migration:

```bash
dotnet ef database update
```

Note: Do NOT add "InProgress" or "Abandoned" as a database-enforced enum/check constraint. Status is stored as a plain string ("Open", "Upcoming", "Completed", "InProgress", "Abandoned") — no schema constraint exists on valid values. New status strings are valid as-is once the model and views handle them.
  </action>
  <verify>
Run: `dotnet build` — must compile with 0 errors.
Run: `dotnet ef database update` — must report "No pending migrations" or apply successfully.
Inspect the generated migration .cs file: must contain `AddColumn` for `StartedAt` on `AssessmentSessions` with `nullable: true`.
  </verify>
  <done>
`Models/AssessmentSession.cs` has `public DateTime? StartedAt { get; set; }`. Migration file exists under Migrations/. `dotnet ef database update` succeeds. `dotnet build` is clean.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire InProgress state — StartExam GET + monitoring detail controller + view</name>
  <files>Controllers/CMPController.cs</files>
  <files>Models/AssessmentMonitoringViewModel.cs</files>
  <files>Views/CMP/AssessmentMonitoringDetail.cshtml</files>
  <action>
**A. CMPController.cs — StartExam GET (around line 1527)**

After the existing `Completed` check (which redirects away) and before building the ViewModel, add the idempotent InProgress state write. Insert after line ~1543 (after `if (assessment.Status == "Completed") { ... }`):

```csharp
// Mark InProgress on first load only (idempotent — skip if already started)
if (assessment.StartedAt == null)
{
    assessment.Status = "InProgress";
    assessment.StartedAt = DateTime.UtcNow;
    await _context.SaveChangesAsync();
}
```

Important: The guard is `assessment.StartedAt == null`, NOT `assessment.Status != "InProgress"`. This ensures idempotency is based on the timestamp, not the status string, so if Status gets updated by another path (e.g., a race), the timestamp is still only written once.

**B. CMPController.cs — AssessmentMonitoringDetail (around line 324)**

The current logic for `UserStatus` is:
```csharp
bool isCompleted = a.Score != null || a.CompletedAt != null;
return new MonitoringSessionViewModel
{
    ...
    UserStatus = isCompleted ? "Completed" : "Not started",
```

Replace this with three-state logic:

```csharp
string userStatus;
if (a.CompletedAt != null || a.Score != null)
    userStatus = "Completed";
else if (a.StartedAt != null)
    userStatus = "InProgress";
else
    userStatus = "Not started";

return new MonitoringSessionViewModel
{
    Id           = a.Id,
    UserFullName = a.User?.FullName ?? "Unknown",
    UserNIP      = a.User?.NIP ?? "",
    UserStatus   = userStatus,
    Score        = a.Score,
    IsPassed     = a.IsPassed,
    CompletedAt  = a.CompletedAt,
    StartedAt    = a.StartedAt
};
```

Also update the `CompletedCount` and related counts — `CompletedCount` logic already uses `s.UserStatus == "Completed"` which remains correct. `GroupStatus` derivation uses raw session `a.Status` from the DB, which will now include "InProgress" — update that line too:

```csharp
GroupStatus = sessions.Any(a => a.Status == "Open" || a.Status == "InProgress") ? "Open"
            : sessions.Any(a => a.Status == "Upcoming") ? "Upcoming" : "Closed"
```

(InProgress sessions keep the group as "Open" from HC's perspective.)

**C. Models/AssessmentMonitoringViewModel.cs — MonitoringSessionViewModel**

Add `StartedAt` property:

```csharp
public DateTime? StartedAt { get; set; }
```

**D. Views/CMP/AssessmentMonitoringDetail.cshtml — per-user status badge**

Currently (line 117):
```csharp
var statusClass = session.UserStatus == "Completed" ? "bg-success" : "bg-light text-dark border";
```

Replace with three-way badge:

```csharp
var statusClass = session.UserStatus switch
{
    "Completed"   => "bg-success",
    "InProgress"  => "bg-warning text-dark",
    _             => "bg-light text-dark border"
};
```

No other view changes are required. The `StartedAt` column is not shown in the monitoring table for this phase (Phase 22 may surface it with a timer display).
  </action>
  <verify>
1. `dotnet build` — 0 errors.
2. Run the application. As HC, open AssessmentMonitoringDetail for a group with Open sessions — verify all show "Not started" (bg-light border badge).
3. As a worker, navigate to the StartExam page for one of those sessions.
4. Reload the StartExam page (F5) — the page loads normally.
5. As HC, refresh AssessmentMonitoringDetail — verify the worker's row now shows "InProgress" badge (yellow/warning).
6. Check the DB directly: `SELECT Id, Status, StartedAt FROM AssessmentSessions WHERE Id = {session_id}` — Status = 'InProgress', StartedAt has a timestamp, not NULL.
7. Reload the exam page again as worker — Status and StartedAt must not change (idempotent confirmed).
  </verify>
  <done>
Worker who visited StartExam has Status='InProgress' and StartedAt set in DB. Subsequent reloads do not change StartedAt. AssessmentMonitoringDetail shows 3 distinct status badges: "Not started" (light border), "InProgress" (warning/yellow), "Completed" (green). dotnet build is clean.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` produces 0 errors and 0 warnings related to new code.
2. EF migration applied: `AssessmentSessions` table has `StartedAt datetime2 NULL` column.
3. First load of StartExam: session Status = 'InProgress', StartedAt = UTC timestamp in DB.
4. Second load of StartExam: StartedAt unchanged (same timestamp), Status still 'InProgress'.
5. AssessmentMonitoringDetail view displays three status states with correct badge colors.
6. Completed sessions (Score != null or CompletedAt != null) still show "Completed" — not broken by new logic.
</verification>

<success_criteria>
- LIFE-01 satisfied: System records StartedAt and sets InProgress on first exam load.
- Idempotent: Reloading exam does not reset StartedAt.
- Monitoring visibility: InProgress badge appears for in-progress workers in AssessmentMonitoringDetail.
- No regression: Completed sessions, Open sessions, and Upcoming status derivations remain correct.
- Build clean: `dotnet build` exits 0.
</success_criteria>

<output>
After completion, create `.planning/phases/21-exam-state-foundation/21-01-SUMMARY.md` using the summary template.
</output>
