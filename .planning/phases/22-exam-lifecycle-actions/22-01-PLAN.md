---
phase: 22-exam-lifecycle-actions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Models/AssessmentSession.cs
  - Controllers/CMPController.cs
  - Views/CMP/CreateAssessment.cshtml
  - Views/CMP/EditAssessment.cshtml
  - Migrations/<timestamp>_AddExamWindowCloseDate.cs
autonomous: true

must_haves:
  truths:
    - "ExamWindowCloseDate column exists on AssessmentSessions table in the database"
    - "HC can enter an exam window close date on the Create Assessment form and it is saved to the session"
    - "HC can enter or update an exam window close date on the Edit Assessment form and it is saved"
    - "A worker navigating to StartExam GET after the ExamWindowCloseDate has passed sees a 'Ujian sudah ditutup' message and is redirected back to the assessment lobby — the exam does NOT load"
    - "A worker navigating to StartExam GET before the ExamWindowCloseDate (or when it is null) proceeds normally into the exam"
  artifacts:
    - path: "Models/AssessmentSession.cs"
      provides: "ExamWindowCloseDate nullable DateTime property"
      contains: "ExamWindowCloseDate"
    - path: "Controllers/CMPController.cs"
      provides: "Close date check in StartExam GET; ExamWindowCloseDate binding in CreateAssessment POST and EditAssessment POST"
      contains: "ExamWindowCloseDate"
    - path: "Views/CMP/CreateAssessment.cshtml"
      provides: "Date input field for ExamWindowCloseDate"
      contains: "ExamWindowCloseDate"
    - path: "Views/CMP/EditAssessment.cshtml"
      provides: "Date input field for ExamWindowCloseDate"
      contains: "ExamWindowCloseDate"
  key_links:
    - from: "StartExam GET (~line 1536)"
      to: "assessment.ExamWindowCloseDate"
      via: "null check + date comparison before InProgress write"
      pattern: "ExamWindowCloseDate.*DateTime.UtcNow|DateTime.UtcNow.*ExamWindowCloseDate"
    - from: "CreateAssessment POST / EditAssessment POST"
      to: "assessment.ExamWindowCloseDate"
      via: "model binding or explicit assignment"
      pattern: "ExamWindowCloseDate"
---

<objective>
Add ExamWindowCloseDate (nullable DateTime) to AssessmentSession and enforce it in StartExam GET so workers cannot start an exam after the configured close date.

Purpose: Satisfies requirement DATA-03 — HC can set a hard close date on an exam; workers who attempt to start after that date are turned away with a clear Indonesian-language message.

Output: EF migration creating the column; ExamWindowCloseDate field in Create/Edit Assessment forms with controller binding; close-date guard inserted at the top of StartExam GET (before the InProgress write) that redirects workers to the assessment lobby with TempData["Error"] = "Ujian sudah ditutup." if DateTime.UtcNow > assessment.ExamWindowCloseDate.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Models/AssessmentSession.cs
@Controllers/CMPController.cs
@Views/CMP/CreateAssessment.cshtml
@Views/CMP/EditAssessment.cshtml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ExamWindowCloseDate to AssessmentSession model and run EF migration</name>
  <files>Models/AssessmentSession.cs</files>
  <action>
Add the following property to AssessmentSession.cs, after the existing `StartedAt` property (around line 37):

```csharp
/// <summary>
/// Optional hard cutoff date for this exam window. Workers cannot start (or restart) the exam
/// after this date. Null = no expiry enforced.
/// </summary>
public DateTime? ExamWindowCloseDate { get; set; }
```

Then run the EF Core migration to add the column to the database:

```bash
dotnet ef migrations add AddExamWindowCloseDate --project HcPortal.csproj
dotnet ef database update --project HcPortal.csproj
```

The migration should produce an `AddColumn` of type `datetime2`, nullable, on `AssessmentSessions`.

Do NOT add a [Required] attribute — the field is explicitly optional (null = no close date).
Do NOT rename any existing fields.
  </action>
  <verify>
Run:
```bash
dotnet build
```
Build must succeed with 0 errors.

Also verify the migration file exists under Migrations/ and contains:
```csharp
migrationBuilder.AddColumn<DateTime>(
    name: "ExamWindowCloseDate",
    table: "AssessmentSessions",
    ...
    nullable: true);
```
  </verify>
  <done>AssessmentSession.cs has `public DateTime? ExamWindowCloseDate { get; set; }`. Migration file exists. `dotnet build` passes. `dotnet ef database update` completes without error.</done>
</task>

<task type="auto">
  <name>Task 2: Enforce close date in StartExam GET and bind ExamWindowCloseDate in Create/Edit forms + controller</name>
  <files>
    Controllers/CMPController.cs
    Views/CMP/CreateAssessment.cshtml
    Views/CMP/EditAssessment.cshtml
  </files>
  <action>
**CMPController.cs — StartExam GET (around line 1536):**

Insert two guard blocks AFTER the existing "Completed" status guard and BEFORE the `StartedAt == null` InProgress write:

```csharp
// Enforce exam window close date (LIFE-02 / DATA-03)
if (assessment.ExamWindowCloseDate.HasValue && DateTime.UtcNow > assessment.ExamWindowCloseDate.Value)
{
    TempData["Error"] = "Ujian sudah ditutup. Waktu ujian telah berakhir.";
    return RedirectToAction("Assessment");
}

// Block re-entry of Abandoned sessions — worker must contact HC for Reset (LIFE-02)
if (assessment.Status == "Abandoned")
{
    TempData["Error"] = "Ujian Anda sebelumnya telah dibatalkan. Hubungi HC untuk mengulang.";
    return RedirectToAction("Assessment");
}
```

Place both blocks immediately after:
```csharp
if (assessment.Status == "Completed")
{
    TempData["Error"] = "This assessment has already been completed.";
    return RedirectToAction("Assessment");
}
```

The Abandoned guard must come BEFORE the `StartedAt == null` check — Abandoned sessions always have StartedAt set (preserved per design), so without this guard they would silently reload the exam page instead of blocking.

---

**CMPController.cs — CreateAssessment POST (around line 791):**

In the block where sessions are constructed per user (the `foreach (var userId in UserIds)` loop), add `ExamWindowCloseDate = model.ExamWindowCloseDate` to each new `AssessmentSession` object initializer. The `model.ExamWindowCloseDate` is already model-bound from the form; no extra binding code is required. The nullable field binds correctly if the input is empty.

Also add `ModelState.Remove("ExamWindowCloseDate")` just above the `if (!ModelState.IsValid)` check to prevent any accidental validation failure on an optional field (not required per model annotation, but defensive).

---

**CMPController.cs — EditAssessment POST (around line 465):**

In the block that updates fields on the loaded `assessment` object (where `assessment.Title = model.Title` etc.), add:

```csharp
assessment.ExamWindowCloseDate = model.ExamWindowCloseDate;
```

This replaces whatever the existing value was (including clearing it to null if the user blanked the date input).

---

**Views/CMP/CreateAssessment.cshtml:**

Add the ExamWindowCloseDate date input inside the Assessment Settings card section (`<div class="card border-secondary mb-4">`), after the AllowAnswerReview toggle row. Insert a new `<div class="row">` block:

```html
<!-- Exam Window Close Date -->
<div class="row mb-3">
    <div class="col-md-6">
        <label asp-for="ExamWindowCloseDate" class="form-label fw-semibold">
            <i class="bi bi-calendar-x text-danger me-1"></i>
            Tanggal Tutup Ujian (Opsional)
        </label>
        <input asp-for="ExamWindowCloseDate" type="date" class="form-control" />
        <div class="form-text text-muted">
            Jika diisi, peserta tidak dapat memulai ujian setelah tanggal ini.
            Kosongkan jika tidak ada batas waktu.
        </div>
    </div>
</div>
```

---

**Views/CMP/EditAssessment.cshtml:**

Add the same field in the equivalent location in EditAssessment.cshtml (inside the settings card area, after AllowAnswerReview):

```html
<!-- Exam Window Close Date -->
<div class="row mb-3">
    <div class="col-md-6">
        <label asp-for="ExamWindowCloseDate" class="form-label fw-semibold">
            <i class="bi bi-calendar-x text-danger me-1"></i>
            Tanggal Tutup Ujian (Opsional)
        </label>
        <input asp-for="ExamWindowCloseDate" type="date" class="form-control" />
        <div class="form-text text-muted">
            Jika diisi, peserta tidak dapat memulai ujian setelah tanggal ini.
            Kosongkan jika tidak ada batas waktu.
        </div>
    </div>
</div>
```

The `asp-for="ExamWindowCloseDate"` tag helper will pre-populate the value from the model and format it correctly for the `type="date"` input.

Note on bulk-assign in EditAssessment POST: when sibling sessions are bulk-created in the `if (NewUserIds != null && NewUserIds.Count > 0)` block, add `ExamWindowCloseDate = savedAssessment.ExamWindowCloseDate` to each new session initializer as well — consistent with how other fields like PassPercentage and AllowAnswerReview are copied.
  </action>
  <verify>
1. Run `dotnet build` — must pass with 0 errors.
2. Run the app and navigate to Create Assessment: the form must render without error and show the "Tanggal Tutup Ujian" date input.
3. Navigate to Edit Assessment for any existing session: the form must render, showing the date input (blank if ExamWindowCloseDate is null).
4. Check that StartExam GET contains `ExamWindowCloseDate.HasValue` guard by grepping:
   ```bash
   grep -n "ExamWindowCloseDate" Controllers/CMPController.cs
   ```
   Should show hits in: StartExam GET, CreateAssessment POST, EditAssessment POST.
  </verify>
  <done>
- `dotnet build` passes.
- Create Assessment and Edit Assessment forms both render the ExamWindowCloseDate date input.
- Navigating to `/CMP/StartExam/{id}` for a session whose ExamWindowCloseDate is in the past redirects to the Assessment lobby with TempData error "Ujian sudah ditutup."
- Navigating to StartExam for a session with null ExamWindowCloseDate proceeds normally.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` passes with 0 errors.
2. Migration file exists with `AddColumn ExamWindowCloseDate datetime2 nullable`.
3. Grep CMPController.cs for "ExamWindowCloseDate" — hits in StartExam GET guard, CreateAssessment POST session initializer, EditAssessment POST field assignment, bulk-assign session initializer.
4. CreateAssessment.cshtml and EditAssessment.cshtml both contain `ExamWindowCloseDate` inputs.
5. Manual test (or code review): StartExam GET close date check appears BEFORE the InProgress write, not after.
</verification>

<success_criteria>
- ExamWindowCloseDate nullable DateTime column exists in the database (migration applied).
- HC can set and clear the close date via Create/Edit Assessment forms.
- Workers attempting StartExam after the close date are blocked with "Ujian sudah ditutup." message.
- Workers attempting StartExam with null close date or before the close date are not blocked.
</success_criteria>

<output>
After completion, create `.planning/phases/22-exam-lifecycle-actions/22-01-SUMMARY.md`
</output>
