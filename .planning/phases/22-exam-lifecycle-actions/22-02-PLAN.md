---
phase: 22-exam-lifecycle-actions
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Controllers/CMPController.cs
  - Views/CMP/StartExam.cshtml
autonomous: true

must_haves:
  truths:
    - "A worker sees a 'Keluar Ujian' button on the exam page while the exam is in progress"
    - "Clicking 'Keluar Ujian' shows a confirmation dialog (browser confirm or Bootstrap modal); if confirmed, the session Status becomes 'Abandoned' and the worker is redirected to the Assessment lobby"
    - "If the worker dismisses the confirmation, nothing changes and the exam continues normally"
    - "The 'Keluar Ujian' action bypasses the window.onbeforeunload guard so the unload warning does not fire after the user already confirmed"
    - "StartedAt is preserved on the abandoned session (not cleared) so HC can see when the exam was started"
  artifacts:
    - path: "Controllers/CMPController.cs"
      provides: "AbandonExam POST action setting Status=Abandoned"
      contains: "AbandonExam"
    - path: "Views/CMP/StartExam.cshtml"
      provides: "Keluar Ujian button with confirmation; clears onbeforeunload before submitting the abandon form"
      contains: "Keluar Ujian"
  key_links:
    - from: "Views/CMP/StartExam.cshtml (Keluar Ujian button)"
      to: "/CMP/AbandonExam"
      via: "hidden form POST submitted by JavaScript after confirm()"
      pattern: "AbandonExam"
    - from: "AbandonExam POST"
      to: "assessment.Status"
      via: "assignment Status = \"Abandoned\"; SaveChangesAsync"
      pattern: "Status.*Abandoned|Abandoned.*Status"
---

<objective>
Add an "Keluar Ujian" (Exit Exam) button on the StartExam page so workers can intentionally abandon an in-progress exam. Clicking it (after confirmation) marks the session Abandoned and returns the worker to the Assessment lobby.

Purpose: Satisfies requirement LIFE-02 — workers need a sanctioned way to exit without losing their session state. (HC actions on Abandoned sessions — Reset for retake — are LIFE-04, handled in Plan 22-04.)

Output: AbandonExam POST action in CMPController; "Keluar Ujian" button in StartExam.cshtml that calls confirm() and bypasses onbeforeunload; session Status = "Abandoned", StartedAt preserved.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Controllers/CMPController.cs
@Views/CMP/StartExam.cshtml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AbandonExam POST action to CMPController</name>
  <files>Controllers/CMPController.cs</files>
  <action>
Add a new `AbandonExam` POST action to CMPController. Place it immediately after the `StartExam` GET action (after line ~1560 in the current file).

```csharp
[HttpPost]
[ValidateAntiForgeryToken]
public async Task<IActionResult> AbandonExam(int id)
{
    var assessment = await _context.AssessmentSessions
        .FirstOrDefaultAsync(a => a.Id == id);

    if (assessment == null) return NotFound();

    // Authorization: only the session owner can abandon their own exam
    var user = await _userManager.GetUserAsync(User);
    if (user == null) return Challenge();
    if (assessment.UserId != user.Id)
        return Forbid();

    // Only abandon if currently InProgress (idempotent guard)
    if (assessment.Status != "InProgress" && assessment.Status != "Open")
    {
        TempData["Error"] = "Sesi ujian ini tidak dapat dibatalkan dalam status saat ini.";
        return RedirectToAction("Assessment");
    }

    // Mark Abandoned — keep StartedAt so HC can see when the exam was started
    assessment.Status = "Abandoned";
    assessment.UpdatedAt = DateTime.UtcNow;

    await _context.SaveChangesAsync();

    TempData["Info"] = "Ujian telah dibatalkan. Hubungi HC jika Anda ingin mengulang.";
    return RedirectToAction("Assessment");
}
```

Implementation notes:
- Do NOT clear `StartedAt` — per design decision, HC needs it to audit when the exam started. HC will use the Reset action (Plan 22-04) to clear it for a retake.
- Do NOT clear `Score`, `IsPassed`, or `CompletedAt` — they should remain null for an Abandoned session.
- Status "Abandoned" is a plain string value consistent with the existing Status field convention (no DB constraint change required).
- The action uses `[ValidateAntiForgeryToken]` — the form in the view must include `@Html.AntiForgeryToken()`.
- No `[Authorize(Roles = "Admin, HC")]` — this is a worker-facing action; only the session owner may call it (enforced by the `assessment.UserId != user.Id` check).
  </action>
  <verify>
Run `dotnet build` — must pass with 0 errors.

Grep to confirm the action is present:
```bash
grep -n "AbandonExam" Controllers/CMPController.cs
```
Expected: hits for both the `[HttpPost]` attribute line and the method signature.
  </verify>
  <done>`dotnet build` passes. `AbandonExam` POST action exists in CMPController, sets `Status = "Abandoned"`, keeps `StartedAt`, redirects to Assessment lobby.</done>
</task>

<task type="auto">
  <name>Task 2: Add "Keluar Ujian" button to StartExam view with confirmation and onbeforeunload bypass</name>
  <files>Views/CMP/StartExam.cshtml</files>
  <action>
**In the sticky header (`<div class="sticky-top ... " id="examHeader">`):**

The current header contains a `d-flex justify-content-between` row with exam title/progress on the left and the timer on the right. Add a "Keluar Ujian" button between them (or to the right side, before the timer). Insert it inside the header's flex row:

```html
<!-- Keluar Ujian button -->
<div>
    <button type="button" class="btn btn-outline-danger btn-sm"
            onclick="confirmAbandon()">
        <i class="bi bi-box-arrow-left me-1"></i>Keluar Ujian
    </button>
</div>
```

**Hidden abandon form (place just after the closing `</div>` of the sticky header, before the `@if (!Model.Questions.Any())` block):**

```html
<!-- Hidden form for abandon action -->
<form id="abandonForm" asp-action="AbandonExam" method="post" style="display:none">
    @Html.AntiForgeryToken()
    <input type="hidden" name="id" value="@Model.AssessmentSessionId" />
</form>
```

**In the `<script>` section, add the `confirmAbandon()` function.** Place it BEFORE the `window.onbeforeunload` assignment (anywhere in the script block is fine):

```javascript
// -------- Abandon exam --------
function confirmAbandon() {
    var confirmed = confirm(
        'Anda yakin ingin keluar dari ujian?\n\n' +
        'Status ujian Anda akan dicatat sebagai "Ditinggalkan".\n' +
        'Hubungi HC untuk mengulang ujian.'
    );
    if (confirmed) {
        // Bypass the onbeforeunload warning — user already confirmed
        window.onbeforeunload = null;
        document.getElementById('abandonForm').submit();
    }
}
```

**Update the existing `window.onbeforeunload` exemption block:**

The current code already exempts the `examForm` submit from triggering `onbeforeunload`:

```javascript
document.getElementById('examForm').addEventListener('submit', function() {
    window.onbeforeunload = null;
});
```

The `confirmAbandon()` function handles its own `window.onbeforeunload = null` before submitting `abandonForm`, so no additional changes are needed to the existing exemption block.

Do NOT use `window.confirm()` inside the `onbeforeunload` handler — that causes double-prompt issues. The confirm() in `confirmAbandon()` runs before `onbeforeunload` is cleared, which is correct.
  </action>
  <verify>
1. Run `dotnet build` — must pass.
2. Grep to confirm the button and form are present:
   ```bash
   grep -n "Keluar Ujian\|abandonForm\|confirmAbandon\|AbandonExam" Views/CMP/StartExam.cshtml
   ```
   Should return lines for: the button text "Keluar Ujian", the form id "abandonForm", the JS function "confirmAbandon", and the `asp-action="AbandonExam"`.
3. Verify the abandon form includes `@Html.AntiForgeryToken()` and the hidden `name="id"` input.
  </verify>
  <done>
- `dotnet build` passes.
- StartExam.cshtml renders a "Keluar Ujian" button in the sticky header.
- Clicking the button triggers a browser `confirm()` dialog in Indonesian.
- Confirming submits the hidden `#abandonForm` POST to AbandonExam with the session id and CSRF token.
- Dismissing the dialog leaves the exam running normally.
- The `window.onbeforeunload` unload warning does NOT fire after the user confirms the abandon.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` passes with 0 errors.
2. `grep -n "AbandonExam\|Abandoned" Controllers/CMPController.cs` — shows the POST action and Status assignment.
3. `grep -n "Keluar Ujian\|abandonForm\|confirmAbandon" Views/CMP/StartExam.cshtml` — shows button, form, and JS function.
4. Code review: AbandonExam POST checks `assessment.UserId != user.Id` before proceeding.
5. Code review: AbandonExam sets `Status = "Abandoned"` but does NOT clear `StartedAt`.
</verification>

<success_criteria>
- "Keluar Ujian" button visible on the exam page.
- Clicking triggers Indonesian-language confirmation dialog.
- Confirming: session Status = "Abandoned", worker redirected to Assessment lobby with "Ujian telah dibatalkan" info message.
- Dismissing: exam continues unaffected, no navigation occurs.
- StartedAt is preserved on the Abandoned session.
</success_criteria>

<output>
After completion, create `.planning/phases/22-exam-lifecycle-actions/22-02-SUMMARY.md`
</output>
