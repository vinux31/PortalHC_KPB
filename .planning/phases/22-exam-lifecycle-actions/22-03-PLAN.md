---
phase: 22-exam-lifecycle-actions
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - Controllers/CMPController.cs
autonomous: true

must_haves:
  truths:
    - "A worker who submits an exam after the allowed time (DurationMinutes + 2 minute grace) is rejected — the submission is NOT graded"
    - "A rejected submission redirects the worker back to the StartExam page (not the Assessment lobby) with a clear 'Waktu ujian Anda telah habis' error message"
    - "A worker who submits within the allowed time window (elapsed <= DurationMinutes + 2 minutes) is graded normally — existing grading logic is unchanged"
    - "If StartedAt is null on the session, the elapsed time check is skipped and grading proceeds (defensive: prevents blocking legacy sessions without StartedAt)"
  artifacts:
    - path: "Controllers/CMPController.cs"
      provides: "Elapsed-time check in SubmitExam POST before grading logic"
      contains: "StartedAt.*DurationMinutes|DurationMinutes.*StartedAt"
  key_links:
    - from: "SubmitExam POST (~line 1939)"
      to: "assessment.StartedAt"
      via: "DateTime.UtcNow - assessment.StartedAt.Value compared against DurationMinutes + 2 minutes"
      pattern: "StartedAt.*TotalMinutes|TotalMinutes.*DurationMinutes"
---

<objective>
Add a server-side elapsed-time check to SubmitExam POST so that submissions made after the exam's DurationMinutes (plus a 2-minute grace period) are rejected server-side, preventing clock-manipulation cheating.

Purpose: Satisfies requirement LIFE-03 — the server enforces the timer, not just the browser countdown. The 2-minute grace accounts for network latency and slow connections.

Output: A single guard block inserted into SubmitExam POST immediately before the package/legacy path branch. If elapsed time exceeds DurationMinutes + 2 minutes, redirect back to StartExam with a TempData error. No grading changes.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Controllers/CMPController.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Insert elapsed-time check in SubmitExam POST before grading</name>
  <files>Controllers/CMPController.cs</files>
  <action>
Locate the `SubmitExam` POST action (currently around line 1939). The existing structure is:

```csharp
// Prevent re-submission of completed assessments
if (assessment.Status == "Completed") { ... }

// Check for package path — must happen before any grading logic
var packageAssignment = await _context.UserPackageAssignments...
```

Insert the elapsed-time check AFTER the "re-submission" completed guard and BEFORE the `UserPackageAssignments` lookup:

```csharp
// ---- Server-side timer enforcement (LIFE-03) ----
// Grace period: 2 minutes to account for network latency and slow connections.
// Skip check if StartedAt is null (legacy sessions that existed before Phase 21).
if (assessment.StartedAt.HasValue)
{
    var elapsed = DateTime.UtcNow - assessment.StartedAt.Value;
    int allowedMinutes = assessment.DurationMinutes + 2; // 2-minute grace
    if (elapsed.TotalMinutes > allowedMinutes)
    {
        TempData["Error"] = "Waktu ujian Anda telah habis. Pengiriman jawaban tidak dapat diproses.";
        return RedirectToAction("StartExam", new { id });
    }
}
```

Implementation notes:
- The redirect target is `StartExam` (not `Assessment`) — the worker goes back to the exam page, not the lobby. The browser will reload StartExam, which by this point already wrote `Status = InProgress` and `StartedAt`, so reloading is safe (the idempotency guard on line 1555 will skip the InProgress write on subsequent loads). The worker sees the error message on the exam page.
- The 2-minute grace is intentional and must NOT be configurable per-assessment in this phase.
- Do NOT mark the session as Abandoned or Completed here — only reject the submission. HC can ForceClose if needed.
- The `assessment` object at this point in the action already has `Questions` and `Options` included (from the `.Include(...)` at line 1942). The check only reads `StartedAt` and `DurationMinutes`, which are already loaded.
- No new DB reads or writes for this check — pure in-memory arithmetic.
  </action>
  <verify>
1. Run `dotnet build` — must pass with 0 errors.
2. Grep to confirm the check is present:
   ```bash
   grep -n "StartedAt\|DurationMinutes\|allowedMinutes\|elapsed" Controllers/CMPController.cs
   ```
   Should show the new block with `elapsed.TotalMinutes > allowedMinutes` inside `SubmitExam`.
3. Verify placement: the check must appear AFTER the `"Completed"` status guard and BEFORE the `UserPackageAssignments` query. Read the surrounding lines to confirm order.
  </verify>
  <done>
- `dotnet build` passes.
- SubmitExam POST contains the elapsed-time guard block.
- Guard appears before the package/legacy grading branch.
- Guard only activates when `StartedAt.HasValue` is true.
- Expired submissions redirect to `StartExam` (not `Assessment`) with TempData["Error"].
- Non-expired submissions proceed through existing grading logic unchanged.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` passes with 0 errors.
2. Code review: elapsed check uses `DurationMinutes + 2` (not a hardcoded constant).
3. Code review: check is inside `if (assessment.StartedAt.HasValue)` — null StartedAt sessions skip check.
4. Code review: redirect on expiry goes to `StartExam` (not `Assessment`) so the worker sees the error on the exam page.
5. Code review: no SaveChangesAsync or Status mutation in the expiry path.
</verification>

<success_criteria>
- Submitting an exam within DurationMinutes + 2 minutes of StartedAt: graded normally, redirected to Results page.
- Submitting an exam more than DurationMinutes + 2 minutes after StartedAt: rejected, redirected back to StartExam page with "Waktu ujian Anda telah habis" error message.
- Sessions with null StartedAt: graded normally (no blocking).
</success_criteria>

<output>
After completion, create `.planning/phases/22-exam-lifecycle-actions/22-03-SUMMARY.md`
</output>
