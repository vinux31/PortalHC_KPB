---
phase: 22-exam-lifecycle-actions
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - Controllers/CMPController.cs
  - Views/CMP/AssessmentMonitoringDetail.cshtml
autonomous: true

must_haves:
  truths:
    - "HC sees a 'Reset' action button on each row with UserStatus=Completed OR UserStatus=Abandoned in the monitoring detail table"
    - "HC sees a 'Force Close' action button on each row with UserStatus=InProgress or UserStatus=Not started (Open sessions that haven't been started yet) in the monitoring detail table"
    - "Abandoned sessions in AssessmentMonitoringDetail show UserStatus='Abandoned' (not 'InProgress') — the GET projection maps Status=Abandoned before the StartedAt!=null InProgress check"
    - "Clicking Reset on a Completed or Abandoned session: Status reverts to Open, Score/IsPassed/CompletedAt/StartedAt cleared to null, all UserResponse records for this session deleted, UserPackageAssignment record for this session deleted (if any), session ready for fresh retake"
    - "Clicking Force Close on an Open or InProgress session: Status becomes Completed, Score set to 0, IsPassed set to false, CompletedAt set to DateTime.UtcNow"
    - "Both actions are gated to HC and Admin roles only"
    - "Both actions require CSRF token (ValidateAntiForgeryToken)"
    - "After Reset or Force Close, HC is redirected back to the AssessmentMonitoringDetail view for the same assessment group"
  artifacts:
    - path: "Controllers/CMPController.cs"
      provides: "ResetAssessment POST and ForceCloseAssessment POST actions"
      contains: "ResetAssessment\|ForceCloseAssessment"
    - path: "Views/CMP/AssessmentMonitoringDetail.cshtml"
      provides: "Reset button (Completed rows only) and Force Close button (Open/InProgress rows only) per table row"
      contains: "ResetAssessment\|ForceCloseAssessment"
  key_links:
    - from: "AssessmentMonitoringDetail.cshtml (Reset button)"
      to: "/CMP/ResetAssessment"
      via: "inline POST form per row"
      pattern: "ResetAssessment"
    - from: "AssessmentMonitoringDetail.cshtml (Force Close button)"
      to: "/CMP/ForceCloseAssessment"
      via: "inline POST form per row"
      pattern: "ForceCloseAssessment"
    - from: "ResetAssessment POST"
      to: "UserResponses + UserPackageAssignments"
      via: "_context.UserResponses.RemoveRange + _context.UserPackageAssignments.Remove"
      pattern: "UserResponses.*RemoveRange\|UserPackageAssignments.*Remove"
---

<objective>
Add HC management actions (Reset and Force Close) to the AssessmentMonitoringDetail view and implement corresponding POST endpoints in CMPController, giving HC the ability to manage individual worker sessions from the monitoring detail table.

Purpose: Satisfies requirements LIFE-04 (HC force-close) and LIFE-05 (HC reset for retake). Reset deletes answers so the next StartExam assigns a fresh random package; Force Close terminates an open/in-progress session with Score=0.

Output: ResetAssessment POST + ForceCloseAssessment POST in CMPController; action buttons added to the per-user table rows in AssessmentMonitoringDetail.cshtml (conditional on session status); redirect back to the detail view after each action.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Controllers/CMPController.cs
@Views/CMP/AssessmentMonitoringDetail.cshtml
@Models/AssessmentMonitoringViewModel.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ResetAssessment and ForceCloseAssessment POST actions to CMPController</name>
  <files>Controllers/CMPController.cs</files>
  <action>
**Part A — Update UserStatus projection in AssessmentMonitoringDetail GET:**

Locate the `AssessmentMonitoringDetail` GET action (around line 340). The current three-state UserStatus projection is:
```csharp
if (a.CompletedAt != null || a.Score != null)   → "Completed"
else if (a.StartedAt != null)                    → "InProgress"
else                                             → "Not started"
```

Add an "Abandoned" branch BEFORE the InProgress check (Abandoned sessions always have StartedAt set, so without this they'd incorrectly show as InProgress):
```csharp
if (a.CompletedAt != null || a.Score != null)
    userStatus = "Completed";
else if (a.Status == "Abandoned")
    userStatus = "Abandoned";
else if (a.StartedAt != null)
    userStatus = "InProgress";
else
    userStatus = "Not started";
```

This makes "Abandoned" a distinct fourth state that the view buttons can target correctly. Abandoned sessions will now show the Reset button instead of Force Close.

---

**Part B — Add ResetAssessment and ForceCloseAssessment POST actions:**

Add both actions after the `AssessmentMonitoringDetail` GET action (currently ending around line 381). Both require `[Authorize(Roles = "Admin, HC")]`.

---

**ResetAssessment POST:**

```csharp
[HttpPost]
[Authorize(Roles = "Admin, HC")]
[ValidateAntiForgeryToken]
public async Task<IActionResult> ResetAssessment(int id)
{
    var assessment = await _context.AssessmentSessions
        .FirstOrDefaultAsync(a => a.Id == id);

    if (assessment == null) return NotFound();

    // Only reset Completed or Abandoned sessions
    if (assessment.Status != "Completed" && assessment.Status != "Abandoned")
    {
        TempData["Error"] = "Hanya sesi yang telah selesai atau ditinggalkan yang dapat direset.";
        return RedirectToAction("AssessmentMonitoringDetail", new
        {
            title = assessment.Title,
            category = assessment.Category,
            scheduleDate = assessment.Schedule
        });
    }

    // 1. Delete UserResponse records for this session (legacy path answers)
    var responses = await _context.UserResponses
        .Where(r => r.AssessmentSessionId == id)
        .ToListAsync();
    if (responses.Any())
        _context.UserResponses.RemoveRange(responses);

    // 2. Delete UserPackageAssignment for this session (package path)
    //    Deleting ensures the next StartExam assigns a fresh random package.
    var assignment = await _context.UserPackageAssignments
        .FirstOrDefaultAsync(a => a.AssessmentSessionId == id);
    if (assignment != null)
        _context.UserPackageAssignments.Remove(assignment);

    // 3. Reset session state to Open
    assessment.Status = "Open";
    assessment.Score = null;
    assessment.IsPassed = null;
    assessment.CompletedAt = null;
    assessment.StartedAt = null;
    assessment.Progress = 0;
    assessment.UpdatedAt = DateTime.UtcNow;

    await _context.SaveChangesAsync();

    TempData["Success"] = $"Sesi ujian {assessment.User?.FullName ?? "worker"} telah direset. Peserta dapat mengikuti ujian kembali.";
    return RedirectToAction("AssessmentMonitoringDetail", new
    {
        title = assessment.Title,
        category = assessment.Category,
        scheduleDate = assessment.Schedule
    });
}
```

Note: The `assessment.User` navigation property is NOT loaded in this action (no `.Include(a => a.User)`). Use `assessment.UserId` for the success message if needed, or simplify the message to avoid null reference. Safe alternative for the success message: `$"Sesi ujian telah direset. Peserta dapat mengikuti ujian kembali."` (without user name).

---

**ForceCloseAssessment POST:**

```csharp
[HttpPost]
[Authorize(Roles = "Admin, HC")]
[ValidateAntiForgeryToken]
public async Task<IActionResult> ForceCloseAssessment(int id)
{
    var assessment = await _context.AssessmentSessions
        .FirstOrDefaultAsync(a => a.Id == id);

    if (assessment == null) return NotFound();

    // Only force-close Open or InProgress sessions
    if (assessment.Status != "Open" && assessment.Status != "InProgress")
    {
        TempData["Error"] = "Force Close hanya dapat dilakukan pada sesi yang berstatus Open atau InProgress.";
        return RedirectToAction("AssessmentMonitoringDetail", new
        {
            title = assessment.Title,
            category = assessment.Category,
            scheduleDate = assessment.Schedule
        });
    }

    // Mark as Completed with system score of 0
    assessment.Status = "Completed";
    assessment.Score = 0;
    assessment.IsPassed = false;
    assessment.CompletedAt = DateTime.UtcNow;
    assessment.Progress = 100;
    assessment.UpdatedAt = DateTime.UtcNow;

    await _context.SaveChangesAsync();

    TempData["Success"] = "Sesi ujian telah ditutup paksa oleh sistem dengan skor 0.";
    return RedirectToAction("AssessmentMonitoringDetail", new
    {
        title = assessment.Title,
        category = assessment.Category,
        scheduleDate = assessment.Schedule
    });
}
```

Implementation notes:
- Both actions redirect to `AssessmentMonitoringDetail` with the same `title`, `category`, `scheduleDate` parameters — HC stays on the same detail view.
- `scheduleDate` parameter name must match the parameter name in the `AssessmentMonitoringDetail` GET signature (`DateTime scheduleDate`) exactly.
- ForceClose does NOT delete UserResponse or UserPackageAssignment — the session is Completed (not reset), so answers (if any) can remain for audit purposes.
- ForceClose sets `IsPassed = false` (not null) because the session is now formally complete with a score.
  </action>
  <verify>
1. Run `dotnet build` — must pass with 0 errors.
2. Grep to confirm both actions:
   ```bash
   grep -n "ResetAssessment\|ForceCloseAssessment" Controllers/CMPController.cs
   ```
   Should show `[HttpPost]` decorator lines and method signatures for both.
3. Code review: ResetAssessment deletes from `_context.UserResponses` AND `_context.UserPackageAssignments`.
4. Code review: ForceCloseAssessment does NOT delete responses.
5. Code review: both redirect to `AssessmentMonitoringDetail` with title/category/scheduleDate.
  </verify>
  <done>
- `dotnet build` passes.
- ResetAssessment POST exists: clears Status/Score/IsPassed/CompletedAt/StartedAt/Progress, deletes UserResponse rows, deletes UserPackageAssignment row.
- ForceCloseAssessment POST exists: sets Status=Completed, Score=0, IsPassed=false, CompletedAt=now.
- Both gated to Admin/HC. Both redirect back to detail view.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Reset and Force Close action buttons to AssessmentMonitoringDetail view</name>
  <files>Views/CMP/AssessmentMonitoringDetail.cshtml</files>
  <action>
**Add an "Actions" column header to the table:**

In the `<thead>` section, the current headers are: Name, NIP, Status, Score, Result, Completed At.

Add one more `<th>` at the end:
```html
<th>Actions</th>
```

Also update the `colspan` on the "No sessions found" empty-state row from `6` to `7`.

---

**Add conditional action buttons to each `<tr>` row:**

Inside the `@foreach (var session in Model.Sessions)` loop, after the existing `<td>` for "Completed At", add a new `<td>` with conditional buttons:

```html
<td>
    @if (session.UserStatus == "Completed" || session.UserStatus == "Abandoned")
    {
        <!-- Reset: returns session to Open for retake (works for both Completed and Abandoned) -->
        <form asp-action="ResetAssessment" method="post" class="d-inline"
              onsubmit="return confirm('Reset sesi ini? Semua jawaban akan dihapus dan peserta dapat mengulang ujian.')">
            @Html.AntiForgeryToken()
            <input type="hidden" name="id" value="@session.Id" />
            <button type="submit" class="btn btn-warning btn-sm">
                <i class="bi bi-arrow-counterclockwise me-1"></i>Reset
            </button>
        </form>
    }
    else if (session.UserStatus == "InProgress" || session.UserStatus == "Not started")
    {
        <!-- Force Close: terminates session with score 0 (only for active/not-yet-started sessions) -->
        <form asp-action="ForceCloseAssessment" method="post" class="d-inline"
              onsubmit="return confirm('Tutup paksa sesi ini? Skor akan dicatat sebagai 0 dan peserta dinyatakan tidak lulus.')">
            @Html.AntiForgeryToken()
            <input type="hidden" name="id" value="@session.Id" />
            <button type="submit" class="btn btn-danger btn-sm">
                <i class="bi bi-x-circle me-1"></i>Force Close
            </button>
        </form>
    }
    else
    {
        <span class="text-muted small">—</span>
    }
</td>
```

Implementation notes:
- The `session.UserStatus` values used in the view come from the `MonitoringSessionViewModel.UserStatus` property (computed in `AssessmentMonitoringDetail` GET as "Completed", "Abandoned", "InProgress", or "Not started" — four states after Part A of Task 1). The conditions above match those exact strings.
- "Not started" sessions (Status is Open but StartedAt is null) show Force Close — HC may want to close an unstarted session with score 0.
- Abandoned sessions show Reset (not Force Close) — HC's workflow is: worker abandons → HC resets for retake. Showing Force Close on an already-abandoned session would be confusing and redundant.
- The `onsubmit="return confirm(...)"` approach uses a browser confirmation before the form posts — consistent with the AbandonExam approach in Plan 22-02.
- Each inline form has its own `@Html.AntiForgeryToken()` — this is required even for inline forms.
- The buttons use Bootstrap `btn-warning` (Reset) and `btn-danger` (Force Close) to visually communicate the action severity.
- The existing `colspan="6"` on the empty-state row must be updated to `colspan="7"` to match the new column count.

**Also add TempData success/error alerts at the top of the view** (above the back link or below it), so HC sees the result message after Reset or Force Close:

```html
@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show mb-3" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i>@TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show mb-3" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>@TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}
```

Place these alerts immediately after the `<div class="container-fluid px-4 py-4">` opening tag and before the "Back link" section.
  </action>
  <verify>
1. Run `dotnet build` — must pass with 0 errors.
2. Grep to confirm buttons are present:
   ```bash
   grep -n "ResetAssessment\|ForceCloseAssessment\|Force Close\|Keluar" Views/CMP/AssessmentMonitoringDetail.cshtml
   ```
   Should show hits for both form actions and button labels.
3. Grep to confirm TempData alerts are present:
   ```bash
   grep -n "TempData\[.Success.\]\|TempData\[.Error.\]" Views/CMP/AssessmentMonitoringDetail.cshtml
   ```
4. Verify `colspan` on the empty-state row is updated to `7`.
  </verify>
  <done>
- `dotnet build` passes.
- AssessmentMonitoringDetail table has an "Actions" column header (7 columns total).
- Completed session rows show a "Reset" button (btn-warning).
- Open/InProgress/Not started session rows show a "Force Close" button (btn-danger).
- Each button is inside an inline form with CSRF token and a browser confirm() prompt.
- TempData Success and Error alerts are rendered at the top of the view.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` passes with 0 errors.
2. `grep -n "ResetAssessment\|ForceCloseAssessment" Controllers/CMPController.cs` — both POST actions present.
3. `grep -n "ResetAssessment\|ForceCloseAssessment" Views/CMP/AssessmentMonitoringDetail.cshtml` — both forms present in the view.
4. Code review: ResetAssessment deletes UserResponse + UserPackageAssignment rows, then clears Status/Score/IsPassed/CompletedAt/StartedAt/Progress.
5. Code review: ForceCloseAssessment sets Status=Completed, Score=0, IsPassed=false, CompletedAt=now (no answer deletion).
6. Code review: both actions redirect back to AssessmentMonitoringDetail with title/category/scheduleDate route params.
7. Code review: buttons are conditional — Reset on Completed AND Abandoned rows; Force Close on InProgress and Not started rows only.
</verification>

<success_criteria>
- HC navigating to AssessmentMonitoringDetail sees Reset button on Completed AND Abandoned rows; Force Close button on InProgress and Not started rows.
- Reset: session reverts to Open (Score=null, IsPassed=null, CompletedAt=null, StartedAt=null, Progress=0), all UserResponse rows deleted, UserPackageAssignment deleted; HC sees success message.
- Force Close: session becomes Completed with Score=0, IsPassed=false, CompletedAt=now; HC sees success message.
- Both require HC or Admin role.
- Both show browser confirmation dialog before submitting.
</success_criteria>

<output>
After completion, create `.planning/phases/22-exam-lifecycle-actions/22-04-SUMMARY.md`
</output>
