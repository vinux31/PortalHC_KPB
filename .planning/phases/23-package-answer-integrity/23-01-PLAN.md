---
phase: 23-package-answer-integrity
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Models/PackageUserResponse.cs
  - Data/ApplicationDbContext.cs
  - Migrations/*_AddPackageUserResponse.cs
  - Controllers/CMPController.cs
autonomous: true

must_haves:
  truths:
    - "When a worker submits a package-based exam, one PackageUserResponse row is inserted per question answered"
    - "Each PackageUserResponse records the AssessmentSessionId, PackageQuestionId, selected PackageOptionId, and SubmittedAt timestamp"
    - "ResetAssessment deletes PackageUserResponse rows alongside UserResponses and UserPackageAssignment"
  artifacts:
    - path: "Models/PackageUserResponse.cs"
      provides: "PackageUserResponse entity with FK to AssessmentSession, PackageQuestion, PackageOption"
      contains: "class PackageUserResponse"
    - path: "Data/ApplicationDbContext.cs"
      provides: "PackageUserResponses DbSet and EF configuration"
      contains: "DbSet<PackageUserResponse> PackageUserResponses"
  key_links:
    - from: "Controllers/CMPController.cs"
      to: "PackageUserResponse"
      via: "SubmitExam package path inserts rows"
      pattern: "_context\\.PackageUserResponses\\.Add"
    - from: "Controllers/CMPController.cs"
      to: "PackageUserResponse"
      via: "ResetAssessment deletes rows"
      pattern: "_context\\.PackageUserResponses\\.RemoveRange"
---

<objective>
Create the PackageUserResponse entity and EF migration, then wire answer persistence into the SubmitExam package path so every answered question produces a saved row.

Purpose: Package-based exams currently grade answers in-memory but do not persist individual responses. Without stored responses, answer review (plan 23-02) has no data to display.

Output: PackageUserResponse table in DB; one row per answered question on package exam submission; ResetAssessment cleans up PackageUserResponse rows on reset.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Models/AssessmentPackage.cs
@Models/UserResponse.cs
@Models/UserPackageAssignment.cs
@Data/ApplicationDbContext.cs
@Controllers/CMPController.cs (lines 2090-2222 SubmitExam package path; lines 389-440 ResetAssessment)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PackageUserResponse entity, register DbSet, add EF migration</name>
  <files>
    Models/PackageUserResponse.cs
    Data/ApplicationDbContext.cs
    Migrations/ (new migration file)
  </files>
  <action>
1. Create `Models/PackageUserResponse.cs` with the following entity:

```csharp
namespace HcPortal.Models
{
    public class PackageUserResponse
    {
        [Key]
        public int Id { get; set; }

        public int AssessmentSessionId { get; set; }
        [ForeignKey("AssessmentSessionId")]
        public virtual AssessmentSession AssessmentSession { get; set; } = null!;

        public int PackageQuestionId { get; set; }
        [ForeignKey("PackageQuestionId")]
        public virtual PackageQuestion PackageQuestion { get; set; } = null!;

        public int? PackageOptionId { get; set; }
        [ForeignKey("PackageOptionId")]
        public virtual PackageOption? PackageOption { get; set; }

        public DateTime SubmittedAt { get; set; } = DateTime.UtcNow;
    }
}
```

Key design notes:
- `PackageOptionId` is nullable int (same pattern as `UserResponse.SelectedOptionId`) — null means the worker skipped the question.
- FK to `AssessmentSession` uses Restrict delete (same pattern as `UserResponse` — avoids cascade cycles since AssessmentSession already cascades to AssessmentPackage -> PackageQuestion -> PackageOption).
- FK to `PackageQuestion` uses Restrict delete.
- FK to `PackageOption` uses Restrict delete (nullable FK).

2. In `Data/ApplicationDbContext.cs`:
- Add DbSet: `public DbSet<PackageUserResponse> PackageUserResponses { get; set; }` in the "Test Packages -- Phase 17" DbSet section.
- Add EF configuration in `OnModelCreating` after the `UserPackageAssignment` config block:

```csharp
// PackageUserResponse -> AssessmentSession (Restrict — same as UserResponse pattern)
builder.Entity<PackageUserResponse>(entity =>
{
    entity.HasOne(r => r.AssessmentSession)
        .WithMany()
        .HasForeignKey(r => r.AssessmentSessionId)
        .OnDelete(DeleteBehavior.Restrict);

    entity.HasOne(r => r.PackageQuestion)
        .WithMany()
        .HasForeignKey(r => r.PackageQuestionId)
        .OnDelete(DeleteBehavior.Restrict);

    entity.HasOne(r => r.PackageOption)
        .WithMany()
        .HasForeignKey(r => r.PackageOptionId)
        .OnDelete(DeleteBehavior.Restrict);

    entity.HasIndex(r => new { r.AssessmentSessionId, r.PackageQuestionId });
});
```

3. Run EF migration:
```bash
dotnet ef migrations add AddPackageUserResponse
dotnet ef database update
```
  </action>
  <verify>
- `dotnet build` compiles without errors
- `dotnet ef database update` applies the migration
- The `PackageUserResponses` table exists in the database with columns: Id, AssessmentSessionId, PackageQuestionId, PackageOptionId (nullable), SubmittedAt
  </verify>
  <done>PackageUserResponse entity exists, DbSet registered, migration applied, table created in DB with correct schema and FK constraints.</done>
</task>

<task type="auto">
  <name>Task 2: Insert PackageUserResponse rows in SubmitExam package path and delete in ResetAssessment</name>
  <files>Controllers/CMPController.cs</files>
  <action>
1. In `Controllers/CMPController.cs`, find the SubmitExam package path (around line 2146, the `foreach (var q in packageQuestions)` loop). Inside the loop, after the scoring logic and before the closing brace of the foreach, add a PackageUserResponse insert:

Replace the comment block at line ~2157 ("Note: UserResponse records not created for package exams...") with actual persistence:

```csharp
// Persist answer for package-based answer review
_context.PackageUserResponses.Add(new PackageUserResponse
{
    AssessmentSessionId = id,
    PackageQuestionId = q.Id,
    PackageOptionId = selectedOptId,
    SubmittedAt = DateTime.UtcNow
});
```

This goes INSIDE the foreach loop, so one row per question — even if the worker did not select an option (PackageOptionId will be null for unanswered questions).

2. In `ResetAssessment` action (around line 408-413), after the UserResponse deletion block and before the UserPackageAssignment deletion, add PackageUserResponse cleanup:

```csharp
// 1b. Delete PackageUserResponse records for this session (package path answers)
var packageResponses = await _context.PackageUserResponses
    .Where(r => r.AssessmentSessionId == id)
    .ToListAsync();
if (packageResponses.Any())
    _context.PackageUserResponses.RemoveRange(packageResponses);
```

Place this between the UserResponse deletion (step 1) and the UserPackageAssignment deletion (step 2). Update the step comments to renumber if needed (1, 1b, 2, 3 or just 1, 2, 3, 4).
  </action>
  <verify>
- `dotnet build` compiles without errors
- Search the SubmitExam package path for `PackageUserResponses.Add` — confirm it exists inside the foreach loop
- Search ResetAssessment for `PackageUserResponses.RemoveRange` — confirm it exists before the UserPackageAssignment deletion
  </verify>
  <done>SubmitExam inserts one PackageUserResponse per question on package exam submission. ResetAssessment deletes all PackageUserResponse rows for the session before clearing the assignment.</done>
</task>

</tasks>

<verification>
1. `dotnet build` — project compiles cleanly
2. Grep for `PackageUserResponses` in CMPController.cs — appears in both SubmitExam (Add) and ResetAssessment (RemoveRange)
3. Grep for `DbSet<PackageUserResponse>` in ApplicationDbContext.cs — confirms registration
4. Check migration file exists in Migrations/ matching `*AddPackageUserResponse*`
</verification>

<success_criteria>
- PackageUserResponse table exists with columns: Id (int PK), AssessmentSessionId (int FK), PackageQuestionId (int FK), PackageOptionId (int? FK), SubmittedAt (datetime2)
- SubmitExam package path creates one PackageUserResponse per packageQuestion in the loop
- ResetAssessment deletes PackageUserResponse rows for the session alongside legacy UserResponse cleanup
- Project builds and migration applies without errors
</success_criteria>

<output>
After completion, create `.planning/phases/23-package-answer-integrity/23-01-SUMMARY.md`
</output>
