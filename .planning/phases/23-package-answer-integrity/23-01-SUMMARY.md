---
phase: 23-package-answer-integrity
plan: "01"
subsystem: assessment-package
tags: [entity, migration, persistence, answer-review]
dependency_graph:
  requires: []
  provides: [PackageUserResponse-table, package-answer-persistence]
  affects: [CMPController-SubmitExam, CMPController-ResetAssessment]
tech_stack:
  added: [PackageUserResponse entity]
  patterns: [Restrict-FK-to-avoid-cycles, composite-index-on-session-question]
key_files:
  created:
    - Models/PackageUserResponse.cs
    - Migrations/20260221030204_AddPackageUserResponse.cs
    - Migrations/20260221030204_AddPackageUserResponse.Designer.cs
  modified:
    - Data/ApplicationDbContext.cs
    - Controllers/CMPController.cs
    - Migrations/ApplicationDbContextModelSnapshot.cs
decisions:
  - PackageOptionId is nullable int — null means worker skipped question, matching UserResponse.SelectedOptionId pattern
  - All three FKs (AssessmentSession, PackageQuestion, PackageOption) use Restrict delete to avoid cascade cycles through AssessmentPackage chain
  - Insert happens inside foreach loop so skipped questions still produce a row (PackageOptionId null) — enables complete answer review in plan 23-02
metrics:
  duration: 8 min
  completed: 2026-02-21
  tasks_completed: 2
  files_changed: 6
---

# Phase 23 Plan 01: PackageUserResponse Migration and Answer Persistence Summary

PackageUserResponse entity with Restrict FKs, EF migration creating DB table, and SubmitExam/ResetAssessment wired to persist and clean up package exam answers.

## Tasks Completed

| # | Task | Commit | Files |
|---|------|--------|-------|
| 1 | Create PackageUserResponse entity, register DbSet, add EF migration | 9fd384e | Models/PackageUserResponse.cs, Data/ApplicationDbContext.cs, Migrations/ |
| 2 | Insert PackageUserResponse rows in SubmitExam and delete in ResetAssessment | 6b68db0 | Controllers/CMPController.cs |

## What Was Built

**PackageUserResponse entity** (`Models/PackageUserResponse.cs`): New EF entity recording one row per answered question on package exam submission. Fields: Id (PK), AssessmentSessionId (FK Restrict), PackageQuestionId (FK Restrict), PackageOptionId (nullable FK Restrict — null=skipped), SubmittedAt (datetime2).

**ApplicationDbContext** (`Data/ApplicationDbContext.cs`):
- Added `DbSet<PackageUserResponse> PackageUserResponses` in the Test Packages section
- Configured three Restrict-delete FKs and a composite index on (AssessmentSessionId, PackageQuestionId)

**EF Migration** (`20260221030204_AddPackageUserResponse`): Creates `PackageUserResponses` table with all columns, FK constraints (ON DELETE NO ACTION = Restrict), and three indexes (composite on session+question, plus individual indexes on PackageOptionId and PackageQuestionId auto-generated by EF).

**CMPController SubmitExam** (package path foreach loop): Replaced stale "not supported" comment with actual `_context.PackageUserResponses.Add(...)` call — one row per question, `PackageOptionId = selectedOptId` (null for unanswered). Runs before `SaveChangesAsync`.

**CMPController ResetAssessment** (step 1b): Added `PackageUserResponses.RemoveRange` between UserResponse deletion (step 1) and UserPackageAssignment deletion (step 2). Ensures no orphaned answer rows remain after reset.

## Verification

- `dotnet build` — 0 errors, 35 pre-existing warnings (all in CDPController.cs, unrelated)
- `dotnet ef database update` — migration applied, table created with correct schema
- `PackageUserResponses.Add` confirmed inside foreach loop at line ~2180 of CMPController.cs
- `PackageUserResponses.RemoveRange` confirmed in ResetAssessment at line ~420 of CMPController.cs
- `DbSet<PackageUserResponse>` confirmed at line 56 of ApplicationDbContext.cs
- Migration file `20260221030204_AddPackageUserResponse.cs` confirmed in Migrations/

## Deviations from Plan

None — plan executed exactly as written.

## Self-Check: PASSED

- [x] Models/PackageUserResponse.cs — FOUND
- [x] Migrations/20260221030204_AddPackageUserResponse.cs — FOUND
- [x] DbSet<PackageUserResponse> in ApplicationDbContext.cs — FOUND
- [x] PackageUserResponses.Add in CMPController.cs SubmitExam — FOUND
- [x] PackageUserResponses.RemoveRange in CMPController.cs ResetAssessment — FOUND
- [x] Commit 9fd384e — FOUND (feat(23-01): entity + migration)
- [x] Commit 6b68db0 — FOUND (feat(23-01): controller wiring)
