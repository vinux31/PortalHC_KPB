---
phase: 24-hc-audit-log
plan: 02
type: execute
wave: 2
depends_on: ["24-01"]
files_modified:
  - Controllers/CMPController.cs
  - Views/CMP/AuditLog.cshtml
  - Views/CMP/Assessment.cshtml
autonomous: true

must_haves:
  truths:
    - "HC and Admin can navigate to the Audit Log page from the Assessment manage view"
    - "The Audit Log page shows a paginated table of all audit entries sorted by most recent first"
    - "Each row displays actor name, action type, description, and timestamp"
    - "No edit or delete controls exist anywhere on the Audit Log page"
    - "Non-HC/Non-Admin users cannot access the Audit Log page"
  artifacts:
    - path: "Controllers/CMPController.cs"
      provides: "AuditLog GET action with pagination, HC/Admin access gate"
      contains: "public async Task<IActionResult> AuditLog"
    - path: "Views/CMP/AuditLog.cshtml"
      provides: "Read-only paginated table view"
      contains: "AuditLogs"
    - path: "Views/CMP/Assessment.cshtml"
      provides: "Nav link to AuditLog page in manage view header"
      contains: "AuditLog"
  key_links:
    - from: "Views/CMP/Assessment.cshtml"
      to: "Controllers/CMPController.cs"
      via: "asp-action='AuditLog' link"
      pattern: "asp-action=\"AuditLog\""
    - from: "Controllers/CMPController.cs"
      to: "Data/ApplicationDbContext.cs"
      via: "_context.AuditLogs query"
      pattern: "_context\\.AuditLogs"
    - from: "Views/CMP/AuditLog.cshtml"
      to: "Models/AuditLog.cs"
      via: "@model with ViewBag pagination data"
      pattern: "List<.*AuditLog>"
---

<objective>
Create the Audit Log view page accessible to HC and Admin with a paginated, read-only table showing all audit entries sorted by most recent. Add a navigation link from the Assessment manage view.

Purpose: Gives HC and Admin visibility into all assessment management operations for accountability and troubleshooting.

Output: AuditLog controller action, AuditLog.cshtml view, and nav link in Assessment.cshtml manage header.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-hc-audit-log/24-01-SUMMARY.md
@Controllers/CMPController.cs
@Views/CMP/Assessment.cshtml
@Models/AuditLog.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AuditLog controller action and view with pagination, plus nav link in Assessment manage view</name>
  <files>
    Controllers/CMPController.cs
    Views/CMP/AuditLog.cshtml
    Views/CMP/Assessment.cshtml
  </files>
  <action>
**1. Add AuditLog GET action to CMPController.cs:**

Add this action method in the HC management section of the controller (after the RegenerateToken method around line ~861, before CreateAssessment GET). Place it near the other management actions.

```csharp
// --- AUDIT LOG ---
[HttpGet]
[Authorize(Roles = "Admin, HC")]
public async Task<IActionResult> AuditLog(int page = 1)
{
    const int pageSize = 25;

    var totalCount = await _context.AuditLogs.CountAsync();
    var totalPages = (int)Math.Ceiling(totalCount / (double)pageSize);

    // Clamp page to valid range
    if (page < 1) page = 1;
    if (page > totalPages && totalPages > 0) page = totalPages;

    var logs = await _context.AuditLogs
        .OrderByDescending(a => a.CreatedAt)
        .Skip((page - 1) * pageSize)
        .Take(pageSize)
        .ToListAsync();

    ViewBag.CurrentPage = page;
    ViewBag.TotalPages = totalPages;
    ViewBag.TotalCount = totalCount;

    return View(logs);
}
```

Access gate: The `[Authorize(Roles = "Admin, HC")]` attribute handles the access restriction. No additional `isHCAccess` check needed because this is a dedicated action (not a shared action with workers).

Pagination: 25 rows per page. Query param `page` (1-indexed). Total pages computed from count. Skip/Take pattern.

**2. Create `Views/CMP/AuditLog.cshtml`:**

```html
@model List<HcPortal.Models.AuditLog>
@{
    ViewData["Title"] = "Audit Log";
    var currentPage = (int)(ViewBag.CurrentPage ?? 1);
    var totalPages = (int)(ViewBag.TotalPages ?? 1);
    var totalCount = (int)(ViewBag.TotalCount ?? 0);
}

<div class="container-fluid py-4">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="mb-1">
                <i class="bi bi-clock-history me-2 text-primary"></i>Audit Log
            </h4>
            <p class="text-muted mb-0">
                Riwayat seluruh aksi manajemen assessment
                <span class="badge bg-secondary ms-1">@totalCount entries</span>
            </p>
        </div>
        <a asp-action="Assessment" asp-route-view="manage" class="btn btn-outline-primary">
            <i class="bi bi-arrow-left me-1"></i> Back to Manage
        </a>
    </div>

    <!-- Table -->
    @if (Model.Any())
    {
        <div class="card shadow-sm">
            <div class="table-responsive">
                <table class="table table-hover table-striped mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 170px;">Waktu</th>
                            <th style="width: 200px;">Aktor</th>
                            <th style="width: 160px;">Aksi</th>
                            <th>Deskripsi</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var log in Model)
                        {
                            <tr>
                                <td class="text-nowrap">
                                    <small>@log.CreatedAt.ToLocalTime().ToString("dd MMM yyyy HH:mm")</small>
                                </td>
                                <td>
                                    <small>@log.ActorName</small>
                                </td>
                                <td>
                                    @{
                                        var badgeClass = log.ActionType switch
                                        {
                                            "CreateAssessment" => "bg-success",
                                            "EditAssessment" => "bg-primary",
                                            "BulkAssign" => "bg-info text-dark",
                                            "DeleteAssessment" => "bg-danger",
                                            "DeleteAssessmentGroup" => "bg-danger",
                                            "ForceCloseAssessment" => "bg-warning text-dark",
                                            "ResetAssessment" => "bg-secondary",
                                            _ => "bg-dark"
                                        };
                                    }
                                    <span class="badge @badgeClass">@log.ActionType</span>
                                </td>
                                <td>
                                    <small>@log.Description</small>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination -->
        @if (totalPages > 1)
        {
            <nav aria-label="Audit log pagination" class="mt-3">
                <ul class="pagination justify-content-center mb-0">
                    <li class="page-item @(currentPage <= 1 ? "disabled" : "")">
                        <a class="page-link" asp-action="AuditLog" asp-route-page="@(currentPage - 1)">
                            <i class="bi bi-chevron-left"></i>
                        </a>
                    </li>

                    @for (int i = 1; i <= totalPages; i++)
                    {
                        @if (i == 1 || i == totalPages || (i >= currentPage - 2 && i <= currentPage + 2))
                        {
                            <li class="page-item @(i == currentPage ? "active" : "")">
                                <a class="page-link" asp-action="AuditLog" asp-route-page="@i">@i</a>
                            </li>
                        }
                        else if (i == currentPage - 3 || i == currentPage + 3)
                        {
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        }
                    }

                    <li class="page-item @(currentPage >= totalPages ? "disabled" : "")">
                        <a class="page-link" asp-action="AuditLog" asp-route-page="@(currentPage + 1)">
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
        }
    }
    else
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i> Belum ada riwayat aksi manajemen assessment.
        </div>
    }

</div>
```

Key design decisions:
- **Read-only:** No edit, delete, or any form/button that modifies data. Pure read view.
- **Pagination:** 25 per page with ellipsis for large page counts. Window of 5 page numbers around current page plus first/last.
- **Color-coded badges:** Each ActionType gets a distinct Bootstrap badge color for quick scanning.
- **Timestamp:** Displayed in local time using `.ToLocalTime()` with format `dd MMM yyyy HH:mm`.
- **No search/filter** in this phase â€” KISS. Pagination + sort by newest is sufficient for the initial release.

**3. Add nav link in `Views/CMP/Assessment.cshtml`:**

In the manage view header button group (around line 41-48), add the Audit Log button alongside the existing "Create Assessment" and "Personal Assessment" buttons. The existing code is:

```html
<div class="d-flex gap-2">
    <a asp-action="CreateAssessment" class="btn btn-success">
        <i class="bi bi-plus-circle me-1"></i> Create Assessment
    </a>
    <a asp-action="Assessment" asp-route-view="personal" class="btn btn-outline-primary">
        <i class="bi bi-person-circle me-1"></i> Personal Assessment
    </a>
</div>
```

Replace with:

```html
<div class="d-flex gap-2">
    <a asp-action="CreateAssessment" class="btn btn-success">
        <i class="bi bi-plus-circle me-1"></i> Create Assessment
    </a>
    <a asp-action="AuditLog" class="btn btn-outline-secondary">
        <i class="bi bi-clock-history me-1"></i> Audit Log
    </a>
    <a asp-action="Assessment" asp-route-view="personal" class="btn btn-outline-primary">
        <i class="bi bi-person-circle me-1"></i> Personal Assessment
    </a>
</div>
```

The link is only rendered when `viewMode == "manage"` (the enclosing `@if` condition), which is already HC/Admin gated via the `canManage` check. The Audit Log button uses `btn-outline-secondary` to visually distinguish it as a secondary action (not a creation or navigation action).
  </action>
  <verify>
1. `dotnet build` compiles without errors.
2. Grep confirms `public async Task<IActionResult> AuditLog` exists in CMPController.cs.
3. File `Views/CMP/AuditLog.cshtml` exists and contains `@model List<HcPortal.Models.AuditLog>`.
4. Grep confirms `asp-action="AuditLog"` appears in Assessment.cshtml (nav link).
5. Grep confirms NO form, no `[HttpPost]`, no delete/edit button exists in AuditLog.cshtml (read-only check).
6. Grep confirms pagination: `asp-route-page` appears in AuditLog.cshtml.
  </verify>
  <done>
HC and Admin can click "Audit Log" from the Assessment manage view header. The Audit Log page shows a paginated table (25 per page) sorted by newest first, with columns: Waktu (timestamp), Aktor (actor name), Aksi (color-coded action badge), and Deskripsi (human-readable description). The page is fully read-only with no edit or delete controls. Non-HC/Non-Admin users are blocked by `[Authorize(Roles)]`.
  </done>
</task>

</tasks>

<verification>
1. Build passes: `dotnet build` succeeds with zero errors.
2. AuditLog page loads at `/CMP/AuditLog` for HC and Admin users.
3. Page displays paginated table with correct columns and sorting.
4. Pagination works: page 1 shows newest 25, page 2 shows next 25, etc.
5. Nav link visible only in Assessment manage view (HC/Admin only).
6. No edit/delete UI exists on the Audit Log page.
7. Non-HC/Non-Admin users get 403 Forbidden when accessing `/CMP/AuditLog`.
</verification>

<success_criteria>
- AuditLog action exists with [Authorize(Roles = "Admin, HC")] and pagination (25 per page, page query param).
- AuditLog.cshtml renders a read-only table with Waktu, Aktor, Aksi (badge), Deskripsi columns.
- Assessment.cshtml manage view has an "Audit Log" button linking to the AuditLog action.
- The page is fully read-only with zero data modification controls.
</success_criteria>

<output>
After completion, create `.planning/phases/24-hc-audit-log/24-02-SUMMARY.md`
</output>
