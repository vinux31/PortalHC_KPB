---
phase: 25-worker-ux-enhancements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Controllers/CMPController.cs
  - Views/CMP/Assessment.cshtml
autonomous: true

must_haves:
  truths:
    - "Worker's Assessment page shows a 'Riwayat Ujian' section listing all their completed assessments"
    - "Each riwayat row displays title, category, date, score, and pass/fail status"
    - "The riwayat section is only visible to the worker viewing their own page — HC/Admin manage view is unaffected"
  artifacts:
    - path: "Controllers/CMPController.cs"
      provides: "ViewBag.CompletedHistory list populated in worker personal branch"
      contains: "ViewBag.CompletedHistory"
    - path: "Views/CMP/Assessment.cshtml"
      provides: "Riwayat Ujian table rendered in worker else-branch"
      contains: "Riwayat Ujian"
  key_links:
    - from: "Controllers/CMPController.cs"
      to: "Views/CMP/Assessment.cshtml"
      via: "ViewBag.CompletedHistory"
      pattern: "ViewBag\\.CompletedHistory"
---

<objective>
Add a "Riwayat Ujian" (exam history) section to the worker's Assessment page showing all their completed assessments with title, category, date, score, and pass/fail status.

Purpose: Workers currently only see Open/Upcoming assessments on their Assessment page. Completed assessments are only visible via the Training Records page. This enhancement closes the feedback loop by showing exam history directly on the Assessment page where the worker expects to find it.

Output: Worker's Assessment page has a new "Riwayat Ujian" table below the Open/Upcoming card grid.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Controllers/CMPController.cs
@Views/CMP/Assessment.cshtml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Query completed assessments in Assessment() worker branch and render Riwayat Ujian table</name>
  <files>
    Controllers/CMPController.cs
    Views/CMP/Assessment.cshtml
  </files>
  <action>
**Controller — CMPController.cs Assessment() action, worker personal branch (around line 200-246):**

Inside the `// ========== WORKER PERSONAL BRANCH ==========` section, AFTER the existing query that fetches Open/Upcoming sessions and BEFORE `return View(exams);` (line 246), add a second query for completed sessions:

```csharp
// ========== RIWAYAT UJIAN: completed assessment history for worker ==========
var completedHistory = await _context.AssessmentSessions
    .Where(a => a.UserId == userId && a.Status == "Completed")
    .OrderByDescending(a => a.CompletedAt)
    .Select(a => new
    {
        a.Id,
        a.Title,
        a.Category,
        a.CompletedAt,
        a.Score,
        a.IsPassed
    })
    .ToListAsync();

ViewBag.CompletedHistory = completedHistory;
```

Key constraints:
- Query is scoped to `a.UserId == userId` (current logged-in user only — no other user's data leaks)
- Only `Status == "Completed"` sessions are included
- Uses `.Select()` projection (consistent with the management query pattern above) — avoids loading full entities
- Sorted by `CompletedAt DESC` (most recent first)
- This query is ONLY executed inside the worker branch (the `else` path after `if (view == "manage" && isHCAccess)`). The HC/Admin branch returns early at line 197 and never reaches this code.

**View — Assessment.cshtml, worker else-branch:**

Inside the `else` block (line 341, the worker view section), AFTER the closing `</div>` of `id="assessmentCards"` (line 524) and AFTER the `emptyTabState` div (line 531), add a new "Riwayat Ujian" section BEFORE the closing `}` of the else block (line 532):

```html
<!-- Riwayat Ujian (Exam History) — worker only -->
@{
    var completedHistory = ViewBag.CompletedHistory as IEnumerable<dynamic>;
}
@if (completedHistory != null && completedHistory.Any())
{
    <div class="mt-5">
        <h4 class="fw-bold mb-3">
            <i class="bi bi-clock-history me-2 text-primary"></i>Riwayat Ujian
        </h4>
        <div class="card border-0 shadow-sm">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Judul</th>
                            <th>Kategori</th>
                            <th>Tanggal Selesai</th>
                            <th>Skor</th>
                            <th>Status</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in completedHistory)
                        {
                            <tr>
                                <td class="fw-semibold">@item.Title</td>
                                <td><span class="badge bg-secondary">@item.Category</span></td>
                                <td>@(item.CompletedAt != null ? ((DateTime)item.CompletedAt).ToString("dd MMM yyyy") : "—")</td>
                                <td>@(item.Score != null ? item.Score + "%" : "—")</td>
                                <td>
                                    @if (item.IsPassed == true)
                                    {
                                        <span class="badge text-bg-success"><i class="bi bi-check-circle-fill me-1"></i>Lulus</span>
                                    }
                                    else
                                    {
                                        <span class="badge text-bg-danger"><i class="bi bi-x-circle-fill me-1"></i>Tidak Lulus</span>
                                    }
                                </td>
                                <td>
                                    <a asp-action="Results" asp-route-id="@item.Id" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye me-1"></i>Detail
                                    </a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}
```

Key constraints:
- The section is placed INSIDE the `else` block (worker view only) — HC/Admin manage view is structurally unreachable
- Uses `@if (completedHistory != null && completedHistory.Any())` guard — no empty table rendered when no history exists
- "Detail" link goes to `Results` action with the assessment ID — reuses existing results page
- Indonesian labels used: "Riwayat Ujian", "Judul", "Kategori", "Tanggal Selesai", "Skor", "Lulus"/"Tidak Lulus"
- Badge uses `text-bg-success`/`text-bg-danger` — consistent with Results.cshtml pattern (line 54/61)
  </action>
  <verify>
Build the project: `dotnet build` must succeed with no errors. Then navigate to `/CMP/Assessment` as a worker user — the page should render without errors. If the logged-in user has completed assessments, the "Riwayat Ujian" table should appear below the Open/Upcoming cards. If the user has no completed assessments, no table appears.
  </verify>
  <done>
Worker's Assessment page shows a "Riwayat Ujian" section listing all their completed assessments with title, category, completion date, score percentage, and Lulus/Tidak Lulus badge. The section is only visible in the worker personal branch — HC/Admin manage view is completely unaffected. Each row has a "Detail" link to the Results page.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` succeeds with no errors
2. Worker view (`/CMP/Assessment` or `/CMP/Assessment?view=personal`) shows "Riwayat Ujian" table when user has completed assessments
3. Worker view shows no riwayat section when user has zero completed assessments
4. HC/Admin manage view (`/CMP/Assessment?view=manage`) is unchanged — no riwayat table appears
5. Each riwayat row shows: title, category badge, completion date, score%, and Lulus/Tidak Lulus badge
6. "Detail" link on each row navigates to `/CMP/Results/{id}` correctly
</verification>

<success_criteria>
- Worker sees their completed assessment history on the Assessment page
- History shows title, category, date, score, and pass/fail for each completed session
- The section is invisible to HC/Admin viewing the manage page
- No modifications to existing Open/Upcoming card grid or HC manage view
</success_criteria>

<output>
After completion, create `.planning/phases/25-worker-ux-enhancements/25-01-SUMMARY.md`
</output>
