---
phase: 25-worker-ux-enhancements
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Controllers/CMPController.cs
  - Models/AssessmentResultsViewModel.cs
  - Views/CMP/Results.cshtml
autonomous: true

must_haves:
  truths:
    - "After passing an assessment, the Results page shows a 'Kompetensi Diperoleh' section listing each competency name and the new level"
    - "The competency section only appears when IsPassed is true AND AssessmentCompetencyMap entries exist for that assessment category"
    - "When the worker failed or no competency mappings exist, the section does not appear"
  artifacts:
    - path: "Models/AssessmentResultsViewModel.cs"
      provides: "CompetencyGainItem class and CompetencyGains list property on AssessmentResultsViewModel"
      contains: "CompetencyGains"
    - path: "Controllers/CMPController.cs"
      provides: "AssessmentCompetencyMap query in Results action populating CompetencyGains"
      contains: "CompetencyGains"
    - path: "Views/CMP/Results.cshtml"
      provides: "Kompetensi Diperoleh card rendered when CompetencyGains has items"
      contains: "Kompetensi Diperoleh"
  key_links:
    - from: "Controllers/CMPController.cs"
      to: "Models/AssessmentResultsViewModel.cs"
      via: "CompetencyGains property set on viewModel"
      pattern: "CompetencyGains\\s*="
    - from: "Views/CMP/Results.cshtml"
      to: "Models/AssessmentResultsViewModel.cs"
      via: "Model.CompetencyGains iteration"
      pattern: "Model\\.CompetencyGains"
---

<objective>
Add a "Kompetensi Diperoleh" (competencies earned) section to the Results page that shows which competencies the worker earned when they passed an assessment.

Purpose: Workers currently see their score and pass/fail status on the Results page but have no visibility into which specific competencies were updated as a result. This enhancement surfaces the competency gains directly on the results page, closing the feedback loop between assessment performance and competency development.

Output: Results page displays a "Kompetensi Diperoleh" card listing competency name and level granted, visible only when IsPassed=true and competency mappings exist.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Controllers/CMPController.cs
@Models/AssessmentResultsViewModel.cs
@Models/Competency/AssessmentCompetencyMap.cs
@Models/Competency/UserCompetencyLevel.cs
@Models/KkjModels.cs
@Views/CMP/Results.cshtml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CompetencyGainItem to ViewModel</name>
  <files>Models/AssessmentResultsViewModel.cs</files>
  <action>
**Add a new class and property to Models/AssessmentResultsViewModel.cs:**

1. Add a new `CompetencyGainItem` class at the bottom of the file (after `OptionReviewItem`):

```csharp
public class CompetencyGainItem
{
    public string CompetencyName { get; set; } = "";
    public int LevelGranted { get; set; }
}
```

2. Add a nullable list property to `AssessmentResultsViewModel`:

```csharp
public List<CompetencyGainItem>? CompetencyGains { get; set; }
```

Place it after the existing `QuestionReviews` property (line 16).

This is purely additive — no existing properties are modified.
  </action>
  <verify>
`dotnet build` succeeds. The new class and property compile without errors.
  </verify>
  <done>
AssessmentResultsViewModel has a `CompetencyGains` list property and `CompetencyGainItem` class with CompetencyName and LevelGranted fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: Populate CompetencyGains in Results action and render Kompetensi Diperoleh card</name>
  <files>
    Controllers/CMPController.cs
    Views/CMP/Results.cshtml
  </files>
  <action>
**Controller — CMPController.cs Results() action (line 2504-2695):**

The Results action builds a `viewModel` in two branches: the package path (line 2614) and the legacy path (line 2677). We need to add the competency lookup ONCE, after the branch merge, and set it on both viewModels. The cleanest approach: add the competency query AFTER the view model is constructed in EACH branch but BEFORE `return View(viewModel)`.

However, to avoid code duplication, use a shared block. Since both branches end with `return View(viewModel);`, we can instead use a local variable pattern:

**Approach:** After the if/else block that constructs `viewModel` (both paths), add a shared competency lookup block just before the final `return View(viewModel);`. Since the current code has `return View(viewModel)` inside each branch, we need to refactor slightly:

In the **package path** (inside `if (packageAssignment != null)`, around line 2614-2630), change:
- Remove `return View(viewModel);` from line 2630

In the **legacy path** (inside `else`, around line 2677-2693), change:
- Remove `return View(viewModel);` from line 2693

Then AFTER the closing `}` of the else block (line 2694), add:

```csharp
            // ========== COMPETENCY GAINS (shared by both paths) ==========
            if (viewModel.IsPassed)
            {
                var competencyMappings = await _context.AssessmentCompetencyMaps
                    .Include(m => m.KkjMatrixItem)
                    .Where(m => m.AssessmentCategory == assessment.Category &&
                                (m.TitlePattern == null || assessment.Title.Contains(m.TitlePattern)))
                    .ToListAsync();

                if (competencyMappings.Any())
                {
                    viewModel.CompetencyGains = competencyMappings
                        .Select(m => new CompetencyGainItem
                        {
                            CompetencyName = m.KkjMatrixItem?.Kompetensi ?? "Unknown",
                            LevelGranted = m.LevelGranted
                        })
                        .ToList();
                }
            }

            return View(viewModel);
```

**IMPORTANT:** The `viewModel` variable must be declared OUTSIDE the if/else branches for this to work. Currently, `viewModel` is declared inside each branch with `var`. We need to declare it before the if/else:

Before the `if (packageAssignment != null)` line (around line 2542), add:
```csharp
            AssessmentResultsViewModel viewModel;
```

Then inside each branch, change `var viewModel = new AssessmentResultsViewModel` to `viewModel = new AssessmentResultsViewModel`.

This uses the EXACT SAME query pattern as SubmitExam (lines 2322-2326 and 2417-2421):
- `_context.AssessmentCompetencyMaps.Include(m => m.KkjMatrixItem)`
- `.Where(m => m.AssessmentCategory == assessment.Category && (m.TitlePattern == null || assessment.Title.Contains(m.TitlePattern)))`

Key constraints:
- CompetencyGains is ONLY populated when `viewModel.IsPassed` is true — failed assessments get null
- The query is READ-ONLY — no database mutations (unlike SubmitExam which updates UserCompetencyLevel)
- Null guard: `m.KkjMatrixItem?.Kompetensi ?? "Unknown"` prevents NRE if KkjMatrixItem nav property is null
- If no AssessmentCompetencyMap entries match, `competencyMappings.Any()` is false and CompetencyGains stays null

**View — Results.cshtml:**

After the motivational message section (line 87-98) and BEFORE the "Answer Review Section" comment (line 100), add:

```html
    <!-- Kompetensi Diperoleh (Competencies Earned) -->
    @if (Model.CompetencyGains != null && Model.CompetencyGains.Any())
    {
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-award me-2 text-success"></i>Kompetensi Diperoleh</h5>
            </div>
            <div class="card-body p-0">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Nama Kompetensi</th>
                            <th>Level Diperoleh</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var comp in Model.CompetencyGains)
                        {
                            <tr>
                                <td class="fw-semibold">@comp.CompetencyName</td>
                                <td>
                                    <span class="badge bg-success fs-6">Level @comp.LevelGranted</span>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
```

Key constraints:
- Double guard: `Model.CompetencyGains != null && Model.CompetencyGains.Any()` — card only renders when competencies exist
- For failed assessments, `CompetencyGains` is null so the card is invisible
- For passed assessments with no category mappings, `CompetencyGains` is also null — card is invisible
- Card style matches "Answer Review" card pattern (card shadow-sm, card-header bg-light, table inside card-body p-0)
- Indonesian labels: "Kompetensi Diperoleh", "Nama Kompetensi", "Level Diperoleh"
  </action>
  <verify>
`dotnet build` succeeds. Navigate to `/CMP/Results/{id}` for:
1. A passed assessment whose category has AssessmentCompetencyMap entries — "Kompetensi Diperoleh" card should appear with competency names and levels
2. A failed assessment — no "Kompetensi Diperoleh" card should appear
3. A passed assessment whose category has NO AssessmentCompetencyMap entries — no card should appear
  </verify>
  <done>
Results page shows a "Kompetensi Diperoleh" card listing competency names and levels granted when the worker passed an assessment and competency mappings exist for that category. The card is invisible for failed assessments or when no mappings exist. No existing Results page behavior is modified.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` succeeds with no errors
2. Results page for a PASSED assessment with competency mappings shows "Kompetensi Diperoleh" card
3. Results page for a FAILED assessment does NOT show "Kompetensi Diperoleh" card
4. Results page for a PASSED assessment with NO competency mappings does NOT show "Kompetensi Diperoleh" card
5. Existing Results page elements (score, pass/fail, answer review) remain unchanged
6. CompetencyGainItem displays the correct competency name from KkjMatrixItem.Kompetensi and the correct LevelGranted from AssessmentCompetencyMap.LevelGranted
</verification>

<success_criteria>
- Passed assessment results show which competencies were earned with name and level
- Failed assessment results do not show the competency section
- Assessments with no category-to-competency mapping do not show the competency section
- No modifications to existing score display, pass/fail logic, or answer review sections
</success_criteria>

<output>
After completion, create `.planning/phases/25-worker-ux-enhancements/25-02-SUMMARY.md`
</output>
