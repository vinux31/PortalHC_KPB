---
phase: 26-data-integrity-safeguards
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Controllers/CMPController.cs
  - Views/CMP/ManagePackages.cshtml
autonomous: true
must_haves:
  truths:
    - "When HC clicks Delete on a package that has one or more UserPackageAssignment records, a JS confirm dialog shows the number of affected assignments before the delete proceeds"
    - "When HC clicks Delete on a package that has zero UserPackageAssignment records, the existing simple confirm dialog is shown (no assignment count)"
    - "If HC cancels the confirmation, no data is changed — the package, questions, options, and UserPackageAssignment records all remain intact"
    - "DeletePackage also deletes associated UserPackageAssignment and PackageUserResponse records when confirmed, preventing FK constraint errors"
  artifacts:
    - path: "Controllers/CMPController.cs"
      provides: "DeletePackage action with UserPackageAssignment count check and cascade cleanup"
      contains: "UserPackageAssignments.*Count"
    - path: "Views/CMP/ManagePackages.cshtml"
      provides: "Enhanced delete confirmation showing assignment count"
      contains: "confirm.*assignment"
  key_links:
    - from: "Views/CMP/ManagePackages.cshtml"
      to: "Controllers/CMPController.cs"
      via: "form POST to DeletePackage action"
      pattern: "asp-action=\"DeletePackage\""
    - from: "Controllers/CMPController.cs"
      to: "Data/ApplicationDbContext.cs"
      via: "UserPackageAssignments DbSet count + delete"
      pattern: "UserPackageAssignments"
---

<objective>
Add a data-loss warning to the DeletePackage flow. When HC deletes a package that has active UserPackageAssignment records (workers who have been assigned or have taken that package), a confirmation dialog shows the number of affected assignments. The delete also cascades to clean up UserPackageAssignment and PackageUserResponse records that reference the package being deleted, preventing FK constraint errors.

Purpose: Prevent accidental data loss when HC deletes a package that workers have already been assigned to or have taken exams with.
Output: Enhanced DeletePackage action with assignment count awareness and cascade cleanup; ManagePackages view with assignment-aware confirm dialog.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Controllers/CMPController.cs (lines 2791-2814 — current DeletePackage action)
@Views/CMP/ManagePackages.cshtml (lines 87-93 — current delete form with simple confirm)
@Models/UserPackageAssignment.cs (full — FK to AssessmentPackageId)
@Models/AssessmentPackage.cs (full — FK to AssessmentSessionId)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance DeletePackage with assignment count check and cascade cleanup</name>
  <files>Controllers/CMPController.cs, Views/CMP/ManagePackages.cshtml</files>
  <action>
**1. Update `ManagePackages` GET action (line ~2740) to pass assignment counts per package to the view:**

In the ManagePackages action, after loading packages (line ~2751), query UserPackageAssignment counts per package and pass them to the view via ViewBag:

```csharp
// After: var packages = await _context.AssessmentPackages...
var packageIds = packages.Select(p => p.Id).ToList();
var assignmentCounts = await _context.UserPackageAssignments
    .Where(a => packageIds.Contains(a.AssessmentPackageId))
    .GroupBy(a => a.AssessmentPackageId)
    .Select(g => new { PackageId = g.Key, Count = g.Count() })
    .ToDictionaryAsync(x => x.PackageId, x => x.Count);
ViewBag.AssignmentCounts = assignmentCounts;
```

**2. Update `DeletePackage` POST action (line ~2794) to cascade-delete related records:**

Before deleting the package, delete UserPackageAssignment and PackageUserResponse records that reference this package. This prevents FK constraint violations and is the correct behavior since the package and all its data are being removed.

After `if (pkg == null) return NotFound();` and before the existing cascade delete code, add:

```csharp
// Delete PackageUserResponses that reference questions in this package
var questionIds = pkg.Questions.Select(q => q.Id).ToList();
if (questionIds.Any())
{
    var pkgResponses = await _context.PackageUserResponses
        .Where(r => questionIds.Contains(r.PackageQuestionId))
        .ToListAsync();
    if (pkgResponses.Any())
        _context.PackageUserResponses.RemoveRange(pkgResponses);
}

// Delete UserPackageAssignments that reference this package
var assignments = await _context.UserPackageAssignments
    .Where(a => a.AssessmentPackageId == packageId)
    .ToListAsync();
if (assignments.Any())
    _context.UserPackageAssignments.RemoveRange(assignments);
```

Keep the existing cascade delete (options -> questions -> package) and SaveChangesAsync unchanged.

Also add audit logging after the save, matching the existing pattern:
```csharp
// After SaveChangesAsync, before redirect:
try
{
    var delUser = await _userManager.GetUserAsync(User);
    var delActorName = $"{delUser?.NIP ?? "?"} - {delUser?.FullName ?? "Unknown"}";
    await _auditLog.LogAsync(
        delUser?.Id ?? "",
        delActorName,
        "DeletePackage",
        $"Deleted package '{pkg.PackageName}' from assessment [ID={assessmentId}]" +
            (assignments.Any() ? $" ({assignments.Count} assignment(s) removed)" : ""),
        assessmentId,
        "AssessmentPackage");
}
catch { /* audit failure must not roll back successful delete */ }
```

**3. Update `ManagePackages.cshtml` delete form (line ~87) to show assignment-aware confirm:**

Replace the existing delete form's `onsubmit` to use the assignment count from ViewBag:

```razor
@{
    var assignmentCounts = ViewBag.AssignmentCounts as Dictionary<int, int> ?? new Dictionary<int, int>();
}
```
Add this at the top of the view (after existing variable declarations).

Then replace the delete form block (lines 87-93) with:

```razor
@{
    var aCount = assignmentCounts.ContainsKey(pkg.Id) ? assignmentCounts[pkg.Id] : 0;
    var confirmMsg = aCount > 0
        ? $"PERINGATAN: {aCount} peserta sudah ditugaskan ke {pkg.PackageName}. Menghapus paket ini akan menghapus semua data jawaban dan penugasan mereka.\\n\\nLanjutkan hapus?"
        : $"Hapus {pkg.PackageName} dan semua pertanyaannya?";
}
<form asp-action="DeletePackage" method="post"
      onsubmit="return confirm('@Html.Raw(confirmMsg)');">
    <input type="hidden" name="packageId" value="@pkg.Id" />
    <button type="submit" class="btn btn-sm btn-outline-danger">
        <i class="bi bi-trash"></i>
    </button>
</form>
```

This uses JS `confirm()` with a stronger warning message when assignments exist, matching the established hidden form POST + confirm() pattern used throughout the project (e.g., ResetAssessment, ForceClose, DeleteTrainingRecord).

**Important:** Do NOT use `@` string interpolation inside Razor that also uses `@` — use the `@{ var ... }` block pattern shown above to pre-compute the confirm message.
  </action>
  <verify>
1. `dotnet build` compiles without errors
2. Grep for `UserPackageAssignments` in DeletePackage action confirms the count check exists
3. Grep for `assignmentCounts` in ManagePackages.cshtml confirms the view uses assignment counts
4. Grep for `PackageUserResponses` in DeletePackage action confirms cascade cleanup exists
  </verify>
  <done>
- Deleting a package with active assignments shows a confirm dialog with the assignment count and a warning about data loss
- Deleting a package with zero assignments shows the simpler confirm dialog
- The delete cascades to clean up UserPackageAssignment and PackageUserResponse records
- Cancelling the confirm dialog leaves all data intact
- DeletePackage is audit-logged
  </done>
</task>

</tasks>

<verification>
1. Open ManagePackages view for an assessment that has packages
2. If a package has UserPackageAssignment records, the Delete button confirm shows the count and a warning
3. Cancelling the dialog does not delete anything
4. Confirming the dialog deletes the package, its questions, options, assignments, and responses
5. An audit log entry is written for the delete
</verification>

<success_criteria>
- DATA-01 satisfied: HC sees a confirmation warning before deleting a package that has active UserPackageAssignment records
- Delete cascades correctly to UserPackageAssignment and PackageUserResponse
- No FK constraint errors on delete
- Audit log entry written
</success_criteria>

<output>
After completion, create `.planning/phases/26-data-integrity-safeguards/26-01-SUMMARY.md`
</output>
