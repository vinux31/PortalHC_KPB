---
phase: 26-data-integrity-safeguards
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Controllers/CMPController.cs
  - Views/CMP/EditAssessment.cshtml
autonomous: true
must_haves:
  truths:
    - "When HC changes the Schedule date on EditAssessment and packages are attached to that assessment's sibling group, a JS confirm warning is shown before the form submits"
    - "The warning tells HC how many packages are attached and that changing the date may affect package-user associations"
    - "If HC cancels the confirmation, the form does not submit and no data is changed"
    - "If no packages are attached to the assessment's sibling group, the form submits normally without any extra confirmation"
  artifacts:
    - path: "Controllers/CMPController.cs"
      provides: "EditAssessment GET passes package count to view"
      contains: "PackageCount"
    - path: "Views/CMP/EditAssessment.cshtml"
      provides: "JS onsubmit handler that detects date change and shows confirm when packages exist"
      contains: "confirm.*paket"
  key_links:
    - from: "Views/CMP/EditAssessment.cshtml"
      to: "Controllers/CMPController.cs"
      via: "form POST to EditAssessment and JS confirm gate"
      pattern: "asp-action=\"EditAssessment\""
    - from: "Controllers/CMPController.cs"
      to: "Data/ApplicationDbContext.cs"
      via: "AssessmentPackages count query for sibling sessions"
      pattern: "AssessmentPackages.*Count"
---

<objective>
Add a schedule-change warning to the EditAssessment flow. When HC changes the Schedule date on an assessment that has packages attached (via sibling session lookup), a JS confirm dialog warns them that changing the date may affect package associations. This is a client-side guard — no server-side confirmation page is needed.

Purpose: Prevent accidental disruption to package-based assessments when HC changes the schedule date, which could break the sibling-session package lookup (packages are attached to a representative session ID found via Title+Category+Date matching).
Output: EditAssessment GET passes package count to view; EditAssessment form gains JS onsubmit handler that detects date change + packages and shows confirm.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Controllers/CMPController.cs (lines 535-588 — EditAssessment GET; lines 590-666 — EditAssessment POST)
@Views/CMP/EditAssessment.cshtml (full — form with Schedule input and JS section)
@Models/AssessmentPackage.cs (full — AssessmentSessionId FK)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add package count to EditAssessment GET and schedule-change confirm to view</name>
  <files>Controllers/CMPController.cs, Views/CMP/EditAssessment.cshtml</files>
  <action>
**1. In `EditAssessment` GET action (line ~535), query and pass package count:**

After the sibling query (line ~550-555), find packages attached to any sibling session. Packages are attached via `AssessmentPackage.AssessmentSessionId` which points to one of the sibling session IDs.

Add after `ViewBag.Sections = OrganizationStructure.GetAllSections();` (line ~585):

```csharp
// Count packages attached to this assessment's sibling group (for schedule-change warning)
var siblingIds = siblings.Select(s => s.Id).ToList();
var packageCount = await _context.AssessmentPackages
    .CountAsync(p => siblingIds.Contains(p.AssessmentSessionId));
ViewBag.PackageCount = packageCount;
ViewBag.OriginalSchedule = assessment.Schedule.ToString("yyyy-MM-dd");
```

The `siblings` variable already exists from line ~550. We pass the original schedule date as a string for the JS date comparison.

**2. In `EditAssessment.cshtml`, add JS onsubmit handler that warns on date change when packages exist:**

At the top of the `@{ }` block (after existing variable declarations, around line 23), add:

```razor
var packageCount = (int)(ViewBag.PackageCount ?? 0);
var originalSchedule = (string)(ViewBag.OriginalSchedule ?? "");
```

Replace the opening `<form>` tag (line ~53) to add an id:

```razor
<form asp-action="EditAssessment" asp-route-id="@Model.Id" method="post" class="needs-validation" novalidate id="editAssessmentForm">
```

Then in the `@section Scripts` block, add the following JS BEFORE the existing Bootstrap validation code (insert around line ~357, after the `<script>` opening tag):

```javascript
// Schedule-change warning when packages are attached
(function() {
    var packageCount = @packageCount;
    var originalSchedule = '@originalSchedule';
    if (packageCount <= 0) return; // No packages — no warning needed

    var form = document.getElementById('editAssessmentForm');
    if (!form) return;

    form.addEventListener('submit', function(e) {
        var scheduleInput = document.getElementById('Schedule');
        if (!scheduleInput) return;

        var newSchedule = scheduleInput.value;
        if (newSchedule !== originalSchedule) {
            var msg = 'PERINGATAN: Assessment ini memiliki ' + packageCount + ' paket ujian yang terkait. ' +
                      'Mengubah tanggal jadwal dapat mempengaruhi penugasan paket peserta.\n\n' +
                      'Lanjutkan simpan perubahan?';
            if (!confirm(msg)) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
        }
    });
})();
```

This approach:
- Is purely client-side (no separate confirmation page or second POST needed)
- Only triggers when the date is actually changed AND packages exist
- Matches the established confirm() pattern used throughout the project
- Does not interfere with Bootstrap form validation (it runs on submit, before the validation handler)
- Does nothing when packageCount is 0 (no packages attached)

**Important implementation notes:**
- The `@packageCount` and `@originalSchedule` are Razor expressions that emit server-side values into the JS. Since `packageCount` is an int, it renders as a bare number. `originalSchedule` is a string in yyyy-MM-dd format matching the HTML date input's value format.
- The `id="Schedule"` on the input is generated automatically by `asp-for="Schedule"` tag helper.
- Do NOT add a second `<script>` tag — insert the IIFE inside the existing `<script>` block in `@section Scripts`.
  </action>
  <verify>
1. `dotnet build` compiles without errors
2. Grep for `PackageCount` in CMPController.cs confirms the count is passed to the view
3. Grep for `packageCount` in EditAssessment.cshtml confirms the JS uses the count
4. Grep for `originalSchedule` in EditAssessment.cshtml confirms the JS compares dates
  </verify>
  <done>
- When HC changes the Schedule date on an assessment with attached packages, a confirm dialog warns about the impact
- When HC does not change the date, or there are no packages, the form submits normally
- Cancelling the dialog prevents the form from submitting
  </done>
</task>

</tasks>

<verification>
1. Open EditAssessment for an assessment that has packages — change the date and submit — confirm dialog appears with package count
2. Cancel the dialog — no data changed
3. Confirm the dialog — form submits normally and changes are saved
4. Open EditAssessment for an assessment without packages — change the date — no extra confirmation
5. Open EditAssessment for an assessment with packages — change other fields but NOT the date — no extra confirmation
</verification>

<success_criteria>
- DATA-02 satisfied: HC sees a confirmation warning when editing an assessment's schedule date if packages are attached
- Warning only appears when date is changed AND packages exist
- Cancelling leaves data unchanged
- Non-date edits are unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/26-data-integrity-safeguards/26-02-SUMMARY.md`
</output>
