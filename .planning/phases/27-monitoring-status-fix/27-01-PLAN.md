---
phase: 27-monitoring-status-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Controllers/CMPController.cs
  - Models/AssessmentMonitoringViewModel.cs
autonomous: false

must_haves:
  truths:
    - "HC opens the monitoring tab — a worker who started but has not submitted shows In Progress, not Not started"
    - "HC opens the monitoring tab — a worker who abandoned shows Abandoned, not Not started"
    - "A worker who has not started shows Not started"
    - "A worker who submitted shows Completed"
  artifacts:
    - path: "Controllers/CMPController.cs"
      provides: "GetMonitorData endpoint with 4-state UserStatus projection and Abandoned sessions included in WHERE"
      contains: "Abandoned"
    - path: "Models/AssessmentMonitoringViewModel.cs"
      provides: "MonitoringSessionViewModel with accurate UserStatus comment listing all 4 states"
      contains: "In Progress"
  key_links:
    - from: "GetMonitorData WHERE clause"
      to: "AssessmentSessions with Status Abandoned"
      via: "a.Status == Abandoned added to filter"
      pattern: "Status == \"Abandoned\""
    - from: "GetMonitorData SELECT projection"
      to: "a.StartedAt nullable field"
      via: "a.StartedAt included in anonymous type"
      pattern: "a\\.StartedAt"
    - from: "GetMonitorData UserStatus projection"
      to: "4-state branch logic"
      via: "Completed then Abandoned then InProgress then Not started — Abandoned before InProgress"
      pattern: "Abandoned"
---

<objective>
Update GetMonitorData in CMPController to use a 4-state UserStatus projection instead of the current 2-state logic, and include Abandoned sessions in the WHERE clause so they appear in the monitoring card summary.

Purpose: HC currently sees "Not started" for both InProgress and Abandoned sessions in the monitoring card summary, which gives an inaccurate picture of assessment participation. The AssessmentMonitoringDetail view already has correct 4-state logic — GetMonitorData needs to match it.
Output: GetMonitorData returns correct UserStatus for all 4 states: Completed, Abandoned, In Progress, Not started. Abandoned sessions are no longer hidden from the monitoring card.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix GetMonitorData — WHERE, SELECT, and UserStatus projection</name>
  <files>Controllers/CMPController.cs</files>
  <action>
In the GetMonitorData method (around line 277), make three targeted changes:

CHANGE 1 — Add Abandoned to the WHERE clause. Currently the filter excludes Abandoned sessions entirely, so they never appear in the monitoring card. Add || a.Status == "Abandoned" to the existing filter. Result:

    .Where(a => a.Status == "Open"
             || a.Status == "InProgress"
             || a.Status == "Abandoned"
             || a.Status == "Upcoming"
             || (a.Status == "Completed" && a.CompletedAt != null && a.CompletedAt >= cutoff))

CHANGE 2 — Add StartedAt to the SELECT projection. The current anonymous .Select() projection does not include StartedAt, which is needed to detect the InProgress state. Add a.StartedAt alongside the existing fields.

CHANGE 3 — Replace the 2-state UserStatus with 4-state logic. Current code (lines 303-309):

    bool isCompleted = a.Score != null || a.CompletedAt != null;
    return new MonitoringSessionViewModel
    {
        ...
        UserStatus = isCompleted ? "Completed" : "Not started",
        ...
    };

Replace with the 4-state logic that mirrors AssessmentMonitoringDetail exactly. CRITICAL: the Abandoned branch MUST come before the InProgress check because Abandoned sessions have StartedAt set and would otherwise be misclassified as InProgress:

    string userStatus;
    if (a.CompletedAt != null || a.Score != null)
        userStatus = "Completed";
    else if (a.Status == "Abandoned")
        userStatus = "Abandoned";
    else if (a.StartedAt != null)
        userStatus = "In Progress";
    else
        userStatus = "Not started";

    return new MonitoringSessionViewModel
    {
        Id           = a.Id,
        UserFullName = a.UserFullName,
        UserNIP      = a.UserNIP,
        UserStatus   = userStatus,
        Score        = a.Score,
        IsPassed     = a.IsPassed,
        CompletedAt  = a.CompletedAt,
        StartedAt    = a.StartedAt
    };

Do NOT change the groupStatus or completedCount/passedCount aggregations below the session projection. groupStatus uses a.Status (the DB field, not UserStatus) — unaffected. completedCount uses s.UserStatus == "Completed" — remains correct.
  </action>
  <verify>dotnet build from the solution root. Confirm zero build errors.</verify>
  <done>Project builds without errors. WHERE clause includes Abandoned. SELECT includes StartedAt. UserStatus projection is 4-state with Abandoned branch before In Progress.</done>
</task>

<task type="auto">
  <name>Task 2: Update MonitoringSessionViewModel UserStatus comment</name>
  <files>Models/AssessmentMonitoringViewModel.cs</files>
  <action>
On the UserStatus property in MonitoringSessionViewModel, the comment currently reads:

    public string UserStatus { get; set; } = "";    // "Not started", "InProgress", or "Completed"

Update the comment to document all 4 valid states:

    public string UserStatus { get; set; } = "";    // "Not started", "In Progress", "Abandoned", or "Completed"

This is a comment-only change. No logic changes.
  </action>
  <verify>File saved. Comment now lists all 4 states.</verify>
  <done>UserStatus comment in MonitoringSessionViewModel accurately documents all 4 possible values including Abandoned and In Progress.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify monitoring card shows correct 4-state statuses</name>
  <files>Controllers/CMPController.cs, Models/AssessmentMonitoringViewModel.cs</files>
  <action>
This is a human verification checkpoint. All implementation was completed in Tasks 1 and 2. Confirm that the monitoring card summary now returns accurate statuses for Abandoned and InProgress sessions.
  </action>
  <what-built>
GetMonitorData now returns 4-state UserStatus values. Three changes were made:
1. Abandoned sessions included in the WHERE clause (previously excluded)
2. StartedAt projected in the SELECT so InProgress detection works
3. UserStatus projection changed from 2-state to 4-state: Completed then Abandoned then In Progress then Not started
  </what-built>
  <how-to-verify>
1. Start the app and log in as HC or Admin.
2. Navigate to the Assessment manage view and click the Monitoring tab.
3. Open browser DevTools, go to the Network tab, and filter for GetMonitorData.
4. The Monitoring tab triggers a fetch on first activation — inspect the JSON response.
5. Find a session where the worker started but did not submit (Status=InProgress or StartedAt is set). Confirm userStatus in the JSON is "In Progress", not "Not started".
6. Find a session where the worker abandoned (Status=Abandoned). Confirm userStatus in the JSON is "Abandoned", not "Not started".
7. Find a session where the worker never started. Confirm userStatus is "Not started".
8. Find a session where the worker submitted. Confirm userStatus is "Completed".
9. Verify the progress bar in the card (Completed X/Y) still reflects only submitted sessions.
  </how-to-verify>
  <verify>User confirms all statuses are correct in the GetMonitorData JSON response via DevTools inspection.</verify>
  <done>HC sees accurate 4-state statuses in the monitoring card — Abandoned and In Progress sessions no longer appear as Not started. MON-01 satisfied.</done>
  <resume-signal>Type "approved" if statuses are correct, or describe any discrepancy.</resume-signal>
</task>

</tasks>

<verification>
- dotnet build completes with zero errors
- GetMonitorData JSON response contains correct userStatus values for all 4 states
- Abandoned sessions appear in the GetMonitorData response (previously excluded from WHERE)
- Workers with StartedAt set but not Abandoned or Completed show "In Progress"
- Workers with Status=Abandoned show "Abandoned"
- The monitoring card progress bar (completedCount/totalCount) remains accurate — CompletedCount counts only sessions with UserStatus=Completed
- MON-01 satisfied: HC sees accurate session status in the monitoring card summary
</verification>

<success_criteria>
- Abandoned sessions appear in GetMonitorData response (WHERE fix)
- Workers who started but did not submit show "In Progress" in the monitoring card JSON
- Workers who abandoned show "Abandoned" in the monitoring card JSON
- Workers who never started show "Not started"
- Workers who submitted show "Completed"
- dotnet build passes with zero errors
- No regression to completedCount, passedCount, or groupStatus aggregations
</success_criteria>

<output>
After completion, create `.planning/phases/27-monitoring-status-fix/27-01-SUMMARY.md`
</output>
