---
phase: 28-package-reassign-and-reshuffle
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Controllers/CMPController.cs
  - Models/AssessmentMonitoringViewModel.cs
autonomous: true

must_haves:
  truths:
    - "POST /CMP/ReshufflePackage with a session ID deletes the existing UserPackageAssignment and creates a new one with a different random package"
    - "POST /CMP/ReshuffleAll with title/category/scheduleDate reshuffles all Pending (Not started) workers and returns per-worker results"
    - "Reshuffle is blocked for InProgress, Completed, and Abandoned sessions — only Not started sessions are eligible"
    - "Reshuffle selects a different package from the current one when multiple packages exist"
    - "Both actions return JSON responses suitable for AJAX consumption"
    - "MonitoringGroupViewModel exposes IsPackageMode and MonitoringSessionViewModel exposes PackageName so the view can conditionally render reshuffle controls"
  artifacts:
    - path: "Controllers/CMPController.cs"
      provides: "ReshufflePackage and ReshuffleAll POST actions"
      contains: "ReshufflePackage"
    - path: "Models/AssessmentMonitoringViewModel.cs"
      provides: "IsPackageMode flag on group, PackageName on session"
      contains: "IsPackageMode"
  key_links:
    - from: "Controllers/CMPController.cs (ReshufflePackage)"
      to: "UserPackageAssignments DbSet"
      via: "Delete existing assignment + create new with different AssessmentPackageId"
      pattern: "UserPackageAssignments"
    - from: "Controllers/CMPController.cs (ReshuffleAll)"
      to: "ReshufflePackage logic"
      via: "Loop over all Not started sessions, apply same reshuffle logic"
      pattern: "ReshuffleAll"
    - from: "Controllers/CMPController.cs (AssessmentMonitoringDetail)"
      to: "Models/AssessmentMonitoringViewModel.cs"
      via: "Populates IsPackageMode and PackageName fields"
      pattern: "IsPackageMode"
---

<objective>
Add backend controller actions for package reshuffle (single and bulk) and extend the monitoring view models with package-mode awareness.

Purpose: Enable HC to reshuffle worker package assignments as a recovery action after technical incidents, ensuring fairness through re-randomization.

Output: Two new POST actions (ReshufflePackage, ReshuffleAll) returning JSON, and extended view models with IsPackageMode/PackageName fields for the UI layer.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-package-reassign-and-reshuffle/28-CONTEXT.md

Key source files:
@Controllers/CMPController.cs (AssessmentMonitoringDetail at ~line 359, ResetAssessment at ~line 423, Shuffle helper at ~line 2043, StartExam package assignment at ~line 1880)
@Models/AssessmentMonitoringViewModel.cs
@Models/UserPackageAssignment.cs
@Models/AssessmentPackage.cs
@Services/AuditLogService.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend view models and update AssessmentMonitoringDetail to populate package info</name>
  <files>Models/AssessmentMonitoringViewModel.cs, Controllers/CMPController.cs</files>
  <action>
1. **Extend MonitoringGroupViewModel** in `Models/AssessmentMonitoringViewModel.cs`:
   - Add `public bool IsPackageMode { get; set; }` — true when the assessment group has packages attached
   - Add `public int PendingCount { get; set; }` — count of "Not started" sessions (for the Reshuffle All confirmation dialog)

2. **Extend MonitoringSessionViewModel** in `Models/AssessmentMonitoringViewModel.cs`:
   - Add `public string PackageName { get; set; } = "";` — the name of the currently assigned package (e.g., "Paket A"), empty if no assignment
   - Add `public int? AssignmentId { get; set; }` — the UserPackageAssignment.Id if one exists, null otherwise (used by AJAX to identify the assignment)

3. **Update AssessmentMonitoringDetail action** in `Controllers/CMPController.cs` (~line 359):
   After `sessions` is loaded but before building `sessionViewModels`, detect package mode:

   ```csharp
   // Detect package mode: check if any sibling session has packages attached
   var siblingIds = sessions.Select(s => s.Id).ToList();
   var packageCount = await _context.AssessmentPackages
       .CountAsync(p => siblingIds.Contains(p.AssessmentSessionId));
   var isPackageMode = packageCount > 0;

   // Load package assignments for all sessions in this group (for PackageName display)
   Dictionary<int, (int AssignmentId, string PackageName)> assignmentMap = new();
   if (isPackageMode)
   {
       assignmentMap = await _context.UserPackageAssignments
           .Where(a => siblingIds.Contains(a.AssessmentSessionId))
           .Join(_context.AssessmentPackages,
               a => a.AssessmentPackageId,
               p => p.Id,
               (a, p) => new { a.AssessmentSessionId, a.Id, p.PackageName })
           .ToDictionaryAsync(
               x => x.AssessmentSessionId,
               x => (x.Id, x.PackageName));
   }
   ```

   Then in the `sessions.Select(...)` lambda, populate the new fields:
   ```csharp
   PackageName = assignmentMap.ContainsKey(a.Id) ? assignmentMap[a.Id].PackageName : "",
   AssignmentId = assignmentMap.ContainsKey(a.Id) ? assignmentMap[a.Id].AssignmentId : null
   ```

   And on the `MonitoringGroupViewModel`:
   ```csharp
   IsPackageMode = isPackageMode,
   PendingCount = sessionViewModels.Count(s => s.UserStatus == "Not started")
   ```

   **IMPORTANT**: The context doc says "Pending" workers, but in the current codebase UserStatus is "Not started" — use "Not started" in code, the UI can label it however it wants.
  </action>
  <verify>
  Build succeeds: `dotnet build` passes with no errors. The new properties appear on the view models. The AssessmentMonitoringDetail action loads package assignments and populates IsPackageMode/PackageName/AssignmentId.
  </verify>
  <done>
  MonitoringGroupViewModel has IsPackageMode and PendingCount. MonitoringSessionViewModel has PackageName and AssignmentId. AssessmentMonitoringDetail queries UserPackageAssignments and populates these fields for every session in the group.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add ReshufflePackage and ReshuffleAll POST controller actions</name>
  <files>Controllers/CMPController.cs</files>
  <action>
Add two new POST actions after the existing ForceCloseAssessment action (~line 540) in CMPController.cs:

**1. ReshufflePackage (single worker)**

```csharp
[HttpPost]
[Authorize(Roles = "Admin, HC")]
[ValidateAntiForgeryToken]
public async Task<IActionResult> ReshufflePackage(int sessionId)
```

Logic:
- Load the `AssessmentSession` by `sessionId`. Return `Json(new { success = false, message = "Session not found." })` if null.
- Derive UserStatus using the same 4-state logic as AssessmentMonitoringDetail:
  - If `CompletedAt != null || Score != null` → "Completed"
  - If `Status == "Abandoned"` → "Abandoned"
  - If `StartedAt != null` → "InProgress"
  - Else → "Not started"
- If UserStatus is NOT "Not started", return `Json(new { success = false, message = "Hanya peserta yang belum mulai ujian yang dapat di-reshuffle." })`.
- Find sibling session IDs (same Title + Category + Schedule.Date) — reuse the same pattern from StartExam.
- Load all `AssessmentPackages` for those sibling IDs.
- If no packages exist, return `Json(new { success = false, message = "Assessment ini tidak menggunakan mode paket." })`.
- Load current `UserPackageAssignment` for this session (may be null if worker hasn't started yet, which is fine — reshuffle creates a new assignment).
- Select a new package:
  - If there are 2+ packages AND a current assignment exists, exclude the current `AssessmentPackageId` and pick randomly from the rest.
  - If only 1 package exists or no current assignment, pick randomly from all packages (the requirement says "different from current one **if possible**").
- Delete the existing assignment if one exists.
- Create a new `UserPackageAssignment`:
  - Use the existing `Shuffle<T>` helper (Fisher-Yates at ~line 2043).
  - Create an `rng = new Random()`.
  - Shuffle question IDs and option IDs per question (same logic as StartExam at ~line 1894-1918).
  - Set `AssessmentSessionId = sessionId`, `AssessmentPackageId = selectedPackage.Id`, `UserId = assessment.UserId`.
- `SaveChangesAsync()`.
- Audit log: `_auditLog.LogAsync(...)` with ActionType `"ReshufflePackage"`, description including worker name and old/new package name, targetId = sessionId, targetType = "AssessmentSession".
  - Load the HC user for actor info: `var hcUser = await _userManager.GetUserAsync(User);`
  - Wrap audit in try/catch (consistent with delete actions pattern).
- Return `Json(new { success = true, packageName = selectedPackage.PackageName, assignmentId = newAssignment.Id })`.

**2. ReshuffleAll (bulk)**

```csharp
[HttpPost]
[Authorize(Roles = "Admin, HC")]
[ValidateAntiForgeryToken]
public async Task<IActionResult> ReshuffleAll(string title, string category, DateTime scheduleDate)
```

Logic:
- Load all sessions for this group (same query as AssessmentMonitoringDetail). Include `User` for names.
- Find sibling IDs and load all packages. If no packages, return `Json(new { success = false, message = "Assessment ini tidak menggunakan mode paket." })`.
- Load all existing assignments for sibling IDs into a dictionary keyed by `AssessmentSessionId`.
- Build a results list: `List<object>` with `{ name, status }` per worker.
- For each session:
  - Derive UserStatus using the 4-state logic.
  - If NOT "Not started": add to results as `{ name = user.FullName, status = "Dilewati — " + reason }` (reason: "sedang mengerjakan" for InProgress, "sudah selesai" for Completed, "dibatalkan" for Abandoned).
  - If "Not started":
    - Apply the same reshuffle logic as ReshufflePackage (select different package if possible, delete old assignment, create new).
    - Add to results as `{ name = user.FullName, status = "Reshuffled → " + newPackageName }`.
- `SaveChangesAsync()` once at the end (batch — not per-worker).
- Audit log: single entry with ActionType `"ReshuffleAll"`, description listing the count of reshuffled workers.
- Return `Json(new { success = true, results = resultsList, reshuffledCount = count })`.

**Important implementation notes:**
- Both actions use `[ValidateAntiForgeryToken]` — the AJAX calls must send the token.
- The Shuffle helper is `private static void Shuffle<T>(List<T> list, Random rng)` — already exists in CMPController at ~line 2043. Reuse it directly.
- For ReshuffleAll, create a single `Random` instance and reuse across all workers (avoid re-seeding per worker).
- For ReshuffleAll, accumulate all DB changes (delete old assignments, add new assignments) and call `SaveChangesAsync()` once before the audit log.
  </action>
  <verify>
  Build succeeds: `dotnet build` passes with no errors. Both actions exist and compile. Verify by searching the controller for `ReshufflePackage` and `ReshuffleAll` — both should appear as `[HttpPost]` actions.
  </verify>
  <done>
  ReshufflePackage POST action accepts sessionId, validates eligibility (Not started only), selects a different random package, deletes old assignment, creates new assignment with shuffled questions/options, logs audit, and returns JSON with success/packageName/assignmentId. ReshuffleAll POST action accepts group identifiers, iterates all sessions, reshuffles eligible workers, skips ineligible ones with reasons, and returns JSON with per-worker results list.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` passes — no compile errors.
2. `MonitoringGroupViewModel` has `IsPackageMode` (bool) and `PendingCount` (int).
3. `MonitoringSessionViewModel` has `PackageName` (string) and `AssignmentId` (int?).
4. `AssessmentMonitoringDetail` action queries packages and assignments, populates IsPackageMode/PackageName/AssignmentId.
5. `ReshufflePackage` POST exists, returns JSON, guards against non-Pending workers, picks different package when possible.
6. `ReshuffleAll` POST exists, returns JSON with per-worker results, only reshuffles Not started workers.
7. Both actions have `[Authorize(Roles = "Admin, HC")]` and `[ValidateAntiForgeryToken]`.
8. Both actions write audit logs.
</verification>

<success_criteria>
Backend is complete: two JSON-returning POST actions for single and bulk reshuffle, view models enriched with package-mode flag and package name. The UI plan (28-02) can build on this without any additional controller changes.
</success_criteria>

<output>
After completion, create `.planning/phases/28-package-reassign-and-reshuffle/28-01-SUMMARY.md`
</output>
