---
phase: 28-package-reassign-and-reshuffle
plan: 02
type: execute
wave: 2
depends_on: ["28-01"]
files_modified:
  - Views/CMP/AssessmentMonitoringDetail.cshtml
autonomous: true

must_haves:
  truths:
    - "On a package-mode assessment, each worker row shows a Reshuffle button — active for Not started, disabled (grayed out) for InProgress/Completed/Abandoned"
    - "Clicking an active Reshuffle button immediately reshuffles the worker's package via AJAX and shows a toast notification with the new package name"
    - "The worker row updates in-place after reshuffle (PackageName column updates, no full page reload)"
    - "A Reshuffle All button exists on the page and is visible only for package-mode assessments"
    - "Clicking Reshuffle All shows a confirmation dialog with the count of pending workers"
    - "After Reshuffle All completes, a modal shows the result list (each worker name and outcome)"
    - "Reshuffle controls do not appear for question-mode assessments"
    - "Disabled reshuffle buttons show a tooltip explaining why they are disabled"
  artifacts:
    - path: "Views/CMP/AssessmentMonitoringDetail.cshtml"
      provides: "Reshuffle UI controls, AJAX calls, toast, confirmation dialog, result modal"
      contains: "ReshufflePackage"
  key_links:
    - from: "Views/CMP/AssessmentMonitoringDetail.cshtml (per-worker button)"
      to: "/CMP/ReshufflePackage"
      via: "jQuery $.ajax POST"
      pattern: "ReshufflePackage"
    - from: "Views/CMP/AssessmentMonitoringDetail.cshtml (Reshuffle All button)"
      to: "/CMP/ReshuffleAll"
      via: "jQuery $.ajax POST"
      pattern: "ReshuffleAll"
---

<objective>
Add reshuffle UI controls to the AssessmentMonitoringDetail view: per-worker reshuffle buttons, Reshuffle All button, confirmation dialog, result modal, and toast notifications.

Purpose: Give HC a visible, intuitive way to reshuffle package assignments directly from the monitoring detail page, with clear feedback on what happened.

Output: Updated AssessmentMonitoringDetail.cshtml with all reshuffle UI and AJAX interactions.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-package-reassign-and-reshuffle/28-CONTEXT.md
@.planning/phases/28-package-reassign-and-reshuffle/28-01-SUMMARY.md

Key source files:
@Views/CMP/AssessmentMonitoringDetail.cshtml
@Views/CMP/Assessment.cshtml (for AJAX patterns — $.ajax, $.post usage)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Package column, reshuffle buttons, Reshuffle All button, and AJAX interactions</name>
  <files>Views/CMP/AssessmentMonitoringDetail.cshtml</files>
  <action>
Modify `Views/CMP/AssessmentMonitoringDetail.cshtml` to add reshuffle capabilities. The view uses `@model HcPortal.Models.MonitoringGroupViewModel`.

**1. Add Package column to the table (conditional on IsPackageMode)**

In the `<thead>`, add a "Package" column header **after the NIP column and before Status**, but only when `Model.IsPackageMode` is true:
```razor
@if (Model.IsPackageMode)
{
    <th>Package</th>
}
```

In each `<tr>` body row, add the corresponding cell:
```razor
@if (Model.IsPackageMode)
{
    <td class="small" id="pkg-@session.Id">
        @(string.IsNullOrEmpty(session.PackageName) ? "—" : session.PackageName)
    </td>
}
```

Update the `colspan` on the empty-state row to account for the extra column when IsPackageMode (currently `colspan="7"`, change to `colspan="@(Model.IsPackageMode ? 8 : 7)"`).

**2. Add per-worker Reshuffle button in the Actions column**

Inside the Actions `<td>`, add the reshuffle button **before** the existing Reset/ForceClose buttons. The button renders for ALL workers in package-mode but is disabled for non-Pending:

```razor
@if (Model.IsPackageMode)
{
    var canReshuffle = session.UserStatus == "Not started";
    <button type="button"
            class="btn btn-outline-primary btn-sm me-1 @(canReshuffle ? "" : "disabled")"
            @(canReshuffle ? "" : "disabled")
            data-session-id="@session.Id"
            onclick="@(canReshuffle ? $"reshuffleWorker({session.Id})" : "")"
            title="@(canReshuffle ? "Reshuffle paket ujian" : (session.UserStatus == "InProgress" ? "Tidak bisa reshuffle — sedang mengerjakan" : (session.UserStatus == "Completed" ? "Tidak bisa reshuffle — sudah selesai" : "Tidak bisa reshuffle — dibatalkan")))">
        <i class="bi bi-shuffle me-1"></i>Reshuffle
    </button>
}
```

**3. Add Reshuffle All button**

Add a "Reshuffle All" button in the card header (`.card-header`) area, next to the "Per-User Status" heading. Only show when IsPackageMode is true:

```razor
<div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
    <h5 class="mb-0 fw-semibold">
        <i class="bi bi-people me-2 text-primary"></i>Per-User Status
    </h5>
    @if (Model.IsPackageMode && Model.PendingCount > 0)
    {
        <button type="button" class="btn btn-outline-primary btn-sm"
                onclick="reshuffleAll()">
            <i class="bi bi-shuffle me-1"></i>Reshuffle All (@Model.PendingCount pending)
        </button>
    }
</div>
```

**4. Add toast container and result modal HTML**

At the bottom of the `<div class="container-fluid">`, before the closing `</div>`, add:

**Toast container** (Bootstrap 5 toast, positioned top-right):
```html
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1080;">
    <div id="reshuffleToast" class="toast align-items-center text-bg-success border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body" id="reshuffleToastBody">
                Package reshuffled successfully.
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>
```

**Result modal** (for Reshuffle All results):
```html
<div class="modal fade" id="reshuffleResultModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-shuffle me-2"></i>Reshuffle All — Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="reshuffleResultBody"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
```

**5. Add JavaScript for AJAX calls**

Add a `@section Scripts` block (or inline `<script>` at the bottom if @section is not used in the layout — check the existing view; AssessmentMonitoringDetail.cshtml does NOT currently use @section Scripts, so add an inline `<script>` before the final closing `</div>`):

```javascript
@if (Model.IsPackageMode)
{
<script>
    var antiForgeryToken = '@Html.AntiForgeryToken()'.match(/value="([^"]+)"/)[1];

    function reshuffleWorker(sessionId) {
        var btn = document.querySelector('[data-session-id="' + sessionId + '"]');
        var originalHtml = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        btn.disabled = true;

        $.ajax({
            url: '/CMP/ReshufflePackage',
            type: 'POST',
            data: {
                sessionId: sessionId,
                __RequestVerificationToken: antiForgeryToken
            },
            success: function(resp) {
                if (resp.success) {
                    // Update package name in-place
                    var pkgCell = document.getElementById('pkg-' + sessionId);
                    if (pkgCell) pkgCell.textContent = resp.packageName;

                    // Show toast
                    var toastBody = document.getElementById('reshuffleToastBody');
                    toastBody.textContent = 'Package berhasil di-reshuffle → ' + resp.packageName;
                    var toast = new bootstrap.Toast(document.getElementById('reshuffleToast'));
                    toast.show();
                } else {
                    alert(resp.message || 'Reshuffle gagal.');
                }
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            },
            error: function() {
                alert('Terjadi kesalahan saat reshuffle.');
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        });
    }

    function reshuffleAll() {
        var pendingCount = @Model.PendingCount;
        if (!confirm('Reshuffle semua ' + pendingCount + ' peserta yang belum mulai ujian?')) return;

        var btn = event.target.closest('button');
        var originalHtml = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';
        btn.disabled = true;

        $.ajax({
            url: '/CMP/ReshuffleAll',
            type: 'POST',
            data: {
                title: '@Html.Raw(Model.Title.Replace("'", "\\'"))',
                category: '@Model.Category',
                scheduleDate: '@Model.Schedule.ToString("yyyy-MM-dd")',
                __RequestVerificationToken: antiForgeryToken
            },
            success: function(resp) {
                btn.innerHTML = originalHtml;
                btn.disabled = false;

                if (resp.success) {
                    // Build result table
                    var html = '<table class="table table-sm mb-0"><thead><tr><th>Name</th><th>Result</th></tr></thead><tbody>';
                    resp.results.forEach(function(r) {
                        var badgeClass = r.status.indexOf('Reshuffled') === 0 ? 'text-success' : 'text-muted';
                        html += '<tr><td>' + r.name + '</td><td class="' + badgeClass + '">' + r.status + '</td></tr>';
                    });
                    html += '</tbody></table>';
                    html += '<p class="mt-2 mb-0 text-muted small">' + resp.reshuffledCount + ' peserta berhasil di-reshuffle.</p>';

                    document.getElementById('reshuffleResultBody').innerHTML = html;
                    var modal = new bootstrap.Modal(document.getElementById('reshuffleResultModal'));
                    modal.show();

                    // Update package cells in-place for reshuffled workers
                    // This requires the results to include sessionId and packageName.
                    // Since ReshuffleAll returns per-worker results, we can update after modal close
                    // or immediately. For simplicity, reload after modal is closed:
                    document.getElementById('reshuffleResultModal').addEventListener('hidden.bs.modal', function() {
                        location.reload();
                    }, { once: true });
                } else {
                    alert(resp.message || 'Reshuffle All gagal.');
                }
            },
            error: function() {
                alert('Terjadi kesalahan saat reshuffle.');
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        });
    }
</script>
}
```

**Implementation notes:**
- The `antiForgeryToken` extraction regex parses the hidden input generated by `@Html.AntiForgeryToken()`. This is the same pattern used in Assessment.cshtml (e.g., line 1019: `$('input[name="__RequestVerificationToken"]').val()`). Since this page doesn't have a form with the token, we generate it inline.
- Actually, an alternative is to add a hidden form with the token at the top of the page (simpler and more reliable):
  ```razor
  <form id="reshuffleForm" style="display:none">@Html.AntiForgeryToken()</form>
  ```
  Then in JS: `var antiForgeryToken = document.querySelector('#reshuffleForm input[name="__RequestVerificationToken"]').value;`
  **Use this approach** — it's more reliable than regex parsing.
- For Reshuffle All, a page reload on modal close is acceptable since the bulk operation changes many rows. Per-worker reshuffle updates in-place without reload (per locked decision: "toast notification + card updates in-place").
- Bootstrap 5 Toast and Modal are used — the project already uses Bootstrap 5.
- `bi-shuffle` is the Bootstrap Icons class for shuffle — verify it exists (Bootstrap Icons 1.10+). If not available, use `bi-arrow-repeat` as fallback.
  </action>
  <verify>
  1. `dotnet build` passes — no Razor compilation errors.
  2. Open a package-mode assessment's monitoring detail page in the browser:
     - A "Package" column appears in the table.
     - Each "Not started" worker has an active Reshuffle button.
     - Each InProgress/Completed/Abandoned worker has a disabled Reshuffle button with tooltip.
     - A "Reshuffle All" button appears in the card header.
  3. For a question-mode assessment, no Package column and no Reshuffle buttons appear.
  </verify>
  <done>
  Package column appears in the monitoring table for package-mode assessments. Per-worker Reshuffle buttons are active for Not started workers and disabled with tooltips for others. Reshuffle All button shows with pending count. Clicking per-worker Reshuffle makes AJAX POST, updates cell in-place, and shows toast. Clicking Reshuffle All shows confirm dialog, processes, and displays result modal. Question-mode assessments show no reshuffle controls.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` passes.
2. Navigate to a package-mode assessment's monitoring detail page:
   a. Package column visible with assigned package names.
   b. Per-worker Reshuffle button: active for Not started, disabled for others.
   c. Click Reshuffle on a Not started worker → toast appears, package name updates in-place.
   d. Reshuffle All button visible with pending count.
   e. Click Reshuffle All → confirmation dialog → result modal shows each worker's outcome → page reloads on close.
3. Navigate to a question-mode assessment's monitoring detail page:
   a. No Package column.
   b. No Reshuffle buttons.
   c. No Reshuffle All button.
4. Disabled buttons have descriptive tooltips.
</verification>

<success_criteria>
HC can reshuffle individual worker packages via AJAX with toast feedback, and bulk reshuffle all pending workers with a confirmation dialog and result modal. Reshuffle controls are hidden for non-package assessments. No full page reload needed for single-worker reshuffle.
</success_criteria>

<output>
After completion, create `.planning/phases/28-package-reassign-and-reshuffle/28-02-SUMMARY.md`
</output>
