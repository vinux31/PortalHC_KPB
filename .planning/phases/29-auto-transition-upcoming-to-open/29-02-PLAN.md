---
phase: 29-auto-transition-upcoming-to-open
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Controllers/CMPController.cs
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "A worker whose Upcoming assessment has a scheduled time in the future (same date, later hour) cannot start the exam — StartExam redirects with an error even if navigated to directly"
    - "A worker whose Upcoming assessment has a scheduled date+time that has arrived (Schedule <= now WIB) sees it as Open on their assessment list"
    - "HC monitoring dashboard shows Open for any assessment whose scheduled date+time has arrived (WIB)"
    - "The transition trigger is time-based: an assessment scheduled at 14:00 WIB on today's date is NOT open at 09:00 WIB but IS open at 14:00 WIB"
  artifacts:
    - path: "Controllers/CMPController.cs"
      provides: "Time-based WIB comparison at all three auto-transition sites + StartExam time gate"
      contains: "DateTime.UtcNow.AddHours(7)"
  key_links:
    - from: "Controllers/CMPController.cs (Assessment worker list)"
      to: "auto-transition condition"
      via: "foreach loop"
      pattern: "assessment\\.Schedule <= DateTime\\.UtcNow\\.AddHours\\(7\\)"
    - from: "Controllers/CMPController.cs (GetMonitorData)"
      to: "auto-transition condition"
      via: "re-projection Select"
      pattern: "a\\.Schedule <= DateTime\\.UtcNow\\.AddHours\\(7\\)"
    - from: "Controllers/CMPController.cs (StartExam)"
      to: "auto-transition persist"
      via: "SaveChangesAsync block"
      pattern: "assessment\\.Schedule <= DateTime\\.UtcNow\\.AddHours\\(7\\)"
    - from: "Controllers/CMPController.cs (StartExam)"
      to: "time gate block"
      via: "early return redirect"
      pattern: "assessment\\.Schedule > DateTime\\.UtcNow\\.AddHours\\(7\\)"
---

<objective>
Upgrade the three auto-transition comparison sites in CMPController.cs from date-only to time-based (WIB), and add a StartExam gate that blocks access when the scheduled time has not yet arrived.

Purpose: The existing implementation opens assessments at midnight UTC on the scheduled date regardless of the HC-configured opening time. The user requires time-precision: an assessment set for 14:00 WIB must not open at midnight WIB.

Output: CMPController.cs with four targeted changes — comparison updated at GetMonitorData, worker list, and StartExam persist block; plus a new time gate block added to StartExam before the persist block.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-auto-transition-upcoming-to-open/29-01-SUMMARY.md
@Controllers/CMPController.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update date-only comparisons to time-based WIB at all three auto-transition sites</name>
  <files>Controllers/CMPController.cs</files>
  <action>
    There are three locations in CMPController.cs that compare Schedule against today's date. Each must be updated to compare against current WIB time (DateTime.UtcNow.AddHours(7)) instead.

    **Site 1 — Worker assessment list (around line 236):**

    Current:
    ```csharp
    var todayUtc = DateTime.UtcNow.Date;
    foreach (var exam in exams)
    {
        if (exam.Status == "Upcoming" && exam.Schedule.Date <= todayUtc)
            exam.Status = "Open";
    }
    ```

    Replace with:
    ```csharp
    var nowWib = DateTime.UtcNow.AddHours(7);
    foreach (var exam in exams)
    {
        if (exam.Status == "Upcoming" && exam.Schedule <= nowWib)
            exam.Status = "Open";
    }
    ```

    Remove the `var todayUtc` variable entirely; use `nowWib` in the condition. Drop `.Date` from both sides — compare full DateTime values.

    **Site 2 — GetMonitorData re-projection (around line 309):**

    Current:
    ```csharp
    var today = DateTime.UtcNow.Date;
    monitorSessions = monitorSessions
        .Select(a => new
        {
            ...
            Status = (a.Status == "Upcoming" && a.Schedule.Date <= today) ? "Open" : a.Status,
            ...
        })
        .ToList();
    ```

    Replace the variable and condition:
    ```csharp
    var nowWib = DateTime.UtcNow.AddHours(7);
    monitorSessions = monitorSessions
        .Select(a => new
        {
            ...
            Status = (a.Status == "Upcoming" && a.Schedule <= nowWib) ? "Open" : a.Status,
            ...
        })
        .ToList();
    ```

    Only update the `var today` line and the ternary condition inside the anonymous type. All other fields in the anonymous type are unchanged.

    **Site 3 — StartExam persist block (around line 2122):**

    Current:
    ```csharp
    // Auto-transition: Upcoming → Open when scheduled date has arrived (persisted to DB)
    if (assessment.Status == "Upcoming" && assessment.Schedule.Date <= DateTime.UtcNow.Date)
    {
        assessment.Status = "Open";
        assessment.UpdatedAt = DateTime.UtcNow;
        await _context.SaveChangesAsync();
    }
    ```

    Replace with:
    ```csharp
    // Auto-transition: Upcoming → Open when scheduled date+time has arrived in WIB (persisted to DB)
    if (assessment.Status == "Upcoming" && assessment.Schedule <= DateTime.UtcNow.AddHours(7))
    {
        assessment.Status = "Open";
        assessment.UpdatedAt = DateTime.UtcNow;
        await _context.SaveChangesAsync();
    }
    ```

    Update comment and condition only. Do not move or reorder this block — it must remain before the Completed status check.
  </action>
  <verify>
    Search the file for all remaining occurrences of `UtcNow.Date` in the context of Schedule comparisons — there should be none left at the three auto-transition sites.
    Search for `DateTime.UtcNow.AddHours(7)` — should appear at least three times (one per site).
    The project should build: `dotnet build` exits 0.
  </verify>
  <done>
    All three auto-transition sites use `Schedule <= DateTime.UtcNow.AddHours(7)` with no `.Date` truncation. Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add StartExam time gate blocking future-scheduled assessments</name>
  <files>Controllers/CMPController.cs</files>
  <action>
    In StartExam, after the auto-transition persist block (the block that was just updated in Task 1) and before the Completed status check, add a new guard that rejects access when the assessment is still Upcoming (i.e., the auto-transition did NOT fire because the scheduled time has not arrived yet).

    The placement must be: AFTER the auto-transition block, BEFORE the `if (assessment.Status == "Completed")` check (around line 2129).

    Add this block:
    ```csharp
    // Time gate: block access if assessment is still Upcoming (scheduled time not yet reached)
    if (assessment.Status == "Upcoming")
    {
        TempData["Error"] = "Ujian belum dibuka. Silakan kembali setelah waktu ujian dimulai.";
        return RedirectToAction("Assessment");
    }
    ```

    The Indonesian message ("Ujian belum dibuka. Silakan kembali setelah waktu ujian dimulai.") is intentional — per Claude's discretion for the error message wording.

    This guard fires when:
    1. The auto-transition condition was FALSE (Schedule > nowWib), so assessment.Status is still "Upcoming"
    2. A worker navigates directly to the StartExam URL before the scheduled time

    This gate must also apply to HC/Admin roles IF they are the exam taker (assessment.UserId == user.Id). HC/Admin users who are NOT the exam taker are already allowed past the authorization check above. Do NOT add a role bypass here — the time gate applies to anyone trying to take a future-scheduled exam.

    Do not change any other part of the StartExam method.
  </action>
  <verify>
    Read the StartExam method in CMPController.cs and confirm:
    1. The time gate block appears immediately after the auto-transition SaveChangesAsync block
    2. The time gate block appears before the `if (assessment.Status == "Completed")` check
    3. The condition is `assessment.Status == "Upcoming"` (not a date comparison — status reflects post-transition state)
    4. `dotnet build` exits 0
  </verify>
  <done>
    StartExam has a time gate block after the auto-transition block. Workers navigating to a future-scheduled exam URL are redirected to the Assessment page with an error message. Build succeeds.
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. Run `dotnet build` — must exit 0 with no errors.
2. Grep CMPController.cs for `UtcNow.Date` — the three auto-transition sites must not use date-truncation comparison. (Other uses of `UtcNow.Date` unrelated to auto-transition are acceptable.)
3. Grep CMPController.cs for `AddHours(7)` — must appear at the three comparison sites.
4. Read the StartExam method and confirm the time gate block (status == "Upcoming" redirect) exists between the auto-transition block and the Completed check.
5. Grep for `Ujian belum dibuka` — must appear exactly once.
</verification>

<success_criteria>
- Three auto-transition sites use `Schedule <= DateTime.UtcNow.AddHours(7)` (WIB time-based comparison)
- StartExam blocks Upcoming assessments with a redirect+error message after the auto-transition check
- Build succeeds with no compilation errors
- No date-truncation (`.Date`) used in any of the three auto-transition comparisons
</success_criteria>

<output>
After completion, create `.planning/phases/29-auto-transition-upcoming-to-open/29-02-SUMMARY.md`
</output>
