---
phase: 29-auto-transition-upcoming-to-open
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - Views/CMP/CreateAssessment.cshtml
  - Views/CMP/EditAssessment.cshtml
  - Views/CMP/Assessment.cshtml
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "HC sees a time input next to the date input on the Create Assessment form, and can set an opening time (defaulting to 08:00)"
    - "HC sees a time input next to the date input on the Edit Assessment form, pre-populated with the assessment's stored time"
    - "A worker viewing an Upcoming assessment sees the opening date AND time displayed, e.g. 'Opens 22 Feb 2026, 08:00 WIB'"
    - "The time picker submits its value as part of the Schedule DateTime (not a separate field) so existing controller POST logic needs no change"
  artifacts:
    - path: "Views/CMP/CreateAssessment.cshtml"
      provides: "Schedule time input alongside the date input"
      contains: "ScheduleTime"
    - path: "Views/CMP/EditAssessment.cshtml"
      provides: "Schedule time input alongside the date input, pre-populated from model"
      contains: "ScheduleTime"
    - path: "Views/CMP/Assessment.cshtml"
      provides: "Opens [date], [time] WIB label for Upcoming assessments"
      contains: "WIB"
  key_links:
    - from: "CreateAssessment.cshtml time input"
      to: "CMPController CreateAssessment POST"
      via: "JavaScript: combine date + time into Schedule hidden input before form submit"
      pattern: "ScheduleTime"
    - from: "EditAssessment.cshtml time input"
      to: "CMPController EditAssessment POST"
      via: "JavaScript: combine date + time into Schedule hidden input before form submit"
      pattern: "ScheduleTime"
    - from: "Assessment.cshtml Upcoming card"
      to: "item.Schedule"
      via: "Razor: item.Schedule.ToString(\"HH:mm\") + \" WIB\""
      pattern: "WIB"
---

<objective>
Add a time picker to the Create and Edit Assessment forms so HC can set the exact opening time per assessment, and update the worker assessment list to display "Opens DD MMM YYYY, HH:mm WIB" for Upcoming assessments.

Purpose: The backend time-based comparison (Plan 02) requires a time component in the stored Schedule DateTime. Without a time input, Schedule is always midnight (00:00), making the time-based comparison functionally identical to the old date-only comparison.

Output: CreateAssessment.cshtml and EditAssessment.cshtml each gain a Schedule Time input alongside the existing date input. Assessment.cshtml displays the scheduled time for Upcoming assessments. The controller POST endpoints need NO changes — the time is merged into the Schedule hidden field via JavaScript before submit.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Views/CMP/CreateAssessment.cshtml
@Views/CMP/EditAssessment.cshtml
@Views/CMP/Assessment.cshtml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add time picker to CreateAssessment and EditAssessment forms</name>
  <files>Views/CMP/CreateAssessment.cshtml, Views/CMP/EditAssessment.cshtml</files>
  <action>
    **Strategy:** The existing `asp-for="Schedule"` inputs bind to `AssessmentSession.Schedule` (a `DateTime`). An `input type="date"` only captures the date portion; we need a separate `input type="time"` that HC uses to set the opening time. Before form submit, JavaScript combines date + time into the `Schedule` hidden field value (ISO format: `YYYY-MM-DDTHH:mm:ss`) so the model binder receives a full DateTime.

    **CreateAssessment.cshtml changes:**

    Find the Schedule section (around line 160-167):
    ```html
    <!-- Schedule -->
    <div class="col-md-6 mb-3">
        <label asp-for="Schedule" class="form-label fw-semibold">
            Schedule Date <span class="text-danger">*</span>
        </label>
        <input asp-for="Schedule" type="date" class="form-control" required />
        <span asp-validation-for="Schedule" class="text-danger"></span>
    </div>
    ```

    Replace this entire `<div class="col-md-6 mb-3">` block with:
    ```html
    <!-- Schedule -->
    <div class="col-md-6 mb-3">
        <label class="form-label fw-semibold">
            Schedule Date &amp; Time <span class="text-danger">*</span>
        </label>
        <div class="d-flex gap-2 align-items-start">
            <div class="flex-grow-1">
                <input type="date" id="ScheduleDate" class="form-control" required />
                <div class="form-text text-muted">Date (WIB)</div>
            </div>
            <div style="width:130px">
                <input type="time" id="ScheduleTime" class="form-control" value="08:00" required />
                <div class="form-text text-muted">Time (WIB)</div>
            </div>
        </div>
        <input asp-for="Schedule" type="hidden" id="ScheduleHidden" />
        <span asp-validation-for="Schedule" class="text-danger"></span>
    </div>
    ```

    Key points:
    - `ScheduleDate` is a plain `input type="date"` (not `asp-for`) so it does not pre-populate with a DateTime ISO string that includes time, which would break the date input.
    - `ScheduleTime` defaults to `08:00`.
    - `ScheduleHidden` is the actual `asp-for="Schedule"` field — hidden, populated by JS before submit.
    - Both date and time fields are marked `required` so browser validation fires before JS runs.

    In the existing `<script>` section of CreateAssessment.cshtml, find the form submit handler (the section that already validates required fields and calls `console.error` on validation failures). Within that submit handler, before the `form.submit()` call, add the following JavaScript to combine date + time:

    ```javascript
    // Combine ScheduleDate + ScheduleTime into Schedule hidden field
    var schedDateInput = document.getElementById('ScheduleDate');
    var schedTimeInput = document.getElementById('ScheduleTime');
    var schedHidden   = document.getElementById('ScheduleHidden');
    if (schedDateInput && schedDateInput.value && schedTimeInput && schedHidden) {
        schedHidden.value = schedDateInput.value + 'T' + (schedTimeInput.value || '08:00') + ':00';
    }
    ```

    Also update the existing schedule validation block in the submit handler. The current code checks `scheduleField` (which was `input[name="Schedule"]`). With the new structure, `ScheduleHidden` has `name="Schedule"` via `asp-for`, but its value is set by JS just before submit. Change the pre-submit validation to check `ScheduleDate` (not `ScheduleHidden`):

    Find the block that checks schedule is empty (currently something like `if (!scheduleField || !scheduleField.value)`). Update the variable reference from `scheduleField` to `schedDateInput`. The check should become: if `schedDateInput.value` is empty, show the alert and abort.

    **EditAssessment.cshtml changes:**

    Find the Schedule section (around line 131-137):
    ```html
    <label asp-for="Schedule" class="form-label fw-semibold">
        Schedule Date <span class="text-danger">*</span>
    </label>
    <input asp-for="Schedule" type="date" class="form-control" required />
    <span asp-validation-for="Schedule" class="text-danger"></span>
    ```

    Replace the label + input + span (within their existing `<div class="col-md-6">`) with:
    ```html
    <label class="form-label fw-semibold">
        Schedule Date &amp; Time <span class="text-danger">*</span>
    </label>
    <div class="d-flex gap-2 align-items-start">
        <div class="flex-grow-1">
            <input type="date" id="ScheduleDate"
                   value="@Model.Schedule.ToString("yyyy-MM-dd")"
                   class="form-control" required />
            <div class="form-text text-muted">Date (WIB)</div>
        </div>
        <div style="width:130px">
            <input type="time" id="ScheduleTime"
                   value="@Model.Schedule.ToString("HH:mm")"
                   class="form-control" required />
            <div class="form-text text-muted">Time (WIB)</div>
        </div>
    </div>
    <input asp-for="Schedule" type="hidden" id="ScheduleHidden"
           value="@Model.Schedule.ToString("yyyy-MM-ddTHH:mm:ss")" />
    <span asp-validation-for="Schedule" class="text-danger"></span>
    ```

    Key points:
    - `ScheduleDate` is pre-populated with `@Model.Schedule.ToString("yyyy-MM-dd")`.
    - `ScheduleTime` is pre-populated with `@Model.Schedule.ToString("HH:mm")`.
    - `ScheduleHidden` (the `asp-for` binding) is pre-populated with full ISO string.
    - If an existing assessment was created before this change (stored with time 00:00), the time input will show `00:00`. HC will need to set the correct time when editing.

    In the existing `<script>` section of EditAssessment.cshtml, find the form submit handler. Before the `form.submit()` or the submit call, add the date+time combination:

    ```javascript
    // Combine ScheduleDate + ScheduleTime into Schedule hidden field
    var schedDateInput = document.getElementById('ScheduleDate');
    var schedTimeInput = document.getElementById('ScheduleTime');
    var schedHidden   = document.getElementById('ScheduleHidden');
    if (schedDateInput && schedDateInput.value && schedTimeInput && schedHidden) {
        schedHidden.value = schedDateInput.value + 'T' + (schedTimeInput.value || '08:00') + ':00';
    }
    ```

    Also update the `originalSchedule` comparison in EditAssessment.cshtml's script. Currently it compares the date-only string. It now needs to compare the date portion of the new ScheduleDate input instead. Find the block:
    ```javascript
    var scheduleInput = document.getElementById('Schedule');
    ...
    var newSchedule = scheduleInput.value;
    if (newSchedule !== originalSchedule) { ... }
    ```
    Update `scheduleInput` to reference `document.getElementById('ScheduleDate')` instead of `'Schedule'`. The warning about package re-assignment should still fire when the date changes (time change alone does not require the warning).
  </action>
  <verify>
    1. Open CreateAssessment page — two inputs visible side-by-side: a date input and a time input defaulting to 08:00.
    2. Open EditAssessment page — date and time inputs pre-populated from the stored assessment schedule.
    3. `dotnet build` exits 0.
    4. Read CreateAssessment.cshtml — `ScheduleHidden` with `asp-for="Schedule"` is present. `ScheduleDate` and `ScheduleTime` plain inputs are present. JS combine block is present in the submit handler.
    5. Read EditAssessment.cshtml — same structure confirmed.
  </verify>
  <done>
    CreateAssessment and EditAssessment forms each have a date+time picker pair. The hidden `asp-for="Schedule"` field is populated by JS before submit so the controller receives the full WIB DateTime. Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Upcoming assessment display to show opening time in worker list</name>
  <files>Views/CMP/Assessment.cshtml</files>
  <action>
    In Assessment.cshtml, find the section that displays the date for each assessment card (around line 437-441):
    ```html
    <!-- Date -->
    <div class="meta-item">
        <i class="bi bi-calendar3"></i>
        <span>@item.Schedule.ToString("dd MMM yyyy")</span>
    </div>
    ```

    Update the span to show time for Upcoming assessments:
    ```html
    <!-- Date -->
    <div class="meta-item">
        <i class="bi bi-calendar3"></i>
        @if (item.Status == "Upcoming")
        {
            <span>Opens @item.Schedule.ToString("dd MMM yyyy"), @item.Schedule.ToString("HH:mm") WIB</span>
        }
        else
        {
            <span>@item.Schedule.ToString("dd MMM yyyy")</span>
        }
    </div>
    ```

    Also update the disabled button for Upcoming assessments (around line 509-511). Currently:
    ```html
    <button class="btn btn-outline-secondary w-100" disabled>
        <i class="bi bi-lock-fill me-1"></i>@(((item.Schedule - DateTime.Now).Days > 0) ? $"Available in {(item.Schedule - DateTime.Now).Days} day{((item.Schedule - DateTime.Now).Days != 1 ? "s" : "")}" : "Coming soon")
    </button>
    ```

    The existing "Available in N days / Coming soon" logic is based on `.Days` which is date-level. Now that we have time precision, replace with a simpler message that is always accurate:
    ```html
    <button class="btn btn-outline-secondary w-100" disabled>
        <i class="bi bi-lock-fill me-1"></i>Opens @item.Schedule.ToString("dd MMM yyyy"), @item.Schedule.ToString("HH:mm") WIB
    </button>
    ```

    This removes the ".Days" arithmetic (which could show "Available in 0 days" when same day but not yet time) and always shows the exact opening datetime, consistent with the meta-item display above.

    Do not change any other part of Assessment.cshtml.
  </action>
  <verify>
    1. Read Assessment.cshtml — `WIB` appears in the Upcoming assessment card (both in meta-item and in the disabled button).
    2. Read Assessment.cshtml — the old `.Days` day-countdown logic is removed from the Upcoming button.
    3. `dotnet build` exits 0.
  </verify>
  <done>
    Worker assessment list shows "Opens DD MMM YYYY, HH:mm WIB" for Upcoming assessments in both the date meta-item and the disabled action button. Build succeeds.
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `dotnet build` exits 0 with no errors.
2. Grep Assessment.cshtml for `WIB` — must appear in the Upcoming card sections.
3. Grep CreateAssessment.cshtml for `ScheduleTime` — must appear (the time input id).
4. Grep EditAssessment.cshtml for `ScheduleTime` — must appear.
5. Grep CreateAssessment.cshtml for `ScheduleHidden` — must appear (the hidden asp-for binding).
6. Grep EditAssessment.cshtml for `ScheduleHidden` — must appear.
7. Grep Assessment.cshtml for `Available in` — must NOT appear (old day-countdown logic removed).
</verification>

<success_criteria>
- CreateAssessment form has both a date input and a time input (defaulting 08:00); JS merges them into the hidden Schedule field before submit
- EditAssessment form has both inputs pre-populated from stored schedule; JS merges on submit
- Worker assessment list shows "Opens DD MMM YYYY, HH:mm WIB" for Upcoming items in both the date meta-item and the disabled action button
- No regressions: Open and Completed assessment cards are unchanged
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/29-auto-transition-upcoming-to-open/29-03-SUMMARY.md`
</output>
