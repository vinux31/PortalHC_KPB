---
phase: 30-import-deduplication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Controllers/CMPController.cs
autonomous: true

must_haves:
  truths:
    - "HC imports 10 questions where 3 already exist in the package — exactly 7 are added and the success banner reads '7 added, 3 skipped.' (or 'Imported from file: 7 added, 3 skipped.' for Excel)"
    - "HC pastes a duplicate row — it is silently skipped with no error entry, and only new questions are saved"
    - "A package with zero prior questions accepts all imported rows with no skips reported"
    - "HC imports a file where ALL rows are duplicates — stays on the import page with a yellow warning: 'All questions were already in the package. Nothing was added.' (no redirect to ManagePackages)"
    - "HC submits malformed data with 0 valid rows — stays on the import page with a DISTINCT yellow warning ('No valid questions found in the import. Check the format and try again.') — different text from the all-duplicates message"
    - "If HC's import file contains two identical rows, only one is saved — both count toward the skip tally (self-deduplication)"
  artifacts:
    - path: "Controllers/CMPController.cs"
      provides: "NormalizeText + MakeFingerprint private static helpers, ThenInclude(q => q.Options) on POST query, HashSet fingerprint build, int skipped counter, fingerprint check in validation loop, 3-branch TempData/redirect block"
      contains: "NormalizeText"
  key_links:
    - from: "ImportPackageQuestions POST"
      to: "pkg.Questions[*].Options"
      via: "ThenInclude(q => q.Options) in the EF query"
      pattern: "ThenInclude\\(q => q\\.Options\\)"
    - from: "Import loop (per-row)"
      to: "existingFingerprints / seenInBatch"
      via: "MakeFingerprint check before SaveChangesAsync"
      pattern: "existingFingerprints\\.Contains\\(fp\\)"
    - from: "Post-loop TempData block"
      to: "RedirectToAction(ImportPackageQuestions)"
      via: "added == 0 branch (all-duplicates or 0-valid)"
      pattern: "added == 0 && skipped"
---

<objective>
Add fingerprint-based deduplication to the ImportPackageQuestions POST action in CMPController so that rows already present in the target package (and duplicate rows within the import file itself) are silently skipped, and the result banner accurately reports how many were added versus skipped.

Purpose: Prevent HC from accidentally bloating a package with repeated questions when re-importing or importing from a shared question bank.
Output: Modified CMPController.cs — 2 private static helpers + ~25 lines of logic changes in ImportPackageQuestions POST.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-import-deduplication/30-CONTEXT.md
@.planning/phases/30-import-deduplication/30-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add NormalizeText and MakeFingerprint helpers to CMPController</name>
  <files>Controllers/CMPController.cs</files>
  <action>
Locate the private static helper region near `ExtractCorrectLetter` (around line 2369) and add two new private static methods immediately after it (or nearby, keeping helpers grouped):

```csharp
private static string NormalizeText(string s)
    => System.Text.RegularExpressions.Regex.Replace(s.Trim(), @"\s+", " ").ToLowerInvariant();

private static string MakeFingerprint(string q, string a, string b, string c, string d)
    => string.Join("|||", new[] { q, a, b, c, d }.Select(NormalizeText));
```

Rules:
- Do NOT strip punctuation — only trim + collapse internal whitespace + toLowerInvariant (per locked decision and research pitfall 6).
- The "|||" separator must be used to prevent "AB"+"CD" matching "A"+"BCD".
- Both methods are `private static` — no instance dependencies.
  </action>
  <verify>Build succeeds: `dotnet build` in the project directory with no errors. Grep confirms both methods exist: `grep -n "NormalizeText\|MakeFingerprint" Controllers/CMPController.cs`</verify>
  <done>CMPController.cs compiles and both `NormalizeText` and `MakeFingerprint` are present as private static methods.</done>
</task>

<task type="auto">
  <name>Task 2: Add deduplication logic to ImportPackageQuestions POST</name>
  <files>Controllers/CMPController.cs</files>
  <action>
Find the `ImportPackageQuestions` POST action (around line 3257). Make the following four changes in order:

**Change A — Upgrade the EF Include query to load Options:**

Find the single POST query that loads the package (currently `.Include(p => p.Questions)` with no ThenInclude). Change it to:

```csharp
var pkg = await _context.AssessmentPackages
    .Include(p => p.Questions)
        .ThenInclude(q => q.Options)
    .FirstOrDefaultAsync(p => p.Id == packageId);
```

Important: This is the POST query only. The GET query (for the preview/display action) may already have ThenInclude — do not change it.

**Change B — Build the existing-fingerprint HashSet after pkg is loaded:**

After the `if (pkg == null) return NotFound();` guard and before the row-parsing loop, add:

```csharp
var existingFingerprints = pkg.Questions.Select(q =>
{
    var opts = q.Options.OrderBy(o => o.Id).Select(o => o.OptionText).ToList();
    return MakeFingerprint(
        q.QuestionText,
        opts.ElementAtOrDefault(0) ?? "",
        opts.ElementAtOrDefault(1) ?? "",
        opts.ElementAtOrDefault(2) ?? "",
        opts.ElementAtOrDefault(3) ?? "");
}).ToHashSet();
var seenInBatch = new HashSet<string>();
```

Also add `int skipped = 0;` alongside the existing `int added = 0;` declaration.

Options MUST be sorted by `o.Id` ascending (not alphabetically) — auto-increment Id guarantees A→B→C→D insertion order. Do not sort by OptionText.

**Change C — Insert fingerprint check inside the validation loop:**

Inside the per-row validation block, after all format checks have passed (after the `!new[] { "A","B","C","D" }.Contains(normalizedCor)` check or equivalent — the last validation gate before `SaveChangesAsync`), insert:

```csharp
var fp = MakeFingerprint(q, a, b, c, d);
if (existingFingerprints.Contains(fp) || seenInBatch.Contains(fp))
{
    skipped++;
    continue;
}
seenInBatch.Add(fp);
```

Where `q` is the normalized question text and `a`/`b`/`c`/`d` are the four option texts from the current row. Use whichever variable names the existing code uses for those values — do not rename them.

Critical: `skipped++` and `continue` — do NOT add to the `errors` list. Duplicates are silently skipped (per locked decision: "detail level: count only, no list").

**Change D — Replace the post-loop TempData/redirect block:**

Find the existing TempData block that sets success/warning message and redirects (approximately lines 3385-3391). Replace it entirely with the following 3-branch logic:

```csharp
// 0-valid-rows: something submitted but nothing parseable
if (added == 0 && skipped == 0)
{
    TempData["Warning"] = "No valid questions found in the import. Check the format and try again.";
    return RedirectToAction("ImportPackageQuestions", new { packageId });
}

// All-duplicates: every parseable row was already in the package
if (added == 0 && skipped > 0)
{
    TempData["Warning"] = "All questions were already in the package. Nothing was added.";
    return RedirectToAction("ImportPackageQuestions", new { packageId });
}

// Normal success: at least 1 row was added
if (excelFile != null && excelFile.Length > 0)
    TempData["Success"] = $"Imported from file: {added} added, {skipped} skipped.";
else
    TempData["Success"] = $"{added} added, {skipped} skipped.";

return RedirectToAction("ManagePackages", new { assessmentId = pkg.AssessmentSessionId });
```

The variable names `excelFile`, `added`, `skipped`, `packageId`, and `pkg.AssessmentSessionId` must match the existing action's local variable names exactly. Adjust if the codebase uses different names.

Note on existing errors block: The pre-existing code may have an `if (errors.Any())` block that set `TempData["Warning"]` with a list of row errors. That block is subsumed by the new 3-branch logic — the "0 valid rows" case covers the all-format-errors scenario. Remove the old `errors.Any()` warning block if it now conflicts, or confirm that `added == 0 && skipped == 0` correctly fires when all rows fail format validation (errors.Any() but added==0 and skipped==0).
  </action>
  <verify>
1. `dotnet build` succeeds with no errors or warnings about the changed code.
2. Manual smoke test (if dev server is running): Navigate to a package's import page and import a file with mix of new and duplicate questions — confirm the success banner shows "X added, Y skipped."
3. Grep confirms ThenInclude is present in the POST action region: `grep -n "ThenInclude" Controllers/CMPController.cs`
4. Grep confirms the all-duplicates branch exists: `grep -n "All questions were already" Controllers/CMPController.cs`
5. Grep confirms the 0-valid-rows branch exists: `grep -n "No valid questions found" Controllers/CMPController.cs`
  </verify>
  <done>
- `dotnet build` passes.
- The POST query loads Options via ThenInclude.
- HashSet fingerprint dedup runs for both package-scope and in-batch duplicates.
- Success banner: "X added, Y skipped." (paste) or "Imported from file: X added, Y skipped." (Excel) — green, always shown when at least 1 added.
- All-duplicates path: stays on import page, yellow warning "All questions were already in the package. Nothing was added."
- 0-valid-rows path: stays on import page, distinct yellow warning "No valid questions found in the import. Check the format and try again."
- A fresh package with no prior questions: all rows accepted, skipped == 0, banner shows "X added, 0 skipped."
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. `dotnet build` passes with zero errors.
2. `grep -n "NormalizeText\|MakeFingerprint\|ThenInclude\|existingFingerprints\|seenInBatch\|skipped" Controllers/CMPController.cs` shows all six patterns present.
3. `grep -n "All questions were already\|No valid questions found" Controllers/CMPController.cs` confirms both edge-case messages are present.
4. Logical review: the `added == 0 && skipped == 0` branch appears BEFORE the `added == 0 && skipped > 0` branch in source order (prevents the wrong message firing).
5. Options sorted by `o.Id` ascending confirmed in the fingerprint build block.
</verification>

<success_criteria>
Phase 30 is complete when:
- HC can import an Excel file with 10 questions (3 duplicates of existing package questions) and get exactly 7 added with the banner "Imported from file: 7 added, 3 skipped."
- HC can paste question text with 1 duplicate and get the remaining new questions saved silently — no error banner, no duplicate saved.
- A package with zero prior questions accepts a 5-question import with "5 added, 0 skipped."
- Importing a file where all rows match existing package questions stays on the import page with yellow warning "All questions were already in the package. Nothing was added."
- Submitting malformed data (all rows fail format validation) stays on the import page with "No valid questions found in the import. Check the format and try again." — not the all-duplicates message.
- Two identical rows in the same import file: only one saved, both count in the skipped tally.
</success_criteria>

<output>
After completion, create `.planning/phases/30-import-deduplication/30-01-SUMMARY.md` following the summary template at `@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md`.
</output>
