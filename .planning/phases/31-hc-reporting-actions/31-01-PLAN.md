---
phase: 31-hc-reporting-actions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Controllers/CMPController.cs
  - Views/CMP/AssessmentMonitoringDetail.cshtml
autonomous: true

must_haves:
  truths:
    - "HC clicks Export Results on the monitoring detail page and an .xlsx file downloads immediately"
    - "The exported file contains one row per worker in the assessment group, including workers who have not started"
    - "Not-started workers appear in the export with blank Score and Status = 'Not Started'"
    - "Completed workers appear with their Score, Pass/Fail, and CompletedAt timestamp"
    - "The exported file includes a Package column (blank/dash for non-package assessments)"
  artifacts:
    - path: "Controllers/CMPController.cs"
      provides: "ExportAssessmentResults GET action"
      contains: "ExportAssessmentResults"
    - path: "Views/CMP/AssessmentMonitoringDetail.cshtml"
      provides: "Export Results button in card header"
      contains: "ExportAssessmentResults"
  key_links:
    - from: "Views/CMP/AssessmentMonitoringDetail.cshtml"
      to: "Controllers/CMPController.cs ExportAssessmentResults"
      via: "form GET asp-action=ExportAssessmentResults with title/category/scheduleDate inputs"
      pattern: "ExportAssessmentResults"
    - from: "Controllers/CMPController.cs ExportAssessmentResults"
      to: "AssessmentSessions Include User"
      via: "EF query by Title + Category + Schedule.Date with no status filter"
      pattern: "Schedule\\.Date == scheduleDate\\.Date"
    - from: "Controllers/CMPController.cs ExportAssessmentResults"
      to: "UserPackageAssignments join AssessmentPackages"
      via: "same assignmentMap pattern as AssessmentMonitoringDetail"
      pattern: "packageNameMap"
---

<objective>
Add ExportAssessmentResults GET action to CMPController and Export Results button to AssessmentMonitoringDetail.cshtml, enabling HC to download a complete Excel roster of all workers assigned to an assessment including those who have not started.

Purpose: HC needs a downloadable record of assessment results for all assigned workers — including incomplete/not-started ones — for reporting and record-keeping.
Output: New GET action returns .xlsx file; new button in monitoring detail card header triggers the download.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Controllers/CMPController.cs
@Views/CMP/AssessmentMonitoringDetail.cshtml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ExportAssessmentResults action to CMPController.cs</name>
  <files>Controllers/CMPController.cs</files>
  <action>
Insert a new action immediately after the closing brace of `ForceCloseAssessment` (line 597) and before the `// --- RESHUFFLE PACKAGE (single worker) ---` comment (line 599). Insert exactly this block:

```csharp
        // --- EXPORT ASSESSMENT RESULTS ---
        [HttpGet]
        [Authorize(Roles = "Admin, HC")]
        public async Task<IActionResult> ExportAssessmentResults(string title, string category, DateTime scheduleDate)
        {
            // Query all sessions in this group (all workers assigned, regardless of completion status)
            var sessions = await _context.AssessmentSessions
                .Include(a => a.User)
                .Where(a => a.Title == title
                         && a.Category == category
                         && a.Schedule.Date == scheduleDate.Date)
                .ToListAsync();

            if (!sessions.Any())
            {
                TempData["Error"] = "No sessions found for this assessment group.";
                return RedirectToAction("Assessment", new { view = "manage" });
            }

            // Detect package mode and load package assignments (same pattern as AssessmentMonitoringDetail)
            var siblingIds = sessions.Select(s => s.Id).ToList();
            var packageCount = await _context.AssessmentPackages
                .CountAsync(p => siblingIds.Contains(p.AssessmentSessionId));
            var isPackageMode = packageCount > 0;

            Dictionary<int, string> packageNameMap = new();
            if (isPackageMode)
            {
                packageNameMap = await _context.UserPackageAssignments
                    .Where(a => siblingIds.Contains(a.AssessmentSessionId))
                    .Join(_context.AssessmentPackages,
                        a => a.AssessmentPackageId,
                        p => p.Id,
                        (a, p) => new { a.AssessmentSessionId, p.PackageName })
                    .ToDictionaryAsync(
                        x => x.AssessmentSessionId,
                        x => x.PackageName);
            }

            // Build row data: one row per session, include all statuses
            var rows = sessions.Select(a =>
            {
                string userStatus;
                if (a.CompletedAt != null || a.Score != null)
                    userStatus = "Completed";
                else if (a.Status == "Abandoned")
                    userStatus = "Abandoned";
                else if (a.StartedAt != null)
                    userStatus = "In Progress";
                else
                    userStatus = "Not Started";

                string resultText = a.IsPassed == true ? "Pass"
                                  : a.IsPassed == false ? "Fail"
                                  : "—";

                return new
                {
                    UserFullName = a.User?.FullName ?? "Unknown",
                    UserNIP      = a.User?.NIP ?? "",
                    PackageName  = isPackageMode
                                    ? (packageNameMap.ContainsKey(a.Id) ? packageNameMap[a.Id] : "—")
                                    : "—",
                    UserStatus   = userStatus,
                    Score        = a.Score.HasValue ? (object)a.Score.Value : "—",
                    Result       = resultText,
                    CompletedAt  = a.CompletedAt.HasValue
                                    ? a.CompletedAt.Value.ToString("yyyy-MM-dd HH:mm")
                                    : ""
                };
            })
            .OrderBy(r => r.UserStatus)
            .ThenBy(r => r.UserFullName)
            .ToList();

            // Generate workbook (ClosedXML — same pattern as CDPController.ExportAnalyticsResults)
            using var workbook = new XLWorkbook();
            var worksheet = workbook.Worksheets.Add("Results");

            // Header row
            int col = 1;
            worksheet.Cell(1, col++).Value = "Name";
            worksheet.Cell(1, col++).Value = "NIP";
            if (isPackageMode) worksheet.Cell(1, col++).Value = "Package";
            worksheet.Cell(1, col++).Value = "Status";
            worksheet.Cell(1, col++).Value = "Score";
            worksheet.Cell(1, col++).Value = "Result";
            worksheet.Cell(1, col).Value   = "Completed At";

            int totalCols = isPackageMode ? 7 : 6;
            var headerRange = worksheet.Range(1, 1, 1, totalCols);
            headerRange.Style.Font.Bold = true;
            headerRange.Style.Fill.BackgroundColor = XLColor.LightBlue;

            // Data rows
            for (int i = 0; i < rows.Count; i++)
            {
                var r = rows[i];
                var row = i + 2;
                int c = 1;
                worksheet.Cell(row, c++).Value = r.UserFullName;
                worksheet.Cell(row, c++).Value = r.UserNIP;
                if (isPackageMode) worksheet.Cell(row, c++).Value = r.PackageName;
                worksheet.Cell(row, c++).Value = r.UserStatus;
                worksheet.Cell(row, c++).Value = r.Score?.ToString() ?? "—";
                worksheet.Cell(row, c++).Value = r.Result;
                worksheet.Cell(row, c).Value   = r.CompletedAt;
            }

            worksheet.Columns().AdjustToContents();

            using var stream = new MemoryStream();
            workbook.SaveAs(stream);
            var content = stream.ToArray();
            // Sanitize title for filename: replace non-alphanumeric with _
            var safeTitle = System.Text.RegularExpressions.Regex.Replace(title, @"[^\w]", "_");
            var fileName = $"{safeTitle}_{scheduleDate:yyyyMMdd}_Results.xlsx";
            return File(content, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", fileName);
        }
```

Notes:
- Inserted between `ForceCloseAssessment` closing brace (line 597) and `// --- RESHUFFLE PACKAGE` comment (line 599). Keep exactly one blank line before and after.
- `ClosedXML` using is already at the top of the file (line 7: `using ClosedXML.Excel;`). Do NOT add a duplicate using.
- Score cell: write int directly when score is non-null; write string "—" when null. Use `worksheet.Cell(row, c++).Value = r.Score?.ToString() ?? "—"` — this keeps it simple and avoids XLCellValue type conflicts.
- The `isPackageMode` conditional on column count: non-package export has 6 columns (no Package col), package-mode has 7.
  </action>
  <verify>
Build the project: `dotnet build "C:/Users/rinoa/Desktop/PortalHC_KPB/HcPortal.csproj" --no-restore 2>&1 | tail -20`

Check for zero build errors. The action must compile cleanly — pay attention to:
- XLCellValue assignment for Score (may need `.ToString()` to avoid ambiguous overload)
- `col` variable used for header but shadowed for data rows by `c` — ensure both increment correctly
  </verify>
  <done>dotnet build exits with 0 errors. ExportAssessmentResults action exists in CMPController.cs and compiles.</done>
</task>

<task type="auto">
  <name>Task 2: Add Export Results button to AssessmentMonitoringDetail.cshtml</name>
  <files>Views/CMP/AssessmentMonitoringDetail.cshtml</files>
  <action>
In `AssessmentMonitoringDetail.cshtml`, locate the card header div (around line 103-113):

```html
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-semibold">
                <i class="bi bi-people me-2 text-primary"></i>Per-User Status
            </h5>
            @if (Model.IsPackageMode && Model.PendingCount > 0)
            {
                <button type="button" class="btn btn-outline-primary btn-sm"
                        onclick="reshuffleAll(event)">
                    <i class="bi bi-shuffle me-1"></i>Reshuffle All (@Model.PendingCount pending)
                </button>
            }
        </div>
```

Replace the entire card-header div with this updated version that adds an Export Results button and makes the header right side a flex gap:

```html
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-semibold">
                <i class="bi bi-people me-2 text-primary"></i>Per-User Status
            </h5>
            <div class="d-flex gap-2 align-items-center">
                <!-- Export Results: GET download, no antiforgery needed -->
                <form asp-action="ExportAssessmentResults" method="get" class="d-inline">
                    <input type="hidden" name="title" value="@Model.Title" />
                    <input type="hidden" name="category" value="@Model.Category" />
                    <input type="hidden" name="scheduleDate" value="@Model.Schedule.ToString("yyyy-MM-dd")" />
                    <button type="submit" class="btn btn-outline-success btn-sm">
                        <i class="bi bi-download me-1"></i>Export Results
                    </button>
                </form>
                @if (Model.IsPackageMode && Model.PendingCount > 0)
                {
                    <button type="button" class="btn btn-outline-primary btn-sm"
                            onclick="reshuffleAll(event)">
                        <i class="bi bi-shuffle me-1"></i>Reshuffle All (@Model.PendingCount pending)
                    </button>
                }
            </div>
        </div>
```

Key points:
- The Export Results form uses `method="get"` — this is correct for file downloads and matches the CDPController.ExportAnalyticsResults pattern. No antiforgery token needed.
- `btn-outline-success` to distinguish from the blue Reshuffle All button.
- The Reshuffle All button is now inside the `d-flex gap-2` div alongside Export Results.
- `scheduleDate` format `yyyy-MM-dd` matches what AssessmentMonitoringDetail GET action parses via DateTime model binding.
  </action>
  <verify>
1. Build succeeds: `dotnet build "C:/Users/rinoa/Desktop/PortalHC_KPB/HcPortal.csproj" --no-restore 2>&1 | tail -10`
2. Confirm the view file contains `ExportAssessmentResults` form.
3. Confirm `d-flex gap-2` wrapper div exists in the card-header.
  </verify>
  <done>Build passes. AssessmentMonitoringDetail.cshtml card-header contains both the Export Results form (GET) and the existing Reshuffle All button inside a d-flex gap-2 container.</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `dotnet build` exits with 0 errors and 0 warnings related to new code.
2. Open the monitoring detail page for any assessment — the "Export Results" button appears in the card header.
3. Click Export Results — browser downloads an .xlsx file named `{Title}_{yyyyMMdd}_Results.xlsx`.
4. Open the .xlsx — verify it has a header row (Name, NIP, [Package if applicable], Status, Score, Result, Completed At) and one data row per worker.
5. Workers who have not started appear with Status="Not Started", Score="—", Result="—", CompletedAt="".
6. Total row count in exported file equals TotalCount displayed in the monitoring summary card.
</verification>

<success_criteria>
- ExportAssessmentResults GET action exists in CMPController.cs and compiles cleanly
- Export Results button renders in AssessmentMonitoringDetail.cshtml card header
- Clicking Export Results triggers a file download (no page navigation)
- Downloaded file contains all workers assigned to the assessment, not just completed ones
- File includes Package column when isPackageMode=true; column omitted when false
</success_criteria>

<output>
After completion, create `.planning/phases/31-hc-reporting-actions/31-01-SUMMARY.md` with:
- What was built (ExportAssessmentResults action + Export button)
- Files modified with line number ranges for new code
- Pattern used (ClosedXML, same as CDPController.ExportAnalyticsResults)
- Any deviations from plan (e.g., column count adjustments, filename sanitization)
- Verification status
</output>
