---
phase: 31-hc-reporting-actions
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Controllers/CMPController.cs
  - Views/CMP/AssessmentMonitoringDetail.cshtml
autonomous: true

must_haves:
  truths:
    - "HC clicks Force Close All and a confirmation prompt appears before any action is taken"
    - "After confirmation, all sessions with Status Open or InProgress in the assessment group are set to Abandoned"
    - "Sessions with Status Completed, Abandoned, or Upcoming are untouched by ForceCloseAll"
    - "One audit log entry is written in the AuditLog table after the bulk close completes"
    - "The page reloads after Force Close All and reflects the updated session statuses immediately"
    - "If no Open or InProgress sessions exist, TempData Error is set and the page reloads unchanged"
  artifacts:
    - path: "Controllers/CMPController.cs"
      provides: "ForceCloseAll POST action"
      contains: "ForceCloseAll"
    - path: "Views/CMP/AssessmentMonitoringDetail.cshtml"
      provides: "Force Close All button with hidden form POST + confirm()"
      contains: "ForceCloseAll"
  key_links:
    - from: "Views/CMP/AssessmentMonitoringDetail.cshtml"
      to: "Controllers/CMPController.cs ForceCloseAll"
      via: "hidden form POST asp-action=ForceCloseAll with antiforgery token and title/category/scheduleDate inputs"
      pattern: "ForceCloseAll"
    - from: "Controllers/CMPController.cs ForceCloseAll"
      to: "AssessmentSessions filtered by Open or InProgress within Title+Category+Schedule.Date group"
      via: "EF query using same group key as GetMonitorData and AssessmentMonitoringDetail"
      pattern: "Status == \"Open\" || Status == \"InProgress\""
    - from: "Controllers/CMPController.cs ForceCloseAll"
      to: "AuditLogService.LogAsync"
      via: "called after SaveChangesAsync with actor NIP-FullName, action=ForceCloseAll, description includes count"
      pattern: "await _auditLog\\.LogAsync"
---

<objective>
Add ForceCloseAll POST action to CMPController and Force Close All button to AssessmentMonitoringDetail.cshtml, enabling HC to bulk-transition all Open/InProgress sessions in an assessment group to Abandoned in a single confirmed action with a full audit trail.

Purpose: HC needs a way to administratively close an entire assessment batch at once without clicking per-worker Force Close — used when an assessment session period ends and remaining workers cannot or will not complete.
Output: New POST action that bulk-closes sessions and writes one audit log entry; new button with confirmation prompt in the monitoring detail card header.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Controllers/CMPController.cs
@Views/CMP/AssessmentMonitoringDetail.cshtml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ForceCloseAll action to CMPController.cs</name>
  <files>Controllers/CMPController.cs</files>
  <action>
Insert the ForceCloseAll action immediately after the `ExportAssessmentResults` action added in Plan 01 (before `// --- RESHUFFLE PACKAGE (single worker) ---`). If Plan 01 has not yet been executed, insert after the `ForceCloseAssessment` closing brace (line 597). Insert exactly this block:

```csharp
        // --- FORCE CLOSE ALL SESSIONS IN GROUP ---
        [HttpPost]
        [Authorize(Roles = "Admin, HC")]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> ForceCloseAll(string title, string category, DateTime scheduleDate)
        {
            // Find all Open or InProgress sessions in this assessment group
            var sessionsToClose = await _context.AssessmentSessions
                .Where(a => a.Title == title
                         && a.Category == category
                         && a.Schedule.Date == scheduleDate.Date
                         && (a.Status == "Open" || a.Status == "InProgress"))
                .ToListAsync();

            if (!sessionsToClose.Any())
            {
                TempData["Error"] = "No Open or InProgress sessions to close.";
                return RedirectToAction("AssessmentMonitoringDetail", new { title, category, scheduleDate });
            }

            // Bulk-transition to Abandoned (session period ended — no score recorded)
            foreach (var session in sessionsToClose)
            {
                session.Status    = "Abandoned";
                session.UpdatedAt = DateTime.UtcNow;
            }

            await _context.SaveChangesAsync();

            // Audit log — one summary entry for the bulk action (AuditLogService saves immediately)
            var actor = await _userManager.GetUserAsync(User);
            var actorName = $"{actor?.NIP ?? "?"} - {actor?.FullName ?? "Unknown"}";
            await _auditLog.LogAsync(
                actor?.Id ?? "",
                actorName,
                "ForceCloseAll",
                $"Force-closed all Open/InProgress sessions for '{title}' (Category: {category}, Date: {scheduleDate:yyyy-MM-dd}) — {sessionsToClose.Count} session(s) closed",
                null,
                "AssessmentSession");

            TempData["Success"] = $"Berhasil menutup {sessionsToClose.Count} sesi ujian.";
            return RedirectToAction("AssessmentMonitoringDetail", new { title, category, scheduleDate });
        }
```

Critical implementation notes:
- `Status = "Abandoned"` is correct for bulk close — this is a bulk administrative closure that does NOT record a score. Contrast with per-session `ForceCloseAssessment` which sets `Status = "Completed"` with Score=0 (that path is semantically different: forced completion with system score). For ForceCloseAll, sessions are truly abandoned — do NOT set Score, IsPassed, or CompletedAt.
- Group key must match exactly: `a.Title == title && a.Category == category && a.Schedule.Date == scheduleDate.Date` — same as AssessmentMonitoringDetail and GetMonitorData. Using `.Date` property on both sides ensures time-of-day does not affect matching.
- `AuditLogService.LogAsync` is called AFTER `SaveChangesAsync` per the established pattern (Phase 24). It calls SaveChangesAsync internally — the audit row is written immediately.
- `TempData["Success"]` and `TempData["Error"]` keys match the existing patterns in `AssessmentMonitoringDetail.cshtml` (lines 36-49) — the view already renders them.
- The `RedirectToAction` for both success and no-op paths passes `{ title, category, scheduleDate }` — this matches the AssessmentMonitoringDetail GET signature.
  </action>
  <verify>
Build the project: `dotnet build "C:/Users/rinoa/Desktop/PortalHC_KPB/HcPortal.csproj" --no-restore 2>&1 | tail -20`

Check for zero build errors. Verify the action exists: `grep -n "ForceCloseAll" "C:/Users/rinoa/Desktop/PortalHC_KPB/Controllers/CMPController.cs"`
  </verify>
  <done>dotnet build exits with 0 errors. ForceCloseAll POST action exists in CMPController.cs. The action sets Status="Abandoned" and UpdatedAt only (no Score/IsPassed/CompletedAt mutation).</done>
</task>

<task type="auto">
  <name>Task 2: Add Force Close All button to AssessmentMonitoringDetail.cshtml</name>
  <files>Views/CMP/AssessmentMonitoringDetail.cshtml</files>
  <action>
Locate the card-header `d-flex gap-2` container that was created in Plan 01 (contains the Export Results form and optionally the Reshuffle All button). If Plan 01 has NOT been executed yet, the card-header still has the original structure (lines 103-113) — in that case, follow the same approach: replace the card-header with a `d-flex gap-2` container and add the Force Close All form.

Either way, the final card-header must contain three items in the right-side `d-flex gap-2` div:
1. Export Results form (GET) — from Plan 01
2. Force Close All form (POST) — from this plan
3. Reshuffle All button — conditional on IsPackageMode && PendingCount > 0

Add the Force Close All form inside the `d-flex gap-2 align-items-center` div, between the Export Results form and the Reshuffle All button:

```html
                <!-- Force Close All: POST with antiforgery, confirm() guard -->
                <form asp-action="ForceCloseAll" method="post" class="d-inline"
                      onsubmit="return confirm('Tutup paksa semua sesi Open/InProgress? Sesi akan ditandai Abandoned dan tidak dapat dikembalikan.')">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="title" value="@Model.Title" />
                    <input type="hidden" name="category" value="@Model.Category" />
                    <input type="hidden" name="scheduleDate" value="@Model.Schedule.ToString("yyyy-MM-dd")" />
                    <button type="submit" class="btn btn-danger btn-sm">
                        <i class="bi bi-x-circle me-1"></i>Force Close All
                    </button>
                </form>
```

The complete final card-header div (including Plan 01 content) should look like:

```html
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-semibold">
                <i class="bi bi-people me-2 text-primary"></i>Per-User Status
            </h5>
            <div class="d-flex gap-2 align-items-center">
                <!-- Export Results: GET download, no antiforgery needed -->
                <form asp-action="ExportAssessmentResults" method="get" class="d-inline">
                    <input type="hidden" name="title" value="@Model.Title" />
                    <input type="hidden" name="category" value="@Model.Category" />
                    <input type="hidden" name="scheduleDate" value="@Model.Schedule.ToString("yyyy-MM-dd")" />
                    <button type="submit" class="btn btn-outline-success btn-sm">
                        <i class="bi bi-download me-1"></i>Export Results
                    </button>
                </form>
                <!-- Force Close All: POST with antiforgery, confirm() guard -->
                <form asp-action="ForceCloseAll" method="post" class="d-inline"
                      onsubmit="return confirm('Tutup paksa semua sesi Open/InProgress? Sesi akan ditandai Abandoned dan tidak dapat dikembalikan.')">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="title" value="@Model.Title" />
                    <input type="hidden" name="category" value="@Model.Category" />
                    <input type="hidden" name="scheduleDate" value="@Model.Schedule.ToString("yyyy-MM-dd")" />
                    <button type="submit" class="btn btn-danger btn-sm">
                        <i class="bi bi-x-circle me-1"></i>Force Close All
                    </button>
                </form>
                @if (Model.IsPackageMode && Model.PendingCount > 0)
                {
                    <button type="button" class="btn btn-outline-primary btn-sm"
                            onclick="reshuffleAll(event)">
                        <i class="bi bi-shuffle me-1"></i>Reshuffle All (@Model.PendingCount pending)
                    </button>
                }
            </div>
        </div>
```

Key points:
- `@Html.AntiForgeryToken()` inside the form — required for POST with [ValidateAntiForgeryToken].
- `onsubmit="return confirm(...)"` — the established destructive-action pattern from Phase 22/26. Uses Indonesian confirmation text consistent with other forms in this view.
- `btn-danger` for Force Close All — red to signal destructive action.
- `scheduleDate` formatted as `yyyy-MM-dd` — matches DateTime model binding in the POST action.
- If Plan 01 has already been executed: only INSERT the Force Close All `<form>` block between the existing Export Results form and the Reshuffle All button. Do NOT rewrite the whole card-header if the structure from Plan 01 is already correct.
  </action>
  <verify>
1. `dotnet build "C:/Users/rinoa/Desktop/PortalHC_KPB/HcPortal.csproj" --no-restore 2>&1 | tail -10` — no errors.
2. `grep -n "ForceCloseAll" "C:/Users/rinoa/Desktop/PortalHC_KPB/Views/CMP/AssessmentMonitoringDetail.cshtml"` — shows the form action in the card header.
3. Confirm antiforgery token is inside the Force Close All form (not outside).
  </verify>
  <done>Build passes. AssessmentMonitoringDetail.cshtml card-header contains: Export Results (GET form), Force Close All (POST form with antiforgery + confirm()), and the conditionally-rendered Reshuffle All button — all inside a d-flex gap-2 container.</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `dotnet build` exits with 0 errors.
2. Open monitoring detail for an assessment that has Open or InProgress sessions.
3. "Force Close All" red button appears in the card header.
4. Click Force Close All — a JavaScript confirm() dialog appears with the warning message.
5. Dismiss the dialog (Cancel) — no action taken, page unchanged.
6. Click Force Close All and confirm — page reloads showing a success TempData banner.
7. Previously Open/InProgress workers now show Status "Abandoned" in the per-user table.
8. Completed and Upcoming sessions are unaffected.
9. AuditLog table has a new entry with Action="ForceCloseAll" and description including the session count.
10. If all sessions were already Completed/Abandoned: Error TempData shows "No Open or InProgress sessions to close."
</verification>

<success_criteria>
- ForceCloseAll POST action exists in CMPController.cs and compiles cleanly
- Force Close All button renders in AssessmentMonitoringDetail.cshtml with confirm() guard
- Clicking Force Close All and confirming sets all Open/InProgress sessions in the group to Status="Abandoned"
- Sessions set to Abandoned have UpdatedAt set; Score/IsPassed/CompletedAt remain null (untouched)
- One AuditLog entry created with Action="ForceCloseAll" and session count in description
- TempData["Success"] shown on redirect with count of closed sessions
- TempData["Error"] shown if no sessions were eligible for closing
</success_criteria>

<output>
After completion, create `.planning/phases/31-hc-reporting-actions/31-02-SUMMARY.md` with:
- What was built (ForceCloseAll action + Force Close All button)
- Files modified with line number ranges for new code
- Status transition chosen (Abandoned, not Completed) and rationale
- Audit log approach (one summary entry per bulk action)
- Verification status
</output>
