---
phase: 32-fix-legacy-question-path
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Controllers/CMPController.cs
autonomous: true

must_haves:
  truths:
    - "Worker starts an exam that uses HC-created questions (legacy path, no packages) and sees the questions"
    - "Worker submits the legacy exam and receives a correct score"
    - "Package path exams are completely unaffected by this change"
  artifacts:
    - path: "Controllers/CMPController.cs"
      provides: "Fixed legacy question path using sibling session lookup"
      contains: "siblingSessionIds.Contains"
  key_links:
    - from: "Controllers/CMPController.cs (legacy path)"
      to: "siblingSessionIds variable"
      via: "Where clause filtering AssessmentSessions by sibling IDs"
      pattern: "siblingSessionIds\\.Contains\\(a\\.Id\\)"
---

<objective>
Fix the legacy "Question" path in StartExam so HC-created questions are found for all workers in the same assessment batch, not just the representative session owner.

Purpose: When HC creates questions via the "Question" button on an assessment card, those questions are stored on the representative session. Other workers in the same batch have their own sessions with zero questions. The legacy path currently queries only the worker's own session (always empty), so workers see a blank exam. The package path already solves this with a sibling session lookup -- apply the same pattern to the legacy path.

Output: Single-file fix in CMPController.cs, legacy path at ~line 1974.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Controllers/CMPController.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix legacy question path to use sibling session lookup</name>
  <files>Controllers/CMPController.cs</files>
  <action>
In the StartExam action (~line 1972-2002), replace the legacy path's query that loads questions from only the worker's own session with a query that searches across all sibling sessions.

CURRENT CODE (lines 1975-1978):
```csharp
var assessmentWithQuestions = await _context.AssessmentSessions
    .Include(a => a.Questions)
        .ThenInclude(q => q.Options)
    .FirstOrDefaultAsync(a => a.Id == id);
```

REPLACE WITH:
```csharp
var sessionWithQuestions = await _context.AssessmentSessions
    .Include(a => a.Questions)
        .ThenInclude(q => q.Options)
    .Where(a => siblingSessionIds.Contains(a.Id) && a.Questions.Any())
    .FirstOrDefaultAsync();
```

Then update the next line (~line 1980) to use the new variable name:
```csharp
var legacyQuestions = sessionWithQuestions?.Questions
```

IMPORTANT constraints:
- Do NOT touch the package path (lines 1880-1970) -- it already works correctly
- Do NOT change the SubmitExam action -- legacy submission uses the worker's own session ID for UserResponses, which is correct (responses are per-worker, questions are shared)
- Keep HasPackages = false for the legacy ViewModel -- the submit action branches on this
- The variable `siblingSessionIds` is already computed at line 1864 and is in scope -- reuse it directly, do NOT recompute it
- The `.Where(... && a.Questions.Any())` filter ensures we find the representative session that actually has questions, not an empty worker session
  </action>
  <verify>
1. Run `dotnet build` from the project root -- must compile with zero errors
2. Visually inspect the diff to confirm:
   - Only the legacy path (else block around line 1972) is changed
   - The package path (if block) is untouched
   - `siblingSessionIds.Contains` is used in the new query
   - `HasPackages = false` is preserved in the legacy ViewModel
  </verify>
  <done>
The legacy path in StartExam queries sibling sessions (via siblingSessionIds) to find the representative session with questions, instead of querying only the worker's own (empty) session. Build succeeds. Package path is untouched.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` passes with zero errors
2. Code review confirms only the legacy path query changed (2 lines: the query itself and the variable name reference)
3. The package path (if branch) has zero modifications
4. The SubmitExam action has zero modifications
</verification>

<success_criteria>
- Legacy path uses siblingSessionIds.Contains() to find the session that holds questions
- Build succeeds
- Package path untouched (no regression risk)
- SubmitExam untouched (responses still stored per-worker)
</success_criteria>

<output>
After completion, create `.planning/phases/32-fix-legacy-question-path-in-startexam-sibling-session-lookup-so-hc-created-questions-work-for-all-workers/32-01-SUMMARY.md`
</output>
