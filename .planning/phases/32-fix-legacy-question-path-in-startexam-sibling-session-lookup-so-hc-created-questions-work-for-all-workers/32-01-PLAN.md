---
phase: 32-fix-legacy-question-path
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Controllers/CMPController.cs
autonomous: true

must_haves:
  truths:
    - "Worker starts an exam that uses HC-created questions (legacy path, no packages) and sees the questions"
    - "Worker reviews the ExamSummary page before final submit and sees their answered questions listed (not an empty table)"
    - "Worker submits the legacy exam and receives a correct score based on the sibling session's questions"
    - "Package path exams are completely unaffected by this change"
  artifacts:
    - path: "Controllers/CMPController.cs"
      provides: "Fixed legacy question path using sibling session lookup in StartExam, ExamSummary, and SubmitExam"
      contains: "siblingSessionIds.Contains"
  key_links:
    - from: "Controllers/CMPController.cs (StartExam legacy path)"
      to: "siblingSessionIds variable"
      via: "Where clause filtering AssessmentSessions by sibling IDs"
      pattern: "siblingSessionIds\\.Contains\\(a\\.Id\\)"
    - from: "Controllers/CMPController.cs (ExamSummary legacy path)"
      to: "siblingSessionIds variable"
      via: "Where clause filtering AssessmentQuestions by sibling IDs"
      pattern: "siblingSessionIds\\.Contains\\(q\\.AssessmentSessionId\\)"
    - from: "Controllers/CMPController.cs (SubmitExam legacy path)"
      to: "siblingSessionIds variable"
      via: "Where clause filtering AssessmentSessions by sibling IDs to load questions for grading"
      pattern: "siblingSessionIds\\.Contains\\(a\\.Id\\)"
---

<objective>
Fix the legacy "Question" path in three controller actions (StartExam, ExamSummary, SubmitExam) so HC-created questions are found for all workers in the same assessment batch, not just the representative session owner.

Purpose: When HC creates questions via the "Question" button on an assessment card, those questions are stored on the representative session. Other workers in the same batch have their own sessions with zero questions. All three legacy paths currently query only the worker's own session (always empty), so workers see blank exams, empty review summaries, and get zero scores. The package path already solves this with a sibling session lookup -- apply the same pattern to all three legacy paths.

Output: Single-file fix in CMPController.cs across three action methods.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Controllers/CMPController.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix StartExam legacy path to use sibling session lookup</name>
  <files>Controllers/CMPController.cs</files>
  <action>
In the StartExam action (~line 1972-2002), replace the legacy path's query that loads questions from only the worker's own session with a query that searches across all sibling sessions.

CURRENT CODE (lines 1975-1978):
```csharp
var assessmentWithQuestions = await _context.AssessmentSessions
    .Include(a => a.Questions)
        .ThenInclude(q => q.Options)
    .FirstOrDefaultAsync(a => a.Id == id);
```

REPLACE WITH:
```csharp
var sessionWithQuestions = await _context.AssessmentSessions
    .Include(a => a.Questions)
        .ThenInclude(q => q.Options)
    .Where(a => siblingSessionIds.Contains(a.Id) && a.Questions.Any())
    .FirstOrDefaultAsync();
```

Then update the next line (~line 1980) to use the new variable name:
```csharp
var legacyQuestions = sessionWithQuestions?.Questions
```

IMPORTANT constraints:
- Do NOT touch the package path (lines 1880-1970) -- it already works correctly
- Keep HasPackages = false for the legacy ViewModel -- the submit action branches on this
- The variable `siblingSessionIds` is already computed at line 1864 and is in scope -- reuse it directly, do NOT recompute it
- The `.Where(... && a.Questions.Any())` filter ensures we find the representative session that actually has questions, not an empty worker session
  </action>
  <verify>
1. Run `dotnet build` from the project root -- must compile with zero errors
2. Visually inspect the diff to confirm:
   - Only the legacy path (else block around line 1972) is changed
   - The package path (if block) is untouched
   - `siblingSessionIds.Contains` is used in the new query
   - `HasPackages = false` is preserved in the legacy ViewModel
  </verify>
  <done>
The legacy path in StartExam queries sibling sessions (via siblingSessionIds) to find the representative session with questions, instead of querying only the worker's own (empty) session. Build succeeds. Package path is untouched.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix ExamSummary and SubmitExam legacy paths to use sibling session lookup</name>
  <files>Controllers/CMPController.cs</files>
  <action>
Fix two additional legacy paths that also query only the worker's own (empty) session.

**FIX 1 -- ExamSummary GET (~line 2096):**

The ExamSummary GET action loads the assessment at line 2101 with `FindAsync(id)` but does NOT load sibling session IDs. Add the sibling session lookup before the legacy path block.

After line 2105 (the Forbid check) and before line 2107 (the TempData retrieval), or alternatively right before the legacy else block at line 2161, add:

```csharp
var siblingSessionIds = await _context.AssessmentSessions
    .Where(s => s.Title == assessment.Title &&
                s.Category == assessment.Category &&
                s.Schedule.Date == assessment.Schedule.Date)
    .Select(s => s.Id)
    .ToListAsync();
```

Then fix the legacy path query at lines 2164-2168. CURRENT CODE:
```csharp
var legacyQuestions = await _context.AssessmentQuestions
    .Include(q => q.Options)
    .Where(q => q.AssessmentSessionId == id)
    .OrderBy(q => q.Order)
    .ToListAsync();
```

REPLACE WITH:
```csharp
var legacyQuestions = await _context.AssessmentQuestions
    .Include(q => q.Options)
    .Where(q => siblingSessionIds.Contains(q.AssessmentSessionId))
    .OrderBy(q => q.Order)
    .ToListAsync();
```

Place the `siblingSessionIds` computation just before the `if (assignment != null)` check at line 2131 so it is in scope for both branches, OR place it inside the else block just before the legacyQuestions query. Either location is fine as long as `siblingSessionIds` is in scope when the legacy query executes.

NOTE: The ExamSummary action needs `assessment` to have the Schedule navigation loaded for the `.Schedule.Date` comparison. The current line 2101 uses `FindAsync(id)` which does NOT include Schedule. Change it to:
```csharp
var assessment = await _context.AssessmentSessions
    .Include(a => a.Schedule)
    .FirstOrDefaultAsync(a => a.Id == id);
```

**FIX 2 -- SubmitExam POST (~line 2272):**

The SubmitExam action loads assessment at line 2274 with `.Include(a => a.Questions).ThenInclude(q => q.Options).FirstOrDefaultAsync(a => a.Id == id)`. For the worker's own session, `assessment.Questions` is empty.

After the package path check (after line 2313 where `packageAssignment` is retrieved and before line 2406 where the legacy else block begins), add the sibling session lookup and load questions from the sibling:

```csharp
// Inside the else block at line 2406, before the grading loop:
var siblingSessionIds = await _context.AssessmentSessions
    .Where(s => s.Title == assessment.Title &&
                s.Category == assessment.Category &&
                s.Schedule.Date == assessment.Schedule.Date)
    .Select(s => s.Id)
    .ToListAsync();

var siblingWithQuestions = await _context.AssessmentSessions
    .Include(a => a.Questions)
        .ThenInclude(q => q.Options)
    .Where(a => siblingSessionIds.Contains(a.Id) && a.Questions.Any())
    .FirstOrDefaultAsync();

var questionsForGrading = siblingWithQuestions?.Questions?.ToList()
    ?? new List<AssessmentQuestion>();
```

Then change line 2413 from:
```csharp
foreach (var question in assessment.Questions)
```
to:
```csharp
foreach (var question in questionsForGrading)
```

NOTE: The SubmitExam action also needs `assessment.Schedule` for the sibling lookup. The current line 2274 does NOT include Schedule. Change it to:
```csharp
var assessment = await _context.AssessmentSessions
    .Include(a => a.Questions)
        .ThenInclude(q => q.Options)
    .Include(a => a.Schedule)
    .FirstOrDefaultAsync(a => a.Id == id);
```

IMPORTANT constraints:
- UserResponse records at line 2431-2436 MUST still use `AssessmentSessionId = id` (the worker's own session) -- this is correct, responses are per-worker
- The `assessment.Score`, `assessment.Status`, etc. updates at lines 2444-2448 MUST still update the worker's own session -- this is correct
- Do NOT touch the package path (lines 2314-2405) -- it already works correctly
- The sibling lookup pattern is identical to StartExam line 1864: same Title + Category + Schedule.Date
  </action>
  <verify>
1. Run `dotnet build` from the project root -- must compile with zero errors
2. Visually inspect the diff to confirm:
   - ExamSummary legacy path now queries using siblingSessionIds.Contains
   - ExamSummary loads assessment with .Include(a => a.Schedule)
   - SubmitExam legacy path grades from siblingWithQuestions, not assessment.Questions
   - SubmitExam loads assessment with .Include(a => a.Schedule)
   - UserResponse records still use AssessmentSessionId = id (worker's own session)
   - Package paths in both actions are untouched
  </verify>
  <done>
ExamSummary legacy path queries sibling sessions for questions so the review page shows the correct question list. SubmitExam legacy path grades against the sibling session's questions so the worker receives a correct score. UserResponses are still stored against the worker's own session ID. Both package paths are untouched. Build succeeds.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` passes with zero errors
2. Code review confirms three legacy paths are fixed:
   - StartExam: queries sibling sessions for questions (Task 1)
   - ExamSummary: queries sibling sessions for questions (Task 2)
   - SubmitExam: grades against sibling session's questions (Task 2)
3. All three fixes use the same pattern: compute siblingSessionIds, query with .Contains(), find session with .Questions.Any()
4. Package paths in all three actions have zero modifications
5. UserResponse storage still uses the worker's own session ID
</verification>

<success_criteria>
- All three legacy paths (StartExam, ExamSummary, SubmitExam) use siblingSessionIds.Contains() to find the session that holds questions
- ExamSummary shows the correct question list on the review page
- SubmitExam grades correctly against the representative session's questions
- UserResponses are stored per-worker (AssessmentSessionId = id)
- Build succeeds
- Package paths untouched (no regression risk)
</success_criteria>

<output>
After completion, create `.planning/phases/32-fix-legacy-question-path-in-startexam-sibling-session-lookup-so-hc-created-questions-work-for-all-workers/32-01-SUMMARY.md`
</output>
