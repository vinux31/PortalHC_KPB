---
phase: 33-protontrack-schema
plan: 02
type: execute
wave: 2
depends_on: ["33-01"]
files_modified:
  - Data/SeedProtonData.cs
  - Controllers/CDPController.cs
  - Models/ProtonViewModels.cs
  - Models/CDPDashboardViewModel.cs
  - Views/CDP/ProtonMain.cshtml
autonomous: true
must_haves:
  truths:
    - "SeedProtonData.cs seeds only ProtonTrack rows (6 rows); it does not seed ProtonKompetensi, ProtonSubKompetensi, or ProtonDeliverable"
    - "AssignTrack action accepts a protonTrackId (int) parameter — no trackType or tahunKe string parameters"
    - "PlanIdp Coachee path queries ProtonKompetensiList by ProtonTrackId FK, not by TrackType+TahunKe strings"
    - "No code in CDPController reads .TrackType or .TahunKe directly from ProtonKompetensi or ProtonTrackAssignment entities"
    - "ProtonMain.cshtml AssignTrack form sends a single protonTrackId value (from a dropdown of ProtonTrack rows)"
    - "The application builds and runs without runtime errors on the Proton workflow paths"
  artifacts:
    - path: "Data/SeedProtonData.cs"
      provides: "Updated seed that checks ProtonTracks.AnyAsync() and seeds 6 ProtonTrack rows only"
      contains: "context.ProtonTracks.AnyAsync()"
    - path: "Controllers/CDPController.cs"
      provides: "AssignTrack accepts protonTrackId; PlanIdp and Deliverable/ApproveDeliverable use ProtonTrackId FK for filtering"
      contains: "ProtonTrackId == assignment.ProtonTrackId"
    - path: "Views/CDP/ProtonMain.cshtml"
      provides: "AssignTrack form with a single ProtonTrack dropdown (select name=protonTrackId) populated from ViewBag.ProtonTracks"
      contains: "name=\"protonTrackId\""
  key_links:
    - from: "Views/CDP/ProtonMain.cshtml AssignTrack form"
      to: "Controllers/CDPController.cs AssignTrack action"
      via: "form POST with protonTrackId int parameter"
      pattern: "name=\"protonTrackId\""
    - from: "Controllers/CDPController.cs AssignTrack"
      to: "Data/ApplicationDbContext.cs ProtonTrackAssignments"
      via: "new ProtonTrackAssignment { ProtonTrackId = protonTrackId } — no TrackType/TahunKe"
      pattern: "ProtonTrackId = protonTrackId"
    - from: "Controllers/CDPController.cs PlanIdp"
      to: "Data/ApplicationDbContext.cs ProtonKompetensiList"
      via: ".Include(a => a.ProtonTrack) on assignment, then .Where(k => k.ProtonTrackId == assignment.ProtonTrackId)"
      pattern: "k\\.ProtonTrackId == assignment\\.ProtonTrackId"
    - from: "Controllers/CDPController.cs Deliverable/ApproveDeliverable"
      to: "ProtonKompetensi.ProtonTrackId"
      via: "filter orderedProgresses by ProtonTrackId traversed through include chain (progress.ProtonDeliverable.ProtonSubKompetensi.ProtonKompetensi.ProtonTrackId)"
      pattern: "ProtonKompetensi\\.ProtonTrackId"
---

<objective>
Update all consumer code to use ProtonTrackId FK instead of the removed TrackType+TahunKe string fields: rewrite SeedProtonData.cs to seed ProtonTrack rows only, update CDPController to receive/query by ProtonTrackId, update ProtonMain.cshtml's AssignTrack form to send a protonTrackId, and fix ViewModels that still hold string TrackType/TahunKe fields used for display.

Purpose: Complete the Phase 33 schema migration by making all application code consistent with the new normalized schema. After this plan, no code path reads TrackType or TahunKe from ProtonKompetensi or ProtonTrackAssignment entities.

Output: A working application where the full Proton workflow (PlanIdp, AssignTrack, Deliverable, ApproveDeliverable, BuildCoacheeSubModel, BuildProtonProgressSubModel) operates through ProtonTrackId FK without any string-field access on the migrated entities.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-protontrack-schema/33-CONTEXT.md
@.planning/phases/33-protontrack-schema/33-RESEARCH.md
@.planning/phases/33-protontrack-schema/33-01-SUMMARY.md
@Data/SeedProtonData.cs
@Controllers/CDPController.cs
@Models/ProtonViewModels.cs
@Models/CDPDashboardViewModel.cs
@Views/CDP/ProtonMain.cshtml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite SeedProtonData.cs to seed ProtonTrack rows only</name>
  <files>Data/SeedProtonData.cs</files>
  <action>
    Replace the entire body of SeedProtonData.cs with a new implementation that:

    1. Checks `context.ProtonTracks.AnyAsync()` — if any ProtonTrack rows already exist, print a skip message and return. (Previously it checked ProtonKompetensiList; change the guard to ProtonTracks.)

    2. Seeds exactly 6 ProtonTrack rows in Urutan order:
    ```csharp
    var tracks = new List<ProtonTrack>
    {
        new ProtonTrack { TrackType = "Panelman", TahunKe = "Tahun 1", DisplayName = "Panelman - Tahun 1", Urutan = 1 },
        new ProtonTrack { TrackType = "Panelman", TahunKe = "Tahun 2", DisplayName = "Panelman - Tahun 2", Urutan = 2 },
        new ProtonTrack { TrackType = "Panelman", TahunKe = "Tahun 3", DisplayName = "Panelman - Tahun 3", Urutan = 3 },
        new ProtonTrack { TrackType = "Operator", TahunKe = "Tahun 1", DisplayName = "Operator - Tahun 1", Urutan = 4 },
        new ProtonTrack { TrackType = "Operator", TahunKe = "Tahun 2", DisplayName = "Operator - Tahun 2", Urutan = 5 },
        new ProtonTrack { TrackType = "Operator", TahunKe = "Tahun 3", DisplayName = "Operator - Tahun 3", Urutan = 6 },
    };
    await context.ProtonTracks.AddRangeAsync(tracks);
    await context.SaveChangesAsync();
    ```

    3. Print a success message: "Seeded 6 ProtonTrack rows (Panelman/Operator x Tahun 1/2/3) successfully!"

    Do NOT seed ProtonKompetensi, ProtonSubKompetensi, or ProtonDeliverable. The old catalog seeding is removed entirely — catalog items are managed via Phase 35 UI going forward.

    The using statement at the top must include `using HcPortal.Models;` (already present) and `using Microsoft.EntityFrameworkCore;` (for AnyAsync).
  </action>
  <verify>
    `dotnet build` passes. The file no longer references `ProtonKompetensiList` in any seed check or AddRange call.
    Grep: `grep -n "ProtonKompetensi\|AddRange.*kompetensi\|ProtonSubKompetensi" Data/SeedProtonData.cs` — must return no results.
    Grep: `grep -n "ProtonTracks.AnyAsync" Data/SeedProtonData.cs` — must return 1 result.
  </verify>
  <done>
    SeedProtonData.cs seeds only ProtonTrack rows. Guard checks ProtonTracks (not ProtonKompetensiList). File compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update CDPController — AssignTrack, PlanIdp, Deliverable, ApproveDeliverable, and helper methods</name>
  <files>Controllers/CDPController.cs</files>
  <action>
    Make the following targeted changes to CDPController.cs. Work through each method in turn.

    **A. ProtonMain action (around line 632) — load ProtonTracks for the dropdown:**
    After loading `coachees` and `assignments`, also load:
    ```csharp
    var protonTracks = await _context.ProtonTracks
        .OrderBy(t => t.Urutan)
        .ToListAsync();
    ViewBag.ProtonTracks = protonTracks;
    ```
    Pass this to the view via ViewBag so the form can render a dropdown.

    **B. AssignTrack action (around line 674) — change signature and body:**
    Old signature: `public async Task<IActionResult> AssignTrack(string coacheeId, string trackType, string tahunKe)`
    New signature: `public async Task<IActionResult> AssignTrack(string coacheeId, int protonTrackId)`

    Update the null/empty check:
    ```csharp
    if (string.IsNullOrEmpty(coacheeId) || protonTrackId <= 0)
    {
        TempData["Error"] = "Data tidak lengkap.";
        return RedirectToAction("ProtonMain");
    }
    ```

    Update new assignment creation — remove TrackType/TahunKe, add ProtonTrackId:
    ```csharp
    var newAssignment = new ProtonTrackAssignment
    {
        CoacheeId = coacheeId,
        AssignedById = user.Id,
        ProtonTrackId = protonTrackId,
        IsActive = true,
        AssignedAt = DateTime.UtcNow
    };
    ```

    Update the deliverables query — change from TrackType+TahunKe string filter to ProtonTrackId:
    ```csharp
    var deliverables = await _context.ProtonDeliverableList
        .Include(d => d.ProtonSubKompetensi)
            .ThenInclude(s => s.ProtonKompetensi)
        .Where(d => d.ProtonSubKompetensi.ProtonKompetensi.ProtonTrackId == protonTrackId)
        .OrderBy(d => d.ProtonSubKompetensi.ProtonKompetensi.Urutan)
            .ThenBy(d => d.ProtonSubKompetensi.Urutan)
            .ThenBy(d => d.Urutan)
        .ToListAsync();
    ```

    **C. PlanIdp coachee path (around line 54) — load assignment with ProtonTrack navigation:**
    Change:
    ```csharp
    var assignment = await _context.ProtonTrackAssignments
        .Where(a => a.CoacheeId == user.Id && a.IsActive)
        .FirstOrDefaultAsync();
    ```
    To:
    ```csharp
    var assignment = await _context.ProtonTrackAssignments
        .Include(a => a.ProtonTrack)
        .Where(a => a.CoacheeId == user.Id && a.IsActive)
        .FirstOrDefaultAsync();
    ```

    Change the kompetensiList query from TrackType+TahunKe strings to ProtonTrackId:
    ```csharp
    var kompetensiList = await _context.ProtonKompetensiList
        .Include(k => k.SubKompetensiList)
            .ThenInclude(s => s.Deliverables)
        .Where(k => k.ProtonTrackId == assignment.ProtonTrackId)
        .OrderBy(k => k.Urutan)
        .ToListAsync();
    ```

    Update the viewModel construction — read TrackType/TahunKe from assignment.ProtonTrack (the FK'd entity):
    ```csharp
    var protonViewModel = new ProtonPlanViewModel
    {
        TrackType = assignment.ProtonTrack!.TrackType,
        TahunKe = assignment.ProtonTrack.TahunKe,
        KompetensiList = kompetensiList,
        ActiveProgress = activeProgress,
        FinalAssessment = finalAssessment
    };
    ```

    **D. BuildCoacheeSubModelAsync helper (around line 177) — load assignment with ProtonTrack:**
    Change the assignment query to include `.Include(a => a.ProtonTrack)`.
    Change the TrackType/TahunKe assignment:
    ```csharp
    subModel.TrackType = assignment.ProtonTrack?.TrackType ?? "";
    subModel.TahunKe = assignment.ProtonTrack?.TahunKe ?? "";
    ```

    **E. BuildProtonProgressSubModelAsync helper (around line 267) — load assignments with ProtonTrack:**
    Change:
    ```csharp
    var assignments = await _context.ProtonTrackAssignments
        .Where(a => scopedCoacheeIds.Contains(a.CoacheeId) && a.IsActive)
        .ToListAsync();
    ```
    To:
    ```csharp
    var assignments = await _context.ProtonTrackAssignments
        .Include(a => a.ProtonTrack)
        .Where(a => scopedCoacheeIds.Contains(a.CoacheeId) && a.IsActive)
        .ToListAsync();
    ```
    Update the CoacheeProgressRow construction for TrackType/TahunKe:
    ```csharp
    TrackType = assignment?.ProtonTrack?.TrackType ?? "",
    TahunKe = assignment?.ProtonTrack?.TahunKe ?? "",
    ```

    **F. Deliverable action (around line 799) — change track info retrieval from string navigation to ProtonTrackId:**
    The Deliverable action currently reads `kompetensi.TrackType` and `kompetensi.TahunKe` to filter `orderedProgresses`. After the migration, ProtonKompetensi no longer has TrackType/TahunKe; it has ProtonTrackId. Change:
    - Remove `string trackType = kompetensi?.TrackType ?? "";` and `string tahunKe = kompetensi?.TahunKe ?? "";`
    - Add: `int? protonTrackId = kompetensi?.ProtonTrackId;`
    - Change the `orderedProgresses` filter:
      ```csharp
      var orderedProgresses = allProgresses
          .Where(p => p.ProtonDeliverable?.ProtonSubKompetensi?.ProtonKompetensi?.ProtonTrackId == protonTrackId)
          .OrderBy(p => p.ProtonDeliverable?.ProtonSubKompetensi?.ProtonKompetensi?.Urutan ?? 0)
          .ThenBy(p => p.ProtonDeliverable?.ProtonSubKompetensi?.Urutan ?? 0)
          .ThenBy(p => p.ProtonDeliverable?.Urutan ?? 0)
          .ToList();
      ```
    - For the DeliverableViewModel, TrackType and TahunKe are still needed for display in views. Read them from `kompetensi.ProtonTrack` navigation. The Include chain `Include(p => p.ProtonDeliverable).ThenInclude(d => d.ProtonSubKompetensi).ThenInclude(s => s.ProtonKompetensi)` already loads ProtonKompetensi. Add `.ThenInclude(k => k.ProtonTrack)` to that chain so the navigation is populated:
      ```csharp
      var progress = await _context.ProtonDeliverableProgresses
          .Include(p => p.ProtonDeliverable)
              .ThenInclude(d => d.ProtonSubKompetensi)
                  .ThenInclude(s => s.ProtonKompetensi)
                      .ThenInclude(k => k.ProtonTrack)
          ...
      ```
      Then set:
      ```csharp
      TrackType = kompetensi?.ProtonTrack?.TrackType ?? "",
      TahunKe = kompetensi?.ProtonTrack?.TahunKe ?? "",
      ```

    **G. ApproveDeliverable action (around line 906) — same pattern as Deliverable:**
    - Change from `kompetensi?.TrackType` and `kompetensi?.TahunKe` to `int? protonTrackId = kompetensi?.ProtonTrackId;`
    - Add `.ThenInclude(k => k.ProtonTrack)` to the Include chain for the `allProgresses` query
    - Change `orderedProgresses` filter to use ProtonTrackId: `.Where(p => p.ProtonDeliverable?.ProtonSubKompetensi?.ProtonKompetensi?.ProtonTrackId == protonTrackId)`

    **H. HCApprovals / readyForAssessment (around line 1119) — load assignments with ProtonTrack:**
    Change the allAssignments query to include `.Include(a => a.ProtonTrack)`.
    Update the FinalAssessmentCandidate construction:
    ```csharp
    TrackType = assignment.ProtonTrack?.TrackType ?? "",
    TahunKe = assignment.ProtonTrack?.TahunKe ?? "",
    ```

    Do NOT change: CoacheeDashboardSubModel.TrackType and TahunKe properties (they are ViewModel string fields for display, not entity fields — they still exist, just populated from FK navigation now).

    Do NOT touch the Views — view display logic for TrackType/TahunKe string values remains unchanged; the strings are now sourced from ProtonTrack navigation rather than removed entity fields.
  </action>
  <verify>
    `dotnet build` passes with 0 errors.

    Grep checks — these MUST return 0 matches (no remaining string-field reads on the migrated entities):
    ```
    grep -n "assignment\.TrackType\|assignment\.TahunKe" Controllers/CDPController.cs
    grep -n "kompetensi\.TrackType\|kompetensi\.TahunKe" Controllers/CDPController.cs
    grep -n "trackType.*TahunKe\|tahunKe.*TrackType" Controllers/CDPController.cs
    ```

    Grep checks — these MUST return matches (new FK usage in place):
    ```
    grep -n "ProtonTrackId == assignment\.ProtonTrackId" Controllers/CDPController.cs
    grep -n "Include.*ProtonTrack" Controllers/CDPController.cs
    grep -n "ProtonTrack\?" Controllers/CDPController.cs
    ```

    Verify AssignTrack signature: `grep -n "AssignTrack.*protonTrackId" Controllers/CDPController.cs` — must return 1 result.
  </verify>
  <done>
    CDPController.cs compiles without errors. No code reads .TrackType or .TahunKe directly from ProtonKompetensi or ProtonTrackAssignment entities. AssignTrack accepts protonTrackId. All ProtonTrackAssignment queries that need track display info use .Include(a => a.ProtonTrack).
  </done>
</task>

<task type="auto">
  <name>Task 3: Update ProtonMain.cshtml form and fix remaining compiler errors</name>
  <files>
    Views/CDP/ProtonMain.cshtml
    Models/ProtonViewModels.cs
    Models/CDPDashboardViewModel.cs
  </files>
  <action>
    **A. ProtonMain.cshtml — replace two-dropdown form with single ProtonTrack dropdown:**

    Find the AssignTrack modal form section (around line 121). Replace the two separate dropdowns (name="trackType" and name="tahunKe") with a single dropdown populated from ViewBag.ProtonTracks:

    Replace the two `<div class="mb-3">` blocks with:
    ```html
    <div class="mb-3">
        <label class="form-label fw-semibold">Track</label>
        <select class="form-select" name="protonTrackId" required>
            <option value="">Pilih Track</option>
            @foreach (var track in (IEnumerable<HcPortal.Models.ProtonTrack>)ViewBag.ProtonTracks)
            {
                <option value="@track.Id">@track.DisplayName</option>
            }
        </select>
    </div>
    ```

    Also update the display of the current assignment in the coachee table row (around line 77) — the view currently renders `@assignment.TrackType - @assignment.TahunKe`. Replace with `@assignment.ProtonTrack?.DisplayName` (since ProtonMain loads assignments, ensure the ProtonMain action in CDPController also includes `.Include(a => a.ProtonTrack)` on the assignments query — add this if missing).

    **B. Verify ViewModels still compile — no changes needed in most cases:**

    ProtonPlanViewModel.TrackType and TahunKe are string properties used for display in views. These remain (the View renders them). No changes needed to ProtonViewModels.cs.

    CDPDashboardViewModel.cs CoacheeDashboardSubModel.TrackType and TahunKe are string properties for display. These remain. No changes needed.

    FinalAssessmentCandidate.TrackType and TahunKe are string properties for display in HCApprovals.cshtml. These remain populated from ProtonTrack navigation in CDPController Task 2H above.

    If any remaining compile errors exist (e.g., missing `using`, ambiguous references), fix them. The common pattern is that `HcPortal.Models.ProtonTrack` needs to be in scope in the view file — add the namespace to the `@using` section at the top of ProtonMain.cshtml if needed.

    **C. Final build and smoke test:**
    Run `dotnet build` — must produce 0 errors.
    Run `dotnet run` briefly (or verify it starts). Navigate to /CDP/ProtonMain — the page should load. Navigate to /CDP/PlanIdp — should load without exception for a coachee user. Check the application logs for any FK-related runtime exceptions.
  </action>
  <verify>
    `dotnet build` passes with 0 errors.

    Grep checks on ProtonMain.cshtml:
    ```
    grep -n "name=\"protonTrackId\"" Views/CDP/ProtonMain.cshtml       # Must return 1
    grep -n "name=\"trackType\"\|name=\"tahunKe\"" Views/CDP/ProtonMain.cshtml   # Must return 0
    ```

    Manual smoke test (if running locally):
    1. Visit /CDP/ProtonMain — page loads, AssignTrack modal shows a single dropdown with 6 ProtonTrack options ("Panelman - Tahun 1" ... "Operator - Tahun 3")
    2. As Coachee, visit /CDP/PlanIdp — no exception, page loads (empty if no kompetensi seeded yet, which is expected for fresh install)
    3. Submit AssignTrack form — new ProtonTrackAssignment created with non-null ProtonTrackId; no 400/500 error
  </verify>
  <done>
    ProtonMain.cshtml form uses a single protonTrackId dropdown. Application builds and runs without errors. The full Proton workflow paths (ProtonMain, PlanIdp, AssignTrack) operate without referencing removed string fields.
  </done>
</task>

</tasks>

<verification>
After all tasks complete, run the full Phase 33 verification:

1. `dotnet build` — 0 errors
2. Database state (from Plan 01):
   - `SELECT COUNT(*) FROM ProtonTracks` — returns 6
   - `SELECT COUNT(*) FROM ProtonKompetensiList WHERE ProtonTrackId IS NULL` — returns 0
   - `SELECT COUNT(*) FROM ProtonTrackAssignments WHERE ProtonTrackId IS NULL` — returns 0
3. Code grep — must return 0 results:
   - `grep -rn "assignment\.TrackType\|assignment\.TahunKe" Controllers/CDPController.cs`
   - `grep -rn "name=\"trackType\"\|name=\"tahunKe\"" Views/CDP/ProtonMain.cshtml`
4. Code grep — must return results (FK in use):
   - `grep -n "ProtonTrackId == assignment\.ProtonTrackId" Controllers/CDPController.cs`
   - `grep -n "context\.ProtonTracks\.AnyAsync" Data/SeedProtonData.cs`
5. SeedProtonData guard check — `grep -n "ProtonKompetensiList\.AnyAsync" Data/SeedProtonData.cs` — must return 0 (old guard removed)
</verification>

<success_criteria>
- SeedProtonData.cs seeds 6 ProtonTrack rows and does not seed any Kompetensi/SubKompetensi/Deliverable rows
- AssignTrack controller action signature is (string coacheeId, int protonTrackId) — no string track params
- PlanIdp loads assignment with .Include(a => a.ProtonTrack) and filters Kompetensi by ProtonTrackId
- Deliverable and ApproveDeliverable filter orderedProgresses by ProtonTrackId (not TrackType+TahunKe strings)
- ProtonMain.cshtml sends a single protonTrackId from a DisplayName dropdown (not separate trackType/tahunKe inputs)
- `dotnet build` produces 0 errors
- Phase 33 SCHEMA-01 requirement fully satisfied: ProtonTrack is a dedicated table, ProtonKompetensi links via FK, old string columns are dropped, AssignTrack workflow resolves tracks by ProtonTrackId
</success_criteria>

<output>
After completion, create `.planning/phases/33-protontrack-schema/33-02-SUMMARY.md`
</output>
