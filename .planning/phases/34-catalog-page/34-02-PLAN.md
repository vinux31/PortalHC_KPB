---
phase: 34-catalog-page
plan: 02
type: execute
wave: 2
depends_on: [34-01]
files_modified:
  - Views/ProtonCatalog/Index.cshtml
  - Views/ProtonCatalog/_CatalogTree.cshtml
  - Views/Shared/_Layout.cshtml
autonomous: false

must_haves:
  truths:
    - "HC/Admin sees a 'Proton Catalog' entry in the navigation that navigates to /ProtonCatalog"
    - "Non-HC/Admin users (RoleLevel > 2) do not see the Proton Catalog nav entry"
    - "On /ProtonCatalog the track dropdown shows all tracks; selecting one triggers AJAX tree reload and updates the URL to /ProtonCatalog?trackId={id}"
    - "All Kompetensi rows start collapsed on load; clicking the chevron expands it revealing SubKompetensi rows (also collapsed); clicking a SubKompetensi chevron reveals its Deliverables"
    - "Clicking a row's text (not the chevron) does NOT expand or collapse"
    - "Selecting no track shows 'Select a track to view kompetensi' placeholder; selecting a track with no Kompetensi shows 'No Kompetensi yet — add some in the catalog editor'"
    - "Add Track modal: TrackType dropdown has Panelman/Operator only; TahunKe dropdown has Tahun 1/2/3 only; DisplayName field is read-only and updates live as user selects both inputs"
    - "Submitting Add Track with duplicate combination shows inline error '[DisplayName] already exists' inside the modal without closing it"
    - "Submitting Add Track with valid unique combination closes the modal, adds the new track to the dropdown, and auto-selects it (triggering empty state tree load)"
  artifacts:
    - path: "Views/ProtonCatalog/Index.cshtml"
      provides: "Catalog page with track dropdown, Add Track button, tree container, Add Track modal, and all JavaScript"
      contains: "@section Scripts"
    - path: "Views/ProtonCatalog/_CatalogTree.cshtml"
      provides: "Partial view rendering three-level Bootstrap collapse tree"
      contains: "data-bs-toggle=\"collapse\""
    - path: "Views/Shared/_Layout.cshtml"
      provides: "CDP nav item converted to dropdown with existing CDP link + divider + Proton Catalog link (HC/Admin only)"
      contains: "Proton Catalog"
  key_links:
    - from: "Views/ProtonCatalog/Index.cshtml JS onTrackChanged()"
      to: "Controllers/ProtonCatalogController.cs GetCatalogTree"
      via: "fetch('/ProtonCatalog/GetCatalogTree?trackId='+trackId) replacing #treeContainer innerHTML"
      pattern: "GetCatalogTree"
    - from: "Views/ProtonCatalog/Index.cshtml JS addTrackForm submit"
      to: "Controllers/ProtonCatalogController.cs AddTrack"
      via: "fetch POST /ProtonCatalog/AddTrack form-encoded body with antiforgery token"
      pattern: "AddTrack"
    - from: "Views/ProtonCatalog/_CatalogTree.cshtml chevron buttons"
      to: "Bootstrap collapse API"
      via: "data-bs-toggle='collapse' + data-bs-target='#kompetensi-{id}'"
      pattern: "data-bs-toggle"
    - from: "Views/Shared/_Layout.cshtml"
      to: "Controllers/ProtonCatalogController.cs Index"
      via: "asp-controller='ProtonCatalog' asp-action='Index' inside CDP dropdown, gated on currentUser.RoleLevel <= 2"
      pattern: "ProtonCatalog"
---

<objective>
Build the complete frontend for the Proton Catalog Manager: the main Index view, the collapsible tree partial, and the navigation entry.

Purpose: Delivers the user-facing catalog page satisfying CAT-01 (navigation), CAT-02 (tree view), and CAT-09 (nav visibility for HC/Admin). This plan wires the frontend to the controller created in Plan 01.

Output: Three files created/modified — Index.cshtml (new), _CatalogTree.cshtml (new), _Layout.cshtml (modified).
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-catalog-page/34-RESEARCH.md
@.planning/phases/34-catalog-page/34-01-SUMMARY.md
@Views/Shared/_Layout.cshtml
@Views/CDP/ProtonMain.cshtml
@Models/ProtonModels.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Views/ProtonCatalog/Index.cshtml and Views/ProtonCatalog/_CatalogTree.cshtml</name>
  <files>Views/ProtonCatalog/Index.cshtml, Views/ProtonCatalog/_CatalogTree.cshtml</files>
  <action>
Create the directory `Views/ProtonCatalog/` if it does not exist, then create both files.

---

**FILE: Views/ProtonCatalog/Index.cshtml**

This is the main catalog page view. It reads from ViewBag (set by the controller):
- `ViewBag.AllTracks` — `List<ProtonTrack>` for the dropdown
- `ViewBag.SelectedTrackId` — `int?` for pre-selection
- `ViewBag.KompetensiList` — `List<ProtonKompetensi>` for server-side initial tree (only set when trackId query param was present)

Top of file:
```cshtml
@{
    ViewData["Title"] = "Proton Catalog Manager";
    var tracks = ViewBag.AllTracks as List<ProtonTrack> ?? new List<ProtonTrack>();
    var selectedTrackId = ViewBag.SelectedTrackId as int?;
    var kompetensiList = ViewBag.KompetensiList as List<ProtonKompetensi>;
}
```

**Page structure:**

1. Page header: `<h2 class="fw-bold mb-4">Proton Catalog Manager</h2>` with an inline Bootstrap Icon (`bi-list-check`) and `text-primary` color.

2. Track selection card (`card border-0 shadow-sm mb-4`):
   - Left side (col-md-8): label "Select Track" + `<select class="form-select" id="trackDropdown">` with a placeholder `<option value="">-- Select a track... --</option>` and one `<option>` per track, with `selected` attribute set server-side: `@(track.Id == selectedTrackId ? "selected" : "")` as attribute value.
   - Right side (col-md-4 text-end): "Add Track" button — `<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTrackModal">Add Track</button>`.

3. Tree container card (`card border-0 shadow-sm`):
   - `<div id="treeContainer" class="card-body p-0">`
   - Inside: If `kompetensiList != null` (server pre-loaded), render `@await Html.PartialAsync("_CatalogTree", kompetensiList)`. Otherwise render the placeholder div: `<div class="text-center py-5 text-muted"><i class="bi bi-info-circle me-2"></i>Select a track to view kompetensi</div>`.
   - The empty state message "No Kompetensi yet — add some in the catalog editor" is rendered by the `_CatalogTree` partial when its model is an empty list.

4. Add Track modal (`id="addTrackModal"`):
   - Modal header: "Add Track"
   - Modal body:
     - TrackType select (`id="trackTypeSelect"`): options "Panelman" and "Operator" only (no other values). `onchange="updateDisplayName()"`.
     - TahunKe select (`id="tahunKeSelect"`): options "Tahun 1", "Tahun 2", "Tahun 3" only. `onchange="updateDisplayName()"`.
     - DisplayName preview: `<input type="text" class="form-control" id="displayNamePreview" readonly placeholder="Auto-generated">`. This field is read-only — it shows the live preview but is NOT submitted.
     - Error container: `<div id="addTrackError" class="alert alert-danger mt-2 d-none"></div>`.
   - Modal footer: Cancel (`data-bs-dismiss="modal"`) and "Add Track" submit button (`id="addTrackSubmit"`).
   - The form itself: `<form id="addTrackForm">` with `@Html.AntiForgeryToken()` hidden inside the modal body (above the first field).

5. `@section Scripts` at the bottom with all JavaScript:

**JS function: `updateDisplayName()`**
```javascript
function updateDisplayName() {
    const type = document.getElementById('trackTypeSelect').value;
    const year = document.getElementById('tahunKeSelect').value;
    document.getElementById('displayNamePreview').value = (type && year) ? type + ' - ' + year : '';
}
```

**JS: track dropdown change handler**
Attach `addEventListener('change', onTrackChanged)` on `#trackDropdown` inside `DOMContentLoaded`.

```javascript
function onTrackChanged() {
    const trackId = document.getElementById('trackDropdown').value;
    if (!trackId) {
        window.history.pushState(null, '', '/ProtonCatalog');
        document.getElementById('treeContainer').innerHTML =
            '<div class="text-center py-5 text-muted"><i class="bi bi-info-circle me-2"></i>Select a track to view kompetensi</div>';
        return;
    }
    window.history.pushState(null, '', '/ProtonCatalog?trackId=' + trackId);
    fetch('/ProtonCatalog/GetCatalogTree?trackId=' + trackId)
        .then(function(r) { return r.text(); })
        .then(function(html) { document.getElementById('treeContainer').innerHTML = html; })
        .catch(function(err) { console.error('Tree load error:', err); });
}
```

NOTE: `GetCatalogTree` is a GET endpoint — no antiforgery token needed in the fetch call.

NOTE: On initial page load with `selectedTrackId` pre-set, the tree is already rendered server-side. Do NOT call `onTrackChanged()` on page load — the `selected` attribute on the option handles dropdown state, and the server-rendered partial handles the tree.

**JS: Add Track form submit**
```javascript
document.getElementById('addTrackForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const trackType = document.getElementById('trackTypeSelect').value;
    const tahunKe = document.getElementById('tahunKeSelect').value;
    const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
    const errorDiv = document.getElementById('addTrackError');
    errorDiv.classList.add('d-none');
    errorDiv.textContent = '';

    if (!trackType || !tahunKe) {
        errorDiv.textContent = 'Please select both Track Type and Year.';
        errorDiv.classList.remove('d-none');
        return;
    }

    const body = new URLSearchParams({ trackType: trackType, tahunKe: tahunKe, __RequestVerificationToken: token });
    fetch('/ProtonCatalog/AddTrack', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: body.toString()
    })
    .then(function(r) { return r.json(); })
    .then(function(result) {
        if (result.success) {
            // 1. Add new option to dropdown
            const dropdown = document.getElementById('trackDropdown');
            const option = document.createElement('option');
            option.value = result.trackId;
            option.textContent = result.displayName;
            dropdown.appendChild(option);
            // 2. Select new track
            dropdown.value = result.trackId;
            // 3. Close modal
            bootstrap.Modal.getInstance(document.getElementById('addTrackModal')).hide();
            // 4. Load tree (will show empty state)
            onTrackChanged();
        } else {
            errorDiv.textContent = result.error;
            errorDiv.classList.remove('d-none');
        }
    })
    .catch(function(err) { console.error('AddTrack error:', err); });
});
```

**JS: Reset modal on close**
Listen to `hidden.bs.modal` on `#addTrackModal` to reset form fields and hide error:
```javascript
document.getElementById('addTrackModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('trackTypeSelect').value = '';
    document.getElementById('tahunKeSelect').value = '';
    document.getElementById('displayNamePreview').value = '';
    document.getElementById('addTrackError').classList.add('d-none');
    document.getElementById('addTrackError').textContent = '';
});
```

---

**FILE: Views/ProtonCatalog/_CatalogTree.cshtml**

This partial is the AJAX-replaceable tree. Its model is `List<ProtonKompetensi>`.

Top of file:
```cshtml
@model List<HcPortal.Models.ProtonKompetensi>
```

**Empty state** (when `Model` is empty or null): render the locked message:
```cshtml
@if (Model == null || !Model.Any())
{
    <div class="text-center py-5 text-muted">
        <i class="bi bi-info-circle me-2"></i>No Kompetensi yet — add some in the catalog editor
    </div>
}
```

**Tree table** (when Model has items): a `<table class="table table-bordered mb-0">` with columns: chevron (50px), Name (flexible), Level (120px fixed).

**Tree structure (three levels):**

Level 1 — Kompetensi row:
```html
<tr>
  <td style="width:50px;" class="align-middle text-center">
    <button type="button" class="btn btn-link btn-sm p-0 text-secondary"
            data-bs-toggle="collapse"
            data-bs-target="#kompetensi-@kompetensi.Id"
            aria-expanded="false"
            aria-label="Toggle @kompetensi.NamaKompetensi">
      <i class="bi bi-chevron-right"></i>
    </button>
  </td>
  <td class="align-middle fw-semibold ps-2">@kompetensi.NamaKompetensi</td>
  <td style="width:120px;" class="align-middle text-muted small">Kompetensi</td>
</tr>
```

Followed immediately by a collapse container row:
```html
<tr id="kompetensi-@kompetensi.Id" class="collapse">
  <td colspan="3" class="p-0 ps-4">
    [SubKompetensi rows rendered as nested table]
  </td>
</tr>
```

Level 2 — SubKompetensi: same pattern within the nested table, using `#subkompetensi-@sub.Id` as collapse target. Button uses `aria-label="Toggle @sub.NamaSubKompetensi"`. The collapse container holds the Deliverables nested table. SubKompetensi rows also start with `class="collapse"` (no `.show`).

Level 3 — Deliverable: leaf rows with NO collapse button, NO `data-bs-toggle`. Just: `<td></td><td class="ps-2">@deliverable.NamaDeliverable</td><td class="text-muted small">Deliverable</td>`.

**CRITICAL: Chevron icon rotation** — Bootstrap's collapse fires `show.bs.collapse` and `hide.bs.collapse` events on the TARGET element (the collapsible row), not on the button. Listen on the target to rotate the button's icon:

Use event delegation on the tree container. After the table, add a `<script>` block:
```javascript
(function() {
    document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(function(btn) {
        var targetId = btn.getAttribute('data-bs-target').replace('#', '');
        var target = document.getElementById(targetId);
        if (!target) return;
        target.addEventListener('show.bs.collapse', function() {
            var icon = btn.querySelector('i');
            if (icon) { icon.classList.replace('bi-chevron-right', 'bi-chevron-down'); }
        });
        target.addEventListener('hide.bs.collapse', function() {
            var icon = btn.querySelector('i');
            if (icon) { icon.classList.replace('bi-chevron-down', 'bi-chevron-right'); }
        });
    });
})();
```

Note: This `<script>` block runs inline when the partial is injected via AJAX innerHTML replacement. That is intentional — it re-attaches listeners each time the tree is freshly rendered.

Do NOT use `@section Scripts` in the partial — sections don't work in partial views. Use a bare `<script>` tag.

Iterate in Urutan order: `.OrderBy(k => k.Urutan)` for Kompetensi, `.OrderBy(s => s.Urutan)` for SubKompetensi, `.OrderBy(d => d.Urutan)` for Deliverables.
  </action>
  <verify>
    1. `dotnet build` exits with code 0.
    2. Navigate to `/ProtonCatalog` as HC/Admin — page loads, dropdown shows "-- Select a track... --", tree container shows the placeholder.
    3. Select a track from the dropdown — URL updates to `/ProtonCatalog?trackId={id}`, tree container replaces with the tree partial (or empty state if no Kompetensi).
    4. Navigate directly to `/ProtonCatalog?trackId=1` — dropdown pre-selects track 1 and tree is pre-rendered.
    5. Click a Kompetensi chevron — row expands showing SubKompetensi (all collapsed). Click row text — nothing happens.
    6. Click "Add Track" button — modal opens with both dropdowns empty and DisplayName read-only blank.
    7. Select TrackType + TahunKe — DisplayName preview updates to "TrackType - TahunKe" format.
  </verify>
  <done>
    Both view files exist. Build is clean. Manual browser verification confirms: track dropdown + AJAX tree reload + Bootstrap collapse + Add Track modal with live preview.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Proton Catalog nav link to _Layout.cshtml CDP dropdown</name>
  <files>Views/Shared/_Layout.cshtml</files>
  <action>
Modify `Views/Shared/_Layout.cshtml` to convert the flat CDP nav link into a dropdown that contains both the original CDP link and a new "Proton Catalog" link (visible to HC/Admin only).

**Current state** (lines ~59-61):
```html
<li class="nav-item">
    <a class="nav-link text-dark" asp-controller="CDP" asp-action="Index">CDP</a>
</li>
```

**Replace with** this dropdown structure:
```html
<li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle text-dark" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
        CDP
    </a>
    <ul class="dropdown-menu shadow-sm border-0">
        <li><a class="dropdown-item" asp-controller="CDP" asp-action="Index">CDP Dashboard</a></li>
        @if (currentUser != null && currentUser.RoleLevel <= 2)
        {
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" asp-controller="ProtonCatalog" asp-action="Index">Proton Catalog</a></li>
        }
    </ul>
</li>
```

**Why this pattern:**
- `currentUser` is already resolved at the top of `_Layout.cshtml` (line 6: `var currentUser = await UserManager.GetUserAsync(User);`)
- `currentUser.RoleLevel <= 2` is the exact pattern used at line 81 for "Manage Workers" visibility
- The role check uses the actual role (not simulated view via `SelectedView`) — per the locked decision in CONTEXT.md
- The divider visually separates the general CDP link from the catalog management tool
- No icon on the nav link — plain text only per locked decision

Make this edit surgically: find the exact `<li class="nav-item">` block containing `asp-controller="CDP"` and replace only that block. Do not touch CMP, BP, or any other nav items.
  </action>
  <verify>
    1. `dotnet build` exits with code 0.
    2. Login as HC (RoleLevel 2) or Admin (RoleLevel 1) — hover/click CDP in nav — dropdown appears with "CDP Dashboard" and "Proton Catalog" entries separated by divider.
    3. Click "Proton Catalog" — navigates to `/ProtonCatalog`.
    4. Login as Coachee or other non-HC/Admin role — CDP dropdown shows only "CDP Dashboard" with no divider or Proton Catalog entry.
    5. Admin using simulated view (SelectedView != "HC") — Proton Catalog link is still visible because check is on actual `RoleLevel`, not `SelectedView`.
  </verify>
  <done>
    `_Layout.cshtml` CDP nav item is now a dropdown. "Proton Catalog" link appears for HC/Admin (RoleLevel <= 2) only, gated on actual role. Build is clean.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Manual verification of complete Phase 34 catalog page</name>
  <files>Views/ProtonCatalog/Index.cshtml, Views/ProtonCatalog/_CatalogTree.cshtml, Views/Shared/_Layout.cshtml, Controllers/ProtonCatalogController.cs</files>
  <action>
This is a human verification checkpoint. All implementation was completed in Tasks 1 and 2 — this task confirms the end-to-end catalog page workflow functions correctly in the browser.
  </action>
  <what-built>
    Complete Phase 34 Catalog Page:
    - ProtonCatalogController with Index, GetCatalogTree, AddTrack actions (Plan 01)
    - Views/ProtonCatalog/Index.cshtml with track dropdown, AJAX tree reload, Add Track modal
    - Views/ProtonCatalog/_CatalogTree.cshtml with three-level Bootstrap collapse tree
    - _Layout.cshtml CDP dropdown with "Proton Catalog" link for HC/Admin
  </what-built>
  <how-to-verify>
    Run the app and test as HC or Admin:

    1. **Navigation:** Click "CDP" in the navbar — a dropdown appears. Verify it shows "CDP Dashboard" and (below a divider) "Proton Catalog".

    2. **Page load:** Click "Proton Catalog" — opens /ProtonCatalog. Dropdown shows "-- Select a track... --". Tree container shows "Select a track to view kompetensi" placeholder.

    3. **Track selection:** Pick any track from the dropdown. URL updates to /ProtonCatalog?trackId={id}. Tree reloads via AJAX. If track has Kompetensi, they appear as collapsed rows. If empty, shows "No Kompetensi yet — add some in the catalog editor".

    4. **Direct URL:** Open /ProtonCatalog?trackId=1 directly. Dropdown pre-selects that track and tree is pre-rendered.

    5. **Expand/collapse:** Click the chevron (>) on a Kompetensi row — it expands showing SubKompetensi (collapsed). Click the chevron on a SubKompetensi — Deliverables appear. Click the row text (not chevron) — nothing happens.

    6. **Add Track modal:** Click "Add Track". Modal opens blank. Select TrackType + TahunKe — DisplayName preview updates live to "TrackType - TahunKe". Submit — if unique, modal closes and new track appears in dropdown, auto-selected. If duplicate, inline error "[DisplayName] already exists" appears inside the modal.

    7. **Role restriction:** Log in as a non-HC/Admin (Coachee) — CDP dropdown should show only "CDP Dashboard". Navigating directly to /ProtonCatalog should return 403.
  </how-to-verify>
  <verify>User confirms all 7 verification steps pass by typing "approved"</verify>
  <done>User has verified the complete Phase 34 catalog page — navigation, tree expand/collapse, track dropdown AJAX, and Add Track modal — functions correctly end-to-end</done>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After tasks 1 and 2 complete (before checkpoint):
1. `dotnet build` exits with code 0.
2. `Views/ProtonCatalog/Index.cshtml` exists.
3. `Views/ProtonCatalog/_CatalogTree.cshtml` exists.
4. `grep "Proton Catalog" Views/Shared/_Layout.cshtml` returns a match.
5. `grep "currentUser.RoleLevel <= 2" Views/Shared/_Layout.cshtml` shows at least two matches (existing + new).
6. `grep "data-bs-toggle=\"collapse\"" Views/ProtonCatalog/_CatalogTree.cshtml` returns matches.
7. `grep "GetCatalogTree\|AddTrack" Views/ProtonCatalog/Index.cshtml` returns matches.
</verification>

<success_criteria>
- CDP nav item is now a dropdown; "Proton Catalog" visible only to HC/Admin (actual RoleLevel)
- /ProtonCatalog loads for HC/Admin, shows track dropdown; non-HC/Admin get 403
- Track dropdown change triggers AJAX fetch to GetCatalogTree and updates URL
- Direct URL /ProtonCatalog?trackId=X pre-selects track and renders tree server-side
- Kompetensi rows all start collapsed; chevron-only expand (not row text)
- Expanding Kompetensi shows collapsed SubKompetensi; expanding SubKompetensi shows Deliverables
- Empty track shows correct message; no Kompetensi shows correct message
- Add Track modal: constrained dropdowns, live DisplayName preview, duplicate inline error, on success: modal closes + dropdown updated + auto-selected
- Page is read-only (no add/edit/delete controls on tree rows)
- Human verification checkpoint passed
</success_criteria>

<output>
After completion, create `.planning/phases/34-catalog-page/34-02-SUMMARY.md`
</output>
