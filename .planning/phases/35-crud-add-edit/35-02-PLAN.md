---
phase: 35-crud-add-edit
plan: 02
type: execute
wave: 2
depends_on: ["35-01"]
files_modified:
  - Views/ProtonCatalog/_CatalogTree.cshtml
autonomous: false

must_haves:
  truths:
    - "An '+ Add Kompetensi' link is always visible at the bottom of the Kompetensi list; clicking it reveals an inline input row with Save (checkmark) and Cancel (X) buttons"
    - "When a track has zero Kompetensi, a faint 'No Kompetensi yet' message appears above the '+ Add Kompetensi' link"
    - "An '+ Add SubKompetensi' link is always visible inside an expanded Kompetensi section; clicking it reveals an inline input row"
    - "When a Kompetensi has zero SubKompetensi, a faint 'No SubKompetensi yet' message appears above the '+ Add SubKompetensi' link"
    - "An '+ Add Deliverable' link is always visible inside an expanded SubKompetensi section; clicking it reveals an inline input row"
    - "When a SubKompetensi has zero Deliverables, a faint 'No Deliverables yet' message appears above the '+ Add Deliverable' link"
    - "Save button is disabled when the input field is empty; it enables as soon as the user types a non-whitespace character"
    - "On Save, fetch POSTs to the correct endpoint with antiforgery token; on success, a new row is appended immediately before the '+ Add X' row"
    - "A pencil icon (bi-pencil) appears on the far right of a row only when that row's collapse section is expanded"
    - "Clicking the pencil icon replaces the item name span with an inline text input pre-filled with the current name, plus Save and Cancel buttons"
    - "On edit Save, fetch POSTs to /ProtonCatalog/EditCatalogItem with level + itemId + nama + token; on success, the name span updates in-place"
    - "Clicking Cancel in edit mode restores the original name span without making a network request"
  artifacts:
    - path: "Views/ProtonCatalog/_CatalogTree.cshtml"
      provides: "Inline add rows, empty state messages, pencil icons, edit mode toggling, and all AJAX wiring for three levels"
      min_lines: 200
  key_links:
    - from: "Views/ProtonCatalog/_CatalogTree.cshtml JS"
      to: "/ProtonCatalog/AddKompetensi"
      via: "fetch POST with URLSearchParams + antiforgery token"
      pattern: "fetch.*AddKompetensi|AddKompetensi"
    - from: "Views/ProtonCatalog/_CatalogTree.cshtml JS"
      to: "/ProtonCatalog/EditCatalogItem"
      via: "fetch POST with level + itemId + nama + token"
      pattern: "fetch.*EditCatalogItem|EditCatalogItem"
    - from: "Bootstrap collapse events"
      to: "pencil icon visibility"
      via: "show.bs.collapse / hide.bs.collapse event listeners in inline script"
      pattern: "show\\.bs\\.collapse|pencil"
---

<objective>
Rewrite _CatalogTree.cshtml to add inline Add rows, empty-state messages, pencil-icon edit triggers, and all JavaScript wiring for the four AJAX endpoints delivered in Plan 01.

Purpose: Closes Phase 35 requirements CAT-03 through CAT-06 — HC/Admin can add and rename catalog items in-place without a page reload.
Output: _CatalogTree.cshtml fully updated; all add/edit interactions functional end-to-end.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/34-catalog-page/34-02-SUMMARY.md
@.planning/phases/35-crud-add-edit/35-01-SUMMARY.md
@Views/ProtonCatalog/_CatalogTree.cshtml
@Views/ProtonCatalog/Index.cshtml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add empty states, inline Add rows, and pencil icons to _CatalogTree.cshtml HTML structure</name>
  <files>Views/ProtonCatalog/_CatalogTree.cshtml</files>
  <action>
Rewrite `Views/ProtonCatalog/_CatalogTree.cshtml` to incorporate all structural changes. Keep the existing three-level Bootstrap collapse table structure intact; extend it with the following:

**1. Top-level empty state (zero Kompetensi for a track):**
Replace the current empty-state block (the `@if (Model == null || !Model.Any())` branch) with a version that renders the empty message AND the Add Kompetensi row together:

```cshtml
@if (Model == null || !Model.Any())
{
    <div class="p-3">
        <div class="text-muted small fst-italic mb-2 ps-1">No Kompetensi yet</div>
        <!-- Add Kompetensi trigger row (always visible) -->
        <div class="add-trigger-row" id="addKompetensiTrigger" data-track-id="@ViewBag.SelectedTrackId">
            <a href="#" class="text-primary small text-decoration-none add-trigger-link"
               data-target="addKompetensiInput">+ Add Kompetensi</a>
        </div>
        <div class="add-input-row d-none" id="addKompetensiInput">
            @* inline input rendered below *@
        </div>
    </div>
}
```

When there ARE Kompetensi, append the Add Kompetensi trigger AFTER the `</table>` closing tag (still inside the outer `else` block), before the `<script>` block:

```cshtml
<!-- Add Kompetensi trigger (always visible below the last Kompetensi row) -->
<div class="p-2 ps-3" id="addKompetensiTrigger" data-track-id="@ViewBag.SelectedTrackId">
    <a href="#" class="text-primary small text-decoration-none"
       id="addKompetensiLink">+ Add Kompetensi</a>
    <div class="add-input-row d-none mt-1" id="addKompetensiInput"></div>
</div>
```

**2. Kompetensi row: add pencil icon to the name cell**
Change the Kompetensi level row from:
```cshtml
<td class="align-middle fw-semibold ps-2">@kompetensi.NamaKompetensi</td>
<td class="align-middle text-muted small">Kompetensi</td>
```
To:
```cshtml
<td class="align-middle fw-semibold ps-2">
    <span class="item-name" data-level="Kompetensi" data-id="@kompetensi.Id">@kompetensi.NamaKompetensi</span>
</td>
<td class="align-middle text-end pe-2">
    <button type="button"
            class="btn btn-link btn-sm p-0 text-muted pencil-btn d-none"
            data-level="Kompetensi"
            data-id="@kompetensi.Id"
            aria-label="Edit @kompetensi.NamaKompetensi">
        <i class="bi bi-pencil"></i>
    </button>
</td>
```

**3. Inside each expanded Kompetensi collapse section: SubKompetensi empty state + Add trigger**
Inside the `<tbody>` of the SubKompetensi table, after the `@foreach` loop for SubKompetensi (or in place of it when empty), add:

```cshtml
@if (!kompetensi.SubKompetensiList.Any())
{
    <tr>
        <td colspan="3" class="py-1">
            <div class="text-muted small fst-italic ps-1">No SubKompetensi yet</div>
        </td>
    </tr>
}
<!-- Add SubKompetensi trigger (always visible, after last SubKompetensi row) -->
<tr class="add-subkompetensi-trigger-row">
    <td colspan="3" class="py-1">
        <a href="#" class="text-primary small text-decoration-none ms-1"
           data-parent-id="@kompetensi.Id">+ Add SubKompetensi</a>
        <div class="add-input-row d-none mt-1" id="addSubKompetensiInput-@kompetensi.Id"></div>
    </td>
</tr>
```

**4. SubKompetensi row: add pencil icon**
Mirror the pattern from Kompetensi row — wrap the name in `<span class="item-name" data-level="SubKompetensi" data-id="@sub.Id">` and add a pencil button column with `class="pencil-btn d-none"`.

**5. Inside each expanded SubKompetensi collapse section: Deliverable empty state + Add trigger**
After the `@foreach` for Deliverables (or in place when empty):

```cshtml
@if (!sub.Deliverables.Any())
{
    <tr>
        <td colspan="3" class="py-1">
            <div class="text-muted small fst-italic ps-1">No Deliverables yet</div>
        </td>
    </tr>
}
<!-- Add Deliverable trigger (always visible) -->
<tr class="add-deliverable-trigger-row">
    <td colspan="3" class="py-1">
        <a href="#" class="text-primary small text-decoration-none ms-1"
           data-parent-id="@sub.Id">+ Add Deliverable</a>
        <div class="add-input-row d-none mt-1" id="addDeliverableInput-@sub.Id"></div>
    </td>
</tr>
```

**6. Deliverable row: add pencil icon**
Deliverables are leaf rows (no chevron). Wrap their name in `<span class="item-name" data-level="Deliverable" data-id="@deliverable.Id">` and add a pencil button column with `class="pencil-btn d-none"`.

**Colgroup widths:** The third column (formerly "Kompetensi"/"SubKompetensi"/"Deliverable" label) is now used for the pencil button. Set it to `width:50px` so the pencil aligns to the right edge. Remove the text label from the third column on all levels — the tree hierarchy is already self-evident from indentation.

**Inline input HTML helper** (used in JavaScript to inject — define as a JS function, not Razor):
The input rows are built in JavaScript (see Task 2). The Razor HTML above only needs placeholder containers (`<div class="add-input-row d-none">`).
  </action>
  <verify>
Visually verify by loading `/ProtonCatalog?trackId=1` (or any valid trackId) in a browser:
- The tree renders without JS errors in the console
- Each Kompetensi row has a pencil icon column on the right (hidden initially)
- A "+ Add Kompetensi" link appears below all Kompetensi rows
- Expanding a Kompetensi row shows "+ Add SubKompetensi" below its SubKompetensi list
- If a Kompetensi has zero SubKompetensi, "No SubKompetensi yet" is visible in faint italic text
  </verify>
  <done>
The partial view renders the three-level collapse tree with pencil icon placeholders (hidden), empty-state messages where applicable, and "+ Add X" trigger links at the bottom of each level. No JavaScript errors on page load.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire all AJAX interactions in _CatalogTree.cshtml inline script</name>
  <files>Views/ProtonCatalog/_CatalogTree.cshtml</files>
  <action>
Replace the existing inline `<script>` block in _CatalogTree.cshtml with an expanded version that handles chevron rotation (preserve existing), pencil visibility, inline add inputs, and inline edit mode. The script must be an IIFE so it survives AJAX tree reloads.

**Antiforgery token:** Read from `document.querySelector('input[name="__RequestVerificationToken"]')`. This input is rendered by `@Html.AntiForgeryToken()` on the parent Index.cshtml page. The partial view does NOT need to render its own token — it reads the one already present in the DOM.

**Helper: buildInlineInput(placeholderText, onSave, onCancel)**
Builds and returns a `<div>` containing:
- `<input type="text" class="form-control form-control-sm d-inline-block" style="width:60%" placeholder="...">` — the name field
- `<button class="btn btn-sm btn-success ms-1 save-btn" disabled>✓</button>` — Save; disabled when input is empty
- `<button class="btn btn-sm btn-secondary ms-1 cancel-btn">✗</button>` — Cancel

Wire the `input` event on the text field: `saveBtn.disabled = input.value.trim() === ''`. Wire `click` on saveBtn → call `onSave(input.value.trim())`. Wire `click` on cancelBtn → call `onCancel()`.

**Chevron rotation** (preserve existing pattern from Phase 34):
```js
document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(function (btn) {
    var targetId = btn.getAttribute('data-bs-target').replace('#', '');
    var target = document.getElementById(targetId);
    if (!target) return;
    target.addEventListener('show.bs.collapse', function () {
        var icon = btn.querySelector('i.bi-chevron-right, i.bi-chevron-down');
        if (icon) icon.classList.replace('bi-chevron-right', 'bi-chevron-down');
    });
    target.addEventListener('hide.bs.collapse', function () {
        var icon = btn.querySelector('i.bi-chevron-right, i.bi-chevron-down');
        if (icon) icon.classList.replace('bi-chevron-down', 'bi-chevron-right');
    });
});
```

**Pencil icon visibility** (show when row's collapse is expanded, hide when collapsed):
After the chevron setup loop, add another listener pass to control pencil visibility. Each collapse target element (`#kompetensi-{id}`, `#subkompetensi-{id}`) corresponds to a row that has a pencil button. The pencil button's `data-id` matches the row's Id. Strategy: find each `[data-bs-toggle="collapse"]` button, get its target, listen for `show.bs.collapse` → find the pencil button in the SAME `<tr>` as the toggle button and remove `d-none`; on `hide.bs.collapse` → add `d-none` back.

```js
document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(function (btn) {
    var row = btn.closest('tr');
    if (!row) return;
    var pencil = row.querySelector('.pencil-btn');
    if (!pencil) return;
    var targetId = btn.getAttribute('data-bs-target').replace('#', '');
    var target = document.getElementById(targetId);
    if (!target) return;
    target.addEventListener('show.bs.collapse', function () { pencil.classList.remove('d-none'); });
    target.addEventListener('hide.bs.collapse', function () { pencil.classList.add('d-none'); });
});
```

**Add Kompetensi flow:**
```js
var addKompetensiLink = document.getElementById('addKompetensiLink');
var addKompetensiContainer = document.getElementById('addKompetensiInput');
var addKompetensiTrigger = document.getElementById('addKompetensiTrigger');
if (addKompetensiLink && addKompetensiContainer) {
    addKompetensiLink.addEventListener('click', function (e) {
        e.preventDefault();
        if (!addKompetensiContainer.classList.contains('d-none')) return; // already open
        var trackId = addKompetensiTrigger.dataset.trackId;
        addKompetensiContainer.classList.remove('d-none');
        var widget = buildInlineInput('Nama Kompetensi...', function (nama) {
            postItem('/ProtonCatalog/AddKompetensi', { trackId: trackId, nama: nama }, function (result) {
                addKompetensiContainer.classList.add('d-none');
                addKompetensiContainer.innerHTML = '';
                // Insert new Kompetensi row before the trigger container
                // Reload the entire tree (simplest approach — consistent with existing AJAX pattern)
                reloadTree();
            }, function (err) {
                showInlineError(addKompetensiContainer, err);
            });
        }, function () {
            addKompetensiContainer.classList.add('d-none');
            addKompetensiContainer.innerHTML = '';
        });
        addKompetensiContainer.appendChild(widget);
        widget.querySelector('input').focus();
    });
}
```

**Add SubKompetensi flow** — wire all `[data-parent-id]` links inside SubKompetensi trigger rows:
```js
document.querySelectorAll('.add-subkompetensi-trigger-row a[data-parent-id]').forEach(function (link) {
    link.addEventListener('click', function (e) {
        e.preventDefault();
        var kompetensiId = link.dataset.parentId;
        var container = document.getElementById('addSubKompetensiInput-' + kompetensiId);
        if (!container || !container.classList.contains('d-none')) return;
        container.classList.remove('d-none');
        var widget = buildInlineInput('Nama SubKompetensi...', function (nama) {
            postItem('/ProtonCatalog/AddSubKompetensi', { kompetensiId: kompetensiId, nama: nama }, function () {
                container.classList.add('d-none');
                container.innerHTML = '';
                reloadTree();
            }, function (err) { showInlineError(container, err); });
        }, function () { container.classList.add('d-none'); container.innerHTML = ''; });
        container.appendChild(widget);
        widget.querySelector('input').focus();
    });
});
```

**Add Deliverable flow** — same pattern, using `.add-deliverable-trigger-row a[data-parent-id]` and `/ProtonCatalog/AddDeliverable` with `subKompetensiId`.

**Edit (pencil) flow:**
```js
document.querySelectorAll('.pencil-btn').forEach(function (btn) {
    btn.addEventListener('click', function () {
        var level = btn.dataset.level;
        var itemId = btn.dataset.id;
        var nameSpan = btn.closest('tr').querySelector('.item-name[data-id="' + itemId + '"]');
        if (!nameSpan) return;
        var originalName = nameSpan.textContent.trim();
        // Build edit widget inline
        var widget = buildInlineInput(originalName, function (newName) {
            postItem('/ProtonCatalog/EditCatalogItem', { level: level, itemId: itemId, nama: newName }, function () {
                nameSpan.textContent = newName;
                nameSpan.parentNode.replaceChild(nameSpan, nameSpan.parentNode.querySelector('.add-input-row') || nameSpan);
                restoreNameSpan(nameSpan, widget);
            }, function (err) { showInlineError(widget.parentNode, err); });
        }, function () { restoreNameSpan(nameSpan, widget); });
        widget.querySelector('input').value = originalName;
        widget.querySelector('.save-btn').disabled = false;
        // Replace nameSpan with widget in-place
        nameSpan.style.display = 'none';
        nameSpan.parentNode.insertBefore(widget, nameSpan.nextSibling);
    });
});

function restoreNameSpan(nameSpan, widget) {
    nameSpan.style.display = '';
    if (widget.parentNode) widget.parentNode.removeChild(widget);
}
```

**postItem helper:**
```js
function postItem(url, params, onSuccess, onError) {
    var token = document.querySelector('input[name="__RequestVerificationToken"]');
    if (!token) { onError('Token tidak ditemukan.'); return; }
    var body = new URLSearchParams(Object.assign({}, params, { __RequestVerificationToken: token.value }));
    fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: body.toString() })
        .then(function (r) { return r.json(); })
        .then(function (result) { result.success ? onSuccess(result) : onError(result.error || 'Gagal.'); })
        .catch(function () { onError('Terjadi kesalahan. Coba lagi.'); });
}
```

**reloadTree helper:**
```js
function reloadTree() {
    var trackId = document.getElementById('trackDropdown') ? document.getElementById('trackDropdown').value : null;
    if (!trackId) return;
    fetch('/ProtonCatalog/GetCatalogTree?trackId=' + trackId)
        .then(function (r) { return r.text(); })
        .then(function (html) { document.getElementById('treeContainer').innerHTML = html; })
        .catch(function (err) { console.error('Tree reload error:', err); });
}
```

**showInlineError helper:**
```js
function showInlineError(container, msg) {
    var existing = container.querySelector('.inline-error');
    if (existing) existing.remove();
    var err = document.createElement('div');
    err.className = 'inline-error text-danger small mt-1';
    err.textContent = msg;
    container.appendChild(err);
}
```

**Important notes:**
- The `reloadTree` function references `document.getElementById('trackDropdown')` — this element lives on Index.cshtml (parent page), NOT in the partial. Since the partial is injected into the parent DOM, this reference will resolve correctly at runtime. Do NOT add a trackDropdown to the partial view.
- The `treeContainer` element also lives on Index.cshtml — same reasoning applies.
- The entire script is an IIFE: `(function() { ... })();` so re-injection on AJAX reload re-attaches all listeners.
- Do NOT use `@section Scripts` — the partial view uses an inline `<script>` block (established pattern from Phase 34-02).
- Save button uses `✓` and `✗` as button text (Unicode checkmark and X), not icons, to avoid dependency on Bootstrap Icons inside dynamically created elements.
  </action>
  <verify>
Load `/ProtonCatalog?trackId=1` in a browser. Test the following flows manually:
1. Click "+ Add Kompetensi" — inline input appears with disabled Save button. Type a name — Save enables. Click Save — spinner/loading state shows briefly, then tree reloads with the new Kompetensi at the bottom.
2. Expand any Kompetensi row — pencil icon appears on the right. Collapse it — pencil disappears.
3. Click the pencil on any Kompetensi — name becomes editable input, pre-filled with current name. Edit and click Save — name updates in-place without page reload.
4. Click Cancel in edit mode — name reverts to original without a network call (verify in Network DevTools — no request made).
5. Click "+ Add SubKompetensi" inside an expanded Kompetensi — inline input appears. Submit — tree reloads with new SubKompetensi.
6. Click "+ Add Deliverable" inside an expanded SubKompetensi — inline input appears. Submit — tree reloads.
7. Save button is disabled when input is empty, enabled when input has content.
8. No console errors throughout.
  </verify>
  <done>
All six AJAX interactions (add Kompetensi, add SubKompetensi, add Deliverable, edit Kompetensi, edit SubKompetensi, edit Deliverable) work end-to-end without page reloads. Empty-state messages show when levels have zero items. Save button disabled on empty input. Cancel restores without a network call. No console errors.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Human verification — all add/edit interactions end-to-end</name>
  <files>Views/ProtonCatalog/_CatalogTree.cshtml, Controllers/ProtonCatalogController.cs</files>
  <action>
This is a human verification checkpoint. All implementation was completed in Tasks 1 and 2 (and Plan 01). This task confirms the end-to-end add/edit workflow functions correctly in the browser.
  </action>
  <what-built>
Phase 35 complete: four AJAX endpoints in ProtonCatalogController (Plan 01) and fully wired _CatalogTree.cshtml with inline add/edit interactions (Plan 02).
  </what-built>
  <how-to-verify>
Navigate to the Proton Catalog page (CDP Index > Proton Catalog card, or directly at /ProtonCatalog). Select a track from the dropdown.

**Add flows:**
1. Scroll below the last Kompetensi row — confirm "+ Add Kompetensi" link is visible
2. Click "+ Add Kompetensi" — confirm inline input appears with disabled Save (✓) and enabled Cancel (✗)
3. Type a name — confirm Save button becomes enabled
4. Click Save — confirm the tree reloads with the new Kompetensi at the bottom (no full page reload)
5. Expand any Kompetensi row — confirm "+ Add SubKompetensi" is visible inside; test add flow same as above
6. Expand any SubKompetensi row — confirm "+ Add Deliverable" is visible inside; test add flow

**Edit flows:**
7. Expand a Kompetensi row — confirm pencil icon (bi-pencil) appears on the far right of the Kompetensi row
8. Collapse the Kompetensi row — confirm pencil icon disappears
9. Re-expand and click the pencil — confirm name becomes an editable input pre-filled with the current name
10. Edit the name and click Save (✓) — confirm name updates in-place, no page reload, no console errors
11. Click pencil again → edit → click Cancel (✗) — confirm name reverts to the value from step 9 without any network request (check DevTools Network tab)

**Edge cases:**
12. Click "+ Add Kompetensi" but leave input empty — confirm Save stays disabled
13. For a track with zero Kompetensi, confirm "No Kompetensi yet" faint italic message appears above the "+ Add Kompetensi" link
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. _CatalogTree.cshtml has all three Add trigger rows with placeholder containers for inline inputs
2. Empty-state messages ("No Kompetensi yet", "No SubKompetensi yet", "No Deliverables yet") render when a level has zero items
3. Each item row has a `.pencil-btn` with `d-none` class and `data-level` + `data-id` attributes
4. The inline script IIFE contains: chevron rotation, pencil visibility via collapse events, buildInlineInput helper, postItem helper, reloadTree helper, showInlineError helper, and all three Add click handlers plus the pencil click handler
5. Save button is disabled when input is empty (checked via input event listener)
6. Cancel button hides the input and restores the name span without making any network request
7. All fetch POSTs include the antiforgery token read from `document.querySelector('input[name="__RequestVerificationToken"]').value`
8. Human verification checkpoint passed (approved by user)
</verification>

<success_criteria>
Phase 35 requirements met:
- CAT-03: HC/Admin can add a Kompetensi inline — "+ Add Kompetensi" link, inline input, AJAX POST, tree reloads with new row
- CAT-04: HC/Admin can add a SubKompetensi inline inside any expanded Kompetensi
- CAT-05: HC/Admin can add a Deliverable inline inside any expanded SubKompetensi
- CAT-06: HC/Admin can rename any Kompetensi, SubKompetensi, or Deliverable — click expand → click pencil → edit name → Save commits via AJAX → row updates in-place

All interactions complete without page reloads. Human verification checkpoint passed.
</success_criteria>

<output>
After completion, create `.planning/phases/35-crud-add-edit/35-02-SUMMARY.md`
</output>
