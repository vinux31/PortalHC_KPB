---
phase: 37-drag-drop-reorder
plan: "02"
type: execute
wave: 2
depends_on: ["37-01"]
files_modified:
  - Views/Shared/_Layout.cshtml
  - Views/ProtonCatalog/_CatalogTree.cshtml
  - Views/ProtonCatalog/Index.cshtml
autonomous: false

must_haves:
  truths:
    - "HC/Admin can drag a Kompetensi row to a new position — visual order updates immediately and new order persists after page reload"
    - "HC/Admin can drag a SubKompetensi row within its parent — same behavior"
    - "HC/Admin can drag a Deliverable row within its parent — same behavior (draggable without collapsing)"
    - "Grip handle (bi-grip-vertical) appears only when a Kompetensi or SubKompetensi row is expanded; Deliverable handles are always visible"
    - "While a save is in flight, all drag handles are disabled (no concurrent drops)"
    - "On save failure: reloadTree() restores server order; a warning alert appears above the tree"
    - "Reorder is constrained within same parent — cross-parent drag not possible"
  artifacts:
    - path: "Views/Shared/_Layout.cshtml"
      provides: "SortableJS 1.15.7 CDN script tag"
      contains: "sortablejs@1.15.7"
    - path: "Views/ProtonCatalog/_CatalogTree.cshtml"
      provides: "grip handle column, sortable-row class, data-id, data-sortable-level attributes"
      contains: "drag-handle"
    - path: "Views/ProtonCatalog/Index.cshtml"
      provides: "initSortables(), handleDropEnd(), disableAllSortables(), enableAllSortables(), showReorderError(), CSS for ghost/chosen"
      contains: "initSortables"
  key_links:
    - from: "Views/ProtonCatalog/Index.cshtml initSortables()"
      to: "#treeContainer [data-sortable-level]"
      via: "querySelectorAll + Sortable.create per tbody"
      pattern: "data-sortable-level"
    - from: "Views/ProtonCatalog/Index.cshtml handleDropEnd()"
      to: "/ProtonCatalog/ReorderKompetensi (etc.)"
      via: "postItem() with orderedIds bracket notation"
      pattern: "orderedIds\\["
    - from: "Views/ProtonCatalog/Index.cshtml initCatalogTree()"
      to: "initSortables()"
      via: "direct call at end of initCatalogTree body"
      pattern: "initSortables"
---

<objective>
Add SortableJS drag-and-drop to the three-level Proton Catalog tree: CDN script in _Layout.cshtml, grip handle column in _CatalogTree.cshtml, and initSortables() + supporting functions in Index.cshtml. Followed by human verification.

Purpose: CAT-08 — HC/Admin can drag catalog items to reorder within their level; order persists immediately via AJAX.
Output: Fully working drag-and-drop reorder on all three catalog tree levels.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Views/Shared/_Layout.cshtml
@Views/ProtonCatalog/_CatalogTree.cshtml
@Views/ProtonCatalog/Index.cshtml
@.planning/phases/37-drag-drop-reorder/37-RESEARCH.md
@.planning/phases/37-drag-drop-reorder/37-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SortableJS CDN to _Layout.cshtml and update _CatalogTree.cshtml with grip handles</name>
  <files>Views/Shared/_Layout.cshtml, Views/ProtonCatalog/_CatalogTree.cshtml</files>
  <action>
## _Layout.cshtml

Add SortableJS script tag immediately after the Chart.js CDN line (line ~231). Insert:

```html
<!-- SortableJS (drag-and-drop for Proton Catalog) -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.7/Sortable.min.js"></script>
```

Place it BEFORE the Bootstrap Bundle script (not after). Chart.js is at line 231, jQuery at 234, Bootstrap Bundle at 239. Insert the SortableJS tag between Chart.js and jQuery so it loads before Bootstrap Bundle. Final order: Chart.js → SortableJS → jQuery → Bootstrap Bundle → AOS.

## _CatalogTree.cshtml

The current tree has 3-column colgroups (width:50px, auto, width:50px). Add a NEW first column (width:36px) for the grip handle, making it 4 columns. Apply this to ALL THREE nested table colgroups.

Apply the following changes to the existing _CatalogTree.cshtml structure:

### 1. Outer table colgroup (Kompetensi level) — change from 3 cols to 4:
```html
<colgroup>
    <col style="width:36px;">
    <col style="width:50px;">
    <col>
    <col style="width:50px;">
</colgroup>
```

### 2. Outer tbody — add data-sortable-level attribute:
```html
<tbody data-sortable-level="Kompetensi">
```

### 3. Each Kompetensi data row — add sortable-row class, data-id, and grip cell as FIRST td:
Current: `<tr>`
Change to: `<tr class="sortable-row" data-id="@kompetensi.Id">`

Add as the FIRST `<td>` in this row (before the chevron td):
```html
<td class="align-middle text-center">
    <i class="bi bi-grip-vertical drag-handle d-none text-secondary" style="cursor:grab; font-size:1rem;"></i>
</td>
```

### 4. Kompetensi collapse container row — colspan 3 → 4:
Current: `<tr id="kompetensi-@kompetensi.Id" class="collapse">`
Keep the tr as-is, but its `<td colspan="3" ...>` must become `<td colspan="4" ...>`.

### 5. Inner table colgroup (SubKompetensi level) — change from 3 cols to 4:
```html
<colgroup>
    <col style="width:36px;">
    <col style="width:50px;">
    <col>
    <col style="width:50px;">
</colgroup>
```

### 6. Inner tbody — add data-sortable-level and data-parent-id:
```html
<tbody data-sortable-level="SubKompetensi" data-parent-id="@kompetensi.Id">
```

### 7. Each SubKompetensi data row — add sortable-row class, data-id, and grip cell as FIRST td:
Change to: `<tr class="sortable-row" data-id="@sub.Id">`

Add as FIRST td:
```html
<td class="align-middle text-center">
    <i class="bi bi-grip-vertical drag-handle d-none text-secondary" style="cursor:grab; font-size:1rem;"></i>
</td>
```

### 8. SubKompetensi collapse container row — colspan 3 → 4:
`<td colspan="3" ...>` → `<td colspan="4" ...>`

### 9. Empty-state rows at SubKompetensi level — colspan 3 → 4:
`<td colspan="3" class="py-1">` (the "No SubKompetensi yet" row) → `<td colspan="4" class="py-1">`

### 10. Add SubKompetensi trigger row — colspan 3 → 4:
`<tr class="add-subkompetensi-trigger-row"><td colspan="3" ...>` → `<td colspan="4" ...>`

### 11. Innermost table colgroup (Deliverable level) — change from 3 cols to 4:
```html
<colgroup>
    <col style="width:36px;">
    <col style="width:50px;">
    <col>
    <col style="width:50px;">
</colgroup>
```

### 12. Innermost tbody — add data-sortable-level and data-parent-id:
```html
<tbody data-sortable-level="Deliverable" data-parent-id="@sub.Id">
```

### 13. Each Deliverable data row — add sortable-row class, data-id, and grip cell as FIRST td:
Current: `<tr>` (leaf node, no chevron)
Change to: `<tr class="sortable-row" data-id="@deliverable.Id">`

Current first td: `<td></td>` (empty placeholder for chevron column alignment)
Replace that empty td with the grip cell — Deliverable handles have NO d-none (always visible when parent SubKompetensi is expanded):
```html
<td class="align-middle text-center">
    <i class="bi bi-grip-vertical drag-handle text-secondary" style="cursor:grab; font-size:1rem;"></i>
</td>
```

### 14. Empty-state rows at Deliverable level — colspan 3 → 4:
`<td colspan="3" class="py-1">` (the "No Deliverables yet" row) → `<td colspan="4" class="py-1">`

### 15. Add Deliverable trigger row — colspan 3 → 4:
`<tr class="add-deliverable-trigger-row"><td colspan="3" ...>` → `<td colspan="4" ...>`

### CSS for drag states — add a `<style>` block at the TOP of _CatalogTree.cshtml (before the @if block):
```html
<style>
    .sortable-ghost {
        opacity: 0.3;
        background-color: #e8f4fd;
    }
    .sortable-chosen {
        opacity: 0.8;
    }
    .drag-handle:active {
        cursor: grabbing;
    }
</style>
```

IMPORTANT: After all changes, every `<table>` in _CatalogTree.cshtml must have exactly 4 `<col>` elements in its `<colgroup>`. Every non-data row (collapse containers, empty-state rows, trigger rows) must use colspan="4". Every Kompetensi/SubKompetensi data row must have the grip td with d-none. Deliverable data rows must have the grip td WITHOUT d-none.
  </action>
  <verify>
Run: `dotnet build`
Build must succeed with 0 errors.
Check _Layout.cshtml contains `sortablejs@1.15.7`.
Check _CatalogTree.cshtml contains `drag-handle`, `sortable-row`, `data-sortable-level`, `data-parent-id`, `colspan="4"`.
  </verify>
  <done>
`dotnet build` exits 0. _Layout.cshtml has SortableJS CDN tag. _CatalogTree.cshtml has 4-column colgroups, grip handle tds on all three levels, sortable-row class and data-id on all data rows, data-sortable-level on all three tbodies, colspan="4" on all non-data rows.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add initSortables() and supporting drag functions to Index.cshtml</name>
  <files>Views/ProtonCatalog/Index.cshtml</files>
  <action>
In Index.cshtml, inside the `@section Scripts { <script>` block, make the following changes:

### A. Add module-level variable for Sortable instances

After the opening `<script>` tag and before `function updateDisplayName()`, add:

```javascript
// SortableJS instance registry — destroyed and rebuilt on each initCatalogTree() call
var allSortableInstances = [];
```

### B. Add initSortables(), handleDropEnd(), disableAllSortables(), enableAllSortables(), showReorderError()

Add these five functions AFTER the closing `}` of `initCatalogTree()` (currently at line ~357) and BEFORE `function escapeHtml(str)`:

```javascript
// ── Drag-and-drop reorder (SortableJS) ───────────────────────────────────────

function disableAllSortables() {
    allSortableInstances.forEach(function(s) { s.option('disabled', true); });
}

function enableAllSortables() {
    allSortableInstances.forEach(function(s) { s.option('disabled', false); });
}

function showReorderError(msg) {
    var existing = document.getElementById('reorderAlert');
    if (existing) existing.remove();
    var alertEl = document.createElement('div');
    alertEl.id = 'reorderAlert';
    alertEl.className = 'alert alert-warning alert-dismissible fade show py-2 mb-2 mx-3 mt-2';
    alertEl.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>'
        + escapeHtml(msg)
        + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';
    var treeContainer = document.getElementById('treeContainer');
    if (treeContainer) treeContainer.parentNode.insertBefore(alertEl, treeContainer);
    setTimeout(function() {
        var a = document.getElementById('reorderAlert');
        if (a) { try { bootstrap.Alert.getOrCreateInstance(a).close(); } catch(e) { a.remove(); } }
    }, 4000);
}

function handleDropEnd(evt, level) {
    // Collect current order from DOM after drop (robust — avoids index math with mixed tbody)
    var orderedIds = [];
    evt.to.querySelectorAll('tr.sortable-row').forEach(function(row) {
        orderedIds.push(parseInt(row.dataset.id, 10));
    });

    if (orderedIds.length === 0) { enableAllSortables(); return; }

    var endpointMap = {
        'Kompetensi':    '/ProtonCatalog/ReorderKompetensi',
        'SubKompetensi': '/ProtonCatalog/ReorderSubKompetensi',
        'Deliverable':   '/ProtonCatalog/ReorderDeliverable'
    };

    // Build bracket-notation params for ASP.NET Core int[] model binding
    var params = {};
    orderedIds.forEach(function(id, i) {
        params['orderedIds[' + i + ']'] = id;
    });

    postItem(endpointMap[level], params,
        function() {
            // Success: visual order is already correct — just re-enable
            enableAllSortables();
        },
        function(err) {
            // Failure: restore server order, re-enable, show error
            enableAllSortables();
            reloadTree();
            showReorderError('Gagal menyimpan urutan. ' + (err || ''));
        }
    );
}

function initSortables() {
    // Destroy stale instances from previous tree render (prevents memory leaks after reloadTree)
    allSortableInstances.forEach(function(s) { try { s.destroy(); } catch(e) {} });
    allSortableInstances = [];

    // Initialize one Sortable per [data-sortable-level] tbody
    document.querySelectorAll('#treeContainer [data-sortable-level]').forEach(function(tbody) {
        var level = tbody.dataset.sortableLevel;
        var s = Sortable.create(tbody, {
            handle: '.drag-handle',
            draggable: 'tr.sortable-row',
            animation: 150,
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            onEnd: function(evt) {
                disableAllSortables();
                handleDropEnd(evt, level);
            }
        });
        allSortableInstances.push(s);
    });
}
```

### C. Add grip handle reveal/hide to initCatalogTree()

In `initCatalogTree()`, after the block that wires pencil-btn show/hide (the second `querySelectorAll('#treeContainer [data-bs-toggle="collapse"]').forEach` block, ending around line ~260), add a new block for the drag-handle:

```javascript
// Grip handle: show when row expanded, hide when collapsed (same pattern as pencil/trash)
document.querySelectorAll('#treeContainer [data-bs-toggle="collapse"]').forEach(function (btn) {
    var row = btn.closest('tr');
    if (!row) return;
    var handle = row.querySelector('.drag-handle');
    if (!handle) return;
    var targetId = btn.getAttribute('data-bs-target').replace('#', '');
    var target = document.getElementById(targetId);
    if (!target) return;
    target.addEventListener('show.bs.collapse', function (e) {
        if (e.target !== target) return;
        handle.classList.remove('d-none');
    });
    target.addEventListener('hide.bs.collapse', function (e) {
        if (e.target !== target) return;
        handle.classList.add('d-none');
    });
});
```

### D. Call initSortables() at the END of initCatalogTree()

The current end of `initCatalogTree()` is the closing `}` after the "Edit (pencil click)" block (line ~357). Add the call to initSortables() BEFORE that final `}`:

```javascript
    // Initialize drag-and-drop sortables
    initSortables();
}
```

This ensures initSortables() is called:
- On DOMContentLoaded (initCatalogTree is called there)
- After reloadTree() (which calls initCatalogTree after innerHTML)
- After onTrackChanged() (which calls initCatalogTree after innerHTML)

No additional call sites needed — initCatalogTree() already covers all three.

IMPORTANT: The escapeHtml() function referenced in showReorderError() already exists in Index.cshtml (defined in the separator section below initDeleteGuards). Do NOT duplicate it. Verify by searching for `function escapeHtml` — it should appear exactly once.
  </action>
  <verify>
Run: `dotnet build`
Build must succeed with 0 errors.
Check Index.cshtml contains: `allSortableInstances`, `initSortables`, `handleDropEnd`, `disableAllSortables`, `enableAllSortables`, `showReorderError`, `drag-handle` (in collapse event wiring), `initSortables()` call inside initCatalogTree.
Check `function escapeHtml` appears exactly once.
  </verify>
  <done>
`dotnet build` exits 0. Index.cshtml contains all five new functions plus the grip-handle collapse wiring block and the initSortables() call at the end of initCatalogTree(). escapeHtml appears exactly once. The module-level `allSortableInstances = []` variable is declared at script scope.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Human verification — drag-and-drop reorder end-to-end</name>
  <files>N/A — human verification only, no files modified</files>
  <action>Human verifies the drag-and-drop reorder feature works end-to-end in the browser. See how-to-verify steps.</action>
  <verify>Human confirms all six verification tests pass (see how-to-verify).</verify>
  <done>All three catalog levels can be reordered by drag; order persists after page reload; grip handles appear/disappear correctly; cross-level drag not possible.</done>
  <what-built>
SortableJS drag-and-drop on all three catalog tree levels (Kompetensi, SubKompetensi, Deliverable). Grip handles reveal on expand (Kompetensi/SubKompetensi) or are always visible (Deliverable). Drop fires AJAX POST immediately; success is silent; failure calls reloadTree() and shows a warning alert. In-flight lock prevents concurrent drags.
  </what-built>
  <how-to-verify>
Run the app (`dotnet run` or F5 in VS). Navigate to CDP → Proton Catalog (HC or Admin role).

**Test 1: Grip handle visibility**
1. Select any track from the dropdown — tree loads.
2. Before expanding any row: confirm no grip handles are visible on Kompetensi rows.
3. Expand a Kompetensi row — confirm the grip handle (bi-grip-vertical icon) appears on that Kompetensi row.
4. Collapse the row — confirm the grip handle disappears.
5. With the Kompetensi expanded, expand a SubKompetensi — confirm a grip handle appears on the SubKompetensi row.
6. Confirm Deliverable rows show their grip handle (always visible, no expand needed) when the SubKompetensi is expanded.

**Test 2: Drag Kompetensi reorder (requires 2+ Kompetensi in a track)**
1. Note the current order of Kompetensi rows.
2. Drag a Kompetensi row (using the grip handle) — confirm faded ghost remains in original position while dragging; a blue-tinted placeholder gap shows the drop target.
3. Drop the row in a new position — confirm visual order updates immediately.
4. Reload the page — confirm the new order persists (Urutan was saved).

**Test 3: Drag SubKompetensi reorder (requires 2+ SubKompetensi in a Kompetensi)**
1. Expand a Kompetensi to see its SubKompetensi rows.
2. Drag a SubKompetensi row to a new position — visual update on drop.
3. Reload page — confirm SubKompetensi order persisted.

**Test 4: Drag Deliverable reorder (requires 2+ Deliverables in a SubKompetensi)**
1. Expand a Kompetensi, then expand a SubKompetensi to see Deliverables.
2. Drag a Deliverable row — confirm drag works without needing to collapse.
3. Drop in new position — visual update.
4. Reload page — confirm Deliverable order persisted.

**Test 5: Cross-level constraint**
1. Confirm you cannot drag a Kompetensi row into a SubKompetensi section and vice versa — each SortableJS instance only accepts drops within its own tbody.

**Test 6: Cursor styles**
1. Hover over a grip handle — confirm cursor shows grab (hand icon).
2. While dragging — confirm cursor shows grabbing.
  </how-to-verify>
  <resume-signal>Type "approved" to proceed, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
- `dotnet build` passes (0 errors)
- _Layout.cshtml: SortableJS 1.15.7 CDN tag present
- _CatalogTree.cshtml: 4-column colgroups on all three table levels; drag-handle icon in first td of each data row; Kompetensi/SubKompetensi handles have d-none; Deliverable handles have no d-none; data-sortable-level on all three tbodies; sortable-row class and data-id on all data rows; colspan="4" on all non-data rows
- Index.cshtml: allSortableInstances variable at script scope; initSortables(), handleDropEnd(), disableAllSortables(), enableAllSortables(), showReorderError() all defined; grip-handle collapse wiring block inside initCatalogTree(); initSortables() called at end of initCatalogTree(); escapeHtml appears exactly once
- Human verification: handles visible correctly; drag reorders all three levels; order persists after page reload; cross-level drag not possible
</verification>

<success_criteria>
CAT-08 complete: HC/Admin can drag Kompetensi, SubKompetensi, and Deliverable rows within their level. New order persists immediately (AJAX POST) and survives page reload. Grip handles appear/disappear correctly per level rules. Failed saves trigger reloadTree() and show an auto-dismiss warning alert.
</success_criteria>

<output>
After completion, create `.planning/phases/37-drag-drop-reorder/37-02-SUMMARY.md`
</output>
