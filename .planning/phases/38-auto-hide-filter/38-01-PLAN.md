---
phase: 38-auto-hide-filter
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Controllers/CMPController.cs
autonomous: true

must_haves:
  truths:
    - "An assessment group whose ExamWindowCloseDate (or Schedule fallback) was 8+ days ago does not appear in the Monitoring tab"
    - "The same group is absent from the Management tab — both tabs apply an identical 7-day cutoff"
    - "An assessment group with no ExamWindowCloseDate falls back to Schedule for the 7-day calculation — it is not permanently pinned"
    - "An assessment group closed exactly 7 days ago is still visible; it disappears only on day 8"
  artifacts:
    - path: "Controllers/CMPController.cs"
      provides: "7-day auto-hide filter on both Management branch and GetMonitorData"
      contains: "sevenDaysAgo"
  key_links:
    - from: "Management branch (line ~115)"
      to: "managementQuery WHERE clause"
      via: "(a.ExamWindowCloseDate ?? a.Schedule) >= sevenDaysAgo"
      pattern: "ExamWindowCloseDate.*Schedule.*sevenDaysAgo"
    - from: "GetMonitorData (line ~285)"
      to: "monitorSessions WHERE clause"
      via: "&& (a.ExamWindowCloseDate ?? a.Schedule) >= sevenDaysAgo"
      pattern: "ExamWindowCloseDate.*Schedule.*sevenDaysAgo"
---

<objective>
Add a 7-day auto-hide filter to both the Management tab and the Monitoring tab so that assessment groups whose exam window closed more than 7 days ago disappear automatically from both views. HC no longer sees stale completed assessments cluttering the active list.

Purpose: ASSESS-02 and ASSESS-03 — keep both tabs focused on recent/active assessment groups.
Output: CMPController.cs with two WHERE-clause additions (one per code path). No frontend changes.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-auto-hide-filter/38-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add 7-day cutoff to Management branch</name>
  <files>Controllers/CMPController.cs</files>
  <action>
In `Controllers/CMPController.cs`, inside the Management branch that begins at line 112 (`if (view == "manage" && isHCAccess)`):

1. After line 113 (the opening brace of the if block), insert:
   ```csharp
   var sevenDaysAgo = DateTime.UtcNow.AddDays(-7);
   ```

2. Change the `managementQuery` initialization at line 115-116 from:
   ```csharp
   var managementQuery = _context.AssessmentSessions
       .AsQueryable();
   ```
   to:
   ```csharp
   var managementQuery = _context.AssessmentSessions
       .Where(a => (a.ExamWindowCloseDate ?? a.Schedule) >= sevenDaysAgo)
       .AsQueryable();
   ```

The 7-day WHERE must come BEFORE the optional search `.Where(...)` at line 118, and BEFORE `.ToListAsync()` at line 152 — it must execute as SQL, not in-memory.

Use `DateTime.UtcNow` (not `DateTime.Now`) — consistent with existing code and database stores UTC.

The null-coalescing `??` translates to SQL COALESCE. `Schedule` is non-nullable on `AssessmentSession` so the fallback is always safe.

Do NOT add `ExamWindowCloseDate` to the `Select` projection at lines 136-151 — the filter runs at the database level before projection, so it does not need to be projected.
  </action>
  <verify>Build the project: `dotnet build`. Confirm zero errors. Confirm `sevenDaysAgo` appears in the Management branch section (lines ~112-198) and the WHERE filter uses `ExamWindowCloseDate ?? a.Schedule`.</verify>
  <done>Management branch WHERE clause includes `(a.ExamWindowCloseDate ?? a.Schedule) >= sevenDaysAgo` and the project builds without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Add 7-day cutoff to GetMonitorData</name>
  <files>Controllers/CMPController.cs</files>
  <action>
In `Controllers/CMPController.cs`, inside `GetMonitorData()` which begins at line 277:

1. After line 285 (`var cutoff = DateTime.UtcNow.AddDays(-30);`), add:
   ```csharp
   var sevenDaysAgo = DateTime.UtcNow.AddDays(-7);
   ```

2. Extend the existing WHERE clause on `monitorSessions` (lines 287-291) to add a top-level AND condition. The current clause is:
   ```csharp
   .Where(a => a.Status == "Open"
            || a.Status == "InProgress"
            || a.Status == "Abandoned"
            || a.Status == "Upcoming"
            || (a.Status == "Completed" && a.CompletedAt != null && a.CompletedAt >= cutoff))
   ```
   Change it to:
   ```csharp
   .Where(a => ((a.ExamWindowCloseDate ?? a.Schedule) >= sevenDaysAgo)
            && (a.Status == "Open"
             || a.Status == "InProgress"
             || a.Status == "Abandoned"
             || a.Status == "Upcoming"
             || (a.Status == "Completed" && a.CompletedAt != null && a.CompletedAt >= cutoff)))
   ```

The 7-day condition is a top-level AND wrapping the entire existing status OR block — it must not be inserted inside the OR chain. This ensures every session (regardless of status) is filtered by the exam window cutoff before grouping.

The filter must be part of the `.Where(...)` that runs before `.ToListAsync()` at line 306 — not after.
  </action>
  <verify>Build the project: `dotnet build`. Confirm zero errors. Confirm `sevenDaysAgo` appears in `GetMonitorData()` (lines ~277-379) and the WHERE clause has the 7-day condition as the outermost AND before the status OR block.</verify>
  <done>GetMonitorData WHERE clause includes `(a.ExamWindowCloseDate ?? a.Schedule) >= sevenDaysAgo` as a top-level AND, the project builds without errors, and the existing status filter is fully preserved inside the OR group.</done>
</task>

</tasks>

<verification>
After both tasks:

1. `dotnet build` — zero errors, zero warnings introduced.
2. Grep confirms both insertions:
   - `grep -n "sevenDaysAgo" Controllers/CMPController.cs` — should return at least 4 lines (declaration + usage in each branch).
   - `grep -n "ExamWindowCloseDate.*Schedule" Controllers/CMPController.cs` — should return 2 lines (one per branch).
3. Confirm Task 1 filter is at the `managementQuery` initialization (before the search Where), not after `ToListAsync`.
4. Confirm Task 2 filter wraps the OR status block as a top-level AND (parentheses verify this).
</verification>

<success_criteria>
- Management tab: assessment groups whose `(ExamWindowCloseDate ?? Schedule)` was more than 7 days ago are excluded from the SQL query and do not appear in the paginated list.
- Monitoring tab: same groups are excluded from `GetMonitorData()` and do not appear in the monitoring JSON response.
- Groups with no `ExamWindowCloseDate` use `Schedule` as the cutoff date — they are not permanently visible.
- A group closed exactly 7 days ago (today - 7 days) satisfies `>= sevenDaysAgo` and remains visible.
- No frontend changes. No migration. No model changes. Single file modified: `Controllers/CMPController.cs`.
</success_criteria>

<output>
After completion, create `.planning/phases/38-auto-hide-filter/38-01-SUMMARY.md` using the summary template.
</output>
