---
phase: 39-close-early
plan: 02
type: execute
wave: 2
depends_on: ["39-01"]
files_modified:
  - Views/CMP/AssessmentMonitoringDetail.cshtml
autonomous: false

must_haves:
  truths:
    - "HC sees a 'Tutup Lebih Awal' button (btn-warning) in the AssessmentMonitoringDetail header only when Model.GroupStatus == 'Open'"
    - "The button is absent (not rendered) when GroupStatus is 'Upcoming' or 'Closed'"
    - "Clicking the button opens a Bootstrap modal (not inline confirm()) with an Indonesian warning message explaining what will happen"
    - "The modal has a 'Tutup Lebih Awal' confirm button that submits a POST form to the CloseEarly action with antiforgery token, title, category, and scheduleDate hidden inputs"
    - "After confirming and submitting, HC is redirected to the same AssessmentMonitoringDetail page showing a success alert with updated statuses and scores"
  artifacts:
    - path: "Views/CMP/AssessmentMonitoringDetail.cshtml"
      provides: "Tutup Lebih Awal button + confirmation modal"
      contains: "closeEarlyModal"
  key_links:
    - from: "Tutup Lebih Awal button"
      to: "CloseEarly action"
      via: "Bootstrap modal confirm -> form POST with asp-action='CloseEarly'"
      pattern: "asp-action.*CloseEarly"
    - from: "closeEarlyModal"
      to: "GroupStatus == 'Open' condition"
      via: "Razor @if block controlling button visibility"
      pattern: "Model\\.GroupStatus.*Open"
---

<objective>
Add the "Tutup Lebih Awal" button and confirmation modal to AssessmentMonitoringDetail.cshtml. The button is visible only for Open groups (HC/Admin only by virtue of the page's controller [Authorize(Roles="Admin, HC")] — no additional role check needed in the view). The Bootstrap modal provides a clear Indonesian warning message before the HC confirms. The form POSTs to the CloseEarly action added in plan 39-01. Ends with a human verification checkpoint.

Purpose: HC needs a clear, safe UI to trigger CloseEarly — using a Bootstrap modal (not inline confirm()) gives more space for a descriptive warning matching the established pattern used in other modals on this page.
Output: Modified AssessmentMonitoringDetail.cshtml with button and modal.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-close-early/39-01-SUMMARY.md
@Views/CMP/AssessmentMonitoringDetail.cshtml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add "Tutup Lebih Awal" button and Bootstrap modal to AssessmentMonitoringDetail.cshtml</name>
  <files>Views/CMP/AssessmentMonitoringDetail.cshtml</files>
  <action>
Two changes to the view:

**Change 1 — Add "Tutup Lebih Awal" button in the button row header (around line 117, BEFORE the ForceCloseAll form).**

The current button row (lines 107-135) has: Export Results form | ForceCloseAll form | [Reshuffle All conditional].

Insert the CloseEarly button between Export Results and ForceCloseAll. Use `@if (Model.GroupStatus == "Open")` to conditionally render it — do NOT render it for Upcoming or Closed groups.

```razor
@if (Model.GroupStatus == "Open")
{
    <!-- Close Early: triggers Bootstrap modal confirmation -->
    <button type="button" class="btn btn-warning btn-sm"
            data-bs-toggle="modal" data-bs-target="#closeEarlyModal">
        <i class="bi bi-clock-history me-1"></i>Tutup Lebih Awal
    </button>
}
```

Note: This is a plain `<button>` that triggers the modal, NOT a form submit button. The form is inside the modal (see Change 2).

**Change 2 — Add the Bootstrap confirmation modal and its hidden POST form.**

Add this modal HTML before the closing `</div>` of the `container-fluid` div (around line 296, after the existing reshuffleResultModal closing `}` block). Place it outside any `@if (Model.IsPackageMode)` condition so it always renders when GroupStatus could be Open.

```razor
@if (Model.GroupStatus == "Open")
{
    <!-- Close Early Confirmation Modal -->
    <div class="modal fade" id="closeEarlyModal" tabindex="-1" aria-labelledby="closeEarlyModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title fw-semibold" id="closeEarlyModalLabel">
                        <i class="bi bi-clock-history me-2"></i>Tutup Lebih Awal
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-2">Tindakan ini akan <strong>menutup grup ujian "@Model.Title" lebih awal</strong> secara permanen dan tidak dapat dibatalkan.</p>
                    <ul class="mb-2">
                        <li><strong>Peserta yang sedang mengerjakan (InProgress)</strong> akan diberi skor berdasarkan jawaban yang sudah mereka kirimkan.</li>
                        <li><strong>Peserta yang belum mulai (Not Started)</strong> akan dikunci dan tidak dapat mengakses ujian.</li>
                        <li>Peserta yang sudah selesai tidak akan terpengaruh.</li>
                    </ul>
                    <p class="text-danger mb-0"><i class="bi bi-exclamation-triangle-fill me-1"></i>Apakah Anda yakin ingin menutup ujian ini lebih awal?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <form asp-action="CloseEarly" method="post" class="d-inline">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="title" value="@Model.Title" />
                        <input type="hidden" name="category" value="@Model.Category" />
                        <input type="hidden" name="scheduleDate" value="@Model.Schedule.ToString("yyyy-MM-dd")" />
                        <button type="submit" class="btn btn-warning">
                            <i class="bi bi-clock-history me-1"></i>Ya, Tutup Lebih Awal
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
}
```

**Placement notes:**
- The trigger `<button>` in Change 1 goes inside the existing `<div class="d-flex gap-2 align-items-center">` at line 107, BEFORE the ForceCloseAll `<form>` element.
- The modal `<div>` in Change 2 goes at the bottom of the container-fluid div, after the existing reshuffleResultModal block and before the closing `</div>` of container-fluid.
- Both additions are wrapped in `@if (Model.GroupStatus == "Open")` — the modal only needs to exist in the DOM when the button is shown.
- The antiforgery token `@Html.AntiForgeryToken()` is required inside the form (same pattern as ForceCloseAll at line 120).
- The modal header uses `bg-warning` class to distinguish from the `btn-danger` of ForceCloseAll visually.
  </action>
  <verify>
Run `dotnet build` to confirm no Razor compilation errors. Then:
1. `grep -n "closeEarlyModal\|CloseEarly\|Tutup Lebih Awal" Views/CMP/AssessmentMonitoringDetail.cshtml` — must show the button trigger, modal div, asp-action="CloseEarly", and Indonesian text.
2. `grep -n "GroupStatus.*Open\|Open.*GroupStatus" Views/CMP/AssessmentMonitoringDetail.cshtml` — must show the @if condition wrapping the button and modal.
3. `grep -n "AntiForgeryToken" Views/CMP/AssessmentMonitoringDetail.cshtml` — must show the token is inside the CloseEarly form in the modal footer.
  </verify>
  <done>
`dotnet build` succeeds with 0 errors. The view contains: a "Tutup Lebih Awal" btn-warning trigger button visible only when GroupStatus == "Open", a Bootstrap modal with id="closeEarlyModal" containing Indonesian warning text and a POST form with antiforgery token targeting the CloseEarly action with title/category/scheduleDate hidden inputs.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify CloseEarly end-to-end flow in the running app</name>
  <files>Views/CMP/AssessmentMonitoringDetail.cshtml, Controllers/CMPController.cs</files>
  <action>
This is a human verification checkpoint. All implementation was completed in Task 1 (this plan) and Plan 39-01. This task confirms the end-to-end CloseEarly workflow functions correctly in the browser.
  </action>
  <what-built>
    - CloseEarly POST action in CMPController (plan 39-01): scores InProgress sessions from actual answers, sets ExamWindowCloseDate on all sessions, updates competency levels, writes audit log
    - "Tutup Lebih Awal" btn-warning button in AssessmentMonitoringDetail header (Open groups only)
    - Bootstrap modal with Indonesian warning explaining InProgress scoring and NotStarted lockout
    - POST form in modal footer targeting CloseEarly with antiforgery token
  </what-built>
  <how-to-verify>
    1. Start the app (`dotnet run` or your usual dev server).
    2. Navigate to AssessmentMonitoringDetail for an OPEN assessment group (GroupStatus = "Open").
       Expected: "Tutup Lebih Awal" warning-yellow button appears in the header button row, BEFORE "Force Close All".
    3. Navigate to AssessmentMonitoringDetail for a CLOSED or UPCOMING group.
       Expected: "Tutup Lebih Awal" button is NOT shown.
    4. Return to the Open group. Click "Tutup Lebih Awal".
       Expected: Bootstrap modal opens with title "Tutup Lebih Awal", warning text in Indonesian listing the three bullet points about InProgress/NotStarted/Completed behavior, a "Batal" cancel button, and a warning-yellow "Ya, Tutup Lebih Awal" confirm button.
    5. Click "Batal".
       Expected: Modal closes, no action taken, page is unchanged.
    6. If you have a test assessment group with InProgress sessions: click "Tutup Lebih Awal" again and confirm with "Ya, Tutup Lebih Awal".
       Expected: Page reloads showing a green success alert like "Assessment group ditutup lebih awal. X sesi diberi skor berdasarkan jawaban yang sudah dikerjakan."
       Expected: InProgress workers now show Status = "Completed" with a calculated score (not 0 if they answered any questions).
       Expected: Not Started workers still show "Not Started" status with no score.
    7. Check the Audit Log page (if accessible): an entry with ActionType = "CloseEarly" should be present for the action.
  </how-to-verify>
  <verify>Verified by human tester — see how-to-verify steps above.</verify>
  <done>Human tester confirms: "Tutup Lebih Awal" button visible only for Open groups; modal opens with correct Indonesian text; cancel works; confirm redirects with success alert; InProgress sessions show Completed with calculated score; NotStarted sessions remain unchanged.</done>
  <resume-signal>Type "approved" if everything matches, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
1. `dotnet build` — 0 errors
2. "Tutup Lebih Awal" button visible only for Open groups in AssessmentMonitoringDetail header
3. Bootstrap modal opens on click with correct Indonesian warning text
4. Cancelling modal takes no action
5. Confirming POST redirects back to same detail page with success message
6. InProgress sessions show Completed status + calculated score (not Score=0)
7. NotStarted sessions remain Not Started (locked out via ExamWindowCloseDate)
8. Audit log entry exists with ActionType="CloseEarly"
</verification>

<success_criteria>
- "Tutup Lebih Awal" button rendered with btn-warning in header, inside @if (Model.GroupStatus == "Open") block
- Modal id="closeEarlyModal" with bg-warning header, Indonesian 3-bullet warning body, Batal cancel + Ya confirm buttons
- Confirm button is a form submit inside the modal footer, not a JS fetch — POST with antiforgery token, title, category, scheduleDate hidden inputs
- Clicking confirm POSTs to CloseEarly action and redirects to same page with TempData["Success"] alert
- After CloseEarly: InProgress workers show Completed + score; NotStarted workers remain Not Started
- Human verification passed
</success_criteria>

<output>
After completion, create `.planning/phases/39-close-early/39-02-SUMMARY.md`
</output>
