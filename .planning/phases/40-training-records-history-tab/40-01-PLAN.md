---
phase: 40-training-records-history-tab
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Models/AllWorkersHistoryRow.cs
  - Models/RecordsWorkerListViewModel.cs
  - Controllers/CMPController.cs
autonomous: false

must_haves:
  truths:
    - "Records() action returns a RecordsWorkerListViewModel (not a raw List<WorkerTrainingStatus>) for HC/Admin/Supervisor paths"
    - "GetAllWorkersHistory() queries all TrainingRecords and all AssessmentSessions where Status=='Completed', includes User nav property on both"
    - "History rows are sorted by (TanggalMulai ?? Tanggal) descending for training rows and (CompletedAt ?? Schedule) descending for assessment rows — merged and re-sorted"
    - "AllWorkersHistoryRow carries WorkerName, NIP, RecordType, Title, Date, Penyelenggara (nullable), Score (nullable), IsPassed (nullable)"
    - "Both return View('RecordsWorkerList', ...) call sites in Records() pass RecordsWorkerListViewModel"
  artifacts:
    - path: "Models/AllWorkersHistoryRow.cs"
      provides: "Flat projection for one history event across all workers"
      contains: "class AllWorkersHistoryRow"
    - path: "Models/RecordsWorkerListViewModel.cs"
      provides: "Wrapper ViewModel combining Workers list and History list"
      contains: "class RecordsWorkerListViewModel"
    - path: "Controllers/CMPController.cs"
      provides: "GetAllWorkersHistory() helper + updated Records() return points"
      contains: "GetAllWorkersHistory"
  key_links:
    - from: "Controllers/CMPController.cs (Records action)"
      to: "Models/RecordsWorkerListViewModel.cs"
      via: "return View('RecordsWorkerList', new RecordsWorkerListViewModel { Workers = workers, History = await GetAllWorkersHistory() })"
      pattern: "RecordsWorkerListViewModel"
    - from: "Controllers/CMPController.cs (GetAllWorkersHistory)"
      to: "_context.AssessmentSessions"
      via: ".Include(a => a.User).Where(a => a.Status == 'Completed')"
      pattern: "a\\.Status == \"Completed\""
    - from: "Controllers/CMPController.cs (GetAllWorkersHistory)"
      to: "_context.TrainingRecords"
      via: ".Include(t => t.User)"
      pattern: "Include.*User"
---

<objective>
Create the two new model files (AllWorkersHistoryRow, RecordsWorkerListViewModel) and extend CMPController with GetAllWorkersHistory() helper; update both return points in Records() to pass the wrapper ViewModel.

Purpose: The frontend tab (Plan 02) cannot be built without typed data flowing from the controller. This plan provides the full data pipeline: query → merge → sort → ViewModel.
Output: AllWorkersHistoryRow.cs, RecordsWorkerListViewModel.cs, updated CMPController.cs
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-training-records-history-tab/40-RESEARCH.md

# Source files — read before writing
@Models/CDPDashboardViewModel.cs
@Models/WorkerTrainingStatus.cs
@Models/UnifiedTrainingRecord.cs
@Controllers/CMPController.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AllWorkersHistoryRow and RecordsWorkerListViewModel</name>
  <files>
    Models/AllWorkersHistoryRow.cs
    Models/RecordsWorkerListViewModel.cs
  </files>
  <action>
    Create Models/AllWorkersHistoryRow.cs:

    ```csharp
    namespace HcPortal.Models;

    /// <summary>
    /// Flat projection for one training event across all workers.
    /// Used in the History tab of RecordsWorkerList (Phase 40).
    /// </summary>
    public class AllWorkersHistoryRow
    {
        public string WorkerName { get; set; } = "";
        public string? WorkerNIP { get; set; }

        // "Manual" or "Assessment Online"
        public string RecordType { get; set; } = "";

        public string Title { get; set; } = "";

        // Sort key: TanggalMulai ?? Tanggal (training) or CompletedAt ?? Schedule (assessment)
        public DateTime Date { get; set; }

        // Manual-only
        public string? Penyelenggara { get; set; }

        // Assessment-only
        public int? Score { get; set; }
        public bool? IsPassed { get; set; }
    }
    ```

    Create Models/RecordsWorkerListViewModel.cs:

    ```csharp
    namespace HcPortal.Models;

    /// <summary>
    /// Wrapper ViewModel for RecordsWorkerList view (Phase 40).
    /// Mirrors CDPDashboardViewModel pattern — wraps two sub-lists.
    /// </summary>
    public class RecordsWorkerListViewModel
    {
        // Existing worker-list tab data (was the entire model before Phase 40)
        public List<WorkerTrainingStatus> Workers { get; set; } = new();

        // New History tab data — all workers, merged, sorted by Date descending
        public List<AllWorkersHistoryRow> History { get; set; } = new();
    }
    ```

    Pattern reference: Models/CDPDashboardViewModel.cs (wrapper with sub-lists).
  </action>
  <verify>
    Run: dotnet build
    Expected: 0 errors. Both new model files compile cleanly. No warnings about missing namespaces.
  </verify>
  <done>
    AllWorkersHistoryRow.cs and RecordsWorkerListViewModel.cs exist under Models/.
    `dotnet build` passes with 0 errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add GetAllWorkersHistory() and update Records() return points in CMPController</name>
  <files>
    Controllers/CMPController.cs
  </files>
  <action>
    Read Controllers/CMPController.cs in full before editing. Focus on:
    - Records() action at lines 2099-2156 — TWO return View("RecordsWorkerList", ...) call sites
    - GetUnifiedRecords() helper at lines 2412-2460 — template for GetAllWorkersHistory()

    STEP A — Add GetAllWorkersHistory() private async helper.
    Place it directly after GetUnifiedRecords() (after line 2460). Do NOT modify GetUnifiedRecords().

    ```csharp
    // Phase 40: all-workers history helper — merges TrainingRecords + completed AssessmentSessions across all workers
    private async Task<List<AllWorkersHistoryRow>> GetAllWorkersHistory()
    {
        // Query 1: All completed assessment sessions with User nav property
        var assessments = await _context.AssessmentSessions
            .Include(a => a.User)
            .Where(a => a.Status == "Completed")
            .ToListAsync();

        // Query 2: All training records with User nav property
        var trainings = await _context.TrainingRecords
            .Include(t => t.User)
            .ToListAsync();

        var rows = new List<AllWorkersHistoryRow>();

        rows.AddRange(assessments.Select(a => new AllWorkersHistoryRow
        {
            WorkerName  = a.User?.FullName ?? a.UserId,
            WorkerNIP   = a.User?.NIP,
            RecordType  = "Assessment Online",
            Title       = a.Title ?? "",
            Date        = a.CompletedAt ?? a.Schedule,
            Score       = a.Score,
            IsPassed    = a.IsPassed
        }));

        rows.AddRange(trainings.Select(t => new AllWorkersHistoryRow
        {
            WorkerName   = t.User?.FullName ?? t.UserId,
            WorkerNIP    = t.User?.NIP,
            RecordType   = "Manual",
            Title        = t.Judul ?? "",
            // PITFALL: TanggalMulai is nullable — must coalesce to Tanggal
            Date         = t.TanggalMulai ?? t.Tanggal,
            Penyelenggara = t.Penyelenggara
        }));

        return rows
            .OrderByDescending(r => r.Date)
            .ToList();
    }
    ```

    STEP B — Update Records() action (lines 2099-2156).
    There are EXACTLY TWO return View("RecordsWorkerList", ...) call sites:
      1. Line ~2148: `return View("RecordsWorkerList", workers);`  (initial state — empty list)
      2. Line ~2155: `return View("RecordsWorkerList", workers);`  (filtered list)

    Replace BOTH with the wrapper ViewModel. The history list is always fully loaded regardless of filter state (it has no filters in this phase):

    ```csharp
    // Replace the initial-state return:
    return View("RecordsWorkerList", new RecordsWorkerListViewModel
    {
        Workers = workers,
        History = await GetAllWorkersHistory()
    });

    // Replace the filtered return (identical wrapper, workers is already populated):
    return View("RecordsWorkerList", new RecordsWorkerListViewModel
    {
        Workers = workers,
        History = await GetAllWorkersHistory()
    });
    ```

    PITFALL: Do NOT change the early return for Coach/Coachee at line ~2137:
    `return View("Records", unified);` — this returns a different view (Records.cshtml) and must remain untouched.

    After editing, RecordsWorkerList.cshtml will fail to compile because its @model directive still says `List<WorkerTrainingStatus>`. That is intentional — Plan 02 fixes the view. The controller itself should compile cleanly because Views are not compiled during `dotnet build` by default (Razor views compile at runtime).
  </action>
  <verify>
    Run: dotnet build
    Expected: 0 errors. The new GetAllWorkersHistory() compiles. Verify with grep:
      grep -n "GetAllWorkersHistory" Controllers/CMPController.cs
    Expected: 3 matches — the method definition + two call sites in Records().
  </verify>
  <done>
    `dotnet build` passes with 0 errors.
    `grep -c "GetAllWorkersHistory" Controllers/CMPController.cs` returns 3.
    Records() has no bare `return View("RecordsWorkerList", workers)` remaining (grep returns 0 for that pattern).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify backend compiles and data shape is correct</name>
  <files>Controllers/CMPController.cs</files>
  <action>Human verifies compilation and controller structure per how-to-verify steps below.</action>
  <verify>See how-to-verify steps below.</verify>
  <done>User types "approved" confirming 0 build errors and GetAllWorkersHistory appears 3 times in CMPController.cs.</done>
  <what-built>
    Two new model classes (AllWorkersHistoryRow, RecordsWorkerListViewModel) and a GetAllWorkersHistory() helper in CMPController. Records() now passes RecordsWorkerListViewModel to RecordsWorkerList view at both return points.
  </what-built>
  <how-to-verify>
    1. Run `dotnet build` in the project root — confirm 0 errors, 0 unexpected warnings.
    2. Check Models/ directory contains AllWorkersHistoryRow.cs and RecordsWorkerListViewModel.cs.
    3. Open Controllers/CMPController.cs and search for "GetAllWorkersHistory" — should appear 3 times (1 definition + 2 call sites).
    4. Confirm Records() no longer contains `return View("RecordsWorkerList", workers)` with a plain List — both returns now wrap a RecordsWorkerListViewModel.
    5. The application does NOT need to run yet — Plan 02 will update the view. If you do run it and navigate to Records, a runtime Razor compile error on RecordsWorkerList.cshtml is expected and normal at this stage.
  </how-to-verify>
  <resume-signal>Type "approved" to proceed to Plan 02, or describe any compilation errors.</resume-signal>
</task>

</tasks>

<verification>
- `dotnet build` returns 0 errors after both auto tasks complete
- grep confirms GetAllWorkersHistory appears exactly 3 times in CMPController.cs
- Both model files exist under Models/
- No bare `return View("RecordsWorkerList", workers)` (plain list) remains in Records()
</verification>

<success_criteria>
RecordsWorkerListViewModel flows from Records() to the view with both Workers and History populated. The controller is ready for Plan 02 to consume Model.Workers and Model.History in the Razor view.
</success_criteria>

<output>
After completion, create `.planning/phases/40-training-records-history-tab/40-01-SUMMARY.md`
</output>
