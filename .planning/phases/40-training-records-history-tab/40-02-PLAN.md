---
phase: 40-training-records-history-tab
plan: 02
type: execute
wave: 2
depends_on: ["40-01"]
files_modified:
  - Views/CMP/RecordsWorkerList.cshtml
autonomous: false

must_haves:
  truths:
    - "RecordsWorkerList page shows two Bootstrap tabs: the existing worker-list tab and a new 'History' tab"
    - "History tab renders one row per training event with columns: Worker Name, NIP, Type badge (Manual/Assessment Online), Title, Tanggal Mulai, Penyelenggara, Score, Pass/Fail"
    - "History tab rows are already sorted descending by date (controller sorts them) — the view renders them as-is"
    - "Clicking the History tab URL-persists ?activeTab=history so a page reload lands on the History tab"
    - "The existing worker-list tab (filter form + table) is fully preserved and still functional after the ViewModel switch from List<WorkerTrainingStatus> to Model.Workers"
  artifacts:
    - path: "Views/CMP/RecordsWorkerList.cshtml"
      provides: "Tab strip, worker-list pane, history pane"
      contains: "activeTab=history"
    - path: "Views/CMP/RecordsWorkerList.cshtml"
      provides: "History table"
      contains: "Model.History"
  key_links:
    - from: "Views/CMP/RecordsWorkerList.cshtml (@model directive)"
      to: "Models/RecordsWorkerListViewModel.cs"
      via: "@model HcPortal.Models.RecordsWorkerListViewModel"
      pattern: "@model HcPortal\\.Models\\.RecordsWorkerListViewModel"
    - from: "Views/CMP/RecordsWorkerList.cshtml (worker table loop)"
      to: "Model.Workers"
      via: "@foreach (var worker in Model.Workers)"
      pattern: "Model\\.Workers"
    - from: "Views/CMP/RecordsWorkerList.cshtml (history table loop)"
      to: "Model.History"
      via: "@foreach (var row in Model.History)"
      pattern: "Model\\.History"
    - from: "Tab persistence JS (IIFE)"
      to: "Bootstrap Tab API"
      via: "new bootstrap.Tab(el).show() when ?activeTab=history"
      pattern: "activeTab.*history"
---

<objective>
Update RecordsWorkerList.cshtml to: (1) switch @model directive to RecordsWorkerListViewModel, (2) replace all Model. references in the worker-list section with Model.Workers., (3) add a second "History" Bootstrap tab pane with the combined-history table, (4) add tab-persistence JS matching the CDP Dashboard pattern.

Purpose: Surfaces the combined training + assessment history data already prepared by Plan 01 so HC can see all worker activity chronologically in one place.
Output: Updated Views/CMP/RecordsWorkerList.cshtml with fully functional two-tab layout.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-training-records-history-tab/40-RESEARCH.md
@.planning/phases/40-training-records-history-tab/40-01-SUMMARY.md

# Source files — read before writing
@Views/CMP/RecordsWorkerList.cshtml
@Views/CMP/Assessment.cshtml
@Views/CDP/Dashboard.cshtml
@Views/CMP/Records.cshtml
@Models/RecordsWorkerListViewModel.cs
@Models/AllWorkersHistoryRow.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Switch @model directive and fix all Model. references in the worker-list section</name>
  <files>
    Views/CMP/RecordsWorkerList.cshtml
  </files>
  <action>
    Read Views/CMP/RecordsWorkerList.cshtml in full first.

    CHANGE 1 — @model directive (line 1):
    Old: `@model List<HcPortal.Models.WorkerTrainingStatus>`
    New: `@model HcPortal.Models.RecordsWorkerListViewModel`

    CHANGE 2 — @{ block at the top.
    Old: `var totalWorkers = Model.Count;`
    New: `var totalWorkers = Model.Workers.Count;`

    Old: `var availableUnits = Model.Select(w => w.Unit)...`
    New: `var availableUnits = Model.Workers.Select(w => w.Unit)...`

    CHANGE 3 — All usages of `Model` that refer to the worker list.
    Search the file for every occurrence of `Model.` and `Model.Count` that currently refers to the flat list.
    Replace each with `Model.Workers.` or `Model.Workers.Count` as appropriate.

    Key replacements (verify by reading the file — exact line numbers may shift):
    - `@if (Model.Count > 0)` → `@if (Model.Workers.Count > 0)`
    - `@foreach (var worker in Model)` → `@foreach (var worker in Model.Workers)`
    - Any `Model.Count` in pagination footer → `Model.Workers.Count`

    PITFALL: Do NOT touch pagination JS that reads `allRows` from the DOM — it is already working from DOM traversal, not from Model directly. Only change Razor C# expressions that reference `Model`.

    After this change, the existing worker-list tab should compile and render identically to before.
  </action>
  <verify>
    Run: dotnet build
    Expected: 0 errors. The Razor view compiles (dotnet build does not compile Razor by default, but runtime compilation will catch errors when the page loads).
    Grep check: grep "@model" Views/CMP/RecordsWorkerList.cshtml
    Expected: `@model HcPortal.Models.RecordsWorkerListViewModel`
  </verify>
  <done>
    @model directive updated. No bare `Model.Count` or `foreach (var worker in Model)` (without `.Workers`) remains in the file.
    `dotnet build` passes 0 errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Bootstrap tab strip, History pane, and tab-persistence JS</name>
  <files>
    Views/CMP/RecordsWorkerList.cshtml
  </files>
  <action>
    Read the current state of Views/CMP/RecordsWorkerList.cshtml after Task 1.

    STRUCTURAL CHANGE — Wrap the entire existing content (from the filter card down to the export button) inside a tab pane, and prepend a tab strip above it.

    Insert immediately AFTER the TempData alert block (after the closing `</div>` of the second alert) and BEFORE the "<!-- Filter and Export Section -->" comment:

    ```html
    <!-- Tab Strip (Phase 40) -->
    <ul class="nav nav-tabs mb-4" id="recordsTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="workers-tab" data-bs-toggle="tab"
                    data-bs-target="#workers-tab-pane" type="button" role="tab"
                    aria-controls="workers-tab-pane" aria-selected="true">
                <i class="bi bi-people me-1"></i> Daftar Pekerja
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="history-tab" data-bs-toggle="tab"
                    data-bs-target="#history-tab-pane" type="button" role="tab"
                    aria-controls="history-tab-pane" aria-selected="false">
                <i class="bi bi-clock-history me-1"></i> History
                <span class="badge bg-secondary ms-1">@Model.History.Count</span>
            </button>
        </li>
    </ul>

    <div class="tab-content" id="recordsTabsContent">

    <!-- Workers Tab Pane — wraps existing filter + table -->
    <div class="tab-pane fade show active" id="workers-tab-pane" role="tabpanel" aria-labelledby="workers-tab">
    ```

    Then close the workers tab pane by inserting `</div> <!-- /workers-tab-pane -->` immediately AFTER the existing Export to Excel button block (after the closing `</div>` of the `d-flex justify-content-end mt-3` div).

    Then insert the History tab pane AFTER that closing div:

    ```html
    <!-- History Tab Pane (Phase 40) -->
    <div class="tab-pane fade" id="history-tab-pane" role="tabpanel" aria-labelledby="history-tab">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white py-3">
                <h6 class="mb-0 fw-bold text-primary">
                    <i class="bi bi-clock-history me-2"></i>Riwayat Training &amp; Assessment — Semua Pekerja
                </h6>
            </div>
            <div class="card-body p-0">
                @if (!Model.History.Any())
                {
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-inbox fs-1 d-block mb-3"></i>
                        <h5>Belum ada riwayat</h5>
                        <p class="small">Data akan muncul setelah ada Training Record atau Assessment yang selesai.</p>
                    </div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="sticky-header">
                                <tr>
                                    <th class="p-3">Nama Pekerja</th>
                                    <th class="p-3">Nopeg</th>
                                    <th class="p-3">Tipe</th>
                                    <th class="p-3">Judul / Nama Pelatihan</th>
                                    <th class="p-3">Tanggal Mulai</th>
                                    <th class="p-3">Penyelenggara</th>
                                    <th class="p-3 text-center">Nilai</th>
                                    <th class="p-3 text-center">Pass/Fail</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var row in Model.History)
                                {
                                    <tr>
                                        <td class="p-3 fw-semibold">@row.WorkerName</td>
                                        <td class="p-3 text-muted">@(row.WorkerNIP ?? "—")</td>
                                        <td class="p-3">
                                            @if (row.RecordType == "Assessment Online")
                                            {
                                                <span class="badge rounded-pill bg-primary">Assessment Online</span>
                                            }
                                            else
                                            {
                                                <span class="badge rounded-pill bg-success">Manual</span>
                                            }
                                        </td>
                                        <td class="p-3"><span class="fw-semibold">@row.Title</span></td>
                                        <td class="p-3">@row.Date.ToString("dd MMM yyyy")</td>
                                        <td class="p-3">@(row.Penyelenggara ?? "—")</td>
                                        <td class="p-3 text-center">
                                            @if (row.Score.HasValue)
                                            { <span>@row.Score</span> }
                                            else
                                            { <span class="text-muted">—</span> }
                                        </td>
                                        <td class="p-3 text-center">
                                            @if (row.IsPassed.HasValue)
                                            {
                                                if (row.IsPassed == true)
                                                { <span class="badge bg-success">Pass</span> }
                                                else
                                                { <span class="badge bg-danger">Fail</span> }
                                            }
                                            else
                                            { <span class="text-muted">—</span> }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>
    </div>

    </div> <!-- /tab-content -->
    ```

    BADGE RENDERING: Copy pattern from Views/CMP/Records.cshtml lines 126-133 (Assessment Online badge = bg-primary, Training Manual badge = bg-success). Note this plan uses "Manual" not "Training Manual" to match AllWorkersHistoryRow.RecordType value set by GetAllWorkersHistory().

    SCORE / PASS-FAIL COLUMNS: Copy pattern from Views/CMP/Records.cshtml lines 136-148.

    PENYELENGGARA COLUMN: Copy pattern from Views/CMP/Records.cshtml line 149.

    TAB PERSISTENCE JS — Add this IIFE at the bottom of the existing `<script>` block (before the closing `</script>` tag), AFTER all existing JS:

    ```javascript
    // Phase 40: Tab persistence — activate History tab if ?activeTab=history in URL
    // Pattern mirrors Views/CDP/Dashboard.cshtml lines 56-72
    (function () {
        var params = new URLSearchParams(window.location.search);
        if (params.get('activeTab') === 'history') {
            var historyTabEl = document.getElementById('history-tab');
            if (historyTabEl) {
                new bootstrap.Tab(historyTabEl).show();
            }
        }
    })();
    ```

    Also wire the tab click events to update the URL param without full page reload. Add this inside the DOMContentLoaded handler, after the existing initializePagination() call:

    ```javascript
    // Update URL param when switching tabs so the browser back button and refresh work
    document.getElementById('history-tab')?.addEventListener('shown.bs.tab', function () {
        var url = new URL(window.location.href);
        url.searchParams.set('activeTab', 'history');
        history.replaceState(null, '', url.toString());
    });
    document.getElementById('workers-tab')?.addEventListener('shown.bs.tab', function () {
        var url = new URL(window.location.href);
        url.searchParams.delete('activeTab');
        history.replaceState(null, '', url.toString());
    });
    ```

    PITFALL: The `sticky-header` class is already defined in the existing `<style>` block of the file — do NOT add it again.
  </action>
  <verify>
    1. Run the application: `dotnet run` (or use your existing dev server).
    2. Navigate to /CMP/Records as HC or Admin.
    3. Confirm two tabs appear: "Daftar Pekerja" and "History".
    4. Confirm the "Daftar Pekerja" tab is active by default and the existing filter form + table work correctly.
    5. Click the "History" tab — confirm the history table loads with rows (or the empty-state message if no data exists yet).
    6. Add ?activeTab=history to the URL and reload — confirm the History tab is active on load.
    7. Run: `dotnet build` — 0 errors.
  </verify>
  <done>
    Two tabs visible on RecordsWorkerList page.
    Daftar Pekerja tab: filter + worker table still functional (Model.Workers renders correctly).
    History tab: renders history table with correct columns (Worker Name, Nopeg, Tipe badge, Judul, Tanggal Mulai, Penyelenggara, Nilai, Pass/Fail).
    Tab persistence works: ?activeTab=history lands on History tab.
    `dotnet build` 0 errors.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: End-to-end verification of the History tab</name>
  <files>Views/CMP/RecordsWorkerList.cshtml</files>
  <action>Human performs end-to-end verification of the two-tab layout per the how-to-verify steps below.</action>
  <verify>See how-to-verify steps below (10-point checklist).</verify>
  <done>User types "approved" confirming all 10 checks pass — two tabs visible, History tab shows combined data, tab persistence works, Daftar Pekerja tab unchanged.</done>
  <what-built>
    Full two-tab layout on RecordsWorkerList:
    - Tab 1 "Daftar Pekerja": existing filter form + worker table, now reads from Model.Workers
    - Tab 2 "History": combined chronological list of all workers' TrainingRecords and completed AssessmentSessions, sorted most-recent first, with type badge, worker name, title, date, penyelenggara, score, pass/fail columns
    - Tab persistence via ?activeTab=history URL parameter
  </what-built>
  <how-to-verify>
    1. Start the application (`dotnet run` or existing dev server) and log in as HC or Admin.
    2. Navigate to Training Records (Records page for HC — the one that shows RecordsWorkerList).
    3. Confirm TWO tabs appear at the top: "Daftar Pekerja" and "History".
    4. Confirm "Daftar Pekerja" tab is active by default and works as before (filters, worker table, pagination).
    5. Click "History" tab:
       - If data exists: confirm rows show Worker Name, Nopeg, a colored badge (Assessment Online = blue, Manual = green), Title, date, penyelenggara or "—", score or "—", Pass/Fail badge or "—"
       - Confirm rows are sorted most-recent date first
       - If no data: confirm the empty-state message "Belum ada riwayat" appears (not an error or blank screen)
    6. While on History tab: check the URL contains ?activeTab=history
    7. Reload the page with ?activeTab=history in the URL — confirm History tab is still active (not reset to Daftar Pekerja)
    8. Switch back to "Daftar Pekerja" tab — confirm URL no longer contains activeTab param
    9. Apply a section filter on the Daftar Pekerja tab — confirm the worker list updates correctly and the tab strip is still visible
    10. Run `dotnet build` — confirm 0 errors
  </how-to-verify>
  <resume-signal>Type "approved" if all 10 checks pass. Otherwise describe which check failed and what was observed.</resume-signal>
</task>

</tasks>

<verification>
- `dotnet build` 0 errors
- @model directive is `HcPortal.Models.RecordsWorkerListViewModel`
- No bare `foreach (var worker in Model)` or `Model.Count` (without `.Workers`) remains
- History tab renders with correct 8-column table structure
- Tab persistence JS is present and functional
- Existing Daftar Pekerja tab filter + pagination JS unchanged and still working
</verification>

<success_criteria>
HC can open RecordsWorkerList, click the "History" tab, and see all workers' training and assessment activity in one sorted list — without navigating to individual worker pages. All 5 roadmap success criteria for Phase 40 are satisfied.
</success_criteria>

<output>
After completion, create `.planning/phases/40-training-records-history-tab/40-02-SUMMARY.md`
</output>
