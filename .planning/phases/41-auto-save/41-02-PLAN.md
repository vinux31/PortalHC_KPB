---
phase: 41-auto-save
plan: 02
type: execute
wave: 2
depends_on: [41-01]
files_modified:
  - Views/CMP/StartExam.cshtml
  - Views/CMP/ExamSummary.cshtml
autonomous: false

must_haves:
  truths:
    - "Worker's radio selection triggers a debounced (300ms) AJAX save — rapid clicks do not fire duplicate requests"
    - "Save indicator appears at bottom-right: 'Soal no. X, menyimpan...' while in-flight, changes to 'Soal no. X, saved' on success, fades out after ~2 seconds"
    - "Prev/Next/ReviewSubmit navigation buttons are disabled while any save is in-flight; navigation proceeds automatically after saves complete or after 5-second timeout"
    - "On save failure after 1 retry: indicator shows 'Soal no. X, gagal tersimpan' and a toast 'Koneksi bermasalah, cek jaringan' fades after ~5 seconds"
    - "Package exams call SaveAnswer; legacy exams (HasPackages=false) call SaveLegacyAnswer"
    - "ExamSummary shows a 'Semua jawaban sudah tersimpan' badge reassuring worker before final submit"
  artifacts:
    - path: "Views/CMP/StartExam.cshtml"
      provides: "Debounced auto-save JS, save indicator HTML/CSS, navigation blocking, toast failure handling"
      contains: "saveAnswerWithDebounce"
    - path: "Views/CMP/ExamSummary.cshtml"
      provides: "Semua jawaban sudah tersimpan badge"
      contains: "tersimpan"
  key_links:
    - from: "Views/CMP/StartExam.cshtml radio change handler"
      to: "saveAnswerWithDebounce()"
      via: "addEventListener change"
      pattern: "saveAnswerWithDebounce"
    - from: "Views/CMP/StartExam.cshtml saveAnswerAsync()"
      to: "SaveAnswer or SaveLegacyAnswer endpoint"
      via: "fetch POST with antiforgery token"
      pattern: "IS_PACKAGE_PATH.*SaveAnswer|SaveLegacyAnswer"
    - from: "Views/CMP/StartExam.cshtml changePage()"
      to: "navigation blocking check"
      via: "pendingSaves / inFlightSaves check + setInterval poll"
      pattern: "inFlightSaves"
---

<objective>
Replace the existing fire-and-forget saveAnswerAsync in StartExam.cshtml with a full auto-save system: debounced saves, live save indicator, navigation blocking with 5s timeout, retry logic, and failure toast. Add reassurance badge to ExamSummary.cshtml.

Purpose: Workers never silently lose answers — each radio click is persisted, navigation waits for save to complete, and failures are surfaced with clear messaging. Both exam paths (package and legacy) are covered.

Output:
- StartExam.cshtml: debounced radio handler, pendingSaves/inFlightSaves state, indicator element + CSS, navigation blocking in changePage(), reviewSubmitBtn listener, toast on double-failure
- ExamSummary.cshtml: "Semua jawaban sudah tersimpan" badge above the submit button area
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Views/CMP/StartExam.cshtml
@Views/CMP/ExamSummary.cshtml
@.planning/phases/41-auto-save/41-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add auto-save JS and save indicator to StartExam.cshtml</name>
  <files>Views/CMP/StartExam.cshtml</files>
  <action>
**Overview of changes to StartExam.cshtml:**

This task replaces the existing fire-and-forget `saveAnswerAsync` + its radio listener, rewrites `changePage()` to block navigation while saves are pending, and adds the save indicator HTML element + CSS + toast logic. All changes are inside the existing `<script>` block and before the closing `</script>` tag, unless noted.

---

**1. Add save indicator HTML element and CSS — insert before the closing `</div>` of the outermost container (before `</div>` that wraps the sticky header and main content), or simply append to `<body>` just before the first `<script>` tag.**

Add this HTML block immediately before the opening `<script>` tag:

```html
<!-- Auto-save indicator (fixed bottom-right) -->
<div id="saveIndicator" style="display:none; position:fixed; bottom:20px; right:20px; z-index:1050;">
    <span id="saveIndicatorBadge" class="badge rounded-pill px-3 py-2" style="font-size:0.85rem;">
        <span id="saveIndicatorText"></span>
    </span>
</div>
```

Add a `<style>` block before the `<script>` tag (or inside it as a template literal — prefer a separate `<style>` tag for clarity):

```html
<style>
    #saveIndicator.fade-out {
        animation: saveIndicatorFade 0.4s ease-in-out forwards;
    }
    @keyframes saveIndicatorFade {
        0%   { opacity: 1; }
        100% { opacity: 0; }
    }
</style>
```

---

**2. Inside the `<script>` block, after the existing `SESSION_ID` constant (line ~222), add the auto-save state variables and URL constants:**

```javascript
// -------- Auto-save state --------
const IS_PACKAGE_PATH = @(Model.HasPackages ? "true" : "false");
const SAVE_LEGACY_URL = '@Url.Action("SaveLegacyAnswer", "CMP")';
const DEBOUNCE_MS = 300;
const SAVE_TIMEOUT_MS = 5000; // Navigation timeout if saves hang
let pendingSaves = {};    // questionId -> debounce timeout ID
let inFlightSaves = new Set();  // question IDs with requests in-flight
let failureToastShown = false;
let indicatorFadeTimer = null;
```

---

**3. Replace the entire existing `saveAnswerAsync` function and radio change listener block (lines ~224-252) with the following:**

```javascript
// -------- Auto-save functions --------

function getDisplayNumForQuestion(qId) {
    const qcard = document.getElementById('qcard_' + qId);
    if (qcard) {
        const badge = qcard.querySelector('.badge.bg-primary');
        if (badge) return badge.innerText.trim();
    }
    return qId;
}

function showSaveIndicator(qId, state) {
    const indicator = document.getElementById('saveIndicator');
    const badge = document.getElementById('saveIndicatorBadge');
    const text = document.getElementById('saveIndicatorText');
    const displayNum = getDisplayNumForQuestion(qId);

    // Clear any pending fade-out
    if (indicatorFadeTimer) { clearTimeout(indicatorFadeTimer); indicatorFadeTimer = null; }
    indicator.classList.remove('fade-out');

    if (state === 'saving') {
        badge.className = 'badge rounded-pill px-3 py-2 bg-secondary text-white';
        text.innerText = 'Soal no. ' + displayNum + ', menyimpan...';
        indicator.style.display = 'block';
        indicator.style.opacity = '1';
    } else if (state === 'saved') {
        badge.className = 'badge rounded-pill px-3 py-2 bg-success text-white';
        text.innerText = 'Soal no. ' + displayNum + ', saved';
        indicator.style.display = 'block';
        indicator.style.opacity = '1';
        // Auto-fade after 2 seconds
        indicatorFadeTimer = setTimeout(function() {
            indicator.classList.add('fade-out');
            setTimeout(function() { indicator.style.display = 'none'; indicator.classList.remove('fade-out'); }, 400);
        }, 2000);
    } else if (state === 'error') {
        badge.className = 'badge rounded-pill px-3 py-2 bg-danger text-white';
        text.innerText = 'Soal no. ' + displayNum + ', gagal tersimpan';
        indicator.style.display = 'block';
        indicator.style.opacity = '1';
    }
}

function showFailureToast() {
    if (failureToastShown) return;
    failureToastShown = true;
    var toast = document.createElement('div');
    toast.style.cssText = 'position:fixed;top:80px;right:20px;z-index:2000;max-width:380px;';
    toast.className = 'alert alert-warning alert-dismissible fade show';
    toast.innerHTML = '<i class="bi bi-exclamation-triangle-fill me-2"></i>' +
        '<strong>Koneksi bermasalah, cek jaringan</strong>' +
        '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
    document.body.appendChild(toast);
    setTimeout(function() {
        if (toast.parentNode) toast.parentNode.removeChild(toast);
        failureToastShown = false;
    }, 5000);
}

function doSaveFetch(qId, optId) {
    var saveUrl = IS_PACKAGE_PATH ? SAVE_ANSWER_URL : SAVE_LEGACY_URL;
    return fetch(saveUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'RequestVerificationToken': SAVE_ANSWER_TOKEN
        },
        body: 'sessionId=' + SESSION_ID + '&questionId=' + qId + '&optionId=' + optId
    }).then(function(r) {
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return r.json();
    }).then(function(data) {
        if (!data.success) throw new Error(data.error || 'Save rejected');
    });
}

function saveAnswerAsync(qId, optId, isRetry) {
    if (inFlightSaves.has(String(qId))) return;
    inFlightSaves.add(String(qId));
    showSaveIndicator(qId, 'saving');

    doSaveFetch(qId, optId)
        .then(function() {
            showSaveIndicator(qId, 'saved');
        })
        .catch(function() {
            if (!isRetry) {
                // 1x retry immediately
                inFlightSaves.delete(String(qId));
                saveAnswerAsync(qId, optId, true);
            } else {
                // Retry also failed
                showSaveIndicator(qId, 'error');
                showFailureToast();
            }
        })
        .finally(function() {
            inFlightSaves.delete(String(qId));
        });
}

function saveAnswerWithDebounce(qId, optId) {
    if (pendingSaves[qId]) { clearTimeout(pendingSaves[qId]); }
    pendingSaves[qId] = setTimeout(function() {
        delete pendingSaves[qId];
        saveAnswerAsync(qId, optId, false);
    }, DEBOUNCE_MS);
}

// -------- Radio change listener (replaces old listener) --------
document.querySelectorAll('.exam-radio').forEach(function(radio) {
    radio.addEventListener('change', function() {
        const qId = this.getAttribute('data-question-id');
        const optId = this.value;
        // Update hidden input
        document.getElementById('ans_' + qId).value = optId;
        answeredQuestions.add(qId);
        updateAnsweredCount();
        // Visual: highlight selected label
        document.querySelectorAll('[id^="lbl_' + qId + '_"]').forEach(function(lbl) {
            lbl.classList.remove('option-selected');
        });
        document.getElementById('lbl_' + qId + '_' + optId).classList.add('option-selected');
        // Debounced auto-save
        saveAnswerWithDebounce(qId, optId);
    });
});
```

---

**4. Replace the existing `changePage()` function (lines ~208-215) with a navigation-blocking version:**

```javascript
function changePage(newPage) {
    if (newPage < 0 || newPage >= TOTAL_PAGES) return;

    // Check for pending saves
    if (Object.keys(pendingSaves).length > 0 || inFlightSaves.size > 0) {
        // Disable nav buttons while waiting
        document.querySelectorAll('[onclick^="changePage"], #reviewSubmitBtn').forEach(function(b) {
            b.disabled = true;
        });

        var navTimeout = setTimeout(function() {
            // 5s timeout: give up waiting, navigate anyway
            clearInterval(navPoll);
            document.querySelectorAll('[onclick^="changePage"], #reviewSubmitBtn').forEach(function(b) {
                b.disabled = false;
            });
            performPageSwitch(newPage);
        }, SAVE_TIMEOUT_MS);

        var navPoll = setInterval(function() {
            if (Object.keys(pendingSaves).length === 0 && inFlightSaves.size === 0) {
                clearInterval(navPoll);
                clearTimeout(navTimeout);
                document.querySelectorAll('[onclick^="changePage"], #reviewSubmitBtn').forEach(function(b) {
                    b.disabled = false;
                });
                performPageSwitch(newPage);
            }
        }, 50);
        return;
    }

    performPageSwitch(newPage);
}

function performPageSwitch(newPage) {
    document.getElementById('page_' + currentPage).style.display = 'none';
    currentPage = newPage;
    document.getElementById('page_' + currentPage).style.display = 'block';
    updatePanel();
    window.scrollTo(0, 0);
}
```

---

**5. Add navigation-blocking to the ReviewSubmit button.**

After the `changePage`/`performPageSwitch` function block, add:

```javascript
// -------- ReviewSubmitBtn: block form submit until saves complete --------
var reviewBtn = document.getElementById('reviewSubmitBtn');
if (reviewBtn) {
    reviewBtn.addEventListener('click', function(e) {
        if (Object.keys(pendingSaves).length > 0 || inFlightSaves.size > 0) {
            e.preventDefault();
            reviewBtn.disabled = true;

            var rTimeout = setTimeout(function() {
                clearInterval(rPoll);
                reviewBtn.disabled = false;
                document.getElementById('examForm').submit();
            }, SAVE_TIMEOUT_MS);

            var rPoll = setInterval(function() {
                if (Object.keys(pendingSaves).length === 0 && inFlightSaves.size === 0) {
                    clearInterval(rPoll);
                    clearTimeout(rTimeout);
                    reviewBtn.disabled = false;
                    document.getElementById('examForm').submit();
                }
            }, 50);
        }
        // If no saves pending: default form submit proceeds normally
    });
}
```

Note: The reviewSubmitBtn is a `type="submit"` inside `#examForm`. When saves are pending, we call `e.preventDefault()` and then re-trigger `examForm.submit()` after saves clear. When saves are not pending, the button submits normally (no preventDefault).
  </action>
  <verify>
1. Read Views/CMP/StartExam.cshtml — confirm:
   - `#saveIndicator` element exists before the `<script>` tag
   - `saveAnswerWithDebounce` function is defined
   - `pendingSaves` and `inFlightSaves` variables are declared
   - `changePage` calls `performPageSwitch` and has setInterval poll
   - `doSaveFetch` references both `SAVE_ANSWER_URL` and `SAVE_LEGACY_URL` based on `IS_PACKAGE_PATH`
   - No old `saveAnswerAsync` fire-and-forget pattern remains (the old one was a single fetch with `.catch(function() { /* ignore */ })`)
2. Run `dotnet build` — zero errors.
  </verify>
  <done>StartExam.cshtml has debounced auto-save for both exam paths, live indicator, navigation blocking with 5s timeout, retry with toast on double-failure, and build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Add "Semua jawaban sudah tersimpan" badge to ExamSummary.cshtml</name>
  <files>Views/CMP/ExamSummary.cshtml</files>
  <action>
In ExamSummary.cshtml, add a reassurance badge immediately above the `<!-- Final submit form -->` comment (before `<form asp-action="SubmitExam">`).

Insert the following block between the closing `</div>` of the summary table card and the `<!-- Final submit form -->` comment:

```html
<!-- Auto-save reassurance badge -->
<div class="d-flex justify-content-center mb-3">
    <span class="badge bg-success bg-opacity-10 text-success border border-success rounded-pill px-3 py-2">
        <i class="bi bi-check-circle-fill me-1"></i>Semua jawaban sudah tersimpan
    </span>
</div>
```

This badge appears between the summary table and the submit button area. It uses Bootstrap's `bg-opacity-10` utility for a subtle background, with a green border and icon matching the existing success styling pattern in ExamSummary.cshtml.
  </action>
  <verify>
1. Read Views/CMP/ExamSummary.cshtml — confirm "Semua jawaban sudah tersimpan" text is present between the summary table div and the Final submit form.
2. Run `dotnet build` — zero errors.
  </verify>
  <done>ExamSummary shows "Semua jawaban sudah tersimpan" badge above the submit form; build passes.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: End-to-end verification of auto-save behaviour</name>
  <files>Views/CMP/StartExam.cshtml, Views/CMP/ExamSummary.cshtml</files>
  <action>Human performs end-to-end verification of the auto-save indicator, navigation blocking, and ExamSummary badge per the how-to-verify steps below.</action>
  <verify>See how-to-verify steps below.</verify>
  <done>User types "approved" confirming: indicator shows correct states, navigation blocks and unblocks, toast appears on failure, ExamSummary badge is visible.</done>
  <what-built>
- Auto-save debounce (300ms) on radio button clicks in StartExam.cshtml
- Save indicator at bottom-right corner: "Soal no. X, menyimpan..." → "Soal no. X, saved" → auto-fade after 2s
- Navigation blocking: Prev/Next/ReviewSubmit buttons disabled while save in-flight; proceed after save completes or 5s timeout
- 1x retry on failure → "gagal tersimpan" indicator + "Koneksi bermasalah, cek jaringan" toast
- "Semua jawaban sudah tersimpan" badge on ExamSummary.cshtml
  </what-built>
  <how-to-verify>
1. Start a package exam (use a test account with an active assignment):
   - Click a radio button → bottom-right should show "Soal no. X, menyimpan..." briefly then "Soal no. X, saved" then fade out after 2 seconds
   - Click rapidly on different options for the same question → should NOT fire multiple simultaneous requests (check Network tab: only one request fires ~300ms after last click)
   - Click Prev/Next immediately after a radio click → button should appear disabled briefly while save completes, then navigate

2. Start a legacy exam (assessment without packages, HasPackages=false):
   - Same radio click test — Network tab request should go to `/CMP/SaveLegacyAnswer` instead of `/CMP/SaveAnswer`

3. Navigate to ExamSummary (click Review and Submit):
   - Confirm "Semua jawaban sudah tersimpan" badge is visible above the Submit Exam button

4. (Optional failure test) Throttle network in DevTools to Offline after selecting a radio button:
   - Indicator should show "gagal tersimpan"
   - Toast "Koneksi bermasalah, cek jaringan" should appear at top-right and fade after 5 seconds
  </how-to-verify>
  <resume-signal>Type "approved" if all indicators and blocking behave correctly, or describe any issues seen.</resume-signal>
</task>

</tasks>

<verification>
After all tasks (including checkpoint approval):
- `dotnet build` passes with zero errors
- Network tab during exam shows single SaveAnswer (package) or SaveLegacyAnswer (legacy) request per radio selection after 300ms
- No `FirstOrDefaultAsync` remains in either SaveAnswer or SaveLegacyAnswer
- PackageUserResponse has UNIQUE constraint active (confirmed in Phase 41-01)
- ExamSummary shows the reassurance badge
</verification>

<success_criteria>
- SAVE-01: Worker answer is persisted on every radio selection (debounced 300ms, both paths)
- SAVE-02: All current-page answers are saved before navigating (Prev/Next/ReviewSubmit blocked until in-flight resolves or 5s timeout)
- SAVE-03: Atomic upsert (from Plan 01) + UNIQUE constraint prevents duplicate records under concurrency
- Indicator, toast, and ExamSummary badge match locked decisions from CONTEXT.md exactly
</success_criteria>

<output>
After completion, create `.planning/phases/41-auto-save/41-02-SUMMARY.md` using the standard summary template.
</output>
