---
phase: 42-session-resume
plan: 03
type: execute
wave: 3
depends_on: ["42-02"]
files_modified:
  - Views/CMP/Assessment.cshtml
  - Views/CMP/StartExam.cshtml
autonomous: true

must_haves:
  truths:
    - "Assignment card shows btn-warning 'Resume' button (not 'Start Assessment') when session is InProgress for this worker"
    - "Clicking Resume navigates to StartExam; a modal 'Ada ujian yang belum selesai — lanjutkan dari soal no. X?' appears before exam renders"
    - "Clicking 'Lanjutkan' dismisses modal and exam loads at LastActivePage with all previously answered radio buttons pre-checked"
    - "Timer starts immediately at server-calculated remaining time (not full duration)"
    - "Answered count badge shows correct count of pre-populated answers immediately on load"
    - "UpdateSessionProgress is called on every Prev/Next navigation AND every 30 seconds via setInterval"
    - "If RemainingSeconds <= 0 on load: exam expired modal shows and auto-submit fires"
  artifacts:
    - path: "Views/CMP/Assessment.cshtml"
      provides: "InProgress session detection + Resume button"
      contains: "InProgress"
    - path: "Views/CMP/StartExam.cshtml"
      provides: "Resume modal, timer init, answer pre-population, periodic progress save, expired path"
      contains: "resumeConfirmModal"
  key_links:
    - from: "Views/CMP/Assessment.cshtml"
      to: "Controllers/CMPController.cs StartExam"
      via: "href to /CMP/StartExam/{id} for Resume button"
      pattern: "StartExam.*id"
    - from: "Views/CMP/StartExam.cshtml"
      to: "Controllers/CMPController.cs UpdateSessionProgress"
      via: "fetch POST on navigation + setInterval"
      pattern: "UpdateSessionProgress"
    - from: "Views/CMP/StartExam.cshtml"
      to: "ViewBag.SavedAnswers"
      via: "SAVED_ANSWERS JS object parsed from @Html.Raw"
      pattern: "SAVED_ANSWERS"
---

<objective>
Implement all frontend changes for session resume: (1) show Resume button on assignment cards for in-progress sessions, (2) resume confirmation modal in StartExam, (3) timer initialized from server-provided remaining time, (4) answer pre-population across all pages, (5) periodic progress save (30s + on navigation), (6) expired exam path with auto-submit modal.

Purpose: This is the worker-facing experience. Backend (Plan 02) provides the data; this plan makes it visible.
Output: Two modified Razor views. Workers can resume exactly where they left off with correct timer and pre-filled answers.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/42-session-resume/42-CONTEXT.md
@.planning/phases/42-session-resume/42-RESEARCH.md
@.planning/phases/42-session-resume/42-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Assessment.cshtml — Resume button for InProgress sessions</name>
  <files>Views/CMP/Assessment.cshtml</files>
  <action>
In Views/CMP/Assessment.cshtml, find the "Personal View: Show action buttons" section (around line 497-520). The current logic is:

```razor
@if (item.Status == "Open")
{
    if (item.IsTokenRequired) { ... }
    else { <button ... onclick="startStandardAssessment(...)">Start Assessment</button> }
}
else if (item.Status == "Upcoming")
{
    <button disabled>Opens ...</button>
}
```

The `item.Status` for an in-progress session is `"InProgress"` (set by StartExam on first load). Add a new branch for InProgress status BEFORE the existing `@if (item.Status == "Open")` check:

```razor
@if (item.Status == "InProgress")
{
    <a class="btn btn-warning w-100" asp-action="StartExam" asp-route-id="@item.Id">
        <i class="bi bi-play-circle-fill me-1"></i>Resume
    </a>
}
else if (item.Status == "Open")
{
    if (item.IsTokenRequired)
    {
        <button class="btn btn-primary w-100" onclick="openTokenModal(@item.Id, '@item.Title', '@item.Category')">
            <i class="bi bi-shield-lock me-1"></i>Start Assessment <i class="bi bi-arrow-right ms-1"></i>
        </button>
    }
    else
    {
        <button class="btn btn-primary w-100" onclick="startStandardAssessment(@item.Id, '@item.Title')">
            Start Assessment <i class="bi bi-arrow-right ms-1"></i>
        </button>
    }
}
else if (item.Status == "Upcoming")
{
    <button class="btn btn-outline-secondary w-100" disabled>
        <i class="bi bi-lock-fill me-1"></i>Opens @item.Schedule.ToString("dd MMM yyyy"), @item.Schedule.ToString("HH:mm") WIB
    </button>
}
```

**Key decisions (Claude's discretion):**
- Use `btn-warning` (yellow) per user decision for visual distinction
- Use `<a>` tag with asp-action/asp-route-id (not a button with JS) — direct navigation to StartExam is correct; the resume modal appears on StartExam load
- Use `bi-play-circle-fill` icon to signal resume vs. start
- No token re-check needed: InProgress sessions already passed token check on first load (existing guard in StartExam bypasses token check for InProgress sessions per line 2743 of CMPController.cs)

Also update the status badge color for InProgress in the `statusBadgeClass` switch (around line 414):

```razor
var statusBadgeClass = item.Status switch
{
    "Open" => "bg-success",
    "Upcoming" => "bg-warning text-dark",
    "Completed" => "bg-primary",
    "InProgress" => "bg-warning text-dark",   // ADD THIS
    _ => "bg-secondary"
};
```

And update the status icon switch (around line 468):

```razor
var statusIcon = item.Status switch
{
    "Open" => "bi-check-circle-fill text-success",
    "Upcoming" => "bi-clock-fill text-warning",
    "Completed" => "bi-check-circle text-primary",
    "InProgress" => "bi-play-circle-fill text-warning",   // ADD THIS
    _ => "bi-circle"
};
```

**Do NOT modify** the status text display ("Status: @item.Status") — showing "InProgress" is fine for now.
  </action>
  <verify>
1. Read Views/CMP/Assessment.cshtml around the action buttons section — confirms the InProgress branch with btn-warning "Resume" exists before the Open branch.
2. `dotnet build C:/Users/rinoa/Desktop/PortalHC_KPB/PortalHC_KPB.csproj --no-restore 2>&1 | tail -5` — 0 errors.
  </verify>
  <done>Assessment.cshtml has InProgress branch rendering btn-warning "Resume" anchor tag. Status badge and icon switches include InProgress entries. Build: 0 errors.</done>
</task>

<task type="auto">
  <name>Task 2: StartExam.cshtml — Resume modal, timer init, answer pre-population, periodic save, expired path</name>
  <files>Views/CMP/StartExam.cshtml</files>
  <action>
Open Views/CMP/StartExam.cshtml. Make the following changes in order:

---

**CHANGE 1 — Add resume modal + expired modal HTML (insert before the `&lt;!-- Auto-save indicator --&gt;` div, around line 162):**

```html
<!-- Resume confirmation modal (shown on load for in-progress sessions) -->
<div class="modal fade" id="resumeConfirmModal" tabindex="-1"
     data-bs-backdrop="static" data-bs-keyboard="false" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-warning">
            <div class="modal-header bg-light border-bottom-0 pb-0">
                <h5 class="modal-title text-warning fw-bold">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>Ada ujian yang belum selesai
                </h5>
            </div>
            <div class="modal-body pt-2">
                <p class="mb-0">Lanjutkan dari soal no. <strong id="resumePageNum">--</strong>?</p>
            </div>
            <div class="modal-footer border-top-0">
                <button type="button" class="btn btn-warning w-100 fw-semibold" id="resumeConfirmBtn">
                    <i class="bi bi-arrow-right me-1"></i>Lanjutkan
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Expired exam modal (shown when remaining time <= 0 on resume) -->
<div class="modal fade" id="examExpiredModal" tabindex="-1"
     data-bs-backdrop="static" data-bs-keyboard="false" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-danger">
            <div class="modal-header bg-light border-bottom-0 pb-0">
                <h5 class="modal-title text-danger fw-bold">
                    <i class="bi bi-hourglass-bottom me-2"></i>Waktu Assessment Habis
                </h5>
            </div>
            <div class="modal-body pt-2">
                <p class="mb-0">Waktu ujian Anda telah berakhir. Jawaban yang sudah tersimpan akan dikirimkan secara otomatis.</p>
            </div>
            <div class="modal-footer border-top-0">
                <button type="button" class="btn btn-danger w-100" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>
```

---

**CHANGE 2 — Update JS constants section (around line 181-192, inside the `&lt;script&gt;` block):**

Replace or extend the existing constants block. The existing constants are:
```javascript
const TOTAL_QUESTIONS = @Model.TotalQuestions;
const QUESTIONS_PER_PAGE = @questionsPerPage;
const TOTAL_PAGES = @totalPages;
const DURATION_SECONDS = @Model.DurationMinutes * 60;
const WARNING_THRESHOLD = 300;
```

Add these new constants immediately after `const WARNING_THRESHOLD = 300;`:
```javascript
// --- Resume constants (from server) ---
const IS_RESUME = @((ViewBag.IsResume as bool? ?? false) ? "true" : "false");
const RESUME_PAGE = @(ViewBag.LastActivePage ?? 0);
const ELAPSED_SECONDS_FROM_DB = @(ViewBag.ElapsedSeconds ?? 0);
const REMAINING_SECONDS_FROM_DB = @(ViewBag.RemainingSeconds ?? (Model.DurationMinutes * 60));
const EXAM_EXPIRED = @((ViewBag.ExamExpired as bool? ?? false) ? "true" : "false");
const SAVED_ANSWERS = @Html.Raw(ViewBag.SavedAnswers ?? "{}");
const SESSION_PROGRESS_URL = '@Url.Action("UpdateSessionProgress", "CMP")';
```

---

**CHANGE 3 — Update state variables (around line 188-191):**

Replace:
```javascript
let currentPage = 0;
let timeRemaining = DURATION_SECONDS;
let answeredQuestions = new Set();
```

With:
```javascript
let currentPage = 0;  // Will be set to RESUME_PAGE after modal confirmation
let timeRemaining = REMAINING_SECONDS_FROM_DB;   // Server-calculated, not full duration
let elapsedSeconds = ELAPSED_SECONDS_FROM_DB;    // Tracks active time for UpdateSessionProgress
let answeredQuestions = new Set();
```

---

**CHANGE 4 — Update timer function (find the `updateTimer` function around line 202):**

Replace the existing `updateTimer` function body:
```javascript
function updateTimer() {
    const minutes = Math.floor(timeRemaining / 60);
    const seconds = timeRemaining % 60;
    const display = (minutes < 10 ? '0' + minutes : minutes) + ':' +
                    (seconds < 10 ? '0' + seconds : seconds);
    const el = document.getElementById('examTimer');
    el.innerText = display;
    if (timeRemaining <= WARNING_THRESHOLD) {
        el.className = 'fw-bold fs-5 text-danger';
    } else {
        el.className = 'fw-bold fs-5 text-dark';
    }
    if (timeRemaining <= 0) {
        clearInterval(timerInterval);
        alert('Time is up! Submitting your exam automatically.');
        document.getElementById('examForm').submit();
    }
    timeRemaining--;
}
```

With:
```javascript
function updateTimer() {
    const minutes = Math.floor(timeRemaining / 60);
    const seconds = timeRemaining % 60;
    const display = (minutes < 10 ? '0' + minutes : minutes) + ':' +
                    (seconds < 10 ? '0' + seconds : seconds);
    const el = document.getElementById('examTimer');
    el.innerText = display;
    if (timeRemaining <= WARNING_THRESHOLD) {
        el.className = 'fw-bold fs-5 text-danger';
    } else {
        el.className = 'fw-bold fs-5 text-dark';
    }
    if (timeRemaining <= 0) {
        clearInterval(timerInterval);
        window.onbeforeunload = null;
        document.getElementById('examForm').submit();
    }
    timeRemaining--;
    elapsedSeconds++;
}
```

Note: removed the `alert()` call (replaced by proper auto-submit). Added `elapsedSeconds++` so local tracking stays current. Added `window.onbeforeunload = null` before submit so no "leave page?" dialog interrupts auto-submit.

---

**CHANGE 5 — Add answer pre-population function (insert before the existing `// -------- Radio change listener` comment, around line 351):**

```javascript
// -------- Answer pre-population (for resume) --------
function prePopulateAnswers() {
    if (!SAVED_ANSWERS || Object.keys(SAVED_ANSWERS).length === 0) return;
    Object.entries(SAVED_ANSWERS).forEach(function([qIdStr, optId]) {
        if (!optId || optId === 0) return;
        const qId = parseInt(qIdStr);
        // Update hidden input
        const hiddenInput = document.getElementById('ans_' + qId);
        if (hiddenInput) hiddenInput.value = optId;
        // Pre-check radio button
        const radio = document.querySelector('input[name="radio_' + qId + '"][value="' + optId + '"]');
        if (radio) {
            radio.checked = true;
            // Apply visual highlight to the selected label
            document.querySelectorAll('[id^="lbl_' + qId + '_"]').forEach(function(lbl) {
                lbl.classList.remove('option-selected');
            });
            const selectedLabel = document.getElementById('lbl_' + qId + '_' + optId);
            if (selectedLabel) selectedLabel.classList.add('option-selected');
        }
        // Track as answered
        answeredQuestions.add(String(qId));
    });
    updateAnsweredCount();
}
```

---

**CHANGE 6 — Add UpdateSessionProgress save function (insert after prePopulateAnswers, before radio listener):**

```javascript
// -------- Session progress save (elapsed time + current page) --------
function saveSessionProgress() {
    const token = document.querySelector('input[name="__RequestVerificationToken"]');
    if (!token) return;
    fetch(SESSION_PROGRESS_URL, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'RequestVerificationToken': token.value
        },
        body: 'sessionId=' + SESSION_ID +
              '&elapsedSeconds=' + elapsedSeconds +
              '&currentPage=' + currentPage
    }).catch(function() {
        // Silent failure: local elapsedSeconds continues; next 30s poll will retry
        console.warn('UpdateSessionProgress failed — will retry on next interval');
    });
}

// Periodic save every 30 seconds
setInterval(saveSessionProgress, 30000);
```

---

**CHANGE 7 — Call saveSessionProgress on every page navigation (inside `performPageSwitch`, after the existing `updatePanel()` call):**

Find the `performPageSwitch` function (around line 406):
```javascript
function performPageSwitch(newPage) {
    document.getElementById('page_' + currentPage).style.display = 'none';
    currentPage = newPage;
    document.getElementById('page_' + currentPage).style.display = 'block';
    updatePanel();
    window.scrollTo(0, 0);
}
```

Replace with:
```javascript
function performPageSwitch(newPage) {
    document.getElementById('page_' + currentPage).style.display = 'none';
    currentPage = newPage;
    document.getElementById('page_' + currentPage).style.display = 'block';
    updatePanel();
    saveSessionProgress();  // Save elapsed time + new page on every navigation
    window.scrollTo(0, 0);
}
```

---

**CHANGE 8 — Add initialization block at the bottom (replace the existing `// -------- Init --------` section around line 476):**

Find:
```javascript
// -------- Init --------
updatePanel();
```

Replace with:
```javascript
// -------- Init --------

// Pre-populate saved answers before anything is shown (seamless, no flicker)
prePopulateAnswers();

// Expired exam: show modal then auto-submit
if (EXAM_EXPIRED) {
    clearInterval(timerInterval);   // Stop timer (time already up)
    window.onbeforeunload = null;
    const expiredModal = new bootstrap.Modal(document.getElementById('examExpiredModal'));
    expiredModal.show();
    // Auto-submit after worker acknowledges (or after 5 seconds as fallback)
    document.querySelector('#examExpiredModal button').addEventListener('click', function() {
        document.getElementById('examForm').submit();
    });
    setTimeout(function() {
        document.getElementById('examForm').submit();
    }, 5000);
} else if (IS_RESUME && RESUME_PAGE > 0) {
    // Show resume confirmation modal (worker left mid-exam on a non-first page)
    document.getElementById('resumePageNum').innerText = (RESUME_PAGE + 1);
    const resumeModal = new bootstrap.Modal(document.getElementById('resumeConfirmModal'));
    resumeModal.show();

    document.getElementById('resumeConfirmBtn').addEventListener('click', function() {
        resumeModal.hide();
        // Navigate to last active page
        document.getElementById('page_0').style.display = 'none';
        currentPage = RESUME_PAGE;
        document.getElementById('page_' + currentPage).style.display = 'block';
        updatePanel();
        window.scrollTo(0, 0);
    });
} else {
    // Normal start or resume from page 0: just render panel
    updatePanel();
}
```

**Behavioral notes:**
- `prePopulateAnswers()` runs first (before any modal), ensuring `answeredQuestions` Set is filled and count badge is accurate immediately.
- EXAM_EXPIRED: if remaining time was <= 0 when StartExam was rendered, auto-submit fires. No timer needed.
- IS_RESUME && RESUME_PAGE > 0: show modal. RESUME_PAGE == 0 means they were on page 1 when they left — just load normally (no modal needed since they'll be on the correct page already).
- Normal/fresh start: IS_RESUME is false (first load), so `updatePanel()` runs directly.
- The timer is already running from `var timerInterval = setInterval(updateTimer, 1000)` above this block (initialized with REMAINING_SECONDS_FROM_DB). No change to timer setup needed — it already uses the corrected `timeRemaining` variable.
  </action>
  <verify>
1. `dotnet build C:/Users/rinoa/Desktop/PortalHC_KPB/PortalHC_KPB.csproj --no-restore 2>&1 | tail -5` — 0 errors.
2. Read Views/CMP/StartExam.cshtml and confirm:
   - `resumeConfirmModal` and `examExpiredModal` divs exist in HTML
   - `IS_RESUME`, `REMAINING_SECONDS_FROM_DB`, `SAVED_ANSWERS`, `ELAPSED_SECONDS_FROM_DB` constants declared
   - `timeRemaining = REMAINING_SECONDS_FROM_DB` (not DURATION_SECONDS)
   - `elapsedSeconds` variable declared and incremented in `updateTimer`
   - `prePopulateAnswers()` function exists
   - `saveSessionProgress()` function exists with `setInterval(saveSessionProgress, 30000)` below it
   - `performPageSwitch` calls `saveSessionProgress()` after updatePanel()
   - Init block calls `prePopulateAnswers()` first, then handles EXAM_EXPIRED, then IS_RESUME modal, then normal path
  </verify>
  <done>Assessment.cshtml shows Resume button for InProgress sessions. StartExam.cshtml: resume modal with single "Lanjutkan" button, timer starts at REMAINING_SECONDS_FROM_DB, prePopulateAnswers fills all radio buttons and answered count before render, UpdateSessionProgress called on nav + every 30s, expired path auto-submits with modal. Build: 0 errors.</done>
</task>

</tasks>

<verification>
- `dotnet build` exits 0
- Grep Views/CMP/Assessment.cshtml for "InProgress" — finds the Resume button branch
- Grep Views/CMP/Assessment.cshtml for "btn-warning" — confirms Resume button uses warning color (per user decision)
- Grep Views/CMP/StartExam.cshtml for "resumeConfirmModal" — finds modal HTML + JS initialization
- Grep Views/CMP/StartExam.cshtml for "REMAINING_SECONDS_FROM_DB" — confirms timer uses server value not full duration
- Grep Views/CMP/StartExam.cshtml for "prePopulateAnswers" — finds function definition and call in init block
- Grep Views/CMP/StartExam.cshtml for "saveSessionProgress" — finds function + setInterval + performPageSwitch call
- Grep Views/CMP/StartExam.cshtml for "EXAM_EXPIRED" — finds expired path in init block
</verification>

<success_criteria>
Complete session resume frontend implemented. Workers see Resume button in yellow on assignment cards. Resume modal appears before exam loads. Timer counts from remaining time. All previous answers pre-checked. Progress saved every 30s + on navigation. Expired exam auto-submits. No deferred ideas implemented (no mobile-specific UI, no auto-recovery for stale questions).
</success_criteria>

<output>
After completion, create `.planning/phases/42-session-resume/42-03-SUMMARY.md`
</output>
