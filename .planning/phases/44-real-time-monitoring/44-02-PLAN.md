---
phase: 44-real-time-monitoring
plan: 02
type: execute
wave: 2
depends_on:
  - 44-01
files_modified:
  - Views/CMP/AssessmentMonitoringDetail.cshtml
autonomous: false

must_haves:
  truths:
    - "Table auto-updates every 10 seconds — status, progress, score, result, and time remaining cells change without page refresh"
    - "NIP column is removed; 'Jumlah Soal' column is renamed 'Progress' and shows X/Total format"
    - "New 'Time Remaining' column shows a live client-side countdown for InProgress sessions; shows '—' for Not started, Completed, Abandoned"
    - "Summary counts (Total, Completed, InProgress, Not Started) update on each polling cycle"
    - "Polling stops silently when all sessions reach Completed status"
    - "'Tutup Lebih Awal' button is hidden when all sessions are Completed"
    - "Action buttons update live: Completed shows View Results + Reset; Abandoned shows Reset only; Not started/InProgress shows Reshuffle + Force Close"
    - "'Last updated: HH:MM:SS' indicator is visible on the page and refreshes each poll cycle"
    - "On fetch failure a small non-disruptive error indicator appears; it disappears on next successful poll"
    - "View Results button opens /CMP/Results/{sessionId} in a new tab"
  artifacts:
    - path: "Views/CMP/AssessmentMonitoringDetail.cshtml"
      provides: "Polling JS + updated table structure"
      contains: "fetchProgress"
  key_links:
    - from: "JS fetchProgress()"
      to: "/CMP/GetMonitoringProgress"
      via: "fetch API with URLSearchParams from hidden fields"
      pattern: "fetch.*GetMonitoringProgress"
    - from: "JS updateRow(session)"
      to: "tr[data-session-id]"
      via: "document.querySelector DOM targeting"
      pattern: "data-session-id"
    - from: "JS tickCountdowns()"
      to: "countdownMap"
      via: "setInterval 1s decrement + cell update"
      pattern: "countdownMap"
---

<objective>
Update AssessmentMonitoringDetail.cshtml to implement real-time polling: restructure the table columns, add data-session-id row attributes, add JS polling logic (10s fetch + 1s countdown tick), and wire up all live UI updates.

Purpose: HC can monitor exam progress live — no manual refresh required. Status, progress, scores, time remaining, and action buttons all update automatically.
Output: Single file modified — AssessmentMonitoringDetail.cshtml.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/44-real-time-monitoring/44-01-SUMMARY.md
@Views/CMP/AssessmentMonitoringDetail.cshtml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restructure table — remove NIP, rename/reformat Progress, add Time Remaining, add data attributes and IDs</name>
  <files>Views/CMP/AssessmentMonitoringDetail.cshtml</files>
  <action>
Make these structural changes to the Razor view. Do NOT change any controller, model, or business logic.

**1. Summary cards — add live-update IDs and expand to 4 cards.**

Replace the 3-card row (Total Assigned, Completed, Pass Rate) with a 4-card row:

```html
<div class="row g-3 mb-4">
    <div class="col-sm-3">
        <div class="card border-0 shadow-sm text-center py-3">
            <div class="fs-3 fw-bold text-primary" id="count-total">@Model.TotalCount</div>
            <div class="text-muted small">Total Assigned</div>
        </div>
    </div>
    <div class="col-sm-3">
        <div class="card border-0 shadow-sm text-center py-3">
            <div class="fs-3 fw-bold text-success" id="count-completed">@Model.CompletedCount</div>
            <div class="text-muted small">Completed</div>
        </div>
    </div>
    <div class="col-sm-3">
        <div class="card border-0 shadow-sm text-center py-3">
            <div class="fs-3 fw-bold text-warning" id="count-inprogress">@(Model.Sessions.Count(s => s.UserStatus == "InProgress"))</div>
            <div class="text-muted small">In Progress</div>
        </div>
    </div>
    <div class="col-sm-3">
        <div class="card border-0 shadow-sm text-center py-3">
            <div class="fs-3 fw-bold text-secondary" id="count-notstarted">@Model.PendingCount</div>
            <div class="text-muted small">Not Started</div>
        </div>
    </div>
</div>
```

**2. "Tutup Lebih Awal" button — add id="closeEarlyBtn".**

The button is inside `@if (Model.GroupStatus == "Open")` near the top of the card header. Add `id="closeEarlyBtn"` to the `<button>` element:

```html
<button type="button" class="btn btn-warning btn-sm" id="closeEarlyBtn"
        data-bs-toggle="modal" data-bs-target="#closeEarlyModal">
    <i class="bi bi-clock-history me-1"></i>Submit Assessment
</button>
```

**3. Table header — remove NIP, rename Jumlah Soal → Progress, add Time Remaining.**

Replace the `<thead>` row:
```html
<tr>
    <th>Name</th>
    <th>Progress</th>
    <th>Status</th>
    <th>Score</th>
    <th>Result</th>
    <th>Completed At</th>
    <th>Time Remaining</th>
    <th>Actions</th>
</tr>
```
(8 columns total — same as before; NIP removed, Time Remaining added.)

**4. Table rows — add data-session-id, remove NIP td, reformat Progress td, add Time Remaining td, add cell classes.**

Change `<tr>` to `<tr data-session-id="@session.Id">`.

Remove the NIP `<td>` entirely.

Replace the Jumlah Soal `<td>`:
```html
<td class="text-center progress-cell">@session.QuestionCount > 0 ? $"{0}/{session.QuestionCount}" : "—"</td>
```
Wait — the initial answered count is not in the ViewModel (Phase 44 adds live updates; initial render shows 0/Total is acceptable since polling starts immediately). Use:
```html
<td class="text-center progress-cell">@(session.QuestionCount > 0 ? $"—/{session.QuestionCount}" : "—")</td>
```

Add class to Status `<td>`: `<td class="status-cell">`.
Add class to Score `<td>`: `<td class="score-cell">`.
Add class to Result `<td class="result-cell @resultClass">`.
Add class to Completed At `<td>`: `<td class="completedat-cell text-muted small">`.

Add Time Remaining `<td>` before Actions:
```html
<td class="timeremaining-cell text-muted">—</td>
```
(Initial value is always "—"; JS polling will populate it immediately on first fetch.)

**5. Empty-row colspan stays 8.** The empty-row `<td colspan="8">` is correct — keep unchanged.

**6. Add global antiforgery hidden form (outside all @if blocks, after the closing `</div>` of the main card).**

```html
<!-- Global antiforgery token for JS-rendered action buttons -->
<form id="antiforgeryForm" style="display:none">@Html.AntiForgeryToken()</form>
```

**7. Add hidden fields for polling params and "Last updated" indicator.**

After the global antiforgery form:
```html
<!-- Hidden fields for polling endpoint params -->
<input type="hidden" id="hTitle" value="@Model.Title" />
<input type="hidden" id="hCategory" value="@Model.Category" />
<input type="hidden" id="hScheduleDate" value="@Model.Schedule.ToString("yyyy-MM-dd")" />

<!-- Last updated + error indicator -->
<div class="d-flex align-items-center gap-3 mt-2 px-1">
    <small class="text-muted">
        Last updated: <span id="last-updated-time">—</span>
    </small>
    <span id="poll-error" class="badge bg-warning text-dark" style="display:none;">Update error — retrying</span>
</div>
```
  </action>
  <verify>Open the AssessmentMonitoringDetail page in a browser. Confirm: 4 summary cards visible, NIP column gone, table header shows "Progress / Status / Score / Result / Completed At / Time Remaining / Actions", each `<tr>` has a `data-session-id` attribute (inspect element), "Last updated: —" text appears below the table.</verify>
  <done>Table has correct 8-column structure. Summary shows 4 cards. Every data row has data-session-id. NIP column absent. "Last updated: —" visible.</done>
</task>

<task type="auto">
  <name>Task 2: Add polling JS block (fetchProgress 10s + tickCountdowns 1s + all update helpers)</name>
  <files>Views/CMP/AssessmentMonitoringDetail.cshtml</files>
  <action>
Add a new `<script>` block at the bottom of the file (after the existing `@if (Model.IsPackageMode) { <script>...</script> }` block). This new script block is NOT gated by `@if` — it runs on every page load.

```html
<script>
(function () {
    // ---- State ----
    var countdownMap = {}; // { sessionId: remainingSeconds | null }
    var pollingActive = true;
    var pollingTimer = null;
    var countdownTimer = null;

    // ---- Read page params from hidden fields ----
    var hTitle        = document.getElementById('hTitle').value;
    var hCategory     = document.getElementById('hCategory').value;
    var hScheduleDate = document.getElementById('hScheduleDate').value;

    // ---- Antiforgery token (for JS-rendered Reset / ForceClose forms) ----
    function getToken() {
        var inp = document.querySelector('#antiforgeryForm input[name="__RequestVerificationToken"]');
        return inp ? inp.value : '';
    }

    // ---- Status badge class helper ----
    function statusBadgeClass(status) {
        if (status === 'Completed')  return 'badge bg-success';
        if (status === 'InProgress') return 'badge bg-warning text-dark';
        if (status === 'Abandoned')  return 'badge bg-secondary';
        return 'badge bg-light text-dark border'; // Not started
    }

    // ---- Build actions HTML per status ----
    function buildActionsHtml(session, isPackageMode) {
        var html = '';
        var token = getToken();

        // Reshuffle button (package mode only)
        if (isPackageMode) {
            var canReshuffle = (session.status === 'Not started');
            html += '<button type="button"'
                + ' class="btn btn-outline-primary btn-sm me-1' + (canReshuffle ? '' : ' disabled') + '"'
                + (canReshuffle ? '' : ' disabled')
                + ' data-session-id="' + session.sessionId + '"'
                + (canReshuffle ? ' onclick="reshuffleWorker(' + session.sessionId + ')"' : '')
                + '><i class="bi bi-shuffle me-1"></i>Reshuffle</button>';
        }

        if (session.status === 'Completed') {
            // View Results (new tab) + Reset
            html += '<a href="/CMP/Results/' + session.sessionId + '" target="_blank"'
                + ' class="btn btn-success btn-sm me-1">View Results</a>';
            html += '<form class="d-inline" method="post" action="/CMP/ResetAssessment"'
                + ' onsubmit="return confirm(\'Reset sesi ini? Semua jawaban akan dihapus dan peserta dapat mengulang ujian.\')">'
                + '<input type="hidden" name="__RequestVerificationToken" value="' + token + '" />'
                + '<input type="hidden" name="id" value="' + session.sessionId + '" />'
                + '<button type="submit" class="btn btn-warning btn-sm"><i class="bi bi-arrow-counterclockwise me-1"></i>Reset</button>'
                + '</form>';
        } else if (session.status === 'Abandoned') {
            // Reset only
            html += '<form class="d-inline" method="post" action="/CMP/ResetAssessment"'
                + ' onsubmit="return confirm(\'Reset sesi ini? Semua jawaban akan dihapus dan peserta dapat mengulang ujian.\')">'
                + '<input type="hidden" name="__RequestVerificationToken" value="' + token + '" />'
                + '<input type="hidden" name="id" value="' + session.sessionId + '" />'
                + '<button type="submit" class="btn btn-warning btn-sm"><i class="bi bi-arrow-counterclockwise me-1"></i>Reset</button>'
                + '</form>';
        } else {
            // Not started or InProgress: Force Close
            html += '<form class="d-inline" method="post" action="/CMP/ForceCloseAssessment"'
                + ' onsubmit="return confirm(\'Tutup paksa sesi ini? Skor akan dicatat sebagai 0 dan peserta dinyatakan tidak lulus.\')">'
                + '<input type="hidden" name="__RequestVerificationToken" value="' + token + '" />'
                + '<input type="hidden" name="id" value="' + session.sessionId + '" />'
                + '<button type="submit" class="btn btn-danger btn-sm"><i class="bi bi-x-circle me-1"></i>Force Close</button>'
                + '</form>';
        }
        return html;
    }

    // ---- Format time remaining ----
    function formatTime(secs) {
        if (secs === null || secs === undefined) return '—';
        if (secs <= 0) return '00:00';
        var m = Math.floor(secs / 60);
        var s = secs % 60;
        return String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
    }

    // ---- Detect package mode from page (Reshuffle button presence) ----
    var isPackageMode = (document.getElementById('reshuffleForm') !== null);

    // ---- Update a single row ----
    function updateRow(session) {
        var tr = document.querySelector('tr[data-session-id="' + session.sessionId + '"]');
        if (!tr) return;

        var tds = tr.querySelectorAll('td');
        // Column order (0-indexed): Name=0, Progress=1, Status=2, Score=3, Result=4, CompletedAt=5, TimeRemaining=6, Actions=7

        // Progress (col 1)
        var total = session.totalQuestions || 0;
        tds[1].textContent = total > 0 ? (session.progress + '/' + total) : '—';

        // Status (col 2)
        tds[2].innerHTML = '<span class="' + statusBadgeClass(session.status) + '">' + session.status + '</span>';

        // Score (col 3)
        tds[3].textContent = session.score !== null && session.score !== undefined ? session.score + '%' : '—';

        // Result (col 4)
        var resultText = session.result || '—';
        var resultClass = session.result === 'Pass' ? 'text-success fw-semibold' : (session.result === 'Fail' ? 'text-danger fw-semibold' : 'text-muted');
        tds[4].textContent = resultText;
        tds[4].className = 'result-cell ' + resultClass;

        // Completed At (col 5)
        if (session.completedAt) {
            var d = new Date(session.completedAt);
            tds[5].textContent = d.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' })
                + ' ' + d.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
        } else {
            tds[5].textContent = '—';
        }

        // Time Remaining (col 6) — re-sync countdownMap from server snapshot
        countdownMap[session.sessionId] = session.status === 'InProgress' ? session.remainingSeconds : null;
        tds[6].textContent = formatTime(countdownMap[session.sessionId]);

        // Actions (col 7)
        tds[7].innerHTML = buildActionsHtml(session, isPackageMode);
    }

    // ---- Tick countdown every second ----
    function tickCountdowns() {
        Object.keys(countdownMap).forEach(function (idStr) {
            var id = parseInt(idStr, 10);
            var secs = countdownMap[id];
            if (secs !== null && secs > 0) {
                countdownMap[id] = secs - 1;
                var tr = document.querySelector('tr[data-session-id="' + id + '"]');
                if (tr) {
                    var tds = tr.querySelectorAll('td');
                    if (tds[6]) tds[6].textContent = formatTime(countdownMap[id]);
                }
            }
        });
    }

    // ---- Update summary counts ----
    function updateSummary(sessions) {
        var total      = sessions.length;
        var completed  = sessions.filter(function (s) { return s.status === 'Completed'; }).length;
        var inProgress = sessions.filter(function (s) { return s.status === 'InProgress'; }).length;
        var notStarted = sessions.filter(function (s) { return s.status === 'Not started'; }).length;

        var elTotal      = document.getElementById('count-total');
        var elCompleted  = document.getElementById('count-completed');
        var elInProgress = document.getElementById('count-inprogress');
        var elNotStarted = document.getElementById('count-notstarted');

        if (elTotal)      elTotal.textContent      = total;
        if (elCompleted)  elCompleted.textContent  = completed;
        if (elInProgress) elInProgress.textContent = inProgress;
        if (elNotStarted) elNotStarted.textContent = notStarted;
    }

    // ---- Update "Last updated" timestamp ----
    function updateLastUpdated() {
        var el = document.getElementById('last-updated-time');
        if (el) el.textContent = new Date().toLocaleTimeString('id-ID');
        // Hide error indicator on success
        var errEl = document.getElementById('poll-error');
        if (errEl) errEl.style.display = 'none';
    }

    // ---- Show error indicator on fetch failure ----
    function showErrorIndicator() {
        var errEl = document.getElementById('poll-error');
        if (errEl) errEl.style.display = '';
    }

    // ---- Main poll function ----
    async function fetchProgress() {
        if (!pollingActive) return;
        try {
            var url = '/CMP/GetMonitoringProgress'
                + '?title=' + encodeURIComponent(hTitle)
                + '&category=' + encodeURIComponent(hCategory)
                + '&scheduleDate=' + encodeURIComponent(hScheduleDate);

            var resp = await fetch(url);
            if (!resp.ok) { showErrorIndicator(); return; }

            var sessions = await resp.json();
            sessions.forEach(updateRow);
            updateSummary(sessions);
            updateLastUpdated();

            // Stop polling when all sessions are Completed
            if (sessions.length > 0 && sessions.every(function (s) { return s.status === 'Completed'; })) {
                clearInterval(pollingTimer);
                clearInterval(countdownTimer);
                pollingActive = false;

                // Hide "Tutup Lebih Awal" button
                var closeBtn = document.getElementById('closeEarlyBtn');
                if (closeBtn) closeBtn.style.display = 'none';
            }
        } catch (e) {
            showErrorIndicator();
        }
    }

    // ---- Start intervals ----
    pollingTimer   = setInterval(fetchProgress, 10000);
    countdownTimer = setInterval(tickCountdowns, 1000);

    // Run first poll immediately (don't wait 10s)
    fetchProgress();
})();
</script>
```

Place this script block after the closing `}` of the existing `@if (Model.IsPackageMode) { <script>...</script> }` block. The IIFE pattern keeps all variables scoped and avoids conflicts with the existing jQuery reshuffle code.

Note: the column index mapping (`tds[0]` through `tds[7]`) must match the new 8-column table: Name(0), Progress(1), Status(2), Score(3), Result(4), Completed At(5), Time Remaining(6), Actions(7). This is correct given the Task 1 header structure.
  </action>
  <verify>
1. Open AssessmentMonitoringDetail for an active exam (GroupStatus = Open, some sessions InProgress).
2. Open browser DevTools Network tab — confirm /CMP/GetMonitoringProgress requests fire every ~10s.
3. Confirm "Last updated: HH:MM:SS" updates on each cycle.
4. Confirm InProgress rows show a countdown ticking down in the Time Remaining column.
5. Confirm Not started rows show "—" in Time Remaining.
6. On a session completing: Status badge changes to Completed, Actions column shows "View Results" + "Reset".
7. "View Results" link opens /CMP/Results/{sessionId} in a new tab.
8. When all sessions complete: polling stops (no more network requests), "Tutup Lebih Awal" button disappears.
  </verify>
  <done>
Polling JS runs every 10s. Countdown ticks every 1s. All 13 requirements (MON-RT-01 through MON-RT-13) met. Page auto-updates without manual refresh. Polling stops silently when all Completed.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete real-time monitoring implementation:
- Plan 01: GetMonitoringProgress endpoint (JSON array of session DTOs)
- Plan 02 Task 1: Table restructured — NIP removed, Progress (X/Total), Time Remaining column, data-session-id on rows, 4-card summary
- Plan 02 Task 2: JS polling (10s fetch + 1s countdown) — live status, progress, score, result, countdown, actions, "Last updated" indicator
  </what-built>
  <how-to-verify>
1. Open an active AssessmentMonitoringDetail page (GroupStatus = Open) — confirm 4 summary cards, no NIP column, "Progress" and "Time Remaining" columns present.
2. Open DevTools Network tab — confirm GET /CMP/GetMonitoringProgress fires every ~10 seconds.
3. Confirm "Last updated: HH:MM:SS" timestamp updates on each poll.
4. For any InProgress session — confirm Time Remaining counts down every second.
5. For a Not started session — confirm Time Remaining shows "—".
6. When a session completes (or simulate via ForceClose) — confirm Status badge changes to "Completed", Actions column shows "View Results" and "Reset" buttons without page refresh.
7. Click "View Results" — confirm it opens /CMP/Results/{sessionId} in a new tab.
8. Disconnect network briefly (DevTools → Offline) — confirm "Update error — retrying" badge appears. Reconnect — confirm it disappears on next successful poll.
9. When all sessions complete — confirm polling stops (no more network requests), "Submit Assessment" button disappears.
10. Verify ForceClose and Reset actions still work from the JS-rendered buttons (antiforgery token is included).
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
All 13 MON-RT requirements satisfied:
- MON-RT-01: GET /CMP/GetMonitoringProgress endpoint exists, HC/Admin only, no antiforgery
- MON-RT-02: DTO contains sessionId, status, progress, totalQuestions, score, result, remainingSeconds, completedAt
- MON-RT-03: Page polls every 10 seconds
- MON-RT-04: NIP removed, "Jumlah Soal" → "Progress" (X/Total), new "Time Remaining" column
- MON-RT-05: 1s countdown tick; re-synced from remainingSeconds each 10s poll
- MON-RT-06: Each tr has data-session-id; cells targeted individually
- MON-RT-07: Summary counts update on each poll
- MON-RT-08: Polling stops when all sessions Completed
- MON-RT-09: "Tutup Lebih Awal" button hidden when all Completed
- MON-RT-10: "Last updated: HH:MM:SS" indicator shown
- MON-RT-11: poll-error badge on fetch failure, hidden on next success
- MON-RT-12: Actions buttons update live per status
- MON-RT-13: View Results opens /CMP/Results/{sessionId} in new tab
</verification>

<success_criteria>
- All 13 MON-RT requirements verified working
- No page refresh required for any status update
- Polling stops silently when exam group is fully complete
- Human verification approved
</success_criteria>

<output>
After completion, create `.planning/phases/44-real-time-monitoring/44-02-SUMMARY.md`
</output>
