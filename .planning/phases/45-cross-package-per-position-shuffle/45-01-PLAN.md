---
phase: 45-cross-package-per-position-shuffle
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Migrations/<timestamp>_ClearUserPackageAssignments.cs
  - Controllers/CMPController.cs
autonomous: true

must_haves:
  truths:
    - "All UserPackageAssignment records are deleted on migration (clean break)"
    - "StartExam creates a cross-package assignment: ShuffledQuestionIds contains IDs from multiple packages in slot-list order"
    - "For 1 package: ShuffledQuestionIds contains that package's questions in original DB order (no shuffle)"
    - "For N packages (N>=2): even distribution (K/N per package, remainder randomly allocated) then Fisher-Yates shuffled slot list"
    - "AssessmentPackageId is set to the first package's ID (sentinel — no schema change)"
    - "ShuffledOptionIdsPerQuestion is written as '{}' (option shuffle removed)"
  artifacts:
    - path: "Controllers/CMPController.cs"
      provides: "BuildCrossPackageAssignment private helper method + rewritten StartExam assignment creation block"
      contains: "BuildCrossPackageAssignment"
    - path: "Migrations/<timestamp>_ClearUserPackageAssignments.cs"
      provides: "EF Core migration that DELETEs all UserPackageAssignment records"
      contains: "DELETE FROM UserPackageAssignments"
  key_links:
    - from: "StartExam (lines ~2853-2890)"
      to: "BuildCrossPackageAssignment helper"
      via: "method call replacing old random single-package selection"
      pattern: "BuildCrossPackageAssignment"
    - from: "BuildCrossPackageAssignment"
      to: "UserPackageAssignment.ShuffledQuestionIds"
      via: "JsonSerializer.Serialize of cross-package ID list"
      pattern: "JsonSerializer\\.Serialize.*shuffledIds"
---

<objective>
Create the EF Core migration that deletes all existing UserPackageAssignment records, implement the slot-list shuffle algorithm as a private helper, and rewrite StartExam's assignment creation block to use cross-package per-position selection.

Purpose: This is the foundation change. Consumers (SubmitExam, ExamSummary, Results, Reshuffle) all depend on ShuffledQuestionIds now containing cross-package IDs — but Plan 01 only touches assignment creation. Consumer fixes are Plan 02.

Output: Migration file + rewritten StartExam assignment block + BuildCrossPackageAssignment helper.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Controllers/CMPController.cs
@Models/UserPackageAssignment.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: EF Core migration to delete all UserPackageAssignments</name>
  <files>Migrations/<timestamp>_ClearUserPackageAssignments.cs</files>
  <action>
Run `dotnet ef migrations add ClearUserPackageAssignments` from the project root to scaffold a blank migration, then open the generated file and add to Up():

```csharp
migrationBuilder.Sql("DELETE FROM UserPackageAssignments");
```

Leave Down() empty (no rollback — clean break per user decision).

Do NOT add any schema changes — no columns added or removed. This is a data migration only.

After adding the Sql call, run `dotnet ef database update` to apply the migration. Verify by checking that the migration file exists and the database has 0 rows in UserPackageAssignments (run `dotnet ef migrations list` to confirm it appears).

Note: The timestamp in the filename is auto-generated by EF. Do not hardcode it.
  </action>
  <verify>
Run `dotnet ef migrations list` — `ClearUserPackageAssignments` appears as the latest migration.
Run `dotnet build` — no build errors.
  </verify>
  <done>Migration file exists with `migrationBuilder.Sql("DELETE FROM UserPackageAssignments")` in Up(). Build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Implement BuildCrossPackageAssignment helper + rewrite StartExam assignment creation</name>
  <files>Controllers/CMPController.cs</files>
  <action>
**Part A — Add private helper method** `BuildCrossPackageAssignment` to CMPController (near other private helpers like `Shuffle`):

```csharp
/// <summary>
/// Builds a cross-package ShuffledQuestionIds list using the slot-list algorithm.
/// Per user decision: guaranteed even distribution (K/N per package, remainder randomly allocated),
/// Fisher-Yates shuffle of the slot list, then position i → package[slot[i]].Questions ordered by Order, take index pkgCounter[pkgIdx].
/// For 1 package: returns questions in original DB order (no shuffle).
/// All packages must be loaded with .Include(p => p.Questions) — questions ordered by q.Order.
/// </summary>
private static List<int> BuildCrossPackageAssignment(List<AssessmentPackage> packages, Random rng)
{
    if (packages.Count == 0)
        return new List<int>();

    // Single package: return questions in original DB order (no shuffle per user decision)
    if (packages.Count == 1)
    {
        return packages[0].Questions.OrderBy(q => q.Order).Select(q => q.Id).ToList();
    }

    // Safety fallback: use minimum question count across packages (edge case per user decision)
    int K = packages.Min(p => p.Questions.Count);
    if (K == 0)
        return new List<int>();

    int N = packages.Count;
    int baseCount = K / N;
    int remainder = K % N;

    // Decide which package indices get +1 question (random allocation of remainder)
    var remainderIndices = Enumerable.Range(0, N)
        .OrderBy(_ => rng.Next())
        .Take(remainder)
        .ToHashSet();

    // Build slot list: [pkg0 × baseCount(+1?), pkg1 × baseCount(+1?), ...]
    var slots = new List<int>();
    for (int i = 0; i < N; i++)
    {
        int count = baseCount + (remainderIndices.Contains(i) ? 1 : 0);
        for (int j = 0; j < count; j++)
            slots.Add(i);
    }

    // Fisher-Yates shuffle the slot list
    Shuffle(slots, rng);

    // Build ShuffledQuestionIds: for position p, take package[slots[p]].Questions ordered by Order, at index pkgCounter[pkgIdx]
    var pkgCounter = new int[N];
    var shuffledIds = new List<int>();
    var orderedQuestions = packages.Select(p => p.Questions.OrderBy(q => q.Order).ToList()).ToList();

    for (int pos = 0; pos < K; pos++)
    {
        int pkgIdx = slots[pos];
        var question = orderedQuestions[pkgIdx][pkgCounter[pkgIdx]];
        pkgCounter[pkgIdx]++;
        shuffledIds.Add(question.Id);
    }

    return shuffledIds;
}
```

**Part B — Rewrite StartExam assignment creation block** (currently lines ~2853–2890 in CMPController.cs):

Locate the block that starts with:
```csharp
if (assignment == null)
{
    // Randomly assign a package
    var rng = new Random();
    var selectedPackage = packages[rng.Next(packages.Count)];
    ...
```

Replace that entire `if (assignment == null)` block with:

```csharp
if (assignment == null)
{
    var rng = new Random();

    // Build cross-package ShuffledQuestionIds (per user decision: slot-list algorithm)
    var shuffledIds = BuildCrossPackageAssignment(packages, rng);

    // Sentinel: store first package ID (no schema change — AssessmentPackageId still required by FK)
    var sentinelPackage = packages.First();

    assignment = new UserPackageAssignment
    {
        AssessmentSessionId = id,
        AssessmentPackageId = sentinelPackage.Id,  // sentinel per discretion decision
        UserId = user.Id,
        ShuffledQuestionIds = JsonSerializer.Serialize(shuffledIds),
        ShuffledOptionIdsPerQuestion = "{}"  // option shuffle removed per user decision
    };
    _context.UserPackageAssignments.Add(assignment);
    await _context.SaveChangesAsync();

    // Record question count for stale-question detection on resume (RESUME-03 safety net)
    assignment.SavedQuestionCount = shuffledIds.Count;
    await _context.SaveChangesAsync();
}
```

**Important:** The `Shuffle` generic method already exists in CMPController. Do not redefine it. The `BuildCrossPackageAssignment` helper calls `Shuffle(slots, rng)` — this works because slots is `List<int>`.

Do NOT change anything after the `if (assignment == null)` block in this task. The ViewModel build section (lines ~2892–2960) will be fixed in Plan 02.

**Also fix the stale-question check** immediately after the assignment block (lines ~2893–2910). Currently it reads:
```csharp
var assignedPackage = packages.First(p => p.Id == assignment.AssessmentPackageId);
if (assessment.StartedAt != null && assignment.SavedQuestionCount.HasValue &&
    assignment.SavedQuestionCount.Value != assignedPackage.Questions.Count)
```

Change the stale check to compare against the total shuffled question count:
```csharp
// For cross-package assignments, SavedQuestionCount = shuffledIds.Count at time of creation
// Compare against re-derived count: minimum question count across packages (safety fallback)
int currentQuestionCount = packages.Min(p => p.Questions.Count) == 0
    ? 0
    : (packages.Count == 1 ? packages[0].Questions.Count : packages.Min(p => p.Questions.Count));
if (assessment.StartedAt != null && assignment.SavedQuestionCount.HasValue &&
    assignment.SavedQuestionCount.Value != currentQuestionCount)
{
    // ... rest unchanged
}
```

Remove the `var assignedPackage = packages.First(p => p.Id == assignment.AssessmentPackageId);` line that was only used by the stale check.
  </action>
  <verify>
Run `dotnet build` from project root — zero errors and zero warnings (or same warnings as before).
Search for `BuildCrossPackageAssignment` in Controllers/CMPController.cs — appears at least twice (definition + call site in StartExam).
Search for `ShuffledOptionIdsPerQuestion = "{}"` — appears in StartExam assignment creation block.
Search for `Randomly assign a package` — should NOT appear (old comment gone).
  </verify>
  <done>
Build passes. BuildCrossPackageAssignment exists as a private static method. StartExam's assignment creation block uses slot-list algorithm, writes AssessmentPackageId = sentinelPackage.Id, writes ShuffledOptionIdsPerQuestion = "{}". For 1 package: questions in DB order. For N packages: even distribution, Fisher-Yates shuffled slots.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` passes with no errors.
2. `dotnet ef migrations list` shows `ClearUserPackageAssignments` as applied.
3. `Controllers/CMPController.cs` contains `BuildCrossPackageAssignment` private static method.
4. StartExam assignment creation uses `BuildCrossPackageAssignment(packages, rng)` — no direct `packages[rng.Next(...)]` single-package random selection.
5. `ShuffledOptionIdsPerQuestion = "{}"` in the new assignment creation block.
6. `AssessmentPackageId = sentinelPackage.Id` (first package) in new block.
</verification>

<success_criteria>
- Migration exists and deletes all UserPackageAssignment rows on apply.
- BuildCrossPackageAssignment correctly implements slot-list algorithm: 1 pkg = ordered, N pkgs = even distribution + Fisher-Yates.
- StartExam assignment creation calls BuildCrossPackageAssignment — workers starting exams after this plan get cross-package question IDs in ShuffledQuestionIds.
- Build passes.
</success_criteria>

<output>
After completion, create `.planning/phases/45-cross-package-per-position-shuffle/45-01-SUMMARY.md`
</output>
