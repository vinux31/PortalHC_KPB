---
phase: 45-cross-package-per-position-shuffle
plan: 03
type: execute
wave: 3
depends_on: ["45-01", "45-02"]
files_modified:
  - Controllers/CMPController.cs
  - Views/CMP/ManagePackages.cshtml
autonomous: true

must_haves:
  truths:
    - "ReshufflePackage applies slot-list algorithm — new assignment uses cross-package IDs, ShuffledOptionIdsPerQuestion='{}'"
    - "ReshuffleAll applies slot-list algorithm for every eligible (Not Started) session independently"
    - "Importing questions to Package B when count differs from Package A is blocked with localized error message"
    - "ManagePackages page shows mode indicator (Single Package or Multi-Package N paket) and per-package OK/Warning status"
    - "Mismatch warning visible on ManagePackages but HC can still proceed (not blocked)"
  artifacts:
    - path: "Controllers/CMPController.cs"
      provides: "Rewritten ReshufflePackage + ReshuffleAll using BuildCrossPackageAssignment + ImportPackageQuestions count validation"
      contains: "BuildCrossPackageAssignment"
    - path: "Views/CMP/ManagePackages.cshtml"
      provides: "Summary panel with mode indicator and per-package status badges"
      contains: "Single Package"
  key_links:
    - from: "ReshufflePackage (lines ~1199-1311)"
      to: "BuildCrossPackageAssignment"
      via: "Replace selectedPackage single-package logic with slot-list call"
      pattern: "BuildCrossPackageAssignment.*packages.*rng"
    - from: "ReshuffleAll (lines ~1317-1441)"
      to: "BuildCrossPackageAssignment"
      via: "Replace per-session selectedPackage logic with slot-list call"
      pattern: "BuildCrossPackageAssignment.*packages.*rng"
    - from: "ImportPackageQuestions POST (lines ~4025-4198)"
      to: "sibling package question counts"
      via: "Validation after validRows built, before SaveChanges"
      pattern: "Jumlah soal tidak sama"
    - from: "ManagePackages view"
      to: "packages list + question counts"
      via: "Razor summary panel above package list table"
      pattern: "Multi-Package"
---

<objective>
Rewrite ReshufflePackage and ReshuffleAll to use the slot-list algorithm (BuildCrossPackageAssignment from Plan 01), add cross-package count validation to ImportPackageQuestions, and add a summary panel to ManagePackages.cshtml.

Purpose: Reshuffling must produce the same cross-package format as StartExam. Import validation prevents mismatched package sizes from causing uneven distributions. The summary panel gives HC visibility into package status.

Output: Reshuffle actions updated, import validation added, ManagePackages view enhanced.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Controllers/CMPController.cs
@Views/CMP/ManagePackages.cshtml
@.planning/phases/45-cross-package-per-position-shuffle/45-01-SUMMARY.md
@.planning/phases/45-cross-package-per-position-shuffle/45-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite ReshufflePackage and ReshuffleAll with slot-list algorithm</name>
  <files>Controllers/CMPController.cs</files>
  <action>
**Fix 1 — ReshufflePackage** (lines ~1199–1311):

The current logic picks a single `selectedPackage` (preferring a different one than current) then Fisher-Yates shuffles that package's question order + option order.

Replace the core shuffle logic. Keep everything BEFORE the "Select a new package" block unchanged (eligibility check, sibling session load, packages load, current assignment load). The audit log at the end also stays.

Remove:
- The "Select a different package" block (lines ~1244-1255)
- The `AssessmentPackage selectedPackage;` variable
- The `string oldPackageName = ...` line
- The question shuffle block (`var questionIds = selectedPackage.Questions...Shuffle(questionIds, rng)`)
- The option shuffle block (`var optionOrderDict = ...`)

Replace the entire "Delete existing assignment if one exists" and "Create new assignment" section with:

```csharp
string oldPackageName = currentAssignment != null
    ? (packages.FirstOrDefault(p => p.Id == currentAssignment.AssessmentPackageId)?.PackageName ?? "?")
    : "(none)";

// Delete existing assignment if one exists
if (currentAssignment != null)
    _context.UserPackageAssignments.Remove(currentAssignment);

// Build cross-package ShuffledQuestionIds (per user decision: slot-list algorithm)
var rng = new Random();
var shuffledIds = BuildCrossPackageAssignment(packages, rng);
var sentinelPackage = packages.First();

// Create new assignment
var newAssignment = new UserPackageAssignment
{
    AssessmentSessionId = sessionId,
    AssessmentPackageId = sentinelPackage.Id,  // sentinel per discretion decision
    UserId = assessment.UserId,
    ShuffledQuestionIds = System.Text.Json.JsonSerializer.Serialize(shuffledIds),
    ShuffledOptionIdsPerQuestion = "{}"  // option shuffle removed per user decision
};
_context.UserPackageAssignments.Add(newAssignment);
await _context.SaveChangesAsync();
```

Update the audit log message to reflect the new format (no longer has a single "selected package"):
```csharp
$"Reshuffled package (cross-package) for user {assessment.UserId} on assessment '{assessment.Title}' [SessionID={sessionId}]: {shuffledIds.Count} questions from {packages.Count} packages"
```

Update the return statement:
```csharp
return Json(new { success = true, packageName = $"Cross-package ({packages.Count} paket)", assignmentId = newAssignment.Id });
```

**Fix 2 — ReshuffleAll** (lines ~1317–1441):

Keep the session load, sibling ID derivation, packages load, existing assignments load, and session eligibility check unchanged.

Inside the per-session loop, remove:
- The "Select a different package if possible" block (existingAssignment comparison)
- The `AssessmentPackage selectedPackage;` logic
- The question shuffle block
- The option shuffle block

Replace with:
```csharp
// Build cross-package ShuffledQuestionIds for this session (independent draw per worker per user decision)
var sessionShuffledIds = BuildCrossPackageAssignment(packages, rng);
var sentinelPackage = packages.First();

// Delete old assignment if exists
if (existingAssignment != null)
    _context.UserPackageAssignments.Remove(existingAssignment);

// Add new assignment (accumulated — SaveChangesAsync once at end)
_context.UserPackageAssignments.Add(new UserPackageAssignment
{
    AssessmentSessionId = session.Id,
    AssessmentPackageId = sentinelPackage.Id,  // sentinel per discretion decision
    UserId = session.UserId,
    ShuffledQuestionIds = System.Text.Json.JsonSerializer.Serialize(sessionShuffledIds),
    ShuffledOptionIdsPerQuestion = "{}"  // option shuffle removed per user decision
});

results.Add(new { name = userName, status = $"Reshuffled (cross-package, {packages.Count} paket)" });
reshuffledCount++;
```

Note: `var rng = new Random();` is declared once BEFORE the foreach loop — keep it there and reuse across iterations.
  </action>
  <verify>
`dotnet build` — zero errors.
Search for `otherPackages = packages.Where` in ReshufflePackage — should NOT appear (old single-package selection logic gone).
Search for `BuildCrossPackageAssignment` — appears at least 3 times (StartExam, ReshufflePackage, ReshuffleAll).
Search for `ShuffledOptionIdsPerQuestion = "{}"` — appears at least 3 times (all three assignment creation paths).
  </verify>
  <done>
ReshufflePackage and ReshuffleAll both call BuildCrossPackageAssignment, write ShuffledOptionIdsPerQuestion="{}", use sentinel AssessmentPackageId. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: ImportPackageQuestions validation + ManagePackages summary panel</name>
  <files>Controllers/CMPController.cs, Views/CMP/ManagePackages.cshtml</files>
  <action>
**Fix 3 — ImportPackageQuestions POST count validation** (in CMPController.cs):

The import action handles a single `pkg` (identified by `packageId`). To validate cross-package count:

1. After the parse loop builds `rows` and `errors` (after the `else` branch at line ~4109, before "Validate and persist rows" at line ~4116), add sibling package discovery. The `pkg` has `pkg.AssessmentSessionId`. Load sibling sessions and their packages:

```csharp
// Cross-package count validation (per user decision):
// Find all sibling sessions (same Title/Category/Schedule.Date) and their packages
var targetSession = await _context.AssessmentSessions.FindAsync(pkg.AssessmentSessionId);
if (targetSession != null)
{
    var siblingSessionIds = await _context.AssessmentSessions
        .Where(s => s.Title == targetSession.Title &&
                    s.Category == targetSession.Category &&
                    s.Schedule.Date == targetSession.Schedule.Date)
        .Select(s => s.Id)
        .ToListAsync();

    // Load all sibling packages that have questions AND belong to a different package than the target
    var siblingPackagesWithQuestions = await _context.AssessmentPackages
        .Include(p => p.Questions)
        .Where(p => siblingSessionIds.Contains(p.AssessmentSessionId)
                 && p.Id != packageId
                 && p.Questions.Any())
        .ToListAsync();

    if (siblingPackagesWithQuestions.Any())
    {
        // Count valid (non-duplicate) rows that would be added
        // validRows = rows that pass format checks; compute count from the rows list
        // Note: count valid rows = rows that pass format validation (non-empty Q, non-empty opts, valid correct letter, non-duplicate)
        var validRowCount = rows.Count(r =>
        {
            var (q, a, b, c, d, cor) = r;
            var normalizedCor = ExtractCorrectLetter(cor);
            return !string.IsNullOrWhiteSpace(q) &&
                   !string.IsNullOrWhiteSpace(a) && !string.IsNullOrWhiteSpace(b) &&
                   !string.IsNullOrWhiteSpace(c) && !string.IsNullOrWhiteSpace(d) &&
                   new[] { "A", "B", "C", "D" }.Contains(normalizedCor);
        });

        // Compare against existing non-empty sibling packages
        var referencePackage = siblingPackagesWithQuestions.First();
        int expectedCount = referencePackage.Questions.Count;

        if (validRowCount != expectedCount)
        {
            return Json(new
            {
                success = false,
                error = $"Jumlah soal tidak sama dengan paket lain. {referencePackage.PackageName}: {expectedCount} soal. Harap masukkan {expectedCount} soal."
            });
        }
    }
}
```

This returns a JSON error (consistent with the import action's error handling pattern). Note that the import action currently uses `TempData["Error"]` + `RedirectToAction` for some errors but the return type is `IActionResult` and the view uses AJAX — checking the view will confirm which pattern. Use `return Json(new { success = false, error = ... })` to be consistent with the JSON response pattern implied by the research findings.

Actually, looking at the existing code: `ImportPackageQuestions` POST uses `TempData["Error"]` + `return RedirectToAction(...)` for all its error cases (Excel parse error, no file provided, no valid questions). So for consistency, use the same pattern for this validation:

```csharp
TempData["Error"] = $"Jumlah soal tidak sama dengan paket lain. {referencePackage.PackageName}: {expectedCount} soal. Harap masukkan {expectedCount} soal.";
return RedirectToAction("ImportPackageQuestions", new { packageId });
```

Place this validation block AFTER the `rows` list is built (after the `else` branch at line ~4110 that returns error for no file), BEFORE the "Validate and persist rows" comment at line ~4116.

**Fix 4 — ManagePackages.cshtml summary panel**:

Add the following panel ABOVE the `<div class="row">` that contains the Create Package form and Package List cards (currently the first element inside the container after the TempData alerts):

```html
@{
    // Compute summary data for the panel
    bool hasMismatch = false;
    int? referenceCount = null;
    if (packages.Any(p => p.Questions.Any()))
    {
        referenceCount = packages.Where(p => p.Questions.Any()).Select(p => p.Questions.Count).First();
        hasMismatch = packages.Where(p => p.Questions.Any()).Any(p => p.Questions.Count != referenceCount);
    }
    bool isMultiPackage = packages.Count > 1;
    string modeLabel = isMultiPackage ? $"Multi-Package ({packages.Count} paket)" : "Single Package";
}

<div class="card mb-4">
    <div class="card-body">
        <div class="d-flex align-items-center gap-3 flex-wrap">
            <div>
                <span class="text-muted small">Mode:</span>
                <strong class="ms-1">@modeLabel</strong>
            </div>
            @if (packages.Any())
            {
                <div class="vr d-none d-md-block"></div>
                @foreach (var pkg in packages)
                {
                    bool pkgHasQuestions = pkg.Questions.Any();
                    bool pkgOk = pkgHasQuestions && (!hasMismatch || pkg.Questions.Count == referenceCount);
                    bool pkgWarning = pkgHasQuestions && hasMismatch && pkg.Questions.Count != referenceCount;
                    <div class="d-flex align-items-center gap-1">
                        <span class="badge @(pkgOk ? "text-bg-success" : pkgWarning ? "text-bg-warning" : "text-bg-secondary")">
                            @(pkgOk ? "OK" : pkgWarning ? "Warning" : "Kosong")
                        </span>
                        <span class="small">@pkg.PackageName: @pkg.Questions.Count soal</span>
                    </div>
                }
            }
            @if (hasMismatch)
            {
                <div class="text-warning small ms-auto">
                    <i class="bi bi-exclamation-triangle me-1"></i>Jumlah soal tidak sama antar paket
                </div>
            }
        </div>
    </div>
</div>
```

This panel uses Bootstrap 5 classes (already used throughout the codebase). `bi-exclamation-triangle` is from Bootstrap Icons (already in use). No new dependencies.
  </action>
  <verify>
`dotnet build` — zero errors.
Search for `Jumlah soal tidak sama` in CMPController.cs — appears once in ImportPackageQuestions POST.
Search for `Multi-Package` in Views/CMP/ManagePackages.cshtml — appears once in the summary panel.
Search for `modeLabel` in ManagePackages.cshtml — appears.
Visually confirm panel renders above package list in ManagePackages view by running the app and navigating to ManagePackages for an assessment with 2 packages (or just inspect the cshtml structure).
  </verify>
  <done>
ImportPackageQuestions POST blocks import if valid row count differs from sibling package count, with Indonesian error message naming the reference package. ManagePackages shows summary panel with mode indicator and per-package OK/Warning/Kosong status badges. Mismatch warning shown but HC not blocked from other actions. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` passes with no errors.
2. `BuildCrossPackageAssignment` called in ReshufflePackage and ReshuffleAll (3 call sites total including StartExam from Plan 01).
3. `ShuffledOptionIdsPerQuestion = "{}"` in all 3 assignment creation paths.
4. ImportPackageQuestions validation block present with `Jumlah soal tidak sama dengan paket lain` message.
5. ManagePackages.cshtml has summary panel with `modeLabel` showing Single Package or Multi-Package.
6. All 10 identified change locations from research are addressed across the 3 plans.
</verification>

<success_criteria>
- Reshuffling a single worker or bulk workers produces cross-package assignments matching StartExam format.
- Importing mismatched question counts to a package is blocked with clear Indonesian error message.
- ManagePackages shows mode (Single/Multi) and per-package status (OK/Warning/Kosong).
- Build passes clean.
- Full phase: 3 plans cover all 10 code change locations identified in research.
</success_criteria>

<output>
After completion, create `.planning/phases/45-cross-package-per-position-shuffle/45-03-SUMMARY.md`
</output>
