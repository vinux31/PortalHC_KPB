---
phase: 47-kkj-matrix-manager
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Controllers/AdminController.cs
  - Views/Admin/Index.cshtml
  - Views/Admin/KkjMatrix.cshtml
  - Views/Shared/_Layout.cshtml
autonomous: true
requirements:
  - MDAT-01

must_haves:
  truths:
    - "Admin can navigate to /Admin/Index and see 12 tool cards grouped in 3 categories"
    - "Admin can navigate to /Admin/KkjMatrix and see a compact table listing all KkjMatrixItem rows"
    - "Non-Admin role cannot access /Admin/* pages (redirected, not 403 error)"
    - "'Kelola Data' link appears in the navbar only when the logged-in user is Admin role"
    - "Read-mode table shows No, Indeks, Kompetensi, SkillGroup columns plus Edit/Delete action buttons"
  artifacts:
    - path: "Controllers/AdminController.cs"
      provides: "AdminController with [Authorize(Roles='Admin')], Index GET, KkjMatrix GET"
      exports: ["Index", "KkjMatrix"]
    - path: "Views/Admin/Index.cshtml"
      provides: "Hub page with 3 category sections and 12 tool cards (MDAT-01-03, OPER-01-05, CRUD-01-04)"
    - path: "Views/Admin/KkjMatrix.cshtml"
      provides: "Read-mode compact table; edit-mode placeholder with edit/cancel/save buttons"
    - path: "Views/Shared/_Layout.cshtml"
      provides: "Kelola Data nav link visible only for Admin role (RoleLevel == 1)"
  key_links:
    - from: "Views/Shared/_Layout.cshtml"
      to: "/Admin/Index"
      via: "asp-controller='Admin' asp-action='Index', guarded by userRole == 'Admin'"
      pattern: "asp-controller=\"Admin\""
    - from: "Views/Admin/KkjMatrix.cshtml"
      to: "Controllers/AdminController.cs KkjMatrix action"
      via: "Model passed as List<KkjMatrixItem> from controller"
      pattern: "@model List<HcPortal.Models.KkjMatrixItem>"
---

<objective>
Establish the Admin Portal infrastructure: AdminController with class-level [Authorize(Roles="Admin")], the /Admin/Index hub page listing all 12 admin tools in 3 category groups, the /Admin/KkjMatrix read-mode page showing a compact table of all KkjMatrixItem rows, and a "Kelola Data" nav sidebar link visible only to Admin.

Purpose: This is the structural foundation for all v2.3 Admin Portal phases (47-58). Plan 02 builds the write operations on top of this plan's controller and view.
Output: AdminController.cs, Views/Admin/Index.cshtml, Views/Admin/KkjMatrix.cshtml (read mode only), _Layout.cshtml updated.
</objective>

<execution_context>
@C:/Users/Administrator/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Administrator/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@Controllers/CMPController.cs
@Views/CMP/Kkj.cshtml
@Views/Shared/_Layout.cshtml
@Models/KkjModels.cs
</context>

<interfaces>
<!-- Key types and contracts for the executor. No codebase exploration needed. -->

From Models/KkjModels.cs — KkjMatrixItem (18 columns total):
```csharp
public class KkjMatrixItem
{
    public int Id { get; set; }
    public int No { get; set; }
    public string SkillGroup { get; set; } = "";
    public string SubSkillGroup { get; set; } = "";
    public string Indeks { get; set; } = "";
    public string Kompetensi { get; set; } = "";
    // 13 Target_* columns:
    public string Target_SectionHead { get; set; } = "-";
    public string Target_SrSpv_GSH { get; set; } = "-";
    public string Target_ShiftSpv_GSH { get; set; } = "-";
    public string Target_Panelman_GSH_12_13 { get; set; } = "-";
    public string Target_Panelman_GSH_14 { get; set; } = "-";
    public string Target_Operator_GSH_8_11 { get; set; } = "-";
    public string Target_Operator_GSH_12_13 { get; set; } = "-";
    public string Target_ShiftSpv_ARU { get; set; } = "-";
    public string Target_Panelman_ARU_12_13 { get; set; } = "-";
    public string Target_Panelman_ARU_14 { get; set; } = "-";
    public string Target_Operator_ARU_8_11 { get; set; } = "-";
    public string Target_Operator_ARU_12_13 { get; set; } = "-";
    public string Target_SrSpv_Facility { get; set; } = "-";
    public string Target_JrAnalyst { get; set; } = "-";
    public string Target_HSE { get; set; } = "-";
}
```

From Data/ApplicationDbContext.cs:
```csharp
public DbSet<KkjMatrixItem> KkjMatrices { get; set; }
public DbSet<UserCompetencyLevel> UserCompetencyLevels { get; set; }
// UserCompetencyLevel has DeleteBehavior.Restrict on KkjMatrixItemId FK
```

From Services/AuditLogService.cs:
```csharp
public async Task LogAsync(
    string actorUserId, string actorName, string actionType,
    string description, int? targetId = null, string? targetType = null)
```

From CMPController.cs — constructor pattern to follow:
```csharp
[Authorize]
public class CMPController : Controller
{
    private readonly UserManager<ApplicationUser> _userManager;
    private readonly ApplicationDbContext _context;
    private readonly AuditLogService _auditLog;
    public CMPController(UserManager<ApplicationUser> userManager, ..., AuditLogService auditLog) { ... }
}
```

From Views/Shared/_Layout.cshtml — userRole variable already computed:
```csharp
var userRole = currentUser != null ? (await UserManager.GetRolesAsync(currentUser)).FirstOrDefault() : null;
// userRole == "Admin" is the check to use (not RoleLevel) — for consistency with nav guards already in layout
// Admin nav is inserted after the BP nav-item, before the closing </ul>
```

From Models/UserRoles.cs:
```csharp
// Admin role string = "Admin" (RoleLevel 1)
```
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Create AdminController with Index and KkjMatrix GET actions</name>
  <files>Controllers/AdminController.cs</files>
  <action>
Create Controllers/AdminController.cs in the HcPortal.Controllers namespace.

Class-level attribute: `[Authorize(Roles = "Admin")]` — all actions inherit it; no per-action auth needed.

Constructor: inject `ApplicationDbContext _context`, `UserManager<ApplicationUser> _userManager`, `AuditLogService _auditLog`. Follow exact CMPController constructor signature pattern.

Actions to implement:

1. `GET /Admin/Index` — `public IActionResult Index()` — returns View() with no model (view is static cards).

2. `GET /Admin/KkjMatrix` — `public async Task<IActionResult> KkjMatrix()` — queries `_context.KkjMatrices.OrderBy(k => k.No).ToListAsync()` and passes the `List<KkjMatrixItem>` as the view model. Sets `ViewData["Title"] = "Kelola KKJ Matrix"`.

DO NOT add KkjMatrixSave or KkjMatrixDelete actions yet — those are Plan 02.
DO NOT add SignInManager injection — only UserManager is needed here.

Using statements required:
```csharp
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Authorization;
using Microsoft.EntityFrameworkCore;
using HcPortal.Models;
using HcPortal.Data;
using HcPortal.Services;
```
  </action>
  <verify>
    <automated>cd "C:/Users/Administrator/Desktop/PortalHC_KPB" && dotnet build --configuration Release 2>&1 | tail -5</automated>
  </verify>
  <done>AdminController.cs compiles without errors. dotnet build exits 0.</done>
</task>

<task type="auto">
  <name>Task 2: Create Admin/Index.cshtml hub page with 12 tool cards in 3 groups</name>
  <files>Views/Admin/Index.cshtml</files>
  <action>
Create Views/Admin/Index.cshtml. The Views/Admin/ directory does not exist yet — create it.

Page metadata:
```cshtml
@{
    ViewData["Title"] = "Kelola Data";
    ViewData["ContainerClass"] = "container";
}
```

Page heading: `<h2 class="fw-bold text-dark mb-1"><i class="bi bi-gear-fill me-2 text-primary"></i>Kelola Data</h2>` with a subtitle `<p class="text-muted">Panel admin untuk mengelola data master, operasional, dan konfigurasi sistem.</p>`.

Three category sections using Bootstrap `row g-3` card grid (3 columns on md+, 1 column on mobile):

**Section A: Master Data** (blue badge, `text-primary` heading)
Cards:
1. KKJ Matrix → `Url.Action("KkjMatrix","Admin")` — "Kelola item KKJ Matrix (master kompetensi)" — icon `bi-table`
2. CPDP Items → `#` (placeholder) — "Kelola item CPDP (kompetensi-deliverable)" — icon `bi-list-check`
3. Assessment Competency Map → `#` (placeholder) — "Kelola mapping assessment ke KKJ" — icon `bi-diagram-3`

**Section B: Operasional** (orange badge, `text-warning` heading)
Cards:
4. Coach-Coachee Mapping → `#` — "Atur assignment coach ke coachee" — icon `bi-people`
5. Proton Track Assignment → `#` — "Atur assignment coachee ke Proton track" — icon `bi-person-badge`
6. Deliverable Progress Override → `#` — "Override status progress deliverable" — icon `bi-pencil-square`
7. Final Assessment Manager → `#` — "Kelola final assessment Proton" — icon `bi-clipboard-check`
8. Coaching Session Override → `#` — "Override atau hapus coaching session" — icon `bi-chat-text`

**Section C: Kelengkapan CRUD** (green badge, `text-success` heading)
Cards:
9. Question Bank Edit → `#` — "Edit soal assessment yang sudah ada" — icon `bi-question-circle`
10. Package Question Edit/Delete → `#` — "Edit/hapus soal dalam paket ujian" — icon `bi-file-earmark-text`
11. ProtonTrack Edit/Delete → `#` — "Edit/hapus ProtonTrack" — icon `bi-tools`
12. Password Reset → `#` — "Reset password pekerja secara mandiri" — icon `bi-key`

Card structure for each tool (wrap `<a>` around card for clickable):
```cshtml
<div class="col-md-4">
    <a href="@Url.Action(...)" class="text-decoration-none">
        <div class="card shadow-sm h-100 border-0 @(isActive ? "" : "opacity-75")">
            <div class="card-body">
                <div class="d-flex align-items-center gap-2 mb-2">
                    <i class="bi {icon} fs-5 text-primary"></i>
                    <span class="fw-bold">{name}</span>
                </div>
                <small class="text-muted">{description}</small>
            </div>
        </div>
    </a>
</div>
```

Active card (KKJ Matrix, Plan 01): use `text-primary` icon, full opacity.
Placeholder cards (`#`): use `opacity-75`, add `<span class="badge bg-secondary ms-auto" style="font-size:0.6rem;">Segera</span>` next to the tool name to indicate not yet implemented.

Section separator: `<hr class="my-4">` between sections.
  </action>
  <verify>
    <automated>cd "C:/Users/Administrator/Desktop/PortalHC_KPB" && dotnet build --configuration Release 2>&1 | tail -5</automated>
  </verify>
  <done>Views/Admin/Index.cshtml exists. dotnet build exits 0.</done>
</task>

<task type="auto">
  <name>Task 3: Create KkjMatrix read-mode view and add Kelola Data nav link</name>
  <files>Views/Admin/KkjMatrix.cshtml, Views/Shared/_Layout.cshtml</files>
  <action>
**Part A — Views/Admin/KkjMatrix.cshtml (read mode only)**

Model: `@model List<HcPortal.Models.KkjMatrixItem>`

Page metadata:
```cshtml
@{
    ViewData["Title"] = "Kelola KKJ Matrix";
    ViewData["ContainerClass"] = "container-fluid px-4";
}
```

Include `@Html.AntiForgeryToken()` in a hidden form at the top of the page so the token is available to JS in Plan 02.

Page header section:
- Breadcrumb: Kelola Data > KKJ Matrix
- Title: `<h4 class="fw-bold mb-0">KKJ Matrix</h4>`
- Subtitle: "Kelola item KKJ Matrix (master kompetensi)"
- Toolbar: `<button id="btnEdit" class="btn btn-primary btn-sm"><i class="bi bi-pencil me-1"></i>Edit Mode</button>` — right-aligned. In Plan 02 this button will be wired to JS.

**Read-mode table** (`id="readTable"`):
- Wrap in `<div class="table-responsive custom-scrollbar">` with styles matching Views/CMP/Kkj.cshtml for consistency.
- Sticky header (copy `.custom-scrollbar`, `thead th` sticky CSS from Kkj.cshtml).
- Columns: No | Indeks | Kompetensi | SkillGroup | Aksi (Edit/Delete buttons)
- Header row: `<thead class="table-dark">` with 5 `<th>` elements.
- Data rows: `@foreach (var item in Model)` — render `<tr data-id="@item.Id">` with `<td>` for No, Indeks, Kompetensi, SkillGroup, and an Aksi cell containing:
  - Delete button: `<button class="btn btn-outline-danger btn-sm" onclick="deleteRow(@item.Id, '@Html.Raw(item.Kompetensi.Replace("'", "\\'"))'>` with icon `bi-trash`.
  - Note: Edit button in read-mode row is NOT needed — edit mode is toggled for the whole table via `#btnEdit`. Keep only the delete button per row in read mode. The delete button calls Plan 02's deleteRow JS function (it can be a stub `onclick="deleteRow(@item.Id, '@item.Kompetensi')"` — Plan 02 will implement the function).

Show row count: `<div class="text-muted small mb-2">@Model.Count item(s)</div>` above table.

Empty-state: `@if (!Model.Any()) { <p class="text-muted">Belum ada data KKJ Matrix.</p> }`

**Edit-mode table** (`id="editTable"`, `class="d-none"`): Leave as an empty `<div id="editTable" class="d-none"></div>` placeholder — Plan 02 will inject the full edit table content and JS.

**Edit action buttons** (`id="editActions"`, `class="d-none"`): Empty placeholder div for Plan 02.

**Part B — Views/Shared/_Layout.cshtml**

In the `<ul class="navbar-nav me-auto ...">` section, AFTER the existing `<li>` for BP, add:

```cshtml
@if (userRole == "Admin")
{
    <li class="nav-item">
        <a class="nav-link text-dark" asp-controller="Admin" asp-action="Index">
            <i class="bi bi-gear-fill me-1"></i>Kelola Data
        </a>
    </li>
}
```

The `userRole` variable is already computed at the top of _Layout.cshtml — no new code needed for the check.
  </action>
  <verify>
    <automated>cd "C:/Users/Administrator/Desktop/PortalHC_KPB" && dotnet build --configuration Release 2>&1 | tail -5</automated>
  </verify>
  <done>dotnet build exits 0. Views/Admin/KkjMatrix.cshtml exists. _Layout.cshtml has the Kelola Data nav item.</done>
</task>

</tasks>

<verification>
After all 3 tasks:
1. `dotnet build --configuration Release` exits 0 (no compile errors)
2. Navigate to `/Admin/Index` as Admin role — hub page loads with 3 category sections and 12 cards
3. Navigate to `/Admin/KkjMatrix` as Admin role — compact table loads with all KkjMatrixItem rows (expect ~17 seeded rows), showing No/Indeks/Kompetensi/SkillGroup columns and Delete buttons
4. Navbar shows "Kelola Data" link only when logged in as Admin
5. Navigate to `/Admin/Index` as non-Admin role — redirected to login or access denied
</verification>

<success_criteria>
- GET /Admin/Index returns 200 for Admin role, shows hub with 12 cards in 3 groups
- GET /Admin/KkjMatrix returns 200 for Admin role, shows compact table with correct columns
- dotnet build exits 0 (no compile errors or warnings)
- Kelola Data nav link visible in sidebar for Admin, hidden for all other roles
- AdminController.cs uses [Authorize(Roles = "Admin")] at class level
</success_criteria>

<output>
After completion, create `.planning/phases/47-kkj-matrix-manager/47-01-SUMMARY.md`
</output>
