---
phase: 47-kkj-matrix-manager
plan: 02
type: execute
wave: 2
depends_on:
  - 47-01
files_modified:
  - Controllers/AdminController.cs
  - Views/Admin/KkjMatrix.cshtml
autonomous: true
requirements:
  - MDAT-01

must_haves:
  truths:
    - "Admin can click 'Edit Mode' to reveal all 18 columns as input fields with horizontal scroll and sticky first columns"
    - "Admin can paste TSV data from Excel into the edit table and have rows auto-populate"
    - "Admin can click 'Simpan' to bulk-save all current rows (new and edited) in a single POST, with the table returning to read mode"
    - "Admin can add a new empty row at the bottom of the edit table and it is submitted as a new record (Id=0)"
    - "Admin can delete an unreferenced KkjMatrixItem — it is removed from the list without page reload"
    - "Admin cannot delete a KkjMatrixItem in use by UserCompetencyLevel — an error message shows the worker count"
  artifacts:
    - path: "Controllers/AdminController.cs"
      provides: "KkjMatrixSave POST (bulk upsert JSON) and KkjMatrixDelete POST (guard check)"
      exports: ["KkjMatrixSave", "KkjMatrixDelete"]
    - path: "Views/Admin/KkjMatrix.cshtml"
      provides: "Edit-mode table (18 cols, inputs, sticky), paste handler, JS toggle, bulk-save call, delete-with-guard call, add-row button"
  key_links:
    - from: "Views/Admin/KkjMatrix.cshtml (saveAllRows JS)"
      to: "/Admin/KkjMatrixSave"
      via: "$.ajax POST with contentType: 'application/json', RequestVerificationToken header, JSON.stringify(rows)"
      pattern: "KkjMatrixSave"
    - from: "Views/Admin/KkjMatrix.cshtml (deleteRow JS)"
      to: "/Admin/KkjMatrixDelete"
      via: "$.ajax POST with form-encoded data + __RequestVerificationToken"
      pattern: "KkjMatrixDelete"
    - from: "Controllers/AdminController.cs KkjMatrixSave"
      to: "_context.KkjMatrices (EF upsert)"
      via: "FindAsync(row.Id) then update properties OR _context.KkjMatrices.Add(row)"
      pattern: "FindAsync|KkjMatrices.Add"
    - from: "Controllers/AdminController.cs KkjMatrixDelete"
      to: "_context.UserCompetencyLevels"
      via: "CountAsync(u => u.KkjMatrixItemId == id) before Remove"
      pattern: "UserCompetencyLevels.CountAsync"
---

<objective>
Implement the write operations for KKJ Matrix Manager: client-side spreadsheet edit mode (all 18 columns, input fields, sticky columns, clipboard paste), bulk-save JSON endpoint (upsert), add-row in edit mode, and delete-with-guard endpoint.

Purpose: Completes MDAT-01. Admin can now manage KkjMatrixItem records entirely through the UI — no database or code changes needed.
Output: AdminController.cs extended with KkjMatrixSave + KkjMatrixDelete. Views/Admin/KkjMatrix.cshtml fully wired with edit mode, paste, and delete JS.
</objective>

<execution_context>
@C:/Users/Administrator/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Administrator/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/47-kkj-matrix-manager/47-01-SUMMARY.md

@Controllers/AdminController.cs
@Views/Admin/KkjMatrix.cshtml
@Models/KkjModels.cs
</context>

<interfaces>
<!-- Interfaces established by Plan 01 that this plan extends. -->

AdminController.cs (already has Index + KkjMatrix GET — extend, do not replace):
```csharp
[Authorize(Roles = "Admin")]
public class AdminController : Controller
{
    private readonly ApplicationDbContext _context;
    private readonly UserManager<ApplicationUser> _userManager;
    private readonly AuditLogService _auditLog;
    // constructor and existing actions already present
}
```

KkjMatrixItem model (18 columns — all must appear as inputs in edit mode):
```
Id, No, SkillGroup, SubSkillGroup, Indeks, Kompetensi,
Target_SectionHead, Target_SrSpv_GSH, Target_ShiftSpv_GSH,
Target_Panelman_GSH_12_13, Target_Panelman_GSH_14,
Target_Operator_GSH_8_11, Target_Operator_GSH_12_13,
Target_ShiftSpv_ARU, Target_Panelman_ARU_12_13,
Target_Panelman_ARU_14, Target_Operator_ARU_8_11,
Target_Operator_ARU_12_13, Target_SrSpv_Facility,
Target_JrAnalyst, Target_HSE
```
NOTE: That is 21 properties total — Id + No + 4 metadata + 15 Target_* = 21 fields. The KkjMatrixItem model actually has 15 Target_* fields (not 13 as mentioned in some places — count the model carefully). Double-check Models/KkjModels.cs at execution time.

AuditLogService.LogAsync signature:
```csharp
await _auditLog.LogAsync(actorUserId, actorName, actionType, description, targetId?, targetType?);
```

Antiforgery pattern for JSON body endpoints (CRITICAL — do not put token in body):
```javascript
// JS side: send token as HTTP header
headers: { 'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() }
// C# side: [ValidateAntiForgeryToken] reads from header when Content-Type is application/json
```

Antiforgery pattern for form-encoded endpoints (delete):
```javascript
// JS side: include token in data object
data: { id: id, __RequestVerificationToken: token }
// C# side: normal [ValidateAntiForgeryToken] from form body
```

EF upsert pattern (avoid tracking conflicts — always use FindAsync):
```csharp
var existing = await _context.KkjMatrices.FindAsync(row.Id);
if (existing != null) {
    existing.No = row.No; // update each property individually
    // ... all other properties
} else {
    _context.KkjMatrices.Add(row);
}
// Do NOT call _context.Update(row) on deserialized JSON objects
```
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Add KkjMatrixSave and KkjMatrixDelete POST actions to AdminController</name>
  <files>Controllers/AdminController.cs</files>
  <action>
Add two new action methods to the existing AdminController class (do not recreate the file — append to it).

**Action 1: KkjMatrixSave**
```csharp
// POST /Admin/KkjMatrixSave
[HttpPost]
[ValidateAntiForgeryToken]
public async Task<IActionResult> KkjMatrixSave([FromBody] List<KkjMatrixItem> rows)
{
    if (rows == null || !rows.Any())
        return Json(new { success = false, message = "Tidak ada data yang diterima." });

    try
    {
        foreach (var row in rows)
        {
            if (row.Id == 0)
            {
                _context.KkjMatrices.Add(row);
            }
            else
            {
                var existing = await _context.KkjMatrices.FindAsync(row.Id);
                if (existing != null)
                {
                    existing.No = row.No;
                    existing.SkillGroup = row.SkillGroup ?? "";
                    existing.SubSkillGroup = row.SubSkillGroup ?? "";
                    existing.Indeks = row.Indeks ?? "";
                    existing.Kompetensi = row.Kompetensi ?? "";
                    existing.Target_SectionHead = row.Target_SectionHead ?? "-";
                    existing.Target_SrSpv_GSH = row.Target_SrSpv_GSH ?? "-";
                    existing.Target_ShiftSpv_GSH = row.Target_ShiftSpv_GSH ?? "-";
                    existing.Target_Panelman_GSH_12_13 = row.Target_Panelman_GSH_12_13 ?? "-";
                    existing.Target_Panelman_GSH_14 = row.Target_Panelman_GSH_14 ?? "-";
                    existing.Target_Operator_GSH_8_11 = row.Target_Operator_GSH_8_11 ?? "-";
                    existing.Target_Operator_GSH_12_13 = row.Target_Operator_GSH_12_13 ?? "-";
                    existing.Target_ShiftSpv_ARU = row.Target_ShiftSpv_ARU ?? "-";
                    existing.Target_Panelman_ARU_12_13 = row.Target_Panelman_ARU_12_13 ?? "-";
                    existing.Target_Panelman_ARU_14 = row.Target_Panelman_ARU_14 ?? "-";
                    existing.Target_Operator_ARU_8_11 = row.Target_Operator_ARU_8_11 ?? "-";
                    existing.Target_Operator_ARU_12_13 = row.Target_Operator_ARU_12_13 ?? "-";
                    existing.Target_SrSpv_Facility = row.Target_SrSpv_Facility ?? "-";
                    existing.Target_JrAnalyst = row.Target_JrAnalyst ?? "-";
                    existing.Target_HSE = row.Target_HSE ?? "-";
                }
            }
        }
        await _context.SaveChangesAsync();

        var actor = await _userManager.GetUserAsync(User);
        if (actor != null)
            await _auditLog.LogAsync(actor.Id, actor.FullName, "BulkUpdate",
                $"KKJ Matrix bulk-save: {rows.Count} rows", targetType: "KkjMatrixItem");

        return Json(new { success = true, message = $"{rows.Count} baris berhasil disimpan." });
    }
    catch (Exception ex)
    {
        return Json(new { success = false, message = ex.Message });
    }
}
```

IMPORTANT: The JSON property names sent from JS must match C# property names. Since ASP.NET Core's default System.Text.Json uses camelCase for deserialization by default, but the KkjMatrixItem properties are PascalCase, add this to Program.cs if needed OR ensure the JS sends PascalCase property names. Simplest approach: in Program.cs find `builder.Services.AddControllersWithViews()` and verify whether `options.JsonSerializerOptions.PropertyNameCaseInsensitive = true` is configured. If not, set PascalCase property names in the JS saveAllRows function (use PascalCase: `Id`, `No`, `SkillGroup`, etc. — not camelCase). This avoids touching Program.cs. Check Program.cs at execution time.

**Action 2: KkjMatrixDelete**
```csharp
// POST /Admin/KkjMatrixDelete
[HttpPost]
[ValidateAntiForgeryToken]
public async Task<IActionResult> KkjMatrixDelete(int id)
{
    var item = await _context.KkjMatrices.FindAsync(id);
    if (item == null)
        return Json(new { success = false, message = "Item tidak ditemukan." });

    var usageCount = await _context.UserCompetencyLevels
        .CountAsync(u => u.KkjMatrixItemId == id);

    if (usageCount > 0)
        return Json(new { success = false, blocked = true,
            message = $"Tidak dapat dihapus — digunakan oleh {usageCount} pekerja." });

    _context.KkjMatrices.Remove(item);
    await _context.SaveChangesAsync();

    var actor = await _userManager.GetUserAsync(User);
    if (actor != null)
        await _auditLog.LogAsync(actor.Id, actor.FullName, "Delete",
            $"Deleted KkjMatrixItem Id={id} ({item.Kompetensi})",
            targetId: id, targetType: "KkjMatrixItem");

    return Json(new { success = true });
}
```

Verify the `UserCompetencyLevel` model has a `KkjMatrixItemId` property by checking Models at execution time (the FK name was confirmed in ApplicationDbContext line 191).
  </action>
  <verify>
    <automated>cd "C:/Users/Administrator/Desktop/PortalHC_KPB" && dotnet build --configuration Release 2>&1 | tail -5</automated>
  </verify>
  <done>dotnet build exits 0. AdminController.cs has KkjMatrixSave and KkjMatrixDelete POST actions.</done>
</task>

<task type="auto">
  <name>Task 2: Implement edit mode, bulk-save JS, clipboard paste, and add-row in KkjMatrix view</name>
  <files>Views/Admin/KkjMatrix.cshtml</files>
  <action>
Update Views/Admin/KkjMatrix.cshtml to add:

1. **CSS for edit mode** — inside a `<style>` block at the top of the file, in addition to the custom-scrollbar CSS from Plan 01:
```css
.edit-input {
    border: 1px solid #ced4da;
    border-radius: 4px;
    padding: 2px 4px;
    font-size: 0.75rem;
    width: 100%;
    min-width: 60px;
}
.edit-input:focus { outline: none; border-color: #0d6efd; box-shadow: 0 0 0 2px rgba(13,110,253,0.15); }
.col-no    { min-width: 55px; }
.col-meta  { min-width: 120px; }
.col-target { min-width: 55px; }
/* Sticky first two columns in edit mode */
#editTable td:nth-child(1), #editTable th:nth-child(1) { position: sticky; left: 0; background: white; z-index: 5; border-right: 1px solid #dee2e6; }
#editTable td:nth-child(2), #editTable th:nth-child(2) { position: sticky; left: 57px; background: white; z-index: 5; border-right: 1px solid #dee2e6; }
#editTable thead th { position: sticky; top: 0; background: #343a40; color: white; z-index: 10; }
#editTable thead th:nth-child(1), #editTable thead th:nth-child(2) { z-index: 15; }
```

2. **Embed full item data as JS variable** — after the `@Html.AntiForgeryToken()` hidden form, add:
```cshtml
@{
    var itemsJson = System.Text.Json.JsonSerializer.Serialize(Model,
        new System.Text.Json.JsonSerializerOptions { PropertyNamingPolicy = null });
}
<script>
    var kkjItems = @Html.Raw(itemsJson);
</script>
```

3. **Toolbar update** — The toolbar from Plan 01 has `#btnEdit`. Add edit-action buttons next to it (initially hidden):
```html
<div id="editActions" class="d-none d-flex gap-2">
    <button id="btnAddRow" class="btn btn-success btn-sm"><i class="bi bi-plus me-1"></i>Tambah Baris</button>
    <button id="btnSave" class="btn btn-primary btn-sm"><i class="bi bi-save me-1"></i>Simpan</button>
    <button id="btnCancel" class="btn btn-outline-secondary btn-sm"><i class="bi bi-x me-1"></i>Batal</button>
</div>
```

4. **Edit table** — Replace the `<div id="editTable" class="d-none">` placeholder from Plan 01 with a fully constructed edit-mode table:
```html
<div id="editTable" class="d-none table-responsive custom-scrollbar" style="max-height:80vh;">
    <table class="table table-sm table-bordered align-middle mb-0" id="kkjEditTbl">
        <thead class="table-dark">
            <tr>
                <th class="col-no">No</th>
                <th class="col-meta">SkillGroup</th>
                <th class="col-meta">SubSkillGroup</th>
                <th class="col-meta">Indeks</th>
                <th class="col-meta" style="min-width:180px;">Kompetensi</th>
                <th class="col-target">SectionHead</th>
                <th class="col-target">SrSpv GSH</th>
                <th class="col-target">ShiftSpv GSH</th>
                <th class="col-target">Panelman GSH 12-13</th>
                <th class="col-target">Panelman GSH 14</th>
                <th class="col-target">Op GSH 8-11</th>
                <th class="col-target">Op GSH 12-13</th>
                <th class="col-target">ShiftSpv ARU</th>
                <th class="col-target">Panelman ARU 12-13</th>
                <th class="col-target">Panelman ARU 14</th>
                <th class="col-target">Op ARU 8-11</th>
                <th class="col-target">Op ARU 12-13</th>
                <th class="col-target">SrSpv Facility</th>
                <th class="col-target">Jr Analyst</th>
                <th class="col-target">HSE</th>
            </tr>
        </thead>
        <tbody id="editTbody">
            <!-- Populated by JS renderEditRows() -->
        </tbody>
    </table>
</div>
```

5. **JavaScript block** — At the bottom of the file, in a `<script>` block, implement:

```javascript
// --- EDIT MODE TOGGLE ---
function renderEditRows() {
    var tbody = document.getElementById('editTbody');
    tbody.innerHTML = '';
    kkjItems.forEach(function(item) {
        tbody.appendChild(makeRow(item));
    });
}

function makeRow(item) {
    var tr = document.createElement('tr');
    tr.dataset.id = item.Id || 0;
    // Build 20 input cells: No, SkillGroup, SubSkillGroup, Indeks, Kompetensi, + 15 Target_* columns
    var fields = [
        { name:'No',                     val: item.No,                        cls:'col-no',    type:'number' },
        { name:'SkillGroup',             val: item.SkillGroup,                cls:'col-meta' },
        { name:'SubSkillGroup',          val: item.SubSkillGroup,             cls:'col-meta' },
        { name:'Indeks',                 val: item.Indeks,                    cls:'col-meta' },
        { name:'Kompetensi',             val: item.Kompetensi,                cls:'col-meta', style:'min-width:180px' },
        { name:'Target_SectionHead',     val: item.Target_SectionHead,        cls:'col-target' },
        { name:'Target_SrSpv_GSH',       val: item.Target_SrSpv_GSH,          cls:'col-target' },
        { name:'Target_ShiftSpv_GSH',    val: item.Target_ShiftSpv_GSH,       cls:'col-target' },
        { name:'Target_Panelman_GSH_12_13', val: item.Target_Panelman_GSH_12_13, cls:'col-target' },
        { name:'Target_Panelman_GSH_14', val: item.Target_Panelman_GSH_14,    cls:'col-target' },
        { name:'Target_Operator_GSH_8_11',  val: item.Target_Operator_GSH_8_11,  cls:'col-target' },
        { name:'Target_Operator_GSH_12_13', val: item.Target_Operator_GSH_12_13, cls:'col-target' },
        { name:'Target_ShiftSpv_ARU',    val: item.Target_ShiftSpv_ARU,       cls:'col-target' },
        { name:'Target_Panelman_ARU_12_13', val: item.Target_Panelman_ARU_12_13, cls:'col-target' },
        { name:'Target_Panelman_ARU_14', val: item.Target_Panelman_ARU_14,    cls:'col-target' },
        { name:'Target_Operator_ARU_8_11',  val: item.Target_Operator_ARU_8_11,  cls:'col-target' },
        { name:'Target_Operator_ARU_12_13', val: item.Target_Operator_ARU_12_13, cls:'col-target' },
        { name:'Target_SrSpv_Facility',  val: item.Target_SrSpv_Facility,     cls:'col-target' },
        { name:'Target_JrAnalyst',       val: item.Target_JrAnalyst,          cls:'col-target' },
        { name:'Target_HSE',             val: item.Target_HSE,                cls:'col-target' },
    ];
    fields.forEach(function(f) {
        var td = document.createElement('td');
        td.className = f.cls || '';
        if (f.style) td.style.cssText = f.style;
        var input = document.createElement('input');
        input.type = f.type || 'text';
        input.name = f.name;
        input.value = (f.val === null || f.val === undefined) ? '' : f.val;
        input.className = 'edit-input';
        td.appendChild(input);
        tr.appendChild(td);
    });
    return tr;
}

function makeEmptyRow() {
    return makeRow({
        Id: 0, No: 0, SkillGroup: '', SubSkillGroup: '', Indeks: '', Kompetensi: '',
        Target_SectionHead: '-', Target_SrSpv_GSH: '-', Target_ShiftSpv_GSH: '-',
        Target_Panelman_GSH_12_13: '-', Target_Panelman_GSH_14: '-',
        Target_Operator_GSH_8_11: '-', Target_Operator_GSH_12_13: '-',
        Target_ShiftSpv_ARU: '-', Target_Panelman_ARU_12_13: '-',
        Target_Panelman_ARU_14: '-', Target_Operator_ARU_8_11: '-',
        Target_Operator_ARU_12_13: '-', Target_SrSpv_Facility: '-',
        Target_JrAnalyst: '-', Target_HSE: '-'
    });
}

document.getElementById('btnEdit').addEventListener('click', function() {
    renderEditRows();
    document.getElementById('readTable').classList.add('d-none');
    document.getElementById('editTable').classList.remove('d-none');
    document.getElementById('editActions').classList.remove('d-none');
    this.classList.add('d-none');
});

document.getElementById('btnCancel').addEventListener('click', function() {
    document.getElementById('editTable').classList.add('d-none');
    document.getElementById('readTable').classList.remove('d-none');
    document.getElementById('editActions').classList.add('d-none');
    document.getElementById('btnEdit').classList.remove('d-none');
});

document.getElementById('btnAddRow').addEventListener('click', function() {
    document.getElementById('editTbody').appendChild(makeEmptyRow());
});

// --- BULK SAVE ---
document.getElementById('btnSave').addEventListener('click', function() {
    var rows = [];
    document.querySelectorAll('#editTbody tr').forEach(function(tr) {
        var getVal = function(name) {
            var el = tr.querySelector('[name="' + name + '"]');
            return el ? el.value : '';
        };
        rows.push({
            Id:           parseInt(tr.dataset.id) || 0,
            No:           parseInt(getVal('No')) || 0,
            SkillGroup:   getVal('SkillGroup'),
            SubSkillGroup: getVal('SubSkillGroup'),
            Indeks:       getVal('Indeks'),
            Kompetensi:   getVal('Kompetensi'),
            Target_SectionHead:        getVal('Target_SectionHead') || '-',
            Target_SrSpv_GSH:          getVal('Target_SrSpv_GSH') || '-',
            Target_ShiftSpv_GSH:       getVal('Target_ShiftSpv_GSH') || '-',
            Target_Panelman_GSH_12_13: getVal('Target_Panelman_GSH_12_13') || '-',
            Target_Panelman_GSH_14:    getVal('Target_Panelman_GSH_14') || '-',
            Target_Operator_GSH_8_11:  getVal('Target_Operator_GSH_8_11') || '-',
            Target_Operator_GSH_12_13: getVal('Target_Operator_GSH_12_13') || '-',
            Target_ShiftSpv_ARU:       getVal('Target_ShiftSpv_ARU') || '-',
            Target_Panelman_ARU_12_13: getVal('Target_Panelman_ARU_12_13') || '-',
            Target_Panelman_ARU_14:    getVal('Target_Panelman_ARU_14') || '-',
            Target_Operator_ARU_8_11:  getVal('Target_Operator_ARU_8_11') || '-',
            Target_Operator_ARU_12_13: getVal('Target_Operator_ARU_12_13') || '-',
            Target_SrSpv_Facility:     getVal('Target_SrSpv_Facility') || '-',
            Target_JrAnalyst:          getVal('Target_JrAnalyst') || '-',
            Target_HSE:                getVal('Target_HSE') || '-'
        });
    });

    var token = document.querySelector('input[name="__RequestVerificationToken"]').value;

    $.ajax({
        url: '/Admin/KkjMatrixSave',
        type: 'POST',
        contentType: 'application/json',
        headers: { 'RequestVerificationToken': token },
        data: JSON.stringify(rows),
        success: function(response) {
            if (response.success) {
                location.reload();
            } else {
                alert('Error: ' + response.message);
            }
        },
        error: function(xhr) {
            alert('Server error: ' + xhr.statusText);
        }
    });
});

// --- DELETE ---
function deleteRow(id, kompetensi) {
    if (!confirm('Hapus "' + kompetensi + '"?')) return;
    var token = document.querySelector('input[name="__RequestVerificationToken"]').value;
    $.ajax({
        url: '/Admin/KkjMatrixDelete',
        type: 'POST',
        data: { id: id, __RequestVerificationToken: token },
        success: function(response) {
            if (response.success) {
                document.querySelector('tr[data-id="' + id + '"]').remove();
                // Also remove from kkjItems array to keep in sync
                kkjItems = kkjItems.filter(function(i) { return i.Id !== id; });
            } else if (response.blocked) {
                alert(response.message);
            } else {
                alert('Error: ' + response.message);
            }
        }
    });
}

// --- CLIPBOARD PASTE (TSV from Excel) ---
// Paste on the edit table populates rows from focused position or appends at bottom
document.getElementById('kkjEditTbl').addEventListener('paste', function(e) {
    e.preventDefault();
    var text = (e.clipboardData || window.clipboardData).getData('text');
    if (!text) return;
    var pastedRows = text.trim().split('\n');
    var tbody = document.getElementById('editTbody');
    // Find the focused row index, or append at end
    var focusedRow = document.activeElement ? document.activeElement.closest('tr') : null;
    var startIdx = focusedRow ? Array.from(tbody.rows).indexOf(focusedRow) : tbody.rows.length;
    if (startIdx < 0) startIdx = tbody.rows.length;

    // Column order: No, SkillGroup, SubSkillGroup, Indeks, Kompetensi, Target_SectionHead ... Target_HSE
    var colNames = [
        'No','SkillGroup','SubSkillGroup','Indeks','Kompetensi',
        'Target_SectionHead','Target_SrSpv_GSH','Target_ShiftSpv_GSH',
        'Target_Panelman_GSH_12_13','Target_Panelman_GSH_14',
        'Target_Operator_GSH_8_11','Target_Operator_GSH_12_13',
        'Target_ShiftSpv_ARU','Target_Panelman_ARU_12_13',
        'Target_Panelman_ARU_14','Target_Operator_ARU_8_11',
        'Target_Operator_ARU_12_13','Target_SrSpv_Facility',
        'Target_JrAnalyst','Target_HSE'
    ];

    pastedRows.forEach(function(rowText, pasteRowIdx) {
        var cols = rowText.split('\t');
        var targetRowIdx = startIdx + pasteRowIdx;
        var tr;
        if (targetRowIdx < tbody.rows.length) {
            // Overwrite existing row
            tr = tbody.rows[targetRowIdx];
        } else {
            // Append new empty row
            tr = makeEmptyRow();
            tbody.appendChild(tr);
        }
        cols.forEach(function(cellVal, colIdx) {
            if (colIdx >= colNames.length) return;
            var input = tr.querySelector('[name="' + colNames[colIdx] + '"]');
            if (input) input.value = cellVal.trim();
        });
    });
});

// --- TAB/ENTER KEYBOARD NAVIGATION ---
document.getElementById('kkjEditTbl').addEventListener('keydown', function(e) {
    if (e.key !== 'Tab' && e.key !== 'Enter') return;
    var inputs = Array.from(document.querySelectorAll('#editTbody input.edit-input'));
    var idx = inputs.indexOf(document.activeElement);
    if (idx < 0) return;
    e.preventDefault();
    var nextIdx = e.shiftKey ? idx - 1 : idx + 1;
    if (nextIdx >= 0 && nextIdx < inputs.length) {
        inputs[nextIdx].focus();
        inputs[nextIdx].select();
    }
});
```

IMPORTANT: The `kkjItems` JS variable from the embedded JSON in the view uses PascalCase property names (since `PropertyNamingPolicy = null` in the serializer). Ensure the `makeRow` field definitions reference `item.Id`, `item.No`, `item.SkillGroup` etc. (PascalCase) — this is already the case in the code above.
  </action>
  <verify>
    <automated>cd "C:/Users/Administrator/Desktop/PortalHC_KPB" && dotnet build --configuration Release 2>&1 | tail -5</automated>
  </verify>
  <done>dotnet build exits 0. KkjMatrix.cshtml has complete edit-mode table, save/cancel/add-row buttons, JS toggle, bulk-save AJAX call, clipboard paste handler, and deleteRow function.</done>
</task>

</tasks>

<verification>
After both tasks:
1. `dotnet build --configuration Release` exits 0 (no compile errors)
2. Navigate to `/Admin/KkjMatrix` as Admin:
   a. Read mode: ~17 seeded rows visible in compact table with Delete buttons
   b. Click "Edit Mode": table switches to 20-column input view with horizontal scroll; first columns (No, SkillGroup) are sticky
   c. Modify a cell value, click "Simpan": page reloads with updated value visible in read mode
   d. Add a new row via "Tambah Baris", fill in values, click "Simpan": new row appears in read mode list
   e. Delete an unreferenced row: confirmation dialog, row disappears from table
   f. Attempt to delete a row referenced by UserCompetencyLevel: alert shows "Tidak dapat dihapus — digunakan oleh N pekerja."
   g. Paste TSV data from Excel: rows populate correctly from paste point
   h. Click "Batal": edit mode closes, no changes saved, read mode restored
</verification>

<success_criteria>
- POST /Admin/KkjMatrixSave with valid JSON array returns `{ success: true }` and persists to DB
- POST /Admin/KkjMatrixSave with Id=0 row creates a new KkjMatrixItem record
- POST /Admin/KkjMatrixDelete on unreferenced item returns `{ success: true }` and row is deleted
- POST /Admin/KkjMatrixDelete on referenced item returns `{ success: false, blocked: true, message: "..." }`
- Edit mode shows all 20 input columns with horizontal scroll and sticky first columns
- Clipboard paste from Excel (TSV) populates rows correctly
- dotnet build exits 0
</success_criteria>

<output>
After completion, create `.planning/phases/47-kkj-matrix-manager/47-02-SUMMARY.md`
</output>
