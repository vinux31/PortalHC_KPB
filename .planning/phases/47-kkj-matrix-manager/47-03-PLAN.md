---
phase: 47-kkj-matrix-manager
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - Models/KkjModels.cs
  - Data/ApplicationDbContext.cs
  - Controllers/AdminController.cs
  - Views/Admin/KkjMatrix.cshtml
autonomous: true
gap_closure: true
requirements: [MDAT-01]

must_haves:
  truths:
    - "KkjMatrix page shows one table section per bagian (RFCC, GAST, NGP, DHT/HMU by default)"
    - "Admin can add a new bagian via an Add Bagian button"
    - "Each bagian section header label (column header for each Target_* field) is editable in edit mode"
    - "Editable headers are saved via KkjBagianSave POST endpoint and persist across page reloads"
    - "Each KkjMatrixItem row belongs to exactly one bagian (Bagian string field)"
    - "KkjBagian table exists in SQL Server after EF migration"
  artifacts:
    - path: "Models/KkjModels.cs"
      provides: "KkjBagian entity with Id, Name, DisplayOrder, and 15 header label columns (Label_SectionHead … Label_HSE)"
      contains: "class KkjBagian"
    - path: "Data/ApplicationDbContext.cs"
      provides: "DbSet<KkjBagian> KkjBagians; KkjMatrixItem.Bagian column; EF configuration"
      contains: "DbSet<KkjBagian>"
    - path: "Controllers/AdminController.cs"
      provides: "KkjMatrix GET (grouped by bagian), KkjBagianSave POST, KkjBagianAdd POST"
      exports: ["KkjMatrix GET", "KkjBagianSave POST", "KkjBagianAdd POST"]
    - path: "Views/Admin/KkjMatrix.cshtml"
      provides: "Per-bagian grouped table sections; editable <th> inputs in edit mode; Add Bagian button"
  key_links:
    - from: "Views/Admin/KkjMatrix.cshtml (editMode addBagian button)"
      to: "/Admin/KkjBagianAdd"
      via: "AJAX POST with RequestVerificationToken header"
      pattern: "KkjBagianAdd"
    - from: "Views/Admin/KkjMatrix.cshtml (btnSave)"
      to: "/Admin/KkjBagianSave"
      via: "AJAX POST JSON with bagian headers + KkjMatrixSave for row data"
      pattern: "KkjBagianSave"
    - from: "Controllers/AdminController.cs KkjMatrix GET"
      to: "kkjBagians + kkjItems grouped"
      via: "_context.KkjBagians.OrderBy(b => b.DisplayOrder).ToListAsync()"
      pattern: "KkjBagians.OrderBy"
---

<objective>
Add per-bagian table structure to KKJ Matrix: new KkjBagian entity with editable column header labels, Bagian field on KkjMatrixItem, EF migration, grouped view rendering, and server endpoints.

Purpose: UAT gap 1 — user requires separate tables for RFCC, GAST, NGP, DHT/HMU bagians with ability to add bagians and edit column headers.
Output: KkjBagian DB table, updated KkjMatrixItem with Bagian field, per-bagian grouped view with editable headers in edit mode, KkjBagianSave and KkjBagianAdd endpoints.
</objective>

<execution_context>
@C:/Users/Administrator/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Administrator/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/47-kkj-matrix-manager/47-02-SUMMARY.md

<interfaces>
<!-- Existing KkjMatrixItem in Models/KkjModels.cs (20 columns total) -->
```csharp
public class KkjMatrixItem
{
    public int Id { get; set; }
    public int No { get; set; }
    public string SkillGroup { get; set; } = "";
    public string SubSkillGroup { get; set; } = "";
    public string Indeks { get; set; } = "";
    public string Kompetensi { get; set; } = "";
    // 15 Target_* columns:
    public string Target_SectionHead { get; set; } = "-";
    public string Target_SrSpv_GSH { get; set; } = "-";
    public string Target_ShiftSpv_GSH { get; set; } = "-";
    public string Target_Panelman_GSH_12_13 { get; set; } = "-";
    public string Target_Panelman_GSH_14 { get; set; } = "-";
    public string Target_Operator_GSH_8_11 { get; set; } = "-";
    public string Target_Operator_GSH_12_13 { get; set; } = "-";
    public string Target_ShiftSpv_ARU { get; set; } = "-";
    public string Target_Panelman_ARU_12_13 { get; set; } = "-";
    public string Target_Panelman_ARU_14 { get; set; } = "-";
    public string Target_Operator_ARU_8_11 { get; set; } = "-";
    public string Target_Operator_ARU_12_13 { get; set; } = "-";
    public string Target_SrSpv_Facility { get; set; } = "-";
    public string Target_JrAnalyst { get; set; } = "-";
    public string Target_HSE { get; set; } = "-";
}
```

<!-- Existing AdminController pattern (Controllers/AdminController.cs) -->
```csharp
[Authorize(Roles = "Admin")]
public class AdminController : Controller
{
    private readonly ApplicationDbContext _context;
    private readonly UserManager<ApplicationUser> _userManager;
    private readonly AuditLogService _auditLog;
    // existing: Index(), KkjMatrix() GET, KkjMatrixSave() POST, KkjMatrixDelete() POST
}
```

<!-- Existing AJAX pattern (from KkjMatrix.cshtml) -->
// Antiforgery for JSON body: RequestVerificationToken header
// Antiforgery for form-encoded: __RequestVerificationToken in data object
// JS sends PascalCase property names matching C# model

<!-- CpdpItem.Section pattern (established precedent for Section/Bagian field) -->
public string Section { get; set; } = "";   // RFCC | GAST | NGP | DHT
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add KkjBagian entity and Bagian field to KkjMatrixItem, register in DbContext, run EF migration</name>
  <files>
    Models/KkjModels.cs
    Data/ApplicationDbContext.cs
  </files>
  <action>
**In Models/KkjModels.cs**, add the KkjBagian class immediately after the KkjMatrixItem class:

```csharp
// KKJ Matrix Bagian (section grouping with editable column headers)
public class KkjBagian
{
    public int Id { get; set; }
    public string Name { get; set; } = "";           // e.g. "RFCC", "GAST", "NGP", "DHT/HMU"
    public int DisplayOrder { get; set; } = 0;

    // Editable column header labels for each Target_* field
    // Defaults mirror the existing static headers in KkjMatrix.cshtml
    public string Label_SectionHead        { get; set; } = "Section Head";
    public string Label_SrSpv_GSH          { get; set; } = "Sr Spv GSH";
    public string Label_ShiftSpv_GSH       { get; set; } = "Shift Spv GSH";
    public string Label_Panelman_GSH_12_13 { get; set; } = "Panelman GSH 12-13";
    public string Label_Panelman_GSH_14    { get; set; } = "Panelman GSH 14";
    public string Label_Operator_GSH_8_11  { get; set; } = "Op GSH 8-11";
    public string Label_Operator_GSH_12_13 { get; set; } = "Op GSH 12-13";
    public string Label_ShiftSpv_ARU       { get; set; } = "Shift Spv ARU";
    public string Label_Panelman_ARU_12_13 { get; set; } = "Panelman ARU 12-13";
    public string Label_Panelman_ARU_14    { get; set; } = "Panelman ARU 14";
    public string Label_Operator_ARU_8_11  { get; set; } = "Op ARU 8-11";
    public string Label_Operator_ARU_12_13 { get; set; } = "Op ARU 12-13";
    public string Label_SrSpv_Facility     { get; set; } = "Sr Spv Facility";
    public string Label_JrAnalyst          { get; set; } = "Jr Analyst";
    public string Label_HSE                { get; set; } = "HSE";
}
```

Also add a `Bagian` string property to `KkjMatrixItem` (after the `Kompetensi` property, before the Target_* fields):

```csharp
public string Bagian { get; set; } = "";   // FK by name to KkjBagian.Name (e.g. "RFCC")
```

**In Data/ApplicationDbContext.cs**, add the DbSet immediately after `public DbSet<CpdpItem> CpdpItems`:

```csharp
public DbSet<KkjBagian> KkjBagians { get; set; }
```

In `OnModelCreating`, add KkjBagian configuration after the existing KkjMatrixItem configuration block:

```csharp
builder.Entity<KkjBagian>(entity =>
{
    entity.ToTable("KkjBagians");
    entity.HasIndex(b => b.Name).IsUnique();
    entity.HasIndex(b => b.DisplayOrder);
});
```

**Run EF migration** (use --configuration Release to avoid locked Debug DLL):

```
cd C:/Users/Administrator/Desktop/PortalHC_KPB
dotnet ef migrations add AddKkjBagianAndBagianField --configuration Release
dotnet ef database update --configuration Release
```

If the dotnet ef tool is not found on PATH, try:
```
dotnet tool run dotnet-ef migrations add AddKkjBagianAndBagianField --configuration Release
dotnet tool run dotnet-ef database update --configuration Release
```

Verify the migration file was created in Migrations/ and the database update succeeded without errors.
  </action>
  <verify>
    <automated>cd C:/Users/Administrator/Desktop/PortalHC_KPB && dotnet build --configuration Release 2>&1 | tail -5</automated>
  </verify>
  <done>Build passes 0 errors. KkjBagian class exists in KkjModels.cs with all 15 Label_* properties. DbSet&lt;KkjBagian&gt; exists in ApplicationDbContext. Migration file created in Migrations/. `dotnet ef database update` succeeded.</done>
</task>

<task type="auto">
  <name>Task 2: Update AdminController — KkjMatrix GET returns grouped view model, add KkjBagianSave and KkjBagianAdd endpoints, seed default bagians</name>
  <files>
    Controllers/AdminController.cs
  </files>
  <action>
Replace the existing KkjMatrix GET action and add KkjBagianSave, KkjBagianAdd endpoints. Also add a private method to seed default bagians on first load.

**KkjMatrix GET** — change to pass both bagians and items to the view using a ViewModel tuple approach (ViewBag for bagians):

```csharp
// GET /Admin/KkjMatrix
public async Task<IActionResult> KkjMatrix()
{
    ViewData["Title"] = "Kelola KKJ Matrix";

    // Seed default bagians if none exist yet
    if (!await _context.KkjBagians.AnyAsync())
    {
        var defaults = new[]
        {
            new KkjBagian { Name = "RFCC",    DisplayOrder = 1 },
            new KkjBagian { Name = "GAST",    DisplayOrder = 2 },
            new KkjBagian { Name = "NGP",     DisplayOrder = 3 },
            new KkjBagian { Name = "DHT/HMU", DisplayOrder = 4 },
        };
        _context.KkjBagians.AddRange(defaults);
        await _context.SaveChangesAsync();
    }

    var bagians = await _context.KkjBagians.OrderBy(b => b.DisplayOrder).ToListAsync();
    var items   = await _context.KkjMatrices.OrderBy(k => k.No).ToListAsync();

    ViewBag.Bagians = bagians;
    return View(items);
}
```

**KkjBagianSave POST** — accepts a JSON array of KkjBagian objects (with Id and all Label_* fields), upserts them using FindAsync pattern:

```csharp
// POST /Admin/KkjBagianSave
[HttpPost]
[ValidateAntiForgeryToken]
public async Task<IActionResult> KkjBagianSave([FromBody] List<KkjBagian> bagians)
{
    if (bagians == null || !bagians.Any())
        return Json(new { success = false, message = "Tidak ada data bagian." });

    try
    {
        foreach (var b in bagians)
        {
            if (b.Id == 0)
            {
                _context.KkjBagians.Add(b);
            }
            else
            {
                var existing = await _context.KkjBagians.FindAsync(b.Id);
                if (existing != null)
                {
                    existing.Name         = b.Name;
                    existing.DisplayOrder = b.DisplayOrder;
                    existing.Label_SectionHead        = b.Label_SectionHead        ?? "Section Head";
                    existing.Label_SrSpv_GSH          = b.Label_SrSpv_GSH          ?? "Sr Spv GSH";
                    existing.Label_ShiftSpv_GSH       = b.Label_ShiftSpv_GSH       ?? "Shift Spv GSH";
                    existing.Label_Panelman_GSH_12_13 = b.Label_Panelman_GSH_12_13 ?? "Panelman GSH 12-13";
                    existing.Label_Panelman_GSH_14    = b.Label_Panelman_GSH_14    ?? "Panelman GSH 14";
                    existing.Label_Operator_GSH_8_11  = b.Label_Operator_GSH_8_11  ?? "Op GSH 8-11";
                    existing.Label_Operator_GSH_12_13 = b.Label_Operator_GSH_12_13 ?? "Op GSH 12-13";
                    existing.Label_ShiftSpv_ARU       = b.Label_ShiftSpv_ARU       ?? "Shift Spv ARU";
                    existing.Label_Panelman_ARU_12_13 = b.Label_Panelman_ARU_12_13 ?? "Panelman ARU 12-13";
                    existing.Label_Panelman_ARU_14    = b.Label_Panelman_ARU_14    ?? "Panelman ARU 14";
                    existing.Label_Operator_ARU_8_11  = b.Label_Operator_ARU_8_11  ?? "Op ARU 8-11";
                    existing.Label_Operator_ARU_12_13 = b.Label_Operator_ARU_12_13 ?? "Op ARU 12-13";
                    existing.Label_SrSpv_Facility     = b.Label_SrSpv_Facility     ?? "Sr Spv Facility";
                    existing.Label_JrAnalyst          = b.Label_JrAnalyst          ?? "Jr Analyst";
                    existing.Label_HSE                = b.Label_HSE                ?? "HSE";
                }
            }
        }
        await _context.SaveChangesAsync();
        return Json(new { success = true });
    }
    catch (Exception ex)
    {
        return Json(new { success = false, message = ex.Message });
    }
}
```

**KkjBagianAdd POST** — creates a new KkjBagian with a default name and next DisplayOrder:

```csharp
// POST /Admin/KkjBagianAdd
[HttpPost]
[ValidateAntiForgeryToken]
public async Task<IActionResult> KkjBagianAdd()
{
    var maxOrder = await _context.KkjBagians.MaxAsync(b => (int?)b.DisplayOrder) ?? 0;
    var newBagian = new KkjBagian
    {
        Name         = "Bagian Baru",
        DisplayOrder = maxOrder + 1
    };
    _context.KkjBagians.Add(newBagian);
    await _context.SaveChangesAsync();

    return Json(new
    {
        success = true,
        id      = newBagian.Id,
        name    = newBagian.Name,
        displayOrder = newBagian.DisplayOrder
    });
}
```

**Also update KkjMatrixSave** to persist the `Bagian` field. In the existing `KkjMatrixSave` action, add `existing.Bagian = row.Bagian ?? "";` after `existing.Kompetensi = ...`. Also in the bulk-save loop for `row.Id == 0`, EF will include `Bagian` automatically since it's a property on the deserialized object.
  </action>
  <verify>
    <automated>cd C:/Users/Administrator/Desktop/PortalHC_KPB && dotnet build --configuration Release 2>&1 | tail -5</automated>
  </verify>
  <done>Build passes 0 errors. AdminController has KkjMatrix GET (seeds bagians, returns ViewBag.Bagians + model items), KkjBagianSave POST (JSON upsert), KkjBagianAdd POST (creates new bagian with next order). KkjMatrixSave includes Bagian property update.</done>
</task>

<task type="auto">
  <name>Task 3: Update KkjMatrix view — per-bagian grouped sections, editable header inputs in edit mode, Add Bagian button, Bagian save wired into Simpan</name>
  <files>
    Views/Admin/KkjMatrix.cshtml
  </files>
  <action>
Rewrite Views/Admin/KkjMatrix.cshtml completely to add per-bagian structure. Keep all existing CSS and JS patterns (sticky columns, antiforgery header pattern, TSV paste, Tab/Enter nav) — only add/change the following:

**1. ViewModel JS injection** — embed both kkjItems and kkjBagians at top of page:

```cshtml
@{
    var itemsJson = System.Text.Json.JsonSerializer.Serialize(Model,
        new System.Text.Json.JsonSerializerOptions { PropertyNamingPolicy = null });
    var bagiansJson = System.Text.Json.JsonSerializer.Serialize(ViewBag.Bagians as List<HcPortal.Models.KkjBagian>,
        new System.Text.Json.JsonSerializerOptions { PropertyNamingPolicy = null });
}
<script>
    var kkjItems = @Html.Raw(itemsJson);
    var kkjBagians = @Html.Raw(bagiansJson ?? "[]");
</script>
```

**2. Add Bagian button** — place it in the header toolbar div (inside `#editActions`), after the existing `btnAddRow`:

```html
<button id="btnAddBagian" class="btn btn-outline-primary btn-sm">
    <i class="bi bi-plus-square me-1"></i>Tambah Bagian
</button>
```

**3. Read-mode rendering** — replace the single flat `@foreach` table with a per-bagian loop. Each bagian gets a `<h6>` heading and its own table showing only items where `item.Bagian == bagian.Name` (NOTE: Gap 2 plan will add all 16 columns to read-mode; this plan must at minimum add the Bagian column to the existing 5-column read table so rows are shown under correct section). For now render per-bagian with the existing 5 columns plus a grouping header:

```cshtml
@* Read-mode: per-bagian grouped sections *@
<div id="readTable">
    @{
        var bagians = ViewBag.Bagians as List<HcPortal.Models.KkjBagian> ?? new List<HcPortal.Models.KkjBagian>();
    }
    @foreach (var bagian in bagians)
    {
        var bagianItems = Model.Where(i => i.Bagian == bagian.Name).OrderBy(i => i.No).ToList();
        <h6 class="fw-bold text-primary mt-3 mb-1">@bagian.Name
            <span class="badge bg-secondary ms-1">@bagianItems.Count</span>
        </h6>
        <div class="table-responsive custom-scrollbar mb-3">
            <table class="table table-sm table-bordered table-hover mb-0">
                <thead class="table-dark">
                    <tr>
                        <th style="width:50px;">No</th>
                        <th style="width:100px;">Indeks</th>
                        <th>Kompetensi</th>
                        <th style="width:150px;">SkillGroup</th>
                        <th style="width:80px;">Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in bagianItems)
                    {
                        <tr data-id="@item.Id">
                            <td>@item.No</td>
                            <td>@item.Indeks</td>
                            <td>@item.Kompetensi</td>
                            <td>@item.SkillGroup</td>
                            <td>
                                <button class="btn btn-outline-danger btn-sm"
                                        onclick="deleteRow(@item.Id, '@Html.Raw(item.Kompetensi.Replace("'", "\\'"))')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                    @if (!bagianItems.Any())
                    {
                        <tr><td colspan="5" class="text-muted text-center">Belum ada item di bagian ini.</td></tr>
                    }
                </tbody>
            </table>
        </div>
    }
    @{
        var unassignedItems = Model.Where(i => string.IsNullOrEmpty(i.Bagian) || !bagians.Any(b => b.Name == i.Bagian)).ToList();
    }
    @if (unassignedItems.Any())
    {
        <h6 class="fw-bold text-warning mt-3 mb-1">Tidak Terkategori
            <span class="badge bg-warning text-dark ms-1">@unassignedItems.Count</span>
        </h6>
        <div class="table-responsive custom-scrollbar mb-3">
            <table class="table table-sm table-bordered table-hover mb-0">
                <thead class="table-dark">
                    <tr>
                        <th style="width:50px;">No</th>
                        <th style="width:100px;">Indeks</th>
                        <th>Kompetensi</th>
                        <th style="width:150px;">SkillGroup</th>
                        <th style="width:80px;">Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in unassignedItems)
                    {
                        <tr data-id="@item.Id">
                            <td>@item.No</td>
                            <td>@item.Indeks</td>
                            <td>@item.Kompetensi</td>
                            <td>@item.SkillGroup</td>
                            <td>
                                <button class="btn btn-outline-danger btn-sm"
                                        onclick="deleteRow(@item.Id, '@Html.Raw(item.Kompetensi.Replace("'", "\\'"))')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>
```

**4. Edit-mode: per-bagian sections** — replace the single `#editTable` div with a container `#editTablesContainer` that holds one table section per bagian (rendered by JS). Change the existing `id="editTable"` wrapper into `id="editTablesContainer"` and populate it entirely via JS:

Change the markup section from:
```html
<div id="editTable" class="d-none table-responsive custom-scrollbar" ...>
    <table ... id="kkjEditTbl">...</table>
</div>
```
To:
```html
<div id="editTablesContainer" class="d-none"></div>
```

**5. JS: renderEditRows()** — rewrite to create one table section per bagian:

```javascript
function renderEditRows() {
    var container = document.getElementById('editTablesContainer');
    container.innerHTML = '';
    kkjBagians.forEach(function(bagian, bagianIdx) {
        var bagianItems = kkjItems.filter(function(i) { return i.Bagian === bagian.Name; });

        // Section heading with bagian name input
        var heading = document.createElement('div');
        heading.className = 'mt-3 mb-1 d-flex align-items-center gap-2';
        heading.innerHTML = '<input type="text" class="form-control form-control-sm fw-bold text-primary bagian-name-input" '
            + 'data-bagian-id="' + bagian.Id + '" data-bagian-order="' + bagian.DisplayOrder + '" '
            + 'value="' + escHtml(bagian.Name) + '" style="max-width:160px;" title="Nama Bagian">';
        container.appendChild(heading);

        // Editable column header row: 15 label inputs
        var labelFields = [
            { key:'Label_SectionHead',        prop:'Target_SectionHead'        },
            { key:'Label_SrSpv_GSH',          prop:'Target_SrSpv_GSH'          },
            { key:'Label_ShiftSpv_GSH',       prop:'Target_ShiftSpv_GSH'       },
            { key:'Label_Panelman_GSH_12_13', prop:'Target_Panelman_GSH_12_13' },
            { key:'Label_Panelman_GSH_14',    prop:'Target_Panelman_GSH_14'    },
            { key:'Label_Operator_GSH_8_11',  prop:'Target_Operator_GSH_8_11'  },
            { key:'Label_Operator_GSH_12_13', prop:'Target_Operator_GSH_12_13' },
            { key:'Label_ShiftSpv_ARU',       prop:'Target_ShiftSpv_ARU'       },
            { key:'Label_Panelman_ARU_12_13', prop:'Target_Panelman_ARU_12_13' },
            { key:'Label_Panelman_ARU_14',    prop:'Target_Panelman_ARU_14'    },
            { key:'Label_Operator_ARU_8_11',  prop:'Target_Operator_ARU_8_11'  },
            { key:'Label_Operator_ARU_12_13', prop:'Target_Operator_ARU_12_13' },
            { key:'Label_SrSpv_Facility',     prop:'Target_SrSpv_Facility'     },
            { key:'Label_JrAnalyst',          prop:'Target_JrAnalyst'          },
            { key:'Label_HSE',               prop:'Target_HSE'                },
        ];

        var tableWrapper = document.createElement('div');
        tableWrapper.className = 'table-responsive custom-scrollbar mb-3';
        tableWrapper.style.maxHeight = '80vh';

        var tbl = document.createElement('table');
        tbl.className = 'table table-sm table-bordered align-middle mb-0 kkj-edit-tbl';
        tbl.dataset.bagianId = bagian.Id;
        tbl.dataset.bagianName = bagian.Name;

        // thead: No, SkillGroup, SubSkillGroup, Indeks, Kompetensi + 15 editable label inputs
        var thead = document.createElement('thead');
        thead.className = 'table-dark';
        var headerRow = document.createElement('tr');

        var fixedHeaders = ['No','SkillGroup','SubSkillGroup','Indeks','Kompetensi'];
        fixedHeaders.forEach(function(h) {
            var th = document.createElement('th');
            th.textContent = h;
            th.className = h === 'No' ? 'col-no' : 'col-meta';
            if (h === 'Kompetensi') th.style.minWidth = '180px';
            headerRow.appendChild(th);
        });

        labelFields.forEach(function(lf) {
            var th = document.createElement('th');
            th.className = 'col-target';
            var inp = document.createElement('input');
            inp.type = 'text';
            inp.className = 'edit-input bagian-label-input';
            inp.dataset.bagianId = bagian.Id;
            inp.dataset.labelKey = lf.key;
            inp.value = bagian[lf.key] || '';
            inp.style.minWidth = '70px';
            inp.title = 'Klik untuk edit label kolom ini';
            th.appendChild(inp);
            headerRow.appendChild(th);
        });

        thead.appendChild(headerRow);
        tbl.appendChild(thead);

        // tbody: rows belonging to this bagian
        var tbody = document.createElement('tbody');
        tbody.className = 'bagian-tbody';
        tbody.dataset.bagianName = bagian.Name;
        bagianItems.forEach(function(item) {
            tbody.appendChild(makeRow(item));
        });
        tbl.appendChild(tbody);
        tableWrapper.appendChild(tbl);
        container.appendChild(tableWrapper);

        // "Add row to this bagian" button
        var addBtn = document.createElement('button');
        addBtn.type = 'button';
        addBtn.className = 'btn btn-outline-success btn-sm mb-3';
        addBtn.innerHTML = '<i class="bi bi-plus me-1"></i>Tambah Baris ke ' + escHtml(bagian.Name);
        addBtn.addEventListener('click', function() {
            var emptyRow = makeEmptyRow();
            emptyRow.querySelector('[name="Bagian"]').value = bagian.Name;
            tbody.appendChild(emptyRow);
        });
        container.appendChild(addBtn);
    });
}
```

**6. Update makeRow()** — add a hidden `Bagian` field as the first field (before `No`):

In the `fields` array inside `makeRow()`, prepend:
```javascript
{ name:'Bagian', val: item.Bagian || '', cls:'d-none', hidden: true },
```
And in the forEach that builds `<td>` cells, skip rendering the td as visible if `f.hidden` is true (render the input inside a `<td style="display:none">` or simply as a hidden input appended directly to the `<tr>` without a visible `<td>`). Cleaner: render as a hidden input on the `<tr>` element itself without a `<td>`:

```javascript
// At start of makeRow(), before building fields:
var bagianInput = document.createElement('input');
bagianInput.type = 'hidden';
bagianInput.name = 'Bagian';
bagianInput.value = item.Bagian || '';
tr.appendChild(bagianInput);
```

Do NOT add a `<td>` for Bagian — it's hidden.

**7. Update makeEmptyRow()** — add `Bagian: ''` to the empty item object.

**8. JS: btnEdit handler** — change target from `#editTable` to `#editTablesContainer`:

```javascript
document.getElementById('btnEdit').addEventListener('click', function() {
    renderEditRows();
    document.getElementById('readTable').classList.add('d-none');
    document.getElementById('editTablesContainer').classList.remove('d-none');
    document.getElementById('editActions').classList.remove('d-none');
    document.getElementById('editActions').classList.add('d-flex');
    this.classList.add('d-none');
});

document.getElementById('btnCancel').addEventListener('click', function() {
    document.getElementById('editTablesContainer').classList.add('d-none');
    document.getElementById('readTable').classList.remove('d-none');
    document.getElementById('editActions').classList.add('d-none');
    document.getElementById('editActions').classList.remove('d-flex');
    document.getElementById('btnEdit').classList.remove('d-none');
});
```

**9. JS: btnAddRow** — repurpose/hide the global add-row button since each bagian now has its own add-row button. Change `btnAddRow` click handler to: if no bagians exist, add to first available tbody; otherwise do nothing (add-row is per-bagian now). Or simply hide `btnAddRow` from the toolbar — it's replaced by per-bagian add buttons. Remove `btnAddRow` from the `#editActions` div in HTML.

**10. JS: btnAddBagian handler** — AJAX POST to `/Admin/KkjBagianAdd`, on success appends a new bagian section to the edit container:

```javascript
document.getElementById('btnAddBagian').addEventListener('click', function() {
    var token = document.querySelector('input[name="__RequestVerificationToken"]').value;
    $.ajax({
        url: '/Admin/KkjBagianAdd',
        type: 'POST',
        data: { __RequestVerificationToken: token },
        success: function(resp) {
            if (resp.success) {
                // Add to kkjBagians array and re-render
                kkjBagians.push({
                    Id: resp.id,
                    Name: resp.name,
                    DisplayOrder: resp.displayOrder,
                    Label_SectionHead: 'Section Head',
                    Label_SrSpv_GSH: 'Sr Spv GSH',
                    Label_ShiftSpv_GSH: 'Shift Spv GSH',
                    Label_Panelman_GSH_12_13: 'Panelman GSH 12-13',
                    Label_Panelman_GSH_14: 'Panelman GSH 14',
                    Label_Operator_GSH_8_11: 'Op GSH 8-11',
                    Label_Operator_GSH_12_13: 'Op GSH 12-13',
                    Label_ShiftSpv_ARU: 'Shift Spv ARU',
                    Label_Panelman_ARU_12_13: 'Panelman ARU 12-13',
                    Label_Panelman_ARU_14: 'Panelman ARU 14',
                    Label_Operator_ARU_8_11: 'Op ARU 8-11',
                    Label_Operator_ARU_12_13: 'Op ARU 12-13',
                    Label_SrSpv_Facility: 'Sr Spv Facility',
                    Label_JrAnalyst: 'Jr Analyst',
                    Label_HSE: 'HSE'
                });
                renderEditRows();
            } else {
                alert('Error: ' + resp.message);
            }
        }
    });
});
```

**11. JS: btnSave handler** — update to also collect and save bagian header labels BEFORE saving rows. The save sequence is:
1. Collect bagian objects from label inputs and name inputs in the edit container.
2. POST to `/Admin/KkjBagianSave` (JSON body, RequestVerificationToken header).
3. On success, collect row data from all bagian tbodies (set `Bagian` field from `tr` hidden input or `tbody.dataset.bagianName`).
4. POST to `/Admin/KkjMatrixSave` as before.
5. On success, show toast then reload (per Gap 5 — implemented in Plan 05; for now just `location.reload()`).

Bagian collection JS:
```javascript
function collectBagians() {
    var result = [];
    document.querySelectorAll('.kkj-edit-tbl').forEach(function(tbl) {
        var bagianId   = parseInt(tbl.dataset.bagianId) || 0;
        var nameInput  = tbl.closest('[id]') && tbl.parentElement.previousElementSibling
            ? tbl.parentElement.previousElementSibling.querySelector('.bagian-name-input')
            : null;
        // More reliable: collect by bagianId from label inputs
        var b = { Id: bagianId, Name: '', DisplayOrder: 0 };
        var nameEl = document.querySelector('.bagian-name-input[data-bagian-id="' + bagianId + '"]');
        if (nameEl) { b.Name = nameEl.value; b.DisplayOrder = parseInt(nameEl.dataset.bagianOrder) || 0; }
        tbl.querySelectorAll('.bagian-label-input').forEach(function(inp) {
            b[inp.dataset.labelKey] = inp.value;
        });
        result.push(b);
    });
    return result;
}
```

Row collection JS (reads Bagian from hidden input on each tr):
```javascript
function collectRows() {
    var rows = [];
    document.querySelectorAll('.bagian-tbody tr').forEach(function(tr) {
        var getVal = function(name) {
            // Check hidden input first, then named input
            var el = tr.querySelector('input[name="' + name + '"]');
            return el ? el.value : '';
        };
        rows.push({
            Id:                        parseInt(tr.dataset.id) || 0,
            Bagian:                    getVal('Bagian'),
            No:                        parseInt(getVal('No')) || 0,
            SkillGroup:                getVal('SkillGroup'),
            SubSkillGroup:             getVal('SubSkillGroup'),
            Indeks:                    getVal('Indeks'),
            Kompetensi:                getVal('Kompetensi'),
            Target_SectionHead:        getVal('Target_SectionHead') || '-',
            Target_SrSpv_GSH:          getVal('Target_SrSpv_GSH') || '-',
            Target_ShiftSpv_GSH:       getVal('Target_ShiftSpv_GSH') || '-',
            Target_Panelman_GSH_12_13: getVal('Target_Panelman_GSH_12_13') || '-',
            Target_Panelman_GSH_14:    getVal('Target_Panelman_GSH_14') || '-',
            Target_Operator_GSH_8_11:  getVal('Target_Operator_GSH_8_11') || '-',
            Target_Operator_GSH_12_13: getVal('Target_Operator_GSH_12_13') || '-',
            Target_ShiftSpv_ARU:       getVal('Target_ShiftSpv_ARU') || '-',
            Target_Panelman_ARU_12_13: getVal('Target_Panelman_ARU_12_13') || '-',
            Target_Panelman_ARU_14:    getVal('Target_Panelman_ARU_14') || '-',
            Target_Operator_ARU_8_11:  getVal('Target_Operator_ARU_8_11') || '-',
            Target_Operator_ARU_12_13: getVal('Target_Operator_ARU_12_13') || '-',
            Target_SrSpv_Facility:     getVal('Target_SrSpv_Facility') || '-',
            Target_JrAnalyst:          getVal('Target_JrAnalyst') || '-',
            Target_HSE:                getVal('Target_HSE') || '-'
        });
    });
    return rows;
}
```

**12. JS: escHtml helper** — add at the top of the script block:
```javascript
function escHtml(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
```

**13. Update paste handler** — change from `document.getElementById('kkjEditTbl')` to `document.getElementById('editTablesContainer')` and use event delegation on the paste event. The existing TSV paste logic works the same; just update the container reference and use `e.target.closest('.kkj-edit-tbl')` to find the specific table being pasted into.

**14. Update Tab/Enter keyboard nav** — change `#kkjEditTbl` selector to `#editTablesContainer` and select from `.bagian-tbody input.edit-input`.

Build and verify.
  </action>
  <verify>
    <automated>cd C:/Users/Administrator/Desktop/PortalHC_KPB && dotnet build --configuration Release 2>&1 | tail -5</automated>
  </verify>
  <done>Build passes 0 errors. KkjMatrix.cshtml renders per-bagian sections in read mode (4 default bagian sections). Edit mode shows per-bagian edit tables with editable &lt;th&gt; label inputs and per-bagian Add Row buttons. Add Bagian button visible in edit mode toolbar. Simpan collects and saves both bagian headers (KkjBagianSave) and row data (KkjMatrixSave). Page reloads showing grouped structure.</done>
</task>

</tasks>

<verification>
1. `dotnet build --configuration Release` — 0 errors, 0 warnings (or only pre-existing warnings)
2. Navigate to `/Admin/KkjMatrix` — page loads with 4 bagian sections (RFCC, GAST, NGP, DHT/HMU)
3. Click Edit Mode — edit container appears with one table per bagian, each with editable header label inputs
4. Change a header label, click Simpan — page reloads, header label persists
5. Click Add Bagian button — new section appears in edit mode
6. Add a row to a bagian, fill Bagian field, Simpan — row saved and appears under correct section on reload
</verification>

<success_criteria>
- KkjBagians table exists in SQL Server (EF migration applied)
- KkjMatrixItem.Bagian column exists in SQL Server
- /Admin/KkjMatrix renders separate table sections per bagian
- Column header labels are editable &lt;input&gt; elements in edit mode
- KkjBagianSave POST persists header changes to DB
- KkjBagianAdd POST creates new bagian row in DB
</success_criteria>

<output>
After completion, create `.planning/phases/47-kkj-matrix-manager/47-03-SUMMARY.md`
</output>
