---
phase: 47-kkj-matrix-manager
plan: 04
type: execute
wave: 2
depends_on: [47-03]
files_modified:
  - Views/Admin/KkjMatrix.cshtml
autonomous: true
gap_closure: true
requirements: [MDAT-01]

must_haves:
  truths:
    - "Read mode shows full table with all 21 columns (No, Indeks, Kompetensi, SkillGroup, SubSkillGroup, 15 Target_* columns, Aksi)"
    - "Edit mode has an 'Aksi' column as the 22nd column with an insert-below button and an inline delete button per row"
    - "Clicking insert-below inserts a new empty row immediately after the current row (not appended at bottom)"
    - "Clicking inline delete on an unsaved row (Id=0) removes it from DOM immediately without confirmation"
    - "Clicking inline delete on a saved row (Id > 0) shows a confirm dialog then sends AJAX delete to /Admin/KkjMatrixDelete"
  artifacts:
    - path: "Views/Admin/KkjMatrix.cshtml"
      provides: "Full 21-column read-mode thead and tbody; 22nd Aksi column in edit-mode makeRow(); per-row insert and delete"
      contains: "SubSkillGroup"
  key_links:
    - from: "makeRow() Aksi <td> delete button (Id>0)"
      to: "/Admin/KkjMatrixDelete"
      via: "AJAX POST with __RequestVerificationToken form-encoded"
      pattern: "KkjMatrixDelete"
    - from: "makeRow() Aksi <td> insert button"
      to: "tr.parentNode.insertBefore(makeEmptyRow(), tr.nextSibling)"
      via: "DOM manipulation"
      pattern: "insertBefore"
---

<objective>
Expand KkjMatrix read-mode table to show all 21 columns, and add a per-row Aksi column in edit mode with insert-below and inline delete buttons.

Purpose: UAT gaps 2 and 3 — user wants read mode to show the full table (not compact 5-column view), and wants per-row insert/delete in edit mode so rows can be added or removed at any position.
Output: Updated KkjMatrix.cshtml with full-width read-mode table and per-row action column in edit mode.
</objective>

<execution_context>
@C:/Users/Administrator/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Administrator/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/47-kkj-matrix-manager/47-03-SUMMARY.md

<interfaces>
<!-- Current read-mode thead (5 columns — to be expanded to 21) -->
<!-- No | Indeks | Kompetensi | SkillGroup | Aksi -->

<!-- Target columns to add (16 new columns): SubSkillGroup + 15 Target_* -->
<!-- Target_SectionHead, Target_SrSpv_GSH, Target_ShiftSpv_GSH,
     Target_Panelman_GSH_12_13, Target_Panelman_GSH_14,
     Target_Operator_GSH_8_11, Target_Operator_GSH_12_13,
     Target_ShiftSpv_ARU, Target_Panelman_ARU_12_13, Target_Panelman_ARU_14,
     Target_Operator_ARU_8_11, Target_Operator_ARU_12_13,
     Target_SrSpv_Facility, Target_JrAnalyst, Target_HSE -->

<!-- KkjBagian label fields (from Plan 03 — used as read-mode column headers) -->
<!-- bagian.Label_SectionHead ... bagian.Label_HSE -->

<!-- makeRow() signature (from Plan 03) -->
// makeRow(item) returns a <tr> with hidden Bagian input + 20 data input <td>s
// makeEmptyRow() returns makeRow({Id:0, Bagian:'', No:0, ...})

<!-- deleteRow() function (existing, keep as-is for read-mode delete button) -->
// deleteRow(id, kompetensi) — confirms, AJAX POST to /Admin/KkjMatrixDelete
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand read-mode table to all 21 columns per bagian</name>
  <files>
    Views/Admin/KkjMatrix.cshtml
  </files>
  <action>
In the read-mode section of `Views/Admin/KkjMatrix.cshtml`, replace the 5-column table structure with a full 21-column table for each bagian section.

**For each bagian's read-mode table**, update the `<thead>` and `<tbody>` like this:

```cshtml
<thead class="table-dark">
    <tr>
        <th style="width:45px;">No</th>
        <th style="width:90px;">Indeks</th>
        <th style="min-width:180px;">Kompetensi</th>
        <th style="min-width:120px;">SkillGroup</th>
        <th style="min-width:120px;">SubSkillGroup</th>
        <th class="col-target">@bagian.Label_SectionHead</th>
        <th class="col-target">@bagian.Label_SrSpv_GSH</th>
        <th class="col-target">@bagian.Label_ShiftSpv_GSH</th>
        <th class="col-target">@bagian.Label_Panelman_GSH_12_13</th>
        <th class="col-target">@bagian.Label_Panelman_GSH_14</th>
        <th class="col-target">@bagian.Label_Operator_GSH_8_11</th>
        <th class="col-target">@bagian.Label_Operator_GSH_12_13</th>
        <th class="col-target">@bagian.Label_ShiftSpv_ARU</th>
        <th class="col-target">@bagian.Label_Panelman_ARU_12_13</th>
        <th class="col-target">@bagian.Label_Panelman_ARU_14</th>
        <th class="col-target">@bagian.Label_Operator_ARU_8_11</th>
        <th class="col-target">@bagian.Label_Operator_ARU_12_13</th>
        <th class="col-target">@bagian.Label_SrSpv_Facility</th>
        <th class="col-target">@bagian.Label_JrAnalyst</th>
        <th class="col-target">@bagian.Label_HSE</th>
        <th style="width:70px;">Aksi</th>
    </tr>
</thead>
<tbody>
    @foreach (var item in bagianItems)
    {
        <tr data-id="@item.Id">
            <td>@item.No</td>
            <td>@item.Indeks</td>
            <td>@item.Kompetensi</td>
            <td>@item.SkillGroup</td>
            <td>@item.SubSkillGroup</td>
            <td>@item.Target_SectionHead</td>
            <td>@item.Target_SrSpv_GSH</td>
            <td>@item.Target_ShiftSpv_GSH</td>
            <td>@item.Target_Panelman_GSH_12_13</td>
            <td>@item.Target_Panelman_GSH_14</td>
            <td>@item.Target_Operator_GSH_8_11</td>
            <td>@item.Target_Operator_GSH_12_13</td>
            <td>@item.Target_ShiftSpv_ARU</td>
            <td>@item.Target_Panelman_ARU_12_13</td>
            <td>@item.Target_Panelman_ARU_14</td>
            <td>@item.Target_Operator_ARU_8_11</td>
            <td>@item.Target_Operator_ARU_12_13</td>
            <td>@item.Target_SrSpv_Facility</td>
            <td>@item.Target_JrAnalyst</td>
            <td>@item.Target_HSE</td>
            <td>
                <button class="btn btn-outline-danger btn-sm"
                        onclick="deleteRow(@item.Id, '@Html.Raw(item.Kompetensi.Replace("'", "\\'"))')">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        </tr>
    }
    @if (!bagianItems.Any())
    {
        <tr><td colspan="21" class="text-muted text-center">Belum ada item di bagian ini.</td></tr>
    }
</tbody>
```

Do the same for the "Tidak Terkategori" fallback section (use static header text since no bagian object is available):

```cshtml
<thead class="table-dark">
    <tr>
        <th style="width:45px;">No</th>
        <th style="width:90px;">Indeks</th>
        <th style="min-width:180px;">Kompetensi</th>
        <th style="min-width:120px;">SkillGroup</th>
        <th style="min-width:120px;">SubSkillGroup</th>
        <th class="col-target">Section Head</th>
        <th class="col-target">Sr Spv GSH</th>
        <th class="col-target">Shift Spv GSH</th>
        <th class="col-target">Panelman GSH 12-13</th>
        <th class="col-target">Panelman GSH 14</th>
        <th class="col-target">Op GSH 8-11</th>
        <th class="col-target">Op GSH 12-13</th>
        <th class="col-target">Shift Spv ARU</th>
        <th class="col-target">Panelman ARU 12-13</th>
        <th class="col-target">Panelman ARU 14</th>
        <th class="col-target">Op ARU 8-11</th>
        <th class="col-target">Op ARU 12-13</th>
        <th class="col-target">Sr Spv Facility</th>
        <th class="col-target">Jr Analyst</th>
        <th class="col-target">HSE</th>
        <th style="width:70px;">Aksi</th>
    </tr>
</thead>
```

Note: Since the read-mode table is now wide, ensure each bagian table wrapper uses `class="table-responsive custom-scrollbar mb-3"` so horizontal scrolling works. This is already in place from Plan 03.
  </action>
  <verify>
    <automated>cd C:/Users/Administrator/Desktop/PortalHC_KPB && dotnet build --configuration Release 2>&1 | tail -5</automated>
  </verify>
  <done>Build passes 0 errors. Read-mode table for each bagian section has 21 columns (No, Indeks, Kompetensi, SkillGroup, SubSkillGroup, 15 Target_* columns, Aksi). Column headers use bagian.Label_* values. All Target_* cell values are rendered.</done>
</task>

<task type="auto">
  <name>Task 2: Add 22nd Aksi column to edit-mode makeRow() with insert-below and inline delete</name>
  <files>
    Views/Admin/KkjMatrix.cshtml
  </files>
  <action>
In `Views/Admin/KkjMatrix.cshtml`, update the edit-mode structure:

**2a. Add Aksi `<th>` to the edit table thead** — in `renderEditRows()`, after adding the 5 fixed header `<th>`s and 15 label input `<th>`s, add a sticky Aksi column header:

```javascript
var thAksi = document.createElement('th');
thAksi.className = 'col-aksi';
thAksi.textContent = 'Aksi';
thAksi.style.minWidth = '75px';
headerRow.appendChild(thAksi);
```

Add the CSS class `.col-aksi { min-width: 75px; }` to the `<style>` block.

**2b. Update makeRow()** — append a 22nd `<td>` with two action buttons after the 20 existing data-input `<td>`s:

```javascript
function makeRow(item) {
    var tr = document.createElement('tr');
    tr.dataset.id = item.Id || 0;

    // Hidden Bagian input (from Plan 03)
    var bagianInput = document.createElement('input');
    bagianInput.type = 'hidden';
    bagianInput.name = 'Bagian';
    bagianInput.value = item.Bagian || '';
    tr.appendChild(bagianInput);

    var fields = [
        { name:'No',                        val: item.No,                        cls:'col-no',    type:'number' },
        { name:'SkillGroup',                val: item.SkillGroup,                cls:'col-meta' },
        { name:'SubSkillGroup',             val: item.SubSkillGroup,             cls:'col-meta' },
        { name:'Indeks',                    val: item.Indeks,                    cls:'col-meta' },
        { name:'Kompetensi',                val: item.Kompetensi,                cls:'col-meta', style:'min-width:180px' },
        { name:'Target_SectionHead',        val: item.Target_SectionHead,        cls:'col-target' },
        { name:'Target_SrSpv_GSH',          val: item.Target_SrSpv_GSH,          cls:'col-target' },
        { name:'Target_ShiftSpv_GSH',       val: item.Target_ShiftSpv_GSH,       cls:'col-target' },
        { name:'Target_Panelman_GSH_12_13', val: item.Target_Panelman_GSH_12_13, cls:'col-target' },
        { name:'Target_Panelman_GSH_14',    val: item.Target_Panelman_GSH_14,    cls:'col-target' },
        { name:'Target_Operator_GSH_8_11',  val: item.Target_Operator_GSH_8_11,  cls:'col-target' },
        { name:'Target_Operator_GSH_12_13', val: item.Target_Operator_GSH_12_13, cls:'col-target' },
        { name:'Target_ShiftSpv_ARU',       val: item.Target_ShiftSpv_ARU,       cls:'col-target' },
        { name:'Target_Panelman_ARU_12_13', val: item.Target_Panelman_ARU_12_13, cls:'col-target' },
        { name:'Target_Panelman_ARU_14',    val: item.Target_Panelman_ARU_14,    cls:'col-target' },
        { name:'Target_Operator_ARU_8_11',  val: item.Target_Operator_ARU_8_11,  cls:'col-target' },
        { name:'Target_Operator_ARU_12_13', val: item.Target_Operator_ARU_12_13, cls:'col-target' },
        { name:'Target_SrSpv_Facility',     val: item.Target_SrSpv_Facility,     cls:'col-target' },
        { name:'Target_JrAnalyst',          val: item.Target_JrAnalyst,          cls:'col-target' },
        { name:'Target_HSE',                val: item.Target_HSE,                cls:'col-target' },
    ];
    fields.forEach(function(f) {
        var td = document.createElement('td');
        td.className = f.cls || '';
        if (f.style) td.style.cssText = f.style;
        var input = document.createElement('input');
        input.type = f.type || 'text';
        input.name = f.name;
        input.value = (f.val === null || f.val === undefined) ? '' : f.val;
        input.className = 'edit-input';
        td.appendChild(input);
        tr.appendChild(td);
    });

    // 22nd column: Aksi (insert-below + inline delete)
    var tdAksi = document.createElement('td');
    tdAksi.className = 'col-aksi text-nowrap';

    // Insert-below button
    var btnInsert = document.createElement('button');
    btnInsert.type = 'button';
    btnInsert.className = 'btn btn-outline-success btn-sm me-1';
    btnInsert.title = 'Sisipkan baris baru di bawah';
    btnInsert.innerHTML = '<i class="bi bi-plus-circle"></i>';
    btnInsert.addEventListener('click', function() {
        var bagianName = tr.querySelector('input[name="Bagian"]').value || '';
        var newRow = makeEmptyRow();
        newRow.querySelector('input[name="Bagian"]').value = bagianName;
        tr.parentNode.insertBefore(newRow, tr.nextSibling);
    });

    // Inline delete button
    var btnDel = document.createElement('button');
    btnDel.type = 'button';
    btnDel.className = 'btn btn-outline-danger btn-sm';
    btnDel.title = 'Hapus baris ini';
    btnDel.innerHTML = '<i class="bi bi-trash"></i>';
    btnDel.addEventListener('click', function() {
        var id = parseInt(tr.dataset.id) || 0;
        if (id === 0) {
            // Unsaved row — remove from DOM directly
            tr.remove();
        } else {
            // Saved row — confirm then AJAX delete
            var kompetensi = tr.querySelector('[name="Kompetensi"]') ? tr.querySelector('[name="Kompetensi"]').value : '';
            if (!confirm('Hapus "' + kompetensi + '"?')) return;
            var token = document.querySelector('input[name="__RequestVerificationToken"]').value;
            $.ajax({
                url: '/Admin/KkjMatrixDelete',
                type: 'POST',
                data: { id: id, __RequestVerificationToken: token },
                success: function(response) {
                    if (response.success) {
                        tr.remove();
                        kkjItems = kkjItems.filter(function(i) { return i.Id !== id; });
                    } else if (response.blocked) {
                        alert(response.message);
                    } else {
                        alert('Error: ' + response.message);
                    }
                }
            });
        }
    });

    tdAksi.appendChild(btnInsert);
    tdAksi.appendChild(btnDel);
    tr.appendChild(tdAksi);
    return tr;
}
```

**2c. makeEmptyRow()** — already calls `makeRow({Id:0, Bagian:'', ...})` which now includes the Aksi column automatically.

**2d. CSS for sticky Aksi column** — in the `<style>` block, the existing sticky CSS uses `nth-child` on `#editTable`. Since Plan 03 replaced `#editTable` with `.kkj-edit-tbl`, update the sticky selectors:

```css
.kkj-edit-tbl td:nth-child(1), .kkj-edit-tbl th:nth-child(1) {
    position: sticky; left: 0; background: white; z-index: 5; border-right: 1px solid #dee2e6;
}
.kkj-edit-tbl td:nth-child(2), .kkj-edit-tbl th:nth-child(2) {
    position: sticky; left: 57px; background: white; z-index: 5; border-right: 1px solid #dee2e6;
}
.kkj-edit-tbl thead th {
    position: sticky; top: 0; background: #343a40; color: white; z-index: 10;
}
.kkj-edit-tbl thead th:nth-child(1), .kkj-edit-tbl thead th:nth-child(2) { z-index: 15; }
.col-aksi { min-width: 75px; }
```

Note: The nth-child counts include the `<td>` for data columns. The "No" column will be the first visible `<td>` (column 1) and "SkillGroup" will be the second (column 2) — since Bagian is a hidden input appended directly to `<tr>` (not a `<td>`), it does not affect nth-child counts.

Build to verify.
  </action>
  <verify>
    <automated>cd C:/Users/Administrator/Desktop/PortalHC_KPB && dotnet build --configuration Release 2>&1 | tail -5</automated>
  </verify>
  <done>Build passes 0 errors. In edit mode, each row has a 22nd Aksi column with two buttons: insert-below (adds empty row immediately after current row with same Bagian value) and delete (removes unsaved rows instantly from DOM; confirms and AJAX-deletes saved rows). makeEmptyRow() inherits the Aksi column from makeRow().</done>
</task>

</tasks>

<verification>
1. `dotnet build --configuration Release` — 0 errors
2. Navigate to `/Admin/KkjMatrix` in read mode — count columns: should see No, Indeks, Kompetensi, SkillGroup, SubSkillGroup + 15 Target_* + Aksi = 21 columns with horizontal scroll
3. Column headers in read mode show bagian.Label_* values (e.g. "Section Head" by default)
4. Click Edit Mode — each row in each bagian's edit table has an Aksi column as the last column
5. Click insert-below on a row — new empty row appears immediately below it (not at bottom)
6. Click delete on an unsaved new row (Id=0) — row disappears immediately, no confirmation needed
7. Click delete on a saved row — confirmation dialog appears, after confirming AJAX call removes the row
</verification>

<success_criteria>
- Read-mode table shows all 21 columns per bagian section (No + Indeks + Kompetensi + SkillGroup + SubSkillGroup + 15 Target_* + Aksi)
- Column headers in read mode use bagian Label_* values
- Edit-mode rows have a 22nd Aksi column with insert-below and delete buttons
- Insert-below uses `tr.parentNode.insertBefore(makeEmptyRow(), tr.nextSibling)` pattern
- Inline delete for Id=0 rows is DOM-only (no server call)
- Inline delete for saved rows uses existing /Admin/KkjMatrixDelete endpoint
</success_criteria>

<output>
After completion, create `.planning/phases/47-kkj-matrix-manager/47-04-SUMMARY.md`
</output>
