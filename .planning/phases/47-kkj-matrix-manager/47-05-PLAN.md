---
phase: 47-kkj-matrix-manager
plan: 05
type: execute
wave: 2
depends_on: [47-03]
files_modified:
  - Views/Admin/KkjMatrix.cshtml
autonomous: true
gap_closure: true
requirements: [MDAT-01]

must_haves:
  truths:
    - "Admin can click and drag across multiple cells to select a range (cells highlight visually)"
    - "Admin can Shift+click to extend the selection to a new anchor"
    - "Pressing Delete clears all selected cells to empty string"
    - "Ctrl+C copies the selected range as tab-separated text to the clipboard"
    - "Ctrl+V pastes clipboard text starting from the top-left selected cell, filling the range"
    - "After clicking Simpan, a Bootstrap Toast 'Data berhasil disimpan' appears for ~1.5 seconds before page reloads"
  artifacts:
    - path: "Views/Admin/KkjMatrix.cshtml"
      provides: "selectedCells array, mousedown/mousemove/mouseup selection model, highlight overlay, Ctrl+C/Ctrl+V/Delete key handlers, Bootstrap Toast on save success"
      contains: "selectedCells"
  key_links:
    - from: "mousedown on .kkj-edit-tbl td"
      to: "selectedCells array and .cell-selected CSS class"
      via: "startCell / endCell drag selection loop"
      pattern: "selectedCells"
    - from: "btnSave success callback"
      to: "Bootstrap Toast then setTimeout reload"
      via: "new bootstrap.Toast(document.getElementById('saveToast')).show()"
      pattern: "saveToast"
---

<objective>
Add Excel-like multi-cell selection to the edit table (click+drag, Shift+click, Delete range-clear, Ctrl+C range-copy, Ctrl+V range-paste) and a Bootstrap Toast confirmation after save.

Purpose: UAT gaps 4 and 5 — user wants Excel-style multi-cell selection for copy/paste/delete operations, and a brief success confirmation after Simpan.
Output: Updated KkjMatrix.cshtml with custom selection overlay model and toast notification.
</objective>

<execution_context>
@C:/Users/Administrator/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Administrator/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/47-kkj-matrix-manager/47-03-SUMMARY.md
@.planning/phases/47-kkj-matrix-manager/47-04-SUMMARY.md

<interfaces>
<!-- Edit table structure (from Plans 03 + 04) -->
// Each bagian has a <table class="kkj-edit-tbl"> with tbody.bagian-tbody
// Each <tr> in tbody has: hidden input[name="Bagian"], then 20 <td>s each with input.edit-input, then 1 <td> Aksi
// tr.dataset.id = item Id

<!-- Bootstrap 5 Toast (already in _Layout.cshtml) -->
// Bootstrap 5 is already loaded. Use:
// new bootstrap.Toast(element, { delay: 1500 }).show()

<!-- Antiforgery + AJAX pattern (established in Phase 47) -->
// JSON body: RequestVerificationToken in headers
// Form-encoded: __RequestVerificationToken in data

<!-- Existing paste handler location -->
// Currently on document.getElementById('editTablesContainer') from Plan 03
// TSV paste: split '\n' for rows, '\t' for columns — fills inputs in focused table row
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Excel-like multi-cell selection (click+drag, Shift+click, Delete clear, Ctrl+C copy)</name>
  <files>
    Views/Admin/KkjMatrix.cshtml
  </files>
  <action>
Add a custom selection model to `Views/Admin/KkjMatrix.cshtml`. The approach:

- Track `selectedCells` as an array of `{ tr, td, input, rowIdx, colIdx }` objects
- On `mousedown` on any `.kkj-edit-tbl td` (that contains an `input.edit-input`), start selection
- On `mousemove` with mouse held, extend the selection rectangle
- Use CSS class `cell-selected` for visual highlight

**CSS** — add to the `<style>` block:

```css
.cell-selected {
    background-color: rgba(13, 110, 253, 0.15) !important;
    outline: 1px solid rgba(13, 110, 253, 0.4);
}
```

**JS selection model** — add to the `@section Scripts` block (after existing JS, before closing `</script>`):

```javascript
// ========== MULTI-CELL SELECTION ==========
var selectedCells = [];
var isDragging = false;
var dragStartTd = null;

function getCellCoords(td) {
    // Returns { tbl, tbody, rowIdx, colIdx } for a given <td>
    var tr = td.parentElement;
    var tbody = tr.parentElement;
    var rowIdx = Array.from(tbody.rows).indexOf(tr);
    // colIdx: count only data-input tds (skip Aksi which has no input.edit-input)
    var allTds = Array.from(tr.cells);
    var colIdx = allTds.indexOf(td);
    return { tbody: tbody, rowIdx: rowIdx, colIdx: colIdx };
}

function getRangeCells(startTd, endTd) {
    // Returns all tds in the rectangular range between startTd and endTd
    // Both must be in the same .kkj-edit-tbl
    var tbl = startTd.closest('.kkj-edit-tbl');
    if (!tbl || startTd.closest('.kkj-edit-tbl') !== endTd.closest('.kkj-edit-tbl')) return [startTd];

    var startCoords = getCellCoords(startTd);
    var endCoords   = getCellCoords(endTd);

    var minRow = Math.min(startCoords.rowIdx, endCoords.rowIdx);
    var maxRow = Math.max(startCoords.rowIdx, endCoords.rowIdx);
    var minCol = Math.min(startCoords.colIdx, endCoords.colIdx);
    var maxCol = Math.max(startCoords.colIdx, endCoords.colIdx);

    var cells = [];
    var tbody = startCoords.tbody;
    for (var r = minRow; r <= maxRow; r++) {
        if (r >= tbody.rows.length) break;
        var tr = tbody.rows[r];
        var tds = Array.from(tr.cells);
        for (var c = minCol; c <= maxCol; c++) {
            if (c >= tds.length) break;
            var td = tds[c];
            // Only include cells that have an edit-input (skip Aksi column)
            if (td.querySelector('input.edit-input')) {
                cells.push(td);
            }
        }
    }
    return cells;
}

function applySelection(cells) {
    // Clear previous highlight
    document.querySelectorAll('.cell-selected').forEach(function(el) {
        el.classList.remove('cell-selected');
    });
    selectedCells = cells;
    cells.forEach(function(td) { td.classList.add('cell-selected'); });
}

// Mousedown: start selection on a data-input td
document.addEventListener('mousedown', function(e) {
    var td = e.target.closest('.kkj-edit-tbl td');
    if (!td || !td.querySelector('input.edit-input')) return;
    if (e.target.tagName === 'INPUT') return; // Let input handle its own click for caret

    isDragging = true;
    dragStartTd = td;

    if (e.shiftKey && selectedCells.length > 0) {
        // Extend selection from existing anchor
        var anchorTd = selectedCells[0];
        applySelection(getRangeCells(anchorTd, td));
    } else {
        applySelection([td]);
    }
    e.preventDefault(); // Prevent text selection on drag
});

// Mousemove: extend selection while dragging
document.addEventListener('mousemove', function(e) {
    if (!isDragging || !dragStartTd) return;
    var td = e.target.closest('.kkj-edit-tbl td');
    if (!td || !td.querySelector('input.edit-input')) return;
    applySelection(getRangeCells(dragStartTd, td));
});

// Mouseup: end drag
document.addEventListener('mouseup', function() {
    isDragging = false;
});

// Click on input inside a cell: select just that cell
document.addEventListener('click', function(e) {
    if (e.target.tagName !== 'INPUT' || !e.target.classList.contains('edit-input')) return;
    var td = e.target.closest('td');
    if (!td) return;
    if (e.shiftKey && selectedCells.length > 0) {
        applySelection(getRangeCells(selectedCells[0], td));
    } else if (!e.ctrlKey) {
        applySelection([td]);
    }
});

// Keydown: Delete clears selected cells; Ctrl+C copies; Tab/Enter navigation unchanged
document.addEventListener('keydown', function(e) {
    // Only act if we're in the edit context
    if (!document.getElementById('editTablesContainer') ||
        document.getElementById('editTablesContainer').classList.contains('d-none')) return;

    if (e.key === 'Delete' && selectedCells.length > 1) {
        // Multi-cell delete: clear all selected inputs
        e.preventDefault();
        selectedCells.forEach(function(td) {
            var inp = td.querySelector('input.edit-input');
            if (inp) inp.value = '';
        });
        return;
    }

    if ((e.ctrlKey || e.metaKey) && e.key === 'c' && selectedCells.length > 0) {
        // Ctrl+C: copy selected range as TSV
        e.preventDefault();
        var tbl = selectedCells[0].closest('.kkj-edit-tbl');
        var startCoords = getCellCoords(selectedCells[0]);
        var endCoords   = getCellCoords(selectedCells[selectedCells.length - 1]);
        var minRow = Math.min(startCoords.rowIdx, endCoords.rowIdx);
        var maxRow = Math.max(startCoords.rowIdx, endCoords.rowIdx);
        var minCol = Math.min(startCoords.colIdx, endCoords.colIdx);
        var maxCol = Math.max(startCoords.colIdx, endCoords.colIdx);

        var lines = [];
        var tbody = startCoords.tbody;
        for (var r = minRow; r <= maxRow; r++) {
            if (r >= tbody.rows.length) break;
            var tr = tbody.rows[r];
            var tds = Array.from(tr.cells);
            var cols = [];
            for (var c = minCol; c <= maxCol; c++) {
                if (c >= tds.length) break;
                var inp = tds[c].querySelector('input.edit-input');
                cols.push(inp ? inp.value : '');
            }
            lines.push(cols.join('\t'));
        }
        navigator.clipboard.writeText(lines.join('\n')).catch(function() {
            // Fallback for older browsers
            var ta = document.createElement('textarea');
            ta.value = lines.join('\n');
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
        });
        return;
    }

    if ((e.ctrlKey || e.metaKey) && e.key === 'v' && selectedCells.length > 0) {
        // Ctrl+V: paste to range starting from top-left selected cell
        // Allow the paste event handler to do the work — trigger paste
        // The existing paste handler on #editTablesContainer handles TSV paste
        // We only need to ensure the focused element is inside the selection anchor
        var anchorInput = selectedCells[0].querySelector('input.edit-input');
        if (anchorInput) anchorInput.focus();
        // Do NOT preventDefault — let the paste event fire normally
        return;
    }
});
```

Note: The existing TSV paste handler (from Plan 03, attached to `#editTablesContainer`) already handles multi-row paste from the focused cell position. When Ctrl+V fires, focusing the anchor input and letting the paste event propagate achieves paste-to-range naturally (it fills from the focused row downward).

**Clear selectedCells on edit mode cancel** — add to `btnCancel` handler:
```javascript
selectedCells = [];
document.querySelectorAll('.cell-selected').forEach(function(el) {
    el.classList.remove('cell-selected');
});
```
  </action>
  <verify>
    <automated>cd C:/Users/Administrator/Desktop/PortalHC_KPB && dotnet build --configuration Release 2>&1 | tail -5</automated>
  </verify>
  <done>Build passes 0 errors. In edit mode: clicking a data cell highlights it with blue tint. Dragging across cells highlights the range. Delete key clears all highlighted cell values. Ctrl+C copies the range as TSV text (verify by pasting into Notepad — should show tab-separated values). Ctrl+V pastes from the anchor cell downward using existing TSV paste handler.</done>
</task>

<task type="auto">
  <name>Task 2: Add Bootstrap Toast confirmation after Simpan success</name>
  <files>
    Views/Admin/KkjMatrix.cshtml
  </files>
  <action>
**2a. Add Toast HTML** — place a Bootstrap 5 toast markup immediately after the `@Html.AntiForgeryToken()` line (before the `<style>` block):

```html
<!-- Save success toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
    <div id="saveToast" class="toast align-items-center text-bg-success border-0" role="alert"
         aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi bi-check-circle-fill me-2"></i>Data berhasil disimpan.
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto"
                    data-bs-dismiss="toast" aria-label="Tutup"></button>
        </div>
    </div>
</div>
```

**2b. Update btnSave success callback** — in the `btnSave` AJAX `success` function, replace `location.reload()` with the toast-then-reload pattern. The save sequence (from Plan 03) calls `KkjBagianSave` then `KkjMatrixSave`. After the final KkjMatrixSave success:

```javascript
// Replace: location.reload();
// With:
var toastEl = document.getElementById('saveToast');
var toast = new bootstrap.Toast(toastEl, { delay: 1500 });
toast.show();
setTimeout(function() { location.reload(); }, 1700);
```

The 1700ms timeout (slightly longer than delay:1500) ensures the toast has time to fade out before the reload triggers.

Find the existing `location.reload()` call inside the `btnSave` AJAX success handler and apply this replacement. The success path is inside the chained AJAX pattern from Plan 03:
- First AJAX: KkjBagianSave — on success, triggers second AJAX
- Second AJAX: KkjMatrixSave — on success, previously called `location.reload()`

Replace only the final `location.reload()` in the KkjMatrixSave success callback with the toast pattern above.

Build to verify.
  </action>
  <verify>
    <automated>cd C:/Users/Administrator/Desktop/PortalHC_KPB && dotnet build --configuration Release 2>&1 | tail -5</automated>
  </verify>
  <done>Build passes 0 errors. After clicking Simpan with valid data: a green Bootstrap Toast "Data berhasil disimpan" appears in the bottom-right corner, then the page reloads ~1.7 seconds later. Toast is dismissible via its close button.</done>
</task>

</tasks>

<verification>
1. `dotnet build --configuration Release` — 0 errors
2. In edit mode, mousedown on a data cell (not inside the input) — cell gets blue highlight (`.cell-selected`)
3. Drag from one cell to another — rectangular range is highlighted
4. With range selected, press Delete — all selected input values cleared to empty
5. With range selected, press Ctrl+C — open Notepad and Ctrl+V — should see TSV data matching selected cells
6. Copy cells from Excel (Ctrl+C in Excel), click into a cell in edit table, Ctrl+V — data fills from that cell downward
7. Click Simpan with changes — green toast appears briefly, then page reloads showing saved data
</verification>

<success_criteria>
- `selectedCells` array tracks selected range
- mousedown/mousemove on `.kkj-edit-tbl td` cells (excluding Aksi) sets range with `.cell-selected` visual
- Shift+click extends selection from anchor
- Delete key clears values in all selected cells
- Ctrl+C copies selected range as TSV to clipboard
- Ctrl+V triggers existing paste handler from anchor cell
- Bootstrap Toast `#saveToast` appears on save success before page reload
- Toast delay is 1500ms, reload after 1700ms
</success_criteria>

<output>
After completion, create `.planning/phases/47-kkj-matrix-manager/47-05-SUMMARY.md`
</output>
