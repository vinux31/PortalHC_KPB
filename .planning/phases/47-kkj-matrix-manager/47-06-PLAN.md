---
phase: 47-kkj-matrix-manager
plan: "06"
type: execute
wave: 1
depends_on: []
files_modified:
  - Views/Admin/KkjMatrix.cshtml
autonomous: true
requirements: [MDAT-01]
gap_closure: true
must_haves:
  truths:
    - "Edit mode menampilkan semua baris data yang ada (kolom No, SkillGroup, SubSkillGroup, Indeks, Kompetensi, Target_* sebagai input fields) — baris dengan Bagian kosong muncul di bagian pertama"
    - "Simpan berhasil ketika hanya header kolom diubah (tidak ada baris) — tidak muncul error Tidak ada data yang diterima"
  artifacts:
    - path: "Views/Admin/KkjMatrix.cshtml"
      provides: "renderEditRows() with orphan inclusion + btnSave empty-rows guard"
      contains: "knownBagianNames"
  key_links:
    - from: "renderEditRows() forEach loop"
      to: "kkjItems array"
      via: "filter with orphan fallback on first bagian"
      pattern: "knownBagianNames"
    - from: "btnSave success callback"
      to: "KkjMatrixSave AJAX"
      via: "rows.length === 0 guard"
      pattern: "rows.length === 0"
---

<objective>
Fix two targeted JavaScript bugs in KkjMatrix.cshtml: (1) renderEditRows() orphan filter — items with Bagian='' never match any bagian name so zero rows render in every edit-mode tbody; (2) btnSave calls KkjMatrixSave unconditionally even when collectRows() returns [] which triggers the server-side "Tidak ada data yang diterima" error.

Purpose: Unblock edit-mode data visibility and header-only saves.
Output: KkjMatrix.cshtml with two targeted JS fixes — both issues resolved without touching controller or Razor HTML.
</objective>

<execution_context>
@C:/Users/Administrator/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Administrator/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/47-kkj-matrix-manager/47-03-SUMMARY.md
@.planning/phases/47-kkj-matrix-manager/47-04-SUMMARY.md
@.planning/phases/47-kkj-matrix-manager/47-05-SUMMARY.md
</context>

<interfaces>
<!-- Key contracts the executor needs. Extracted from KkjMatrix.cshtml. -->

renderEditRows() current filter (line ~299):
```javascript
var bagianItems = kkjItems.filter(function(i) { return i.Bagian === bagian.Name; });
```

kkjBagians shape (from JS var injection):
```javascript
// Array of objects: [{ Id, Name, DisplayOrder, Label_SectionHead, ... Label_HSE }]
var kkjBagians = @Html.Raw(bagiansJson ?? "[]");
```

btnSave relevant section (lines ~637-679):
```javascript
document.getElementById('btnSave').addEventListener('click', function() {
    var token = ...;
    var bagians = collectBagians();
    var rows = collectRows();
    // Step 1: Save bagian headers
    $.ajax({ url: '/Admin/KkjBagianSave', ...
        success: function(bagianResp) {
            if (!bagianResp.success) { alert(...); return; }
            // Step 2: Save row data  <-- ALWAYS fires, even when rows.length === 0
            $.ajax({ url: '/Admin/KkjMatrixSave', ...
                data: JSON.stringify(rows),
                success: function(rowResp) {
                    if (rowResp.success) { toast + reload; }
                    else { alert('Error menyimpan baris: ' + rowResp.message); }
                }
            });
        }
    });
});
```

AdminController.KkjMatrixSave guard:
```csharp
if (rows == null || !rows.Any())
    return Json(new { success = false, message = "Tidak ada data yang diterima." });
```
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Fix renderEditRows() to include orphan items in first bagian</name>
  <files>Views/Admin/KkjMatrix.cshtml</files>
  <action>
In renderEditRows(), before the kkjBagians.forEach loop, compute the set of all known bagian names:

```javascript
var knownBagianNames = kkjBagians.map(function(b) { return b.Name; });
```

Then replace the existing filter inside the forEach loop:
OLD (line ~299):
```javascript
var bagianItems = kkjItems.filter(function(i) { return i.Bagian === bagian.Name; });
```

NEW — Strategy A: first bagian also captures orphans (items with Bagian='' or Bagian not in any known bagian name). Use a loop counter to track whether we're processing the first bagian. The kkjBagians.forEach does not give a direct index, so convert it to use a for-loop or add an index variable before the forEach. Simplest approach: use an index variable:

```javascript
var isFirstBagian = (/* this is the first iteration */);
var bagianItems = kkjItems.filter(function(i) {
    if (i.Bagian === bagian.Name) return true;
    if (isFirstBagian && (i.Bagian === '' || i.Bagian === null || knownBagianNames.indexOf(i.Bagian) === -1)) return true;
    return false;
});
```

Implementation: replace the `kkjBagians.forEach(function(bagian) {` with a for-loop using an index variable `bagianIndex`, or add `var bagianIndex = 0;` before the forEach and increment at the end. Use whichever approach produces the least diff. The important constraint: orphan items (Bagian empty/null/unknown) appear in the FIRST bagian's tbody so the user can assign them by editing the hidden Bagian input.
  </action>
  <verify>dotnet build --configuration Release 2>&1 | tail -5</verify>
  <done>Build passes 0 errors. In renderEditRows(), knownBagianNames variable is declared. The filter for the first bagian includes items where i.Bagian is empty/null/unknown. Existing items with Bagian='' will now appear in the first bagian's edit-mode tbody.</done>
</task>

<task type="auto">
  <name>Task 2: Add rows.length guard in btnSave to skip KkjMatrixSave when no rows</name>
  <files>Views/Admin/KkjMatrix.cshtml</files>
  <action>
In the btnSave click handler, inside the KkjBagianSave success callback (after the `if (!bagianResp.success)` early-return block), add a guard before the KkjMatrixSave AJAX call:

```javascript
// After bagianResp.success check:
if (rows.length === 0) {
    // No row data to save — just show toast and reload
    var toastEl = document.getElementById('saveToast');
    var toast = new bootstrap.Toast(toastEl, { delay: 1500 });
    toast.show();
    setTimeout(function() { location.reload(); }, 1700);
    return;
}
// Step 2: Save row data (only when rows exist)
$.ajax({ url: '/Admin/KkjMatrixSave', ... });
```

This is a client-side guard only. Do NOT change AdminController.KkjMatrixSave. The toast + reload pattern is identical to the existing success path in KkjMatrixSave's success callback — copy it exactly.
  </action>
  <verify>dotnet build --configuration Release 2>&1 | tail -5</verify>
  <done>Build passes 0 errors. The pattern `rows.length === 0` appears in the btnSave handler. When collectRows() returns [], the KkjMatrixSave AJAX call is skipped and the success toast fires directly.</done>
</task>

</tasks>

<verification>
- dotnet build --configuration Release produces 0 errors
- grep "knownBagianNames" Views/Admin/KkjMatrix.cshtml shows the variable declaration
- grep "rows.length === 0" Views/Admin/KkjMatrix.cshtml shows the guard in btnSave
- grep "isFirstBagian\|bagianIndex" Views/Admin/KkjMatrix.cshtml shows the first-bagian tracking
</verification>

<success_criteria>
- Edit mode shows all existing KkjMatrixItem rows (including those with Bagian='') in the first bagian's table
- Clicking Simpan when only column headers are changed (no row edits) shows "Data berhasil disimpan" toast without error
- dotnet build --configuration Release passes with 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/47-kkj-matrix-manager/47-06-SUMMARY.md`
</output>
