---
phase: 47-kkj-matrix-manager
plan: "07"
type: execute
wave: 1
depends_on: []
files_modified:
  - Views/Admin/KkjMatrix.cshtml
  - Controllers/AdminController.cs
autonomous: true
requirements: [MDAT-01]
gap_closure: true
must_haves:
  truths:
    - "Read mode menampilkan satu tabel sesuai bagian yang dipilih di dropdown filter — bukan semua bagian sekaligus"
    - "Di sebelah kanan dropdown filter ada tombol Ubah Nama, Hapus, dan Tambah Bagian untuk CRUD bagian langsung dari read mode"
    - "Hapus bagian diblokir jika masih ada KkjMatrixItem yang di-assign ke bagian tersebut"
  artifacts:
    - path: "Views/Admin/KkjMatrix.cshtml"
      provides: "Dropdown filter + CRUD toolbar in read mode + renderReadTable() JS function + #readTablePanel div"
      contains: "renderReadTable"
    - path: "Controllers/AdminController.cs"
      provides: "KkjBagianDelete POST action with assignment guard"
      contains: "KkjBagianDelete"
  key_links:
    - from: "#bagianFilter select"
      to: "renderReadTable(bagianName)"
      via: "change event listener"
      pattern: "bagianFilter.*change"
    - from: "KkjBagianDelete POST"
      to: "_context.KkjMatrices.AnyAsync"
      via: "assignment guard before delete"
      pattern: "KkjBagianDelete"
---

<objective>
Restructure the KkjMatrix read-mode from static Razor multi-section rendering to a single JS-driven table panel with a bagian dropdown filter and CRUD controls (Ubah Nama, Hapus, Tambah Bagian). Also add the KkjBagianDelete POST action to AdminController with a guard that blocks deletion if any KkjMatrixItem is assigned to that bagian.

Purpose: Match the user's stated UX — one table at a time, filterable by bagian, with bagian CRUD in read mode.
Output: Replaced #readTable Razor block + new renderReadTable() JS + KkjBagianDelete controller action.
</objective>

<execution_context>
@C:/Users/Administrator/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Administrator/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/47-kkj-matrix-manager/47-03-SUMMARY.md
@.planning/phases/47-kkj-matrix-manager/47-04-SUMMARY.md
</context>

<interfaces>
<!-- Key contracts extracted from existing code. -->

Current read-mode Razor block (lines 134-283 of KkjMatrix.cshtml):
```razor
@* Read-mode: per-bagian grouped sections *@
<div id="readTable">
    @foreach (var bagian in bagians) { ... renders table per bagian ... }
    @if (unassignedItems.Any()) { ... renders Tidak Terkategori section ... }
</div>
```

JS data available at page load (lines 28-31):
```javascript
var kkjItems  = @Html.Raw(itemsJson);      // List<KkjMatrixItem> as JS array
var kkjBagians = @Html.Raw(bagiansJson ?? "[]");  // List<KkjBagian> as JS array
```

KkjBagian shape:
```javascript
{ Id, Name, DisplayOrder, Label_SectionHead, Label_SrSpv_GSH, Label_ShiftSpv_GSH,
  Label_Panelman_GSH_12_13, Label_Panelman_GSH_14, Label_Operator_GSH_8_11,
  Label_Operator_GSH_12_13, Label_ShiftSpv_ARU, Label_Panelman_ARU_12_13,
  Label_Panelman_ARU_14, Label_Operator_ARU_8_11, Label_Operator_ARU_12_13,
  Label_SrSpv_Facility, Label_JrAnalyst, Label_HSE }
```

KkjMatrixItem target fields (15 Target_* columns, matching label order):
```
Target_SectionHead, Target_SrSpv_GSH, Target_ShiftSpv_GSH,
Target_Panelman_GSH_12_13, Target_Panelman_GSH_14, Target_Operator_GSH_8_11,
Target_Operator_GSH_12_13, Target_ShiftSpv_ARU, Target_Panelman_ARU_12_13,
Target_Panelman_ARU_14, Target_Operator_ARU_8_11, Target_Operator_ARU_12_13,
Target_SrSpv_Facility, Target_JrAnalyst, Target_HSE
```

Existing controller actions (AdminController.cs):
- KkjBagianAdd POST: creates new bagian (lines 170-191)
- KkjBagianSave POST: upserts bagian headers (lines 120-168)
- KkjMatrixDelete POST: deletes item with usage guard (lines 193-219)
- Pattern for JSON response: return Json(new { success = true/false, message = "..." });
- Pattern for guard: check count > 0, return Json(new { success = false, blocked = true, message = "..." });

AntiForgery pattern used in existing AJAX calls:
```javascript
// Form-encoded (data: {}):
data: { __RequestVerificationToken: token }
// JSON body:
headers: { 'RequestVerificationToken': token }
```

deleteRow() read-mode function (existing, for reference):
```javascript
function deleteRow(id, kompetensi) {
    if (!confirm(...)) return;
    var token = document.querySelector('input[name="__RequestVerificationToken"]').value;
    $.ajax({ url: '/Admin/KkjMatrixDelete', type: 'POST',
        data: { id: id, __RequestVerificationToken: token },
        success: function(response) { ... }
    });
}
```
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Replace Razor read-mode block with dropdown toolbar + JS-rendered single panel</name>
  <files>Views/Admin/KkjMatrix.cshtml</files>
  <action>
Replace the entire `@* Read-mode: per-bagian grouped sections *@` block (the `<div id="readTable">...</div>` block, lines ~134-283) with this new structure:

```html
@* Read-mode: dropdown filter + bagian CRUD toolbar + single table panel *@
<div id="readTable">
    <div class="d-flex align-items-center gap-2 mb-3 flex-wrap">
        <label class="fw-semibold mb-0">Bagian:</label>
        <select id="bagianFilter" class="form-select form-select-sm" style="max-width:160px;">
            @foreach (var bagian in bagians)
            {
                <option value="@bagian.Name">@bagian.Name</option>
            }
        </select>
        <button id="btnRenameBagian" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-pencil me-1"></i>Ubah Nama
        </button>
        <button id="btnDeleteBagian" class="btn btn-outline-danger btn-sm">
            <i class="bi bi-trash me-1"></i>Hapus
        </button>
        <button id="btnAddBagianRead" class="btn btn-outline-success btn-sm">
            <i class="bi bi-plus-square me-1"></i>Tambah Bagian
        </button>
    </div>
    <div id="readTablePanel"></div>
</div>
```

Then add the following JavaScript functions and event wiring in the `@section Scripts { <script>` block, BEFORE the existing `// --- EDIT MODE RENDER ---` comment:

```javascript
// --- READ MODE RENDER ---
var labelFieldKeys = [
    { key:'Label_SectionHead',        prop:'Target_SectionHead'        },
    { key:'Label_SrSpv_GSH',          prop:'Target_SrSpv_GSH'          },
    { key:'Label_ShiftSpv_GSH',       prop:'Target_ShiftSpv_GSH'       },
    { key:'Label_Panelman_GSH_12_13', prop:'Target_Panelman_GSH_12_13' },
    { key:'Label_Panelman_GSH_14',    prop:'Target_Panelman_GSH_14'    },
    { key:'Label_Operator_GSH_8_11',  prop:'Target_Operator_GSH_8_11'  },
    { key:'Label_Operator_GSH_12_13', prop:'Target_Operator_GSH_12_13' },
    { key:'Label_ShiftSpv_ARU',       prop:'Target_ShiftSpv_ARU'       },
    { key:'Label_Panelman_ARU_12_13', prop:'Target_Panelman_ARU_12_13' },
    { key:'Label_Panelman_ARU_14',    prop:'Target_Panelman_ARU_14'    },
    { key:'Label_Operator_ARU_8_11',  prop:'Target_Operator_ARU_8_11'  },
    { key:'Label_Operator_ARU_12_13', prop:'Target_Operator_ARU_12_13' },
    { key:'Label_SrSpv_Facility',     prop:'Target_SrSpv_Facility'     },
    { key:'Label_JrAnalyst',          prop:'Target_JrAnalyst'          },
    { key:'Label_HSE',                prop:'Target_HSE'                },
];

function renderReadTable(bagianName) {
    var panel = document.getElementById('readTablePanel');
    if (!panel) return;

    var bagian = kkjBagians.find(function(b) { return b.Name === bagianName; });
    var knownNames = kkjBagians.map(function(b) { return b.Name; });

    // Items for selected bagian; if bagianName is '__unassigned__' show orphans
    var items;
    if (bagianName === '__unassigned__') {
        items = kkjItems.filter(function(i) {
            return !i.Bagian || knownNames.indexOf(i.Bagian) === -1;
        });
        bagian = null; // no bagian object for orphans
    } else {
        items = kkjItems.filter(function(i) { return i.Bagian === bagianName; });
    }
    items = items.slice().sort(function(a, b) { return (a.No || 0) - (b.No || 0); });

    // Build thead
    var theadCells = '<th style="width:45px;">No</th>'
        + '<th style="width:90px;">Indeks</th>'
        + '<th style="min-width:180px;">Kompetensi</th>'
        + '<th style="min-width:120px;">SkillGroup</th>'
        + '<th style="min-width:120px;">SubSkillGroup</th>';

    labelFieldKeys.forEach(function(lf) {
        var label = bagian ? (bagian[lf.key] || lf.key) : lf.key;
        theadCells += '<th class="col-target">' + escHtml(label) + '</th>';
    });
    theadCells += '<th style="width:70px;">Aksi</th>';

    // Build tbody rows
    var tbodyRows = '';
    if (items.length === 0) {
        tbodyRows = '<tr><td colspan="21" class="text-muted text-center">Belum ada item di bagian ini.</td></tr>';
    } else {
        items.forEach(function(item) {
            var tds = '<td>' + escHtml(item.No) + '</td>'
                + '<td>' + escHtml(item.Indeks) + '</td>'
                + '<td>' + escHtml(item.Kompetensi) + '</td>'
                + '<td>' + escHtml(item.SkillGroup) + '</td>'
                + '<td>' + escHtml(item.SubSkillGroup) + '</td>';
            labelFieldKeys.forEach(function(lf) {
                tds += '<td>' + escHtml(item[lf.prop]) + '</td>';
            });
            var safeKomp = escHtml(item.Kompetensi).replace(/'/g, "\\'");
            tds += '<td>'
                + '<button class="btn btn-outline-danger btn-sm" onclick="deleteRow(' + item.Id + ', \'' + safeKomp + '\')">'
                + '<i class="bi bi-trash"></i></button>'
                + '</td>';
            tbodyRows += '<tr data-id="' + item.Id + '">' + tds + '</tr>';
        });
    }

    panel.innerHTML = '<div class="table-responsive custom-scrollbar mb-3">'
        + '<table class="table table-sm table-bordered table-hover mb-0">'
        + '<thead class="table-dark"><tr>' + theadCells + '</tr></thead>'
        + '<tbody>' + tbodyRows + '</tbody>'
        + '</table></div>';
}

// Wire dropdown change
document.addEventListener('DOMContentLoaded', function() {
    var filter = document.getElementById('bagianFilter');
    if (filter) {
        filter.addEventListener('change', function() {
            renderReadTable(this.value);
        });
        // Initial render for first option
        if (filter.value) renderReadTable(filter.value);
    }
});

// Ubah Nama button
document.getElementById('btnRenameBagian').addEventListener('click', function() {
    var filter = document.getElementById('bagianFilter');
    var currentName = filter ? filter.value : '';
    if (!currentName) return;
    var newName = prompt('Nama baru untuk bagian "' + currentName + '":', currentName);
    if (!newName || newName.trim() === '' || newName.trim() === currentName) return;
    newName = newName.trim();
    var bagian = kkjBagians.find(function(b) { return b.Name === currentName; });
    if (!bagian) return;
    // Build bagian payload with new name, keeping all existing label values
    var payload = Object.assign({}, bagian, { Name: newName });
    var token = document.querySelector('input[name="__RequestVerificationToken"]').value;
    $.ajax({
        url: '/Admin/KkjBagianSave',
        type: 'POST',
        contentType: 'application/json',
        headers: { 'RequestVerificationToken': token },
        data: JSON.stringify([payload]),
        success: function(resp) {
            if (resp.success) {
                bagian.Name = newName;
                // Update kkjItems that had old bagian name
                kkjItems.forEach(function(i) { if (i.Bagian === currentName) i.Bagian = newName; });
                // Rebuild dropdown option
                var opt = filter.querySelector('option[value="' + currentName + '"]');
                if (opt) { opt.value = newName; opt.textContent = newName; }
                filter.value = newName;
                renderReadTable(newName);
            } else {
                alert('Error: ' + resp.message);
            }
        },
        error: function(xhr) { alert('Server error: ' + xhr.statusText); }
    });
});

// Hapus Bagian button
document.getElementById('btnDeleteBagian').addEventListener('click', function() {
    var filter = document.getElementById('bagianFilter');
    var currentName = filter ? filter.value : '';
    if (!currentName) return;
    var bagian = kkjBagians.find(function(b) { return b.Name === currentName; });
    if (!bagian) return;
    if (!confirm('Hapus bagian "' + currentName + '"? Bagian tidak dapat dihapus jika masih ada item yang di-assign ke bagian ini.')) return;
    var token = document.querySelector('input[name="__RequestVerificationToken"]').value;
    $.ajax({
        url: '/Admin/KkjBagianDelete',
        type: 'POST',
        data: { id: bagian.Id, __RequestVerificationToken: token },
        success: function(resp) {
            if (resp.success) {
                kkjBagians = kkjBagians.filter(function(b) { return b.Id !== bagian.Id; });
                var opt = filter.querySelector('option[value="' + currentName + '"]');
                if (opt) opt.remove();
                if (kkjBagians.length > 0) {
                    filter.value = kkjBagians[0].Name;
                    renderReadTable(kkjBagians[0].Name);
                } else {
                    document.getElementById('readTablePanel').innerHTML = '<p class="text-muted">Tidak ada bagian.</p>';
                }
            } else if (resp.blocked) {
                alert(resp.message);
            } else {
                alert('Error: ' + resp.message);
            }
        },
        error: function(xhr) { alert('Server error: ' + xhr.statusText); }
    });
});

// Tambah Bagian (read-mode) button — creates bagian via server then adds to dropdown + JS array
document.getElementById('btnAddBagianRead').addEventListener('click', function() {
    var token = document.querySelector('input[name="__RequestVerificationToken"]').value;
    $.ajax({
        url: '/Admin/KkjBagianAdd',
        type: 'POST',
        data: { __RequestVerificationToken: token },
        success: function(resp) {
            if (resp.success) {
                var newBagian = {
                    Id: resp.id, Name: resp.name, DisplayOrder: resp.displayOrder,
                    Label_SectionHead: 'Section Head', Label_SrSpv_GSH: 'Sr Spv GSH',
                    Label_ShiftSpv_GSH: 'Shift Spv GSH', Label_Panelman_GSH_12_13: 'Panelman GSH 12-13',
                    Label_Panelman_GSH_14: 'Panelman GSH 14', Label_Operator_GSH_8_11: 'Op GSH 8-11',
                    Label_Operator_GSH_12_13: 'Op GSH 12-13', Label_ShiftSpv_ARU: 'Shift Spv ARU',
                    Label_Panelman_ARU_12_13: 'Panelman ARU 12-13', Label_Panelman_ARU_14: 'Panelman ARU 14',
                    Label_Operator_ARU_8_11: 'Op ARU 8-11', Label_Operator_ARU_12_13: 'Op ARU 12-13',
                    Label_SrSpv_Facility: 'Sr Spv Facility', Label_JrAnalyst: 'Jr Analyst', Label_HSE: 'HSE'
                };
                kkjBagians.push(newBagian);
                var filter = document.getElementById('bagianFilter');
                var opt = document.createElement('option');
                opt.value = resp.name;
                opt.textContent = resp.name;
                filter.appendChild(opt);
                filter.value = resp.name;
                renderReadTable(resp.name);
            } else {
                alert('Error: ' + resp.message);
            }
        },
        error: function(xhr) { alert('Server error: ' + xhr.statusText); }
    });
});
```

NOTE: The existing edit-mode `#btnAddBagian` button in the header toolbar (for adding bagian while in edit mode) already exists and should remain unchanged. The new `#btnAddBagianRead` button is only visible in read mode — the existing `#readTable` div is hidden when entering edit mode, so there is no conflict.

Also update the `btnEdit` click handler: the existing code hides `#readTable` — this remains correct since the entire `#readTable` div (now containing the dropdown toolbar + panel) is hidden when edit mode activates.
  </action>
  <verify>dotnet build --configuration Release 2>&1 | tail -5</verify>
  <done>Build passes 0 errors. The #readTable div contains a dropdown (#bagianFilter), Ubah Nama / Hapus / Tambah Bagian buttons, and an empty #readTablePanel div. renderReadTable() function exists in the script block. The static Razor @foreach loop rendering per-bagian sections is removed.</done>
</task>

<task type="auto">
  <name>Task 2: Add KkjBagianDelete POST action to AdminController</name>
  <files>Controllers/AdminController.cs</files>
  <action>
Add a new POST action `KkjBagianDelete` to AdminController, after the existing `KkjBagianAdd` action (after line 191) and before `KkjMatrixDelete`. The action must:

1. Accept `int id` from form body (form-encoded POST, same as KkjMatrixDelete pattern)
2. Find the KkjBagian by id — return 404-style JSON if not found
3. Guard: count KkjMatrixItem records where `Bagian == bagian.Name` — if count > 0, return `{ success = false, blocked = true, message = "Tidak dapat dihapus — masih ada {count} item yang di-assign ke bagian ini." }`
4. If safe: remove the KkjBagian and SaveChangesAsync
5. Return `{ success = true }`

```csharp
// POST /Admin/KkjBagianDelete
[HttpPost]
[ValidateAntiForgeryToken]
public async Task<IActionResult> KkjBagianDelete(int id)
{
    var bagian = await _context.KkjBagians.FindAsync(id);
    if (bagian == null)
        return Json(new { success = false, message = "Bagian tidak ditemukan." });

    var assignedCount = await _context.KkjMatrices
        .CountAsync(k => k.Bagian == bagian.Name);

    if (assignedCount > 0)
        return Json(new { success = false, blocked = true,
            message = $"Tidak dapat dihapus — masih ada {assignedCount} item yang di-assign ke bagian ini." });

    _context.KkjBagians.Remove(bagian);
    await _context.SaveChangesAsync();

    return Json(new { success = true });
}
```

Insert this method between `KkjBagianAdd` and `KkjMatrixDelete` in the controller file.
  </action>
  <verify>dotnet build --configuration Release 2>&1 | tail -5</verify>
  <done>Build passes 0 errors. AdminController contains a KkjBagianDelete POST action with [HttpPost] and [ValidateAntiForgeryToken] attributes. The action checks KkjMatrices.CountAsync for assigned items before deleting.</done>
</task>

</tasks>

<verification>
- dotnet build --configuration Release produces 0 errors
- grep "renderReadTable" Views/Admin/KkjMatrix.cshtml shows function declaration and call
- grep "bagianFilter" Views/Admin/KkjMatrix.cshtml shows the dropdown element and change handler
- grep "KkjBagianDelete" Controllers/AdminController.cs shows the new POST action
- grep "assignedCount" Controllers/AdminController.cs shows the guard logic
- The static Razor @foreach rendering per-bagian read-mode sections is no longer in the view
</verification>

<success_criteria>
- Page loads and shows single table for first bagian in dropdown
- Changing dropdown re-renders table for selected bagian without page reload
- Ubah Nama prompts for new name and updates dropdown + table
- Tambah Bagian creates new bagian and adds it to dropdown
- Hapus Bagian blocked with message if items assigned; succeeds if bagian is empty
- dotnet build --configuration Release passes with 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/47-kkj-matrix-manager/47-07-SUMMARY.md`
</output>
