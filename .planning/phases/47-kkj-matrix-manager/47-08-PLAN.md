---
phase: 47-kkj-matrix-manager
plan: "08"
type: execute
wave: 1
depends_on: []
files_modified:
  - Views/Admin/KkjMatrix.cshtml
autonomous: true
requirements: [MDAT-01]
gap_closure: true

must_haves:
  truths:
    - "Multi-cell drag selection works — click+hold on a td and drag across adjacent tds highlights each td with .cell-selected"
    - "Edit mode dropdown filter shows only the selected bagian's table, matching the read-mode behavior"
  artifacts:
    - path: "Views/Admin/KkjMatrix.cshtml"
      provides: "Fixed mousedown guard + edit-mode bagian filter dropdown"
      contains: "editBagianFilter"
  key_links:
    - from: "document mousedown handler"
      to: "isDragging / applySelection"
      via: "remove INPUT guard so drag activates on every td click"
      pattern: "isDragging = true"
    - from: "renderEditRows() forEach"
      to: "div.edit-bagian-section[data-bagian-name]"
      via: "wrap each bagian block in a section div"
      pattern: "edit-bagian-section"
    - from: "#editBagianFilter change event"
      to: ".edit-bagian-section visibility"
      via: "hide all, show matching data-bagian-name"
      pattern: "editBagianFilter"
---

<objective>
Close two UAT-diagnosed JavaScript bugs in Views/Admin/KkjMatrix.cshtml — both are targeted JS-only edits with no controller or Razor HTML changes required.

Purpose: UAT tests 9 (multi-cell drag) and 5 (edit-mode single-bagian filter) failed. Tests 10-12 were skipped because test 9 was broken. Closing these gaps completes Phase 47.
Output: Working drag selection and single-bagian edit mode in KkjMatrix.cshtml.
</objective>

<execution_context>
@C:/Users/Administrator/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Administrator/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/47-kkj-matrix-manager/47-07-SUMMARY.md

<interfaces>
<!-- Key JS structures in KkjMatrix.cshtml -->
<!-- All line numbers reference current file state after 47-07 -->

Drag selection globals (approx line 880-895):
  var selectedCells = [];
  var isDragging = false;
  var dragStartTd = null;

mousedown handler (approx line 907-924):
  document.addEventListener('mousedown', function(e) {
      var td = e.target.closest('.kkj-edit-tbl td');
      if (!td || !td.querySelector('input.edit-input')) return;
      if (e.target.tagName === 'INPUT') return;   // <-- LINE TO DELETE (gap 1)
      isDragging = true;
      dragStartTd = td;
      ...
      e.preventDefault();
  });

renderEditRows() structure (approx line 368-482):
  function renderEditRows() {
      var container = document.getElementById('editTablesContainer');
      container.innerHTML = '';
      kkjBagians.forEach(function(bagian) {
          // heading div
          container.appendChild(heading);
          // tableWrapper > table.kkj-edit-tbl
          container.appendChild(tableWrapper);
          // addBtn
          container.appendChild(addBtn);
      });
  }

Edit mode HTML anchor (from Razor, exists in view):
  <div id="editTablesContainer"></div>
  <!-- editBagianFilter select does NOT exist yet — must be added by this plan -->

Read-mode bagian filter for reference (exists, approx line 200-210):
  <select id="bagianFilter" class="form-select form-select-sm" style="max-width:220px;">
  JS: document.getElementById('bagianFilter').addEventListener('change', function() { renderReadTable(this.value); });

collectRows() and collectBagians() query selectors (no changes needed):
  document.querySelectorAll('.bagian-tbody tr')       // all trs regardless of visibility
  document.querySelectorAll('.kkj-edit-tbl')          // all tables regardless of visibility
  -- hidden sections are still collected on save, so no save-logic changes needed
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete INPUT guard from mousedown handler</name>
  <files>Views/Admin/KkjMatrix.cshtml</files>
  <action>
Find the mousedown handler in the `<script>` section. It starts with:
  document.addEventListener('mousedown', function(e) {

Inside that handler, locate exactly this line:
  if (e.target.tagName === 'INPUT') return; // Let input handle its own click for caret

Delete that entire line (one line only). Do not change any other line in the handler.

Root cause: Every td in .kkj-edit-tbl contains a full-width input (CSS width:100%), so e.target is always INPUT. The guard permanently exits before isDragging=true is ever set, breaking all drag selection. Removing it allows the drag system to activate. e.preventDefault() on the last line of the handler already prevents unwanted caret/text-selection behavior.

After the edit the handler should read:
  document.addEventListener('mousedown', function(e) {
      var td = e.target.closest('.kkj-edit-tbl td');
      if (!td || !td.querySelector('input.edit-input')) return;
      isDragging = true;
      ...
      e.preventDefault();
  });
  </action>
  <verify>
    <automated>grep -n "tagName === 'INPUT'" "C:/Users/Administrator/Desktop/PortalHC_KPB/Views/Admin/KkjMatrix.cshtml" | wc -l</automated>
    Expected output: 0 (line no longer present)
  </verify>
  <done>The guard line `if (e.target.tagName === 'INPUT') return;` is absent from the file. The mousedown handler still contains isDragging = true and e.preventDefault().</done>
</task>

<task type="auto">
  <name>Task 2: Add editBagianFilter dropdown and single-bagian show/hide to renderEditRows()</name>
  <files>Views/Admin/KkjMatrix.cshtml</files>
  <action>
Make three targeted changes inside the `renderEditRows()` function and the edit-mode initialization path:

**Change A — Wrap each bagian block in a section div inside the forEach.**

Inside `kkjBagians.forEach(function(bagian) { ... })`, before appending `heading`, create a wrapper div:

  var sectionDiv = document.createElement('div');
  sectionDiv.className = 'edit-bagian-section';
  sectionDiv.dataset.bagianName = bagian.Name;

Then append `heading`, `tableWrapper`, and `addBtn` to `sectionDiv` (not to `container`). Finally append `sectionDiv` to `container`. The forEach body should now end with:

  sectionDiv.appendChild(heading);
  sectionDiv.appendChild(tableWrapper);
  sectionDiv.appendChild(addBtn);
  container.appendChild(sectionDiv);

**Change B — Inject the editBagianFilter select ABOVE the container before the forEach loop.**

At the top of `renderEditRows()`, after `container.innerHTML = ''`, add:

  // Build/update the editBagianFilter dropdown
  var filterBar = document.getElementById('editBagianFilterBar');
  if (!filterBar) {
      filterBar = document.createElement('div');
      filterBar.id = 'editBagianFilterBar';
      filterBar.className = 'd-flex align-items-center gap-2 mb-2';
      filterBar.innerHTML = '<label class="fw-bold text-primary mb-0">Bagian:</label>'
          + '<select id="editBagianFilter" class="form-select form-select-sm" style="max-width:220px;"></select>';
      container.parentNode.insertBefore(filterBar, container);
  }
  var editBagianFilter = document.getElementById('editBagianFilter');
  editBagianFilter.innerHTML = '';
  kkjBagians.forEach(function(b) {
      var opt = document.createElement('option');
      opt.value = b.Name;
      opt.textContent = b.Name;
      editBagianFilter.appendChild(opt);
  });

**Change C — Wire change event and apply initial selection.**

After the forEach loop (after all sectionDivs are appended), add:

  // Show only selected bagian section
  function showEditBagian(name) {
      document.querySelectorAll('.edit-bagian-section').forEach(function(sec) {
          sec.style.display = sec.dataset.bagianName === name ? '' : 'none';
      });
  }

  // Re-wire change event (avoid duplicate listeners by replacing select)
  var oldFilter = document.getElementById('editBagianFilter');
  var newFilter = oldFilter.cloneNode(true);
  oldFilter.parentNode.replaceChild(newFilter, oldFilter);
  newFilter.addEventListener('change', function() { showEditBagian(this.value); });

  // Show first bagian on initial render
  if (kkjBagians.length > 0) {
      newFilter.value = kkjBagians[0].Name;
      showEditBagian(kkjBagians[0].Name);
  }

Important: collectRows() queries `document.querySelectorAll('.bagian-tbody tr')` and collectBagians() queries `document.querySelectorAll('.kkj-edit-tbl')` — both collect ALL sections regardless of display:none. Do NOT change those collector functions.
  </action>
  <verify>
    <automated>grep -n "edit-bagian-section\|editBagianFilter\|showEditBagian" "C:/Users/Administrator/Desktop/PortalHC_KPB/Views/Admin/KkjMatrix.cshtml"</automated>
    Expected: lines containing 'edit-bagian-section', 'editBagianFilter', and 'showEditBagian' all present.
  </verify>
  <done>renderEditRows() wraps each bagian in div.edit-bagian-section[data-bagian-name], inserts #editBagianFilter select above the container, wires change to showEditBagian(), and shows only the first bagian on initial render. The section divs for non-selected bagians have display:none but are still in the DOM so save collectors work unchanged.</done>
</task>

</tasks>

<verification>
1. Build passes: `dotnet build` exits 0.
2. Drag guard absent: `grep -c "tagName === 'INPUT'" Views/Admin/KkjMatrix.cshtml` returns 0.
3. Dropdown present: `grep -c "editBagianFilter" Views/Admin/KkjMatrix.cshtml` returns >= 3.
4. Section wrapper present: `grep -c "edit-bagian-section" Views/Admin/KkjMatrix.cshtml` returns >= 2.
</verification>

<success_criteria>
- Mousedown guard line deleted — drag selection can now activate on td click even when e.target is an INPUT.
- renderEditRows() wraps each bagian in a named section div, adds editBagianFilter dropdown, shows only selected bagian.
- dotnet build exits with 0 errors.
- collectRows() and collectBagians() unchanged — save still collects all bagians regardless of visibility.
</success_criteria>

<output>
After completion, create `.planning/phases/47-kkj-matrix-manager/47-08-SUMMARY.md` using the summary template.
</output>
