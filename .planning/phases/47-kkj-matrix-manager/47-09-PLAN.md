---
phase: 47-kkj-matrix-manager
plan: 09
type: execute
wave: 1
depends_on: []
files_modified:
  - Views/Admin/KkjMatrix.cshtml
autonomous: true
requirements:
  - MDAT-01
gap_closure: true
must_haves:
  truths:
    - "User dapat copy range dari Excel dan paste ke edit mode KkjMatrix mulai dari anchor sel yang dipilih"
    - "Ctrl+V menempelkan data ke sel yang benar tanpa memerlukan manual click untuk fokus"
  artifacts:
    - path: "Views/Admin/KkjMatrix.cshtml"
      provides: "Paste handler yang menggunakan selectedCells[0] sebagai anchor dan Ctrl+V handler yang menggunakan navigator.clipboard.readText()"
      contains: "navigator.clipboard.readText"
  key_links:
    - from: "mousedown handler (line ~967)"
      to: "input.edit-input di anchor td"
      via: "anchorInput.focus() after applySelection()"
      pattern: "anchorInput\\.focus\\(\\)"
    - from: "Ctrl+V keydown handler (line ~1048)"
      to: "paste logic"
      via: "navigator.clipboard.readText() — decoupled from focus state"
      pattern: "navigator\\.clipboard\\.readText"
    - from: "paste event handler (line ~847)"
      to: "selectedCells[0]"
      via: "selectedCells[0].closest('tr') instead of document.activeElement"
      pattern: "selectedCells\\[0\\]"
---

<objective>
Fix Ctrl+V paste dari Excel ke edit mode KkjMatrix.

Tiga bug terdiagnosis menyebabkan Ctrl+V diam tanpa efek:
1. mousedown `e.preventDefault()` memblokir input mendapat fokus, sehingga `document.activeElement` tetap di `body`
2. Ctrl+V keydown handler memanggil `anchorInput.focus()` lalu return — browser sudah merutekan paste event ke elemen yang fokus SAAT keydown (body), bukan setelah `.focus()`
3. Paste handler memakai `document.activeElement.closest('tr')` sebagai anchor row — karena activeElement adalah body, bukan input, anchor row selalu null/fallback ke akhir tbody

Semua tiga harus diperbaiki bersamaan — memperbaiki salah satu saja tidak cukup.

Purpose: Menyelesaikan gap UAT round 3 Test 5 (Ctrl+V paste dari Excel).
Output: Views/Admin/KkjMatrix.cshtml dengan paste yang berfungsi penuh.
</objective>

<execution_context>
@C:/Users/Administrator/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Administrator/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/47-kkj-matrix-manager/47-UAT-r3.md
@.planning/ROADMAP.md
@.planning/STATE.md

<interfaces>
<!-- Three specific code sections to fix. Executor edits ONLY these sections. -->

CURRENT CODE — mousedown handler (line ~953-968):
```javascript
document.addEventListener('mousedown', function(e) {
    var td = e.target.closest('.kkj-edit-tbl td');
    if (!td || !td.querySelector('input.edit-input')) return;

    isDragging = true;
    dragStartTd = td;

    if (e.shiftKey && selectedCells.length > 0) {
        var anchorTd = selectedCells[0];
        applySelection(getRangeCells(anchorTd, td));
    } else {
        applySelection([td]);
    }
    e.preventDefault(); // Prevent text selection on drag
});
```

CURRENT CODE — paste handler anchor (lines ~846-848):
```javascript
var tbody = targetTbl.querySelector('.bagian-tbody');
var focusedRow = document.activeElement ? document.activeElement.closest('tr') : null;
var startIdx = (focusedRow && tbody.contains(focusedRow)) ? Array.from(tbody.rows).indexOf(focusedRow) : tbody.rows.length;
```

CURRENT CODE — Ctrl+V keydown handler (lines ~1048-1056):
```javascript
if ((e.ctrlKey || e.metaKey) && e.key === 'v' && selectedCells.length > 0) {
    // Ctrl+V: paste to range starting from top-left selected cell
    // The existing paste handler on #editTablesContainer handles TSV paste
    // We only need to ensure the focused element is inside the selection anchor
    var anchorInput = selectedCells[0].querySelector('input.edit-input');
    if (anchorInput) anchorInput.focus();
    // Do NOT preventDefault — let the paste event fire normally
    return;
}
```

ROOT CAUSE (dari 47-UAT-r3.md):
- e.preventDefault() di mousedown mencegah input mendapat fokus
- Ctrl+V handler memanggil focus() tapi return — paste event sudah diroute ke body sebelum focus() berlaku
- paste handler guard `e.target.closest('.kkj-edit-tbl')` menolak event dari body → silent failure
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix mousedown focus + Ctrl+V handler + paste anchor</name>
  <files>Views/Admin/KkjMatrix.cshtml</files>
  <action>
Buat tiga perubahan targeted di Views/Admin/KkjMatrix.cshtml. Jangan ubah kode lain di luar tiga section ini.

**Perubahan 1 — mousedown handler: tambah focus setelah applySelection()**

Setelah setiap panggilan applySelection(), tambahkan fokus ke anchor input agar document.activeElement menjadi input yang valid.

Ganti blok mousedown (sekitar line 953-968):
```javascript
document.addEventListener('mousedown', function(e) {
    var td = e.target.closest('.kkj-edit-tbl td');
    if (!td || !td.querySelector('input.edit-input')) return;

    isDragging = true;
    dragStartTd = td;

    if (e.shiftKey && selectedCells.length > 0) {
        var anchorTd = selectedCells[0];
        applySelection(getRangeCells(anchorTd, td));
    } else {
        applySelection([td]);
    }
    e.preventDefault(); // Prevent text selection on drag
});
```

Dengan:
```javascript
document.addEventListener('mousedown', function(e) {
    var td = e.target.closest('.kkj-edit-tbl td');
    if (!td || !td.querySelector('input.edit-input')) return;

    isDragging = true;
    dragStartTd = td;

    if (e.shiftKey && selectedCells.length > 0) {
        var anchorTd = selectedCells[0];
        applySelection(getRangeCells(anchorTd, td));
    } else {
        applySelection([td]);
    }
    e.preventDefault(); // Prevent text selection on drag
    // Focus anchor input so document.activeElement is a valid edit-input for paste routing
    var anchorInput = selectedCells[0] && selectedCells[0].querySelector('input.edit-input');
    if (anchorInput) anchorInput.focus();
});
```

**Perubahan 2 — paste handler: ganti document.activeElement dengan selectedCells[0]**

Ganti dua baris anchor detection (sekitar line 847-848):
```javascript
var focusedRow = document.activeElement ? document.activeElement.closest('tr') : null;
var startIdx = (focusedRow && tbody.contains(focusedRow)) ? Array.from(tbody.rows).indexOf(focusedRow) : tbody.rows.length;
```

Dengan:
```javascript
// Use selectedCells[0] as anchor (document.activeElement may be body due to e.preventDefault in mousedown)
var anchorTd = (selectedCells && selectedCells.length > 0) ? selectedCells[0] : null;
var anchorRow = anchorTd ? anchorTd.closest('tr') : null;
var startIdx = (anchorRow && tbody.contains(anchorRow)) ? Array.from(tbody.rows).indexOf(anchorRow) : tbody.rows.length;
```

**Perubahan 3 — Ctrl+V keydown handler: gunakan navigator.clipboard.readText()**

Ganti seluruh blok Ctrl+V (sekitar line 1048-1056):
```javascript
if ((e.ctrlKey || e.metaKey) && e.key === 'v' && selectedCells.length > 0) {
    // Ctrl+V: paste to range starting from top-left selected cell
    // The existing paste handler on #editTablesContainer handles TSV paste
    // We only need to ensure the focused element is inside the selection anchor
    var anchorInput = selectedCells[0].querySelector('input.edit-input');
    if (anchorInput) anchorInput.focus();
    // Do NOT preventDefault — let the paste event fire normally
    return;
}
```

Dengan:
```javascript
if ((e.ctrlKey || e.metaKey) && e.key === 'v' && selectedCells.length > 0) {
    // Ctrl+V: read clipboard directly — decoupled from focus/activeElement state
    // Cannot rely on native paste event routing because e.preventDefault() in mousedown
    // causes document.activeElement to be body, not an edit-input inside .kkj-edit-tbl
    e.preventDefault();
    navigator.clipboard.readText().then(function(text) {
        if (!text) return;
        var anchorTd = selectedCells[0];
        var targetTbl = anchorTd.closest('.kkj-edit-tbl');
        if (!targetTbl) return;
        var tbody = targetTbl.querySelector('.bagian-tbody');
        if (!tbody) return;
        var anchorRow = anchorTd.closest('tr');
        var startIdx = (anchorRow && tbody.contains(anchorRow)) ? Array.from(tbody.rows).indexOf(anchorRow) : 0;
        if (startIdx < 0) startIdx = 0;

        var colNames = [
            'No','SkillGroup','SubSkillGroup','Indeks','Kompetensi',
            'Target_SectionHead','Target_SrSpv_GSH','Target_ShiftSpv_GSH',
            'Target_Panelman_GSH_12_13','Target_Panelman_GSH_14',
            'Target_Operator_GSH_8_11','Target_Operator_GSH_12_13',
            'Target_ShiftSpv_ARU','Target_Panelman_ARU_12_13',
            'Target_Panelman_ARU_14','Target_Operator_ARU_8_11',
            'Target_Operator_ARU_12_13','Target_SrSpv_Facility',
            'Target_JrAnalyst','Target_HSE'
        ];

        // Determine start column from anchor td position
        var anchorAllTds = Array.from(anchorTd.parentElement.cells);
        var anchorColIdx = anchorAllTds.indexOf(anchorTd);

        var pastedRows = text.trim().split('\n');
        pastedRows.forEach(function(rowText, pasteRowIdx) {
            var cols = rowText.split('\t');
            var targetRowIdx = startIdx + pasteRowIdx;
            var tr;
            if (targetRowIdx < tbody.rows.length) {
                tr = tbody.rows[targetRowIdx];
            } else {
                tr = makeEmptyRow();
                tr.querySelector('input[name="Bagian"]').value = tbody.dataset.bagianName || '';
                tbody.appendChild(tr);
            }
            cols.forEach(function(cellVal, colOffset) {
                var colIdx = anchorColIdx + colOffset;
                if (colIdx >= anchorAllTds.length) return;
                var colName = colNames[colIdx];
                if (!colName) return;
                var input = tr.querySelector('[name="' + colName + '"]');
                if (input) input.value = cellVal.trim();
            });
        });
    }).catch(function(err) {
        console.warn('Clipboard read failed:', err);
    });
    return;
}
```

Catatan penting untuk Perubahan 3:
- navigator.clipboard.readText() adalah async — semua logika paste ada di dalam .then() callback
- anchorColIdx menentukan kolom mulai paste (tidak selalu kolom 0) sesuai sel anchor yang dipilih
- makeEmptyRow() sudah ada di file — tidak perlu tambah fungsi baru
- colNames array sama persis dengan yang ada di native paste handler (jangan ubah urutan)
  </action>
  <verify>
Buka browser, masuk ke /Admin/KkjMatrix, klik Ubah Data:
1. Klik satu sel (misal kolom SkillGroup di baris pertama) — sel biru ter-highlight
2. Buka Excel, ketik 2 nilai di 2 cell sejajar horizontal (A1="TestA", B1="TestB"), select kedua cell, Ctrl+C
3. Klik kembali ke sel anchor di KkjMatrix, tekan Ctrl+V
4. Nilai "TestA" muncul di sel anchor, "TestB" muncul di sel berikutnya ke kanan
5. Drag selection (klik+tahan beberapa sel) masih berfungsi untuk multi-cell selection
  </verify>
  <done>Ctrl+V dari Excel mengisi sel mulai dari anchor yang dipilih ke kanan/bawah. Drag selection tetap berfungsi. Tidak ada regresi pada Delete, Ctrl+C, atau Simpan.</done>
</task>

</tasks>

<verification>
Test manual via browser di /Admin/KkjMatrix:
- Ctrl+V single cell dari Excel: paste di anchor sel yang dipilih
- Ctrl+V 2x2 range dari Excel: paste benar di kanan-bawah dari anchor
- Drag selection: klik+tahan+drag masih highlight sel biru (tidak rusak oleh fix)
- Delete range: multi-select lalu Delete masih clear semua sel terpilih
- Ctrl+C: copy range lalu paste ke Notepad mengeluarkan TSV yang benar
- Simpan: setelah edit via paste, klik Simpan → toast hijau → data tersimpan di reload
</verification>

<success_criteria>
- Test UAT-r3 Test 5 (Ctrl+V paste dari Excel) menunjukkan hasil PASS
- Tidak ada regresi pada Test 1 (drag), Test 3 (Delete), Test 4 (Ctrl+C), Test 6 (save semua bagian)
</success_criteria>

<output>
Setelah selesai, buat `.planning/phases/47-kkj-matrix-manager/47-09-SUMMARY.md` dengan hasil eksekusi.
</output>
