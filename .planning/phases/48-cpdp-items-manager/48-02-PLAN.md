---
index: 2
wave: 2
title: "Edit mode table, bulk-save POST, delete-with-guard POST, CMP/Mapping dropdown update"
depends_on:
  - 48-01-PLAN.md
files_modified:
  - Controllers/AdminController.cs
  - Views/Admin/CpdpItems.cshtml
  - Views/CMP/MappingSectionSelect.cshtml
autonomous: true
requirements:
  - MDAT-02
---

## Objective

Wire up the edit mode and all write operations for the KKJ-IDP Mapping Editor:
1. Edit-mode table inside `#editTableWrapper` (all 6 data columns + Aksi, horizontal scroll)
2. `CpdpItemsSave` POST — bulk upsert with audit log + Bootstrap Toast, page reload after success
3. `CpdpItemDelete` POST — delete with IdpItem.Kompetensi reference guard + audit log
4. Update `Views/CMP/MappingSectionSelect.cshtml` to use a dropdown instead of card selection (consistent UX with the admin editor)

Plan 03 adds multi-cell selection and Excel export on top of this.

## Context

@Controllers/AdminController.cs — add CpdpItemsSave + CpdpItemDelete actions (pattern: KkjMatrixSave + KkjMatrixDelete)
@Views/Admin/CpdpItems.cshtml — add edit-mode table to #editTableWrapper, wire btnEdit/btnSave/btnCancel JS
@Models/KkjModels.cs — CpdpItem has: Id, No (string), NamaKompetensi, IndikatorPerilaku, DetailIndikator, Silabus, TargetDeliverable, Status, Section
@Views/Admin/KkjMatrix.cshtml — reference for edit-mode table structure, makeRow() JS function, insert-below and delete-row patterns, sticky columns CSS
@Data/ApplicationDbContext.cs — DbSet<CpdpItem> CpdpItems; DbSet<IdpItem> IdpItems (for delete guard)

## Tasks

<task id="48-02-T1" type="auto" wave="1">
  <title>Add CpdpItemsSave and CpdpItemDelete actions to AdminController</title>
  <files>
    - Controllers/AdminController.cs
  </files>
  <action>
Add two new actions to AdminController after the existing `CpdpItems()` GET action.

**Action 1: CpdpItemsSave**
```csharp
// POST /Admin/CpdpItemsSave
[HttpPost]
[ValidateAntiForgeryToken]
public async Task<IActionResult> CpdpItemsSave([FromBody] List<CpdpItem> rows)
{
    if (rows == null || !rows.Any())
        return Json(new { success = false, message = "Tidak ada data yang diterima." });

    try
    {
        foreach (var row in rows)
        {
            if (row.Id == 0)
            {
                _context.CpdpItems.Add(row);
            }
            else
            {
                var existing = await _context.CpdpItems.FindAsync(row.Id);
                if (existing != null)
                {
                    // Warn if NamaKompetensi changed and IdpItems reference the old name
                    if (existing.NamaKompetensi != row.NamaKompetensi)
                    {
                        var refCount = await _context.IdpItems
                            .CountAsync(i => i.Kompetensi == existing.NamaKompetensi);
                        if (refCount > 0)
                            return Json(new { success = false,
                                message = $"Tidak bisa ubah NamaKompetensi '{existing.NamaKompetensi}' — {refCount} IDP record masih mereferensi nama ini." });
                    }

                    existing.No                 = row.No ?? "";
                    existing.NamaKompetensi     = row.NamaKompetensi ?? "";
                    existing.IndikatorPerilaku  = row.IndikatorPerilaku ?? "";
                    existing.DetailIndikator    = row.DetailIndikator ?? "";
                    existing.Silabus            = row.Silabus ?? "";
                    existing.TargetDeliverable  = row.TargetDeliverable ?? "";
                    existing.Status             = row.Status ?? "";
                    existing.Section            = row.Section ?? "";
                }
            }
        }

        await _context.SaveChangesAsync();

        var actor = await _userManager.GetUserAsync(User);
        if (actor != null)
            await _auditLog.LogAsync(actor.Id, actor.FullName, "BulkUpdate",
                $"CPDP Items bulk-save: {rows.Count} rows", targetType: "CpdpItem");

        return Json(new { success = true, message = $"{rows.Count} baris berhasil disimpan." });
    }
    catch (Exception ex)
    {
        return Json(new { success = false, message = ex.Message });
    }
}
```

**Action 2: CpdpItemDelete**
```csharp
// POST /Admin/CpdpItemDelete
[HttpPost]
[ValidateAntiForgeryToken]
public async Task<IActionResult> CpdpItemDelete(int id)
{
    var item = await _context.CpdpItems.FindAsync(id);
    if (item == null)
        return Json(new { success = false, message = "CPDP item tidak ditemukan." });

    // Reference guard: check IdpItem records that match by NamaKompetensi string
    var usageCount = await _context.IdpItems
        .CountAsync(i => i.Kompetensi == item.NamaKompetensi);

    if (usageCount > 0)
        return Json(new { success = false, blocked = true,
            message = $"Tidak dapat dihapus — digunakan oleh {usageCount} IDP record." });

    _context.CpdpItems.Remove(item);
    await _context.SaveChangesAsync();

    var actor = await _userManager.GetUserAsync(User);
    if (actor != null)
        await _auditLog.LogAsync(actor.Id, actor.FullName, "Delete",
            $"Deleted CpdpItem Id={id} ({item.NamaKompetensi})",
            targetId: id, targetType: "CpdpItem");

    return Json(new { success = true });
}
```

**Important:** Check that `_context.IdpItems` exists in ApplicationDbContext. If the DbSet is named differently (e.g., `IdpItems`), use the correct name. Search for `IdpItem` in ApplicationDbContext.cs to confirm the DbSet name before writing code.
  </action>
  <verify>
    <automated>dotnet build HcPortal.csproj --no-restore 2>&1 | tail -5</automated>
  </verify>
  <done>Build succeeds. Both POST endpoints are defined and routable at /Admin/CpdpItemsSave and /Admin/CpdpItemDelete.</done>
</task>

<task id="48-02-T2" type="auto" wave="2">
  <title>Add edit-mode table and JS to Views/Admin/CpdpItems.cshtml</title>
  <files>
    - Views/Admin/CpdpItems.cshtml
  </files>
  <action>
Modify `Views/Admin/CpdpItems.cshtml` to add edit-mode table inside `#editTableWrapper` and wire all interactive JS.

**Step 1: Add CSS for edit mode** — add to the existing `<style>` block:
```css
.edit-input { border: 1px solid #ced4da; border-radius: 4px; padding: 2px 4px; font-size: 0.78rem; width: 100%; min-width: 60px; }
.edit-input:focus { outline: none; border-color: #0d6efd; box-shadow: 0 0 0 2px rgba(13,110,253,0.15); }
.cpdp-edit-tbl td:nth-child(1), .cpdp-edit-tbl th:nth-child(1) { position: sticky; left: 0; background: white; z-index: 5; border-right: 1px solid #dee2e6; min-width: 60px; }
.cpdp-edit-tbl td:nth-child(2), .cpdp-edit-tbl th:nth-child(2) { position: sticky; left: 62px; background: white; z-index: 5; border-right: 1px solid #dee2e6; min-width: 140px; }
.cpdp-edit-tbl thead th { position: sticky; top: 0; background: #343a40; color: white; z-index: 10; }
.cpdp-edit-tbl thead th:nth-child(1), .cpdp-edit-tbl thead th:nth-child(2) { z-index: 15; }
.col-no-edit { min-width: 60px; } .col-nama { min-width: 140px; } .col-indikator { min-width: 120px; }
.col-detail { min-width: 200px; } .col-silabus { min-width: 200px; } .col-target { min-width: 200px; }
.col-aksi { min-width: 80px; }
.custom-scrollbar::-webkit-scrollbar { height: 10px; width: 10px; }
.custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
```

**Step 2: Replace `#editTableWrapper` placeholder** with the actual edit-mode table HTML:
```html
<div id="editTableWrapper" class="d-none">
  <div class="table-responsive custom-scrollbar" style="max-height: 75vh; overflow-x: auto; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px;">
    <table id="editTable" class="table table-sm table-bordered cpdp-edit-tbl mb-0">
      <thead>
        <tr>
          <th class="col-no-edit">No</th>
          <th class="col-nama">Nama Kompetensi</th>
          <th class="col-indikator">Indikator Perilaku</th>
          <th class="col-detail">Detail Indikator</th>
          <th class="col-silabus">Silabus / IDP</th>
          <th class="col-target">Target Deliverable</th>
          <th class="col-aksi">Aksi</th>
        </tr>
      </thead>
      <tbody id="editTbody">
        @foreach (var item in Model)
        {
          <tr data-id="@item.Id" data-section="@item.Section">
            <td><input type="text" name="No" value="@item.No" class="edit-input" /></td>
            <td><input type="text" name="NamaKompetensi" value="@Html.AttributeEncode(item.NamaKompetensi)" class="edit-input" /></td>
            <td><input type="text" name="IndikatorPerilaku" value="@Html.AttributeEncode(item.IndikatorPerilaku)" class="edit-input" /></td>
            <td><input type="text" name="DetailIndikator" value="@Html.AttributeEncode(item.DetailIndikator)" class="edit-input" /></td>
            <td><input type="text" name="Silabus" value="@Html.AttributeEncode(item.Silabus)" class="edit-input" /></td>
            <td><input type="text" name="TargetDeliverable" value="@Html.AttributeEncode(item.TargetDeliverable)" class="edit-input" /></td>
            <td>
              <input type="hidden" name="Status" value="@item.Status" />
              <input type="hidden" name="Section" value="@item.Section" />
              <button type="button" class="btn btn-sm btn-outline-secondary insert-below-btn me-1" title="Sisipkan baris bawah"><i class="bi bi-plus-circle"></i></button>
              <button type="button" class="btn btn-sm btn-outline-danger delete-row-btn" title="Hapus baris"><i class="bi bi-trash"></i></button>
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>
</div>
```

**Step 3: Add JavaScript** — replace or extend the existing `<script>` block with the following complete script. Place all JS at the bottom of the file before closing `</div>` tags.

```javascript
// ── Edit/Read mode toggle ──────────────────────────────────────────────
document.getElementById('btnEdit').addEventListener('click', function() {
    document.getElementById('readTableWrapper').classList.add('d-none');
    document.getElementById('editTableWrapper').classList.remove('d-none');
    document.getElementById('readActions').classList.add('d-none');
    document.getElementById('editActions').classList.remove('d-none');
    filterTables();  // apply current section filter to edit table
});

document.getElementById('btnCancel').addEventListener('click', function() {
    if (!confirm('Batalkan semua perubahan?')) return;
    location.reload();
});

document.getElementById('btnSave').addEventListener('click', function() { saveAllRows(); });

// ── Section filter ─────────────────────────────────────────────────────
var currentSection = '';
document.getElementById('sectionFilter').addEventListener('change', function(e) {
    currentSection = e.target.value;
    document.getElementById('selectedSection').value = currentSection;
    filterTables();
});

function filterTables() {
    var allRows = document.querySelectorAll('#readTableWrapper tbody tr, #editTable tbody tr');
    var visible = 0;
    allRows.forEach(function(row) {
        var rowSection = (row.dataset.section || '').toUpperCase();
        var sel = currentSection.toUpperCase();
        var show = (sel === '' || rowSection === sel);
        row.style.display = show ? '' : 'none';
        if (show) visible++;
    });
    // Count only unique visible (read + edit overlap same rows; count once)
    var readVisible = document.querySelectorAll('#readTableWrapper tbody tr:not([style*="none"])').length;
    document.getElementById('rowCount').textContent = readVisible > 0 ? readVisible + ' baris' : '';
}
filterTables();

// ── Insert-below button ────────────────────────────────────────────────
document.getElementById('editTbody').addEventListener('click', function(e) {
    var insertBtn = e.target.closest('.insert-below-btn');
    if (insertBtn) {
        var currentRow = insertBtn.closest('tr');
        var sectionVal = currentRow.querySelector('[name="Section"]').value || currentSection;
        var newRow = makeNewRow(sectionVal);
        currentRow.insertAdjacentElement('afterend', newRow);
        filterTables();
    }

    var deleteBtn = e.target.closest('.delete-row-btn');
    if (deleteBtn) {
        var row = deleteBtn.closest('tr');
        var rowId = parseInt(row.dataset.id) || 0;
        if (rowId === 0) {
            // New row — remove from DOM only
            row.remove();
            filterTables();
        } else {
            // Existing row — AJAX delete
            if (!confirm('Hapus baris ini dari database?')) return;
            var token = document.querySelector('input[name="__RequestVerificationToken"]').value;
            fetch('/Admin/CpdpItemDelete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'RequestVerificationToken': token },
                body: 'id=' + rowId
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success) {
                    // Remove from both tables
                    document.querySelectorAll('tr[data-id="' + rowId + '"]').forEach(function(r) { r.remove(); });
                    cpdpItems = cpdpItems.filter(function(i) { return i.Id !== rowId; });
                    filterTables();
                } else {
                    alert(data.message || 'Gagal menghapus.');
                }
            })
            .catch(function() { alert('Koneksi error.'); });
        }
    }
});

// Also wire delete buttons on read-mode table
document.getElementById('readTableWrapper').addEventListener('click', function(e) {
    var btn = e.target.closest('.delete-btn');
    if (!btn) return;
    var rowId = parseInt(btn.dataset.id);
    var name = btn.dataset.name || '';
    if (!confirm('Hapus "' + name + '"?')) return;
    var token = document.querySelector('input[name="__RequestVerificationToken"]').value;
    fetch('/Admin/CpdpItemDelete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'RequestVerificationToken': token },
        body: 'id=' + rowId
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            document.querySelectorAll('tr[data-id="' + rowId + '"]').forEach(function(r) { r.remove(); });
            cpdpItems = cpdpItems.filter(function(i) { return i.Id !== rowId; });
            filterTables();
        } else {
            alert(data.message || 'Gagal menghapus.');
        }
    })
    .catch(function() { alert('Koneksi error.'); });
});

// ── Make new blank row ─────────────────────────────────────────────────
function makeNewRow(sectionVal) {
    var tr = document.createElement('tr');
    tr.dataset.id = '0';
    tr.dataset.section = sectionVal || '';
    tr.innerHTML =
        '<td><input type="text" name="No" value="" class="edit-input" /></td>' +
        '<td><input type="text" name="NamaKompetensi" value="" class="edit-input" /></td>' +
        '<td><input type="text" name="IndikatorPerilaku" value="" class="edit-input" /></td>' +
        '<td><input type="text" name="DetailIndikator" value="" class="edit-input" /></td>' +
        '<td><input type="text" name="Silabus" value="" class="edit-input" /></td>' +
        '<td><input type="text" name="TargetDeliverable" value="" class="edit-input" /></td>' +
        '<td>' +
          '<input type="hidden" name="Status" value="" />' +
          '<input type="hidden" name="Section" value="' + (sectionVal || '') + '" />' +
          '<button type="button" class="btn btn-sm btn-outline-secondary insert-below-btn me-1" title="Sisipkan baris bawah"><i class="bi bi-plus-circle"></i></button>' +
          '<button type="button" class="btn btn-sm btn-outline-danger delete-row-btn" title="Hapus baris"><i class="bi bi-trash"></i></button>' +
        '</td>';
    return tr;
}

// ── Bulk save ──────────────────────────────────────────────────────────
function saveAllRows() {
    var rows = [];
    document.querySelectorAll('#editTable tbody tr').forEach(function(tr) {
        var rowId = parseInt(tr.dataset.id) || 0;
        rows.push({
            Id:                 rowId,
            No:                 tr.querySelector('[name="No"]').value,
            NamaKompetensi:     tr.querySelector('[name="NamaKompetensi"]').value,
            IndikatorPerilaku:  tr.querySelector('[name="IndikatorPerilaku"]').value,
            DetailIndikator:    tr.querySelector('[name="DetailIndikator"]').value,
            Silabus:            tr.querySelector('[name="Silabus"]').value,
            TargetDeliverable:  tr.querySelector('[name="TargetDeliverable"]').value,
            Status:             tr.querySelector('[name="Status"]').value || '',
            Section:            tr.querySelector('[name="Section"]').value || ''
        });
    });

    if (rows.length === 0) { alert('Tidak ada data untuk disimpan.'); return; }

    var token = document.querySelector('input[name="__RequestVerificationToken"]').value;

    fetch('/Admin/CpdpItemsSave', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': token },
        body: JSON.stringify(rows)
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            var toastEl = document.getElementById('saveToast');
            var toast = new bootstrap.Toast(toastEl, { delay: 2000 });
            toast.show();
            setTimeout(function() { location.reload(); }, 2100);
        } else {
            alert('Error: ' + (data.message || 'Gagal menyimpan.'));
        }
    })
    .catch(function() { alert('Koneksi error.'); });
}
```
  </action>
  <verify>
    <automated>dotnet build HcPortal.csproj --no-restore 2>&1 | tail -5</automated>
  </verify>
  <done>Build succeeds. Clicking Edit shows 7-column edit table with horizontal scroll and sticky first 2 columns. Section filter applies to edit table. Insert-below adds blank row with correct section. Inline delete for Id=0 rows removes from DOM; Id>0 rows call AJAX delete. Simpan POST sends JSON to /Admin/CpdpItemsSave, shows toast, and reloads. Batal prompts and reloads.</done>
</task>

<task id="48-02-T3" type="auto" wave="2">
  <title>Update CMP/MappingSectionSelect.cshtml — replace card selection with dropdown</title>
  <files>
    - Views/CMP/MappingSectionSelect.cshtml
  </files>
  <action>
Locate `Views/CMP/MappingSectionSelect.cshtml`. Read its current content first.

The current page shows card-based section selection (click a card to navigate to Mapping?section=X). Replace it with a dropdown form that submits to the same `GET /CMP/Mapping?section=X` endpoint, making the UX consistent with the Admin editor dropdown.

**New layout:**
```html
@{
    ViewData["Title"] = "Mapping KKJ - IDP (CPDP)";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold">Mapping KKJ - IDP (CPDP)</h2>
        <p class="text-muted">Kurikulum Pengembangan Kompetensi per Bagian</p>
    </div>
</div>

<div class="card shadow-sm" style="max-width: 480px;">
    <div class="card-body">
        <label for="sectionSelect" class="form-label fw-semibold">Pilih Bagian:</label>
        <div class="d-flex gap-2">
            <select id="sectionSelect" class="form-select">
                <option value="">-- Pilih Bagian --</option>
                <option value="RFCC">RFCC — Unit RFCC</option>
                <option value="GAST">GAST — GSH &amp; Alkylation</option>
                <option value="NGP">NGP — Naphtha Gas Processing</option>
                <option value="DHT">DHT — Diesel Hydrotreating/HMU</option>
            </select>
            <button id="btnLihat" class="btn btn-primary" onclick="goToSection()" disabled>
                <i class="bi bi-arrow-right me-1"></i>Lihat
            </button>
        </div>
        <div class="form-text mt-2 text-muted">Pilih bagian untuk melihat kurikulum pengembangan kompetensi.</div>
    </div>
</div>

<script>
document.getElementById('sectionSelect').addEventListener('change', function() {
    document.getElementById('btnLihat').disabled = this.value === '';
});

function goToSection() {
    var val = document.getElementById('sectionSelect').value;
    if (val) window.location.href = '@Url.Action("Mapping", "CMP")?section=' + encodeURIComponent(val);
}
</script>
```

If `MappingSectionSelect.cshtml` does NOT exist (the Mapping controller returns the card page inline), search for the file first using Glob. If the file doesn't exist, create it at `Views/CMP/MappingSectionSelect.cshtml`. If it does exist, overwrite with the content above.

**Note:** The Mapping action in CMPController already does `return View("MappingSectionSelect")` when section is null, so no controller change needed.
  </action>
  <verify>
    <automated>dotnet build HcPortal.csproj --no-restore 2>&1 | tail -5</automated>
  </verify>
  <done>Build succeeds. Navigating to /CMP/Mapping (no section param) shows a dropdown with 4 section options. Selecting a section and clicking Lihat navigates to /CMP/Mapping?section=RFCC (or other). Read-only table displays correctly.</done>
</task>

## Verification

**Manual verification after all tasks:**
1. Navigate to `/Admin/CpdpItems` — click "Edit" — confirm 7-column edit table with horizontal scroll
2. Section filter in edit mode — select "GAST" — only GAST rows visible in edit table
3. Click insert-below on any row — blank row appears below with correct section
4. Edit cells in new row, click "Simpan" — toast shows "Data berhasil disimpan", page reloads with new row
5. Click trash on an existing read-mode row with no IdpItem references — row deleted, page updates
6. If an item IS referenced by IdpItem: alert shows "Tidak dapat dihapus — digunakan oleh N IDP record."
7. Navigate to `/CMP/Mapping` — dropdown shows instead of cards, selecting a section loads the read-only table

## must_haves

- [ ] POST /Admin/CpdpItemsSave upserts rows and returns `{success:true}`
- [ ] Bulk save with Id=0 row inserts new CpdpItem to database
- [ ] Bulk save with Id>0 row updates all 8 fields (No, NamaKompetensi, IndikatorPerilaku, DetailIndikator, Silabus, TargetDeliverable, Status, Section)
- [ ] POST /Admin/CpdpItemDelete blocks deletion if IdpItem.Kompetensi references the item
- [ ] POST /Admin/CpdpItemDelete deletes unreferenced items and logs to AuditLog
- [ ] Edit mode shows sticky first 2 columns during horizontal scroll
- [ ] Section filter persists when toggling between read and edit mode
- [ ] Toast confirmation shown after successful save, then page reloads
- [ ] CMP/Mapping (no section) shows dropdown instead of card selection
