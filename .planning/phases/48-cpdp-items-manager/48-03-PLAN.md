---
index: 3
wave: 3
title: "Multi-cell selection (drag, Ctrl+C/V, Delete range) + Excel export"
depends_on:
  - 48-02-PLAN.md
files_modified:
  - Views/Admin/CpdpItems.cshtml
  - Controllers/AdminController.cs
autonomous: true
requirements:
  - MDAT-02
---

## Objective

Add Excel-like multi-cell selection and bulk clipboard operations to the edit-mode table, plus a server-side Excel export endpoint so Admin can download current (filtered) data as an `.xlsx` file.

This completes the Phase 48 feature set. After this plan all MDAT-02 success criteria are met.

## Context

@Views/Admin/CpdpItems.cshtml — add multi-cell JS, wire Ctrl+C/V/Delete keydown, add Export button to readActions toolbar
@Controllers/AdminController.cs — add CpdpItemsExport GET action (returns Excel file using ClosedXML)
@Views/Admin/KkjMatrix.cshtml — reference for cell-selection CSS class patterns (.cell-selected) used in Phase 47-05 if implemented; otherwise derive from research
@.planning/phases/48-cpdp-items-manager/48-RESEARCH.md — Pattern 4 (multi-cell selection) code examples
Package check: ClosedXML is likely already in the project (used by Phase 2 Excel export) — confirm in HcPortal.csproj before writing export code

## Tasks

<task id="48-03-T1" type="auto" wave="1">
  <title>Add multi-cell selection and clipboard operations to CpdpItems.cshtml</title>
  <files>
    - Views/Admin/CpdpItems.cshtml
  </files>
  <action>
Add multi-cell selection behavior to the edit-mode table. This is activated only when the edit table is visible.

**Step 1: Add CSS for cell selection** — append to existing `<style>` block:
```css
td.cell-selected input.edit-input { background-color: #cfe9ff !important; border-color: #0d6efd !important; box-shadow: 0 0 0 1px #0d6efd; }
td.cell-selecting { outline: 2px solid #0d6efd; }
```

**Step 2: Add multi-cell selection JavaScript** — append to the existing `<script>` block (after the saveAllRows function). This code handles:
- Single click on an edit-input: clear previous selection, select that cell
- Shift+click: range-select between startCell and clicked cell
- Ctrl+C: copy selected cells as TSV to clipboard
- Ctrl+V: paste TSV from clipboard starting at the topmost-leftmost selected cell
- Delete key: clear contents of selected cells

```javascript
// ── Multi-cell selection ───────────────────────────────────────────────
var selectedCells = [];
var startCell = null;

document.getElementById('editTable').addEventListener('mousedown', function(e) {
    var input = e.target.closest('td input.edit-input');
    if (!input) return;
    var td = input.parentElement;

    if (e.shiftKey && startCell) {
        e.preventDefault();
        selectRange(startCell, td);
    } else {
        clearSelection();
        selectedCells = [td];
        td.classList.add('cell-selected');
        startCell = td;
    }
});

function clearSelection() {
    selectedCells.forEach(function(c) { c.classList.remove('cell-selected'); });
    selectedCells = [];
}

function getTableCells() {
    // Returns 2D array [row][col] of all td elements in editTable tbody
    var result = [];
    document.querySelectorAll('#editTable tbody tr').forEach(function(tr) {
        var cells = [];
        // Only data input cells (not hidden inputs) — columns 0-5 (not Aksi col)
        tr.querySelectorAll('td').forEach(function(td, i) {
            if (i < 6) cells.push(td);  // 6 data columns (No, NamaKompetensi, Indikator, Detail, Silabus, Target)
        });
        if (cells.length > 0) result.push(cells);
    });
    return result;
}

function getCellPos(td, allCells) {
    for (var r = 0; r < allCells.length; r++) {
        for (var c = 0; c < allCells[r].length; c++) {
            if (allCells[r][c] === td) return { r: r, c: c };
        }
    }
    return null;
}

function selectRange(cellA, cellB) {
    var allCells = getTableCells();
    var posA = getCellPos(cellA, allCells);
    var posB = getCellPos(cellB, allCells);
    if (!posA || !posB) return;

    var r1 = Math.min(posA.r, posB.r), r2 = Math.max(posA.r, posB.r);
    var c1 = Math.min(posA.c, posB.c), c2 = Math.max(posA.c, posB.c);

    clearSelection();
    for (var r = r1; r <= r2; r++) {
        for (var c = c1; c <= c2; c++) {
            if (allCells[r] && allCells[r][c]) {
                allCells[r][c].classList.add('cell-selected');
                selectedCells.push(allCells[r][c]);
            }
        }
    }
}

document.addEventListener('keydown', function(e) {
    // Only active in edit mode
    if (document.getElementById('editTableWrapper').classList.contains('d-none')) return;
    if (selectedCells.length === 0) return;

    if ((e.ctrlKey || e.metaKey) && e.key === 'c') {
        e.preventDefault();
        copySelection();
    } else if ((e.ctrlKey || e.metaKey) && e.key === 'v') {
        e.preventDefault();
        pasteFromClipboard();
    } else if (e.key === 'Delete' || e.key === 'Backspace' && e.target.tagName !== 'INPUT') {
        if (e.key === 'Delete' && e.target.tagName !== 'INPUT') {
            e.preventDefault();
            clearCellContents();
        }
    }
});

function copySelection() {
    var allCells = getTableCells();
    // Find bounding box of selection
    var positions = selectedCells.map(function(td) { return getCellPos(td, allCells); }).filter(Boolean);
    if (positions.length === 0) return;
    var r1 = Math.min.apply(null, positions.map(function(p) { return p.r; }));
    var r2 = Math.max.apply(null, positions.map(function(p) { return p.r; }));
    var c1 = Math.min.apply(null, positions.map(function(p) { return p.c; }));
    var c2 = Math.max.apply(null, positions.map(function(p) { return p.c; }));

    var lines = [];
    for (var r = r1; r <= r2; r++) {
        var cols = [];
        for (var c = c1; c <= c2; c++) {
            var inp = allCells[r] && allCells[r][c] ? allCells[r][c].querySelector('input.edit-input') : null;
            cols.push(inp ? inp.value : '');
        }
        lines.push(cols.join('\t'));
    }
    navigator.clipboard.writeText(lines.join('\n')).catch(function() {
        // Fallback for older browsers
        var ta = document.createElement('textarea');
        ta.value = lines.join('\n');
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
    });
}

function pasteFromClipboard() {
    var allCells = getTableCells();
    if (selectedCells.length === 0 || allCells.length === 0) return;
    var startPos = getCellPos(selectedCells[0], allCells);
    if (!startPos) return;

    navigator.clipboard.readText().then(function(text) {
        var lines = text.split('\n');
        lines.forEach(function(line, ri) {
            var cols = line.split('\t');
            cols.forEach(function(val, ci) {
                var r = startPos.r + ri;
                var c = startPos.c + ci;
                if (allCells[r] && allCells[r][c]) {
                    var inp = allCells[r][c].querySelector('input.edit-input');
                    if (inp) inp.value = val.replace(/\r$/, '');
                }
            });
        });
    }).catch(function() {
        alert('Clipboard access denied. Pastikan browser mengizinkan clipboard access.');
    });
}

function clearCellContents() {
    selectedCells.forEach(function(td) {
        var inp = td.querySelector('input.edit-input');
        if (inp) inp.value = '';
    });
}
```
  </action>
  <verify>
    <automated>dotnet build HcPortal.csproj --no-restore 2>&1 | tail -5</automated>
  </verify>
  <done>Build succeeds. In edit mode: clicking a cell highlights it (blue). Shift+click selects a range. Ctrl+C copies as TSV. Ctrl+V pastes from clipboard into cells starting at selected position. Delete key (when not inside an input) clears selected cell contents.</done>
</task>

<task id="48-03-T2" type="auto" wave="1">
  <title>Add Excel export endpoint and Export button</title>
  <files>
    - Controllers/AdminController.cs
    - Views/Admin/CpdpItems.cshtml
  </files>
  <action>
**Step 1: Verify ClosedXML availability**

Before writing code, check `HcPortal.csproj` for a ClosedXML package reference:
```
grep -i "closedxml" HcPortal.csproj
```
If not present, also check if it's referenced in a `.csproj` file under the solution. If ClosedXML is NOT in the project, add it:
```
dotnet add package ClosedXML --version 0.102.2
```

**Step 2: Add CpdpItemsExport GET action to AdminController**

Add after `CpdpItemDelete`:

```csharp
// GET /Admin/CpdpItemsExport?section=RFCC
public async Task<IActionResult> CpdpItemsExport(string? section)
{
    var query = _context.CpdpItems.OrderBy(c => c.No).ThenBy(c => c.Id).AsQueryable();

    if (!string.IsNullOrEmpty(section))
        query = query.Where(c => c.Section == section);

    var items = await query.ToListAsync();

    using var workbook = new ClosedXML.Excel.XLWorkbook();
    var ws = workbook.Worksheets.Add("CPDP Items");

    // Header row
    ws.Cell(1, 1).Value = "No";
    ws.Cell(1, 2).Value = "Nama Kompetensi";
    ws.Cell(1, 3).Value = "Indikator Perilaku";
    ws.Cell(1, 4).Value = "Detail Indikator";
    ws.Cell(1, 5).Value = "Silabus / IDP";
    ws.Cell(1, 6).Value = "Target Deliverable";
    ws.Cell(1, 7).Value = "Status";
    ws.Cell(1, 8).Value = "Section";

    var headerRow = ws.Row(1);
    headerRow.Style.Font.Bold = true;
    headerRow.Style.Fill.BackgroundColor = ClosedXML.Excel.XLColor.FromHtml("#343a40");
    headerRow.Style.Font.FontColor = ClosedXML.Excel.XLColor.White;

    // Data rows
    for (int i = 0; i < items.Count; i++)
    {
        var row = items[i];
        var r = i + 2;
        ws.Cell(r, 1).Value = row.No;
        ws.Cell(r, 2).Value = row.NamaKompetensi;
        ws.Cell(r, 3).Value = row.IndikatorPerilaku;
        ws.Cell(r, 4).Value = row.DetailIndikator;
        ws.Cell(r, 5).Value = row.Silabus;
        ws.Cell(r, 6).Value = row.TargetDeliverable;
        ws.Cell(r, 7).Value = row.Status;
        ws.Cell(r, 8).Value = row.Section;
    }

    ws.Columns().AdjustToContents();

    using var stream = new MemoryStream();
    workbook.SaveAs(stream);
    stream.Position = 0;

    var fileName = string.IsNullOrEmpty(section)
        ? "CPDP_Items_All.xlsx"
        : $"CPDP_Items_{section}.xlsx";

    return File(stream.ToArray(),
        "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
        fileName);
}
```

**Step 3: Add Export button to read-mode toolbar in CpdpItems.cshtml**

In `Views/Admin/CpdpItems.cshtml`, find the `#readActions` div:
```html
<div id="readActions">
  <button id="btnEdit" class="btn btn-sm btn-primary"><i class="bi bi-pencil me-1"></i>Edit</button>
</div>
```

Replace with:
```html
<div id="readActions" class="d-flex gap-2">
  <a id="btnExport" href="/Admin/CpdpItemsExport" class="btn btn-sm btn-outline-success">
    <i class="bi bi-file-earmark-excel me-1"></i>Export Excel
  </a>
  <button id="btnEdit" class="btn btn-sm btn-primary"><i class="bi bi-pencil me-1"></i>Edit</button>
</div>
```

Also add a small JS snippet to update the export button href when section filter changes, so it exports only the filtered section:
```javascript
document.getElementById('sectionFilter').addEventListener('change', function(e) {
    var sel = e.target.value;
    var exportBtn = document.getElementById('btnExport');
    exportBtn.href = '/Admin/CpdpItemsExport' + (sel ? '?section=' + encodeURIComponent(sel) : '');
});
```
Add this inside the existing sectionFilter change handler (or as a separate listener appended after the existing one).
  </action>
  <verify>
    <automated>dotnet build HcPortal.csproj --no-restore 2>&1 | tail -5</automated>
  </verify>
  <done>Build succeeds. "Export Excel" button appears in toolbar. Clicking it downloads CPDP_Items_All.xlsx (when no section selected) or CPDP_Items_RFCC.xlsx (when RFCC is selected). File opens in Excel with correct columns and data rows.</done>
</task>

## Verification

**Manual verification after both tasks:**
1. Navigate to `/Admin/CpdpItems`, click Edit
2. Click a cell — it highlights blue
3. Shift+click a cell 2 rows below, 2 columns right — range of cells highlights
4. Ctrl+C — open Notepad, Ctrl+V — confirm TSV text (tab-separated columns, newline-separated rows)
5. Open Excel, type some values, Ctrl+A, Ctrl+C; go back to browser, click a cell in edit table, Ctrl+V — values fill multiple cells
6. Select some cells with Delete key (focus not in input) — cell contents cleared
7. Back in read mode: click "Export Excel" — file downloads as CPDP_Items_All.xlsx
8. Select "RFCC" from dropdown — Export button URL updates to include ?section=RFCC
9. Click Export — downloads CPDP_Items_RFCC.xlsx with only RFCC rows

## must_haves

- [ ] Multi-cell selection highlights cells with blue background in edit mode
- [ ] Shift+click selects rectangular range between start cell and clicked cell
- [ ] Ctrl+C copies selected range as TSV to system clipboard
- [ ] Ctrl+V pastes TSV from clipboard into edit table starting at selected cell
- [ ] Delete key (outside input focus) clears selected cell contents
- [ ] Export Excel button downloads .xlsx file with all 8 CpdpItem columns
- [ ] Export respects section filter — filtered section downloads only that section's rows
- [ ] ClosedXML package is in HcPortal.csproj (either pre-existing or added)
