---
phase: 48-cpdp-items-manager
plan: "04"
type: execute
wave: 4
depends_on: ["48-03"]
files_modified:
  - Views/Admin/CpdpItems.cshtml
  - Controllers/AdminController.cs
autonomous: true
gap_closure: true
requirements: [MDAT-02]

must_haves:
  truths:
    - "Read-mode table shows all 6 data columns: No, Nama Kompetensi, Indikator Perilaku (Level), Detail Indikator Perilaku, Individual Development Plan / Silabus, Target Deliverable"
    - "HC (Admin) can delete a CpdpItem even when it is referenced by IdpItem records — no reference guard blocks deletion"
    - "Pressing Delete or Backspace on a multi-cell selection clears ALL selected cells, not just the first one"
  artifacts:
    - path: "Views/Admin/CpdpItems.cshtml"
      provides: "Read-mode table with 6 data columns; corrected keydown handler with parenthesised operator precedence"
    - path: "Controllers/AdminController.cs"
      provides: "CpdpItemDelete action without CountAsync reference guard block"
  key_links:
    - from: "Views/Admin/CpdpItems.cshtml (read-mode thead)"
      to: "CpdpItem model"
      via: "@item.DetailIndikator, @item.Silabus, @item.TargetDeliverable in foreach row"
      pattern: "@item\\.DetailIndikator"
    - from: "Views/Admin/CpdpItems.cshtml (keydown handler)"
      to: "clearCellContents()"
      via: "unified condition with correct operator precedence"
      pattern: "\\(e\\.key === 'Delete' \\|\\| e\\.key === 'Backspace'\\)"
    - from: "Controllers/AdminController.cs (CpdpItemDelete)"
      to: "_context.CpdpItems.Remove"
      via: "direct delete without CountAsync guard"
      pattern: "_context\\.CpdpItems\\.Remove"
---

<objective>
Close three UAT-diagnosed gaps in the Phase 48 CPDP Items Manager: add three missing columns to the read-mode table, remove the IdpItem reference guard that blocks deletion, and fix broken operator precedence in the Delete-key handler that caused only the first selected cell to be cleared.

Purpose: Phase 48 UAT found these as "major" severity gaps — all three affect core usability of the KKJ-IDP Mapping Editor.
Output: CpdpItems.cshtml and AdminController.cs with all three defects corrected.
</objective>

<execution_context>
@C:/Users/Administrator/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Administrator/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/48-cpdp-items-manager/48-03-SUMMARY.md

<interfaces>
<!-- Exact current state of the two files being modified. Executor should not explore further. -->

From Views/Admin/CpdpItems.cshtml (read-mode table, lines 70-95):
```html
<thead class="table-light">
    <tr>
        <th>No</th>
        <th>Nama Kompetensi</th>
        <th>Indikator Perilaku</th>
        <th>Aksi</th>
    </tr>
</thead>
<tbody>
    @foreach (var item in Model)
    {
        <tr data-id="@item.Id" data-section="@item.Section">
            <td>@item.No</td>
            <td>@item.NamaKompetensi</td>
            <td>@item.IndikatorPerilaku</td>
            <td>
                <button class="btn btn-sm btn-outline-danger delete-btn"
                        data-id="@item.Id"
                        data-name="@item.NamaKompetensi">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        </tr>
    }
</tbody>
```

CpdpItem model properties available: Id, No, Section, NamaKompetensi, IndikatorPerilaku, DetailIndikator, Silabus, TargetDeliverable

From Views/Admin/CpdpItems.cshtml (keydown handler, lines 393-410):
```javascript
document.addEventListener('keydown', function(e) {
    // Only active in edit mode
    if (document.getElementById('editTableWrapper').classList.contains('d-none')) return;
    if (selectedCells.length === 0) return;

    if ((e.ctrlKey || e.metaKey) && e.key === 'c') {
        e.preventDefault();
        copySelection();
    } else if ((e.ctrlKey || e.metaKey) && e.key === 'v') {
        e.preventDefault();
        pasteFromClipboard();
    } else if (e.key === 'Delete' || e.key === 'Backspace' && e.target.tagName !== 'INPUT') {
        if (e.key === 'Delete' && e.target.tagName !== 'INPUT') {
            e.preventDefault();
            clearCellContents();
        }
    }
});
```

From Controllers/AdminController.cs (CpdpItemDelete, lines 312-339):
```csharp
// POST /Admin/CpdpItemDelete
[HttpPost]
[ValidateAntiForgeryToken]
public async Task<IActionResult> CpdpItemDelete(int id)
{
    var item = await _context.CpdpItems.FindAsync(id);
    if (item == null)
        return Json(new { success = false, message = "CPDP item tidak ditemukan." });

    // Reference guard: check IdpItem records that match by NamaKompetensi string
    var usageCount = await _context.IdpItems
        .CountAsync(i => i.Kompetensi == item.NamaKompetensi);

    if (usageCount > 0)
        return Json(new { success = false, blocked = true,
            message = $"Tidak dapat dihapus — digunakan oleh {usageCount} IDP record." });

    _context.CpdpItems.Remove(item);
    await _context.SaveChangesAsync();

    var actor = await _userManager.GetUserAsync(User);
    if (actor != null)
        await _auditLog.LogAsync(actor.Id, actor.FullName, "Delete",
            $"Deleted CpdpItem Id={id} ({item.NamaKompetensi})",
            targetId: id, targetType: "CpdpItem");

    return Json(new { success = true });
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add 3 missing columns to read-mode table</name>
  <files>Views/Admin/CpdpItems.cshtml</files>
  <action>
In the read-mode `<thead>` (lines 71-76), insert three `<th>` elements BEFORE the existing `<th>Aksi</th>`:

```html
<th>Detail Indikator Perilaku</th>
<th>Individual Development Plan / Silabus</th>
<th>Target Deliverable</th>
```

Result: thead order becomes: No, Nama Kompetensi, Indikator Perilaku, Detail Indikator Perilaku, Individual Development Plan / Silabus, Target Deliverable, Aksi.

In the `@foreach` tbody (lines 81-92), insert three `<td>` elements BEFORE the `<td>` that contains the delete button:

```html
<td>@item.DetailIndikator</td>
<td>@item.Silabus</td>
<td>@item.TargetDeliverable</td>
```

Result: each row renders all 6 data columns followed by the Aksi delete button. Razor auto-encoding handles any special characters in these fields (consistent with Phase 48-01/02 pattern).

Do NOT change edit-mode table — it already has all 6 data columns (lines 101-111).
Do NOT change getTableCells() — it already returns first 6 td elements per row (correct after this fix, since read table columns 0-5 become data and column 6 becomes Aksi).
  </action>
  <verify>
    <automated>cd C:/Users/Administrator/Desktop/PortalHC_KPB && dotnet build --configuration Release 2>&1 | grep -E "^.*error CS|Build succeeded"</automated>
  </verify>
  <done>Read-mode thead has 7 th elements (No, Nama Kompetensi, Indikator Perilaku, Detail Indikator Perilaku, Individual Development Plan / Silabus, Target Deliverable, Aksi). Each tbody row has 7 td elements with @item.DetailIndikator, @item.Silabus, @item.TargetDeliverable present. Build has no CS errors.</done>
</task>

<task type="auto">
  <name>Task 2: Remove IdpItem reference guard from CpdpItemDelete</name>
  <files>Controllers/AdminController.cs</files>
  <action>
In `CpdpItemDelete` (around lines 321-327), delete the 6-line reference guard block:

```csharp
// Reference guard: check IdpItem records that match by NamaKompetensi string
var usageCount = await _context.IdpItems
    .CountAsync(i => i.Kompetensi == item.NamaKompetensi);

if (usageCount > 0)
    return Json(new { success = false, blocked = true,
        message = $"Tidak dapat dihapus — digunakan oleh {usageCount} IDP record." });
```

After removal, the action flows: FindAsync → null-check → Remove → SaveChangesAsync → audit log → return Json success. No other changes to CpdpItemDelete.

The rename guard inside `CpdpItemsSave` (lines ~278-282) that warns when NamaKompetensi changes is a different guard — leave it untouched.
  </action>
  <verify>
    <automated>cd C:/Users/Administrator/Desktop/PortalHC_KPB && dotnet build --configuration Release 2>&1 | grep -E "^.*error CS|Build succeeded"</automated>
  </verify>
  <done>CpdpItemDelete contains no CountAsync call and no `blocked: true` response. Build succeeds with no CS errors.</done>
</task>

<task type="auto">
  <name>Task 3: Fix Delete-key operator precedence in keydown handler</name>
  <files>Views/Admin/CpdpItems.cshtml</files>
  <action>
Replace the broken else-if branch (lines 404-409) with a corrected single condition:

BEFORE:
```javascript
} else if (e.key === 'Delete' || e.key === 'Backspace' && e.target.tagName !== 'INPUT') {
    if (e.key === 'Delete' && e.target.tagName !== 'INPUT') {
        e.preventDefault();
        clearCellContents();
    }
}
```

AFTER:
```javascript
} else if ((e.key === 'Delete' || e.key === 'Backspace') && e.target.tagName !== 'INPUT') {
    e.preventDefault();
    clearCellContents();
}
```

Key changes:
1. Parentheses around `(e.key === 'Delete' || e.key === 'Backspace')` so `&&` binds the combined key check against `tagName !== 'INPUT'` — previously `&&` bound only `Backspace` to the INPUT guard.
2. Remove nested `if` — the outer condition already guards both keys and the INPUT check. `clearCellContents()` is called unconditionally when the outer condition passes.

Do NOT change any other part of the keydown handler (Ctrl+C and Ctrl+V branches are correct).
  </action>
  <verify>
    <automated>cd C:/Users/Administrator/Desktop/PortalHC_KPB && grep -n "e.key === 'Delete' || e.key === 'Backspace'" Views/Admin/CpdpItems.cshtml</automated>
  </verify>
  <done>keydown handler has single condition `(e.key === 'Delete' || e.key === 'Backspace') && e.target.tagName !== 'INPUT'` with no nested if. Build succeeds with no CS errors.</done>
</task>

</tasks>

<verification>
After all three tasks:

1. Navigate to /Admin/CpdpItems. Read-mode table header row shows: No, Nama Kompetensi, Indikator Perilaku, Detail Indikator Perilaku, Individual Development Plan / Silabus, Target Deliverable, [Aksi column]. Each data row shows values for all 6 data columns.

2. In edit mode, select any row for a CpdpItem that has IdpItem references and click the delete icon. The delete should succeed (no "blocked" error toast, row disappears or page reloads without the row).

3. In edit mode, select multiple cells (shift+click range) and press Delete. All selected cells are cleared, not only the first one.
</verification>

<success_criteria>
- Read-mode table shows 6 data columns + Aksi (7 total) — matches user's expected layout
- CpdpItemDelete always succeeds for Id>0 rows — no IdpItem CountAsync guard
- Delete key on multi-cell selection clears every selected cell's input value
- dotnet build produces no CS errors
</success_criteria>

<output>
After completion, create `.planning/phases/48-cpdp-items-manager/48-cpdp-items-manager-04-SUMMARY.md`
</output>
