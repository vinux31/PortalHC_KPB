---
phase: 49-assessment-management-migration
task: UAT gap fixes
total_tasks: 8 (7 issues to fix + 1 cosmetic)
status: diagnosed
last_updated: 2026-02-27T01:13:46.374Z
---

<current_state>
Phase 49 executed (4/4 plans). UAT complete: 5 passed, 7 issues, 1 skipped.
All 7 issues diagnosed with root causes. Ready to plan+execute fixes.
UAT committed: db09553. Diagnosis results below — NOT yet written to UAT.md.
</current_state>

<completed_work>

- Phase 49 execution: 4/4 plans complete (ManageAssessment scaffold, CRUD, Monitoring/Export, CMP cleanup)
- UAT: 13 tests run, 5 passed (1,2,4,12,13), 7 issues (3,5,7,8,9,10,11), 1 skipped (6)
- All 7 issues diagnosed via parallel debug agents — root causes found for all
</completed_work>

<remaining_work>

1. Update 49-UAT.md Gaps section with root causes (status → diagnosed)
2. Plan gap fixes (or directly fix — root causes are very clear)
3. Execute fixes
4. Re-test fixed items

### All 7 Diagnosed Issues — Root Causes & Fixes

**Issue 3a: Create Assessment — Modal not showing**
- FILE: Controllers/AdminController.cs line 706
- ROOT CAUSE: POST redirects to ManageAssessment instead of CreateAssessment, so TempData["CreatedAssessment"] never consumed
- FIX: Change `RedirectToAction("ManageAssessment")` → `RedirectToAction("CreateAssessment")`

**Issue 3b: ManageAssessment — Table height too short**
- FILE: Views/Admin/ManageAssessment.cshtml line 92
- ROOT CAUSE: No min-height on table-responsive div
- FIX: Add `style="min-height: calc(100vh - 280px);"` to table-responsive div

**Issue 5: Delete Assessment — Wrong redirect + JSON response**
- FILE: Controllers/AdminController.cs lines 1044, 1098, 1103 (DeleteAssessmentGroup)
- ROOT CAUSE: Controller returns Json() but view uses plain form POST (expects redirect)
- FIX: Replace `return Json(...)` with `TempData["Error/Success"] + RedirectToAction("ManageAssessment")`
- Also fix DeleteAssessment (lines 966, 1019, 1024) same pattern

**Issue 7: Regenerate Token — Button missing from dropdown**
- FILE: Views/Admin/ManageAssessment.cshtml lines 162-193
- ROOT CAUSE: RegenerateToken `<li>` never added to action dropdown (only 4 items, missing 5th)
- FIX: Add form POST button for /Admin/RegenerateToken/@group.RepresentativeId
- NOTE: Controller returns JSON → needs AJAX handler or change to redirect+TempData

**Issue 8+9: Monitoring Detail + Export — "group not found" / "no sessions found"**
- FILES: Views/Admin/ManageAssessment.cshtml lines 170-181, Controllers/AdminController.cs lines 1219-1226 and 1605-1613
- ROOT CAUSE: View passes title+category+scheduleDate as 3-tuple, but UTC/local timezone mismatch causes Schedule.Date comparison to fail in EF Core SQL query
- FIX: Change both links to pass `asp-route-id="@group.RepresentativeId"` instead of 3-tuple. Change controller actions to accept `int id`, load representative session, then query siblings by title+category+schedule.Date from that session (same pattern as EditAssessment at lines 718-729)

**Issue 10: UserAssessmentHistory — 404**
- FILE: Views/CDP/Shared/_AssessmentAnalyticsPartial.cshtml line 232
- ROOT CAUSE: Link points to controller "CMP" but action only exists in "Admin"
- FIX: Change `"CMP"` to `"Admin"` in Url.Action call
- NOTE: Views/CMP/UserAssessmentHistory.cshtml is dead code, can be removed

**Issue 11: Audit Log — "? - Rino" actor name + column rename**
- FILES: Views/Admin/AuditLog.cshtml line 45, Controllers/AdminController.cs lines 643,824,1004,1083,1490,1542,1590,2041,2120,2216, Controllers/CMPController.cs lines 2319,2890,3052,3181,3454
- ROOT CAUSE: actorName built as `$"{actor?.NIP ?? "?"} - {actor?.FullName}"` — NIP is nullable, falls back to "?"
- FIX 1: Rename column header "Aktor" → "User" in AuditLog.cshtml line 45
- FIX 2: Change all actorName expressions to: `string.IsNullOrWhiteSpace(actor?.NIP) ? (actor?.FullName ?? "Unknown") : $"{actor.NIP} - {actor.FullName}"`
</remaining_work>

<decisions_made>

- Monitoring/Export fix: Use RepresentativeId approach (Option A) over keeping 3-tuple string match (Option B) — matches existing EditAssessment pattern, eliminates timezone fragility
- Delete fix: Use redirect approach (Option A) over AJAX (Option B) — view uses plain form POST
- All fixes are mechanical — root causes are specific file+line level, no architectural decisions needed
</decisions_made>

<blockers>
None. All root causes identified with exact file paths and line numbers.
</blockers>

<context>
Phase 49 migrated assessment management from CMPController to AdminController. The migration itself was correct, but the Admin views wire up actions differently than CMP views did — causing parameter mismatches (3-tuple vs ID), response format mismatches (JSON vs redirect), and missing UI elements (RegenerateToken button). The actor name format issue predates this migration but was surfaced during testing.
</context>

<next_action>
Resume with: /gsd:resume-work

On resume:
1. Update 49-UAT.md with root causes in Gaps section
2. Either run /gsd:plan-phase 49 --gaps or directly fix (fixes are all clear, mechanical changes)
3. Recommended: directly fix since all 7 issues have exact file+line root causes
4. Re-run UAT for fixed items
</next_action>
