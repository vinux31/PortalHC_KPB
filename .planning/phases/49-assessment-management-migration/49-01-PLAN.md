---
phase: 49-assessment-management-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Controllers/AdminController.cs
  - Views/Admin/ManageAssessment.cshtml
  - Views/Admin/Index.cshtml
autonomous: true
requirements:
  - MDAT-03

must_haves:
  truths:
    - GET /Admin/ManageAssessment renders a page listing assessment groups (grouped by Title+Category+Schedule.Date) with search bar and pagination (20/page)
    - Only Admin role can access /Admin/ManageAssessment (AdminController class-level [Authorize(Roles="Admin")] enforced)
    - Page shows Kelola Data breadcrumb style (Admin > Kelola Data > Manage Assessments), card shadow-sm, container-fluid layout
    - Search by title or category filters the grouped list without page reload (standard form GET)
    - Admin/Index.cshtml "Assessment Competency Map" card (with Segera badge) is replaced by "Manage Assessments" card linking to /Admin/ManageAssessment
    - Audit Log button visible in ManageAssessment page header (links to /Admin/AuditLog, placeholder for Plan 04)
  artifacts:
    - Controllers/AdminController.cs (ManageAssessment GET action added)
    - Views/Admin/ManageAssessment.cshtml (new file)
    - Views/Admin/Index.cshtml (card updated)
  key_links:
    - AdminController.ManageAssessment GET → Views/Admin/ManageAssessment.cshtml
    - Admin/Index card "Manage Assessments" → /Admin/ManageAssessment
---

<objective>
Scaffold the Admin ManageAssessment page: add GET action to AdminController, create ManageAssessment.cshtml with grouped assessment list, and update Admin/Index.cshtml to replace the "Assessment Competency Map" stub card with "Manage Assessments" active card.

Purpose: Establishes the new admin home for assessment management. All subsequent plans (Create/Edit/Delete, Monitoring/Export, CMP cleanup) depend on this foundation page existing.
Output: Working /Admin/ManageAssessment page with grouped assessment list. Admin Index card updated to link to it.
</objective>

<context>
@Controllers/AdminController.cs — Add ManageAssessment GET after existing KkjMatrix actions. AdminController already has [Authorize(Roles = "Admin")] at class level — no per-action decorator needed.

@Controllers/CMPController.cs — Source of the grouped assessment query (lines 96-402, Assessment() manage branch). Copy grouped query logic exactly as-is. Key query: AssessmentSessions grouped by (Title, Category, Schedule.Date) using in-memory GroupBy after projection. Search filters by title, category, user FullName, or NIP.

@Views/Admin/Index.cshtml — Replace card at lines 46-59 ("Assessment Competency Map" with Segera badge) with active "Manage Assessments" card linking to /Admin/ManageAssessment.

@Views/Admin/KkjMatrix.cshtml — Reference for Kelola Data page style (breadcrumb, container-fluid, card shadow-sm).

@Views/CMP/Assessment.cshtml — Source manage view table structure. The new ManageAssessment.cshtml replicates the manage tab table (grouped rows with Title, Category, Schedule, Status, User count, action buttons for Create/Edit/Delete/Reset/ForceClose/Export/Monitoring).
</context>

<tasks>

<task id="49-01-T1" type="auto">
  <name>Add ManageAssessment GET action to AdminController</name>
  <files>
    - Controllers/AdminController.cs
  </files>
  <action>
Add the following GET action to AdminController.cs after the existing KkjMatrix-related actions (after the last KkjMatrixDelete action around line 218+):

```csharp
// GET /Admin/ManageAssessment
[HttpGet]
public async Task<IActionResult> ManageAssessment(string? search, int page = 1, int pageSize = 20)
{
    var sevenDaysAgo = DateTime.UtcNow.AddDays(-7);

    var managementQuery = _context.AssessmentSessions
        .Where(a => (a.ExamWindowCloseDate ?? a.Schedule) >= sevenDaysAgo)
        .AsQueryable();

    if (!string.IsNullOrEmpty(search))
    {
        var lowerSearch = search.ToLower();
        managementQuery = managementQuery.Where(a =>
            a.Title.ToLower().Contains(lowerSearch) ||
            a.Category.ToLower().Contains(lowerSearch) ||
            (a.User != null && (
                a.User.FullName.ToLower().Contains(lowerSearch) ||
                (a.User.NIP != null && a.User.NIP.Contains(lowerSearch))
            ))
        );
    }

    var allSessions = await managementQuery
        .Include(a => a.User)
        .OrderByDescending(a => a.Schedule)
        .Select(a => new
        {
            a.Id,
            a.Title,
            a.Category,
            a.Schedule,
            a.ExamWindowCloseDate,
            a.DurationMinutes,
            a.Status,
            a.IsTokenRequired,
            a.AccessToken,
            a.PassPercentage,
            a.AllowAnswerReview,
            a.CreatedAt,
            UserFullName = a.User != null ? a.User.FullName : "Unknown",
            UserEmail = a.User != null ? a.User.Email : "",
            UserId = a.User != null ? a.User.Id : ""
        })
        .ToListAsync();

    // Group by (Title, Category, Schedule.Date) — identical to CMPController manage branch
    var grouped = allSessions
        .GroupBy(a => (a.Title, a.Category, a.Schedule.Date))
        .Select(g =>
        {
            var rep = g.OrderBy(a => a.CreatedAt).First();
            return new
            {
                rep.Title,
                rep.Category,
                rep.Schedule,
                rep.ExamWindowCloseDate,
                rep.DurationMinutes,
                rep.Status,
                rep.IsTokenRequired,
                rep.AccessToken,
                rep.PassPercentage,
                rep.AllowAnswerReview,
                RepresentativeId = rep.Id,
                Users = g.Select(a => new { a.UserFullName, a.UserEmail, a.UserId }).ToList(),
                AllIds = g.Select(a => a.Id).ToList(),
                UserCount = g.Count()
            };
        })
        .OrderByDescending(g => g.Schedule)
        .ToList();

    var totalCount = grouped.Count;
    var totalPages = (int)Math.Ceiling(totalCount / (double)pageSize);

    ViewBag.ManagementData = grouped
        .Skip((page - 1) * pageSize)
        .Take(pageSize)
        .ToList();
    ViewBag.CurrentPage = page;
    ViewBag.TotalPages = totalPages;
    ViewBag.TotalCount = totalCount;
    ViewBag.SearchTerm = search;

    return View();
}
```

Note: AdminController already injects `_context` (AppDbContext) and `_userManager` — no new DI needed. AdminController class has `[Authorize(Roles = "Admin")]` at class level so no per-action auth decorator needed.

Check that `ExamWindowCloseDate` field exists on AssessmentSession model. If it does not exist, use only `a.Schedule` in the Where filter (remove the `?? a.Schedule` part).
  </action>
  <verify>
    <automated>cd /c/Users/Administrator/Desktop/PortalHC_KPB/.claude/worktrees/terminal-a && dotnet build --no-restore -v q 2>&1 | tail -5</automated>
  </verify>
  <done>Build succeeds with no errors. ManageAssessment GET action exists in AdminController.</done>
</task>

<task id="49-01-T2" type="auto">
  <name>Create ManageAssessment.cshtml view</name>
  <files>
    - Views/Admin/ManageAssessment.cshtml
  </files>
  <action>
Create new file Views/Admin/ManageAssessment.cshtml with grouped assessment management table. Model the page style after KkjMatrix.cshtml (Kelola Data breadcrumb, card shadow-sm, container-fluid via layout).

Page structure:
1. Title/breadcrumb: "Admin > Kelola Data > Manage Assessments" using Bootstrap breadcrumb
2. Page header row with title "Manage Assessments" (bi-sliders icon) and two header buttons: "Buat Assessment" (btn-primary, links to /Admin/CreateAssessment) and "Audit Log" (btn-outline-secondary, links to /Admin/AuditLog)
3. Search form (GET to current URL): input for search term, submit button "Cari", clear link if search active — matches CMP Assessment manage view search pattern
4. Stats badge showing total assessment groups count ("@ViewBag.TotalCount grup assessment")
5. Responsive table with columns: No, Judul, Kategori, Jadwal, Durasi, Status, Peserta, Aksi
6. Rows from `@foreach (var group in (dynamic)ViewBag.ManagementData)`:
   - No: row counter
   - Judul: group.Title
   - Kategori: group.Category (badge style)
   - Jadwal: group.Schedule.ToString("dd MMM yyyy HH:mm")
   - Durasi: group.DurationMinutes + " menit"
   - Status: badge (Open=success, Completed=secondary, Upcoming=info, etc.)
   - Peserta: group.UserCount + " peserta" (expandable list, use same collapse pattern as CMP manage view)
   - Aksi: dropdown button with items: Edit (→/Admin/EditAssessment/{group.RepresentativeId}), Delete Group (→/Admin/DeleteAssessmentGroup POST), Monitoring (→/Admin/AssessmentMonitoringDetail), Export (→/Admin/ExportAssessmentResults), Reset (per-session, links to monitoring detail), Force Close (per-session, links to monitoring detail)
7. Pagination controls (same Bootstrap pagination pattern as CMP views): Previous/Next and page number links preserving ?search= and ?page= parameters
8. Empty state: if ManagementData is empty, show "Tidak ada assessment ditemukan" alert

For action buttons: match the exact pattern from Views/CMP/Assessment.cshtml manage tab — the dropdown trigger is per-row and contains links/forms for each operation. Use `asp-controller="Admin"` for all action links (NOT "CMP"). All POST forms must include `@Html.AntiForgeryToken()`.

DeleteAssessmentGroup POST form: `<form method="post" action="/Admin/DeleteAssessmentGroup/@group.RepresentativeId">@Html.AntiForgeryToken()<button type="submit" class="dropdown-item text-danger" onclick="return confirm('Hapus semua assessment dalam grup ini?')">Hapus Grup</button></form>`

Monitoring link: `<a asp-action="AssessmentMonitoringDetail" asp-controller="Admin" asp-route-title="@group.Title" asp-route-category="@group.Category" asp-route-scheduleDate="@group.Schedule.ToString("yyyy-MM-dd")">Monitoring</a>`

Export link: `<a asp-action="ExportAssessmentResults" asp-controller="Admin" asp-route-title="@group.Title" asp-route-category="@group.Category" asp-route-scheduleDate="@group.Schedule.ToString("yyyy-MM-dd")">Export Excel</a>`

Add `@{ ViewData["Title"] = "Manage Assessments"; ViewData["ContainerClass"] = "container-fluid"; }` at top.
  </action>
  <verify>
    <automated>cd /c/Users/Administrator/Desktop/PortalHC_KPB/.claire/worktrees/terminal-a && dotnet build --no-restore -v q 2>&1 | tail -5</automated>
  </verify>
  <done>Views/Admin/ManageAssessment.cshtml exists. Build succeeds. Navigating to /Admin/ManageAssessment (as Admin) shows grouped assessment table with search bar, pagination, and action buttons.</done>
</task>

<task id="49-01-T3" type="auto">
  <name>Update Admin/Index.cshtml — replace Assessment Competency Map card with Manage Assessments</name>
  <files>
    - Views/Admin/Index.cshtml
  </files>
  <action>
In Views/Admin/Index.cshtml, replace the "Assessment Competency Map" card (lines 46-59, the third card in Section A Master Data) with an active "Manage Assessments" card:

OLD (replace this entire col-md-4 div):
```html
    <div class="col-md-4">
        <a href="#" class="text-decoration-none">
            <div class="card shadow-sm h-100 border-0 opacity-75">
                <div class="card-body">
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <i class="bi bi-diagram-3 fs-5 text-primary"></i>
                        <span class="fw-bold">Assessment Competency Map</span>
                        <span class="badge bg-secondary ms-auto" style="font-size:0.6rem;">Segera</span>
                    </div>
                    <small class="text-muted">Kelola mapping assessment ke KKJ</small>
                </div>
            </div>
        </a>
    </div>
```

NEW:
```html
    <div class="col-md-4">
        <a href="@Url.Action("ManageAssessment", "Admin")" class="text-decoration-none">
            <div class="card shadow-sm h-100 border-0">
                <div class="card-body">
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <i class="bi bi-sliders fs-5 text-primary"></i>
                        <span class="fw-bold">Manage Assessments</span>
                    </div>
                    <small class="text-muted">Kelola assessment (buat, edit, hapus, monitoring)</small>
                </div>
            </div>
        </a>
    </div>
```

Note: Active card — no `opacity-75`, no Segera badge. Uses `bi-sliders` icon. Href points to `/Admin/ManageAssessment`.
  </action>
  <verify>
    <automated>cd /c/Users/Administrator/Desktop/PortalHC_KPB/.claude/worktrees/terminal-a && dotnet build --no-restore -v q 2>&1 | tail -5</automated>
  </verify>
  <done>Build succeeds. Admin/Index.cshtml shows "Manage Assessments" as active card (no Segera badge, no opacity-75) with link to /Admin/ManageAssessment. "Assessment Competency Map" card is gone.</done>
</task>

</tasks>

<verification>

## Integration Check

After all tasks complete:

```bash
cd /c/Users/Administrator/Desktop/PortalHC_KPB/.claude/worktrees/terminal-a && dotnet build --no-restore -v q 2>&1 | tail -10
```

Expected: 0 errors, 0 warnings about missing views.

## Manual Spot Check

1. Navigate to /Admin/Index — verify "Manage Assessments" card appears (not "Assessment Competency Map"), click links to /Admin/ManageAssessment
2. Navigate to /Admin/ManageAssessment — verify grouped assessment table renders, search bar works, pagination links exist
3. Verify "Audit Log" and "Buat Assessment" buttons appear in page header

</verification>

<success_criteria>
- GET /Admin/ManageAssessment returns HTTP 200 when called as Admin
- Assessment groups are displayed correctly (grouped by Title+Category+Schedule.Date, not per-session rows)
- Search by title filters the list
- Admin/Index "Manage Assessments" card links to /Admin/ManageAssessment
- "Assessment Competency Map" card with Segera badge no longer appears on Admin/Index
- Build succeeds with no errors
</success_criteria>
