---
phase: 49-assessment-management-migration
plan: 02
type: execute
wave: 2
depends_on:
  - 49-01
files_modified:
  - Controllers/AdminController.cs
  - Views/Admin/CreateAssessment.cshtml
  - Views/Admin/EditAssessment.cshtml
autonomous: true
requirements: []

must_haves:
  truths:
    - POST /Admin/CreateAssessment creates a new AssessmentSession and redirects to /Admin/ManageAssessment
    - GET /Admin/EditAssessment/{id} loads the existing session into a form; POST updates it and redirects to /Admin/ManageAssessment
    - POST /Admin/DeleteAssessment/{id} deletes a single session with guard (returns error if session is not in a deleteable state)
    - POST /Admin/DeleteAssessmentGroup/{representativeId} deletes all sibling sessions in the group
    - POST /Admin/RegenerateToken/{id} regenerates the access token for a session
    - All write actions log to AuditLogService with actionType matching current CMPController names (CreateAssessment, EditAssessment, DeleteAssessment, DeleteAssessmentGroup)
    - All POST actions use [ValidateAntiForgeryToken]
  artifacts:
    - Controllers/AdminController.cs (CreateAssessment GET/POST, EditAssessment GET/POST, DeleteAssessment POST, DeleteAssessmentGroup POST, RegenerateToken POST added)
    - Views/Admin/CreateAssessment.cshtml (new file)
    - Views/Admin/EditAssessment.cshtml (new file)
  key_links:
    - ManageAssessment.cshtml action buttons → AdminController Create/Edit/Delete/RegenerateToken actions
    - AdminController write actions → AuditLogService
---

<objective>
Add Create, Edit, Delete, and RegenerateToken operations to AdminController (migrated 1:1 from CMPController). Create companion view files CreateAssessment.cshtml and EditAssessment.cshtml in Views/Admin/.

Purpose: Admin can create new assessments, edit existing ones, delete single or grouped sessions, and regenerate access tokens — all from the Admin portal, not CMP.
Output: Full Create/Edit/Delete/RegenerateToken workflow operational at /Admin/* routes.
</objective>

<context>
@Controllers/CMPController.cs — Source of all Create/Edit/Delete/RegenerateToken actions. Key line ranges:
- CreateAssessment GET: line 1997
- CreateAssessment POST: line 2031 (~line 2370, very long — includes BulkAssign logic)
- EditAssessment GET: line 1533
- EditAssessment POST: line 1596
- DeleteAssessment POST: line 1773
- DeleteAssessmentGroup POST: line 1854
- RegenerateToken POST: line 1934

Copy these methods verbatim into AdminController. Change only:
1. RedirectToAction("Assessment", "CMP", ...) → RedirectToAction("ManageAssessment", "Admin")
2. RedirectToAction("Assessment", new { view = "manage" }) → RedirectToAction("ManageAssessment")
3. Url.Action("...", "CMP", ...) → Url.Action("...", "Admin", ...)
4. Remove any viewMode/canManage logic — all actions are Admin-only

@Views/CMP/CreateAssessment.cshtml — Source view for Create form. Copy to Views/Admin/CreateAssessment.cshtml, change all `asp-controller="CMP"` to `asp-controller="Admin"`, update breadcrumb to "Admin > Kelola Data > Manage Assessments > Buat Assessment".

@Views/CMP/EditAssessment.cshtml — Source view for Edit form. Copy to Views/Admin/EditAssessment.cshtml, change all `asp-controller="CMP"` to `asp-controller="Admin"`, update breadcrumb to "Admin > Kelola Data > Manage Assessments > Edit Assessment".
</context>

<tasks>

<task id="49-02-T1" type="auto">
  <name>Add CreateAssessment GET/POST and EditAssessment GET/POST to AdminController</name>
  <files>
    - Controllers/AdminController.cs
  </files>
  <action>
Copy the following action methods from CMPController.cs into AdminController.cs, placing them after ManageAssessment GET (added in Plan 01):

**Actions to copy (from CMPController.cs):**
1. `CreateAssessment()` GET — line ~1997 (loads users list for form)
2. `CreateAssessment(AssessmentSession model, List<string> UserIds)` POST — line ~2031 (creates sessions, handles bulk assign, logs audit)
3. `EditAssessment(int id)` GET — line ~1533 (loads session + users)
4. `EditAssessment(int id, AssessmentSession model, List<string> NewUserIds)` POST — line ~1596 (updates session + user assignments + logs audit)

**Changes required when copying:**
- All `RedirectToAction("Assessment", new { view = "manage" })` → `RedirectToAction("ManageAssessment")`
- All `RedirectToAction("Assessment", "CMP", ...)` → `RedirectToAction("ManageAssessment", "Admin")`
- All `Url.Action("Assessment", "CMP", ...)` → `Url.Action("ManageAssessment", "Admin")`
- Any TempData["Error"] redirect that pointed to CMP manage → redirect to Admin ManageAssessment
- No viewMode/canManage references exist in Create/Edit actions (they are manage-only actions)
- Keep all validation logic, BulkAssign logic, user assignment logic UNCHANGED
- Keep AuditLogService calls UNCHANGED (same actionType strings)

Do NOT copy the [HttpPost][ValidateAntiForgeryToken] attribute from CreateAssessment POST if it conflicts with naming — ensure both GET and POST overloads have correct HTTP verb attributes.

Read the actual source from CMPController.cs lines 1533-1596 (EditAssessment GET), 1596-1773 (EditAssessment POST), 1773-1854 (DeleteAssessment), 1854-1934 (DeleteAssessmentGroup), 1934-1969 (RegenerateToken), 1997-2031 (CreateAssessment GET), 2031-2370 (CreateAssessment POST) — copy verbatim, apply only the redirect/url changes above.
  </action>
  <verify>
    <automated>cd /c/Users/Administrator/Desktop/PortalHC_KPB/.claude/worktrees/terminal-a && dotnet build --no-restore -v q 2>&1 | tail -10</automated>
  </verify>
  <done>Build succeeds. AdminController contains CreateAssessment GET/POST, EditAssessment GET/POST methods. All redirects point to Admin ManageAssessment.</done>
</task>

<task id="49-02-T2" type="auto">
  <name>Add DeleteAssessment, DeleteAssessmentGroup, RegenerateToken to AdminController</name>
  <files>
    - Controllers/AdminController.cs
  </files>
  <action>
Continue copying from CMPController.cs into AdminController.cs:

**Actions to copy:**
1. `DeleteAssessment(int id)` POST — line ~1773 (deletes single session, guard check, audit log)
2. `DeleteAssessmentGroup(int representativeId)` POST — line ~1854 (deletes all sibling sessions by title+category+schedule)
3. `RegenerateToken(int id)` POST — line ~1934 (generates new token, saves, redirects)

**Changes required:**
- `RedirectToAction("Assessment", new { view = "manage" })` → `RedirectToAction("ManageAssessment")`
- Any CMP route references → Admin route references
- All [HttpPost][ValidateAntiForgeryToken] attributes preserved

DeleteAssessment has a guard check — preserve it exactly. DeleteAssessmentGroup has logger calls — preserve them (AdminController already has ILogger injected, check constructor; if not, add `private readonly ILogger<AdminController> _logger;` and inject it).

Check AdminController constructor for existing ILogger injection. If missing, add:
```csharp
private readonly ILogger<AdminController> _logger;
```
And add `ILogger<AdminController> logger` to constructor parameter + assignment.
  </action>
  <verify>
    <automated>cd /c/Users/Administrator/Desktop/PortalHC_KPB/.claude/worktrees/terminal-a && dotnet build --no-restore -v q 2>&1 | tail -10</automated>
  </verify>
  <done>Build succeeds. AdminController contains DeleteAssessment POST, DeleteAssessmentGroup POST, RegenerateToken POST. All guard/audit logic preserved.</done>
</task>

<task id="49-02-T3" type="auto">
  <name>Create Views/Admin/CreateAssessment.cshtml and Views/Admin/EditAssessment.cshtml</name>
  <files>
    - Views/Admin/CreateAssessment.cshtml
    - Views/Admin/EditAssessment.cshtml
  </files>
  <action>
Copy Views/CMP/CreateAssessment.cshtml → Views/Admin/CreateAssessment.cshtml with these changes:
1. Update breadcrumb: Replace CMP breadcrumb with "Kelola Data / Manage Assessments / Buat Assessment"
   - Kelola Data links to Url.Action("Index", "Admin")
   - Manage Assessments links to Url.Action("ManageAssessment", "Admin")
2. Replace ALL `asp-controller="CMP"` with `asp-controller="Admin"` throughout
3. Replace ALL `Url.Action("...", "CMP", ...)` with `Url.Action("...", "Admin", ...)`
4. Form action: ensure `<form asp-action="CreateAssessment" asp-controller="Admin" method="post">`
5. Cancel button: link to Url.Action("ManageAssessment", "Admin")
6. Set ViewData["ContainerClass"] = "container" (or container-fluid if source uses it)
7. Keep ALL form fields, validation, JavaScript, user selection multi-select logic UNCHANGED

Copy Views/CMP/EditAssessment.cshtml → Views/Admin/EditAssessment.cshtml with these changes:
1. Update breadcrumb: "Kelola Data / Manage Assessments / Edit Assessment"
   - Kelola Data links to Url.Action("Index", "Admin")
   - Manage Assessments links to Url.Action("ManageAssessment", "Admin")
2. Replace ALL `asp-controller="CMP"` with `asp-controller="Admin"` throughout
3. Replace ALL `Url.Action("...", "CMP", ...)` with `Url.Action("...", "Admin", ...)`
4. Form action: `<form asp-action="EditAssessment" asp-controller="Admin" method="post">`
5. Cancel/back button: link to Url.Action("ManageAssessment", "Admin")
6. Keep ALL form fields, validation, JavaScript UNCHANGED

Pitfall to avoid: Search for `asp-controller="CMP"` in both files after creation — there should be ZERO occurrences. Any remaining "CMP" controller reference will cause 404 or redirect back to CMP.
  </action>
  <verify>
    <automated>cd /c/Users/Administrator/Desktop/PortalHC_KPB/.claude/worktrees/terminal-a && dotnet build --no-restore -v q 2>&1 | tail -5 && grep -r 'asp-controller="CMP"' Views/Admin/ 2>/dev/null | wc -l</automated>
  </verify>
  <done>Build succeeds. Views/Admin/CreateAssessment.cshtml and Views/Admin/EditAssessment.cshtml exist. Zero occurrences of asp-controller="CMP" in Views/Admin/. All breadcrumbs show Admin > Kelola Data > Manage Assessments path.</done>
</task>

</tasks>

<verification>

## Integration Check

```bash
cd /c/Users/Administrator/Desktop/PortalHC_KPB/.claude/worktrees/terminal-a && dotnet build --no-restore -v q 2>&1 | tail -10
```

Expected: 0 errors.

## CMP Reference Check

```bash
grep -r 'asp-controller="CMP"\|"CMP", "Create\|"CMP", "Edit\|"CMP", "Delete' Views/Admin/ 2>/dev/null
```

Expected: no output (zero CMP controller references in Admin views).

## Manual Spot Check

1. Navigate to /Admin/CreateAssessment — form renders with correct breadcrumb
2. Navigate to /Admin/EditAssessment/1 (valid ID) — loads existing session data
3. Create a test assessment via /Admin/CreateAssessment — redirects to /Admin/ManageAssessment and new row appears

</verification>

<success_criteria>
- AdminController has CreateAssessment GET/POST, EditAssessment GET/POST, DeleteAssessment POST, DeleteAssessmentGroup POST, RegenerateToken POST
- All redirects go to /Admin/ManageAssessment (not /CMP/Assessment)
- Views/Admin/CreateAssessment.cshtml and Views/Admin/EditAssessment.cshtml exist with correct breadcrumbs and Admin controller references
- Audit log entries created on Create/Edit/Delete operations (same actionType as CMPController)
- Build succeeds with 0 errors
</success_criteria>
