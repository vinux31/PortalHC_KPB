---
phase: 49-assessment-management-migration
plan: 03
type: execute
wave: 2
depends_on:
  - 49-01
files_modified:
  - Controllers/AdminController.cs
  - Views/Admin/AssessmentMonitoringDetail.cshtml
  - Views/Admin/UserAssessmentHistory.cshtml
autonomous: true
requirements:
  - MDAT-03

must_haves:
  truths:
    - GET /Admin/AssessmentMonitoringDetail?title=X&category=Y&scheduleDate=Z shows live monitoring for all workers in the assessment group
    - POST /Admin/ResetAssessment/{id} resets a single session (clears responses, resets status to Open, archives attempt, logs audit)
    - POST /Admin/ForceCloseAssessment/{id} force-closes a single session (sets status Completed, logs audit)
    - POST /Admin/ForceCloseAll?title=X&category=Y&scheduleDate=Z force-closes all sessions in the group
    - GET /Admin/ExportAssessmentResults?title=X&category=Y&scheduleDate=Z returns Excel file with session results
    - GET /Admin/GetMonitoringProgress?title=X&category=Y&scheduleDate=Z returns JSON progress data for polling
    - GET /Admin/UserAssessmentHistory/{userId} shows individual worker's assessment attempt history
    - All Back/breadcrumb links in monitoring/history views point to /Admin/ManageAssessment (not /CMP/Assessment)
  artifacts:
    - Controllers/AdminController.cs (ResetAssessment, ForceCloseAssessment, ForceCloseAll, ExportAssessmentResults, GetMonitoringProgress, AssessmentMonitoringDetail, UserAssessmentHistory added)
    - Views/Admin/AssessmentMonitoringDetail.cshtml (new file)
    - Views/Admin/UserAssessmentHistory.cshtml (new file)
  key_links:
    - ManageAssessment.cshtml "Monitoring" links → AdminController.AssessmentMonitoringDetail
    - AssessmentMonitoringDetail.cshtml "Reset"/"Force Close" → AdminController POST actions
    - AssessmentMonitoringDetail.cshtml "History" link → AdminController.UserAssessmentHistory
---

<objective>
Add Monitoring, Reset, ForceClose, Export, and User History operations to AdminController (migrated 1:1 from CMPController). Create companion view files AssessmentMonitoringDetail.cshtml and UserAssessmentHistory.cshtml in Views/Admin/.

Purpose: Admin can monitor live assessment progress, reset or force-close individual sessions, export results to Excel, and view individual worker history — all from /Admin routes.
Output: Full monitoring and operations workflow at /Admin/* routes. All action buttons in ManageAssessment.cshtml from Plan 01 become functional.
</objective>

<context>
@Controllers/CMPController.cs — Source actions. Key line ranges:
- AssessmentMonitoringDetail GET: line ~403 (complex — builds MonitoringGroupViewModel with per-worker status, question counts, package detection)
- GetMonitoringProgress GET: line ~501 (JSON polling endpoint for live refresh)
- ResetAssessment POST: line ~598 (clears responses, resets status, creates AssessmentAttemptHistory, logs audit)
- ForceCloseAssessment POST: line ~698
- ExportAssessmentResults GET: line ~750 (ClosedXML Excel generation)
- ForceCloseAll POST: line ~879 (bulk force close for all sibling sessions)
- UserAssessmentHistory GET: line ~4431 (individual worker history — this action is in a different section of CMPController)

@Views/CMP/AssessmentMonitoringDetail.cshtml — Source view. Copy to Views/Admin/. Update all `asp-controller="CMP"` → `asp-controller="Admin"`. The BackUrl ViewBag must point to ManageAssessment (Plan 01 adds ManageAssessment, so the back button should point there).

@Views/CMP/UserAssessmentHistory.cshtml — Source view. Copy to Views/Admin/. Update all controller references.

Key pitfall: AssessmentMonitoringDetail in CMPController sets `ViewBag.BackUrl = Url.Action("Assessment", "CMP", new { view = "manage" })` at line ~494. AdminController must set `ViewBag.BackUrl = Url.Action("ManageAssessment", "Admin")`.
</context>

<tasks>

<task id="49-03-T1" type="auto">
  <name>Add AssessmentMonitoringDetail GET and GetMonitoringProgress to AdminController</name>
  <files>
    - Controllers/AdminController.cs
  </files>
  <action>
Copy from CMPController.cs into AdminController.cs:

1. `AssessmentMonitoringDetail(string title, string category, DateTime scheduleDate)` GET — line ~403
2. `GetMonitoringProgress(string title, string category, DateTime scheduleDate)` GET — line ~501

**Changes required:**
- Line ~494: `ViewBag.BackUrl = Url.Action("Assessment", "CMP", new { view = "manage" })` → `ViewBag.BackUrl = Url.Action("ManageAssessment", "Admin")`
- Any other CMP route references in these methods → Admin route references
- Keep ALL MonitoringGroupViewModel, MonitoringSessionViewModel construction logic UNCHANGED (package detection, question count maps, progress calculation are complex — copy verbatim)
- Keep all using statements needed — ensure MonitoringGroupViewModel and MonitoringSessionViewModel are accessible (they are defined in the project's Models or ViewModels folder)

Check that MonitoringGroupViewModel and MonitoringSessionViewModel are accessible from AdminController's namespace. If they require a using statement not already in AdminController.cs, add it.
  </action>
  <verify>
    <automated>cd /c/Users/Administrator/Desktop/PortalHC_KPB/.claude/worktrees/terminal-a && dotnet build --no-restore -v q 2>&1 | tail -10</automated>
  </verify>
  <done>Build succeeds. AdminController has AssessmentMonitoringDetail GET and GetMonitoringProgress GET.</done>
</task>

<task id="49-03-T2" type="auto">
  <name>Add ResetAssessment, ForceCloseAssessment, ForceCloseAll, ExportAssessmentResults, UserAssessmentHistory to AdminController</name>
  <files>
    - Controllers/AdminController.cs
  </files>
  <action>
Copy from CMPController.cs into AdminController.cs:

1. `ResetAssessment(int id)` POST — line ~598 (archives attempt to AssessmentAttemptHistory, clears UserResponses and UserPackageAssignments, resets session state, logs audit)
2. `ForceCloseAssessment(int id)` POST — line ~698
3. `ForceCloseAll(string title, string category, DateTime scheduleDate)` POST — line ~879
4. `ExportAssessmentResults(string title, string category, DateTime scheduleDate)` GET — line ~750 (ClosedXML Excel export — this is a GET that returns a file)
5. `UserAssessmentHistory(string userId)` GET — line ~4431

**Changes required for all actions:**
- `RedirectToAction("AssessmentMonitoringDetail", "CMP", ...)` → `RedirectToAction("AssessmentMonitoringDetail", "Admin", ...)`
- `RedirectToAction("Assessment", new { view = "manage" })` → `RedirectToAction("ManageAssessment")`
- `RedirectToAction("Assessment", "CMP", ...)` → `RedirectToAction("ManageAssessment", "Admin")`
- Any other CMP route references → Admin route references

**ResetAssessment specifics:** This action creates an AssessmentAttemptHistory entry BEFORE clearing responses (archival before deletion). Copy the entire method verbatim — this is complex logic. Do NOT simplify.

**ExportAssessmentResults specifics:** Uses ClosedXML (XLWorkbook). ClosedXML is already in the project. This is a GET that returns `File(stream.ToArray(), "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", fileName)`. Copy verbatim.

**UserAssessmentHistory specifics:** Located at line ~4431 in CMPController — note this is far from the other manage actions. Copy the full method including UserAssessmentHistoryViewModel construction.
  </action>
  <verify>
    <automated>cd /c/Users/Administrator/Desktop/PortalHC_KPB/.claude/worktrees/terminal-a && dotnet build --no-restore -v q 2>&1 | tail -10</automated>
  </verify>
  <done>Build succeeds. AdminController has ResetAssessment POST, ForceCloseAssessment POST, ForceCloseAll POST, ExportAssessmentResults GET, UserAssessmentHistory GET.</done>
</task>

<task id="49-03-T3" type="auto">
  <name>Create Views/Admin/AssessmentMonitoringDetail.cshtml and Views/Admin/UserAssessmentHistory.cshtml</name>
  <files>
    - Views/Admin/AssessmentMonitoringDetail.cshtml
    - Views/Admin/UserAssessmentHistory.cshtml
  </files>
  <action>
Copy Views/CMP/AssessmentMonitoringDetail.cshtml → Views/Admin/AssessmentMonitoringDetail.cshtml with these changes:
1. Replace ALL `asp-controller="CMP"` with `asp-controller="Admin"`
2. Replace ALL `Url.Action("...", "CMP", ...)` with `Url.Action("...", "Admin", ...)`
3. Update breadcrumb: "Admin > Kelola Data > Manage Assessments > Monitoring Detail"
   - "Kelola Data" links to Url.Action("Index", "Admin")
   - "Manage Assessments" links to Url.Action("ManageAssessment", "Admin")
4. Back button: link to ViewBag.BackUrl (which AdminController sets to /Admin/ManageAssessment)
5. All Reset/ForceClose/ForceCloseAll POST form actions: point to Admin controller
   - `<form asp-action="ResetAssessment" asp-controller="Admin" asp-route-id="@session.Id">`
   - `<form asp-action="ForceCloseAssessment" asp-controller="Admin" asp-route-id="@session.Id">`
   - `<form asp-action="ForceCloseAll" asp-controller="Admin" ...>`
6. GetMonitoringProgress polling URL: `@Url.Action("GetMonitoringProgress", "Admin", ...)` — ensure JavaScript AJAX call uses Admin controller
7. Keep ALL monitoring table structure, progress bars, polling JavaScript, per-worker status display UNCHANGED

Copy Views/CMP/UserAssessmentHistory.cshtml → Views/Admin/UserAssessmentHistory.cshtml with these changes:
1. Replace ALL `asp-controller="CMP"` with `asp-controller="Admin"`
2. Update breadcrumb: "Admin > Kelola Data > Manage Assessments > Riwayat Assessment"
3. Back button: link to Url.Action("ManageAssessment", "Admin") or ViewBag.BackUrl if set
4. Keep ALL history table structure UNCHANGED

After copying, run: `grep -r 'asp-controller="CMP"\|"CMP", ' Views/Admin/AssessmentMonitoringDetail.cshtml Views/Admin/UserAssessmentHistory.cshtml` — expected: zero output.
  </action>
  <verify>
    <automated>cd /c/Users/Administrator/Desktop/PortalHC_KPB/.claude/worktrees/terminal-a && dotnet build --no-restore -v q 2>&1 | tail -5 && grep -c 'asp-controller="CMP"' Views/Admin/AssessmentMonitoringDetail.cshtml Views/Admin/UserAssessmentHistory.cshtml 2>/dev/null || echo "files checked"</automated>
  </verify>
  <done>Build succeeds. Views/Admin/AssessmentMonitoringDetail.cshtml and Views/Admin/UserAssessmentHistory.cshtml exist. Zero CMP controller references in both files. Breadcrumbs show Admin > Kelola Data > Manage Assessments path.</done>
</task>

</tasks>

<verification>

## Build Check

```bash
cd /c/Users/Administrator/Desktop/PortalHC_KPB/.claude/worktrees/terminal-a && dotnet build --no-restore -v q 2>&1 | tail -10
```

Expected: 0 errors.

## CMP Reference Check in Admin Views

```bash
grep -r 'asp-controller="CMP"' /c/Users/Administrator/Desktop/PortalHC_KPB/.claude/worktrees/terminal-a/Views/Admin/ 2>/dev/null
```

Expected: no output.

## Manual Spot Check

1. Navigate to /Admin/AssessmentMonitoringDetail?title=X&category=Y&scheduleDate=2026-02-26 (for a real assessment) — monitoring table renders
2. Polling endpoint GET /Admin/GetMonitoringProgress?... — returns JSON with progress data
3. GET /Admin/ExportAssessmentResults?... — triggers Excel download
4. GET /Admin/UserAssessmentHistory/{validUserId} — renders history page

</verification>

<success_criteria>
- AdminController has all 7 new actions: AssessmentMonitoringDetail, GetMonitoringProgress, ResetAssessment, ForceCloseAssessment, ForceCloseAll, ExportAssessmentResults, UserAssessmentHistory
- Views/Admin/AssessmentMonitoringDetail.cshtml renders with Admin breadcrumb and correct Reset/ForceClose form targets
- Views/Admin/UserAssessmentHistory.cshtml renders with Admin breadcrumb
- All Back links point to /Admin/ManageAssessment
- Build succeeds with 0 errors
</success_criteria>
