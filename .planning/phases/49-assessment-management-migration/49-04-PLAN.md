---
phase: 49-assessment-management-migration
plan: 04
type: execute
wave: 3
depends_on:
  - 49-02
  - 49-03
files_modified:
  - Controllers/AdminController.cs
  - Controllers/CMPController.cs
  - Views/Admin/AuditLog.cshtml
  - Views/CMP/Assessment.cshtml
  - Views/CMP/Index.cshtml
autonomous: true
requirements: []

must_haves:
  truths:
    - GET /Admin/AuditLog shows all global audit entries (paginated, ordered by date desc) with Kelola Data style
    - GET /CMP/AuditLog returns HTTP 404 or redirect (action removed from CMPController)
    - CMP/Assessment is pure personal view — no Manage toggle button, no canManage logic, no manage-related UI elements visible
    - CMP/Assessment view parameter "manage" no longer handled — CMPController.Assessment only serves personal view
    - CMP/Index "Assessment Lobby" card renamed to "My Assessments" with link to /CMP/Assessment (personal)
    - CMP/Index "Manage Assessments" card removed entirely
    - All manage-related actions (CreateAssessment, EditAssessment, DeleteAssessment, DeleteAssessmentGroup, ResetAssessment, ForceCloseAssessment, ForceCloseAll, ExportAssessmentResults, AssessmentMonitoringDetail, GetMonitoringProgress, RegenerateToken, UserAssessmentHistory, AuditLog) removed from CMPController
  artifacts:
    - Controllers/AdminController.cs (AuditLog GET added)
    - Controllers/CMPController.cs (manage-related actions removed, Assessment action simplified to personal-only)
    - Views/Admin/AuditLog.cshtml (new file — relocated from CMP)
    - Views/CMP/Assessment.cshtml (manage-mode UI elements removed)
    - Views/CMP/Index.cshtml (card renamed + card removed)
  key_links:
    - AdminController.AuditLog → Views/Admin/AuditLog.cshtml
    - ManageAssessment.cshtml "Audit Log" button (from Plan 01) → /Admin/AuditLog (now functional)
---

<objective>
Complete the migration: relocate AuditLog from CMP to Admin, clean up CMPController by removing all migrate actions, strip manage-mode UI from CMP/Assessment view, and update CMP/Index cards.

Purpose: CMPController becomes a personal-view-only controller for workers. All admin manage operations are exclusively in AdminController. CMP/Assessment is a clean personal view with no manage elements.
Output: Migration 100% complete. CMP is personal-only. Admin is the single source for assessment management.
</objective>

<context>
@Controllers/CMPController.cs — Actions to REMOVE:
  - CreateAssessment GET (line ~1997) — now in AdminController
  - CreateAssessment POST (line ~2031) — now in AdminController
  - EditAssessment GET (line ~1533) — now in AdminController
  - EditAssessment POST (line ~1596) — now in AdminController
  - DeleteAssessment POST (line ~1773) — now in AdminController
  - DeleteAssessmentGroup POST (line ~1854) — now in AdminController
  - RegenerateToken POST (line ~1934) — now in AdminController
  - AuditLog GET (line ~1969) — now in AdminController
  - AssessmentMonitoringDetail GET (line ~403) — now in AdminController
  - GetMonitoringProgress GET (line ~501) — now in AdminController
  - ResetAssessment POST (line ~598) — now in AdminController
  - ForceCloseAssessment POST (line ~698) — now in AdminController
  - ForceCloseAll POST (line ~879) — now in AdminController
  - ExportAssessmentResults GET (line ~750) — now in AdminController
  - UserAssessmentHistory GET (line ~4431) — now in AdminController

  Assessment() action (line ~96): Remove the `view == "manage"` branch entirely. Keep ONLY the personal view branch. Remove `canManage`, `viewMode` ViewBag, manage-related query logic.

@Views/CMP/Assessment.cshtml — Remove all manage-mode sections:
  - Lines with `viewMode == "manage"` conditionals → delete entire if blocks
  - `canManage` check and "Manage Assessments" button (lines ~36-55) → delete
  - Hidden `view` input and `viewMode` route parameters from search/pagination links → remove
  - ManagementData table/section (the entire `@if (viewMode == "manage" && canManage)` block, line ~86+) → delete entire block
  - Keep ONLY: personal view table (worker's own assessments), search bar, pagination, empty state

@Views/CMP/Index.cshtml — Update cards:
  - "Assessment Lobby" card (lines ~58-76): rename text to "My Assessments", update link if needed (keep pointing to /CMP/Assessment personal view)
  - "Manage Assessments" card (lines ~79-96+): REMOVE entirely

@Views/CMP/AuditLog.cshtml — Source for Admin/AuditLog.cshtml. Copy and update breadcrumb + style.
</context>

<tasks>

<task id="49-04-T1" type="auto">
  <name>Add AuditLog GET to AdminController and create Views/Admin/AuditLog.cshtml</name>
  <files>
    - Controllers/AdminController.cs
    - Views/Admin/AuditLog.cshtml
  </files>
  <action>
**AdminController.cs — Add AuditLog action:**

Copy CMPController.AuditLog GET (line ~1969) verbatim into AdminController after the ManageAssessment action. No route/redirect changes needed (AuditLog has no redirects). AdminController class-level [Authorize(Roles="Admin")] already protects it.

```csharp
// GET /Admin/AuditLog
[HttpGet]
public async Task<IActionResult> AuditLog(int page = 1)
{
    const int pageSize = 25;

    var totalCount = await _context.AuditLogs.CountAsync();
    var totalPages = (int)Math.Ceiling(totalCount / (double)pageSize);

    var logs = await _context.AuditLogs
        .OrderByDescending(l => l.CreatedAt)
        .Skip((page - 1) * pageSize)
        .Take(pageSize)
        .ToListAsync();

    ViewBag.Logs = logs;
    ViewBag.CurrentPage = page;
    ViewBag.TotalPages = totalPages;
    ViewBag.TotalCount = totalCount;

    return View();
}
```

(Copy exact source from CMPController.cs line ~1969 — the above is from RESEARCH.md Example 5.)

**Views/Admin/AuditLog.cshtml — Create by copying Views/CMP/AuditLog.cshtml with changes:**
1. Breadcrumb: "Admin > Kelola Data > Manage Assessments > Audit Log"
   - "Kelola Data" links to Url.Action("Index", "Admin")
   - "Manage Assessments" links to Url.Action("ManageAssessment", "Admin")
2. Replace ALL `asp-controller="CMP"` with `asp-controller="Admin"`
3. Keep the audit log table structure UNCHANGED (columns: Tanggal, Aktor, Aksi, Deskripsi, Target, etc.)
4. ViewData["Title"] = "Audit Log"; ViewData["ContainerClass"] = "container-fluid" (or match source)
5. Pagination links: point to current page preserving ?page= parameter at /Admin/AuditLog
  </action>
  <verify>
    <automated>cd /c/Users/Administrator/Desktop/PortalHC_KPB/.claude/worktrees/terminal-a && dotnet build --no-restore -v q 2>&1 | tail -5</automated>
  </verify>
  <done>Build succeeds. AdminController has AuditLog GET. Views/Admin/AuditLog.cshtml exists. /Admin/AuditLog returns HTTP 200 (requires Admin role).</done>
</task>

<task id="49-04-T2" type="auto">
  <name>Remove all manage actions from CMPController and simplify Assessment() to personal-only</name>
  <files>
    - Controllers/CMPController.cs
  </files>
  <action>
**Step 1 — Simplify CMPController.Assessment() (line ~96):**

The Assessment() action currently has two branches: `if (view == "manage")` (lines ~125-402) and the personal view branch (lines ~402+). Remove ONLY the manage branch:
- Remove the `view` parameter from the action signature (or keep it but ignore it — removing is cleaner)
- Delete the `if (view == "manage" && isHCAccess)` block entirely (the large block from ~125 to ~402 that sets ViewBag.ManagementData, MonitoringData, etc.)
- Remove `ViewBag.CanManage = isHCAccess;` (no longer needed)
- Remove `ViewBag.ViewMode` setting
- Keep the personal view query (the `else` branch logic) and simplify it to always run
- Remove the `isHCAccess` check if it was only used for the manage branch (if it was also used for personal view gating, check before removing)

Result: Assessment() returns only personal view data (worker's own active sessions + completed history).

**Step 2 — Delete manage-related action methods from CMPController:**

Delete these complete method bodies (including their [HttpGet]/[HttpPost]/[ValidateAntiForgeryToken] attributes):
- AssessmentMonitoringDetail (line ~403–500)
- GetMonitoringProgress (line ~501–597)
- ResetAssessment POST (line ~598–697)
- ForceCloseAssessment POST (line ~698–749)
- ExportAssessmentResults GET (line ~750–878)
- ForceCloseAll POST (line ~879–924)
- The long "shuffle/regenerate" action after ForceCloseAll (lines ~925-1532) — check if this is RegenerateToken or another action; delete only manage-specific actions
- EditAssessment GET (line ~1533–1595)
- EditAssessment POST (line ~1596–1772)
- DeleteAssessment POST (line ~1773–1853)
- DeleteAssessmentGroup POST (line ~1854–1933)
- RegenerateToken POST (line ~1934–1968)
- AuditLog GET (line ~1969–1996)
- CreateAssessment GET (line ~1997–2030)
- CreateAssessment POST (line ~2031–2370)
- UserAssessmentHistory GET (line ~4431–end of that method)

IMPORTANT: Read the actual line ranges before deleting. Use the line numbers from the grep output above as approximate. Verify each deletion does not accidentally remove non-manage actions (e.g., training record actions at ~2371+, exam actions, worker management actions). Only delete methods that are being migrated to AdminController.

After deletion, build to confirm no compilation errors. If there are missing type/method errors, check if any remaining CMP methods reference deleted actions (unlikely but possible).
  </action>
  <verify>
    <automated>cd /c/Users/Administrator/Desktop/PortalHC_KPB/.claude/worktrees/terminal-a && dotnet build --no-restore -v q 2>&1 | tail -10</automated>
  </verify>
  <done>Build succeeds. CMPController no longer contains CreateAssessment, EditAssessment, DeleteAssessment, DeleteAssessmentGroup, ResetAssessment, ForceCloseAssessment, ForceCloseAll, ExportAssessmentResults, AssessmentMonitoringDetail, GetMonitoringProgress, RegenerateToken, AuditLog, UserAssessmentHistory methods. Assessment() action serves personal view only.</done>
</task>

<task id="49-04-T3" type="auto">
  <name>Strip manage-mode UI from CMP/Assessment.cshtml and update CMP/Index.cshtml cards</name>
  <files>
    - Views/CMP/Assessment.cshtml
    - Views/CMP/Index.cshtml
  </files>
  <action>
**Views/CMP/Assessment.cshtml — Remove manage-mode UI:**

The file currently has `viewMode` and `canManage` variables at the top. Remove all manage-mode conditionals:

1. At top of file, remove:
   - `var viewMode = ViewBag.ViewMode as string ?? "personal";`
   - `var canManage = ViewBag.CanManage as bool? ?? false;`
   - Update `ViewData["Title"] = "My Assessments";` (remove ternary — always personal)

2. Remove `@if (viewMode == "manage")` blocks in breadcrumb/header area (the ones that show "Manage Assessments" vs "My Assessments" as title).

3. Remove the `@if (canManage)` section that renders the "Manage Assessments" button (lines ~36-55 approximately).

4. In the search form: remove `<input type="hidden" name="view" value="@viewMode" />` and the view route parameter from all links.

5. Remove the entire `@if (viewMode == "manage" && canManage)` block (line ~86+) that renders the management table with grouped sessions, create button, reset/edit/delete buttons, etc. This is the large manage table section — delete entirely.

6. In pagination links: remove `view=@viewMode` from all href parameters. Links become: `?page=1`, `?search=X&page=N`, etc.

7. Keep ONLY: personal view table (worker's own assessment sessions list), search bar without view parameter, pagination without view parameter, empty state message for no assessments.

8. Ensure page title and breadcrumb say "My Assessments" (not "Manage Assessments").

**Views/CMP/Index.cshtml — Update cards:**

1. Find "Assessment Lobby" card text (line ~67 area) and rename to "My Assessments":
   - Change `<h5 class="mb-0">Assessment Lobby</h5>` → `<h5 class="mb-0">My Assessments</h5>`
   - Card link should remain pointing to `/CMP/Assessment` (personal view)
   - Update card description text if present (e.g., "Lihat assessment saya")

2. Find and REMOVE the entire "Manage Assessments" card block (lines ~79-96 area):
   - Delete the entire `<div class="col-md-4">...<h5>Manage Assessments</h5>...</div>` column div
   - This removes the HC/Admin "Manage Assessments" card from CMP Index entirely

After changes, verify no remaining `viewMode`, `canManage`, `view="manage"` references in Assessment.cshtml:
`grep -n "viewMode\|canManage\|view=.manage" Views/CMP/Assessment.cshtml` — expected: 0 results.
  </action>
  <verify>
    <automated>cd /c/Users/Administrator/Desktop/PortalHC_KPB/.claude/worktrees/terminal-a && dotnet build --no-restore -v q 2>&1 | tail -5 && grep -c "viewMode\|canManage\|view=\"manage\"" Views/CMP/Assessment.cshtml 2>/dev/null || echo "0"</automated>
  </verify>
  <done>Build succeeds. Views/CMP/Assessment.cshtml has zero manage-mode references (viewMode, canManage, view="manage"). Views/CMP/Index.cshtml shows "My Assessments" card (not "Assessment Lobby") and has no "Manage Assessments" card. CMP/Assessment personal view renders correctly for workers.</done>
</task>

</tasks>

<verification>

## Full Build Check

```bash
cd /c/Users/Administrator/Desktop/PortalHC_KPB/.claude/worktrees/terminal-a && dotnet build --no-restore -v q 2>&1 | tail -10
```

Expected: 0 errors.

## Manage Remnants Check in CMP Views

```bash
grep -rn "viewMode\|canManage\|view=\"manage\"\|Manage Assessments" /c/Users/Administrator/Desktop/PortalHC_KPB/.claude/worktrees/terminal-a/Views/CMP/Assessment.cshtml /c/Users/Administrator/Desktop/PortalHC_KPB/.claude/worktrees/terminal-a/Views/CMP/Index.cshtml 2>/dev/null
```

Expected: zero results for viewMode/canManage/view="manage". "Manage Assessments" should appear 0 times in Index.cshtml (card removed) and 0 times in Assessment.cshtml.

## Admin Routes Check

```bash
grep -n "public.*AuditLog\|public.*ManageAssessment\|public.*CreateAssessment\|public.*EditAssessment\|public.*DeleteAssessment\|public.*ResetAssessment\|public.*ForceClose\|public.*ExportAssessment\|public.*MonitoringDetail\|public.*UserAssessmentHistory" /c/Users/Administrator/Desktop/PortalHC_KPB/.claude/worktrees/terminal-a/Controllers/AdminController.cs
```

Expected: All 15+ manage actions present in AdminController.

## CMP Removal Check

```bash
grep -n "public.*CreateAssessment\|public.*EditAssessment\|public.*DeleteAssessment\|public.*ResetAssessment\|public.*AuditLog\|public.*MonitoringDetail" /c/Users/Administrator/Desktop/PortalHC_KPB/.claude/worktrees/terminal-a/Controllers/CMPController.cs
```

Expected: 0 results (all removed from CMPController).

## Manual End-to-End Checklist

- [ ] /Admin/ManageAssessment — shows grouped assessment list (Plan 01)
- [ ] /Admin/CreateAssessment — form renders, submission creates session, redirects to ManageAssessment
- [ ] /Admin/EditAssessment/{id} — form renders with existing data, save redirects to ManageAssessment
- [ ] /Admin/AssessmentMonitoringDetail?title=X&category=Y&scheduleDate=Z — live monitoring table
- [ ] /Admin/ExportAssessmentResults?... — Excel download
- [ ] /Admin/AuditLog — audit entries table with pagination
- [ ] /CMP/Assessment — shows only personal assessments (My Assessments), no Manage toggle button
- [ ] /CMP/Index — "My Assessments" card, no "Manage Assessments" card
- [ ] /Admin/Index — "Manage Assessments" card (no "Assessment Competency Map" Segera card)

</verification>

<success_criteria>
- /Admin/AuditLog renders all global audit entries (requires Admin role)
- /CMP/AuditLog returns 404 or redirect (removed from CMPController)
- CMPController has 0 manage-related assessment actions
- CMP/Assessment is personal-view-only (no manage toggle, no manage table, no canManage)
- CMP/Index shows "My Assessments" (renamed from "Assessment Lobby"), no "Manage Assessments" card
- Build succeeds with 0 errors
- All Phase 49 success criteria from ROADMAP.md satisfied: criteria 1-6
</success_criteria>
