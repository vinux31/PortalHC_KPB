---
phase: 49-assessment-management-migration
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - Views/Admin/CreateAssessment.cshtml
  - Views/Admin/ManageAssessment.cshtml
  - Controllers/AdminController.cs
  - Views/Admin/AssessmentMonitoringDetail.cshtml
autonomous: true
gap_closure: true
requirements:
  - MDAT-03

must_haves:
  truths:
    - "Success modal appears after submitting new assessment"
    - "Assessment Monitoring Detail loads correctly for any group (not dependent on representative session ID)"
    - "Export downloads Excel file even if representative session was deleted"
    - "UserAssessmentHistory is reachable from ManageAssessment participant list"
    - "Regenerate Token button only shows for token-enabled assessments"
  artifacts:
    - path: "Views/Admin/CreateAssessment.cshtml"
      provides: "Safe JSON island pattern for success modal data"
      contains: "script type=\"application/json\" id=\"createdAssessmentData\""
    - path: "Controllers/AdminController.cs"
      provides: "Composite key parameters for group-level actions"
      contains: "string title, string category, DateTime scheduleDate"
    - path: "Views/Admin/ManageAssessment.cshtml"
      provides: "View History links in participant rows, composite key links for Monitoring/Export"
      contains: "UserAssessmentHistory"
    - path: "Views/Admin/AssessmentMonitoringDetail.cshtml"
      provides: "Composite key form fields for ForceCloseAll and CloseEarly"
      contains: "name=\"title\""
  key_links:
    - from: "Views/Admin/ManageAssessment.cshtml"
      to: "AdminController.AssessmentMonitoringDetail"
      via: "query string ?title=&category=&scheduleDate="
      pattern: "title.*category.*scheduleDate"
    - from: "Views/Admin/ManageAssessment.cshtml"
      to: "AdminController.UserAssessmentHistory"
      via: "link per user in collapsed participant rows"
      pattern: "UserAssessmentHistory.*userId"
    - from: "Views/Admin/AssessmentMonitoringDetail.cshtml"
      to: "AdminController.ForceCloseAll"
      via: "hidden form fields with composite key"
      pattern: "name=\"title\""
---

<objective>
Fix 5 UAT gaps from Phase 49 verification: broken success modal (JS string literal issue), fragile representative ID lookups (Monitoring/Export/ForceCloseAll/CloseEarly), missing UserAssessmentHistory link, and unconditional Regenerate Token button.

Purpose: All assessment management features work reliably regardless of database state (deleted representative sessions), and all UI flows are reachable.
Output: Patched AdminController, CreateAssessment, ManageAssessment, and AssessmentMonitoringDetail views.
</objective>

<execution_context>
@C:/Users/Administrator/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Administrator/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/49-assessment-management-migration/49-UAT.md

Key codebase context:
- AdminController.cs (2300 lines) has all assessment management actions
- ManageAssessment groups assessments by (Title, Category, Schedule.Date) composite key
- Each group has a RepresentativeId (first session's Id) which is fragile -- if that session is deleted, lookups fail
- GetMonitoringProgress already uses composite key (title, category, scheduleDate) -- proven pattern
- AssessmentMonitoringDetail.cshtml already has hidden fields for polling with composite key (lines 274-276)
- ResetAssessment and ForceCloseAssessment use session-level `int id` (correct -- they target individual sessions, not groups)
</context>

<interfaces>
<!-- Key types and contracts the executor needs -->

From Controllers/AdminController.cs (ManageAssessment GET, line 297-318):
```csharp
// Group anonymous type includes:
// Title, Category, Schedule, ExamWindowCloseDate, DurationMinutes, Status,
// IsTokenRequired, AccessToken, PassPercentage, AllowAnswerReview,
// RepresentativeId (= rep.Id), Users (list of {UserFullName, UserEmail, UserId}),
// AllIds, UserCount
```

From Models/AssessmentMonitoringViewModel.cs:
```csharp
public class MonitoringGroupViewModel
{
    public int RepresentativeId { get; set; }
    public string Title { get; set; }
    public string Category { get; set; }
    public DateTime Schedule { get; set; }
    // ... other properties
}
```

Actions to change from `int id` to composite key:
- AssessmentMonitoringDetail (line 1225)
- ExportAssessmentResults (line 1602)
- ForceCloseAll (line 1557)
- CloseEarly (line 1818)

Actions that stay with `int id` (session-level, NOT group-level):
- ResetAssessment (line 1426) -- targets individual session
- ForceCloseAssessment (line 1515) -- targets individual session

RedirectToAction calls to update (8 occurrences, lines 1437, 1509, 1526, 1551, 1573, 1597, 1837, 2062):
- These redirect to AssessmentMonitoringDetail and currently pass `new { id }`.
- After fix, ResetAssessment and ForceCloseAssessment need to look up the session's title/category/scheduleDate before redirecting.
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Fix CreateAssessment success modal and add UserAssessmentHistory links</name>
  <files>
    Views/Admin/CreateAssessment.cshtml
    Views/Admin/ManageAssessment.cshtml
  </files>
  <action>
**CreateAssessment.cshtml -- Fix success modal (line 733 area):**

Replace the unsafe JS string literal pattern:
```javascript
var createdData = '@Html.Raw(ViewBag.CreatedAssessment ?? "")';
```

With a safe JSON island pattern. Add a `<script type="application/json" id="createdAssessmentData">` block BEFORE the main script block (around line 700, just before the closing `}` of the Razor section or in the Scripts section). The block should contain:
```html
<script type="application/json" id="createdAssessmentData">@Html.Raw(ViewBag.CreatedAssessment ?? "")</script>
```

Then update the JS to read from it:
```javascript
var el = document.getElementById('createdAssessmentData');
var createdData = el ? el.textContent.trim() : '';
```

This avoids the single-quote/double-quote conflict that causes SyntaxError when JSON data contains quotes.

**ManageAssessment.cshtml -- Add "View History" links (line 150-155 area):**

In the collapsed participant list (the `<ul>` inside `<div class="collapse">`), change each `<li>` from:
```html
<li><i class="bi bi-person me-1"></i>@u.UserFullName (@u.UserEmail)</li>
```
to:
```html
<li class="d-flex justify-content-between align-items-center">
    <span><i class="bi bi-person me-1"></i>@u.UserFullName (@u.UserEmail)</span>
    <a href="@Url.Action("UserAssessmentHistory", "Admin", new { userId = u.UserId })"
       class="btn btn-link btn-sm p-0 text-muted" title="Riwayat Assessment">
        <i class="bi bi-clock-history"></i>
    </a>
</li>
```

**ManageAssessment.cshtml -- Conditional Regenerate Token button (line 183-188):**

Wrap the existing Regenerate Token `<li>` block in:
```razor
@if ((bool)group.IsTokenRequired)
{
    <li>
        <button type="button" class="dropdown-item text-warning btn-regenerate-token"
                data-id="@group.RepresentativeId">
            <i class="bi bi-arrow-repeat me-2"></i>Regenerate Token
        </button>
    </li>
}
```
  </action>
  <verify>
    Build with `dotnet build --configuration Release --no-restore` -- no errors.
    Verify CreateAssessment.cshtml contains `script type="application/json" id="createdAssessmentData"` and does NOT contain `var createdData = '@Html.Raw`.
    Verify ManageAssessment.cshtml contains `UserAssessmentHistory` link and `@if ((bool)group.IsTokenRequired)` guard.
  </verify>
  <done>
    Success modal uses safe JSON island pattern (no SyntaxError on quoted data).
    Each participant in the collapsed user list has a "View History" icon link to /Admin/UserAssessmentHistory?userId={userId}.
    Regenerate Token button only appears for token-enabled assessments.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate group-level actions from fragile representative ID to composite key</name>
  <files>
    Controllers/AdminController.cs
    Views/Admin/ManageAssessment.cshtml
    Views/Admin/AssessmentMonitoringDetail.cshtml
  </files>
  <action>
**AdminController.cs -- Change 4 group-level action signatures:**

1. **AssessmentMonitoringDetail** (line 1225): Change from `(int id)` to `(string title, string category, DateTime scheduleDate)`. Remove the `FindAsync(id)` lookup (lines 1227-1232). Instead, query sessions directly:
```csharp
public async Task<IActionResult> AssessmentMonitoringDetail(string title, string category, DateTime scheduleDate)
{
    var sessions = await _context.AssessmentSessions
        .Include(a => a.User)
        .Where(a => a.Title == title
                 && a.Category == category
                 && a.Schedule.Date == scheduleDate.Date)
        .ToListAsync();

    if (!sessions.Any())
    {
        TempData["Error"] = "Assessment group not found.";
        return RedirectToAction("ManageAssessment");
    }
    // ... rest of existing logic (line 1247 onward) remains unchanged
    // But update the ViewModel: set RepresentativeId = sessions.First().Id (for any remaining view usage)
```

2. **ExportAssessmentResults** (line 1602): Change from `(int id)` to `(string title, string category, DateTime scheduleDate)`. Remove `FindAsync(id)` lookup (lines 1604-1609). Query sessions directly by composite key (same pattern as above). The rest of the export logic (line 1625 onward) remains unchanged since it already uses `sessions` list.

3. **ForceCloseAll** (line 1557): Change from `(int id)` to `(string title, string category, DateTime scheduleDate)`. Remove `FindAsync(id)` (line 1559-1560). Query sessions directly:
```csharp
var sessionsToClose = await _context.AssessmentSessions
    .Where(a => a.Title == title
             && a.Category == category
             && a.Schedule.Date == scheduleDate.Date
             && (a.Status == "Open" || a.Status == "InProgress"))
    .ToListAsync();
```

4. **CloseEarly** (line 1818): Change from `(int id)` to `(string title, string category, DateTime scheduleDate)`. Remove `FindAsync(id)` (lines 1820-1825). Query `allSessions` directly by composite key.

**AdminController.cs -- Update ALL RedirectToAction calls:**

Every `RedirectToAction("AssessmentMonitoringDetail", new { id })` must change to pass composite key. There are 8 occurrences (lines 1437, 1509, 1526, 1551, 1573, 1597, 1837, 2062).

For ResetAssessment (line 1437, 1509) and ForceCloseAssessment (line 1526, 1551): These actions still take `int id` (session-level). After performing the operation, they need the session's title/category/schedule to redirect. The `assessment` variable is already loaded by `FindAsync(id)` earlier in those methods, so use:
```csharp
return RedirectToAction("AssessmentMonitoringDetail", new {
    title = assessment.Title,
    category = assessment.Category,
    scheduleDate = assessment.Schedule.Date.ToString("yyyy-MM-dd")
});
```

For ForceCloseAll (line 1573, 1597): Since ForceCloseAll now receives composite key params directly, just pass them through:
```csharp
return RedirectToAction("AssessmentMonitoringDetail", new { title, category, scheduleDate });
```

For CloseEarly (line 1837, 2062): Same as ForceCloseAll -- pass through composite key params.

**ManageAssessment.cshtml -- Update Monitoring and Export links (lines 172-181):**

Change the Monitoring link from:
```html
<a class="dropdown-item" asp-action="AssessmentMonitoringDetail" asp-controller="Admin"
   asp-route-id="@group.RepresentativeId">
```
to:
```html
<a class="dropdown-item" href="@Url.Action("AssessmentMonitoringDetail", "Admin", new { title = (string)group.Title, category = (string)group.Category, scheduleDate = ((DateTime)group.Schedule).Date.ToString("yyyy-MM-dd") })">
```

Change the Export link similarly from `asp-route-id` to composite key query params.

**AssessmentMonitoringDetail.cshtml -- Update ForceCloseAll form (line 132-139):**

Replace `<input type="hidden" name="id" value="@Model.RepresentativeId" />` with:
```html
<input type="hidden" name="title" value="@Model.Title" />
<input type="hidden" name="category" value="@Model.Category" />
<input type="hidden" name="scheduleDate" value="@Model.Schedule.ToString("yyyy-MM-dd")" />
```

**AssessmentMonitoringDetail.cshtml -- Update CloseEarly form (line 345-351):**

Replace `<input type="hidden" name="id" value="@Model.RepresentativeId" />` with:
```html
<input type="hidden" name="title" value="@Model.Title" />
<input type="hidden" name="category" value="@Model.Category" />
<input type="hidden" name="scheduleDate" value="@Model.Schedule.ToString("yyyy-MM-dd")" />
```

Note: The Export form in AssessmentMonitoringDetail (lines 115-122) already uses composite key hidden fields -- no change needed.
Note: ResetAssessment and ForceCloseAssessment forms in AssessmentMonitoringDetail (lines 234-251) correctly use `session.Id` (individual session level) -- no change needed.
Note: The JS-rendered action buttons (line 496-505) use `/Admin/ForceCloseAssessment` and `/Admin/ResetAssessment` with session IDs -- no change needed.
  </action>
  <verify>
    Build with `dotnet build --configuration Release --no-restore` -- no errors.
    Verify AdminController.cs: grep for `AssessmentMonitoringDetail(string title` confirms composite key signature.
    Verify AdminController.cs: grep for `FindAsync(id)` in AssessmentMonitoringDetail, ExportAssessmentResults, ForceCloseAll, CloseEarly should return 0 matches (the fragile pattern is gone).
    Verify ManageAssessment.cshtml: Monitoring link uses `title =` query params instead of `asp-route-id`.
    Verify AssessmentMonitoringDetail.cshtml: ForceCloseAll and CloseEarly forms use `name="title"` instead of `name="id"`.
  </verify>
  <done>
    All group-level actions (AssessmentMonitoringDetail, ExportAssessmentResults, ForceCloseAll, CloseEarly) use resilient composite key (title, category, scheduleDate) instead of fragile representative session ID.
    All RedirectToAction calls pass composite key parameters.
    ManageAssessment links and AssessmentMonitoringDetail forms updated to match new signatures.
    Individual session actions (ResetAssessment, ForceCloseAssessment) remain unchanged with session-level `int id`.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build --configuration Release --no-restore` succeeds with 0 errors
2. CreateAssessment.cshtml uses JSON island pattern (no `'@Html.Raw'` string literal)
3. ManageAssessment.cshtml has UserAssessmentHistory links per participant
4. ManageAssessment.cshtml has IsTokenRequired guard on Regenerate Token button
5. AdminController.cs group-level actions accept composite key parameters
6. No remaining `FindAsync(id)` in AssessmentMonitoringDetail, ExportAssessmentResults, ForceCloseAll, or CloseEarly
7. All 8 RedirectToAction calls pass composite key (not `new { id }`)
</verification>

<success_criteria>
- Build succeeds with zero errors
- Success modal pattern is XSS-safe and quote-safe (JSON island)
- All group-level navigation uses composite key (title + category + scheduleDate)
- UserAssessmentHistory is reachable from ManageAssessment participant list
- Regenerate Token only visible for token-enabled assessments
</success_criteria>

<output>
After completion, create `.planning/phases/49-assessment-management-migration/49-05-SUMMARY.md`
</output>
