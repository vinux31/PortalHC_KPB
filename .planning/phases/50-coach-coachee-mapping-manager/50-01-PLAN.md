---
phase: 50-coach-coachee-mapping-manager
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Controllers/AdminController.cs
  - Views/Admin/CoachCoacheeMapping.cshtml
  - Views/Admin/Index.cshtml
autonomous: true
requirements:
  - OPER-01

must_haves:
  truths:
    - "Admin can navigate to /Admin/CoachCoacheeMapping and see a grouped-by-coach table of all active mappings"
    - "Each coach group is collapsible and shows coach name, section, and active coachee count in the header"
    - "Coachee rows show Name, NIP, Section, Position, Status, StartDate, and Actions columns"
    - "Section filter dropdown and text search narrow displayed results"
    - "Show-all toggle reveals inactive mappings alongside active ones"
    - "Pagination shows 20 coach groups per page"
    - "Admin/Index Section B card 'Coach-Coachee Mapping' links to /Admin/CoachCoacheeMapping and has no Segera badge"
  artifacts:
    - path: "Controllers/AdminController.cs"
      provides: "CoachCoacheeMapping GET action with grouped query, pagination, search, section filter"
      contains: "public async Task<IActionResult> CoachCoacheeMapping"
    - path: "Views/Admin/CoachCoacheeMapping.cshtml"
      provides: "Grouped-by-coach table with Bootstrap collapse, filter UI, pagination, modal HTML skeletons"
      min_lines: 150
    - path: "Views/Admin/Index.cshtml"
      provides: "Activated Coach-Coachee Mapping card in Section B"
      contains: "CoachCoacheeMapping"
  key_links:
    - from: "Views/Admin/Index.cshtml"
      to: "/Admin/CoachCoacheeMapping"
      via: "Url.Action link on card"
      pattern: "Url.Action.*CoachCoacheeMapping.*Admin"
    - from: "Views/Admin/CoachCoacheeMapping.cshtml"
      to: "ViewBag.GroupedCoaches"
      via: "Razor foreach rendering grouped coach rows"
      pattern: "ViewBag.GroupedCoaches"
    - from: "Controllers/AdminController.cs"
      to: "_context.CoachCoacheeMappings"
      via: "EF Core query with grouping"
      pattern: "CoachCoacheeMappings"
---

<objective>
Build the Coach-Coachee Mapping page scaffold: AdminController GET action with grouped-by-coach query, the CoachCoacheeMapping.cshtml view with Bootstrap collapse groups, filters, pagination, and modal HTML skeletons (Assign + Edit + Deactivate confirm). Activate the Admin/Index card.

Purpose: Establish the read-only display and page structure that Plan 02 will wire up with write endpoints.
Output: Working /Admin/CoachCoacheeMapping page showing grouped data, Admin/Index card activated.
</objective>

<execution_context>
@C:/Users/Administrator/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Administrator/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/50-coach-coachee-mapping-manager/50-CONTEXT.md
@.planning/phases/50-coach-coachee-mapping-manager/50-RESEARCH.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From Models/CoachCoacheeMapping.cs:
```csharp
public class CoachCoacheeMapping
{
    public int Id { get; set; }
    public string CoachId { get; set; } = "";
    public string CoacheeId { get; set; } = "";
    public bool IsActive { get; set; } = true;
    public DateTime StartDate { get; set; }
    public DateTime? EndDate { get; set; }
}
```

From Models/ApplicationUser.cs (relevant fields):
```csharp
public string FullName { get; set; } = string.Empty;
public string? NIP { get; set; }
public string? Section { get; set; }
public string? Position { get; set; }
public int RoleLevel { get; set; }
```

From Models/ProtonModels.cs (ProtonTrack for modal dropdown):
```csharp
public class ProtonTrack
{
    public int Id { get; set; }
    public string TrackType { get; set; } = "";
    public string TahunKe { get; set; } = "";
    public string DisplayName { get; set; } = "";
    public int Urutan { get; set; }
}

public class ProtonTrackAssignment
{
    public int Id { get; set; }
    public string CoacheeId { get; set; } = "";
    public string AssignedById { get; set; } = "";
    public int ProtonTrackId { get; set; }
    public ProtonTrack? ProtonTrack { get; set; }
    public bool IsActive { get; set; } = true;
    public DateTime AssignedAt { get; set; } = DateTime.UtcNow;
}
```

From Models/CoachingSession.cs (for deactivation session count):
```csharp
public class CoachingSession
{
    public int Id { get; set; }
    public string CoachId { get; set; } = "";
    public string CoacheeId { get; set; } = "";
    public string Status { get; set; } = "Draft"; // "Draft", "Submitted"
    // ...
}
```

From Models/OrganizationStructure.cs:
```csharp
public static List<string> GetAllSections() // Returns ["RFCC", "GAST", "NGP", "DHT"]
```

From Services/AuditLogService.cs:
```csharp
public async Task LogAsync(string actorUserId, string actorName, string actionType,
    string description, int? targetId = null, string? targetType = null)
```

AdminController constructor dependencies (already injected):
```csharp
private readonly ApplicationDbContext _context;
private readonly UserManager<ApplicationUser> _userManager;
private readonly AuditLogService _auditLog;
private readonly IMemoryCache _cache;
```

Admin/Index.cshtml Section B card for Coach-Coachee Mapping (lines 68-81):
```html
<div class="col-md-4">
    <a href="#" class="text-decoration-none">
        <div class="card shadow-sm h-100 border-0 opacity-75">
            <div class="card-body">
                <div class="d-flex align-items-center gap-2 mb-2">
                    <i class="bi bi-people fs-5 text-primary"></i>
                    <span class="fw-bold">Coach-Coachee Mapping</span>
                    <span class="badge bg-secondary ms-auto" style="font-size:0.6rem;">Segera</span>
                </div>
                <small class="text-muted">Atur assignment coach ke coachee</small>
            </div>
        </div>
    </a>
</div>
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: AdminController GET action + Admin/Index card activation</name>
  <files>
    Controllers/AdminController.cs
    Views/Admin/Index.cshtml
  </files>
  <action>
**1. Add CoachCoacheeMapping GET action** to AdminController (append after the last existing action, before the closing `}` of the class).

```csharp
// ==================== COACH-COACHEE MAPPING ====================

// GET /Admin/CoachCoacheeMapping
[HttpGet]
public async Task<IActionResult> CoachCoacheeMapping(
    string? search, string? section, bool showAll = false, int page = 1)
{
    const int pageSize = 20;

    // 1. Load all users once (avoid N+1)
    var allUsers = await _context.Users
        .Select(u => new { u.Id, u.FullName, u.NIP, u.Section, u.Position, u.RoleLevel })
        .ToListAsync();
    var userDict = allUsers.ToDictionary(u => u.Id);

    // 2. Load mappings
    var query = _context.CoachCoacheeMappings.AsQueryable();
    if (!showAll)
        query = query.Where(m => m.IsActive);
    var mappings = await query.ToListAsync();

    // 3. Join with user data + apply filters
    var rows = mappings.Select(m => new {
        Mapping = m,
        Coach = userDict.GetValueOrDefault(m.CoachId),
        Coachee = userDict.GetValueOrDefault(m.CoacheeId)
    }).ToList();

    if (!string.IsNullOrEmpty(search))
    {
        var lower = search.ToLower();
        rows = rows.Where(r =>
            (r.Coach?.FullName?.ToLower().Contains(lower) ?? false) ||
            (r.Coachee?.FullName?.ToLower().Contains(lower) ?? false) ||
            (r.Coachee?.NIP?.ToLower().Contains(lower) ?? false))
            .ToList();
    }
    if (!string.IsNullOrEmpty(section))
    {
        rows = rows.Where(r =>
            r.Coach?.Section == section ||
            r.Coachee?.Section == section)
            .ToList();
    }

    // 4. Group by Coach, paginate over coach groups
    var grouped = rows
        .GroupBy(r => r.Mapping.CoachId)
        .Select(g => new {
            CoachId = g.Key,
            CoachName = g.First().Coach?.FullName ?? g.Key,
            CoachSection = g.First().Coach?.Section ?? "",
            ActiveCount = g.Count(r => r.Mapping.IsActive),
            Coachees = g.Select(r => new {
                r.Mapping.Id,
                r.Mapping.IsActive,
                r.Mapping.StartDate,
                r.Mapping.EndDate,
                r.Mapping.CoachId,
                CoacheeName = r.Coachee?.FullName ?? r.Mapping.CoacheeId,
                CoacheeNIP = r.Coachee?.NIP ?? "",
                CoacheeSection = r.Coachee?.Section ?? "",
                CoacheePosition = r.Coachee?.Position ?? "",
                r.Mapping.CoacheeId
            }).OrderBy(c => c.CoacheeName).ToList()
        })
        .OrderBy(g => g.CoachName)
        .ToList();

    var totalCoachGroups = grouped.Count;
    var totalPages = (int)Math.Ceiling(totalCoachGroups / (double)pageSize);
    if (page < 1) page = 1;
    if (page > totalPages && totalPages > 0) page = totalPages;
    var paged = grouped.Skip((page - 1) * pageSize).Take(pageSize).ToList();

    // 5. Modal data: eligible coaches, eligible coachees, proton tracks
    var activeCoacheeIds = await _context.CoachCoacheeMappings
        .Where(m => m.IsActive)
        .Select(m => m.CoacheeId)
        .Distinct()
        .ToListAsync();

    ViewBag.GroupedCoaches = paged;
    ViewBag.CurrentPage = page;
    ViewBag.TotalPages = totalPages;
    ViewBag.TotalCount = totalCoachGroups;
    ViewBag.ShowAll = showAll;
    ViewBag.SearchTerm = search;
    ViewBag.SectionFilter = section;
    ViewBag.Sections = OrganizationStructure.GetAllSections();
    ViewBag.EligibleCoaches = allUsers
        .Where(u => u.RoleLevel <= 5)
        .OrderBy(u => u.FullName).ToList();
    ViewBag.EligibleCoachees = allUsers
        .Where(u => !activeCoacheeIds.Contains(u.Id))
        .OrderBy(u => u.FullName).ToList();
    ViewBag.AllUsers = allUsers.OrderBy(u => u.FullName).ToList();
    ViewBag.ProtonTracks = await _context.ProtonTracks
        .OrderBy(t => t.Urutan).ToListAsync();

    return View();
}
```

**2. Activate Admin/Index card** (lines 68-81 in Views/Admin/Index.cshtml):
- Change `href="#"` to `href="@Url.Action("CoachCoacheeMapping", "Admin")"`.
- Remove `opacity-75` class from the card div.
- Remove the `<span class="badge bg-secondary ms-auto" style="font-size:0.6rem;">Segera</span>` line.

  </action>
  <verify>
    <automated>cd C:/Users/Administrator/Desktop/PortalHC_KPB && dotnet build --no-restore 2>&1 | tail -5</automated>
  </verify>
  <done>
    - AdminController has CoachCoacheeMapping GET action that loads grouped mappings with pagination, search, section filter, and showAll toggle
    - Admin/Index card links to /Admin/CoachCoacheeMapping with no Segera badge and no opacity
    - Build succeeds with no errors
  </done>
</task>

<task type="auto">
  <name>Task 2: CoachCoacheeMapping.cshtml view with grouped table, filters, modals, and pagination</name>
  <files>
    Views/Admin/CoachCoacheeMapping.cshtml
  </files>
  <action>
Create `Views/Admin/CoachCoacheeMapping.cshtml` with the following structure:

**Page header area:**
- Title "Coach-Coachee Mapping" with breadcrumb (Kelola Data > Coach-Coachee Mapping)
- Row with: Section filter dropdown (from ViewBag.Sections), text search input, "Show All" toggle checkbox, "Tambah Mapping" button (opens assign modal), "Export Excel" link to `/Admin/CoachCoacheeMappingExport`
- Summary badge: "X coach group(s)" count from ViewBag.TotalCount

**Filter form:**
- GET form submitting to self with `search`, `section`, `showAll` query params
- Reset page to 1 when section or showAll changes (JS: on change, set page hidden input to 1)
- Section dropdown uses `ViewBag.Sections` list
- Text search placeholder: "Cari nama coach/coachee..."

**Grouped table:**
- `<table class="table table-bordered align-middle">` with thead: Name, NIP, Section, Position, Status, Start Date, Actions
- For each coach group in `ViewBag.GroupedCoaches`:
  - Coach header row: `<tr class="table-primary" style="cursor:pointer;" data-bs-toggle="collapse" data-bs-target="#collapse-{loopIndex}">` with colspan=7 showing: chevron icon + `{CoachName} — {CoachSection} — {ActiveCount} coachee`
  - Coachee rows inside `<tbody class="collapse show" id="collapse-{loopIndex}">`. Use a `@{ var idx = 0; }` loop counter for HTML IDs (avoid GUID hyphens).
  - Each coachee row: Name, NIP, Section, Position, Status badge (Active=green, Inactive=secondary), StartDate formatted, Actions column with Edit button + Deactivate/Reactivate button
  - Inactive rows: add `class="table-light text-muted"` for visual distinction
  - Deactivate button: `onclick="confirmDeactivate({Id}, '{CoacheeName}')"` — opens deactivate confirmation modal
  - Reactivate button: `onclick="reactivateMapping({Id})"` — direct AJAX POST
  - Edit button: `onclick="openEditModal({Id}, '{CoachId}', {ProtonTrackId}, '{StartDate:yyyy-MM-dd}')"` — opens edit modal

**Empty state:** If no groups, show centered message "Belum ada mapping coach-coachee." with an icon.

**Pagination:** If TotalPages > 1, render Bootstrap pagination nav with Previous/Next and page numbers. Links preserve search, section, showAll query params.

**Assign Modal (HTML skeleton):**
- `id="assignModal"`, Bootstrap modal-lg
- Form fields:
  - Coach dropdown (`<select>` from `ViewBag.EligibleCoaches`) showing FullName + Section
  - Section filter dropdown (filters the coachee checklist below)
  - Coachee multi-select as checkbox list (`<div>` with scrollable list of checkboxes from `ViewBag.EligibleCoachees`), each checkbox has `data-section` attribute for JS filtering
  - Optional ProtonTrack dropdown (`<select>` from `ViewBag.ProtonTracks`) with empty first option "— Tanpa Track —"
  - StartDate input `type="date"` defaulting to today
- JS for coachee section filter: when section filter changes, hide/show coachee checkboxes by `data-section`
- Submit button "Simpan" — wired in Plan 02

**Edit Modal (HTML skeleton):**
- `id="editModal"`, Bootstrap modal
- Form fields:
  - Coachee name (read-only label, not editable)
  - Coach dropdown (`<select>` from `ViewBag.AllUsers` where RoleLevel <= 5 — use same EligibleCoaches list)
  - Optional ProtonTrack dropdown
  - StartDate input `type="date"`
  - Hidden input for MappingId
- Submit button "Simpan" — wired in Plan 02

**Deactivate Confirmation Modal (HTML skeleton):**
- `id="deactivateModal"`, Bootstrap modal
- Text: "Apakah Anda yakin ingin menonaktifkan mapping ini?"
- Placeholder for active session count (filled by JS)
- Confirm button "Nonaktifkan" + Cancel button — wired in Plan 02

**AntiForgeryToken:** Include `@Html.AntiForgeryToken()` at top of view for AJAX POST security.

**JS section at bottom (`@section Scripts`):**
- `filterCoacheesBySection()`: filters coachee checkboxes in assign modal by selected section
- `openEditModal(id, coachId, trackId, startDate)`: populates edit modal fields and shows it
- `confirmDeactivate(id, name)`: populates deactivate modal and shows it
- Placeholder functions for AJAX POSTs (assign, edit, deactivate, reactivate) — stubs with `// Wired in Plan 02` comments
- Section filter JS: auto-submit form on section dropdown change

**Important implementation notes:**
- Use sequential loop counter `@{ var idx = 0; }` for collapse IDs, NOT GUID strings (GUID hyphens break CSS selectors)
- Use Razor auto-encoding for data attributes (`@item.Property`), NOT `Html.AttributeEncode`
- All date displays: `@coachee.StartDate.ToString("yyyy-MM-dd")`
- Page reloads on `showAll` checkbox change: use JS `this.form.submit()` on change event

  </action>
  <verify>
    <automated>cd C:/Users/Administrator/Desktop/PortalHC_KPB && dotnet build --no-restore 2>&1 | tail -5</automated>
  </verify>
  <done>
    - CoachCoacheeMapping.cshtml renders grouped-by-coach table with collapsible rows
    - Section filter, text search, showAll toggle, and pagination are functional
    - Assign, Edit, and Deactivate modals are present as HTML skeletons
    - Page is navigable at /Admin/CoachCoacheeMapping
    - Build succeeds
  </done>
</task>

</tasks>

<verification>
1. Navigate to /Admin and verify "Coach-Coachee Mapping" card in Section B links to /Admin/CoachCoacheeMapping (no Segera badge, no opacity)
2. Navigate to /Admin/CoachCoacheeMapping — page loads without errors
3. If mappings exist: grouped table shows coach headers with collapse behavior
4. If no mappings: empty state message displays
5. Section filter dropdown shows RFCC, GAST, NGP, DHT
6. Text search filters by coach/coachee name
7. Show All toggle reveals inactive mappings (if any)
8. Pagination renders when >20 coach groups
9. Assign modal opens on "Tambah Mapping" click (form skeleton present)
10. Edit modal opens on Edit button click (form skeleton present)
</verification>

<success_criteria>
- /Admin/CoachCoacheeMapping accessible and displays grouped mapping data
- All filter/search/pagination controls are functional
- Modal HTML skeletons are ready for Plan 02 to wire write endpoints
- Admin/Index card activated
- dotnet build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/50-coach-coachee-mapping-manager/50-01-SUMMARY.md`
</output>
