---
phase: 50-coach-coachee-mapping-manager
plan: 02
type: execute
wave: 2
depends_on:
  - 50-01
files_modified:
  - Controllers/AdminController.cs
  - Views/Admin/CoachCoacheeMapping.cshtml
autonomous: true
requirements:
  - OPER-01

must_haves:
  truths:
    - "Admin can assign one coach to multiple coachees via the Assign modal with optional ProtonTrack selection"
    - "Assign validates: no duplicate active mapping per coachee, no self-assign, coach must have eligible role"
    - "Admin can edit an existing mapping (change coach, track, start date) via the Edit modal"
    - "Admin can deactivate a mapping (soft delete: IsActive=false, EndDate=today) after seeing active session count"
    - "Admin can reactivate an inactive mapping (IsActive=true, EndDate=null)"
    - "ProtonTrackAssignment is created/overwritten when track is selected during assign or edit"
    - "Every assign/edit/deactivate/reactivate action writes an AuditLog entry"
    - "Admin can export all mappings (active + inactive) to Excel via Export button"
  artifacts:
    - path: "Controllers/AdminController.cs"
      provides: "CoachCoacheeMappingAssign, CoachCoacheeMappingEdit, CoachCoacheeMappingDeactivate, CoachCoacheeMappingReactivate, CoachCoacheeMappingExport POST/GET actions"
      contains: "CoachCoacheeMappingAssign"
    - path: "Views/Admin/CoachCoacheeMapping.cshtml"
      provides: "Wired modal JS for assign/edit/deactivate/reactivate AJAX calls + Export button href"
      contains: "CoachCoacheeMappingAssign"
  key_links:
    - from: "Views/Admin/CoachCoacheeMapping.cshtml"
      to: "/Admin/CoachCoacheeMappingAssign"
      via: "AJAX fetch POST from assign modal submit"
      pattern: "CoachCoacheeMappingAssign"
    - from: "Controllers/AdminController.cs"
      to: "_context.CoachCoacheeMappings"
      via: "EF Core AddRange + SaveChangesAsync for assign"
      pattern: "AddRange.*newMappings"
    - from: "Controllers/AdminController.cs"
      to: "_context.ProtonTrackAssignments"
      via: "Side-effect: deactivate existing + add new when track selected"
      pattern: "ProtonTrackAssignment"
    - from: "Controllers/AdminController.cs"
      to: "_auditLog.LogAsync"
      via: "Audit every state-changing action"
      pattern: "_auditLog.LogAsync"
    - from: "Controllers/AdminController.cs"
      to: "ClosedXML XLWorkbook"
      via: "Export Excel endpoint"
      pattern: "XLWorkbook"
---

<objective>
Wire all write operations for Coach-Coachee Mapping: Assign (bulk), Edit, Deactivate (soft delete with session count), Reactivate POST actions in AdminController with ProtonTrackAssignment side-effect and AuditLog. Add Excel export endpoint. Wire modal JS in the view to call these endpoints via AJAX.

Purpose: Complete the full CRUD functionality so Admin can manage all coach-coachee relationships.
Output: Fully functional Coach-Coachee Mapping page with all write operations, audit logging, and Excel export.
</objective>

<execution_context>
@C:/Users/Administrator/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Administrator/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/50-coach-coachee-mapping-manager/50-CONTEXT.md
@.planning/phases/50-coach-coachee-mapping-manager/50-RESEARCH.md
@.planning/phases/50-coach-coachee-mapping-manager/50-01-SUMMARY.md

<interfaces>
<!-- Key types and contracts from Plan 01 that this plan extends -->

From Models/CoachCoacheeMapping.cs:
```csharp
public class CoachCoacheeMapping
{
    public int Id { get; set; }
    public string CoachId { get; set; } = "";
    public string CoacheeId { get; set; } = "";
    public bool IsActive { get; set; } = true;
    public DateTime StartDate { get; set; }
    public DateTime? EndDate { get; set; }
}
```

From Models/ProtonModels.cs:
```csharp
public class ProtonTrackAssignment
{
    public int Id { get; set; }
    public string CoacheeId { get; set; } = "";
    public string AssignedById { get; set; } = "";
    public int ProtonTrackId { get; set; }
    public ProtonTrack? ProtonTrack { get; set; }
    public bool IsActive { get; set; } = true;
    public DateTime AssignedAt { get; set; } = DateTime.UtcNow;
}
```

From Models/CoachingSession.cs:
```csharp
public class CoachingSession
{
    public string CoachId { get; set; } = "";
    public string CoacheeId { get; set; } = "";
    public string Status { get; set; } = "Draft"; // "Draft", "Submitted"
}
```

From Services/AuditLogService.cs:
```csharp
public async Task LogAsync(string actorUserId, string actorName, string actionType,
    string description, int? targetId = null, string? targetType = null)
```

AdminController already has: `_context`, `_userManager`, `_auditLog`, `_cache` injected.
ClosedXML already imported in AdminController (`using ClosedXML.Excel;`).

AJAX pattern used in this project (from ManageAssessment, CpdpItems):
```javascript
fetch('/Admin/ActionName', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'RequestVerificationToken': document.querySelector('[name=__RequestVerificationToken]').value
    },
    body: JSON.stringify(payload)
})
.then(r => r.json())
.then(data => {
    if (data.success) location.reload();
    else alert(data.message);
});
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write endpoints — Assign, Edit, Deactivate, Reactivate, GetSessionCount, Export</name>
  <files>
    Controllers/AdminController.cs
  </files>
  <action>
Add the following actions to AdminController, below the CoachCoacheeMapping GET action added in Plan 01. Also add two DTO classes at the bottom of the AdminController file (inside the namespace, outside the class) or as nested classes.

**DTO classes** (add at the bottom of the file, inside the `HcPortal.Controllers` namespace):

```csharp
public class CoachAssignRequest
{
    public string CoachId { get; set; } = "";
    public List<string> CoacheeIds { get; set; } = new();
    public int? ProtonTrackId { get; set; }
    public DateTime? StartDate { get; set; }
}

public class CoachEditRequest
{
    public int MappingId { get; set; }
    public string CoachId { get; set; } = "";
    public int? ProtonTrackId { get; set; }
    public DateTime? StartDate { get; set; }
}
```

**1. CoachCoacheeMappingAssign POST** (bulk assign):
- Accept `[FromBody] CoachAssignRequest req`
- Validate: req not null, CoachId not empty, CoacheeIds not empty
- Validate: no self-assign (`req.CoacheeIds.Contains(req.CoachId)` returns error)
- Validate: no duplicate active mappings — query `_context.CoachCoacheeMappings.Where(m => req.CoacheeIds.Contains(m.CoacheeId) && m.IsActive)`. If any found, return error with names.
- Create `List<CoachCoacheeMapping>` via `req.CoacheeIds.Select(...)`, `StartDate = req.StartDate ?? DateTime.Today`, `IsActive = true`
- `_context.CoachCoacheeMappings.AddRange(newMappings)`
- **ProtonTrack side-effect:** If `req.ProtonTrackId.HasValue && req.ProtonTrackId.Value > 0`:
  - Deactivate existing: `_context.ProtonTrackAssignments.Where(a => req.CoacheeIds.Contains(a.CoacheeId) && a.IsActive)` → set `IsActive = false` for each
  - Add new: `req.CoacheeIds.Select(id => new ProtonTrackAssignment { CoacheeId = id, AssignedById = actor.Id, ProtonTrackId = req.ProtonTrackId.Value, IsActive = true, AssignedAt = DateTime.UtcNow })`
  - `_context.ProtonTrackAssignments.AddRange(newTracks)`
- Single `SaveChangesAsync()` for all changes
- AuditLog: `_auditLog.LogAsync(actor.Id, actor.FullName, "Assign", $"Assigned coach to {count} coachee(s)", targetType: "CoachCoacheeMapping")`
- Return `Json(new { success = true, message = $"{count} mapping berhasil dibuat." })`

**2. CoachCoacheeMappingEdit POST:**
- Accept `[FromBody] CoachEditRequest req`
- Find mapping by `req.MappingId`; return error if not found
- Validate: no self-assign (`req.CoachId == mapping.CoacheeId` returns error)
- Validate: if changing coach, check no other active mapping exists for the coachee with the new coach (avoid duplicate)
- Update fields: `mapping.CoachId = req.CoachId`, `mapping.StartDate = req.StartDate ?? mapping.StartDate`
- **ProtonTrack side-effect:** Same pattern as assign — if `req.ProtonTrackId.HasValue && req.ProtonTrackId.Value > 0`, deactivate existing for this coachee, add new.  If `req.ProtonTrackId == 0` or null, do nothing (keep existing track).
- `SaveChangesAsync()` + AuditLog with "Edit" action type, `targetId: mapping.Id`
- Return success JSON

**3. CoachCoacheeMappingGetSessionCount POST:**
- Accept `int id` (mapping ID)
- Find mapping, count active coaching sessions: `_context.CoachingSessions.CountAsync(s => s.CoachId == mapping.CoachId && s.CoacheeId == mapping.CoacheeId && s.Status == "Draft")`
- Return `Json(new { success = true, count = activeSessionCount })`
- Purpose: called before deactivation to show admin the session count in the confirmation modal

**4. CoachCoacheeMappingDeactivate POST:**
- Accept `int id`
- Find mapping; return error if not found or already inactive
- Set `mapping.IsActive = false`, `mapping.EndDate = DateTime.Today`
- `SaveChangesAsync()` + AuditLog with "Deactivate" action type, `targetId: id`
- Per Claude's Discretion: do NOT deactivate ProtonTrackAssignment (track stays, only coaching relationship ends)
- Return success JSON

**5. CoachCoacheeMappingReactivate POST:**
- Accept `int id`
- Find mapping; return error if not found or already active
- Validate: no other active mapping exists for the same coachee (1 coachee = 1 active coach rule)
- Set `mapping.IsActive = true`, `mapping.EndDate = null`
- `SaveChangesAsync()` + AuditLog with "Reactivate" action type, `targetId: id`
- Return success JSON

**6. CoachCoacheeMappingExport GET:**
- Load all mappings ordered by CoachId, then StartDate
- Load all users into dictionary (same pattern as GET action)
- Load active ProtonTrackAssignments keyed by CoacheeId for "Current Track" column
- Create ClosedXML workbook, worksheet "Coach-Coachee Mapping"
- Header row (bold, dark background): Coach Name, Coach Section, Coachee Name, Coachee NIP, Coachee Section, Coachee Position, Current Track, Status, Start Date, End Date
- Data rows: one row per mapping record, Status = "Active"/"Inactive"
- `ws.Columns().AdjustToContents()`
- Return `File(stream.ToArray(), "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", "CoachCoacheeMapping.xlsx")`

**All POST actions:** Add `[HttpPost]` and `[ValidateAntiForgeryToken]` attributes. Retrieve actor via `await _userManager.GetUserAsync(User)`.

  </action>
  <verify>
    <automated>cd C:/Users/Administrator/Desktop/PortalHC_KPB && dotnet build --no-restore 2>&1 | tail -5</automated>
  </verify>
  <done>
    - All 6 endpoints compile and are accessible
    - Assign creates bulk mappings with ProtonTrack side-effect
    - Edit updates mapping fields with track side-effect
    - Deactivate soft-deletes (IsActive=false, EndDate=today), does NOT touch ProtonTrack
    - Reactivate restores (IsActive=true, EndDate=null) with duplicate check
    - GetSessionCount returns draft session count for deactivation confirmation
    - Export downloads Excel with all mappings + Current Track column
    - All state-changing actions log to AuditLog
    - dotnet build succeeds
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire modal JS for Assign, Edit, Deactivate, Reactivate AJAX calls</name>
  <files>
    Views/Admin/CoachCoacheeMapping.cshtml
  </files>
  <action>
Update the `@section Scripts` block in CoachCoacheeMapping.cshtml to wire the modal stubs from Plan 01 to the actual POST endpoints from Task 1.

**Assign modal submit handler:**
```javascript
function submitAssign() {
    const coachId = document.getElementById('assignCoachId').value;
    const coacheeCheckboxes = document.querySelectorAll('#assignCoacheeList input[type=checkbox]:checked');
    const coacheeIds = Array.from(coacheeCheckboxes).map(cb => cb.value);
    const trackId = document.getElementById('assignTrackId').value;
    const startDate = document.getElementById('assignStartDate').value;

    if (!coachId) { alert('Pilih coach terlebih dahulu.'); return; }
    if (coacheeIds.length === 0) { alert('Pilih minimal satu coachee.'); return; }

    const payload = {
        CoachId: coachId,
        CoacheeIds: coacheeIds,
        ProtonTrackId: trackId ? parseInt(trackId) : null,
        StartDate: startDate || null
    };

    fetch('/Admin/CoachCoacheeMappingAssign', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'RequestVerificationToken': document.querySelector('[name=__RequestVerificationToken]').value
        },
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) location.reload();
        else alert(data.message);
    })
    .catch(err => alert('Terjadi kesalahan: ' + err.message));
}
```
- Wire assign modal's "Simpan" button to `onclick="submitAssign()"`

**Edit modal submit handler:**
```javascript
function submitEdit() {
    const mappingId = document.getElementById('editMappingId').value;
    const coachId = document.getElementById('editCoachId').value;
    const trackId = document.getElementById('editTrackId').value;
    const startDate = document.getElementById('editStartDate').value;

    const payload = {
        MappingId: parseInt(mappingId),
        CoachId: coachId,
        ProtonTrackId: trackId ? parseInt(trackId) : null,
        StartDate: startDate || null
    };

    fetch('/Admin/CoachCoacheeMappingEdit', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'RequestVerificationToken': document.querySelector('[name=__RequestVerificationToken]').value
        },
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) location.reload();
        else alert(data.message);
    })
    .catch(err => alert('Terjadi kesalahan: ' + err.message));
}
```
- Wire edit modal's "Simpan" button to `onclick="submitEdit()"`

**Deactivate flow (two-step: get session count, then confirm):**
```javascript
let deactivateTargetId = null;

function confirmDeactivate(id, name) {
    deactivateTargetId = id;
    document.getElementById('deactivateCoacheeName').textContent = name;
    document.getElementById('deactivateSessionInfo').textContent = 'Memuat...';

    // Fetch active session count
    fetch('/Admin/CoachCoacheeMappingGetSessionCount', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'RequestVerificationToken': document.querySelector('[name=__RequestVerificationToken]').value
        },
        body: 'id=' + id
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            const msg = data.count > 0
                ? `Coachee ini memiliki ${data.count} sesi coaching aktif (Draft).`
                : 'Tidak ada sesi coaching aktif.';
            document.getElementById('deactivateSessionInfo').textContent = msg;
        }
    });

    new bootstrap.Modal(document.getElementById('deactivateModal')).show();
}

function executeDeactivate() {
    if (!deactivateTargetId) return;

    fetch('/Admin/CoachCoacheeMappingDeactivate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'RequestVerificationToken': document.querySelector('[name=__RequestVerificationToken]').value
        },
        body: 'id=' + deactivateTargetId
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) location.reload();
        else alert(data.message);
    })
    .catch(err => alert('Terjadi kesalahan: ' + err.message));
}
```
- Wire deactivate modal's "Nonaktifkan" button to `onclick="executeDeactivate()"`

**Reactivate handler:**
```javascript
function reactivateMapping(id) {
    if (!confirm('Aktifkan kembali mapping ini?')) return;

    fetch('/Admin/CoachCoacheeMappingReactivate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'RequestVerificationToken': document.querySelector('[name=__RequestVerificationToken]').value
        },
        body: 'id=' + id
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) location.reload();
        else alert(data.message);
    })
    .catch(err => alert('Terjadi kesalahan: ' + err.message));
}
```

**Export button:** Ensure the "Export Excel" button/link has `href="@Url.Action("CoachCoacheeMappingExport", "Admin")"` (no JS needed — direct GET download).

**Replace Plan 01 stub comments** (`// Wired in Plan 02`) with the actual function implementations above.

**Important notes:**
- Use PascalCase property names in JSON payloads (matching C# model — project convention, no PropertyNameCaseInsensitive config)
- Deactivate/Reactivate/GetSessionCount use `application/x-www-form-urlencoded` with `body: 'id=' + id` because they accept a simple `int id` parameter (not [FromBody])
- Assign and Edit use `application/json` with `[FromBody]` because they accept complex objects
- After every successful POST, `location.reload()` refreshes the page to get fresh data (avoids stale coachee picker — per research pitfall guidance)

  </action>
  <verify>
    <automated>cd C:/Users/Administrator/Desktop/PortalHC_KPB && dotnet build --no-restore 2>&1 | tail -5</automated>
  </verify>
  <done>
    - Assign modal submits bulk assign via AJAX, page reloads on success
    - Edit modal submits mapping update via AJAX, page reloads on success
    - Deactivate flow: shows session count in confirmation modal, executes soft delete on confirm
    - Reactivate button sends AJAX POST, page reloads on success
    - Export button downloads Excel file
    - All modals display server-side validation errors via alert()
    - Build succeeds
  </done>
</task>

</tasks>

<verification>
1. Navigate to /Admin/CoachCoacheeMapping
2. Click "Tambah Mapping" — assign modal opens with coach dropdown, coachee checkboxes, track dropdown, start date
3. Select a coach, select 2+ coachees, submit — mappings appear in grouped table
4. Try assigning same coachee again — error "Coachee sudah memiliki coach aktif"
5. Try assigning coach to self — error "Coach tidak dapat menjadi coachee dirinya sendiri"
6. Click Edit on a coachee row — edit modal opens with pre-populated fields, change coach, submit — mapping updated
7. Click Deactivate on a coachee row — confirmation modal shows session count, click confirm — mapping becomes inactive (grey row, "Inactive" badge)
8. Toggle "Show All" — inactive mappings appear
9. Click Reactivate on inactive mapping — mapping becomes active again
10. Click "Export Excel" — XLSX file downloads with all mappings + Current Track column
11. Check /Admin/AuditLog — entries exist for assign, edit, deactivate, reactivate actions
</verification>

<success_criteria>
- Full CRUD operations work: Assign (bulk), Edit, Deactivate (soft delete), Reactivate
- ProtonTrackAssignment side-effect works on assign and edit when track selected
- AuditLog entries written for every state-changing action
- Excel export includes all mappings with Current Track column
- All validation rules enforced (no duplicate active, no self-assign, eligible coach roles)
- dotnet build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/50-coach-coachee-mapping-manager/50-02-SUMMARY.md`
</output>
