---
phase: 52-deliverableprogress-override
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Controllers/ProtonDataController.cs
  - Views/ProtonData/Index.cshtml
autonomous: true
requirements:
  - OPER-03

must_haves:
  truths:
    - "Admin/HC can see a third tab 'Coaching Proton Override' in /ProtonData page"
    - "Admin/HC can filter override table by Bagian > Unit > Track cascade and optionally by status (Semua / Hanya Rejected / Hanya Pending HC)"
    - "Admin/HC can see per-worker rows with deliverable status badges (Active=blue, Submitted=yellow, Approved=green, Rejected=red)"
    - "Admin/HC can click any badge to open a modal showing full record context (status, evidence, timestamps, approver, HC reviewer, rejection reason)"
    - "Admin/HC can override status (Active/Submitted/Approved/Rejected) and HC status (Pending/Reviewed) with mandatory 'Alasan Override' textarea"
    - "Override auto-fills timestamps correctly (Approved→ApprovedAt+ApprovedById, Rejected→RejectedAt, Submitted→SubmittedAt, Active→clears all timestamps)"
    - "Override is logged to AuditLog with format 'Override deliverable progress #{id}: {old} → {new}. Alasan: {reason}'"
  artifacts:
    - path: "Controllers/ProtonDataController.cs"
      provides: "OverrideList GET, OverrideDetail GET, OverrideSave POST endpoints + OverrideSaveRequest DTO"
      contains: "OverrideSave"
    - path: "Views/ProtonData/Index.cshtml"
      provides: "Third Bootstrap nav-tab, override table with per-worker badge rows, override modal with context + form, AJAX wiring"
      contains: "overrideTabContent"
  key_links:
    - from: "Views/ProtonData/Index.cshtml"
      to: "/ProtonData/OverrideList"
      via: "AJAX fetch on filter Muat Data click"
      pattern: "fetch.*OverrideList"
    - from: "Views/ProtonData/Index.cshtml"
      to: "/ProtonData/OverrideDetail"
      via: "AJAX fetch on badge click"
      pattern: "fetch.*OverrideDetail"
    - from: "Views/ProtonData/Index.cshtml"
      to: "/ProtonData/OverrideSave"
      via: "AJAX POST on Simpan Override button"
      pattern: "fetch.*OverrideSave"
    - from: "Controllers/ProtonDataController.cs"
      to: "AuditLogService"
      via: "_auditLog.LogAsync call in OverrideSave"
      pattern: "_auditLog\\.LogAsync"
---

<objective>
Add "Coaching Proton Override" as a third tab to the existing /ProtonData page. Admin and HC roles can view all ProtonDeliverableProgress records grouped per-worker with deliverable status badges, click any badge to open a context-rich override modal, and save status overrides with mandatory reason — all logged to AuditLog.

Purpose: Enables Admin/HC to correct stuck or erroneous deliverable progress records without direct database access (OPER-03).
Output: Three new controller endpoints (OverrideList, OverrideDetail, OverrideSave) + third Bootstrap tab with AJAX-driven override table and modal in ProtonData/Index.cshtml.
</objective>

<execution_context>
@C:/Users/Administrator/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Administrator/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/52-deliverableprogress-override/52-CONTEXT.md
@.planning/phases/52-deliverableprogress-override/52-RESEARCH.md
@.planning/phases/51-proton-silabus-coaching-guidance-manager/51-01-SUMMARY.md
@.planning/phases/51-proton-silabus-coaching-guidance-manager/51-03-SUMMARY.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From Models/ProtonModels.cs (ProtonDeliverableProgress — lines 83-116):
```csharp
public class ProtonDeliverableProgress
{
    public int Id { get; set; }
    public string CoacheeId { get; set; } = "";
    public int ProtonDeliverableId { get; set; }
    public ProtonDeliverable? ProtonDeliverable { get; set; }
    public string Status { get; set; } = "Locked"; // "Locked","Active","Submitted","Approved","Rejected"
    public string? EvidencePath { get; set; }
    public string? EvidenceFileName { get; set; }
    public DateTime? SubmittedAt { get; set; }
    public DateTime? ApprovedAt { get; set; }
    public DateTime? RejectedAt { get; set; }
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    public string? RejectionReason { get; set; }
    public string? ApprovedById { get; set; }
    public string HCApprovalStatus { get; set; } = "Pending"; // "Pending" or "Reviewed"
    public DateTime? HCReviewedAt { get; set; }
    public string? HCReviewedById { get; set; }
}
```

From Controllers/ProtonDataController.cs — existing structure:
```csharp
namespace HcPortal.Controllers
{
    // DTOs at namespace level (outside class)
    public class SilabusRowDto { ... }
    public class SilabusDeleteRequest { ... }
    public class GuidanceDeleteRequest { ... }

    [Authorize(Roles = "Admin,HC")]
    public class ProtonDataController : Controller
    {
        private readonly ApplicationDbContext _context;
        private readonly UserManager<ApplicationUser> _userManager;
        private readonly AuditLogService _auditLog;
        private readonly IWebHostEnvironment _env;
        // Constructor with all 4 injected
    }
}
```

From Views/ProtonData/Index.cshtml — tab structure (lines 24-39):
```html
<ul class="nav nav-tabs mb-4" id="protonDataTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="silabus-tab" ...>Silabus</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="guidance-tab" ...>Coaching Guidance</button>
    </li>
</ul>
<div class="tab-content" id="protonDataTabContent">
    <div class="tab-pane fade show active" id="silabusTabContent" ...>...</div>
    <div class="tab-pane fade" id="guidanceTabContent" ...>...</div>
</div>
```

From Views/ProtonData/Index.cshtml — AJAX POST pattern (GuidanceDelete, ~line 596+):
```javascript
const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
const resp = await fetch('/ProtonData/GuidanceDelete', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': token },
    body: JSON.stringify({ id: guidanceDeleteId })
});
const data = await resp.json();
```

From Views/ProtonData/Index.cshtml — orgStructure and allTracks data (already available):
- `var orgStructure = @Html.Raw(...)` — JS object with SectionUnits for Bagian > Unit cascade
- `var allTracks = @Html.Raw(...)` — JS array of ProtonTrack objects for Track dropdown
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add OverrideSaveRequest DTO, OverrideList GET, OverrideDetail GET, and OverrideSave POST endpoints to ProtonDataController</name>
  <files>Controllers/ProtonDataController.cs</files>
  <action>
Add the following to Controllers/ProtonDataController.cs:

1. **OverrideSaveRequest DTO** — at namespace level (outside ProtonDataController class, inside `namespace HcPortal.Controllers` block), alongside existing DTOs (SilabusRowDto, SilabusDeleteRequest, GuidanceDeleteRequest):
```csharp
public class OverrideSaveRequest
{
    public int ProgressId { get; set; }
    public string NewStatus { get; set; } = "";
    public string NewHCStatus { get; set; } = "";
    public string? NewRejectionReason { get; set; }
    public string OverrideReason { get; set; } = "";
}
```

2. **OverrideList GET action** — returns JSON list of per-worker override data for the selected Bagian+Unit+Track scope. Parameters: `string bagian, string unit, int trackId, string? statusFilter`.

Query logic:
- Load all ProtonDeliverable records for the given trackId WHERE the deliverable's ProtonSubKompetensi.ProtonKompetensi has matching Bagian AND Unit AND ProtonTrackId. Include full hierarchy (ProtonSubKompetensi → ProtonKompetensi). Order by Kompetensi.Urutan → SubKompetensi.Urutan → Deliverable.Urutan.
- Collect deliverable IDs. Load all ProtonDeliverableProgress records WHERE ProtonDeliverableId is in the ID list.
- Collect distinct CoacheeIds from progress records. Load coachee names from Users table as dictionary (Id → FullName ?? UserName ?? Id).
- Group progress records by CoacheeId.
- Apply statusFilter:
  - "rejected" → only coachees who have at least one progress with Status == "Rejected"
  - "pendingHC" → only coachees who have at least one progress with HCApprovalStatus == "Pending" AND Status == "Approved"
  - null/"semua" → no filter
- Build response as JSON array of coachee objects, each containing: `coacheeId`, `coacheeName`, `badges` (array of objects: `{ progressId, deliverableId, deliverableName, status }` — one per deliverable in order, with `progressId: null` and `status: "—"` if no progress record exists for that deliverable).
- Return `Json(new { success = true, coachees = [...], deliverableHeaders = [...] })` where deliverableHeaders is an array of `{ id, name }` for table column headers.

Guard: if bagian/unit are null/empty or trackId is 0, return `Json(new { success = true, coachees = new List<object>(), deliverableHeaders = new List<object>() })` (empty state).

3. **OverrideDetail GET action** — `public async Task<IActionResult> OverrideDetail(int id)`.
- Load ProtonDeliverableProgress by id with Include chain: ProtonDeliverable → ProtonSubKompetensi → ProtonKompetensi.
- If not found, return `Json(new { success = false })`.
- Look up approver name (if ApprovedById is not empty, query Users for FullName ?? UserName).
- Look up HC reviewer name (if HCReviewedById is not empty, query Users for FullName ?? UserName).
- Return JSON with all fields: id, deliverableName, kompetensiName, subKompetensiName, status, hcApprovalStatus, evidenceFileName, evidencePath, submittedAt (formatted "dd MMM yyyy HH:mm"), approvedAt, rejectedAt, rejectionReason, approvedByName, hcReviewedAt, hcReviewedByName, coacheeId.

4. **OverrideSave POST action** — `[HttpPost] [ValidateAntiForgeryToken] public async Task<IActionResult> OverrideSave([FromBody] OverrideSaveRequest req)`.
- Get current user via _userManager.GetUserAsync(User). If null, return Challenge().
- Validate: if OverrideReason is empty, return `Json(new { success = false, message = "Alasan override wajib diisi." })`.
- Validate: if NewStatus is not one of "Active", "Submitted", "Approved", "Rejected", return error.
- Validate: if NewHCStatus is not one of "Pending", "Reviewed", return error.
- Find progress by ProgressId. If null, return `Json(new { success = false, message = "Record tidak ditemukan." })`.
- Store old status: `var oldStatus = progress.Status;`
- Auto-fill timestamps based on NewStatus:
  - "Approved": set ApprovedAt = DateTime.UtcNow, ApprovedById = user.Id
  - "Rejected": set RejectedAt = DateTime.UtcNow
  - "Submitted": set SubmittedAt = DateTime.UtcNow
  - "Active": set ApprovedAt = null, RejectedAt = null, SubmittedAt = null
- Update: progress.Status = req.NewStatus, progress.HCApprovalStatus = req.NewHCStatus, progress.RejectionReason = req.NewRejectionReason.
- SaveChangesAsync().
- Log to AuditLog: `await _auditLog.LogAsync(user.Id, user.FullName ?? user.UserName ?? user.Id, "Override", $"Override deliverable progress #{progress.Id}: {oldStatus} → {req.NewStatus}. Alasan: {req.OverrideReason}", targetId: progress.Id, targetType: "ProtonDeliverableProgress");`
- Return `Json(new { success = true })`.
  </action>
  <verify>
    <automated>cd C:/Users/Administrator/Desktop/PortalHC_KPB && dotnet build --configuration Release 2>&1 | tail -5</automated>
  </verify>
  <done>ProtonDataController has OverrideSaveRequest DTO + OverrideList/OverrideDetail/OverrideSave endpoints that compile without errors. OverrideSave validates inputs, auto-fills timestamps per status, and logs to AuditLog.</done>
</task>

<task type="auto">
  <name>Task 2: Add Override tab UI with filter cascade, badge table, and override modal to ProtonData/Index.cshtml</name>
  <files>Views/ProtonData/Index.cshtml</files>
  <action>
Modify Views/ProtonData/Index.cshtml to add the third tab:

1. **Add third nav-tab** — after the Coaching Guidance `<li>` (around line 35), add:
```html
<li class="nav-item" role="presentation">
    <button class="nav-link" id="override-tab" data-bs-toggle="tab" data-bs-target="#overrideTabContent"
            type="button" role="tab" aria-controls="overrideTabContent" aria-selected="false">
        <i class="bi bi-shield-exclamation me-1"></i>Coaching Proton Override
    </button>
</li>
```

2. **Add third tab-pane** — after the Coaching Guidance tab-pane closing `</div>` (around line 127's closing), add a new `<div class="tab-pane fade" id="overrideTabContent" ...>` containing:

   a. **Filter section** (card with Bagian > Unit > Track cascade + Status dropdown + Muat Data button):
   - Bagian select: `<select id="overrideBagian">` with `<option value="">Pilih Bagian</option>` + options from orgStructure keys
   - Unit select: `<select id="overrideUnit" disabled>` — populated dynamically when Bagian changes (same pattern as Silabus/Guidance tabs)
   - Track select: `<select id="overrideTrack" disabled>` — populated when Unit is selected, using allTracks data
   - Status filter: `<select id="overrideStatusFilter">` with options: Semua (value=""), Hanya Rejected (value="rejected"), Hanya Pending HC (value="pendingHC")
   - Muat Data button: `<button id="btnLoadOverride" class="btn btn-primary" disabled>Muat Data</button>` — enabled when Bagian+Unit+Track are selected

   b. **Table container**: `<div id="overrideTableContainer" class="mt-3"></div>` — populated by AJAX

   c. **Override modal** (Bootstrap 5 modal, id="overrideModal"):
   - Header: "Override Deliverable Progress"
   - Body — context display section (read-only):
     - Deliverable name (bold)
     - Kompetensi / Sub-Kompetensi path
     - Current status badge with color
     - Evidence file: download link if exists, "Tidak ada" if not
     - Timestamps: SubmittedAt, ApprovedAt (+ approver name), RejectedAt
     - HC Review: HCApprovalStatus, HCReviewedAt (+ reviewer name)
     - Existing Rejection Reason (if any)
   - Body — override form section:
     - Hidden input: `<input type="hidden" id="overrideProgressId">`
     - Status dropdown: `<select id="overrideStatusSelect">` with options Active, Submitted, Approved, Rejected
     - HC Status dropdown: `<select id="overrideHCStatusSelect">` with options Pending, Reviewed
     - Rejection Reason textarea: `<textarea id="overrideRejectionReason">` (editable, can clear)
     - Alasan Override textarea: `<textarea id="overrideAlasan" required>` (mandatory)
   - Footer: Simpan Override button (`<button id="btnSaveOverride" class="btn btn-primary">Simpan Override</button>`) + Batal button

3. **JavaScript IIFE** — add after the existing Coaching Guidance IIFE, within the same `<script>` block. Use an IIFE `(function() { ... })();` to scope variables:

   a. **Filter cascade** for Override tab — reuse `orgStructure` and `allTracks` variables already available in parent scope:
   - overrideBagian change → populate overrideUnit (filter orgStructure), reset overrideTrack, disable btnLoadOverride
   - overrideUnit change → populate overrideTrack (filter allTracks by matching Bagian from the track hierarchy — or just populate all tracks and let the server filter), enable overrideTrack
   - overrideTrack change → enable btnLoadOverride

   b. **loadOverrideData()** function — called on btnLoadOverride click:
   - Read bagian, unit, trackId, statusFilter from dropdowns
   - Fetch `/ProtonData/OverrideList?bagian=${bagian}&unit=${unit}&trackId=${trackId}&statusFilter=${statusFilter}`
   - On success, call renderOverrideTable(data.coachees, data.deliverableHeaders)

   c. **renderOverrideTable(coachees, headers)** function:
   - If coachees is empty, show alert "Tidak ada data untuk filter ini."
   - Build HTML table with horizontal scroll (`<div class="table-responsive"><table class="table table-sm table-bordered">`):
     - thead: "Nama Pekerja" column + one column per deliverable header (short name, maybe first 15 chars with title tooltip)
     - tbody: one row per coachee. First cell = coacheeName. Subsequent cells = badge buttons styled by status color:
       - Active → `<button class="badge bg-primary border-0 btn-override" data-progress-id="X" title="deliverableName">A</button>`
       - Submitted → bg-warning text-dark, letter "S"
       - Approved → bg-success, letter "V" (checkmark letter)
       - Rejected → bg-danger, letter "R"
       - No progress (progressId null) → grey "—" (no click handler)
   - Set `overrideTableContainer.innerHTML = tableHTML`

   d. **Badge click handler** — event delegation on overrideTableContainer:
   - `document.getElementById('overrideTableContainer').addEventListener('click', async function(e) { ... })`
   - Find closest `.btn-override`. If not found, return.
   - Get progressId from dataset.
   - Fetch `/ProtonData/OverrideDetail?id=${progressId}`.
   - Populate modal fields from response data.
   - Pre-select current status and HC status in dropdowns.
   - Clear Alasan Override textarea.
   - Show modal: `new bootstrap.Modal(document.getElementById('overrideModal')).show();`

   e. **Save handler** — on btnSaveOverride click:
   - Read all form values.
   - Validate Alasan Override is not empty (show alert if empty, return).
   - POST to `/ProtonData/OverrideSave` with JSON body and RequestVerificationToken header (same pattern as GuidanceDelete).
   - On success: close modal, call loadOverrideData() to refresh table, optionally show brief success toast/alert.
   - On failure: show error message from response.

**Important patterns to follow:**
- Use `selected="@(condition ? "selected" : null)"` pattern for Razor if needed (but Override tab is pure JS-rendered, so Razor attributes unlikely needed here).
- AntiForgeryToken already exists in the form — use `document.querySelector('input[name="__RequestVerificationToken"]').value` to extract.
- Reuse `orgStructure` and `allTracks` variables from parent scope (already declared in existing JS).
  </action>
  <verify>
    <automated>cd C:/Users/Administrator/Desktop/PortalHC_KPB && dotnet build --configuration Release 2>&1 | tail -5</automated>
  </verify>
  <done>ProtonData/Index.cshtml has a third "Coaching Proton Override" tab with Bagian/Unit/Track cascade filter + status filter, per-worker badge table loaded via AJAX, badge click opens override modal with full context + override form, and Simpan Override saves via AJAX POST with AuditLog logging. The page compiles and the tab is only visible as part of the existing Admin/HC-restricted /ProtonData page.</done>
</task>

</tasks>

<verification>
1. `dotnet build --configuration Release` compiles with 0 errors
2. Navigate to /ProtonData — three tabs visible (Silabus, Coaching Guidance, Coaching Proton Override)
3. Click Override tab → filter cascade works: select Bagian → Unit populates, select Unit → Track populates, select Track → Muat Data enables
4. Click Muat Data → table loads with per-worker rows and deliverable badges colored by status
5. Click any badge → modal opens with full record context (deliverable name, status, timestamps, evidence, approver info)
6. Fill override form (change status, enter Alasan Override) → click Simpan Override → success → table refreshes → badge color updated
7. Check /Admin/AuditLog → override entry visible with correct format
8. Status filter dropdown (Hanya Rejected / Hanya Pending HC) correctly narrows displayed coachees
</verification>

<success_criteria>
- Third Bootstrap tab "Coaching Proton Override" is functional in /ProtonData
- Filter cascade (Bagian > Unit > Track) loads per-worker override data via AJAX
- All badge statuses display with correct Bootstrap colors (blue/yellow/green/red)
- Override modal shows full record context and allows status change with mandatory reason
- OverrideSave auto-fills timestamps per status transition rules
- AuditLog records each override with old→new status and reason
</success_criteria>

<output>
After completion, create `.planning/phases/52-deliverableprogress-override/52-01-SUMMARY.md`
</output>
