---
phase: 52-deliverableprogress-override
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Controllers/CDPController.cs
  - Models/CDPDashboardViewModel.cs
  - Models/ProtonModels.cs
autonomous: true
requirements:
  - OPER-03

must_haves:
  truths:
    - "New track assignments via CDPController.AssignTrack create ALL deliverable progress records with Status='Active' (no Locked status)"
    - "CDPController.Deliverable() no longer checks sequential lock — all deliverables are accessible regardless of previous deliverable status"
    - "CDPController.ApproveDeliverable() no longer attempts to unlock the next deliverable (unlock-next block removed)"
    - "ProtonProgress doughnut chart shows 4 statuses only (Approved, Submitted, Active, Rejected) — no Locked label/count"
    - "CoacheeProgressRow no longer has a Locked property; table display excludes Locked column"
    - "Existing database records with Status='Locked' are migrated to 'Active' via EF migration"
    - "ProtonDeliverableProgress model Status summary comment updated to remove 'Locked' from valid values"
  artifacts:
    - path: "Controllers/CDPController.cs"
      provides: "Lock-free AssignTrack, lock-free Deliverable(), simplified ApproveDeliverable() retaining allApproved check"
      contains: "Status = \"Active\""
    - path: "Models/CDPDashboardViewModel.cs"
      provides: "CoacheeProgressRow without Locked property"
    - path: "Models/ProtonModels.cs"
      provides: "Updated Status XML comment reflecting 4-status model"
  key_links:
    - from: "Controllers/CDPController.cs"
      to: "ProtonDeliverableProgress"
      via: "AssignTrack creating all records as Active"
      pattern: "Status = .Active."
    - from: "Controllers/CDPController.cs"
      to: "BuildProtonProgressSubModelAsync"
      via: "statusLabels list without Locked"
      pattern: "statusLabels"
---

<objective>
Remove the sequential lock mechanism from the entire Proton deliverable system. All deliverables become Active on assignment instead of first=Active/rest=Locked. Remove lock checks from CDPController.Deliverable(), remove unlock-next from ApproveDeliverable(), clean up stats/charts to exclude Locked status, remove Locked property from CoacheeProgressRow, and bulk-migrate existing Locked DB records to Active.

Purpose: Simplifies the Proton workflow by removing the sequential constraint — coachees can work on any deliverable in any order. This is a prerequisite for Phase 65 (v2.4 Progress page actions) and aligns with the Override tab which has no Locked option.
Output: CDPController with 3 code blocks modified/removed, CDPDashboardViewModel cleaned, EF data migration applied, ProtonModels comment updated.
</objective>

<execution_context>
@C:/Users/Administrator/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Administrator/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/52-deliverableprogress-override/52-CONTEXT.md
@.planning/phases/52-deliverableprogress-override/52-RESEARCH.md

<interfaces>
<!-- Key code locations that will be modified. Extracted from codebase grep. -->

From Controllers/CDPController.cs — AssignTrack (lines 738-745):
```csharp
// Create progress records — first Active, rest Locked
var progressList = deliverables.Select((d, index) => new ProtonDeliverableProgress
{
    CoacheeId = coacheeId,
    ProtonDeliverableId = d.Id,
    Status = index == 0 ? "Active" : "Locked",
    CreatedAt = DateTime.UtcNow
}).ToList();
```

From Controllers/CDPController.cs — Deliverable() sequential lock check (lines 817-830):
```csharp
// Sequential lock check
int currentIndex = orderedProgresses.FindIndex(p => p.Id == progress.Id);
bool isAccessible;
if (currentIndex <= 0)
{
    // First deliverable — always accessible
    isAccessible = true;
}
else
{
    // Check if previous deliverable is Approved
    var previousProgress = orderedProgresses[currentIndex - 1];
    isAccessible = previousProgress.Status == "Approved";
}
```

From Controllers/CDPController.cs — ApproveDeliverable() unlock-next (lines 930-939):
```csharp
// Unlock next deliverable: find index of just-approved record and set next to Active
int currentIndex = orderedProgresses.FindIndex(p => p.Id == progress.Id);
if (currentIndex >= 0 && currentIndex < orderedProgresses.Count - 1)
{
    var nextProgress = orderedProgresses[currentIndex + 1];
    if (nextProgress.Status == "Locked")
    {
        nextProgress.Status = "Active";
    }
}
```

From Controllers/CDPController.cs — ApproveDeliverable() allApproved check (line 942):
```csharp
// Check all-approved: use in-memory state (current record already set to "Approved" above)
bool allApproved = orderedProgresses.All(p => p.Status == "Approved");
```

From Controllers/CDPController.cs — BuildProtonProgressSubModelAsync stats (lines 293, 327-335):
```csharp
Locked = progresses.Count(p => p.Status == "Locked"),
// ...
var statusLabels = new List<string> { "Approved", "Submitted", "Active", "Rejected", "Locked" };
var statusData = new List<int>
{
    allProgresses.Count(p => p.Status == "Approved"),
    allProgresses.Count(p => p.Status == "Submitted"),
    allProgresses.Count(p => p.Status == "Active"),
    allProgresses.Count(p => p.Status == "Rejected"),
    allProgresses.Count(p => p.Status == "Locked")
};
```

From Models/CDPDashboardViewModel.cs — CoacheeProgressRow (line 104):
```csharp
public int Locked { get; set; }
```

From Models/ProtonModels.cs — ProtonDeliverableProgress Status comment (line 90):
```csharp
/// <summary>Values: "Locked", "Active", "Submitted", "Approved", "Rejected"</summary>
public string Status { get; set; } = "Locked";
```

From Controllers/CDPController.cs — Deliverable() ViewModel (line 854):
```csharp
IsAccessible = isAccessible,
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove sequential lock logic from CDPController (AssignTrack, Deliverable, ApproveDeliverable) and clean up stats</name>
  <files>Controllers/CDPController.cs</files>
  <action>
Make the following targeted changes to Controllers/CDPController.cs:

**Change 1 — AssignTrack (lines ~738-745):** Change `Status = index == 0 ? "Active" : "Locked"` to `Status = "Active"` for all deliverables. Also remove the `(d, index)` lambda since index is no longer needed — change to `.Select(d => new ProtonDeliverableProgress { ... })`. Update the comment from "first Active, rest Locked" to "all deliverables start Active".

Before:
```csharp
// Create progress records — first Active, rest Locked
var progressList = deliverables.Select((d, index) => new ProtonDeliverableProgress
{
    CoacheeId = coacheeId,
    ProtonDeliverableId = d.Id,
    Status = index == 0 ? "Active" : "Locked",
    CreatedAt = DateTime.UtcNow
}).ToList();
```

After:
```csharp
// Create progress records — all deliverables start Active (no sequential lock)
var progressList = deliverables.Select(d => new ProtonDeliverableProgress
{
    CoacheeId = coacheeId,
    ProtonDeliverableId = d.Id,
    Status = "Active",
    CreatedAt = DateTime.UtcNow
}).ToList();
```

**Change 2 — Deliverable() sequential lock check (lines 817-830):** Remove the entire sequential lock check block. Replace `isAccessible` assignment with `bool isAccessible = true;` (unconditionally accessible). Keep it as a simple variable assignment so the ViewModel line `IsAccessible = isAccessible` (line 854) still compiles.

IMPORTANT: The `allProgresses` and `orderedProgresses` variables at lines 796-815 are used later in the method for OTHER purposes (computing context). Check carefully: if `orderedProgresses` is ONLY used for the lock check and nothing else in Deliverable(), then the allProgresses + orderedProgresses load at lines 796-815 can also be removed (since isAccessible is now always true). However, check that no other code between lines 815 and the end of the method references orderedProgresses or allProgresses. If they are used elsewhere, keep them.

After analysis: In Deliverable(), allProgresses and orderedProgresses are ONLY used for the sequential lock check (lines 817-830). No other code in Deliverable() references them after line 830. Therefore:
- Remove lines 795-830 entirely (the allProgresses load, orderedProgresses computation, and lock check block)
- Replace with: `bool isAccessible = true; // All deliverables accessible (no sequential lock)`

**Change 3 — ApproveDeliverable() unlock-next block (lines 930-939):** Remove this entire block. The `orderedProgresses` variable is still needed for the `allApproved` check on line 942, so keep the allProgresses + orderedProgresses computation (lines 915-928).

Before (lines 930-942):
```csharp
// Unlock next deliverable: find index of just-approved record and set next to Active
int currentIndex = orderedProgresses.FindIndex(p => p.Id == progress.Id);
if (currentIndex >= 0 && currentIndex < orderedProgresses.Count - 1)
{
    var nextProgress = orderedProgresses[currentIndex + 1];
    if (nextProgress.Status == "Locked")
    {
        nextProgress.Status = "Active";
    }
}

// Check all-approved: use in-memory state (current record already set to "Approved" above)
bool allApproved = orderedProgresses.All(p => p.Status == "Approved");
```

After:
```csharp
// Check all-approved: use in-memory state (current record already set to "Approved" above)
bool allApproved = orderedProgresses.All(p => p.Status == "Approved");
```

**Change 4 — BuildProtonProgressSubModelAsync stats (line ~293):** Remove `Locked = progresses.Count(p => p.Status == "Locked"),` from the CoacheeProgressRow construction.

**Change 5 — BuildProtonProgressSubModelAsync doughnut chart (lines ~327-335):** Remove "Locked" from statusLabels and its corresponding count from statusData:

Before:
```csharp
var statusLabels = new List<string> { "Approved", "Submitted", "Active", "Rejected", "Locked" };
var statusData = new List<int>
{
    allProgresses.Count(p => p.Status == "Approved"),
    allProgresses.Count(p => p.Status == "Submitted"),
    allProgresses.Count(p => p.Status == "Active"),
    allProgresses.Count(p => p.Status == "Rejected"),
    allProgresses.Count(p => p.Status == "Locked")
};
```

After:
```csharp
var statusLabels = new List<string> { "Approved", "Submitted", "Active", "Rejected" };
var statusData = new List<int>
{
    allProgresses.Count(p => p.Status == "Approved"),
    allProgresses.Count(p => p.Status == "Submitted"),
    allProgresses.Count(p => p.Status == "Active"),
    allProgresses.Count(p => p.Status == "Rejected")
};
```
  </action>
  <verify>
    <automated>cd C:/Users/Administrator/Desktop/PortalHC_KPB && dotnet build --configuration Release 2>&1 | tail -5</automated>
  </verify>
  <done>CDPController compiles: AssignTrack creates all Active, Deliverable() sets isAccessible=true unconditionally, ApproveDeliverable() unlock-next block removed (allApproved check retained), stats/chart exclude Locked.</done>
</task>

<task type="auto">
  <name>Task 2: Remove Locked from CoacheeProgressRow, update ProtonModels Status comment and default, create EF data migration</name>
  <files>Models/CDPDashboardViewModel.cs, Models/ProtonModels.cs</files>
  <action>
**Change 1 — CDPDashboardViewModel.cs (line 104):** Remove the `public int Locked { get; set; }` property from `CoacheeProgressRow` class entirely.

**Change 2 — ProtonModels.cs (lines 90-91):** Update the Status XML summary and default value:

Before:
```csharp
/// <summary>Values: "Locked", "Active", "Submitted", "Approved", "Rejected"</summary>
public string Status { get; set; } = "Locked";
```

After:
```csharp
/// <summary>Values: "Active", "Submitted", "Approved", "Rejected"</summary>
public string Status { get; set; } = "Active";
```

**Change 3 — Create EF data migration** to bulk-update existing Locked records to Active. Run:
```bash
dotnet ef migrations add RemoveLockedStatus --configuration Release
```

Then edit the generated migration file. In the `Up()` method, add a raw SQL command:
```csharp
migrationBuilder.Sql("UPDATE ProtonDeliverableProgresses SET Status = 'Active' WHERE Status = 'Locked'");
```

The `Down()` method should be a no-op (cannot restore which records were originally Locked). Leave the default empty Down() method.

Note: Changing the default value on ProtonDeliverableProgress.Status from "Locked" to "Active" is a C# default change only — it does NOT generate an EF schema migration (the column type and nullability are unchanged). The migration will be empty except for the raw SQL. If EF generates an empty migration with no schema changes, that's expected — just add the SQL line.

After creating the migration, apply it:
```bash
dotnet ef database update --configuration Release
```

**Verification after migration:** Query DB to confirm no Locked records remain. Use EF or raw check.
  </action>
  <verify>
    <automated>cd C:/Users/Administrator/Desktop/PortalHC_KPB && dotnet build --configuration Release 2>&1 | tail -5</automated>
  </verify>
  <done>CoacheeProgressRow.Locked property removed, ProtonDeliverableProgress model default changed to "Active" with updated comment, EF migration created and applied — no records with Status="Locked" remain in database.</done>
</task>

</tasks>

<verification>
1. `dotnet build --configuration Release` compiles with 0 errors
2. CDPController.AssignTrack: new track assignments create all deliverables with Status="Active"
3. CDPController.Deliverable(): accessing any deliverable page works without sequential lock check
4. CDPController.ApproveDeliverable(): approving a deliverable does NOT attempt to unlock next (block removed)
5. CDPController.ApproveDeliverable(): allApproved check still triggers HC notification when all deliverables are Approved
6. ProtonProgress stats page: doughnut chart shows 4 labels (Approved, Submitted, Active, Rejected) — no Locked
7. CoacheeProgressRow table: no Locked column displayed
8. Database check: `SELECT COUNT(*) FROM ProtonDeliverableProgresses WHERE Status = 'Locked'` returns 0
</verification>

<success_criteria>
- No compilation errors after all changes
- "Locked" string does not appear in status labels, CoacheeProgressRow, or AssignTrack creation logic
- Existing Locked DB records migrated to Active via EF migration
- ApproveDeliverable allApproved check + HC notification still functional
- ProtonDeliverableProgress model reflects 4-status system
</success_criteria>

<output>
After completion, create `.planning/phases/52-deliverableprogress-override/52-02-SUMMARY.md`
</output>
