---
phase: 64-functional-filters
plan: 02
type: execute
wave: 2
depends_on: ["64-01"]
files_modified:
  - Views/CDP/ProtonProgress.cshtml
autonomous: true
requirements: [FILT-01, FILT-02, FILT-03, FILT-04, UI-01, UI-03]

must_haves:
  truths:
    - "Filter bar renders horizontally: Bagian -> Unit -> Coachee -> Track -> Tahun -> Search -> Reset, stacking vertically on mobile"
    - "Each dropdown change auto-submits the GET form, updating the URL with query params"
    - "Bagian dropdown change clears Unit selection before submitting (prevents stale cascade)"
    - "Search input filters competency/deliverable rows client-side with 300ms debounce, no page reload"
    - "Clear (X) button in search input clears text without submitting the form"
    - "Dropdown selected attribute uses if/else Razor blocks (NOT ternary) to avoid RZ1031"
    - "Role-conditional visibility: Spv sees Track/Tahun/Search only; SrSpv/SectionHead sees Unit/Track/Tahun/Search; Coach sees Coachee/Track/Tahun/Search; HC/Admin sees all"
    - "Result count shows 'Menampilkan X dari Y data' above the table"
    - "AJAX fetch() coachee switching from Phase 63 replaced by GET form auto-submit"
    - "Multi-coachee rows show Coachee column when no specific coachee is selected"
  artifacts:
    - path: "Views/CDP/ProtonProgress.cshtml"
      provides: "Full filter-driven ProtonProgress view with GET form, cascading dropdowns, client-side search"
      min_lines: 350
  key_links:
    - from: "Views/CDP/ProtonProgress.cshtml"
      to: "Controllers/CDPController.cs"
      via: "GET form action targeting ProtonProgress with bagian/unit/coacheeId/trackType/tahun params"
      pattern: 'form.*method.*get.*ProtonProgress'
    - from: "Views/CDP/ProtonProgress.cshtml"
      to: "OrganizationStructure.SectionUnits"
      via: "JS unitsByBagian object for client-side Bagian->Unit cascade"
      pattern: "unitsByBagian"
    - from: "Views/CDP/ProtonProgress.cshtml"
      to: "ViewBag.AllBagian, ViewBag.SelectedBagian, etc."
      via: "Razor rendering of dropdown options with selected state"
      pattern: "ViewBag\\.Selected"
---

<objective>
Rewrite ProtonProgress.cshtml to replace Phase 63 AJAX model with a GET form filter bar. Wire all dropdowns to auto-submit on change, implement Bagian->Unit cascade, add debounced client-side search, and render correct selected attributes using Razor if/else blocks.

Purpose: Make every filter on the Progress page genuinely narrow the displayed data via URL query params and page reload, with client-side search layered on top. Role-conditional filter visibility ensures users only see filters relevant to their scope.

Output: Rewritten ProtonProgress.cshtml with filter bar, auto-submit dropdowns, cascade JS, search JS, correct selected rendering, and multi-coachee table support.
</objective>

<execution_context>
@C:/Users/Administrator/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Administrator/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/64-functional-filters/64-CONTEXT.md
@.planning/phases/64-functional-filters/64-RESEARCH.md
@.planning/phases/64-functional-filters/64-01-SUMMARY.md

<interfaces>
<!-- ViewBag values populated by Plan 01's refactored ProtonProgress action -->

ViewBag contract from CDPController.ProtonProgress (Plan 01):
```
ViewBag.AllBagian       : List<string>          — ["RFCC", "DHT / HMU", "NGP", "GAST"]
ViewBag.AllUnits        : List<string>          — units for selected bagian, or empty list
ViewBag.AllTracks       : List<string>          — ["Panelman", "Operator"]
ViewBag.AllTahun        : List<string>          — ["Tahun 1", "Tahun 2", "Tahun 3"]
ViewBag.Coachees        : List<ApplicationUser>? — scoped coachee list, null for Level 6
ViewBag.SelectedBagian  : string?               — current bagian filter value
ViewBag.SelectedUnit    : string?               — current unit filter value
ViewBag.SelectedTrackType : string?             — current track filter value
ViewBag.SelectedCoacheeId : string?             — current coachee filter value
ViewBag.SelectedTahun   : string?               — current tahun filter value
ViewBag.TotalCount      : int                   — total deliverable rows before filter
ViewBag.FilteredCount   : int                   — deliverable rows after filter
ViewBag.UserLevel       : int                   — user role level (1=Admin, 2=HC, 4=SrSpv, 5=Coach, 6=Coachee)
ViewBag.UserRole        : string                — role name
ViewBag.UserSection     : string?               — user's section
ViewBag.UserUnit        : string?               — user's unit
ViewBag.UserFullName    : string                — user's display name
ViewBag.ProgressPercent : int
ViewBag.PendingActions  : int
ViewBag.PendingApprovals: int
ViewBag.TrackLabel      : string                — e.g. "Panelman Tahun 2" (single coachee only)
ViewBag.CoacheeName     : string                — selected coachee name (single coachee only)
ViewBag.EmptyMessage    : string?               — set when data.Count == 0
```

Model: `@model List<HcPortal.Models.TrackingItem>` where TrackingItem now has:
```csharp
public string CoacheeId { get; set; } = "";
public string CoacheeName { get; set; } = "";
```

OrganizationStructure.SectionUnits (for JS cascade):
```
{
    "RFCC": ["RFCC LPG Treating Unit (062)", "Propylene Recovery Unit (063)"],
    "DHT / HMU": ["Diesel Hydrotreating Unit I & II (054 & 083)", "Hydrogen Manufacturing Unit (068)", "Common DHT H2 Compressor (085)"],
    "NGP": ["Saturated Gas Concentration Unit (060)", "Saturated LPG Treating Unit (064)", "Isomerization Unit (082)", "Common Facilities For NLP (160)", "Naphtha Hydrotreating Unit II (084)"],
    "GAST": ["RFCC NHT (053)", "Alkylation Unit (065)", "Wet Gas Sulfuric Acid Unit (066)", "SWS RFCC & Non RFCC (067 & 167)", "Amine Regeneration Unit I & II (069 & 079)", "Flare System (319)", "Sulfur Recovery Unit (169)"]
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite ProtonProgress.cshtml with GET form filter bar and cascading dropdowns</name>
  <files>Views/CDP/ProtonProgress.cshtml</files>
  <action>
Rewrite `Views/CDP/ProtonProgress.cshtml` entirely. The Phase 63 version (424 lines, AJAX-based) is replaced with a GET form-based page. Reference the existing file for structure guidance but replace the core interaction model.

**Layout structure (top to bottom):**

1. **Page header** — "Proton Progress" title
2. **Filter bar** — single horizontal row of dropdowns + search + reset
3. **Result count** — "Menampilkan X dari Y data"
4. **Stat cards** — Progress %, Pending Actions, Pending Approvals (same 3-card row from Phase 63)
5. **Coachee info** — when single coachee selected: name + track badge
6. **Data table** — with rowspan merging, Coachee column when multi-coachee
7. **Empty state** — "Tidak ada data yang sesuai filter" when no rows
8. **Search no-results** — "Tidak ditemukan kompetensi untuk '[query]'" (JS-only, search-specific)

**Filter bar implementation:**

```razor
@{
    var userLevel = (int)ViewBag.UserLevel;
    var allBagian = ViewBag.AllBagian as List<string> ?? new List<string>();
    var allUnits = ViewBag.AllUnits as List<string> ?? new List<string>();
    var allTracks = ViewBag.AllTracks as List<string> ?? new List<string>();
    var allTahun = ViewBag.AllTahun as List<string> ?? new List<string>();
    var coachees = ViewBag.Coachees as List<HcPortal.Models.ApplicationUser>;
    var selectedBagian = ViewBag.SelectedBagian as string ?? "";
    var selectedUnit = ViewBag.SelectedUnit as string ?? "";
    var selectedTrackType = ViewBag.SelectedTrackType as string ?? "";
    var selectedTahun = ViewBag.SelectedTahun as string ?? "";
    var selectedCoacheeId = ViewBag.SelectedCoacheeId as string ?? "";
}

<form method="get" asp-action="ProtonProgress" asp-controller="CDP" id="filterForm"
      class="d-flex flex-wrap gap-2 align-items-center mb-3">

    @* Bagian dropdown — HC/Admin only (Level 1-2) *@
    @if (userLevel <= 2)
    {
        <select name="bagian" class="form-select form-select-sm" style="width:auto;min-width:150px"
                onchange="onBagianChange(this)">
            <option value="">Semua Bagian</option>
            @foreach (var b in allBagian)
            {
                if (b == selectedBagian)
                {
                    <option value="@b" selected>@b</option>
                }
                else
                {
                    <option value="@b">@b</option>
                }
            }
        </select>
    }

    @* Unit dropdown — HC/Admin (Level 1-2) and SrSpv/SectionHead (Level 4) *@
    @if (userLevel <= 2 || userLevel == 4)
    {
        <select name="unit" id="unitSelect" class="form-select form-select-sm" style="width:auto;min-width:180px"
                onchange="this.form.submit()">
            <option value="">Semua Unit</option>
            @foreach (var u in allUnits)
            {
                if (u == selectedUnit)
                {
                    <option value="@u" selected>@u</option>
                }
                else
                {
                    <option value="@u">@u</option>
                }
            }
        </select>
    }

    @* Coachee dropdown — Coach (Level 5) and HC/Admin (Level 1-2) *@
    @if (coachees != null && (userLevel == 5 || userLevel <= 2))
    {
        <select name="coacheeId" class="form-select form-select-sm" style="width:auto;min-width:180px"
                onchange="this.form.submit()">
            <option value="">Semua Coachee</option>
            @foreach (var c in coachees)
            {
                if (c.Id == selectedCoacheeId)
                {
                    <option value="@c.Id" selected>@c.FullName</option>
                }
                else
                {
                    <option value="@c.Id">@c.FullName</option>
                }
            }
        </select>
    }

    @* Track dropdown — all roles except Coachee (Level 6) *@
    @if (userLevel < 6)
    {
        <select name="trackType" class="form-select form-select-sm" style="width:auto;min-width:140px"
                onchange="this.form.submit()">
            <option value="">Semua Track</option>
            @foreach (var t in allTracks)
            {
                if (t == selectedTrackType)
                {
                    <option value="@t" selected>@t</option>
                }
                else
                {
                    <option value="@t">@t</option>
                }
            }
        </select>
    }

    @* Tahun dropdown — all roles except Coachee (Level 6) *@
    @if (userLevel < 6)
    {
        <select name="tahun" class="form-select form-select-sm" style="width:auto;min-width:130px"
                onchange="this.form.submit()">
            <option value="">Semua Tahun</option>
            @foreach (var th in allTahun)
            {
                if (th == selectedTahun)
                {
                    <option value="@th" selected>@th</option>
                }
                else
                {
                    <option value="@th">@th</option>
                }
            }
        </select>
    }

    @* Search box — client-side only, NOT a form field (no name attribute) *@
    @if (userLevel < 6)
    {
        <div class="position-relative" style="min-width:200px">
            <span class="position-absolute top-50 start-0 translate-middle-y ps-2 text-muted">
                <i class="bi bi-search"></i>
            </span>
            <input type="text" id="searchInput" class="form-control form-control-sm ps-4"
                   placeholder="Cari kompetensi..." autocomplete="off">
            <button type="button" id="searchClear"
                    class="btn btn-sm position-absolute top-50 end-0 translate-middle-y d-none"
                    style="border:none;background:none;color:#6c757d"
                    onclick="clearSearch()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
    }

    @* Reset button *@
    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">
        <i class="bi bi-arrow-counterclockwise"></i> Reset
    </button>
</form>
```

**CRITICAL Razor rules (UI-01):**
- Every `<option>` with conditional `selected` MUST use explicit `if/else` blocks
- Do NOT use `selected="@(cond ? "selected" : "")"` — causes RZ1031
- Do NOT use ternary expressions inside attribute declarations
- The search input has NO `name` attribute — it is NOT submitted with the form (client-side only per CONTEXT.md)

**Result count display:**
```razor
<small class="text-muted mb-2 d-block">Menampilkan @ViewBag.FilteredCount dari @ViewBag.TotalCount data</small>
```

**Stat cards** — keep the same 3-card row structure from Phase 63 (ProgressPercent, PendingActions, PendingApprovals). Show them always (not hidden behind AJAX load anymore).

**Coachee info section** — show only when a single coachee is selected:
```razor
@if (!string.IsNullOrEmpty(ViewBag.SelectedCoacheeId as string))
{
    <div class="card mb-3">
        <div class="card-body py-2">
            <strong>@ViewBag.CoacheeName</strong>
            @if (!string.IsNullOrEmpty(ViewBag.TrackLabel as string))
            {
                <span class="badge bg-primary ms-2">@ViewBag.TrackLabel</span>
            }
        </div>
    </div>
}
```

**Data table:**

The table needs a Coachee column when multiple coachees are shown (no specific coachee selected AND userLevel < 6). When a single coachee is selected, hide the Coachee column.

```razor
@{
    var showCoacheeColumn = string.IsNullOrEmpty(selectedCoacheeId) && userLevel < 6;
}
```

Table columns:
- (If showCoacheeColumn) Coachee
- Kompetensi (with rowspan)
- Sub Kompetensi (with rowspan)
- Deliverable
- Evidence
- Approval Sr. Spv
- Approval Section Head
- Approval HC
- Aksi

**Rowspan merging logic:** Keep the Phase 63 server-side Razor GroupBy pattern for Kompetensi/SubKompetensi. When `showCoacheeColumn` is true, group first by CoacheeName, then by Kompetensi, then by SubKompetensi.

Add `data-kompetensi` and `data-deliverable` attributes to each `<tr>` for client-side search:
```razor
<tr data-kompetensi="@item.Kompetensi" data-deliverable="@item.Deliverable">
```

**Empty state:**
```razor
@if (Model.Count == 0 && !string.IsNullOrEmpty(ViewBag.EmptyMessage as string))
{
    <div class="alert alert-info">@ViewBag.EmptyMessage</div>
}
```

**Search no-results message** (hidden by default, shown by JS):
```html
<div id="searchNoResults" class="alert alert-warning d-none">
    Tidak ditemukan kompetensi untuk '<span id="searchQuery"></span>'
</div>
```

**@functions block:** Keep `GetApprovalBadge(string)` from Phase 63 (same badge rendering).

**JavaScript section** (at bottom of file, in `@section Scripts` or inline `<script>`):

```javascript
// === Bagian -> Unit cascade ===
const unitsByBagian = {
    "RFCC": ["RFCC LPG Treating Unit (062)", "Propylene Recovery Unit (063)"],
    "DHT / HMU": ["Diesel Hydrotreating Unit I & II (054 & 083)", "Hydrogen Manufacturing Unit (068)", "Common DHT H2 Compressor (085)"],
    "NGP": ["Saturated Gas Concentration Unit (060)", "Saturated LPG Treating Unit (064)", "Isomerization Unit (082)", "Common Facilities For NLP (160)", "Naphtha Hydrotreating Unit II (084)"],
    "GAST": ["RFCC NHT (053)", "Alkylation Unit (065)", "Wet Gas Sulfuric Acid Unit (066)", "SWS RFCC & Non RFCC (067 & 167)", "Amine Regeneration Unit I & II (069 & 079)", "Flare System (319)", "Sulfur Recovery Unit (169)"]
};

function onBagianChange(select) {
    const unitSelect = document.getElementById('unitSelect');
    if (unitSelect) {
        // Clear unit selection to prevent stale cascade (Pitfall 5)
        unitSelect.innerHTML = '<option value="">Semua Unit</option>';
        const bagian = select.value;
        if (bagian && unitsByBagian[bagian]) {
            unitsByBagian[bagian].forEach(u => {
                const opt = document.createElement('option');
                opt.value = u;
                opt.textContent = u;
                unitSelect.appendChild(opt);
            });
        }
    }
    select.form.submit();
}

// === Reset all filters ===
function clearFilters() {
    // Navigate to ProtonProgress with no params
    window.location.href = '@Url.Action("ProtonProgress", "CDP")';
}

// === Client-side search (FILT-04) ===
let searchTimer;
const searchInput = document.getElementById('searchInput');
const searchClear = document.getElementById('searchClear');
const searchNoResults = document.getElementById('searchNoResults');
const searchQuerySpan = document.getElementById('searchQuery');

if (searchInput) {
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimer);
        const query = this.value.trim();

        // Toggle clear button visibility
        if (searchClear) {
            searchClear.classList.toggle('d-none', !query);
        }

        searchTimer = setTimeout(() => {
            const q = query.toLowerCase();
            const rows = document.querySelectorAll('#progressTableBody tr');
            let visibleCount = 0;

            rows.forEach(row => {
                const kompetensi = (row.dataset.kompetensi || '').toLowerCase();
                const deliverable = (row.dataset.deliverable || '').toLowerCase();
                const match = !q || kompetensi.includes(q) || deliverable.includes(q);
                row.style.display = match ? '' : 'none';
                if (match) visibleCount++;
            });

            // Show/hide no-results message
            if (searchNoResults) {
                if (q && visibleCount === 0) {
                    searchNoResults.classList.remove('d-none');
                    if (searchQuerySpan) searchQuerySpan.textContent = query;
                } else {
                    searchNoResults.classList.add('d-none');
                }
            }
        }, 300);
    });
}

function clearSearch() {
    if (searchInput) {
        searchInput.value = '';
        searchInput.dispatchEvent(new Event('input'));
    }
}
```

**IMPORTANT — Remove Phase 63 AJAX logic:**
- Remove the `fetch('/CDP/GetCoacheeDeliverables?coacheeId=...')` code
- Remove the JS `coacheeSelect` change listener that did AJAX
- Remove the JS rowspan rebuild function (rowspan is now server-side only)
- Remove `escapeHtml()` and JS `getApprovalBadge()` functions (no longer needed — all rendering is Razor server-side)
- Remove the `#messageArea` AJAX loading/error div pattern

**Responsive:** Use Bootstrap `d-flex flex-wrap gap-2` on the form so filters wrap on mobile. No custom CSS needed.
  </action>
  <verify>
    <automated>cd "C:/Users/Administrator/Desktop/PortalHC_KPB/.claude/worktrees/terminal-a" && dotnet build --no-restore 2>&1 | tail -5</automated>
  </verify>
  <done>
    - ProtonProgress.cshtml has a GET form with method="get" and asp-action="ProtonProgress"
    - Filter bar contains: Bagian (HC/Admin), Unit (HC/Admin + SrSpv), Coachee (Coach + HC/Admin), Track (all non-Coachee), Tahun (all non-Coachee), Search, Reset
    - Each dropdown uses onchange="this.form.submit()" (or onBagianChange for Bagian)
    - Bagian change clears Unit dropdown before submitting
    - All dropdown option selected attributes use Razor if/else blocks (no ternary in attributes)
    - Search input has NO name attribute (client-side only, not in form submission)
    - Search debounces at 300ms and shows/hides table rows based on data-kompetensi/data-deliverable attributes
    - "Menampilkan X dari Y data" displayed above table
    - Coachee column shown in table when no specific coachee selected
    - Phase 63 AJAX fetch() logic completely removed
    - Reset button navigates to ProtonProgress with no params
    - Build succeeds with 0 errors
  </done>
</task>

</tasks>

<verification>
1. `dotnet build --no-restore` — 0 errors
2. Grep for `form.*method.*get` in ProtonProgress.cshtml — confirms GET form
3. Grep for `onchange.*submit\|onBagianChange` in ProtonProgress.cshtml — confirms auto-submit
4. Grep for `if.*==.*selected` in ProtonProgress.cshtml — confirms if/else Razor pattern (no ternary)
5. Grep for `fetch\|GetCoacheeDeliverables` in ProtonProgress.cshtml — SHOULD NOT match (AJAX removed)
6. Grep for `searchInput.*input.*setTimeout` in ProtonProgress.cshtml — confirms debounced search
7. Grep for `data-kompetensi` in ProtonProgress.cshtml — confirms search data attributes
8. Grep for `Menampilkan.*dari.*data` in ProtonProgress.cshtml — confirms result count
</verification>

<success_criteria>
- ProtonProgress.cshtml renders a complete filter bar with role-conditional visibility
- Every dropdown auto-submits on change via GET form
- Bagian->Unit cascade works: changing Bagian clears Unit and submits
- Client-side search filters table rows without page reload
- All selected attributes use correct Razor if/else pattern (no RZ1031)
- Phase 63 AJAX model completely removed and replaced
- Build succeeds with 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/64-functional-filters/64-02-SUMMARY.md`
</output>
