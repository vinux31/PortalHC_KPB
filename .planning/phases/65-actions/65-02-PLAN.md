---
phase: 65-actions
plan: 02
type: execute
wave: 2
depends_on: ["65-01"]
files_modified:
  - Controllers/CDPController.cs
  - Views/CDP/ProtonProgress.cshtml
autonomous: true
requirements: [ACTN-03, ACTN-04]
must_haves:
  truths:
    - "Coach clicking Submit Evidence on a Pending or Rejected deliverable opens a combined modal with coaching fields + file upload"
    - "Coach can select multiple deliverables in the modal via checkbox tree (Kompetensi > SubKompetensi > Deliverable)"
    - "Submitting the modal creates one CoachingSession per selected deliverable, all with shared field values, and sets Status to Submitted"
    - "Optional file upload saves to wwwroot/uploads/evidence and stores path in EvidencePath on each selected progress record"
    - "On resubmission (Rejected deliverable), SrSpvApprovalStatus and ShApprovalStatus reset to Pending"
    - "Evidence column for non-coach roles shows Sudah Upload / Belum Upload badge"
    - "After submission, row updates in-place with toast — no full page reload"
  artifacts:
    - path: "Controllers/CDPController.cs"
      provides: "SubmitEvidenceWithCoaching multipart AJAX endpoint"
      contains: "SubmitEvidenceWithCoaching"
    - path: "Views/CDP/ProtonProgress.cshtml"
      provides: "Combined evidence+coaching modal with batch deliverable selector"
      contains: "evidenceModal"
  key_links:
    - from: "Views/CDP/ProtonProgress.cshtml"
      to: "CDPController.SubmitEvidenceWithCoaching"
      via: "fetch() with FormData (multipart)"
      pattern: "fetch.*SubmitEvidenceWithCoaching"
    - from: "CDPController.SubmitEvidenceWithCoaching"
      to: "CoachingSession"
      via: "EF Core Add per deliverable"
      pattern: "_context.CoachingSessions.Add"
---

<objective>
Build the combined Evidence + Coaching modal and SubmitEvidenceWithCoaching AJAX endpoint that handles batch deliverable submission with optional file upload.

Purpose: Wires ACTN-03 (coaching report creation) and ACTN-04 (evidence upload from Progress page) end-to-end — coach submits evidence + coaching data in one modal, creates CoachingSession records linked to deliverables.
Output: One new multipart AJAX endpoint in CDPController, combined modal in ProtonProgress.cshtml with batch deliverable selector.
</objective>

<execution_context>
@C:/Users/Administrator/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Administrator/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/65-actions/65-CONTEXT.md
@.planning/phases/65-actions/65-RESEARCH.md
@.planning/phases/65-actions/65-01-SUMMARY.md

<interfaces>
<!-- Plan 01 creates these — executor should verify they exist before starting -->

From Models/ProtonModels.cs (after Plan 01):
```csharp
public class ProtonDeliverableProgress
{
    // ... existing fields ...
    public string Status { get; set; } = "Pending"; // Changed from "Locked"
    public string? EvidencePath { get; set; }
    public string? EvidenceFileName { get; set; }
    // Phase 65 additions:
    public string SrSpvApprovalStatus { get; set; } = "Pending";
    public string ShApprovalStatus { get; set; } = "Pending";
    // ... SrSpvApprovedById, SrSpvApprovedAt, ShApprovedById, ShApprovedAt
}
```

From Models/CoachingSession.cs (after Plan 01):
```csharp
public class CoachingSession
{
    // ... existing fields ...
    public int? ProtonDeliverableProgressId { get; set; } // Plan 01 addition
}
```

From Models/TrackingModels.cs (after Plan 01):
```csharp
public class TrackingItem
{
    // ... existing fields ...
    public string Status { get; set; } = "Pending"; // Plan 01 addition
}
```

From Views/CDP/ProtonProgress.cshtml (after Plan 01):
- Evidence column: Coach sees "Submit Evidence" button for Pending/Rejected deliverables
- tinjaModal already exists (Plan 01)
- actionToast already exists (Plan 01)
- showToast() JS function already exists (Plan 01)
- @Html.AntiForgeryToken() already present (Plan 01)
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: SubmitEvidenceWithCoaching endpoint + combined modal + batch selector</name>
  <files>
    Controllers/CDPController.cs
    Views/CDP/ProtonProgress.cshtml
  </files>
  <action>
**1. Add SubmitEvidenceWithCoaching endpoint** to CDPController.cs (after the HCReviewFromProgress action added in Plan 01):

```csharp
[HttpPost]
[ValidateAntiForgeryToken]
public async Task<IActionResult> SubmitEvidenceWithCoaching(
    [FromForm] string progressIdsJson,
    [FromForm] DateTime date,
    [FromForm] string koacheeCompetencies,
    [FromForm] string catatanCoach,
    [FromForm] string kesimpulan,
    [FromForm] string result,
    IFormFile? evidenceFile)
```

Implementation:
- Get current user, validate Coach role (Level 5)
- Parse progressIdsJson to `List<int>` via `System.Text.Json.JsonSerializer.Deserialize`
- Load all progress records by ids with Include chain:
  ```csharp
  var progresses = await _context.ProtonDeliverableProgresses
      .Include(p => p.ProtonDeliverable)
          .ThenInclude(d => d!.ProtonSubKompetensi)
              .ThenInclude(s => s!.ProtonKompetensi)
      .Where(p => progressIds.Contains(p.Id))
      .ToListAsync();
  ```
- Validate: all progress records must have `CoacheeId` matching one of the coach's coachees (via CoachCoacheeMapping)
- Validate: all must have `Status == "Pending" || Status == "Rejected"` (coach can only submit for these)

- **Handle optional file upload:**
  - If evidenceFile is not null and Length > 0:
    - Validate: file extension must be .pdf, .jpg, .jpeg, or .png (CONTEXT.md: "PDF/JPG/PNG, max 10MB")
    - Validate: file size <= 10 * 1024 * 1024 (10MB)
    - Save to `wwwroot/uploads/evidence/{firstProgressId}/{timestamp}_{filename}`
    - Store relative path: `/uploads/evidence/{firstProgressId}/{timestamp}_{filename}`
  - If no file and the deliverable already has an EvidencePath, keep the existing one (coach can submit coaching report without re-uploading)

- **For each progress record:**
  - Set `Status = "Submitted"`, `SubmittedAt = DateTime.UtcNow`
  - Reset `SrSpvApprovalStatus = "Pending"`, `ShApprovalStatus = "Pending"` (fresh review cycle per CONTEXT.md)
  - Reset `SrSpvApprovedById = null`, `SrSpvApprovedAt = null`, `ShApprovedById = null`, `ShApprovedAt = null`
  - If file was uploaded: set `EvidencePath = evidencePath`, `EvidenceFileName = evidenceFile.FileName`
  - Create `CoachingSession` record:
    ```csharp
    var session = new CoachingSession
    {
        CoachId = user.Id,
        CoacheeId = progress.CoacheeId,
        Date = date,
        Kompetensi = progress.ProtonDeliverable?.ProtonSubKompetensi?.ProtonKompetensi?.NamaKompetensi ?? "",
        SubKompetensi = progress.ProtonDeliverable?.ProtonSubKompetensi?.NamaSubKompetensi ?? "",
        Deliverable = progress.ProtonDeliverable?.NamaDeliverable ?? "",
        CoacheeCompetencies = koacheeCompetencies,
        CatatanCoach = catatanCoach,
        Kesimpulan = kesimpulan,
        Result = result,
        Status = "Submitted",
        ProtonDeliverableProgressId = progress.Id,
        CreatedAt = DateTime.UtcNow
    };
    _context.CoachingSessions.Add(session);
    ```

- `await _context.SaveChangesAsync()`
- Return JSON: `{ success: true, message: "{count} deliverable berhasil disubmit", submittedIds: [...] }`

**IMPORTANT: FormData + AntiForgery:** Do NOT set Content-Type header in the fetch call — browser sets multipart boundary automatically. Only set `RequestVerificationToken` header. See RESEARCH Pattern 1 and Pitfall 4.

**2. Add Combined Evidence + Coaching Modal** to ProtonProgress.cshtml:

Place after the tinjaModal (Plan 01) and before the toast container. This is the `#evidenceModal`:

```html
<div class="modal fade" id="evidenceModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Submit Evidence & Coaching Report</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- Deliverable selector (batch) -->
        <div class="mb-3">
          <label class="form-label fw-bold">Deliverable</label>
          <div id="deliverableSelector" class="border rounded p-2" style="max-height:200px;overflow-y:auto">
            <!-- JS populates: checkboxes grouped by Kompetensi > SubKompetensi > Deliverable -->
          </div>
        </div>
        <hr/>
        <!-- Date -->
        <div class="mb-3">
          <label class="form-label">Tanggal</label>
          <input type="date" class="form-control" id="evidenceDate" />
        </div>
        <!-- Kompetensi Coachee (free-text) -->
        <div class="mb-3">
          <label class="form-label">Kompetensi Coachee</label>
          <textarea class="form-control" id="evidenceKoacheeComp" rows="2" placeholder="Coach menuliskan competencies yang harus dipenuhi sesuai dengan workbook"></textarea>
        </div>
        <!-- Catatan Coach -->
        <div class="mb-3">
          <label class="form-label">Catatan Coach</label>
          <textarea class="form-control" id="evidenceCatatan" rows="3"></textarea>
        </div>
        <!-- Kesimpulan dropdown -->
        <div class="mb-3">
          <label class="form-label">Kesimpulan</label>
          <select class="form-select" id="evidenceKesimpulan">
            <option value="">-- Pilih --</option>
            <option value="Kompeten secara mandiri">Kompeten secara mandiri</option>
            <option value="Masih perlu dikembangkan">Masih perlu dikembangkan</option>
          </select>
        </div>
        <!-- Result dropdown -->
        <div class="mb-3">
          <label class="form-label">Result</label>
          <select class="form-select" id="evidenceResult">
            <option value="">-- Pilih --</option>
            <option value="Need Improvement">Need Improvement</option>
            <option value="Suitable">Suitable</option>
            <option value="Good">Good</option>
            <option value="Excellence">Excellence</option>
          </select>
        </div>
        <!-- File upload -->
        <div class="mb-3">
          <label class="form-label">File Evidence (opsional, PDF/JPG/PNG, max 10MB)</label>
          <input type="file" class="form-control" id="evidenceFile" accept=".pdf,.jpg,.jpeg,.png" />
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-primary" id="btnSubmitEvidence">Submit</button>
      </div>
    </div>
  </div>
</div>
```

**3. Wire Submit Evidence buttons to modal:**

The Plan 01 Evidence column already shows "Submit Evidence" buttons for Coach on Pending/Rejected deliverables. Give these buttons: `class="btn btn-sm btn-primary btnSubmitEvidence" data-progress-id="@item.Id" data-deliverable="@item.Deliverable" data-kompetensi="@item.Kompetensi" data-sub-kompetensi="@item.SubKompetensi" data-status="@item.Status"`.

Note: if Plan 01 already placed stub buttons, update them to have these data attributes and class. If not, add them in the Evidence column where Plan 01 placed the conditional Coach button.

**4. Add JavaScript** in @section Scripts (after Plan 01's JS):

**Deliverable selector population:**
- Build a JS data structure from the table: scan all `<tr>` rows with `data-progress-id` and extract progress-id, kompetensi, sub-kompetensi, deliverable, status
- Only include deliverables where `status == "Pending" || status == "Rejected"` (coach can select)
- Group by Kompetensi > SubKompetensi > Deliverable
- Render as nested checkboxes with collapsible Kompetensi/SubKompetensi headers

**Modal show handler:**
- When a `btnSubmitEvidence` is clicked, programmatically show the modal
- Pre-check the clicked deliverable's checkbox in the selector
- Set today's date in the date field
- Clear all other fields

**Submit handler (btnSubmitEvidence click):**
- Collect all checked deliverable progress IDs
- Validate: at least one selected
- Validate: kesimpulan and result selected
- Build `FormData`:
  ```javascript
  var formData = new FormData();
  formData.append('progressIdsJson', JSON.stringify(selectedIds));
  formData.append('date', document.getElementById('evidenceDate').value);
  formData.append('koacheeCompetencies', document.getElementById('evidenceKoacheeComp').value);
  formData.append('catatanCoach', document.getElementById('evidenceCatatan').value);
  formData.append('kesimpulan', document.getElementById('evidenceKesimpulan').value);
  formData.append('result', document.getElementById('evidenceResult').value);
  var fileInput = document.getElementById('evidenceFile');
  if (fileInput.files[0]) formData.append('evidenceFile', fileInput.files[0]);
  ```
- Validate file size: if file.size > 10 * 1024 * 1024, show error toast and return
- fetch POST to `/CDP/SubmitEvidenceWithCoaching` with:
  - `headers: { 'RequestVerificationToken': token }` — do NOT set Content-Type (Pitfall 4)
  - `body: formData`
- On success:
  - Dismiss modal, show success toast
  - For each submitted progress ID: update the Evidence column badge to "Sudah Upload" (or leave existing), update the Status column badge to "Submitted" (blue), hide the "Submit Evidence" button (it was for Pending/Rejected only)
  - **Update stat cards:** recalculate Pending Evidence count (subtract submitted count), recalculate Progress % client-side
- On error: show error toast

**5. Stat cards update logic:**

After Plan 01 sets up stat cards (Progress %, Pending Evidence, Pending Approvals), add a client-side function `updateStatCards()` that recounts from table rows:
- Count all rows, sum: Pending=0, Submitted=0.5, Approved=1.0, Rejected=0 → compute new progress %
- Count Pending + Rejected = pending evidence
- Count Submitted for the user's role = pending approvals

Call this after any AJAX action (approve/reject/submit evidence/HC review) to keep stat cards accurate without page reload.
  </action>
  <verify>
    <automated>cd C:/Users/Administrator/Desktop/PortalHC_KPB/.claude/worktrees/terminal-a && dotnet build --configuration Release 2>&1 | tail -5</automated>
  </verify>
  <done>
    - SubmitEvidenceWithCoaching POST endpoint creates CoachingSession records per deliverable and updates Status to Submitted
    - Evidence+Coaching modal has all 7 fields (date, competencies, catatan, kesimpulan, result, file, deliverable selector)
    - Batch deliverable selector allows multi-select via checkboxes grouped by Kompetensi
    - File upload saves to wwwroot/uploads/evidence/ and validates extension+size
    - On resubmission, SrSpvApprovalStatus and ShApprovalStatus reset to Pending
    - Submit Evidence buttons appear for Coach on Pending/Rejected deliverables only
    - After submit, row updates in-place and stat cards refresh
    - Build succeeds with 0 errors
  </done>
</task>

</tasks>

<verification>
1. `dotnet build --configuration Release` — 0 errors
2. CDPController has SubmitEvidenceWithCoaching action with [HttpPost][ValidateAntiForgeryToken]
3. ProtonProgress.cshtml has evidenceModal with deliverable selector, coaching fields, file upload
4. Batch submission creates N CoachingSession records for N selected deliverables
5. File upload validates .pdf/.jpg/.jpeg/.png extension and 10MB size limit
6. FormData AJAX does NOT set Content-Type header
7. After submission: row Evidence column shows "Sudah Upload", Status shows "Submitted", Submit Evidence button hidden
8. Stat cards update after AJAX submission
</verification>

<success_criteria>
- Coach clicks Submit Evidence → modal opens with clicked deliverable pre-selected → fills coaching fields → submits → CoachingSession records created in DB → Status changes to Submitted → row updates in-place with toast
- Coach can select multiple deliverables in one modal submission
- File upload is optional; if provided, saved to wwwroot/uploads/evidence/
- On resubmission after rejection, approval columns reset to Pending
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/65-actions/65-02-SUMMARY.md`
</output>
