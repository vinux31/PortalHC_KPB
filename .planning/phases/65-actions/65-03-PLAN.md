---
phase: 65-actions
plan: 03
type: execute
wave: 3
depends_on: ["65-01", "65-02"]
files_modified:
  - Controllers/CDPController.cs
  - Views/CDP/ProtonProgress.cshtml
  - Views/CDP/Deliverable.cshtml
  - Program.cs
  - HcPortal.csproj
autonomous: true
requirements: [ACTN-05]
must_haves:
  truths:
    - "SrSpv/SH/HC/Admin clicking Export Excel downloads an .xlsx file with deliverable data including coaching columns (Catatan Coach, Kesimpulan, Result)"
    - "SrSpv/SH/HC/Admin clicking Export PDF downloads a .pdf file with table-style layout and coachee name header"
    - "Export filename follows pattern CoacheeName_Progress_YYYY-MM-DD.xlsx/.pdf"
    - "Coach and Coachee do NOT see export buttons"
    - "Deliverable detail page shows coaching report data (Catatan, Kesimpulan, Result, uploaded file) and rejection reason"
  artifacts:
    - path: "Controllers/CDPController.cs"
      provides: "ExportProgressExcel and ExportProgressPdf GET endpoints"
      contains: "ExportProgressExcel"
    - path: "Views/CDP/ProtonProgress.cshtml"
      provides: "Export Excel and Export PDF buttons near stat cards"
      contains: "ExportProgressExcel"
    - path: "Views/CDP/Deliverable.cshtml"
      provides: "Coaching report display section and rejection reason"
      contains: "CatatanCoach"
    - path: "HcPortal.csproj"
      provides: "QuestPDF package reference"
      contains: "QuestPDF"
  key_links:
    - from: "Views/CDP/ProtonProgress.cshtml"
      to: "CDPController.ExportProgressExcel"
      via: "href link with coacheeId param"
      pattern: "ExportProgressExcel"
    - from: "Views/CDP/ProtonProgress.cshtml"
      to: "CDPController.ExportProgressPdf"
      via: "href link with coacheeId param"
      pattern: "ExportProgressPdf"
    - from: "CDPController.ExportProgressPdf"
      to: "QuestPDF Document.Create"
      via: "QuestPDF API call"
      pattern: "Document.Create"
---

<objective>
Add Excel and PDF export endpoints, export buttons on ProtonProgress page, and update Deliverable detail page to show coaching report data and rejection reason.

Purpose: Wires ACTN-05 (Export Excel/PDF) end-to-end, and completes the Deliverable detail page with coaching report display as specified in CONTEXT.md.
Output: Two new GET endpoints (ExportProgressExcel, ExportProgressPdf), QuestPDF package installed, export buttons in ProtonProgress.cshtml, updated Deliverable.cshtml with coaching section.
</objective>

<execution_context>
@C:/Users/Administrator/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Administrator/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/65-actions/65-CONTEXT.md
@.planning/phases/65-actions/65-RESEARCH.md
@.planning/phases/65-actions/65-01-SUMMARY.md
@.planning/phases/65-actions/65-02-SUMMARY.md

<interfaces>
<!-- Plan 01+02 provide these. Executor should verify they exist. -->

From Controllers/CDPController.cs (after Plans 01+02):
- `ProtonProgress(...)` — GET action with filter params, returns View with List<TrackingItem>
- `ApproveFromProgress(...)` — POST AJAX endpoint
- `RejectFromProgress(...)` — POST AJAX endpoint
- `HCReviewFromProgress(...)` — POST AJAX endpoint
- `SubmitEvidenceWithCoaching(...)` — POST multipart endpoint

From Models/TrackingModels.cs (after Plan 01):
```csharp
public class TrackingItem
{
    public int Id { get; set; }
    public string Kompetensi { get; set; } = "";
    public string SubKompetensi { get; set; } = "";
    public string Deliverable { get; set; } = "";
    public string EvidenceStatus { get; set; } = "";
    public string FullEvidencePath { get; set; } = "";
    public string ApprovalSrSpv { get; set; } = "Not Started";
    public string ApprovalSectionHead { get; set; } = "Not Started";
    public string ApprovalHC { get; set; } = "Not Started";
    public string Status { get; set; } = "Pending";
    public string CoacheeId { get; set; } = "";
    public string CoacheeName { get; set; } = "";
    // ... tooltip fields ...
}
```

From Models/CoachingSession.cs (after Plan 01):
```csharp
public class CoachingSession
{
    public int Id { get; set; }
    public string CoachId { get; set; } = "";
    public string CoacheeId { get; set; } = "";
    public DateTime Date { get; set; }
    public string Kompetensi { get; set; } = "";
    public string SubKompetensi { get; set; } = "";
    public string Deliverable { get; set; } = "";
    public string CoacheeCompetencies { get; set; } = "";
    public string CatatanCoach { get; set; } = "";
    public string Kesimpulan { get; set; } = "";
    public string Result { get; set; } = "";
    public string Status { get; set; } = "Draft";
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    public DateTime? UpdatedAt { get; set; }
    public int? ProtonDeliverableProgressId { get; set; }
    public ICollection<ActionItem> ActionItems { get; set; } = new List<ActionItem>();
}
```

From Views/CDP/ProtonProgress.cshtml (after Plans 01+02):
- GET form filter bar, stat cards, Tinjau modal, evidence modal, toast container
- Table with Kompetensi | Sub-Kompetensi | Deliverable | Evidence | Approval Sr.Spv | Approval SH | Approval HC | Detail

From Views/CDP/Deliverable.cshtml (existing, not yet modified by Phase 65):
- Shows deliverable detail with evidence upload form, approval buttons, status display
- CDPController.Deliverable(int id) at line ~754

Existing ClosedXML pattern (from CDPController.ExportAnalyticsResults):
```csharp
using var workbook = new XLWorkbook();
var worksheet = workbook.Worksheets.Add("Sheet1");
// ... headers + data ...
worksheet.Columns().AdjustToContents();
using var stream = new MemoryStream();
workbook.SaveAs(stream);
return File(stream.ToArray(), "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", filename);
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install QuestPDF, add export endpoints (Excel + PDF), add export buttons to ProtonProgress</name>
  <files>
    HcPortal.csproj
    Program.cs
    Controllers/CDPController.cs
    Views/CDP/ProtonProgress.cshtml
  </files>
  <action>
**1. Install QuestPDF:**

```bash
cd C:/Users/Administrator/Desktop/PortalHC_KPB/.claude/worktrees/terminal-a
dotnet add package QuestPDF
```

**2. Configure QuestPDF license** in Program.cs:

Add near the top of Program.cs (before `var builder = WebApplication.CreateBuilder(args)`), or after `builder.Build()` but before `app.Run()`:
```csharp
QuestPDF.Settings.License = QuestPDF.Infrastructure.LicenseType.Community;
```

Add the using at the top of Program.cs:
```csharp
using QuestPDF.Infrastructure;
```

**3. Add ExportProgressExcel endpoint** to CDPController.cs:

```csharp
[HttpGet]
[Authorize(Roles = "Sr Supervisor, Section Head, HC, Admin")]
public async Task<IActionResult> ExportProgressExcel(string coacheeId)
```

Implementation:
- Get current user, validate role (Level 1-4 only — not Coach or Coachee per CONTEXT.md)
- Load coachee user to get `FullName` for filename
- Load deliverable progress data using same query as ProtonProgress action — but filtered to single `coacheeId`
- **Also load coaching sessions** for each deliverable:
  ```csharp
  var coachingSessions = await _context.CoachingSessions
      .Where(cs => cs.CoacheeId == coacheeId && cs.ProtonDeliverableProgressId != null)
      .GroupBy(cs => cs.ProtonDeliverableProgressId)
      .ToDictionaryAsync(g => g.Key!.Value, g => g.OrderByDescending(cs => cs.CreatedAt).First());
  ```
  This gets the latest coaching session per deliverable progress.

- Build Excel using ClosedXML (existing project pattern):
  ```csharp
  using ClosedXML.Excel;
  using var workbook = new XLWorkbook();
  var ws = workbook.Worksheets.Add("Proton Progress");
  ```
- Header row (10 columns, flat — Claude discretion per CONTEXT.md):
  `Kompetensi | Sub Kompetensi | Deliverable | Evidence | Approval SrSpv | Approval SH | Approval HC | Catatan Coach | Kesimpulan | Result`
- Style header: Bold, LightBlue background
- Data rows: for each deliverable progress item, fill columns. For coaching columns, use the latest CoachingSession from the dictionary (or empty string if no session).
- `ws.Columns().AdjustToContents()`
- Return file:
  ```csharp
  using var stream = new MemoryStream();
  workbook.SaveAs(stream);
  var safeName = (coacheeUser?.FullName ?? "Coachee").Replace(" ", "_");
  return File(stream.ToArray(),
      "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
      $"{safeName}_Progress_{DateTime.Now:yyyy-MM-dd}.xlsx");
  ```

**4. Add ExportProgressPdf endpoint** to CDPController.cs:

```csharp
[HttpGet]
[Authorize(Roles = "Sr Supervisor, Section Head, HC, Admin")]
public async Task<IActionResult> ExportProgressPdf(string coacheeId)
```

Implementation:
- Same data loading as ExportProgressExcel
- Use QuestPDF API:
  ```csharp
  using QuestPDF.Fluent;
  using QuestPDF.Helpers;

  var coacheeName = coacheeUser?.FullName ?? "Coachee";
  var pdf = Document.Create(container =>
  {
      container.Page(page =>
      {
          page.Size(PageSizes.A4.Landscape());
          page.Margin(20);
          page.Content().Column(col =>
          {
              col.Item().Text($"Proton Progress — {coacheeName}").FontSize(14).Bold();
              col.Item().Text($"Export date: {DateTime.Now:dd MMM yyyy}").FontSize(9);
              col.Item().PaddingTop(10).Table(table =>
              {
                  table.ColumnsDefinition(cols =>
                  {
                      cols.RelativeColumn(2); // Kompetensi
                      cols.RelativeColumn(2); // Sub Kompetensi
                      cols.RelativeColumn(2); // Deliverable
                      cols.RelativeColumn(1); // Evidence
                      cols.RelativeColumn(1); // SrSpv
                      cols.RelativeColumn(1); // SH
                      cols.RelativeColumn(1); // HC
                      cols.RelativeColumn(2); // Catatan
                      cols.RelativeColumn(1.5f); // Kesimpulan
                      cols.RelativeColumn(1); // Result
                  });
                  // Header row
                  foreach (var header in new[] {"Kompetensi", "Sub Kompetensi", "Deliverable", "Evidence", "Approval SrSpv", "Approval SH", "Approval HC", "Catatan Coach", "Kesimpulan", "Result"})
                  {
                      table.Cell().Background(Colors.Blue.Lighten4).Padding(3).Text(header).FontSize(8).Bold();
                  }
                  // Data rows
                  foreach (var item in data)
                  {
                      var cs = coachingSessions.ContainsKey(item.Id) ? coachingSessions[item.Id] : null;
                      table.Cell().BorderBottom(1).BorderColor(Colors.Grey.Lighten2).Padding(3).Text(item.Kompetensi).FontSize(7);
                      table.Cell().BorderBottom(1).BorderColor(Colors.Grey.Lighten2).Padding(3).Text(item.SubKompetensi).FontSize(7);
                      table.Cell().BorderBottom(1).BorderColor(Colors.Grey.Lighten2).Padding(3).Text(item.Deliverable).FontSize(7);
                      table.Cell().BorderBottom(1).BorderColor(Colors.Grey.Lighten2).Padding(3).Text(item.EvidenceStatus).FontSize(7);
                      table.Cell().BorderBottom(1).BorderColor(Colors.Grey.Lighten2).Padding(3).Text(item.ApprovalSrSpv).FontSize(7);
                      table.Cell().BorderBottom(1).BorderColor(Colors.Grey.Lighten2).Padding(3).Text(item.ApprovalSectionHead).FontSize(7);
                      table.Cell().BorderBottom(1).BorderColor(Colors.Grey.Lighten2).Padding(3).Text(item.ApprovalHC).FontSize(7);
                      table.Cell().BorderBottom(1).BorderColor(Colors.Grey.Lighten2).Padding(3).Text(cs?.CatatanCoach ?? "").FontSize(7);
                      table.Cell().BorderBottom(1).BorderColor(Colors.Grey.Lighten2).Padding(3).Text(cs?.Kesimpulan ?? "").FontSize(7);
                      table.Cell().BorderBottom(1).BorderColor(Colors.Grey.Lighten2).Padding(3).Text(cs?.Result ?? "").FontSize(7);
                  }
              });
          });
      });
  });

  var pdfStream = new MemoryStream();
  pdf.GeneratePdf(pdfStream);
  var safeName = coacheeName.Replace(" ", "_");
  return File(pdfStream.ToArray(), "application/pdf",
      $"{safeName}_Progress_{DateTime.Now:yyyy-MM-dd}.pdf");
  ```

**5. Add export buttons** to ProtonProgress.cshtml:

Place the export buttons near the stat cards section (after stat cards, before the table). Only visible to SrSpv/SH/HC/Admin (userLevel <= 4):

```html
@if (userLevel <= 4 && !string.IsNullOrEmpty(selectedCoacheeId))
{
    <div class="mb-3">
        <a href="@Url.Action("ExportProgressExcel", "CDP", new { coacheeId = selectedCoacheeId })"
           class="btn btn-sm btn-outline-success me-2">
            <i class="bi bi-file-earmark-excel"></i> Export Excel
        </a>
        <a href="@Url.Action("ExportProgressPdf", "CDP", new { coacheeId = selectedCoacheeId })"
           class="btn btn-sm btn-outline-danger">
            <i class="bi bi-file-earmark-pdf"></i> Export PDF
        </a>
    </div>
}
```

Note: Export requires a specific coachee selected (`selectedCoacheeId` not empty) — you can't export the multi-coachee aggregate view per CONTEXT.md ("current coachee only").

If Bootstrap Icons (`bi`) are not available, use text-only buttons without icons.
  </action>
  <verify>
    <automated>cd C:/Users/Administrator/Desktop/PortalHC_KPB/.claude/worktrees/terminal-a && dotnet build --configuration Release 2>&1 | tail -5</automated>
  </verify>
  <done>
    - QuestPDF package installed and license configured in Program.cs
    - ExportProgressExcel GET endpoint generates .xlsx with 10 columns including coaching data
    - ExportProgressPdf GET endpoint generates .pdf with table layout and coachee name header
    - Export buttons visible to SrSpv/SH/HC/Admin only, when a coachee is selected
    - Filename follows CoacheeName_Progress_YYYY-MM-DD pattern
    - Build succeeds with 0 errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Deliverable detail page with coaching report display and rejection reason</name>
  <files>
    Controllers/CDPController.cs
    Views/CDP/Deliverable.cshtml
  </files>
  <action>
**1. Update CDPController.Deliverable action** (line ~754) to load coaching session data:

After loading the `ProtonDeliverableProgress` record, also load coaching sessions linked to this progress:
```csharp
var coachingSessions = await _context.CoachingSessions
    .Where(cs => cs.ProtonDeliverableProgressId == id)
    .OrderByDescending(cs => cs.CreatedAt)
    .ToListAsync();
ViewBag.CoachingSessions = coachingSessions;
```

Also load the coach's name for display:
```csharp
if (coachingSessions.Any())
{
    var coachIds = coachingSessions.Select(cs => cs.CoachId).Distinct().ToList();
    var coachNames = await _context.Users
        .Where(u => coachIds.Contains(u.Id))
        .ToDictionaryAsync(u => u.Id, u => u.FullName ?? u.UserName ?? u.Id);
    ViewBag.CoachNames = coachNames;
}
else
{
    ViewBag.CoachNames = new Dictionary<string, string>();
}
```

Also pass the rejection reason to the view:
```csharp
ViewBag.RejectionReason = progress.RejectionReason;
ViewBag.DeliverableStatus = progress.Status;
```

**2. Update Deliverable.cshtml** to display coaching report and rejection reason:

Add a new section after the existing evidence/approval display, before any footer or back button:

```html
@{
    var coachingSessions = ViewBag.CoachingSessions as List<HcPortal.Models.CoachingSession> ?? new List<HcPortal.Models.CoachingSession>();
    var coachNames = ViewBag.CoachNames as Dictionary<string, string> ?? new Dictionary<string, string>();
    var rejectionReason = ViewBag.RejectionReason as string;
    var deliverableStatus = ViewBag.DeliverableStatus as string;
}

@if (deliverableStatus == "Rejected" && !string.IsNullOrEmpty(rejectionReason))
{
    <div class="alert alert-danger mt-3">
        <h6 class="alert-heading">Alasan Penolakan</h6>
        <p class="mb-0">@rejectionReason</p>
    </div>
}

@if (coachingSessions.Any())
{
    <div class="card mt-3">
        <div class="card-header">
            <h6 class="mb-0">Coaching Reports</h6>
        </div>
        <div class="card-body">
            @foreach (var session in coachingSessions)
            {
                var coachName = coachNames.ContainsKey(session.CoachId) ? coachNames[session.CoachId] : session.CoachId;
                <div class="border rounded p-3 mb-2">
                    <div class="d-flex justify-content-between">
                        <strong>@coachName</strong>
                        <small class="text-muted">@session.Date.ToString("dd MMM yyyy")</small>
                    </div>
                    <table class="table table-sm table-borderless mt-2 mb-0">
                        <tr>
                            <td class="text-muted" style="width:180px">Kompetensi Coachee</td>
                            <td>@session.CoacheeCompetencies</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Catatan Coach</td>
                            <td style="white-space:pre-line">@session.CatatanCoach</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Kesimpulan</td>
                            <td>@session.Kesimpulan</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Result</td>
                            <td>@session.Result</td>
                        </tr>
                    </table>
                </div>
            }
        </div>
    </div>
}
```

If the deliverable has an evidence file uploaded (EvidencePath not null), ensure the existing evidence section shows a viewable/downloadable link. Check existing Deliverable.cshtml — if it already shows evidence, leave it. If not, add:
```html
@if (!string.IsNullOrEmpty(ViewBag.EvidencePath as string))
{
    <div class="mt-2">
        <strong>Evidence File:</strong>
        <a href="@ViewBag.EvidencePath" target="_blank" class="ms-2">@(ViewBag.EvidenceFileName ?? "Download")</a>
    </div>
}
```

Pass `ViewBag.EvidencePath = progress.EvidencePath` and `ViewBag.EvidenceFileName = progress.EvidenceFileName` from the controller if not already passed.
  </action>
  <verify>
    <automated>cd C:/Users/Administrator/Desktop/PortalHC_KPB/.claude/worktrees/terminal-a && dotnet build --configuration Release 2>&1 | tail -5</automated>
  </verify>
  <done>
    - Deliverable detail page shows coaching report section with all sessions (Date, CoacheeCompetencies, Catatan, Kesimpulan, Result) ordered newest first
    - Deliverable detail page shows rejection reason alert when Status==Rejected
    - Evidence file is viewable/downloadable from Deliverable detail page
    - Coach name displayed alongside each coaching session
    - Build succeeds with 0 errors
  </done>
</task>

</tasks>

<verification>
1. `dotnet build --configuration Release` — 0 errors
2. QuestPDF package in HcPortal.csproj, license set in Program.cs
3. ExportProgressExcel and ExportProgressPdf actions exist with [Authorize] for SrSpv/SH/HC/Admin
4. Export buttons visible in ProtonProgress.cshtml only for userLevel <= 4 and selectedCoacheeId not empty
5. Deliverable.cshtml has Coaching Reports card section with CoachingSession data
6. Deliverable.cshtml shows rejection reason alert for Rejected status
7. Export includes coaching columns (Catatan Coach, Kesimpulan, Result) from CoachingSession
</verification>

<success_criteria>
- SrSpv/SH/HC/Admin clicking Export Excel → downloads .xlsx with all deliverable + coaching data
- SrSpv/SH/HC/Admin clicking Export PDF → downloads .pdf with table layout
- Filename: CoacheeName_Progress_YYYY-MM-DD.xlsx/.pdf
- Coach and Coachee do NOT see export buttons
- Deliverable detail page shows coaching reports (Catatan, Kesimpulan, Result, Date, Coach name)
- Deliverable detail page shows rejection reason when Status==Rejected
- Evidence file viewable/downloadable from Deliverable detail page
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/65-actions/65-03-SUMMARY.md`
</output>
