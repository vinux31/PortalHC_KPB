---
phase: 66-ui-polish
plan: 02
type: execute
wave: 2
depends_on:
  - 66-01
files_modified:
  - Views/CDP/ProtonProgress.cshtml
autonomous: false
requirements:
  - UI-02
  - UI-04

must_haves:
  truths:
    - "When no data exists, the table is replaced with a centered icon + message in Bahasa Indonesia"
    - "Empty state scenario 'no_coachees': shows informational message only, no Hapus Filter button"
    - "Empty state scenario 'no_filter_match': shows message + 'Hapus Filter' button that calls clearFilters()"
    - "Empty state scenario 'no_deliverables': shows informational message only, no Hapus Filter button"
    - "Role-aware empty state: HC/Admin sees contextual hint (assign track); Coach/Coachee sees simple informational text"
    - "Pagination navigation bar shows at bottom of table when TotalPages > 1"
    - "Numbered pagination « 1 2 3 » with active page highlighted; Previous/Next arrows shown when applicable"
    - "All pagination links preserve the current filter params (bagian, unit, trackType, tahun, coacheeId)"
    - "Result count shows 'Menampilkan X-Y dari Z deliverable' using ViewBag.PageFirstRow/PageLastRow/FilteredCount"
    - "Filter form submission resets to page=1 (default page parameter)"
    - "Spinner overlay appears on filter change and pagination navigation, dismissed on DOMContentLoaded"
    - "After page navigation, page auto-scrolls to #progressTable"
    - "Network error during AJAX shows toast (existing showToast function), keeps current data visible"
  artifacts:
    - path: Views/CDP/ProtonProgress.cshtml
      provides: "Empty state rendering + pagination controls + spinner overlay"
      contains: "ViewBag.EmptyScenario, ViewBag.TotalPages, ViewBag.CurrentPage, loadingSpinner, page-item"
  key_links:
    - from: Views/CDP/ProtonProgress.cshtml
      to: Controllers/CDPController.cs
      via: "Url.Action('ProtonProgress', new { bagian, unit, trackType, tahun, coacheeId, page }) links in pagination nav"
      pattern: "page = .*ViewBag\\.CurrentPage"
---

<objective>
Implement empty state UI and pagination controls in ProtonProgress.cshtml, using the ViewBag fields set by Plan 01.

Purpose: UI-02 (empty states) requires replacing the current plain `alert alert-info` with a centered icon + scenario-aware Bahasa Indonesia message + optional "Hapus Filter" CTA. UI-04 (pagination) requires a numbered pagination nav at the bottom of the table, a result count string, and a spinner overlay for loading feedback. This plan delivers the complete view-side implementation.

Output:
- ProtonProgress.cshtml updated with: role-aware empty state rendering, spinner overlay, pagination nav bar, updated result count display
</objective>

<execution_context>
@C:/Users/Administrator/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Administrator/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/66-ui-polish/66-CONTEXT.md
@.planning/phases/66-ui-polish/66-RESEARCH.md
@.planning/phases/66-ui-polish/66-01-SUMMARY.md
@Views/CDP/ProtonProgress.cshtml

<interfaces>
<!-- ViewBag fields set by Plan 01 (CDPController.ProtonProgress) -->
<!--
  ViewBag.CurrentPage   : int — current page number (1-based)
  ViewBag.TotalPages    : int — total number of pages
  ViewBag.PageFirstRow  : int — 1-based index of first row on current page (0 if no data)
  ViewBag.PageLastRow   : int — 1-based index of last row on current page (0 if no data)
  ViewBag.FilteredCount : int — total rows across all pages (set to progresses.Count by Plan 01)
  ViewBag.EmptyScenario : string — one of: "no_coachees", "no_filter_match", "no_deliverables", "" (non-empty)

  Existing ViewBag fields preserved:
  ViewBag.SelectedBagian, ViewBag.SelectedUnit, ViewBag.SelectedTrackType, ViewBag.SelectedTahun
  ViewBag.SelectedCoacheeId — the selected coachee ID (needed in pagination links)
  ViewBag.UserLevel, ViewBag.UserRole
-->

<!-- Existing Razor variables at top of view (lines 1-58) -->
<!--
  var userLevel = (int)ViewBag.UserLevel;
  var userRole = ViewBag.UserRole as string ?? "";
  var selectedBagian = ViewBag.SelectedBagian as string ?? "";
  var selectedUnit = ViewBag.SelectedUnit as string ?? "";
  var selectedTrackType = ViewBag.SelectedTrackType as string ?? "";
  var selectedTahun = ViewBag.SelectedTahun as string ?? "";
  var selectedCoacheeId = ViewBag.SelectedCoacheeId as string ?? "";
  (Model = List<TrackingItem>, now contains only current page's rows)
-->

<!-- Existing JS functions in view (already defined, do not redefine) -->
<!--
  clearFilters() — navigates to ProtonProgress with no params (clears all filters + resets page=1)
  showToast(message, type) — shows Bootstrap toast (existing)
  progressTable — id="progressTable" on the <table> element (line 291)
-->
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pagination ViewBag vars, update result count label, replace empty state, add spinner overlay and auto-scroll</name>
  <files>Views/CDP/ProtonProgress.cshtml</files>
  <action>
Make all view-level changes to ProtonProgress.cshtml. Read the full file first, then apply all changes in one pass.

**Change 1: Add pagination + empty state variables to the Razor `@{ }` block at the top (after the existing var declarations, before closing `}`)**

Add after `var showCoacheeColumn = ...`:
```csharp
var currentPage = (int)(ViewBag.CurrentPage ?? 1);
var totalPages = (int)(ViewBag.TotalPages ?? 1);
var pageFirstRow = (int)(ViewBag.PageFirstRow ?? 0);
var pageLastRow = (int)(ViewBag.PageLastRow ?? 0);
var filteredCount = (int)(ViewBag.FilteredCount ?? 0);
var emptyScenario = ViewBag.EmptyScenario as string ?? "";
```

**Change 2: Update the result count line** (currently line ~200: `<small class="text-muted mb-2 d-block">Menampilkan @ViewBag.FilteredCount dari @ViewBag.TotalCount data</small>`)

Replace with:
```html
<small class="text-muted mb-2 d-block">
    @if (Model.Count > 0)
    {
        <span>Menampilkan @pageFirstRow–@pageLastRow dari @filteredCount deliverable</span>
    }
    else
    {
        <span>@filteredCount deliverable total</span>
    }
</small>
```

**Change 3: Add loading spinner overlay** — place immediately AFTER the closing `</form>` of the filter bar form (before the result count `<small>` tag):

```html
@* Loading spinner overlay — shown on filter/page navigation, hidden on DOMContentLoaded *@
<div id="loadingSpinner" class="d-none"
     style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.75);z-index:9999;display:flex;align-items:center;justify-content:center;pointer-events:none;">
    <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem;">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>
```

**Change 4: Replace the empty state block** (currently lines ~276-280):

Find and replace this exact block:
```html
    @* Empty state — no data matching current filters *@
    @if (Model.Count == 0 && !string.IsNullOrEmpty(ViewBag.EmptyMessage as string))
    {
        <div class="alert alert-info">@ViewBag.EmptyMessage</div>
    }
```

With the new scenario-aware empty state:
```html
    @* Empty state — scenario-aware icon + message (UI-02) *@
    @if (Model.Count == 0)
    {
        <div id="emptyStateContainer" class="text-center py-5 border rounded bg-light">
            @if (emptyScenario == "no_coachees")
            {
                <i class="bi bi-people fs-1 text-muted mb-3 d-block"></i>
                @if (isHC)
                {
                    <h5 class="text-muted mb-1">Belum ada coachee yang ditugaskan</h5>
                    <p class="text-muted small">Tambahkan mapping Coach-Coachee di menu Kelola Data untuk memulai.</p>
                }
                else
                {
                    <h5 class="text-muted mb-1">Belum ada coachee yang ditugaskan</h5>
                }
            }
            else if (emptyScenario == "no_filter_match")
            {
                <i class="bi bi-funnel fs-1 text-muted mb-3 d-block"></i>
                <h5 class="text-muted mb-1">Tidak ada deliverable yang sesuai filter</h5>
                <p class="text-muted small">Coba ubah atau hapus filter yang aktif.</p>
                <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="clearFilters()">
                    <i class="bi bi-arrow-counterclockwise me-1"></i>Hapus Filter
                </button>
            }
            else if (emptyScenario == "no_deliverables")
            {
                <i class="bi bi-inbox fs-1 text-muted mb-3 d-block"></i>
                @if (isHC)
                {
                    <h5 class="text-muted mb-1">Belum ada data deliverable</h5>
                    <p class="text-muted small">Pastikan coachee sudah ditugaskan ke Proton Track.</p>
                }
                else if (isCoach)
                {
                    <h5 class="text-muted mb-1">Coachee ini belum memiliki deliverable</h5>
                }
                else
                {
                    <h5 class="text-muted mb-1">Belum ada data deliverable</h5>
                }
            }
            else
            {
                @* Fallback for any unclassified empty state *@
                <i class="bi bi-inbox fs-1 text-muted mb-3 d-block"></i>
                <h5 class="text-muted mb-1">Tidak ada data</h5>
            }
        </div>
    }
```

**Change 5: Add pagination navigation bar** — place AFTER the closing `</div>` of the `table-responsive` div (the block that wraps `<table class="table table-bordered" id="progressTable">`), and BEFORE the existing modal and script sections. Locate the `@if (Model.Count > 0)` block that wraps the table; add the pagination nav inside this same `@if` block, after the closing `</div>` of `table-responsive`:

```html
        @* Pagination controls (UI-04) — numbered navigation, positioned at bottom of table only *@
        @if (totalPages > 1)
        {
            <nav aria-label="Navigasi halaman" class="mt-4 d-flex justify-content-between align-items-center">
                <small class="text-muted">Halaman @currentPage dari @totalPages</small>
                <ul class="pagination pagination-sm mb-0">
                    @* Previous button *@
                    @if (currentPage > 1)
                    {
                        <li class="page-item">
                            <a class="page-link page-nav-link" href="@Url.Action("ProtonProgress", "CDP", new {
                                bagian = selectedBagian,
                                unit = selectedUnit,
                                trackType = selectedTrackType,
                                tahun = selectedTahun,
                                coacheeId = selectedCoacheeId,
                                page = currentPage - 1
                            })">«</a>
                        </li>
                    }
                    else
                    {
                        <li class="page-item disabled"><span class="page-link">«</span></li>
                    }

                    @* Numbered pages (window of ±2 around current) *@
                    @{
                        int startPage = Math.Max(1, currentPage - 2);
                        int endPage = Math.Min(totalPages, currentPage + 2);
                    }
                    @if (startPage > 1)
                    {
                        <li class="page-item">
                            <a class="page-link page-nav-link" href="@Url.Action("ProtonProgress", "CDP", new {
                                bagian = selectedBagian, unit = selectedUnit,
                                trackType = selectedTrackType, tahun = selectedTahun,
                                coacheeId = selectedCoacheeId, page = 1
                            })">1</a>
                        </li>
                        @if (startPage > 2)
                        {
                            <li class="page-item disabled"><span class="page-link">…</span></li>
                        }
                    }
                    @for (int p = startPage; p <= endPage; p++)
                    {
                        if (p == currentPage)
                        {
                            <li class="page-item active" aria-current="page"><span class="page-link">@p</span></li>
                        }
                        else
                        {
                            <li class="page-item">
                                <a class="page-link page-nav-link" href="@Url.Action("ProtonProgress", "CDP", new {
                                    bagian = selectedBagian, unit = selectedUnit,
                                    trackType = selectedTrackType, tahun = selectedTahun,
                                    coacheeId = selectedCoacheeId, page = p
                                })">@p</a>
                            </li>
                        }
                    }
                    @if (endPage < totalPages)
                    {
                        @if (endPage < totalPages - 1)
                        {
                            <li class="page-item disabled"><span class="page-link">…</span></li>
                        }
                        <li class="page-item">
                            <a class="page-link page-nav-link" href="@Url.Action("ProtonProgress", "CDP", new {
                                bagian = selectedBagian, unit = selectedUnit,
                                trackType = selectedTrackType, tahun = selectedTahun,
                                coacheeId = selectedCoacheeId, page = totalPages
                            })">@totalPages</a>
                        </li>
                    }

                    @* Next button *@
                    @if (currentPage < totalPages)
                    {
                        <li class="page-item">
                            <a class="page-link page-nav-link" href="@Url.Action("ProtonProgress", "CDP", new {
                                bagian = selectedBagian,
                                unit = selectedUnit,
                                trackType = selectedTrackType,
                                tahun = selectedTahun,
                                coacheeId = selectedCoacheeId,
                                page = currentPage + 1
                            })">»</a>
                        </li>
                    }
                    else
                    {
                        <li class="page-item disabled"><span class="page-link">»</span></li>
                    }
                </ul>
            </nav>
        }
```

**Change 6: Add spinner + auto-scroll JavaScript** — add to the `<script>` section at the bottom of the view, BEFORE the closing `</script>` tag (after all existing JS):

```javascript
// === Spinner overlay: show on filter change and pagination navigation ===
(function() {
    const spinner = document.getElementById('loadingSpinner');

    // Show spinner when any filter dropdown changes (filter form auto-submits)
    const filterForm = document.getElementById('filterForm');
    if (filterForm) {
        filterForm.addEventListener('submit', function() {
            if (spinner) {
                spinner.classList.remove('d-none');
                spinner.style.display = 'flex';
            }
        });
    }

    // Show spinner on pagination link click
    document.querySelectorAll('.page-nav-link').forEach(function(link) {
        link.addEventListener('click', function() {
            if (spinner) {
                spinner.classList.remove('d-none');
                spinner.style.display = 'flex';
            }
        });
    });

    // Hide spinner on DOMContentLoaded (page fully loaded)
    if (spinner) {
        spinner.classList.add('d-none');
    }
})();

// === Auto-scroll to table after page navigation ===
(function() {
    // Only scroll if navigated via pagination (page param present in URL)
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('page')) {
        const table = document.getElementById('progressTable');
        if (table) {
            // Small delay to ensure layout is complete before scrolling
            setTimeout(function() {
                table.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }
    }
})();
```

Note on filter form auto-submit: the existing filter dropdowns all have `onchange="this.form.submit()"` or `onchange="onBagianChange(this)"` which calls `select.form.submit()`. The `submit` event fires before the page unloads, so the spinner will appear. The spinner auto-hides on page load. Filter change always goes to ProtonProgress without a `page` param, which defaults to page=1 in the controller.
  </action>
  <verify>
    <automated>cd "C:/Users/Administrator/Desktop/PortalHC_KPB/.claude/worktrees/terminal-a" && dotnet build --configuration Release -v quiet 2>&1 | tail -5</automated>
  </verify>
  <done>
- Build succeeds with 0 errors
- ProtonProgress.cshtml contains id="loadingSpinner" div
- ProtonProgress.cshtml contains id="emptyStateContainer" div (replacing old alert alert-info)
- ProtonProgress.cshtml contains class="page-nav-link" anchors inside pagination nav
- ProtonProgress.cshtml contains "Menampilkan @pageFirstRow" in the result count area
- ProtonProgress.cshtml does NOT contain "ViewBag.EmptyMessage" (old pattern removed)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Phase 66 complete:
- Plan 01: CDPController.ProtonProgress now paginates by group boundary (~20 rows/page, never splits Kompetensi/SubKompetensi group), exposes ViewBag.CurrentPage/TotalPages/PageFirstRow/PageLastRow/EmptyScenario
- Plan 02: ProtonProgress.cshtml shows scenario-aware empty states (icon + Bahasa Indonesia message ± Hapus Filter button), numbered pagination nav (« 1 2 3 »), updated result count, spinner overlay on navigation
  </what-built>
  <how-to-verify>
1. **Empty state — no coachees (HC login, no mappings):**
   - Login as HC user who has no CoachCoacheeMapping records
   - Navigate to `/CDP/ProtonProgress`
   - Expected: centered icon (bi-people) + "Belum ada coachee yang ditugaskan" + hint text about Kelola Data
   - Expected: NO "Hapus Filter" button

2. **Empty state — filter no match:**
   - Login as HC or Coach with some coachees
   - Apply a filter combination that returns 0 results (e.g., select a Bagian with no coachees in that section)
   - Expected: centered icon (bi-funnel) + "Tidak ada deliverable yang sesuai filter" + "Hapus Filter" button
   - Click "Hapus Filter" — expected: page reloads with all data restored

3. **Empty state — coachee has no deliverables:**
   - Select a specific coachee from the dropdown who has no ProtonTrackAssignment or ProtonDeliverableProgress records
   - Expected: centered icon (bi-inbox) + appropriate message (HC: "Belum ada data deliverable" + hint; Coach: "Coachee ini belum memiliki deliverable")

4. **Pagination — data exists:**
   - If there is a coachee with 25+ deliverables across multiple competency groups, navigate to `/CDP/ProtonProgress`
   - Expected: result count shows "Menampilkan 1–N dari Z deliverable" (N ≤ 20 unless last group straddles boundary)
   - Expected: pagination nav appears at bottom with numbered buttons
   - Click page 2 — expected: page loads, auto-scrolls to table, result count updates (e.g., "Menampilkan 21–40")
   - Apply a filter while on page 2 — expected: page resets to 1

5. **Pagination — filter state preserved:**
   - Apply a filter (e.g., Track = Panelman), go to page 2
   - Expected: URL contains `?trackType=Panelman&page=2`
   - Expected: data on page 2 is still filtered (only Panelman deliverables)

6. **Spinner:**
   - Change a filter dropdown or click a pagination page number
   - Expected: spinner overlay briefly appears then disappears when new page loads

7. **Build health:**
   - Run `dotnet build --configuration Release` — must pass with 0 errors
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
- Build: `dotnet build --configuration Release` passes with 0 errors
- ProtonProgress.cshtml: grep for "emptyStateContainer", "page-nav-link", "loadingSpinner", "Menampilkan @pageFirstRow" — all must appear
- ProtonProgress.cshtml: grep for "ViewBag.EmptyMessage" — must NOT appear
- CDPController.cs: grep for "ViewBag.EmptyScenario", "ViewBag.CurrentPage", "ViewBag.TotalPages" — all must appear
- Human UAT: all 7 verification steps above pass
</verification>

<success_criteria>
- Empty state shows scenario-appropriate icon + Bahasa Indonesia message when data is absent
- "Hapus Filter" CTA appears only for "no_filter_match" scenario
- Pagination nav shows when TotalPages > 1; active page highlighted; all filter params preserved in links
- Result count reads "Menampilkan X-Y dari Z deliverable"
- Spinner overlay appears on filter change and page navigation
- User-approved via checkpoint
</success_criteria>

<output>
After completion, create `.planning/phases/66-ui-polish/66-02-SUMMARY.md`
</output>
