---
phase: 68-functional-settings-page
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Models/SettingsViewModel.cs
  - Controllers/AccountController.cs
autonomous: true
requirements:
  - PROF-04
  - PROF-05

must_haves:
  truths:
    - "User can change password with current/new/confirm validation via ChangePasswordAsync"
    - "User can edit FullName, Position, PhoneNumber via UpdateAsync"
    - "Settings GET loads user data into composite SettingsViewModel with read-only fields"
    - "EditProfile POST validates, updates user, redirects with TempData success/error"
    - "ChangePassword POST validates, changes password, calls RefreshSignInAsync, redirects with TempData"
  artifacts:
    - path: "Models/SettingsViewModel.cs"
      provides: "SettingsViewModel + EditProfileViewModel + ChangePasswordViewModel"
      contains: "class SettingsViewModel"
    - path: "Controllers/AccountController.cs"
      provides: "Settings GET (updated), EditProfile POST, ChangePassword POST"
      contains: "ChangePasswordAsync"
  key_links:
    - from: "Controllers/AccountController.cs"
      to: "Models/SettingsViewModel.cs"
      via: "Settings GET creates SettingsViewModel, POST actions accept sub-models"
      pattern: "new SettingsViewModel"
    - from: "Controllers/AccountController.cs"
      to: "UserManager<ApplicationUser>"
      via: "ChangePasswordAsync and UpdateAsync calls"
      pattern: "_userManager\\.ChangePasswordAsync|_userManager\\.UpdateAsync"
---

<objective>
Create backend ViewModels and AccountController actions for the functional Settings page.

Purpose: Provide the data contracts (SettingsViewModel, EditProfileViewModel, ChangePasswordViewModel) and server-side endpoints (Settings GET updated, EditProfile POST, ChangePassword POST) that the frontend view will consume.

Output: Models/SettingsViewModel.cs with 3 model classes; AccountController.cs updated with composite model Settings GET and two POST actions.
</objective>

<execution_context>
@C:/Users/Administrator/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Administrator/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/68-functional-settings-page/68-CONTEXT.md
@.planning/phases/68-functional-settings-page/68-RESEARCH.md
@.planning/phases/67-dynamic-profile-page/67-01-SUMMARY.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From Controllers/AccountController.cs:
```csharp
public class AccountController : Controller
{
    private readonly UserManager<ApplicationUser> _userManager;
    private readonly SignInManager<ApplicationUser> _signInManager;
    // Constructor injects both
    // Existing Settings() GET at line 101 — returns View() with no model (stub)
}
```

From Models/ApplicationUser.cs (fields relevant to Settings):
```csharp
public class ApplicationUser : IdentityUser
{
    public string FullName { get; set; } = string.Empty;
    public string? NIP { get; set; }
    public string? Position { get; set; }
    public string? Section { get; set; }
    public string? Unit { get; set; }
    public string? Directorate { get; set; }
    // PhoneNumber inherited from IdentityUser
}
```

From Models/ManageUserViewModel.cs (annotation pattern reference):
```csharp
[Required(ErrorMessage = "Nama lengkap harus diisi")]
[Display(Name = "Nama Lengkap")]
[StringLength(100)]
public string FullName { get; set; } = string.Empty;

[StringLength(100, MinimumLength = 6, ErrorMessage = "Password minimal 6 karakter")]
public string? Password { get; set; }

[Compare("Password", ErrorMessage = "Password dan Konfirmasi tidak cocok")]
public string? ConfirmPassword { get; set; }
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SettingsViewModel with nested EditProfileViewModel and ChangePasswordViewModel</name>
  <files>Models/SettingsViewModel.cs</files>
  <action>
Create Models/SettingsViewModel.cs containing three classes in HcPortal.Models namespace:

1. **SettingsViewModel** — composite model for Settings GET view:
   - `EditProfile` property (EditProfileViewModel, initialized to new())
   - `ChangePassword` property (ChangePasswordViewModel, initialized to new())
   - Read-only display fields: NIP (string?), Email (string?), Role (string, default "—"), Section (string?), Directorate (string?), Unit (string?)

2. **EditProfileViewModel** — editable fields for profile form:
   - `FullName` — `[Required(ErrorMessage = "Nama lengkap harus diisi")] [StringLength(100)]` string, default string.Empty
   - `Position` — `[StringLength(100)]` string?
   - `PhoneNumber` — `[StringLength(20)]` string?

3. **ChangePasswordViewModel** — password change form:
   - `CurrentPassword` — `[Required(ErrorMessage = "Password lama harus diisi")] [DataType(DataType.Password)]` string, default string.Empty
   - `NewPassword` — `[Required(ErrorMessage = "Password baru harus diisi")] [StringLength(100, MinimumLength = 6, ErrorMessage = "Password minimal 6 karakter")] [DataType(DataType.Password)]` string, default string.Empty
   - `ConfirmNewPassword` — `[Required(ErrorMessage = "Konfirmasi password harus diisi")] [Compare("NewPassword", ErrorMessage = "Password baru dan konfirmasi tidak cocok")] [DataType(DataType.Password)]` string, default string.Empty

Use `using System.ComponentModel.DataAnnotations;` at top. Follow ManageUserViewModel annotation patterns. All classes in one file (project convention for related ViewModels — see CoachingViewModels.cs, ProtonViewModels.cs).
  </action>
  <verify>
    <automated>cd C:/Users/Administrator/Desktop/PortalHC_KPB && dotnet build --no-restore 2>&1 | tail -5</automated>
  </verify>
  <done>Models/SettingsViewModel.cs exists with 3 classes: SettingsViewModel, EditProfileViewModel, ChangePasswordViewModel. All have correct data annotations. Build succeeds.</done>
</task>

<task type="auto">
  <name>Task 2: Update AccountController — Settings GET with model, add EditProfile POST and ChangePassword POST</name>
  <files>Controllers/AccountController.cs</files>
  <action>
Modify Controllers/AccountController.cs:

**1. Update Settings GET (replace existing stub at line 101):**
- Make it `async Task<IActionResult>` (currently synchronous)
- Load user via `_userManager.GetUserAsync(User)` (same pattern as Profile action)
- Get user roles via `_userManager.GetRolesAsync(user)`
- Create `SettingsViewModel` populated with:
  - `EditProfile` = new EditProfileViewModel { FullName = user.FullName, Position = user.Position, PhoneNumber = user.PhoneNumber }
  - `ChangePassword` = new ChangePasswordViewModel() (empty, never pre-populated)
  - Read-only fields from user: NIP, Email, Section, Directorate, Unit
  - Role = roles.FirstOrDefault() ?? "—"
- Return View(model)

**2. Add EditProfile POST action (after Settings GET):**
```csharp
[HttpPost]
[ValidateAntiForgeryToken]
public async Task<IActionResult> EditProfile([Bind(Prefix = "EditProfile")] EditProfileViewModel model)
```
- If !ModelState.IsValid: set TempData["ProfileError"] = "Periksa kembali isian profil." and RedirectToAction("Settings")
- Load user via GetUserAsync. If null, redirect to Login.
- Set user.FullName = model.FullName, user.Position = model.Position, user.PhoneNumber = model.PhoneNumber
- Call `_userManager.UpdateAsync(user)`
- If succeeded: TempData["ProfileSuccess"] = "Profil berhasil diperbarui."
- If failed: TempData["ProfileError"] = string.Join("; ", result.Errors.Select(e => e.Description))
- Return RedirectToAction("Settings")

**3. Add ChangePassword POST action (after EditProfile):**
```csharp
[HttpPost]
[ValidateAntiForgeryToken]
public async Task<IActionResult> ChangePassword([Bind(Prefix = "ChangePassword")] ChangePasswordViewModel model)
```
- If !ModelState.IsValid: set TempData["PasswordError"] = "Periksa kembali isian password." and RedirectToAction("Settings")
- Load user via GetUserAsync. If null, redirect to Login.
- Call `_userManager.ChangePasswordAsync(user, model.CurrentPassword, model.NewPassword)`
- If succeeded:
  - Call `await _signInManager.RefreshSignInAsync(user)` — CRITICAL: prevents cookie invalidation after security stamp update
  - TempData["PasswordSuccess"] = "Password berhasil diubah."
- If failed:
  - Check `result.Errors.Any(e => e.Code == "PasswordMismatch")` → TempData["PasswordError"] = "Password lama salah."
  - Otherwise: TempData["PasswordError"] = string.Join("; ", result.Errors.Select(e => e.Description))
- Return RedirectToAction("Settings")

**Key points:**
- Use `[Bind(Prefix = "EditProfile")]` and `[Bind(Prefix = "ChangePassword")]` to handle nested model binding from composite SettingsViewModel forms (per RESEARCH Pitfall 3)
- TempData keys are section-specific: ProfileSuccess, ProfileError, PasswordSuccess, PasswordError (per CONTEXT decision)
- All messages in Bahasa Indonesia (per CONTEXT decision)
- Do NOT add AuditLog injection for this phase — keep it minimal (no AuditLogService in AccountController currently)
  </action>
  <verify>
    <automated>cd C:/Users/Administrator/Desktop/PortalHC_KPB && dotnet build --no-restore 2>&1 | tail -5</automated>
  </verify>
  <done>AccountController has: (1) async Settings GET returning SettingsViewModel, (2) EditProfile POST with [Bind(Prefix)] updating 3 user fields via UpdateAsync, (3) ChangePassword POST with ChangePasswordAsync + RefreshSignInAsync. Build succeeds with 0 errors.</done>
</task>

</tasks>

<verification>
1. `dotnet build` compiles with 0 errors
2. Settings GET creates SettingsViewModel with pre-populated EditProfile fields from user data
3. EditProfile POST accepts [Bind(Prefix="EditProfile")] EditProfileViewModel and updates user via UpdateAsync
4. ChangePassword POST accepts [Bind(Prefix="ChangePassword")] ChangePasswordViewModel and calls ChangePasswordAsync + RefreshSignInAsync
5. All TempData keys are section-specific (ProfileSuccess/ProfileError/PasswordSuccess/PasswordError)
6. All user-facing messages in Bahasa Indonesia
</verification>

<success_criteria>
- Models/SettingsViewModel.cs exists with SettingsViewModel, EditProfileViewModel, ChangePasswordViewModel
- AccountController Settings GET is async, returns View(SettingsViewModel)
- AccountController EditProfile POST validates, updates user.FullName/Position/PhoneNumber, redirects with TempData
- AccountController ChangePassword POST validates, calls ChangePasswordAsync, calls RefreshSignInAsync on success, redirects with TempData
- `dotnet build` succeeds with 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/68-functional-settings-page/68-01-SUMMARY.md`
</output>
