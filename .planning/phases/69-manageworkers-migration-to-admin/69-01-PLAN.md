---
phase: 69-manageworkers-migration-to-admin
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Controllers/AdminController.cs
  - Models/UserRoles.cs
  - Views/Admin/ManageWorkers.cshtml
  - Views/Admin/CreateWorker.cshtml
  - Views/Admin/EditWorker.cshtml
  - Views/Admin/WorkerDetail.cshtml
  - Views/Admin/ImportWorkers.cshtml
autonomous: true
requirements:
  - USR-01
  - USTR-02

must_haves:
  truths:
    - "All 11 ManageWorkers action methods exist in AdminController with [Authorize(Roles = 'Admin, HC')] per-action attribute"
    - "GetDefaultView() static method exists in UserRoles.cs and is called from AdminController CreateWorker, EditWorker, ImportWorkers POST actions"
    - "5 view files exist in Views/Admin/ with all Url.Action and asp-controller references pointing to Admin (not CMP)"
    - "dotnet build compiles without errors"
  artifacts:
    - path: "Controllers/AdminController.cs"
      provides: "11 ManageWorkers action methods with HC+Admin authorization"
      contains: "ManageWorkers"
    - path: "Models/UserRoles.cs"
      provides: "GetDefaultView() static helper method"
      contains: "GetDefaultView"
    - path: "Views/Admin/ManageWorkers.cshtml"
      provides: "Worker list page with Admin URLs"
    - path: "Views/Admin/CreateWorker.cshtml"
      provides: "Create worker form with Admin URLs"
    - path: "Views/Admin/EditWorker.cshtml"
      provides: "Edit worker form with Admin URLs"
    - path: "Views/Admin/WorkerDetail.cshtml"
      provides: "Worker detail view with Admin URLs"
    - path: "Views/Admin/ImportWorkers.cshtml"
      provides: "Import workers page with Admin URLs"
  key_links:
    - from: "Controllers/AdminController.cs"
      to: "Models/UserRoles.cs"
      via: "UserRoles.GetDefaultView() call in CreateWorker, EditWorker, ImportWorkers POST"
      pattern: "UserRoles\\.GetDefaultView"
    - from: "Views/Admin/ManageWorkers.cshtml"
      to: "Controllers/AdminController.cs"
      via: "Url.Action with controller Admin"
      pattern: "Url\\.Action.*Admin"
---

<objective>
Copy all 11 ManageWorkers action methods from CMPController to AdminController, extract GetDefaultView() helper to UserRoles.cs, copy and update 5 view files from Views/CMP/ to Views/Admin/ with all internal URL references changed from CMP to Admin.

Purpose: Establish the ManageWorkers feature in AdminController so it is fully functional at /Admin/ManageWorkers before removing from CMP (Plan 02).
Output: 11 working actions in AdminController, GetDefaultView() helper in UserRoles.cs, 5 updated view files in Views/Admin/
</objective>

<execution_context>
@C:/Users/Administrator/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Administrator/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/69-manageworkers-migration-to-admin/69-CONTEXT.md
@.planning/phases/69-manageworkers-migration-to-admin/69-RESEARCH.md
@Controllers/AdminController.cs
@Controllers/CMPController.cs
@Models/UserRoles.cs
@Views/Admin/Index.cshtml

<interfaces>
<!-- AdminController class-level authorization must be relaxed for HC access -->
<!-- CRITICAL: ASP.NET Core AND's multiple [Authorize] attributes -->
<!-- Class-level [Authorize(Roles = "Admin")] + per-action [Authorize(Roles = "Admin, HC")] = Admin only (HC still blocked) -->
<!-- Solution: Change class-level to [Authorize] (authenticated only), add per-action [Authorize(Roles = "Admin")] to ALL existing actions, add [Authorize(Roles = "Admin, HC")] to all ManageWorkers actions + Index() -->

From Models/UserRoles.cs (existing static class with role constants):
```csharp
public static class UserRoles
{
    public const string Admin = "Admin";
    public const string HC = "HC";
    public const string Coach = "Coach";
    public const string Direktur = "Direktur";
    public const string VP = "VP";
    public const string Manager = "Manager";
    public const string SectionHead = "Section Head";
    public const string SrSupervisor = "Sr Supervisor";
    public const string Coachee = "Coachee";
    // ... GetDefaultView() will be added here
}
```

From CMPController.cs — GetDefaultView() mapping (duplicated 3 times, lines ~2856, ~3010, ~3403):
```csharp
var selectedView = model.Role switch
{
    "Admin" => "Admin",
    "HC" => "HC",
    "Coach" => "Coach",
    "Direktur" or "VP" or "Manager" or "Section Head" or "Sr Supervisor" => "Atasan",
    _ => "Coachee"
};
```

Actions to copy from CMPController (lines 2757-3465):
1. ManageWorkers [GET] — lines 2757-2814
2. CreateWorker [GET] — lines 2816-2826
3. CreateWorker [POST] — lines 2828-2911
4. EditWorker [GET] — lines 2913-2940
5. EditWorker [POST] — lines 2942-3065
6. DeleteWorker [POST] — lines 3067-3200
7. ExportWorkers [GET] — lines 3202-3270
8. WorkerDetail [GET] — lines 3272-3285
9. ImportWorkers [GET] — lines 3287-3293
10. DownloadImportTemplate [GET] — lines 3295-3334
11. ImportWorkers [POST] — lines 3336-3465
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract GetDefaultView() to UserRoles.cs and add ManageWorkers actions to AdminController</name>
  <files>Models/UserRoles.cs, Controllers/AdminController.cs</files>
  <action>
**Step 1 — Add GetDefaultView() to Models/UserRoles.cs:**

Add this static method to the existing `UserRoles` class:

```csharp
/// <summary>
/// Get the default SelectedView for a given role name.
/// </summary>
public static string GetDefaultView(string roleName)
{
    return roleName switch
    {
        Admin => "Admin",
        HC => "HC",
        Coach => "Coach",
        Direktur or VP or Manager or SectionHead or SrSupervisor => "Atasan",
        _ => "Coachee"
    };
}
```

**Step 2 — Fix AdminController authorization for HC access:**

CRITICAL: ASP.NET Core AND's multiple `[Authorize]` attributes. The class-level `[Authorize(Roles = "Admin")]` will block HC even with per-action `[Authorize(Roles = "Admin, HC")]`.

Change the class-level attribute from `[Authorize(Roles = "Admin")]` to just `[Authorize]` (any authenticated user).

Then add `[Authorize(Roles = "Admin")]` to EVERY EXISTING action method in AdminController that should remain Admin-only. Scan through all existing action methods (Index, KkjMatrix, KkjBagianSave, KkjMatrixSave, KkjMatrixDelete, CpdpItems, CpdpItemsSave, CpdpItemDelete, ManageAssessment, CreateAssessment GET+POST, EditAssessment GET+POST, DeleteAssessment, RegenerateToken, AssessmentMonitoringDetail, ResetWorkerAssessment, ForceCloseAll, CloseEarly, ReshufflePackage, ReshuffleAll, ExportAssessmentResults, UserAssessmentHistory, AuditLog, CoachCoacheeMapping, CoachAssign, CoachEdit, CoachDeactivate, CoachReactivate, CoachGetSessionCount, ExportCoachCoacheeMapping, ProtonData, SilabusSave, SilabusDelete, GuidanceUpload, GuidanceReplace, GuidanceDelete, OverrideList, OverrideDetail, OverrideSave) and add `[Authorize(Roles = "Admin")]` per-action.

For the **Index()** action specifically: add `[Authorize(Roles = "Admin, HC")]` (HC needs hub access too).

**Step 3 — Copy all 11 ManageWorkers action methods from CMPController to AdminController:**

Copy the following methods from CMPController (lines 2757-3465) into AdminController:
1. `ManageWorkers(string? search, string? sectionFilter, string? roleFilter)` [HttpGet]
2. `CreateWorker()` [HttpGet]
3. `CreateWorker(ManageUserViewModel model)` [HttpPost, ValidateAntiForgeryToken]
4. `EditWorker(string id)` [HttpGet]
5. `EditWorker(ManageUserViewModel model)` [HttpPost, ValidateAntiForgeryToken]
6. `DeleteWorker(string id)` [HttpPost, ValidateAntiForgeryToken]
7. `ExportWorkers(string? search, string? sectionFilter, string? roleFilter)` [HttpGet]
8. `WorkerDetail(string id)` [HttpGet]
9. `ImportWorkers()` [HttpGet]
10. `DownloadImportTemplate()` [HttpGet]
11. `ImportWorkers(IFormFile? excelFile)` [HttpPost, ValidateAntiForgeryToken]

Add `[Authorize(Roles = "Admin, HC")]` to EACH of these 11 action methods.

**Step 4 — Replace inline role-to-view mapping with GetDefaultView():**

In the copied actions, replace ALL 3 occurrences of the duplicated switch statement:
```csharp
var selectedView = model.Role switch { ... };
```
with:
```csharp
var selectedView = UserRoles.GetDefaultView(model.Role);
```

This appears in CreateWorker POST, EditWorker POST, and ImportWorkers POST.

**Step 5 — Ensure AdminController has all required DI dependencies:**

The ManageWorkers actions use `UserManager<ApplicationUser>` and `RoleManager<IdentityRole>`, which AdminController may already have via its constructor. Verify that `_userManager` and `_roleManager` (or equivalent) fields exist. If not, add them to the constructor injection and private field declarations. Also check for `_context` (AppDbContext) which is used in DeleteWorker.

Do NOT modify any return View() calls yet — that is handled by the view file task. The action methods should `return View(model)` which will automatically look in `Views/Admin/`.

**Step 6 — Fix any RedirectToAction calls:**

In the copied actions, any `RedirectToAction("ManageWorkers", "CMP")` must become `RedirectToAction("ManageWorkers")` (same controller, no need to specify). Similarly update any other RedirectToAction calls that reference "CMP" controller.
  </action>
  <verify>
    <automated>cd C:/Users/Administrator/Desktop/PortalHC_KPB && grep -n "GetDefaultView" Models/UserRoles.cs && grep -n "GetDefaultView" Controllers/AdminController.cs && grep -cn "ManageWorkers\|CreateWorker\|EditWorker\|DeleteWorker\|ExportWorkers\|WorkerDetail\|ImportWorkers\|DownloadImportTemplate" Controllers/AdminController.cs</automated>
  </verify>
  <done>
- GetDefaultView() method exists in UserRoles.cs
- All 11 ManageWorkers actions exist in AdminController with [Authorize(Roles = "Admin, HC")]
- All existing AdminController actions have explicit [Authorize(Roles = "Admin")] (or "Admin, HC" for Index)
- Class-level [Authorize] changed from Admin-only to authenticated-only
- All inline role-to-view switch statements replaced with UserRoles.GetDefaultView()
- All RedirectToAction calls reference AdminController (not CMP)
  </done>
</task>

<task type="auto">
  <name>Task 2: Copy view files to Views/Admin/ and update all CMP references to Admin</name>
  <files>Views/Admin/ManageWorkers.cshtml, Views/Admin/CreateWorker.cshtml, Views/Admin/EditWorker.cshtml, Views/Admin/WorkerDetail.cshtml, Views/Admin/ImportWorkers.cshtml</files>
  <action>
**Step 1 — Copy 5 view files from Views/CMP/ to Views/Admin/ (flat, no subfolder):**

Copy:
- `Views/CMP/ManageWorkers.cshtml` → `Views/Admin/ManageWorkers.cshtml`
- `Views/CMP/CreateWorker.cshtml` → `Views/Admin/CreateWorker.cshtml`
- `Views/CMP/EditWorker.cshtml` → `Views/Admin/EditWorker.cshtml`
- `Views/CMP/WorkerDetail.cshtml` → `Views/Admin/WorkerDetail.cshtml`
- `Views/CMP/ImportWorkers.cshtml` → `Views/Admin/ImportWorkers.cshtml`

**Step 2 — Update ALL CMP references in each view to Admin:**

For EVERY copied view file, find and replace:
- ALL `Url.Action("X", "CMP")` → `Url.Action("X", "Admin")`
- ALL `asp-controller="CMP"` → `asp-controller="Admin"`
- ALL hardcoded `/CMP/...` URLs in JavaScript → `/Admin/...`
- ALL `action="@Url.Action("X", "CMP")"` → `action="@Url.Action("X", "Admin")"`

Specific references to update per file (from RESEARCH.md):

**ManageWorkers.cshtml:**
- Url.Action("CreateWorker", "CMP") → "Admin"
- Url.Action("ImportWorkers", "CMP") → "Admin"
- Url.Action("ExportWorkers", "CMP", ...) → "Admin"
- Url.Action("Index", "Home") → Url.Action("Index", "Admin") (back button → hub)
- action="@Url.Action("ManageWorkers", "CMP")" → "Admin"
- Url.Action("ManageWorkers", "CMP") → "Admin"
- Url.Action("WorkerDetail", "CMP", ...) → "Admin"
- Url.Action("EditWorker", "CMP", ...) → "Admin"
- action="@Url.Action("DeleteWorker", "CMP")" → "Admin"

**CreateWorker.cshtml:**
- Url.Action("ManageWorkers", "CMP") → "Admin"
- asp-controller="CMP" → "Admin"
- Url.Action("ManageWorkers", "CMP") (cancel button) → "Admin"

**EditWorker.cshtml:**
- Url.Action("ManageWorkers", "CMP") → "Admin"
- asp-controller="CMP" → "Admin"
- Url.Action("ManageWorkers", "CMP") (cancel button) → "Admin"

**ImportWorkers.cshtml:**
- Url.Action("ManageWorkers", "CMP") → "Admin"
- Url.Action("DownloadImportTemplate", "CMP") → "Admin"
- asp-controller="CMP" (ImportWorkers form) → "Admin"
- Url.Action("ManageWorkers", "CMP") → "Admin"

**WorkerDetail.cshtml:**
- Url.Action("EditWorker", "CMP", ...) → "Admin"
- Url.Action("ManageWorkers", "CMP") → "Admin" (all instances)

**Step 3 — Update breadcrumbs to Admin navigation:**

Replace existing breadcrumbs (which reference Home or CMP) with Admin-style breadcrumbs matching existing Admin views (CoachCoacheeMapping pattern):

For ManageWorkers.cshtml:
```html
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="@Url.Action("Index", "Admin")">Kelola Data</a></li>
        <li class="breadcrumb-item active" aria-current="page">Manajemen Pekerja</li>
    </ol>
</nav>
```

For sub-pages (CreateWorker, EditWorker, WorkerDetail, ImportWorkers):
```html
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="@Url.Action("Index", "Admin")">Kelola Data</a></li>
        <li class="breadcrumb-item"><a href="@Url.Action("ManageWorkers", "Admin")">Manajemen Pekerja</a></li>
        <li class="breadcrumb-item active" aria-current="page">[Page Title]</li>
    </ol>
</nav>
```

Page titles: CreateWorker → "Tambah Pekerja", EditWorker → "Edit Pekerja", WorkerDetail → "Detail Pekerja", ImportWorkers → "Import Pekerja"

**Step 4 — Final grep verification:**

After all updates, grep each copied view file for any remaining "CMP" references. Every instance must be replaced.
  </action>
  <verify>
    <automated>cd C:/Users/Administrator/Desktop/PortalHC_KPB && ls Views/Admin/ManageWorkers.cshtml Views/Admin/CreateWorker.cshtml Views/Admin/EditWorker.cshtml Views/Admin/WorkerDetail.cshtml Views/Admin/ImportWorkers.cshtml && grep -rn "CMP" Views/Admin/ManageWorkers.cshtml Views/Admin/CreateWorker.cshtml Views/Admin/EditWorker.cshtml Views/Admin/WorkerDetail.cshtml Views/Admin/ImportWorkers.cshtml | grep -v "^Binary" | head -20 && dotnet build C:/Users/Administrator/Desktop/PortalHC_KPB/HcPortal.csproj 2>&1 | tail -5</automated>
  </verify>
  <done>
- 5 view files exist in Views/Admin/
- Zero CMP references remain in any of the 5 copied view files
- All Url.Action calls point to Admin controller
- All asp-controller attributes say "Admin"
- All breadcrumbs updated to Admin navigation style
- dotnet build succeeds
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` compiles without errors
2. `grep -rn "GetDefaultView" Models/UserRoles.cs Controllers/AdminController.cs` — shows method definition and 3 call sites
3. `grep -c "Authorize.*Admin.*HC" Controllers/AdminController.cs` — shows 12+ per-action attributes (11 ManageWorkers + Index)
4. `grep -rn "CMP" Views/Admin/ManageWorkers.cshtml Views/Admin/CreateWorker.cshtml Views/Admin/EditWorker.cshtml Views/Admin/WorkerDetail.cshtml Views/Admin/ImportWorkers.cshtml` — returns zero results
5. All 5 view files exist in Views/Admin/
</verification>

<success_criteria>
- ManageWorkers feature is fully functional in AdminController at /Admin/ManageWorkers
- HC role can access ManageWorkers actions (per-action [Authorize(Roles = "Admin, HC")])
- GetDefaultView() helper exists and replaces all 3 duplicated switch statements
- All view files in Views/Admin/ reference Admin controller (zero CMP references)
- Project compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/69-manageworkers-migration-to-admin/69-01-SUMMARY.md`
</output>
