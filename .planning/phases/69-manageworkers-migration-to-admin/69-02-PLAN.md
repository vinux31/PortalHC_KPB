---
phase: 69-manageworkers-migration-to-admin
plan: 02
type: execute
wave: 2
depends_on:
  - 69-01
files_modified:
  - Controllers/CMPController.cs
  - Views/Shared/_Layout.cshtml
  - Views/Admin/Index.cshtml
  - Views/CMP/RecordsWorkerList.cshtml
autonomous: true
requirements:
  - USR-01
  - USR-02
  - USR-03

must_haves:
  truths:
    - "Zero ManageWorkers action methods remain in CMPController"
    - "Old CMP ManageWorkers view files deleted from Views/CMP/"
    - "Standalone 'Kelola Pekerja' button removed from navbar"
    - "'Manajemen Pekerja' card is first card in Section A of Admin/Index hub"
    - "RecordsWorkerList.cshtml worker detail link points to /Admin/WorkerDetail"
    - "Zero CMP/ManageWorkers references remain anywhere in the codebase"
  artifacts:
    - path: "Controllers/CMPController.cs"
      provides: "CMPController without ManageWorkers actions"
    - path: "Views/Shared/_Layout.cshtml"
      provides: "Navbar without standalone Kelola Pekerja button"
    - path: "Views/Admin/Index.cshtml"
      provides: "Hub page with Manajemen Pekerja card in Section A first position"
    - path: "Views/CMP/RecordsWorkerList.cshtml"
      provides: "Updated JS URL pointing to /Admin/WorkerDetail"
  key_links:
    - from: "Views/Admin/Index.cshtml"
      to: "Controllers/AdminController.cs"
      via: "Hub card href to ManageWorkers action"
      pattern: "ManageWorkers.*Admin"
    - from: "Views/CMP/RecordsWorkerList.cshtml"
      to: "Controllers/AdminController.cs"
      via: "JS window.location.href to /Admin/WorkerDetail"
      pattern: "/Admin/WorkerDetail"
---

<objective>
Remove ManageWorkers from CMPController and CMP views (clean break, no redirect), remove navbar button, add hub card to Admin/Index, update all remaining codebase references, and verify zero CMP/ManageWorkers references remain.

Purpose: Complete the migration by cleaning up the source location and establishing the new access path via Kelola Data hub.
Output: Clean CMPController (no ManageWorkers), updated navbar, hub card, zero stale references.
</objective>

<execution_context>
@C:/Users/Administrator/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Administrator/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/69-manageworkers-migration-to-admin/69-CONTEXT.md
@.planning/phases/69-manageworkers-migration-to-admin/69-RESEARCH.md
@.planning/phases/69-manageworkers-migration-to-admin/69-01-SUMMARY.md
@Controllers/CMPController.cs
@Views/Shared/_Layout.cshtml
@Views/Admin/Index.cshtml
@Views/CMP/RecordsWorkerList.cshtml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove ManageWorkers from CMP, remove navbar button, add hub card, update remaining references</name>
  <files>Controllers/CMPController.cs, Views/Shared/_Layout.cshtml, Views/Admin/Index.cshtml, Views/CMP/RecordsWorkerList.cshtml</files>
  <action>
**Step 1 — Delete all 11 ManageWorkers action methods from CMPController.cs:**

Remove the entire block from CMPController.cs (approximately lines 2757-3465) containing:
1. ManageWorkers [GET]
2. CreateWorker [GET]
3. CreateWorker [POST]
4. EditWorker [GET]
5. EditWorker [POST]
6. DeleteWorker [POST]
7. ExportWorkers [GET]
8. WorkerDetail [GET] (the admin version at ~line 3272, NOT the training records WorkerDetail at ~line 515 which takes workerId+name params)
9. ImportWorkers [GET]
10. DownloadImportTemplate [GET]
11. ImportWorkers [POST]

IMPORTANT: Do NOT delete the training records `WorkerDetail(int workerId, string name)` action (~line 515) — that is a DIFFERENT action serving training records, not the admin account detail. Only delete the admin `WorkerDetail(string id)` at ~line 3272.

**Step 2 — Delete old CMP view files:**

Delete these 5 files from Views/CMP/ (they are now in Views/Admin/):
- `Views/CMP/ManageWorkers.cshtml`
- `Views/CMP/CreateWorker.cshtml`
- `Views/CMP/EditWorker.cshtml`
- `Views/CMP/WorkerDetail.cshtml`
- `Views/CMP/ImportWorkers.cshtml`

NOTE on WorkerDetail.cshtml: Research found ONE `Views/CMP/WorkerDetail.cshtml` file with `@model ApplicationUser` — this is the admin version being migrated. If the training records WorkerDetail action at line 515 uses this same view file, it may already be broken (model mismatch). Check if the training WorkerDetail at ~line 515 uses `return View("WorkerDetail", ...)` — if so, investigate what model it passes. If it's a different model type, the training WorkerDetail was broken already and this is not a regression. If there's a separate view mechanism, leave it. The key point: delete the `Views/CMP/WorkerDetail.cshtml` that has `@model ApplicationUser` because it's now at `Views/Admin/WorkerDetail.cshtml`.

**Step 3 — Remove standalone "Kelola Pekerja" button from navbar:**

In `Views/Shared/_Layout.cshtml`, remove the entire block (approximately lines 88-96):
```html
@* Manage Workers button — Admin & HC only *@
@if (currentUser.RoleLevel <= 2)
{
    <a href="/CMP/ManageWorkers" class="btn btn-outline-primary btn-sm me-3 d-flex align-items-center gap-2"
       title="Kelola Pekerja" id="btnNavManageWorkers">
        <i class="bi bi-people-fill"></i>
        <span class="d-none d-xl-inline">Kelola Pekerja</span>
    </a>
}
```

Remove this block entirely — no replacement, no notification per CONTEXT decision.

**Step 4 — Add "Manajemen Pekerja" hub card to Admin/Index.cshtml:**

In `Views/Admin/Index.cshtml`, find Section A (Master Data) row. Insert a new card as the FIRST card in Section A (before KKJ Matrix card), following existing card style:

```html
<div class="col-md-4">
    <a href="@Url.Action("ManageWorkers", "Admin")" class="text-decoration-none">
        <div class="card shadow-sm h-100 border-0">
            <div class="card-body">
                <div class="d-flex align-items-center gap-2 mb-2">
                    <i class="bi bi-person-lines-fill fs-5 text-primary"></i>
                    <span class="fw-bold">Manajemen Pekerja</span>
                </div>
                <small class="text-muted">Tambah, edit, hapus, dan kelola data pekerja sistem</small>
            </div>
        </div>
    </a>
</div>
```

Match the exact card pattern used by existing Section A cards (KKJ Matrix, CPDP Items, etc.) — same div structure, classes, and style.

**Step 5 — Update RecordsWorkerList.cshtml hardcoded CMP URL:**

In `Views/CMP/RecordsWorkerList.cshtml`, find the JavaScript line (~643) containing:
```javascript
window.location.href = `/CMP/WorkerDetail?id=${encodeURIComponent(workerId)}`;
```

Change to:
```javascript
window.location.href = `/Admin/WorkerDetail?id=${encodeURIComponent(workerId)}`;
```

**Step 6 — Full codebase grep for remaining CMP/ManageWorkers references:**

Run comprehensive grep across the entire codebase for any remaining references to CMP + ManageWorkers actions:

```bash
grep -rn "CMP.*ManageWorkers\|CMP.*CreateWorker\|CMP.*EditWorker\|CMP.*DeleteWorker\|CMP.*ImportWorkers\|CMP.*ExportWorkers\|CMP.*WorkerDetail\|CMP.*DownloadImportTemplate\|CMP/ManageWorkers\|CMP/CreateWorker\|CMP/EditWorker\|CMP/DeleteWorker\|CMP/ImportWorkers\|CMP/ExportWorkers\|CMP/WorkerDetail\|CMP/DownloadImportTemplate" Views/ Controllers/
```

Every result must be investigated and updated. Expected results after cleanup: ZERO matches (except possibly the training records WorkerDetail at CMPController ~line 515 which is a different action and does NOT reference "CMP/WorkerDetail" in its URL).

Also grep for `btnNavManageWorkers` to confirm navbar button is fully removed:
```bash
grep -rn "btnNavManageWorkers\|Kelola Pekerja" Views/Shared/_Layout.cshtml
```

Expected: ZERO matches.
  </action>
  <verify>
    <automated>cd C:/Users/Administrator/Desktop/PortalHC_KPB && dotnet build HcPortal.csproj 2>&1 | tail -5 && echo "--- CMP ManageWorkers references ---" && grep -rn "CMP.*ManageWorkers\|CMP/ManageWorkers\|CMP.*CreateWorker\|CMP/CreateWorker\|CMP.*EditWorker\|CMP/EditWorker\|CMP.*DeleteWorker\|CMP/DeleteWorker\|CMP.*ImportWorkers\|CMP/ImportWorkers\|CMP.*ExportWorkers\|CMP/ExportWorkers\|CMP/WorkerDetail\|CMP.*DownloadImportTemplate\|CMP/DownloadImportTemplate" Views/ Controllers/ || echo "CLEAN: zero CMP ManageWorkers references" && echo "--- Navbar button ---" && grep -n "btnNavManageWorkers" Views/Shared/_Layout.cshtml || echo "CLEAN: navbar button removed" && echo "--- Hub card ---" && grep -n "Manajemen Pekerja" Views/Admin/Index.cshtml && echo "--- Old CMP views ---" && ls Views/CMP/ManageWorkers.cshtml Views/CMP/CreateWorker.cshtml Views/CMP/EditWorker.cshtml Views/CMP/WorkerDetail.cshtml Views/CMP/ImportWorkers.cshtml 2>&1 || echo "CLEAN: old CMP views deleted"</automated>
  </verify>
  <done>
- Zero ManageWorkers actions in CMPController (11 methods removed)
- 5 old CMP view files deleted
- Navbar "Kelola Pekerja" button completely removed
- "Manajemen Pekerja" hub card is first card in Section A of Admin/Index
- RecordsWorkerList.cshtml JS URL updated to /Admin/WorkerDetail
- Full codebase grep returns zero CMP/ManageWorkers references
- dotnet build compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Compile, verify zero stale references, generate manual UAT checklist</name>
  <files></files>
  <action>
**Step 1 — Run dotnet build and confirm clean compilation:**

```bash
dotnet build C:/Users/Administrator/Desktop/PortalHC_KPB/HcPortal.csproj
```

Must complete with 0 errors. Warnings are acceptable.

**Step 2 — Comprehensive stale reference scan:**

Run exhaustive grep for any remaining references to the old CMP ManageWorkers routes anywhere in the project (Views, Controllers, wwwroot JS files, etc.):

```bash
grep -rn "CMP/ManageWorkers\|CMP/CreateWorker\|CMP/EditWorker\|CMP/DeleteWorker\|CMP/ImportWorkers\|CMP/ExportWorkers\|CMP/WorkerDetail\|CMP/DownloadImportTemplate" C:/Users/Administrator/Desktop/PortalHC_KPB/ --include="*.cshtml" --include="*.cs" --include="*.js"
```

Note: `CMP/WorkerDetail` in the context of training records (`WorkerDetail(int workerId, string name)`) at CMPController ~line 515 is NOT a stale reference — that is a different action. But if any VIEW references `/CMP/WorkerDetail?id=` (the admin version), those ARE stale.

**Step 3 — Verify GetDefaultView usage:**

```bash
grep -n "GetDefaultView" C:/Users/Administrator/Desktop/PortalHC_KPB/Models/UserRoles.cs C:/Users/Administrator/Desktop/PortalHC_KPB/Controllers/AdminController.cs
```

Must show: 1 definition in UserRoles.cs + 3 call sites in AdminController.cs (CreateWorker POST, EditWorker POST, ImportWorkers POST).

**Step 4 — Verify no inline switch duplicates remain in CMPController:**

```bash
grep -n "selectedView.*switch\|SelectedView.*switch" C:/Users/Administrator/Desktop/PortalHC_KPB/Controllers/CMPController.cs
```

Must return zero results (all 3 duplicates removed with the ManageWorkers actions).

**Step 5 — Print summary for UAT checklist:**

Output manual browser verification checklist (cannot be automated):
- [ ] Login as Admin → navigate to /Admin → "Manajemen Pekerja" card visible as first in Section A → click → list loads
- [ ] Login as HC → navigate to /Admin → hub loads (not 403) → "Manajemen Pekerja" card visible → click → list loads
- [ ] Create worker → saves, redirects to list
- [ ] Edit worker → saves, redirects to list
- [ ] Delete worker → removes, redirects to list
- [ ] Worker Detail → shows account info
- [ ] Import Workers → page loads, download template works, import processes
- [ ] Export Workers → Excel downloads
- [ ] /CMP/ManageWorkers → returns 404 (no redirect)
- [ ] Navbar: "Kelola Pekerja" button absent for all users
- [ ] RecordsWorkerList → click worker name → /Admin/WorkerDetail loads (not 404)
  </action>
  <verify>
    <automated>cd C:/Users/Administrator/Desktop/PortalHC_KPB && dotnet build HcPortal.csproj 2>&1 | tail -3 && echo "---" && grep -rn "CMP/ManageWorkers\|CMP/CreateWorker\|CMP/EditWorker\|CMP/DeleteWorker\|CMP/ImportWorkers\|CMP/ExportWorkers\|CMP/DownloadImportTemplate" . --include="*.cshtml" --include="*.cs" --include="*.js" | grep -v ".planning/" | grep -v "node_modules/" || echo "ALL CLEAN"</automated>
  </verify>
  <done>
- dotnet build: 0 errors
- Full grep: zero stale CMP/ManageWorkers references in codebase
- GetDefaultView: 1 definition + 3 call sites confirmed
- No inline role-to-view switch duplicates remain in CMPController
- Manual UAT checklist generated for browser verification
  </done>
</task>

</tasks>

<verification>
1. `dotnet build HcPortal.csproj` — 0 errors
2. Full codebase grep for `CMP/ManageWorkers`, `CMP/CreateWorker`, `CMP/EditWorker`, `CMP/DeleteWorker`, `CMP/ImportWorkers`, `CMP/ExportWorkers`, `CMP/WorkerDetail` (admin version), `CMP/DownloadImportTemplate` — zero results
3. `grep -n "btnNavManageWorkers" Views/Shared/_Layout.cshtml` — zero results
4. `grep -n "Manajemen Pekerja" Views/Admin/Index.cshtml` — has result (hub card exists)
5. `ls Views/CMP/ManageWorkers.cshtml 2>/dev/null` — file not found (deleted)
6. `grep -rn "GetDefaultView" Models/UserRoles.cs Controllers/AdminController.cs` — 1 definition + 3 calls
</verification>

<success_criteria>
- CMP is clean: zero ManageWorkers actions in CMPController, zero ManageWorkers views in Views/CMP/
- Navigation is clean: no standalone navbar button, hub card in Section A first position
- References are clean: zero stale CMP/ManageWorkers URLs anywhere in codebase
- RecordsWorkerList JS URL updated to /Admin/WorkerDetail
- Project compiles successfully
- Manual UAT checklist available for browser testing
</success_criteria>

<output>
After completion, create `.planning/phases/69-manageworkers-migration-to-admin/69-02-SUMMARY.md`
</output>
