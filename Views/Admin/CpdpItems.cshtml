@model List<HcPortal.Models.CpdpItem>
@{
    ViewData["ContainerClass"] = "container-fluid px-4";

    var itemsJson = System.Text.Json.JsonSerializer.Serialize(Model,
        new System.Text.Json.JsonSerializerOptions { PropertyNamingPolicy = null });
}

@Html.AntiForgeryToken()

<style>
    .table-sm td, .table-sm th { font-size: 0.85rem; padding: 0.4rem 0.5rem; vertical-align: middle; }
    #readTableWrapper th, #readTableWrapper td:first-child { white-space: nowrap; }
    #readTableWrapper td:nth-child(2) { max-width: 220px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    #readTableWrapper td:nth-child(3) { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .edit-input { border: 1px solid #ced4da; border-radius: 4px; padding: 2px 4px; font-size: 0.78rem; width: 100%; min-width: 60px; }
    .edit-input:focus { outline: none; border-color: #0d6efd; box-shadow: 0 0 0 2px rgba(13,110,253,0.15); }
    .cpdp-edit-tbl td:nth-child(1), .cpdp-edit-tbl th:nth-child(1) { position: sticky; left: 0; background: white; z-index: 5; border-right: 1px solid #dee2e6; min-width: 60px; }
    .cpdp-edit-tbl td:nth-child(2), .cpdp-edit-tbl th:nth-child(2) { position: sticky; left: 62px; background: white; z-index: 5; border-right: 1px solid #dee2e6; min-width: 140px; }
    .cpdp-edit-tbl thead th { position: sticky; top: 0; background: #343a40; color: white; z-index: 10; }
    .cpdp-edit-tbl thead th:nth-child(1), .cpdp-edit-tbl thead th:nth-child(2) { z-index: 15; }
    .col-no-edit { min-width: 60px; } .col-nama { min-width: 140px; } .col-indikator { min-width: 120px; }
    .col-detail { min-width: 200px; } .col-silabus { min-width: 200px; } .col-target { min-width: 200px; }
    .col-aksi { min-width: 80px; }
    .custom-scrollbar::-webkit-scrollbar { height: 10px; width: 10px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
    td.cell-selected input.edit-input { background-color: #cfe9ff !important; border-color: #0d6efd !important; box-shadow: 0 0 0 1px #0d6efd; }
    td.cell-selecting { outline: 2px solid #0d6efd; }
</style>

<nav aria-label="breadcrumb" class="mb-2">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/Admin">Kelola Data</a></li>
        <li class="breadcrumb-item active">KKJ-IDP Mapping Editor</li>
    </ol>
</nav>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">KKJ-IDP Mapping Editor (CPDP Items)</h5>
        <div id="readActions" class="d-flex gap-2">
            <a id="btnExport" href="/Admin/CpdpItemsExport" class="btn btn-sm btn-outline-success">
                <i class="bi bi-file-earmark-excel me-1"></i>Export Excel
            </a>
            <button id="btnEdit" class="btn btn-sm btn-primary"><i class="bi bi-pencil me-1"></i>Edit</button>
        </div>
        <div id="editActions" class="d-none gap-2 d-flex">
            <button id="btnSave" class="btn btn-sm btn-success"><i class="bi bi-check-lg me-1"></i>Simpan</button>
            <button id="btnCancel" class="btn btn-sm btn-secondary"><i class="bi bi-x-lg me-1"></i>Batal</button>
        </div>
    </div>
    <div class="card-body">

        <div class="mb-3 d-flex align-items-center gap-2">
            <label for="sectionFilter" class="form-label mb-0 fw-semibold">Filter Bagian:</label>
            <select id="sectionFilter" class="form-select form-select-sm" style="max-width:180px;">
                <option value="">Semua Bagian</option>
                <option value="RFCC">RFCC</option>
                <option value="GAST">GAST</option>
                <option value="NGP">NGP</option>
                <option value="DHT">DHT</option>
            </select>
            <span id="rowCount" class="text-muted small"></span>
        </div>
        <input type="hidden" id="selectedSection" value="" />

        <div id="readTableWrapper">
            <table class="table table-sm table-hover table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>No</th>
                        <th>Nama Kompetensi</th>
                        <th>Indikator Perilaku</th>
                        <th>Detail Indikator Perilaku</th>
                        <th>Individual Development Plan / Silabus</th>
                        <th>Target Deliverable</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr data-id="@item.Id" data-section="@item.Section">
                            <td>@item.No</td>
                            <td>@item.NamaKompetensi</td>
                            <td>@item.IndikatorPerilaku</td>
                            <td>@item.DetailIndikator</td>
                            <td>@item.Silabus</td>
                            <td>@item.TargetDeliverable</td>
                            <td>
                                <button class="btn btn-sm btn-outline-danger delete-btn"
                                        data-id="@item.Id"
                                        data-name="@item.NamaKompetensi">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div id="editTableWrapper" class="d-none">
          <div class="table-responsive custom-scrollbar" style="max-height: 75vh; overflow-x: auto; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px;">
            <table id="editTable" class="table table-sm table-bordered cpdp-edit-tbl mb-0">
              <thead>
                <tr>
                  <th class="col-no-edit">No</th>
                  <th class="col-nama">Nama Kompetensi</th>
                  <th class="col-indikator">Indikator Perilaku</th>
                  <th class="col-detail">Detail Indikator</th>
                  <th class="col-silabus">Silabus / IDP</th>
                  <th class="col-target">Target Deliverable</th>
                  <th class="col-aksi">Aksi</th>
                </tr>
              </thead>
              <tbody id="editTbody">
                @foreach (var item in Model)
                {
                  <tr data-id="@item.Id" data-section="@item.Section">
                    <td><input type="text" name="No" value="@item.No" class="edit-input" /></td>
                    <td><input type="text" name="NamaKompetensi" value="@item.NamaKompetensi" class="edit-input" /></td>
                    <td><input type="text" name="IndikatorPerilaku" value="@item.IndikatorPerilaku" class="edit-input" /></td>
                    <td><input type="text" name="DetailIndikator" value="@item.DetailIndikator" class="edit-input" /></td>
                    <td><input type="text" name="Silabus" value="@item.Silabus" class="edit-input" /></td>
                    <td><input type="text" name="TargetDeliverable" value="@item.TargetDeliverable" class="edit-input" /></td>
                    <td>
                      <input type="hidden" name="Status" value="@item.Status" />
                      <input type="hidden" name="Section" value="@item.Section" />
                      <button type="button" class="btn btn-sm btn-outline-secondary insert-below-btn me-1" title="Sisipkan baris bawah"><i class="bi bi-plus-circle"></i></button>
                      <button type="button" class="btn btn-sm btn-outline-danger delete-row-btn" title="Hapus baris"><i class="bi bi-trash"></i></button>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>

    </div>
</div>

<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="saveToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body fw-semibold">Data berhasil disimpan.</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<script>
    var cpdpItems = @Html.Raw(itemsJson);

    // ── Edit/Read mode toggle ──────────────────────────────────────────────
    document.getElementById('btnEdit').addEventListener('click', function() {
        document.getElementById('readTableWrapper').classList.add('d-none');
        document.getElementById('editTableWrapper').classList.remove('d-none');
        document.getElementById('readActions').classList.add('d-none');
        document.getElementById('editActions').classList.remove('d-none');
        filterTables();  // apply current section filter to edit table
    });

    document.getElementById('btnCancel').addEventListener('click', function() {
        if (!confirm('Batalkan semua perubahan?')) return;
        location.reload();
    });

    document.getElementById('btnSave').addEventListener('click', function() { saveAllRows(); });

    // ── Section filter ─────────────────────────────────────────────────────
    var currentSection = '';
    document.getElementById('sectionFilter').addEventListener('change', function(e) {
        currentSection = e.target.value;
        document.getElementById('selectedSection').value = currentSection;
        filterTables();
        // Update export button href to reflect current section filter
        var exportBtn = document.getElementById('btnExport');
        exportBtn.href = '/Admin/CpdpItemsExport' + (currentSection ? '?section=' + encodeURIComponent(currentSection) : '');
    });

    function filterTables() {
        var allRows = document.querySelectorAll('#readTableWrapper tbody tr, #editTable tbody tr');
        var visible = 0;
        allRows.forEach(function(row) {
            var rowSection = (row.dataset.section || '').toUpperCase();
            var sel = currentSection.toUpperCase();
            var show = (sel === '' || rowSection === sel);
            row.style.display = show ? '' : 'none';
            if (show) visible++;
        });
        // Count only unique visible (read + edit overlap same rows; count once)
        var readVisible = document.querySelectorAll('#readTableWrapper tbody tr:not([style*="none"])').length;
        document.getElementById('rowCount').textContent = readVisible > 0 ? readVisible + ' baris' : '';
    }
    filterTables();

    // ── Insert-below button ────────────────────────────────────────────────
    document.getElementById('editTbody').addEventListener('click', function(e) {
        var insertBtn = e.target.closest('.insert-below-btn');
        if (insertBtn) {
            var currentRow = insertBtn.closest('tr');
            var sectionVal = currentRow.querySelector('[name="Section"]').value || currentSection;
            var newRow = makeNewRow(sectionVal);
            currentRow.insertAdjacentElement('afterend', newRow);
            filterTables();
        }

        var deleteBtn = e.target.closest('.delete-row-btn');
        if (deleteBtn) {
            var row = deleteBtn.closest('tr');
            var rowId = parseInt(row.dataset.id) || 0;
            if (rowId === 0) {
                // New row — remove from DOM only
                row.remove();
                filterTables();
            } else {
                // Existing row — AJAX delete
                if (!confirm('Hapus baris ini dari database?')) return;
                var token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                fetch('/Admin/CpdpItemDelete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'RequestVerificationToken': token },
                    body: 'id=' + rowId
                })
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.success) {
                        // Remove from both tables
                        document.querySelectorAll('tr[data-id="' + rowId + '"]').forEach(function(r) { r.remove(); });
                        cpdpItems = cpdpItems.filter(function(i) { return i.Id !== rowId; });
                        filterTables();
                    } else {
                        alert(data.message || 'Gagal menghapus.');
                    }
                })
                .catch(function() { alert('Koneksi error.'); });
            }
        }
    });

    // Also wire delete buttons on read-mode table
    document.getElementById('readTableWrapper').addEventListener('click', function(e) {
        var btn = e.target.closest('.delete-btn');
        if (!btn) return;
        var rowId = parseInt(btn.dataset.id);
        var name = btn.dataset.name || '';
        if (!confirm('Hapus "' + name + '"?')) return;
        var token = document.querySelector('input[name="__RequestVerificationToken"]').value;
        fetch('/Admin/CpdpItemDelete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'RequestVerificationToken': token },
            body: 'id=' + rowId
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                document.querySelectorAll('tr[data-id="' + rowId + '"]').forEach(function(r) { r.remove(); });
                cpdpItems = cpdpItems.filter(function(i) { return i.Id !== rowId; });
                filterTables();
            } else {
                alert(data.message || 'Gagal menghapus.');
            }
        })
        .catch(function() { alert('Koneksi error.'); });
    });

    // ── Make new blank row ─────────────────────────────────────────────────
    function makeNewRow(sectionVal) {
        var tr = document.createElement('tr');
        tr.dataset.id = '0';
        tr.dataset.section = sectionVal || '';
        tr.innerHTML =
            '<td><input type="text" name="No" value="" class="edit-input" /></td>' +
            '<td><input type="text" name="NamaKompetensi" value="" class="edit-input" /></td>' +
            '<td><input type="text" name="IndikatorPerilaku" value="" class="edit-input" /></td>' +
            '<td><input type="text" name="DetailIndikator" value="" class="edit-input" /></td>' +
            '<td><input type="text" name="Silabus" value="" class="edit-input" /></td>' +
            '<td><input type="text" name="TargetDeliverable" value="" class="edit-input" /></td>' +
            '<td>' +
              '<input type="hidden" name="Status" value="" />' +
              '<input type="hidden" name="Section" value="' + (sectionVal || '') + '" />' +
              '<button type="button" class="btn btn-sm btn-outline-secondary insert-below-btn me-1" title="Sisipkan baris bawah"><i class="bi bi-plus-circle"></i></button>' +
              '<button type="button" class="btn btn-sm btn-outline-danger delete-row-btn" title="Hapus baris"><i class="bi bi-trash"></i></button>' +
            '</td>';
        return tr;
    }

    // ── Bulk save ──────────────────────────────────────────────────────────
    function saveAllRows() {
        var rows = [];
        document.querySelectorAll('#editTable tbody tr').forEach(function(tr) {
            var rowId = parseInt(tr.dataset.id) || 0;
            rows.push({
                Id:                 rowId,
                No:                 tr.querySelector('[name="No"]').value,
                NamaKompetensi:     tr.querySelector('[name="NamaKompetensi"]').value,
                IndikatorPerilaku:  tr.querySelector('[name="IndikatorPerilaku"]').value,
                DetailIndikator:    tr.querySelector('[name="DetailIndikator"]').value,
                Silabus:            tr.querySelector('[name="Silabus"]').value,
                TargetDeliverable:  tr.querySelector('[name="TargetDeliverable"]').value,
                Status:             tr.querySelector('[name="Status"]').value || '',
                Section:            tr.querySelector('[name="Section"]').value || ''
            });
        });

        if (rows.length === 0) { alert('Tidak ada data untuk disimpan.'); return; }

        var token = document.querySelector('input[name="__RequestVerificationToken"]').value;

        fetch('/Admin/CpdpItemsSave', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': token },
            body: JSON.stringify(rows)
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                var toastEl = document.getElementById('saveToast');
                var toast = new bootstrap.Toast(toastEl, { delay: 2000 });
                toast.show();
                setTimeout(function() { location.reload(); }, 2100);
            } else {
                alert('Error: ' + (data.message || 'Gagal menyimpan.'));
            }
        })
        .catch(function() { alert('Koneksi error.'); });
    }

    // ── Multi-cell selection ───────────────────────────────────────────────
    var selectedCells = [];
    var startCell = null;

    document.getElementById('editTable').addEventListener('mousedown', function(e) {
        var input = e.target.closest('td input.edit-input');
        if (!input) return;
        var td = input.parentElement;

        if (e.shiftKey && startCell) {
            e.preventDefault();
            selectRange(startCell, td);
        } else {
            clearSelection();
            selectedCells = [td];
            td.classList.add('cell-selected');
            startCell = td;
        }
    });

    function clearSelection() {
        selectedCells.forEach(function(c) { c.classList.remove('cell-selected'); });
        selectedCells = [];
    }

    function getTableCells() {
        // Returns 2D array [row][col] of all td elements in editTable tbody
        var result = [];
        document.querySelectorAll('#editTable tbody tr').forEach(function(tr) {
            var cells = [];
            // Only data input cells (not hidden inputs) — columns 0-5 (not Aksi col)
            tr.querySelectorAll('td').forEach(function(td, i) {
                if (i < 6) cells.push(td);  // 6 data columns (No, NamaKompetensi, Indikator, Detail, Silabus, Target)
            });
            if (cells.length > 0) result.push(cells);
        });
        return result;
    }

    function getCellPos(td, allCells) {
        for (var r = 0; r < allCells.length; r++) {
            for (var c = 0; c < allCells[r].length; c++) {
                if (allCells[r][c] === td) return { r: r, c: c };
            }
        }
        return null;
    }

    function selectRange(cellA, cellB) {
        var allCells = getTableCells();
        var posA = getCellPos(cellA, allCells);
        var posB = getCellPos(cellB, allCells);
        if (!posA || !posB) return;

        var r1 = Math.min(posA.r, posB.r), r2 = Math.max(posA.r, posB.r);
        var c1 = Math.min(posA.c, posB.c), c2 = Math.max(posA.c, posB.c);

        clearSelection();
        for (var r = r1; r <= r2; r++) {
            for (var c = c1; c <= c2; c++) {
                if (allCells[r] && allCells[r][c]) {
                    allCells[r][c].classList.add('cell-selected');
                    selectedCells.push(allCells[r][c]);
                }
            }
        }
    }

    document.addEventListener('keydown', function(e) {
        // Only active in edit mode
        if (document.getElementById('editTableWrapper').classList.contains('d-none')) return;
        if (selectedCells.length === 0) return;

        if ((e.ctrlKey || e.metaKey) && e.key === 'c') {
            e.preventDefault();
            copySelection();
        } else if ((e.ctrlKey || e.metaKey) && e.key === 'v') {
            e.preventDefault();
            pasteFromClipboard();
        } else if (e.key === 'Delete' || e.key === 'Backspace' && e.target.tagName !== 'INPUT') {
            if (e.key === 'Delete' && e.target.tagName !== 'INPUT') {
                e.preventDefault();
                clearCellContents();
            }
        }
    });

    function copySelection() {
        var allCells = getTableCells();
        // Find bounding box of selection
        var positions = selectedCells.map(function(td) { return getCellPos(td, allCells); }).filter(Boolean);
        if (positions.length === 0) return;
        var r1 = Math.min.apply(null, positions.map(function(p) { return p.r; }));
        var r2 = Math.max.apply(null, positions.map(function(p) { return p.r; }));
        var c1 = Math.min.apply(null, positions.map(function(p) { return p.c; }));
        var c2 = Math.max.apply(null, positions.map(function(p) { return p.c; }));

        var lines = [];
        for (var r = r1; r <= r2; r++) {
            var cols = [];
            for (var c = c1; c <= c2; c++) {
                var inp = allCells[r] && allCells[r][c] ? allCells[r][c].querySelector('input.edit-input') : null;
                cols.push(inp ? inp.value : '');
            }
            lines.push(cols.join('\t'));
        }
        navigator.clipboard.writeText(lines.join('\n')).catch(function() {
            // Fallback for older browsers
            var ta = document.createElement('textarea');
            ta.value = lines.join('\n');
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
        });
    }

    function pasteFromClipboard() {
        var allCells = getTableCells();
        if (selectedCells.length === 0 || allCells.length === 0) return;
        var startPos = getCellPos(selectedCells[0], allCells);
        if (!startPos) return;

        navigator.clipboard.readText().then(function(text) {
            var lines = text.split('\n');
            lines.forEach(function(line, ri) {
                var cols = line.split('\t');
                cols.forEach(function(val, ci) {
                    var r = startPos.r + ri;
                    var c = startPos.c + ci;
                    if (allCells[r] && allCells[r][c]) {
                        var inp = allCells[r][c].querySelector('input.edit-input');
                        if (inp) inp.value = val.replace(/\r$/, '');
                    }
                });
            });
        }).catch(function() {
            alert('Clipboard access denied. Pastikan browser mengizinkan clipboard access.');
        });
    }

    function clearCellContents() {
        selectedCells.forEach(function(td) {
            var inp = td.querySelector('input.edit-input');
            if (inp) inp.value = '';
        });
    }
</script>
