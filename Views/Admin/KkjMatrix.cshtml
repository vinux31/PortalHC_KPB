@model List<HcPortal.Models.KkjMatrixItem>

@{
    ViewData["Title"] = "Kelola KKJ Matrix";
    ViewData["ContainerClass"] = "container-fluid px-4";
    var itemsJson = System.Text.Json.JsonSerializer.Serialize(Model,
        new System.Text.Json.JsonSerializerOptions { PropertyNamingPolicy = null });
    var bagiansJson = System.Text.Json.JsonSerializer.Serialize(ViewBag.Bagians as List<HcPortal.Models.KkjBagian>,
        new System.Text.Json.JsonSerializerOptions { PropertyNamingPolicy = null });
}

@Html.AntiForgeryToken()

<!-- Save success toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
    <div id="saveToast" class="toast align-items-center text-bg-success border-0" role="alert"
         aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi bi-check-circle-fill me-2"></i>Data berhasil disimpan.
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto"
                    data-bs-dismiss="toast" aria-label="Tutup"></button>
        </div>
    </div>
</div>

<script>
    var kkjItems = @Html.Raw(itemsJson);
    var kkjBagians = @Html.Raw(bagiansJson ?? "[]");
</script>

<style>
    .custom-scrollbar::-webkit-scrollbar {
        height: 12px;
        width: 12px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }

    .table-responsive.custom-scrollbar {
        max-height: 80vh;
        overflow-x: auto;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 8px;
    }

    thead th {
        position: sticky;
        top: 0;
        z-index: 20;
    }

    .table-sm td, .table-sm th {
        font-size: 0.85rem;
        padding: 0.5rem 0.6rem;
        vertical-align: middle;
    }

    .edit-input {
        border: 1px solid #ced4da;
        border-radius: 4px;
        padding: 2px 4px;
        font-size: 0.75rem;
        width: 100%;
        min-width: 60px;
    }
    .edit-input:focus { outline: none; border-color: #0d6efd; box-shadow: 0 0 0 2px rgba(13,110,253,0.15); }
    .col-no    { min-width: 55px; }
    .col-meta  { min-width: 120px; }
    .col-target { min-width: 55px; }
    /* Sticky first two columns in edit mode */
    .kkj-edit-tbl td:nth-child(1), .kkj-edit-tbl th:nth-child(1) { position: sticky; left: 0; background: white; z-index: 5; border-right: 1px solid #dee2e6; }
    .kkj-edit-tbl td:nth-child(2), .kkj-edit-tbl th:nth-child(2) { position: sticky; left: 57px; background: white; z-index: 5; border-right: 1px solid #dee2e6; }
    .kkj-edit-tbl thead th { position: sticky; top: 0; background: #343a40; color: white; z-index: 10; }
    .kkj-edit-tbl thead th:nth-child(1), .kkj-edit-tbl thead th:nth-child(2) { z-index: 15; }
    .col-aksi { min-width: 75px; }
    .bagian-label-input { background: rgba(255,255,255,0.15); color: white; border-color: rgba(255,255,255,0.4); }
    .bagian-label-input:focus { background: white; color: #212529; }
    .bagian-name-input { font-weight: bold; }
    .cell-selected {
        background-color: rgba(13, 110, 253, 0.15) !important;
        outline: 1px solid rgba(13, 110, 253, 0.4);
    }
</style>

@* Breadcrumb *@
<nav aria-label="breadcrumb" class="mb-2">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="@Url.Action("Index", "Admin")">Kelola Data</a></li>
        <li class="breadcrumb-item active" aria-current="page">KKJ Matrix</li>
    </ol>
</nav>

@* Page header *@
<div class="d-flex align-items-center justify-content-between mb-3">
    <div>
        <h4 class="fw-bold mb-0">KKJ Matrix</h4>
        <small class="text-muted">Kelola item KKJ Matrix (master kompetensi)</small>
    </div>
    <div class="d-flex gap-2 align-items-center">
        <button id="btnEdit" class="btn btn-primary btn-sm">
            <i class="bi bi-pencil me-1"></i>Edit Mode
        </button>
        <div id="editActions" class="d-none d-flex gap-2">
            <button id="btnAddBagian" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-plus-square me-1"></i>Tambah Bagian
            </button>
            <button id="btnSave" class="btn btn-primary btn-sm"><i class="bi bi-save me-1"></i>Simpan</button>
            <button id="btnCancel" class="btn btn-outline-secondary btn-sm"><i class="bi bi-x me-1"></i>Batal</button>
        </div>
    </div>
</div>

@* Row count *@
<div class="text-muted small mb-2">@Model.Count item(s)</div>

@* Empty state *@
@if (!Model.Any() && !(ViewBag.Bagians as List<HcPortal.Models.KkjBagian> ?? new List<HcPortal.Models.KkjBagian>()).Any())
{
    <p class="text-muted">Belum ada data KKJ Matrix.</p>
}

@* Read-mode: dropdown filter + bagian CRUD toolbar + single table panel *@
<div id="readTable">
    @{
        var bagians = ViewBag.Bagians as List<HcPortal.Models.KkjBagian> ?? new List<HcPortal.Models.KkjBagian>();
    }
    <div class="d-flex align-items-center gap-2 mb-3 flex-wrap">
        <label class="fw-semibold mb-0">Bagian:</label>
        <select id="bagianFilter" class="form-select form-select-sm" style="max-width:160px;">
            @foreach (var bagian in bagians)
            {
                <option value="@bagian.Name">@bagian.Name</option>
            }
        </select>
        <button id="btnRenameBagian" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-pencil me-1"></i>Ubah Nama
        </button>
        <button id="btnDeleteBagian" class="btn btn-outline-danger btn-sm">
            <i class="bi bi-trash me-1"></i>Hapus
        </button>
        <button id="btnAddBagianRead" class="btn btn-outline-success btn-sm">
            <i class="bi bi-plus-square me-1"></i>Tambah Bagian
        </button>
    </div>
    <div id="readTablePanel"></div>
</div>

@* Edit-mode: per-bagian sections (populated by JS) *@
<div id="editTablesContainer" class="d-none"></div>

@section Scripts {
<script>
// --- HELPERS ---
function escHtml(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

// --- READ MODE RENDER ---
var labelFieldKeys = [
    { key:'Label_SectionHead',        prop:'Target_SectionHead'        },
    { key:'Label_SrSpv_GSH',          prop:'Target_SrSpv_GSH'          },
    { key:'Label_ShiftSpv_GSH',       prop:'Target_ShiftSpv_GSH'       },
    { key:'Label_Panelman_GSH_12_13', prop:'Target_Panelman_GSH_12_13' },
    { key:'Label_Panelman_GSH_14',    prop:'Target_Panelman_GSH_14'    },
    { key:'Label_Operator_GSH_8_11',  prop:'Target_Operator_GSH_8_11'  },
    { key:'Label_Operator_GSH_12_13', prop:'Target_Operator_GSH_12_13' },
    { key:'Label_ShiftSpv_ARU',       prop:'Target_ShiftSpv_ARU'       },
    { key:'Label_Panelman_ARU_12_13', prop:'Target_Panelman_ARU_12_13' },
    { key:'Label_Panelman_ARU_14',    prop:'Target_Panelman_ARU_14'    },
    { key:'Label_Operator_ARU_8_11',  prop:'Target_Operator_ARU_8_11'  },
    { key:'Label_Operator_ARU_12_13', prop:'Target_Operator_ARU_12_13' },
    { key:'Label_SrSpv_Facility',     prop:'Target_SrSpv_Facility'     },
    { key:'Label_JrAnalyst',          prop:'Target_JrAnalyst'          },
    { key:'Label_HSE',                prop:'Target_HSE'                },
];

function renderReadTable(bagianName) {
    var panel = document.getElementById('readTablePanel');
    if (!panel) return;

    var bagian = kkjBagians.find(function(b) { return b.Name === bagianName; });
    var knownNames = kkjBagians.map(function(b) { return b.Name; });

    // Items for selected bagian; if bagianName is '__unassigned__' show orphans
    var items;
    if (bagianName === '__unassigned__') {
        items = kkjItems.filter(function(i) {
            return !i.Bagian || knownNames.indexOf(i.Bagian) === -1;
        });
        bagian = null; // no bagian object for orphans
    } else {
        items = kkjItems.filter(function(i) { return i.Bagian === bagianName; });
    }
    items = items.slice().sort(function(a, b) { return (a.No || 0) - (b.No || 0); });

    // Build thead
    var theadCells = '<th style="width:45px;">No</th>'
        + '<th style="width:90px;">Indeks</th>'
        + '<th style="min-width:180px;">Kompetensi</th>'
        + '<th style="min-width:120px;">SkillGroup</th>'
        + '<th style="min-width:120px;">SubSkillGroup</th>';

    labelFieldKeys.forEach(function(lf) {
        var label = bagian ? (bagian[lf.key] || lf.key) : lf.key;
        theadCells += '<th class="col-target">' + escHtml(label) + '</th>';
    });
    theadCells += '<th style="width:70px;">Aksi</th>';

    // Build tbody rows
    var tbodyRows = '';
    if (items.length === 0) {
        tbodyRows = '<tr><td colspan="21" class="text-muted text-center">Belum ada item di bagian ini.</td></tr>';
    } else {
        items.forEach(function(item) {
            var tds = '<td>' + escHtml(item.No) + '</td>'
                + '<td>' + escHtml(item.Indeks) + '</td>'
                + '<td>' + escHtml(item.Kompetensi) + '</td>'
                + '<td>' + escHtml(item.SkillGroup) + '</td>'
                + '<td>' + escHtml(item.SubSkillGroup) + '</td>';
            labelFieldKeys.forEach(function(lf) {
                tds += '<td>' + escHtml(item[lf.prop]) + '</td>';
            });
            var safeKomp = escHtml(item.Kompetensi).replace(/'/g, "\\'");
            tds += '<td>'
                + '<button class="btn btn-outline-danger btn-sm" onclick="deleteRow(' + item.Id + ', \'' + safeKomp + '\')">'
                + '<i class="bi bi-trash"></i></button>'
                + '</td>';
            tbodyRows += '<tr data-id="' + item.Id + '">' + tds + '</tr>';
        });
    }

    panel.innerHTML = '<div class="table-responsive custom-scrollbar mb-3">'
        + '<table class="table table-sm table-bordered table-hover mb-0">'
        + '<thead class="table-dark"><tr>' + theadCells + '</tr></thead>'
        + '<tbody>' + tbodyRows + '</tbody>'
        + '</table></div>';
}

// Wire dropdown change
document.addEventListener('DOMContentLoaded', function() {
    var filter = document.getElementById('bagianFilter');
    if (filter) {
        filter.addEventListener('change', function() {
            renderReadTable(this.value);
        });
        // Initial render for first option
        if (filter.value) renderReadTable(filter.value);
    }
});

// Ubah Nama button
document.getElementById('btnRenameBagian').addEventListener('click', function() {
    var filter = document.getElementById('bagianFilter');
    var currentName = filter ? filter.value : '';
    if (!currentName) return;
    var newName = prompt('Nama baru untuk bagian "' + currentName + '":', currentName);
    if (!newName || newName.trim() === '' || newName.trim() === currentName) return;
    newName = newName.trim();
    var bagian = kkjBagians.find(function(b) { return b.Name === currentName; });
    if (!bagian) return;
    // Build bagian payload with new name, keeping all existing label values
    var payload = Object.assign({}, bagian, { Name: newName });
    var token = document.querySelector('input[name="__RequestVerificationToken"]').value;
    $.ajax({
        url: '/Admin/KkjBagianSave',
        type: 'POST',
        contentType: 'application/json',
        headers: { 'RequestVerificationToken': token },
        data: JSON.stringify([payload]),
        success: function(resp) {
            if (resp.success) {
                bagian.Name = newName;
                // Update kkjItems that had old bagian name
                kkjItems.forEach(function(i) { if (i.Bagian === currentName) i.Bagian = newName; });
                // Rebuild dropdown option
                var opt = filter.querySelector('option[value="' + currentName + '"]');
                if (opt) { opt.value = newName; opt.textContent = newName; }
                filter.value = newName;
                renderReadTable(newName);
            } else {
                alert('Error: ' + resp.message);
            }
        },
        error: function(xhr) { alert('Server error: ' + xhr.statusText); }
    });
});

// Hapus Bagian button
document.getElementById('btnDeleteBagian').addEventListener('click', function() {
    var filter = document.getElementById('bagianFilter');
    var currentName = filter ? filter.value : '';
    if (!currentName) return;
    var bagian = kkjBagians.find(function(b) { return b.Name === currentName; });
    if (!bagian) return;
    if (!confirm('Hapus bagian "' + currentName + '"? Bagian tidak dapat dihapus jika masih ada item yang di-assign ke bagian ini.')) return;
    var token = document.querySelector('input[name="__RequestVerificationToken"]').value;
    $.ajax({
        url: '/Admin/KkjBagianDelete',
        type: 'POST',
        data: { id: bagian.Id, __RequestVerificationToken: token },
        success: function(resp) {
            if (resp.success) {
                kkjBagians = kkjBagians.filter(function(b) { return b.Id !== bagian.Id; });
                var opt = filter.querySelector('option[value="' + currentName + '"]');
                if (opt) opt.remove();
                if (kkjBagians.length > 0) {
                    filter.value = kkjBagians[0].Name;
                    renderReadTable(kkjBagians[0].Name);
                } else {
                    document.getElementById('readTablePanel').innerHTML = '<p class="text-muted">Tidak ada bagian.</p>';
                }
            } else if (resp.blocked) {
                alert(resp.message);
            } else {
                alert('Error: ' + resp.message);
            }
        },
        error: function(xhr) { alert('Server error: ' + xhr.statusText); }
    });
});

// Tambah Bagian (read-mode) button — creates bagian via server then adds to dropdown + JS array
document.getElementById('btnAddBagianRead').addEventListener('click', function() {
    var token = document.querySelector('input[name="__RequestVerificationToken"]').value;
    $.ajax({
        url: '/Admin/KkjBagianAdd',
        type: 'POST',
        data: { __RequestVerificationToken: token },
        success: function(resp) {
            if (resp.success) {
                var newBagian = {
                    Id: resp.id, Name: resp.name, DisplayOrder: resp.displayOrder,
                    Label_SectionHead: 'Section Head', Label_SrSpv_GSH: 'Sr Spv GSH',
                    Label_ShiftSpv_GSH: 'Shift Spv GSH', Label_Panelman_GSH_12_13: 'Panelman GSH 12-13',
                    Label_Panelman_GSH_14: 'Panelman GSH 14', Label_Operator_GSH_8_11: 'Op GSH 8-11',
                    Label_Operator_GSH_12_13: 'Op GSH 12-13', Label_ShiftSpv_ARU: 'Shift Spv ARU',
                    Label_Panelman_ARU_12_13: 'Panelman ARU 12-13', Label_Panelman_ARU_14: 'Panelman ARU 14',
                    Label_Operator_ARU_8_11: 'Op ARU 8-11', Label_Operator_ARU_12_13: 'Op ARU 12-13',
                    Label_SrSpv_Facility: 'Sr Spv Facility', Label_JrAnalyst: 'Jr Analyst', Label_HSE: 'HSE'
                };
                kkjBagians.push(newBagian);
                var filter = document.getElementById('bagianFilter');
                var opt = document.createElement('option');
                opt.value = resp.name;
                opt.textContent = resp.name;
                filter.appendChild(opt);
                filter.value = resp.name;
                renderReadTable(resp.name);
            } else {
                alert('Error: ' + resp.message);
            }
        },
        error: function(xhr) { alert('Server error: ' + xhr.statusText); }
    });
});

// --- EDIT MODE RENDER ---
function renderEditRows() {
    var container = document.getElementById('editTablesContainer');
    container.innerHTML = '';

    // Build/update the editBagianFilter dropdown
    var filterBar = document.getElementById('editBagianFilterBar');
    if (!filterBar) {
        filterBar = document.createElement('div');
        filterBar.id = 'editBagianFilterBar';
        filterBar.className = 'd-flex align-items-center gap-2 mb-2';
        filterBar.innerHTML = '<label class="fw-bold text-primary mb-0">Bagian:</label>'
            + '<select id="editBagianFilter" class="form-select form-select-sm" style="max-width:220px;"></select>';
        container.parentNode.insertBefore(filterBar, container);
    }
    var editBagianFilter = document.getElementById('editBagianFilter');
    editBagianFilter.innerHTML = '';
    kkjBagians.forEach(function(b) {
        var opt = document.createElement('option');
        opt.value = b.Name;
        opt.textContent = b.Name;
        editBagianFilter.appendChild(opt);
    });

    var knownBagianNames = kkjBagians.map(function(b) { return b.Name; });
    var bagianIndex = 0;
    kkjBagians.forEach(function(bagian) {
        var isFirstBagian = (bagianIndex === 0);
        var bagianItems = kkjItems.filter(function(i) {
            if (i.Bagian === bagian.Name) return true;
            if (isFirstBagian && (i.Bagian === '' || i.Bagian === null || knownBagianNames.indexOf(i.Bagian) === -1)) return true;
            return false;
        });
        bagianIndex++;

        // Wrap each bagian block in a section div
        var sectionDiv = document.createElement('div');
        sectionDiv.className = 'edit-bagian-section';
        sectionDiv.dataset.bagianName = bagian.Name;

        // Section heading with editable bagian name input
        var heading = document.createElement('div');
        heading.className = 'mt-3 mb-1 d-flex align-items-center gap-2';
        heading.innerHTML = '<label class="fw-bold text-primary mb-0">Bagian:</label>'
            + '<input type="text" class="form-control form-control-sm bagian-name-input" '
            + 'data-bagian-id="' + bagian.Id + '" data-bagian-order="' + bagian.DisplayOrder + '" '
            + 'value="' + escHtml(bagian.Name) + '" style="max-width:160px;" title="Nama Bagian">';

        // Label fields mapping
        var labelFields = [
            { key:'Label_SectionHead',        prop:'Target_SectionHead'        },
            { key:'Label_SrSpv_GSH',          prop:'Target_SrSpv_GSH'          },
            { key:'Label_ShiftSpv_GSH',       prop:'Target_ShiftSpv_GSH'       },
            { key:'Label_Panelman_GSH_12_13', prop:'Target_Panelman_GSH_12_13' },
            { key:'Label_Panelman_GSH_14',    prop:'Target_Panelman_GSH_14'    },
            { key:'Label_Operator_GSH_8_11',  prop:'Target_Operator_GSH_8_11'  },
            { key:'Label_Operator_GSH_12_13', prop:'Target_Operator_GSH_12_13' },
            { key:'Label_ShiftSpv_ARU',       prop:'Target_ShiftSpv_ARU'       },
            { key:'Label_Panelman_ARU_12_13', prop:'Target_Panelman_ARU_12_13' },
            { key:'Label_Panelman_ARU_14',    prop:'Target_Panelman_ARU_14'    },
            { key:'Label_Operator_ARU_8_11',  prop:'Target_Operator_ARU_8_11'  },
            { key:'Label_Operator_ARU_12_13', prop:'Target_Operator_ARU_12_13' },
            { key:'Label_SrSpv_Facility',     prop:'Target_SrSpv_Facility'     },
            { key:'Label_JrAnalyst',          prop:'Target_JrAnalyst'          },
            { key:'Label_HSE',                prop:'Target_HSE'                },
        ];

        var tableWrapper = document.createElement('div');
        tableWrapper.className = 'table-responsive custom-scrollbar mb-1';
        tableWrapper.style.maxHeight = '80vh';

        var tbl = document.createElement('table');
        tbl.className = 'table table-sm table-bordered align-middle mb-0 kkj-edit-tbl';
        tbl.dataset.bagianId = bagian.Id;
        tbl.dataset.bagianName = bagian.Name;

        // thead: fixed columns + 15 editable label inputs
        var thead = document.createElement('thead');
        thead.className = 'table-dark';
        var headerRow = document.createElement('tr');

        var fixedHeaders = ['No','SkillGroup','SubSkillGroup','Indeks','Kompetensi'];
        fixedHeaders.forEach(function(h) {
            var th = document.createElement('th');
            th.textContent = h;
            th.className = h === 'No' ? 'col-no' : 'col-meta';
            if (h === 'Kompetensi') th.style.minWidth = '180px';
            headerRow.appendChild(th);
        });

        labelFields.forEach(function(lf) {
            var th = document.createElement('th');
            th.className = 'col-target';
            var inp = document.createElement('input');
            inp.type = 'text';
            inp.className = 'edit-input bagian-label-input';
            inp.dataset.bagianId = bagian.Id;
            inp.dataset.labelKey = lf.key;
            inp.value = bagian[lf.key] || '';
            inp.style.minWidth = '70px';
            inp.title = 'Klik untuk edit label kolom ini';
            th.appendChild(inp);
            headerRow.appendChild(th);
        });

        var thAksi = document.createElement('th');
        thAksi.className = 'col-aksi';
        thAksi.textContent = 'Aksi';
        thAksi.style.minWidth = '75px';
        headerRow.appendChild(thAksi);

        thead.appendChild(headerRow);
        tbl.appendChild(thead);

        // tbody: rows belonging to this bagian
        var tbody = document.createElement('tbody');
        tbody.className = 'bagian-tbody';
        tbody.dataset.bagianName = bagian.Name;
        bagianItems.forEach(function(item) {
            tbody.appendChild(makeRow(item));
        });
        tbl.appendChild(tbody);
        tableWrapper.appendChild(tbl);

        // "Add row to this bagian" button
        var addBtn = document.createElement('button');
        addBtn.type = 'button';
        addBtn.className = 'btn btn-outline-success btn-sm mb-3';
        addBtn.innerHTML = '<i class="bi bi-plus me-1"></i>Tambah Baris ke ' + escHtml(bagian.Name);
        (function(capturedTbody, capturedBagianName) {
            addBtn.addEventListener('click', function() {
                var emptyRow = makeEmptyRow();
                emptyRow.querySelector('input[name="Bagian"]').value = capturedBagianName;
                capturedTbody.appendChild(emptyRow);
            });
        })(tbody, bagian.Name);

        sectionDiv.appendChild(heading);
        sectionDiv.appendChild(tableWrapper);
        sectionDiv.appendChild(addBtn);
        container.appendChild(sectionDiv);
    });

    // Show only selected bagian section
    function showEditBagian(name) {
        document.querySelectorAll('.edit-bagian-section').forEach(function(sec) {
            sec.style.display = sec.dataset.bagianName === name ? '' : 'none';
        });
    }

    // Re-wire change event (avoid duplicate listeners by replacing select)
    var oldFilter = document.getElementById('editBagianFilter');
    var newFilter = oldFilter.cloneNode(true);
    oldFilter.parentNode.replaceChild(newFilter, oldFilter);
    newFilter.addEventListener('change', function() { showEditBagian(this.value); });

    // Show first bagian on initial render
    if (kkjBagians.length > 0) {
        newFilter.value = kkjBagians[0].Name;
        showEditBagian(kkjBagians[0].Name);
    }
}

function makeRow(item) {
    var tr = document.createElement('tr');
    tr.dataset.id = item.Id || 0;

    // Hidden Bagian input (no td)
    var bagianInput = document.createElement('input');
    bagianInput.type = 'hidden';
    bagianInput.name = 'Bagian';
    bagianInput.value = item.Bagian || '';
    tr.appendChild(bagianInput);

    var fields = [
        { name:'No',                        val: item.No,                        cls:'col-no',    type:'number' },
        { name:'SkillGroup',                val: item.SkillGroup,                cls:'col-meta' },
        { name:'SubSkillGroup',             val: item.SubSkillGroup,             cls:'col-meta' },
        { name:'Indeks',                    val: item.Indeks,                    cls:'col-meta' },
        { name:'Kompetensi',                val: item.Kompetensi,                cls:'col-meta', style:'min-width:180px' },
        { name:'Target_SectionHead',        val: item.Target_SectionHead,        cls:'col-target' },
        { name:'Target_SrSpv_GSH',          val: item.Target_SrSpv_GSH,          cls:'col-target' },
        { name:'Target_ShiftSpv_GSH',       val: item.Target_ShiftSpv_GSH,       cls:'col-target' },
        { name:'Target_Panelman_GSH_12_13', val: item.Target_Panelman_GSH_12_13, cls:'col-target' },
        { name:'Target_Panelman_GSH_14',    val: item.Target_Panelman_GSH_14,    cls:'col-target' },
        { name:'Target_Operator_GSH_8_11',  val: item.Target_Operator_GSH_8_11,  cls:'col-target' },
        { name:'Target_Operator_GSH_12_13', val: item.Target_Operator_GSH_12_13, cls:'col-target' },
        { name:'Target_ShiftSpv_ARU',       val: item.Target_ShiftSpv_ARU,       cls:'col-target' },
        { name:'Target_Panelman_ARU_12_13', val: item.Target_Panelman_ARU_12_13, cls:'col-target' },
        { name:'Target_Panelman_ARU_14',    val: item.Target_Panelman_ARU_14,    cls:'col-target' },
        { name:'Target_Operator_ARU_8_11',  val: item.Target_Operator_ARU_8_11,  cls:'col-target' },
        { name:'Target_Operator_ARU_12_13', val: item.Target_Operator_ARU_12_13, cls:'col-target' },
        { name:'Target_SrSpv_Facility',     val: item.Target_SrSpv_Facility,     cls:'col-target' },
        { name:'Target_JrAnalyst',          val: item.Target_JrAnalyst,          cls:'col-target' },
        { name:'Target_HSE',                val: item.Target_HSE,                cls:'col-target' },
    ];
    fields.forEach(function(f) {
        var td = document.createElement('td');
        td.className = f.cls || '';
        if (f.style) td.style.cssText = f.style;
        var input = document.createElement('input');
        input.type = f.type || 'text';
        input.name = f.name;
        input.value = (f.val === null || f.val === undefined) ? '' : f.val;
        input.className = 'edit-input';
        td.appendChild(input);
        tr.appendChild(td);
    });

    // 22nd column: Aksi (insert-below + inline delete)
    var tdAksi = document.createElement('td');
    tdAksi.className = 'col-aksi text-nowrap';

    // Insert-below button
    var btnInsert = document.createElement('button');
    btnInsert.type = 'button';
    btnInsert.className = 'btn btn-outline-success btn-sm me-1';
    btnInsert.title = 'Sisipkan baris baru di bawah';
    btnInsert.innerHTML = '<i class="bi bi-plus-circle"></i>';
    btnInsert.addEventListener('click', function() {
        var bagianName = tr.querySelector('input[name="Bagian"]').value || '';
        var newRow = makeEmptyRow();
        newRow.querySelector('input[name="Bagian"]').value = bagianName;
        tr.parentNode.insertBefore(newRow, tr.nextSibling);
    });

    // Inline delete button
    var btnDel = document.createElement('button');
    btnDel.type = 'button';
    btnDel.className = 'btn btn-outline-danger btn-sm';
    btnDel.title = 'Hapus baris ini';
    btnDel.innerHTML = '<i class="bi bi-trash"></i>';
    btnDel.addEventListener('click', function() {
        var id = parseInt(tr.dataset.id) || 0;
        if (id === 0) {
            // Unsaved row — remove from DOM directly
            tr.remove();
        } else {
            // Saved row — confirm then AJAX delete
            var kompetensi = tr.querySelector('[name="Kompetensi"]') ? tr.querySelector('[name="Kompetensi"]').value : '';
            if (!confirm('Hapus "' + kompetensi + '"?')) return;
            var token = document.querySelector('input[name="__RequestVerificationToken"]').value;
            $.ajax({
                url: '/Admin/KkjMatrixDelete',
                type: 'POST',
                data: { id: id, __RequestVerificationToken: token },
                success: function(response) {
                    if (response.success) {
                        tr.remove();
                        kkjItems = kkjItems.filter(function(i) { return i.Id !== id; });
                    } else if (response.blocked) {
                        alert(response.message);
                    } else {
                        alert('Error: ' + response.message);
                    }
                }
            });
        }
    });

    tdAksi.appendChild(btnInsert);
    tdAksi.appendChild(btnDel);
    tr.appendChild(tdAksi);
    return tr;
}

function makeEmptyRow() {
    return makeRow({
        Id: 0, Bagian: '', No: 0, SkillGroup: '', SubSkillGroup: '', Indeks: '', Kompetensi: '',
        Target_SectionHead: '-', Target_SrSpv_GSH: '-', Target_ShiftSpv_GSH: '-',
        Target_Panelman_GSH_12_13: '-', Target_Panelman_GSH_14: '-',
        Target_Operator_GSH_8_11: '-', Target_Operator_GSH_12_13: '-',
        Target_ShiftSpv_ARU: '-', Target_Panelman_ARU_12_13: '-',
        Target_Panelman_ARU_14: '-', Target_Operator_ARU_8_11: '-',
        Target_Operator_ARU_12_13: '-', Target_SrSpv_Facility: '-',
        Target_JrAnalyst: '-', Target_HSE: '-'
    });
}

// --- EDIT MODE TOGGLE ---
document.getElementById('btnEdit').addEventListener('click', function() {
    renderEditRows();
    document.getElementById('readTable').classList.add('d-none');
    document.getElementById('editTablesContainer').classList.remove('d-none');
    document.getElementById('editActions').classList.remove('d-none');
    document.getElementById('editActions').classList.add('d-flex');
    this.classList.add('d-none');
});

document.getElementById('btnCancel').addEventListener('click', function() {
    document.getElementById('editTablesContainer').classList.add('d-none');
    document.getElementById('readTable').classList.remove('d-none');
    document.getElementById('editActions').classList.add('d-none');
    document.getElementById('editActions').classList.remove('d-flex');
    document.getElementById('btnEdit').classList.remove('d-none');
    selectedCells = [];
    document.querySelectorAll('.cell-selected').forEach(function(el) {
        el.classList.remove('cell-selected');
    });
});

// --- ADD BAGIAN ---
document.getElementById('btnAddBagian').addEventListener('click', function() {
    var token = document.querySelector('input[name="__RequestVerificationToken"]').value;
    $.ajax({
        url: '/Admin/KkjBagianAdd',
        type: 'POST',
        data: { __RequestVerificationToken: token },
        success: function(resp) {
            if (resp.success) {
                kkjBagians.push({
                    Id: resp.id,
                    Name: resp.name,
                    DisplayOrder: resp.displayOrder,
                    Label_SectionHead: 'Section Head',
                    Label_SrSpv_GSH: 'Sr Spv GSH',
                    Label_ShiftSpv_GSH: 'Shift Spv GSH',
                    Label_Panelman_GSH_12_13: 'Panelman GSH 12-13',
                    Label_Panelman_GSH_14: 'Panelman GSH 14',
                    Label_Operator_GSH_8_11: 'Op GSH 8-11',
                    Label_Operator_GSH_12_13: 'Op GSH 12-13',
                    Label_ShiftSpv_ARU: 'Shift Spv ARU',
                    Label_Panelman_ARU_12_13: 'Panelman ARU 12-13',
                    Label_Panelman_ARU_14: 'Panelman ARU 14',
                    Label_Operator_ARU_8_11: 'Op ARU 8-11',
                    Label_Operator_ARU_12_13: 'Op ARU 12-13',
                    Label_SrSpv_Facility: 'Sr Spv Facility',
                    Label_JrAnalyst: 'Jr Analyst',
                    Label_HSE: 'HSE'
                });
                renderEditRows();
            } else {
                alert('Error: ' + resp.message);
            }
        },
        error: function(xhr) {
            alert('Server error: ' + xhr.statusText);
        }
    });
});

// --- COLLECT BAGIANS FROM EDIT FORM ---
function collectBagians() {
    var result = [];
    document.querySelectorAll('.kkj-edit-tbl').forEach(function(tbl) {
        var bagianId = parseInt(tbl.dataset.bagianId) || 0;
        var b = { Id: bagianId, Name: '', DisplayOrder: 0 };
        var nameEl = document.querySelector('.bagian-name-input[data-bagian-id="' + bagianId + '"]');
        if (nameEl) {
            b.Name = nameEl.value;
            b.DisplayOrder = parseInt(nameEl.dataset.bagianOrder) || 0;
        }
        tbl.querySelectorAll('.bagian-label-input').forEach(function(inp) {
            b[inp.dataset.labelKey] = inp.value;
        });
        result.push(b);
    });
    return result;
}

// --- COLLECT ROWS FROM ALL BAGIAN TBODIES ---
function collectRows() {
    var rows = [];
    document.querySelectorAll('.bagian-tbody tr').forEach(function(tr) {
        var getVal = function(name) {
            var el = tr.querySelector('input[name="' + name + '"]');
            return el ? el.value : '';
        };
        rows.push({
            Id:                        parseInt(tr.dataset.id) || 0,
            Bagian:                    getVal('Bagian'),
            No:                        parseInt(getVal('No')) || 0,
            SkillGroup:                getVal('SkillGroup'),
            SubSkillGroup:             getVal('SubSkillGroup'),
            Indeks:                    getVal('Indeks'),
            Kompetensi:                getVal('Kompetensi'),
            Target_SectionHead:        getVal('Target_SectionHead') || '-',
            Target_SrSpv_GSH:          getVal('Target_SrSpv_GSH') || '-',
            Target_ShiftSpv_GSH:       getVal('Target_ShiftSpv_GSH') || '-',
            Target_Panelman_GSH_12_13: getVal('Target_Panelman_GSH_12_13') || '-',
            Target_Panelman_GSH_14:    getVal('Target_Panelman_GSH_14') || '-',
            Target_Operator_GSH_8_11:  getVal('Target_Operator_GSH_8_11') || '-',
            Target_Operator_GSH_12_13: getVal('Target_Operator_GSH_12_13') || '-',
            Target_ShiftSpv_ARU:       getVal('Target_ShiftSpv_ARU') || '-',
            Target_Panelman_ARU_12_13: getVal('Target_Panelman_ARU_12_13') || '-',
            Target_Panelman_ARU_14:    getVal('Target_Panelman_ARU_14') || '-',
            Target_Operator_ARU_8_11:  getVal('Target_Operator_ARU_8_11') || '-',
            Target_Operator_ARU_12_13: getVal('Target_Operator_ARU_12_13') || '-',
            Target_SrSpv_Facility:     getVal('Target_SrSpv_Facility') || '-',
            Target_JrAnalyst:          getVal('Target_JrAnalyst') || '-',
            Target_HSE:                getVal('Target_HSE') || '-'
        });
    });
    return rows;
}

// --- BULK SAVE (bagians + rows) ---
document.getElementById('btnSave').addEventListener('click', function() {
    var token = document.querySelector('input[name="__RequestVerificationToken"]').value;
    var bagians = collectBagians();
    var rows = collectRows();

    // Step 1: Save bagian headers
    $.ajax({
        url: '/Admin/KkjBagianSave',
        type: 'POST',
        contentType: 'application/json',
        headers: { 'RequestVerificationToken': token },
        data: JSON.stringify(bagians),
        success: function(bagianResp) {
            if (!bagianResp.success) {
                alert('Error menyimpan bagian: ' + bagianResp.message);
                return;
            }
            // Step 2: Save row data (skip if no rows)
            if (rows.length === 0) {
                var toastEl = document.getElementById('saveToast');
                var toast = new bootstrap.Toast(toastEl, { delay: 1500 });
                toast.show();
                setTimeout(function() { location.reload(); }, 1700);
                return;
            }
            $.ajax({
                url: '/Admin/KkjMatrixSave',
                type: 'POST',
                contentType: 'application/json',
                headers: { 'RequestVerificationToken': token },
                data: JSON.stringify(rows),
                success: function(rowResp) {
                    if (rowResp.success) {
                        var toastEl = document.getElementById('saveToast');
                        var toast = new bootstrap.Toast(toastEl, { delay: 1500 });
                        toast.show();
                        setTimeout(function() { location.reload(); }, 1700);
                    } else {
                        alert('Error menyimpan baris: ' + rowResp.message);
                    }
                },
                error: function(xhr) {
                    alert('Server error (rows): ' + xhr.statusText);
                }
            });
        },
        error: function(xhr) {
            alert('Server error (bagian): ' + xhr.statusText);
        }
    });
});

// --- DELETE ---
function deleteRow(id, kompetensi) {
    if (!confirm('Hapus "' + kompetensi + '"?')) return;
    var token = document.querySelector('input[name="__RequestVerificationToken"]').value;
    $.ajax({
        url: '/Admin/KkjMatrixDelete',
        type: 'POST',
        data: { id: id, __RequestVerificationToken: token },
        success: function(response) {
            if (response.success) {
                var row = document.querySelector('tr[data-id="' + id + '"]');
                if (row) row.remove();
                kkjItems = kkjItems.filter(function(i) { return i.Id !== id; });
            } else if (response.blocked) {
                alert(response.message);
            } else {
                alert('Error: ' + response.message);
            }
        }
    });
}

// --- CLIPBOARD PASTE (TSV from Excel) ---
document.getElementById('editTablesContainer').addEventListener('paste', function(e) {
    var targetTbl = e.target.closest('.kkj-edit-tbl');
    if (!targetTbl) return;
    e.preventDefault();
    var text = (e.clipboardData || window.clipboardData).getData('text');
    if (!text) return;
    var pastedRows = text.trim().split('\n');
    var tbody = targetTbl.querySelector('.bagian-tbody');
    // Use selectedCells[0] as anchor (document.activeElement may be body due to e.preventDefault in mousedown)
    var anchorTd = (selectedCells && selectedCells.length > 0) ? selectedCells[0] : null;
    var anchorRow = anchorTd ? anchorTd.closest('tr') : null;
    var startIdx = (anchorRow && tbody.contains(anchorRow)) ? Array.from(tbody.rows).indexOf(anchorRow) : tbody.rows.length;
    if (startIdx < 0) startIdx = tbody.rows.length;

    var colNames = [
        'No','SkillGroup','SubSkillGroup','Indeks','Kompetensi',
        'Target_SectionHead','Target_SrSpv_GSH','Target_ShiftSpv_GSH',
        'Target_Panelman_GSH_12_13','Target_Panelman_GSH_14',
        'Target_Operator_GSH_8_11','Target_Operator_GSH_12_13',
        'Target_ShiftSpv_ARU','Target_Panelman_ARU_12_13',
        'Target_Panelman_ARU_14','Target_Operator_ARU_8_11',
        'Target_Operator_ARU_12_13','Target_SrSpv_Facility',
        'Target_JrAnalyst','Target_HSE'
    ];

    pastedRows.forEach(function(rowText, pasteRowIdx) {
        var cols = rowText.split('\t');
        var targetRowIdx = startIdx + pasteRowIdx;
        var tr;
        if (targetRowIdx < tbody.rows.length) {
            tr = tbody.rows[targetRowIdx];
        } else {
            tr = makeEmptyRow();
            tr.querySelector('input[name="Bagian"]').value = tbody.dataset.bagianName || '';
            tbody.appendChild(tr);
        }
        cols.forEach(function(cellVal, colIdx) {
            if (colIdx >= colNames.length) return;
            var input = tr.querySelector('[name="' + colNames[colIdx] + '"]');
            if (input) input.value = cellVal.trim();
        });
    });
});

// --- TAB/ENTER KEYBOARD NAVIGATION ---
document.getElementById('editTablesContainer').addEventListener('keydown', function(e) {
    if (e.key !== 'Tab' && e.key !== 'Enter') return;
    var inputs = Array.from(document.querySelectorAll('#editTablesContainer .bagian-tbody input.edit-input'));
    var idx = inputs.indexOf(document.activeElement);
    if (idx < 0) return;
    e.preventDefault();
    var nextIdx = e.shiftKey ? idx - 1 : idx + 1;
    if (nextIdx >= 0 && nextIdx < inputs.length) {
        inputs[nextIdx].focus();
        inputs[nextIdx].select();
    }
});

// ========== MULTI-CELL SELECTION ==========
var selectedCells = [];
var isDragging = false;
var dragStartTd = null;

function getCellCoords(td) {
    // Returns { tbl, tbody, rowIdx, colIdx } for a given <td>
    var tr = td.parentElement;
    var tbody = tr.parentElement;
    var rowIdx = Array.from(tbody.rows).indexOf(tr);
    // colIdx: count only data-input tds (skip Aksi which has no input.edit-input)
    var allTds = Array.from(tr.cells);
    var colIdx = allTds.indexOf(td);
    return { tbody: tbody, rowIdx: rowIdx, colIdx: colIdx };
}

function getRangeCells(startTd, endTd) {
    // Returns all tds in the rectangular range between startTd and endTd
    // Both must be in the same .kkj-edit-tbl
    var tbl = startTd.closest('.kkj-edit-tbl');
    if (!tbl || startTd.closest('.kkj-edit-tbl') !== endTd.closest('.kkj-edit-tbl')) return [startTd];

    var startCoords = getCellCoords(startTd);
    var endCoords   = getCellCoords(endTd);

    var minRow = Math.min(startCoords.rowIdx, endCoords.rowIdx);
    var maxRow = Math.max(startCoords.rowIdx, endCoords.rowIdx);
    var minCol = Math.min(startCoords.colIdx, endCoords.colIdx);
    var maxCol = Math.max(startCoords.colIdx, endCoords.colIdx);

    var cells = [];
    var tbody = startCoords.tbody;
    for (var r = minRow; r <= maxRow; r++) {
        if (r >= tbody.rows.length) break;
        var tr = tbody.rows[r];
        var tds = Array.from(tr.cells);
        for (var c = minCol; c <= maxCol; c++) {
            if (c >= tds.length) break;
            var td = tds[c];
            // Only include cells that have an edit-input (skip Aksi column)
            if (td.querySelector('input.edit-input')) {
                cells.push(td);
            }
        }
    }
    return cells;
}

function applySelection(cells) {
    // Clear previous highlight
    document.querySelectorAll('.cell-selected').forEach(function(el) {
        el.classList.remove('cell-selected');
    });
    selectedCells = cells;
    cells.forEach(function(td) { td.classList.add('cell-selected'); });
}

// Mousedown: start selection on a data-input td
document.addEventListener('mousedown', function(e) {
    var td = e.target.closest('.kkj-edit-tbl td');
    if (!td || !td.querySelector('input.edit-input')) return;

    isDragging = true;
    dragStartTd = td;

    if (e.shiftKey && selectedCells.length > 0) {
        // Extend selection from existing anchor
        var anchorTd = selectedCells[0];
        applySelection(getRangeCells(anchorTd, td));
    } else {
        applySelection([td]);
    }
    e.preventDefault(); // Prevent text selection on drag
    // Focus anchor input so document.activeElement is a valid edit-input for paste routing
    var anchorInput = selectedCells[0] && selectedCells[0].querySelector('input.edit-input');
    if (anchorInput) anchorInput.focus();
});

// Mousemove: extend selection while dragging
document.addEventListener('mousemove', function(e) {
    if (!isDragging || !dragStartTd) return;
    var td = e.target.closest('.kkj-edit-tbl td');
    if (!td || !td.querySelector('input.edit-input')) return;
    applySelection(getRangeCells(dragStartTd, td));
});

// Mouseup: end drag
document.addEventListener('mouseup', function() {
    isDragging = false;
});

// Click on input inside a cell: select just that cell
document.addEventListener('click', function(e) {
    if (e.target.tagName !== 'INPUT' || !e.target.classList.contains('edit-input')) return;
    var td = e.target.closest('td');
    if (!td) return;
    if (e.shiftKey && selectedCells.length > 0) {
        applySelection(getRangeCells(selectedCells[0], td));
    } else if (!e.ctrlKey) {
        applySelection([td]);
    }
});

// Keydown: Delete clears selected cells; Ctrl+C copies; Tab/Enter navigation unchanged
document.addEventListener('keydown', function(e) {
    // Only act if we're in the edit context
    if (!document.getElementById('editTablesContainer') ||
        document.getElementById('editTablesContainer').classList.contains('d-none')) return;

    if (e.key === 'Delete' && selectedCells.length > 1) {
        // Multi-cell delete: clear all selected inputs
        e.preventDefault();
        selectedCells.forEach(function(td) {
            var inp = td.querySelector('input.edit-input');
            if (inp) inp.value = '';
        });
        return;
    }

    if ((e.ctrlKey || e.metaKey) && e.key === 'c' && selectedCells.length > 0) {
        // Ctrl+C: copy selected range as TSV
        e.preventDefault();
        var tbl = selectedCells[0].closest('.kkj-edit-tbl');
        var startCoords = getCellCoords(selectedCells[0]);
        var endCoords   = getCellCoords(selectedCells[selectedCells.length - 1]);
        var minRow = Math.min(startCoords.rowIdx, endCoords.rowIdx);
        var maxRow = Math.max(startCoords.rowIdx, endCoords.rowIdx);
        var minCol = Math.min(startCoords.colIdx, endCoords.colIdx);
        var maxCol = Math.max(startCoords.colIdx, endCoords.colIdx);

        var lines = [];
        var tbody = startCoords.tbody;
        for (var r = minRow; r <= maxRow; r++) {
            if (r >= tbody.rows.length) break;
            var tr = tbody.rows[r];
            var tds = Array.from(tr.cells);
            var cols = [];
            for (var c = minCol; c <= maxCol; c++) {
                if (c >= tds.length) break;
                var inp = tds[c].querySelector('input.edit-input');
                cols.push(inp ? inp.value : '');
            }
            lines.push(cols.join('\t'));
        }
        navigator.clipboard.writeText(lines.join('\n')).catch(function() {
            // Fallback for older browsers
            var ta = document.createElement('textarea');
            ta.value = lines.join('\n');
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
        });
        return;
    }

    if ((e.ctrlKey || e.metaKey) && e.key === 'v' && selectedCells.length > 0) {
        // Ctrl+V: read clipboard directly — decoupled from focus/activeElement state
        // Cannot rely on native paste event routing because e.preventDefault() in mousedown
        // causes document.activeElement to be body, not an edit-input inside .kkj-edit-tbl
        e.preventDefault();
        navigator.clipboard.readText().then(function(text) {
            if (!text) return;
            var anchorTd = selectedCells[0];
            var targetTbl = anchorTd.closest('.kkj-edit-tbl');
            if (!targetTbl) return;
            var tbody = targetTbl.querySelector('.bagian-tbody');
            if (!tbody) return;
            var anchorRow = anchorTd.closest('tr');
            var startIdx = (anchorRow && tbody.contains(anchorRow)) ? Array.from(tbody.rows).indexOf(anchorRow) : 0;
            if (startIdx < 0) startIdx = 0;

            var colNames = [
                'No','SkillGroup','SubSkillGroup','Indeks','Kompetensi',
                'Target_SectionHead','Target_SrSpv_GSH','Target_ShiftSpv_GSH',
                'Target_Panelman_GSH_12_13','Target_Panelman_GSH_14',
                'Target_Operator_GSH_8_11','Target_Operator_GSH_12_13',
                'Target_ShiftSpv_ARU','Target_Panelman_ARU_12_13',
                'Target_Panelman_ARU_14','Target_Operator_ARU_8_11',
                'Target_Operator_ARU_12_13','Target_SrSpv_Facility',
                'Target_JrAnalyst','Target_HSE'
            ];

            // Determine start column from anchor td position
            var anchorAllTds = Array.from(anchorTd.parentElement.cells);
            var anchorColIdx = anchorAllTds.indexOf(anchorTd);

            var pastedRows = text.trim().split('\n');
            pastedRows.forEach(function(rowText, pasteRowIdx) {
                var cols = rowText.split('\t');
                var targetRowIdx = startIdx + pasteRowIdx;
                var tr;
                if (targetRowIdx < tbody.rows.length) {
                    tr = tbody.rows[targetRowIdx];
                } else {
                    tr = makeEmptyRow();
                    tr.querySelector('input[name="Bagian"]').value = tbody.dataset.bagianName || '';
                    tbody.appendChild(tr);
                }
                cols.forEach(function(cellVal, colOffset) {
                    var colIdx = anchorColIdx + colOffset;
                    if (colIdx >= anchorAllTds.length) return;
                    var colName = colNames[colIdx];
                    if (!colName) return;
                    var input = tr.querySelector('[name="' + colName + '"]');
                    if (input) input.value = cellVal.trim();
                });
            });
        }).catch(function(err) {
            console.warn('Clipboard read failed:', err);
        });
        return;
    }
});
</script>
}
