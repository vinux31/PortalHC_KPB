@model List<HcPortal.Models.TrackingItem>

@{
    ViewData["Title"] = "Progress & Tracking";
    
    // Calculate Summary Stats
    var totalItems = Model.Count();
    var completedItems = Model.Count(x => x.ApprovalHC == "Approved");
    var progressPercentage = totalItems > 0 ? (int)((double)completedItems / totalItems * 100) : 0;
    
    var pendingActions = Model.Count(x => x.EvidenceStatus != "Uploaded");
    var pendingApprovals = Model.Count(x => x.EvidenceStatus == "Uploaded" && x.ApprovalHC != "Approved");
}

<style>
    /* Sticky Header */
    .table-responsive {
        max-height: 80vh;
        overflow-y: auto;
    }
    thead th {
        position: sticky;
        top: 0;
        z-index: 10;
        background-color: #f8f9fa !important;
        box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
    }
    .hover-scale:hover {
        transform: translateY(-2px);
        transition: transform 0.2s;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold text-primary">Progress & Tracking</h2>
        <p class="text-muted">Monitoring status approval dan evidence kompetensi.</p>
    </div>
    <div>
        <button class="btn btn-outline-success me-2">
            <i class="bi bi-file-earmark-excel me-1"></i> Export Excel
        </button>
        <button class="btn btn-outline-danger">
            <i class="bi bi-file-earmark-pdf me-1"></i> Export PDF
        </button>
    </div>
</div>

<!-- Summary Dashboard -->
<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="card shadow-sm border-0 bg-primary bg-gradient text-white h-100 hover-scale">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="text-white-50">Total Progress</h6>
                    <i class="bi bi-trophy-fill fs-4 text-white-50"></i>
                </div>
                <h2 class="fw-bold mb-2">@progressPercentage%</h2>
                <div class="progress bg-white bg-opacity-25" style="height: 6px;">
                    <div class="progress-bar bg-white" role="progressbar" style="width: @progressPercentage%"></div>
                </div>
                <small class="text-white-50 mt-2 d-block">@completedItems of @totalItems Competencies Completed</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow-sm border-0 border-start border-4 border-warning h-100 hover-scale">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="bg-warning bg-opacity-10 p-3 rounded me-3">
                        <i class="bi bi-exclamation-circle text-warning fs-3"></i>
                    </div>
                    <div>
                        <h6 class="text-muted mb-1">Butuh Tindakan</h6>
                        <h3 class="fw-bold mb-0">@pendingActions</h3>
                        <small class="text-muted">Evidence belum diupload</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow-sm border-0 border-start border-4 border-info h-100 hover-scale">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="bg-info bg-opacity-10 p-3 rounded me-3">
                        <i class="bi bi-hourglass-split text-info fs-3"></i>
                    </div>
                    <div>
                        <h6 class="text-muted mb-1">Menunggu Approval</h6>
                        <h3 class="fw-bold mb-0">@pendingApprovals</h3>
                        <small class="text-muted">Proses review berjenjang</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filters and Table -->
<div class="card shadow-sm border-0">
    <div class="card-header bg-white py-3 border-0 border-bottom">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h5 class="mb-0 fw-bold">Daftar Kompetensi</h5>
            </div>
            <div class="col-md-6 text-end">
                <div class="d-inline-block">
                    <select class="form-select form-select-sm" style="width: auto;">
                        <option value="">Semua Tahun</option>
                        <option value="Tahun Pertama">Tahun Pertama</option>
                        <option value="Tahun Kedua">Tahun Kedua</option>
                        <option value="Tahun Ketiga">Tahun Ketiga</option>
                    </select>
                </div>
                <div class="d-inline-block ms-2">
                    <input type="text" class="form-control form-control-sm" placeholder="Cari kompetensi...">
                </div>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light text-secondary small text-uppercase">
                    <tr>
                        <th class="p-3 ps-4" style="width: 25%">Nama Kompetensi CPDP</th>
                        <th class="p-3 text-center" style="width: 10%">Implementasi</th>
                        <th class="p-3" style="width: 20%">Nama Sub Kompetensi</th>
                        <th class="p-3 text-center" style="width: 10%">Evidence</th>
                        <th class="p-3 text-center" style="width: 10%">Sr. Supervisor</th>
                        <th class="p-3 text-center" style="width: 10%">Section Head</th>
                        <th class="p-3 text-center" style="width: 10%">HC</th>
                        <th class="p-3 text-center" style="width: 5%">Action</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td class="p-3 ps-4 fw-bold text-dark">@item.Kompetensi</td>
                            <td class="p-3 text-center text-muted small">@item.Periode</td>
                            <td class="p-3 text-dark small">
                                @item.SubKompetensi
                                @if(!string.IsNullOrEmpty(item.SupervisorComments))
                                {
                                    <i class="bi bi-chat-left-text-fill text-warning ms-1" 
                                       data-bs-toggle="tooltip" 
                                       title="Catatan Supervisor: @item.SupervisorComments"></i>
                                }
                            </td>
                            
                            <!-- Evidence Status -->
                            <td class="p-3 text-center">
                                @if(item.EvidenceStatus == "Uploaded") {
                                    <span class="badge bg-success bg-opacity-10 text-success border border-success rounded-pill px-3">
                                        <i class="bi bi-check-circle me-1"></i> Uploaded
                                    </span>
                                } else {
                                     <span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary rounded-pill px-3">
                                        <i class="bi bi-dash-circle me-1"></i> Pending
                                    </span>
                                }
                            </td>

                            <!-- Approvals -->
                            <td class="p-3 text-center">
                                @{ RenderStatusBadge(item.ApprovalSrSpv); }
                            </td>
                            <td class="p-3 text-center">
                                @{ RenderStatusBadge(item.ApprovalSectionHead); }
                            </td>
                            <td class="p-3 text-center">
                                @{ RenderStatusBadge(item.ApprovalHC); }
                            </td>
                            
                             <!-- Action -->
                            <td class="p-3 text-center">
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-light border rounded-circle" type="button" data-bs-toggle="dropdown">
                                        <i class="bi bi-three-dots-vertical"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                                        @if(item.EvidenceStatus != "Uploaded") {
                                            <li><a class="dropdown-item" href="#"><i class="bi bi-upload me-2 text-primary"></i> Upload Evidence</a></li>
                                        } else {
                                            <li><a class="dropdown-item" href="#"><i class="bi bi-eye me-2 text-info"></i> Lihat Evidence</a></li>
                                        }
                                        <li><a class="dropdown-item" href="#"><i class="bi bi-journal-text me-2"></i> Detail Log</a></li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@functions {
    void RenderStatusBadge(string? status)
    {
        if (status == "Approved")
        {
            <span class="badge bg-success bg-opacity-10 text-success border border-success px-2 py-1 rounded-pill small">
                <i class="bi bi-check me-1"></i> Approved
            </span>
        }
        else if (status == "Rejected")
        {
            <span class="badge bg-danger bg-opacity-10 text-danger border border-danger px-2 py-1 rounded-pill small">
                <i class="bi bi-x me-1"></i> Rejected
            </span>
        }
        else if (status == "Pending")
        {
             <span class="badge bg-warning bg-opacity-10 text-warning border border-warning px-2 py-1 rounded-pill small">
                <i class="bi bi-hourglass me-1"></i> Pending
            </span>
        }
        else
        {
            <span class="text-muted small">-</span>
        }
    }
}

@section Scripts {
    <script>
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })
    </script>
}
