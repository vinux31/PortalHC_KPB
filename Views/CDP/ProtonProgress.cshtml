@model List<HcPortal.Models.TrackingItem>
@{
    ViewData["Title"] = "Proton Progress";
    var userLevel = (int)ViewBag.UserLevel;
    var userRole = ViewBag.UserRole as string ?? "";
    var allBagian = ViewBag.AllBagian as List<string> ?? new List<string>();
    var allUnits = ViewBag.AllUnits as List<string> ?? new List<string>();
    var allTracks = ViewBag.AllTracks as List<string> ?? new List<string>();
    var allTahun = ViewBag.AllTahun as List<string> ?? new List<string>();
    var coachees = ViewBag.Coachees as List<HcPortal.Models.ApplicationUser>;
    var selectedBagian = ViewBag.SelectedBagian as string ?? "";
    var selectedUnit = ViewBag.SelectedUnit as string ?? "";
    var selectedTrackType = ViewBag.SelectedTrackType as string ?? "";
    var selectedTahun = ViewBag.SelectedTahun as string ?? "";
    var selectedCoacheeId = ViewBag.SelectedCoacheeId as string ?? "";
    var progressPercent = (int)ViewBag.ProgressPercent;
    var pendingActions = (int)ViewBag.PendingActions;
    var pendingApprovals = (int)ViewBag.PendingApprovals;
    var showCoacheeColumn = string.IsNullOrEmpty(selectedCoacheeId) && userLevel < 6;

    bool isSrSpv = userRole == "Sr Supervisor";
    bool isSH = userRole == "Section Head";
    bool isHC = userRole == "HC" || userRole == "Admin";
    bool isCoach = userLevel == 5;
    bool isCoachee = userLevel == 6;

    // Pre-compute groupings for table rendering
    var coacheeGroups = Model
        .GroupBy(x => x.CoacheeName)
        .Select(cg => new {
            CoacheeName = cg.Key,
            RowCount = cg.Count(),
            KompGroups = cg.GroupBy(x => x.Kompetensi)
                .Select(kg => new {
                    Kompetensi = kg.Key,
                    RowCount = kg.Count(),
                    SubGroups = kg.GroupBy(x => x.SubKompetensi)
                        .Select(sg => new {
                            SubKompetensi = sg.Key,
                            RowCount = sg.Count(),
                            Items = sg.ToList()
                        }).ToList()
                }).ToList()
        }).ToList();

    var kompetensiGroups = Model
        .GroupBy(x => x.Kompetensi)
        .Select(g => new {
            Kompetensi = g.Key,
            RowCount = g.Count(),
            SubGroups = g.GroupBy(x => x.SubKompetensi)
                .Select(sg => new {
                    SubKompetensi = sg.Key,
                    RowCount = sg.Count(),
                    Items = sg.ToList()
                }).ToList()
        }).ToList();
}

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="bi bi-graph-up me-2"></i>Proton Progress</h2>
            <p class="text-muted mb-0">Monitor deliverable progress and approval status</p>
        </div>
        <a href="@Url.Action("Index", "CDP")" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>Kembali
        </a>
    </div>

    @* Filter bar — GET form, auto-submits on dropdown change *@
    <form method="get" asp-action="ProtonProgress" asp-controller="CDP" id="filterForm"
          class="d-flex flex-wrap gap-2 align-items-center mb-3">

        @* Bagian dropdown — HC/Admin only (Level 1-2) *@
        @if (userLevel <= 2)
        {
            <select name="bagian" class="form-select form-select-sm" style="width:auto;min-width:150px"
                    onchange="onBagianChange(this)">
                <option value="">Semua Bagian</option>
                @foreach (var b in allBagian)
                {
                    if (b == selectedBagian)
                    {
                        <option value="@b" selected>@b</option>
                    }
                    else
                    {
                        <option value="@b">@b</option>
                    }
                }
            </select>
        }

        @* Unit dropdown — HC/Admin (Level 1-2) and SrSpv/SectionHead (Level 4) *@
        @if (userLevel <= 2 || userLevel == 4)
        {
            <select name="unit" id="unitSelect" class="form-select form-select-sm" style="width:auto;min-width:180px"
                    onchange="this.form.submit()">
                <option value="">Semua Unit</option>
                @foreach (var u in allUnits)
                {
                    if (u == selectedUnit)
                    {
                        <option value="@u" selected>@u</option>
                    }
                    else
                    {
                        <option value="@u">@u</option>
                    }
                }
            </select>
        }

        @* Coachee dropdown — Coach (Level 5) and HC/Admin (Level 1-2) *@
        @if (coachees != null && (userLevel == 5 || userLevel <= 2))
        {
            <select name="coacheeId" class="form-select form-select-sm" style="width:auto;min-width:180px"
                    onchange="this.form.submit()">
                <option value="">Semua Coachee</option>
                @foreach (var c in coachees)
                {
                    if (c.Id == selectedCoacheeId)
                    {
                        <option value="@c.Id" selected>@c.FullName</option>
                    }
                    else
                    {
                        <option value="@c.Id">@c.FullName</option>
                    }
                }
            </select>
        }

        @* Track dropdown — all roles except Coachee (Level 6) *@
        @if (userLevel < 6)
        {
            <select name="trackType" class="form-select form-select-sm" style="width:auto;min-width:140px"
                    onchange="this.form.submit()">
                <option value="">Semua Track</option>
                @foreach (var t in allTracks)
                {
                    if (t == selectedTrackType)
                    {
                        <option value="@t" selected>@t</option>
                    }
                    else
                    {
                        <option value="@t">@t</option>
                    }
                }
            </select>
        }

        @* Tahun dropdown — all roles except Coachee (Level 6) *@
        @if (userLevel < 6)
        {
            <select name="tahun" class="form-select form-select-sm" style="width:auto;min-width:130px"
                    onchange="this.form.submit()">
                <option value="">Semua Tahun</option>
                @foreach (var th in allTahun)
                {
                    if (th == selectedTahun)
                    {
                        <option value="@th" selected>@th</option>
                    }
                    else
                    {
                        <option value="@th">@th</option>
                    }
                }
            </select>
        }

        @* Search box — client-side only, NOT a form field (no name attribute) *@
        @if (userLevel < 6)
        {
            <div class="position-relative" style="min-width:200px">
                <span class="position-absolute top-50 start-0 translate-middle-y ps-2 text-muted">
                    <i class="bi bi-search"></i>
                </span>
                <input type="text" id="searchInput" class="form-control form-control-sm ps-4"
                       placeholder="Cari kompetensi..." autocomplete="off">
                <button type="button" id="searchClear"
                        class="btn btn-sm position-absolute top-50 end-0 translate-middle-y d-none"
                        style="border:none;background:none;color:#6c757d"
                        onclick="clearSearch()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        }

        @* Reset button *@
        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">
            <i class="bi bi-arrow-counterclockwise"></i> Reset
        </button>
    </form>

    @* Result count *@
    <small class="text-muted mb-2 d-block">Menampilkan @ViewBag.FilteredCount dari @ViewBag.TotalCount data</small>

    @* Summary stat cards *@
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <h6 class="text-muted mb-1">Progress</h6>
                    <h3 class="mb-0 text-primary">@progressPercent%</h3>
                    <div class="progress mt-2" style="height: 6px;">
                        <div class="progress-bar" role="progressbar" style="width: @progressPercent%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <h6 class="text-muted mb-1">Pending Actions</h6>
                    <h3 class="mb-0 text-warning">@pendingActions</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <h6 class="text-muted mb-1">Pending Approvals</h6>
                    <h3 class="mb-0 text-info">@pendingApprovals</h3>
                </div>
            </div>
        </div>
    </div>

    @* Coachee info — when single coachee selected *@
    @if (!string.IsNullOrEmpty(ViewBag.SelectedCoacheeId as string))
    {
        <div class="card mb-3">
            <div class="card-body py-2">
                <strong>@ViewBag.CoacheeName</strong>
                @if (!string.IsNullOrEmpty(ViewBag.TrackLabel as string))
                {
                    <span class="badge bg-primary ms-2">@ViewBag.TrackLabel</span>
                }
            </div>
        </div>
    }

    @* Coachee info for Level 6 — own data *@
    @if (userLevel == 6)
    {
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="mb-1">@ViewBag.UserFullName</h5>
                @if (!string.IsNullOrEmpty(ViewBag.TrackLabel as string))
                {
                    <span class="badge bg-info">@ViewBag.TrackLabel</span>
                }
            </div>
        </div>
    }

    @* Empty state — no data matching current filters *@
    @if (Model.Count == 0 && !string.IsNullOrEmpty(ViewBag.EmptyMessage as string))
    {
        <div class="alert alert-info">@ViewBag.EmptyMessage</div>
    }

    @* Search no-results message (hidden by default, shown by JS) *@
    <div id="searchNoResults" class="alert alert-warning d-none">
        Tidak ditemukan kompetensi untuk '<span id="searchQuery"></span>'
    </div>

    @* Deliverable table *@
    @if (Model.Count > 0)
    {
        <div class="table-responsive">
            <table class="table table-bordered table-hover" id="progressTable">
                <thead class="table-light">
                    <tr>
                        @if (showCoacheeColumn)
                        {
                            <th>Coachee</th>
                        }
                        <th>Kompetensi</th>
                        <th>Sub Kompetensi</th>
                        <th>Deliverable</th>
                        <th>Evidence</th>
                        <th>Approval Sr. Spv</th>
                        <th>Approval Section Head</th>
                        <th>Approval HC</th>
                        <th>Detail</th>
                    </tr>
                </thead>
                <tbody id="progressTableBody">
                    @if (showCoacheeColumn)
                    {
                        @* Multi-coachee view: group by CoacheeName, then Kompetensi, then SubKompetensi *@
                        @foreach (var coacheeGroup in coacheeGroups)
                        {
                            bool firstCoacheeRow = true;
                            foreach (var kompGroup in coacheeGroup.KompGroups)
                            {
                                bool firstKomp = true;
                                foreach (var subGroup in kompGroup.SubGroups)
                                {
                                    bool firstSub = true;
                                    foreach (var item in subGroup.Items)
                                    {
                                        <tr data-kompetensi="@item.Kompetensi" data-deliverable="@item.Deliverable">
                                            @if (firstCoacheeRow)
                                            {
                                                <td rowspan="@coacheeGroup.RowCount" class="align-middle fw-bold">@coacheeGroup.CoacheeName</td>
                                                firstCoacheeRow = false;
                                            }
                                            @if (firstKomp)
                                            {
                                                <td rowspan="@kompGroup.RowCount" class="align-middle fw-bold">@kompGroup.Kompetensi</td>
                                                firstKomp = false;
                                            }
                                            @if (firstSub)
                                            {
                                                <td rowspan="@subGroup.RowCount" class="align-middle">@subGroup.SubKompetensi</td>
                                                firstSub = false;
                                            }
                                            <td>@item.Deliverable</td>
                                            @* Evidence column *@
                                            <td class="text-center" id="evidence-@item.Id">
                                                @if (isCoach && (item.Status == "Pending" || item.Status == "Rejected"))
                                                {
                                                    <button class="btn btn-sm btn-primary btnSubmitEvidence"
                                                            data-progress-id="@item.Id"
                                                            data-deliverable="@item.Deliverable"
                                                            data-kompetensi="@item.Kompetensi"
                                                            data-sub-kompetensi="@item.SubKompetensi"
                                                            data-status="@item.Status">Submit Evidence</button>
                                                }
                                                else if (item.EvidenceStatus == "Uploaded")
                                                {
                                                    <span class="badge bg-success">Sudah Upload</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary">Belum Upload</span>
                                                }
                                            </td>
                                            @* SrSpv approval column *@
                                            <td class="text-center" id="srspv-@item.Id">
                                                @if (!string.IsNullOrEmpty(item.SrSpvApproverName))
                                                {
                                                    @Html.Raw(GetApprovalBadgeWithTooltip(item.ApprovalSrSpv, item.SrSpvApproverName, item.SrSpvApprovedAt))
                                                }
                                                else
                                                {
                                                    @Html.Raw(GetApprovalBadge(item.ApprovalSrSpv))
                                                }
                                                @if (isSrSpv && item.Status == "Submitted" && item.ApprovalSrSpv == "Pending")
                                                {
                                                    <br />
                                                    <button class="btn btn-sm btn-outline-primary btnTinjau mt-1"
                                                            data-bs-toggle="modal" data-bs-target="#tinjaModal"
                                                            data-progress-id="@item.Id"
                                                            data-deliverable="@item.Deliverable"
                                                            data-kompetensi="@item.Kompetensi"
                                                            data-sub-kompetensi="@item.SubKompetensi"
                                                            data-evidence-url="@item.FullEvidencePath"
                                                            data-role="srspv">Tinjau</button>
                                                }
                                            </td>
                                            @* SH approval column *@
                                            <td class="text-center" id="sh-@item.Id">
                                                @if (!string.IsNullOrEmpty(item.ShApproverName))
                                                {
                                                    @Html.Raw(GetApprovalBadgeWithTooltip(item.ApprovalSectionHead, item.ShApproverName, item.ShApprovedAt))
                                                }
                                                else
                                                {
                                                    @Html.Raw(GetApprovalBadge(item.ApprovalSectionHead))
                                                }
                                                @if (isSH && item.Status == "Submitted" && item.ApprovalSectionHead == "Pending")
                                                {
                                                    <br />
                                                    <button class="btn btn-sm btn-outline-primary btnTinjau mt-1"
                                                            data-bs-toggle="modal" data-bs-target="#tinjaModal"
                                                            data-progress-id="@item.Id"
                                                            data-deliverable="@item.Deliverable"
                                                            data-kompetensi="@item.Kompetensi"
                                                            data-sub-kompetensi="@item.SubKompetensi"
                                                            data-evidence-url="@item.FullEvidencePath"
                                                            data-role="sh">Tinjau</button>
                                                }
                                            </td>
                                            @* HC approval column *@
                                            <td class="text-center" id="hc-@item.Id">
                                                @if (!string.IsNullOrEmpty(item.HcReviewerName))
                                                {
                                                    @Html.Raw(GetApprovalBadgeWithTooltip(item.ApprovalHC, item.HcReviewerName, item.HcReviewedAt))
                                                }
                                                else
                                                {
                                                    @Html.Raw(GetApprovalBadge(item.ApprovalHC))
                                                }
                                                @if (isHC && item.Status == "Submitted" && item.ApprovalHC == "Pending")
                                                {
                                                    <br />
                                                    <button class="btn btn-sm btn-outline-success btnHcReview mt-1"
                                                            data-progress-id="@item.Id">Review</button>
                                                }
                                            </td>
                                            <td class="text-center">
                                                <a asp-action="Deliverable" asp-route-id="@item.Id"
                                                   class="btn btn-sm btn-outline-secondary">Lihat Detail</a>
                                            </td>
                                        </tr>
                                    }
                                }
                            }
                        }
                    }
                    else
                    {
                        @* Single-coachee view: group by Kompetensi, then SubKompetensi *@
                        @foreach (var kompGroup in kompetensiGroups)
                        {
                            bool firstKomp = true;
                            foreach (var subGroup in kompGroup.SubGroups)
                            {
                                bool firstSub = true;
                                foreach (var item in subGroup.Items)
                                {
                                    <tr data-kompetensi="@item.Kompetensi" data-deliverable="@item.Deliverable">
                                        @if (firstKomp)
                                        {
                                            <td rowspan="@kompGroup.RowCount" class="align-middle fw-bold">@kompGroup.Kompetensi</td>
                                            firstKomp = false;
                                        }
                                        @if (firstSub)
                                        {
                                            <td rowspan="@subGroup.RowCount" class="align-middle">@subGroup.SubKompetensi</td>
                                            firstSub = false;
                                        }
                                        <td>@item.Deliverable</td>
                                        @* Evidence column *@
                                        <td class="text-center" id="evidence-@item.Id">
                                            @if (isCoach && (item.Status == "Pending" || item.Status == "Rejected"))
                                            {
                                                <button class="btn btn-sm btn-primary btnSubmitEvidence"
                                                        data-progress-id="@item.Id"
                                                        data-deliverable="@item.Deliverable"
                                                        data-kompetensi="@item.Kompetensi"
                                                        data-sub-kompetensi="@item.SubKompetensi"
                                                        data-status="@item.Status">Submit Evidence</button>
                                            }
                                            else if (item.EvidenceStatus == "Uploaded")
                                            {
                                                <span class="badge bg-success">Sudah Upload</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">Belum Upload</span>
                                            }
                                        </td>
                                        @* SrSpv approval column *@
                                        <td class="text-center" id="srspv-@item.Id">
                                            @if (!string.IsNullOrEmpty(item.SrSpvApproverName))
                                            {
                                                @Html.Raw(GetApprovalBadgeWithTooltip(item.ApprovalSrSpv, item.SrSpvApproverName, item.SrSpvApprovedAt))
                                            }
                                            else
                                            {
                                                @Html.Raw(GetApprovalBadge(item.ApprovalSrSpv))
                                            }
                                            @if (isSrSpv && item.Status == "Submitted" && item.ApprovalSrSpv == "Pending")
                                            {
                                                <br />
                                                <button class="btn btn-sm btn-outline-primary btnTinjau mt-1"
                                                        data-bs-toggle="modal" data-bs-target="#tinjaModal"
                                                        data-progress-id="@item.Id"
                                                        data-deliverable="@item.Deliverable"
                                                        data-kompetensi="@item.Kompetensi"
                                                        data-sub-kompetensi="@item.SubKompetensi"
                                                        data-evidence-url="@item.FullEvidencePath"
                                                        data-role="srspv">Tinjau</button>
                                            }
                                        </td>
                                        @* SH approval column *@
                                        <td class="text-center" id="sh-@item.Id">
                                            @if (!string.IsNullOrEmpty(item.ShApproverName))
                                            {
                                                @Html.Raw(GetApprovalBadgeWithTooltip(item.ApprovalSectionHead, item.ShApproverName, item.ShApprovedAt))
                                            }
                                            else
                                            {
                                                @Html.Raw(GetApprovalBadge(item.ApprovalSectionHead))
                                            }
                                            @if (isSH && item.Status == "Submitted" && item.ApprovalSectionHead == "Pending")
                                            {
                                                <br />
                                                <button class="btn btn-sm btn-outline-primary btnTinjau mt-1"
                                                        data-bs-toggle="modal" data-bs-target="#tinjaModal"
                                                        data-progress-id="@item.Id"
                                                        data-deliverable="@item.Deliverable"
                                                        data-kompetensi="@item.Kompetensi"
                                                        data-sub-kompetensi="@item.SubKompetensi"
                                                        data-evidence-url="@item.FullEvidencePath"
                                                        data-role="sh">Tinjau</button>
                                            }
                                        </td>
                                        @* HC approval column *@
                                        <td class="text-center" id="hc-@item.Id">
                                            @if (!string.IsNullOrEmpty(item.HcReviewerName))
                                            {
                                                @Html.Raw(GetApprovalBadgeWithTooltip(item.ApprovalHC, item.HcReviewerName, item.HcReviewedAt))
                                            }
                                            else
                                            {
                                                @Html.Raw(GetApprovalBadge(item.ApprovalHC))
                                            }
                                            @if (isHC && item.Status == "Submitted" && item.ApprovalHC == "Pending")
                                            {
                                                <br />
                                                <button class="btn btn-sm btn-outline-success btnHcReview mt-1"
                                                        data-progress-id="@item.Id">Review</button>
                                            }
                                        </td>
                                        <td class="text-center">
                                            <a asp-action="Deliverable" asp-route-id="@item.Id"
                                               class="btn btn-sm btn-outline-secondary">Lihat Detail</a>
                                        </td>
                                    </tr>
                                }
                            }
                        }
                    }
                </tbody>
            </table>
        </div>
    }

</div> @* end container-fluid *@

@* Tinjau Modal — shared for SrSpv and SH approve/reject *@
<div class="modal fade" id="tinjaModal" tabindex="-1" aria-labelledby="tinjaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="tinjaModalLabel">Tinjau Deliverable</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modalProgressId" />
                <input type="hidden" id="modalRole" />
                <p><strong>Kompetensi:</strong> <span id="modalKompetensi"></span></p>
                <p><strong>Sub-Kompetensi:</strong> <span id="modalSubKompetensi"></span></p>
                <p><strong>Deliverable:</strong> <span id="modalDeliverableName"></span></p>
                <p><strong>Evidence:</strong> <a id="modalEvidenceLink" href="#" target="_blank" rel="noopener">Lihat Evidence</a></p>
                <div class="mb-3">
                    <label class="form-label">Aksi</label>
                    <select class="form-select" id="modalAction">
                        <option value="">-- Pilih Aksi --</option>
                        <option value="approve">Approve</option>
                        <option value="reject">Reject</option>
                    </select>
                </div>
                <div class="mb-3 d-none" id="commentGroup">
                    <label class="form-label">Komentar <span id="commentRequired" class="text-danger d-none">*</span></label>
                    <textarea class="form-control" id="modalComment" rows="3" placeholder="Masukkan alasan penolakan..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-primary" id="btnSubmitTinja" disabled>Submit</button>
            </div>
        </div>
    </div>
</div>

@* Evidence + Coaching Modal — Plan 02 *@
<div class="modal fade" id="evidenceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Submit Evidence &amp; Coaching Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                @* Deliverable selector (batch) *@
                <div class="mb-3">
                    <label class="form-label fw-bold">Deliverable</label>
                    <div id="deliverableSelector" class="border rounded p-2" style="max-height:200px;overflow-y:auto">
                        @* Populated by JS *@
                    </div>
                </div>
                <hr/>
                @* Date *@
                <div class="mb-3">
                    <label class="form-label">Tanggal</label>
                    <input type="date" class="form-control" id="evidenceDate" />
                </div>
                @* Kompetensi Coachee (free-text) *@
                <div class="mb-3">
                    <label class="form-label">Kompetensi Coachee</label>
                    <textarea class="form-control" id="evidenceKoacheeComp" rows="2" placeholder="Coach menuliskan competencies yang harus dipenuhi sesuai dengan workbook"></textarea>
                </div>
                @* Catatan Coach *@
                <div class="mb-3">
                    <label class="form-label">Catatan Coach</label>
                    <textarea class="form-control" id="evidenceCatatan" rows="3"></textarea>
                </div>
                @* Kesimpulan dropdown *@
                <div class="mb-3">
                    <label class="form-label">Kesimpulan</label>
                    <select class="form-select" id="evidenceKesimpulan">
                        <option value="">-- Pilih --</option>
                        <option value="Kompeten secara mandiri">Kompeten secara mandiri</option>
                        <option value="Masih perlu dikembangkan">Masih perlu dikembangkan</option>
                    </select>
                </div>
                @* Result dropdown *@
                <div class="mb-3">
                    <label class="form-label">Result</label>
                    <select class="form-select" id="evidenceResult">
                        <option value="">-- Pilih --</option>
                        <option value="Need Improvement">Need Improvement</option>
                        <option value="Suitable">Suitable</option>
                        <option value="Good">Good</option>
                        <option value="Excellence">Excellence</option>
                    </select>
                </div>
                @* File upload *@
                <div class="mb-3">
                    <label class="form-label">File Evidence (opsional, PDF/JPG/PNG, max 10MB)</label>
                    <input type="file" class="form-control" id="evidenceFile" accept=".pdf,.jpg,.jpeg,.png" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-primary" id="btnSubmitEvidence">Submit</button>
            </div>
        </div>
    </div>
</div>

@* Toast container *@
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index:1100">
    <div id="actionToast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="actionToastBody"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

@functions {
    string GetApprovalBadge(string status)
    {
        return status switch
        {
            "Approved" => "<span class=\"badge bg-success\">Approved</span>",
            "Rejected" => "<span class=\"badge bg-danger\">Rejected</span>",
            "Reviewed" => "<span class=\"badge bg-success\">Reviewed</span>",
            "Pending"  => "<span class=\"badge bg-secondary\">Pending</span>",
            _ => "<span class=\"badge bg-light text-dark\">-</span>",
        };
    }

    string GetApprovalBadgeWithTooltip(string status, string approverName, string approvedAt)
    {
        var tooltipText = $"{approverName} — {approvedAt}";
        return status switch
        {
            "Approved" => $"<span class=\"badge bg-success\" data-bs-toggle=\"tooltip\" title=\"{tooltipText}\">Approved</span>",
            "Rejected" => $"<span class=\"badge bg-danger\" data-bs-toggle=\"tooltip\" title=\"{tooltipText}\">Rejected</span>",
            "Reviewed" => $"<span class=\"badge bg-success\" data-bs-toggle=\"tooltip\" title=\"{tooltipText}\">Reviewed</span>",
            "Pending"  => "<span class=\"badge bg-secondary\">Pending</span>",
            _ => "<span class=\"badge bg-light text-dark\">-</span>",
        };
    }

    string GetStatusBadge(string status)
    {
        return status switch
        {
            "Pending"   => "<span class=\"badge bg-secondary\">Pending</span>",
            "Submitted" => "<span class=\"badge bg-primary\">Submitted</span>",
            "Approved"  => "<span class=\"badge bg-success\">Approved</span>",
            "Rejected"  => "<span class=\"badge bg-danger\">Rejected</span>",
            _ => "<span class=\"badge bg-light text-dark\">-</span>",
        };
    }
}

@section Scripts {
@Html.AntiForgeryToken()
<script>
// === Bagian -> Unit cascade ===
const unitsByBagian = {
    "RFCC": ["RFCC LPG Treating Unit (062)", "Propylene Recovery Unit (063)"],
    "DHT / HMU": ["Diesel Hydrotreating Unit I & II (054 & 083)", "Hydrogen Manufacturing Unit (068)", "Common DHT H2 Compressor (085)"],
    "NGP": ["Saturated Gas Concentration Unit (060)", "Saturated LPG Treating Unit (064)", "Isomerization Unit (082)", "Common Facilities For NLP (160)", "Naphtha Hydrotreating Unit II (084)"],
    "GAST": ["RFCC NHT (053)", "Alkylation Unit (065)", "Wet Gas Sulfuric Acid Unit (066)", "SWS RFCC & Non RFCC (067 & 167)", "Amine Regeneration Unit I & II (069 & 079)", "Flare System (319)", "Sulfur Recovery Unit (169)"]
};

function onBagianChange(select) {
    const unitSelect = document.getElementById('unitSelect');
    if (unitSelect) {
        unitSelect.innerHTML = '<option value="">Semua Unit</option>';
        const bagian = select.value;
        if (bagian && unitsByBagian[bagian]) {
            unitsByBagian[bagian].forEach(u => {
                const opt = document.createElement('option');
                opt.value = u;
                opt.textContent = u;
                unitSelect.appendChild(opt);
            });
        }
    }
    select.form.submit();
}

function clearFilters() {
    window.location.href = '@Url.Action("ProtonProgress", "CDP")';
}

// === AJAX helpers ===
function getAntiForgeryToken() {
    const tokenEl = document.querySelector('input[name="__RequestVerificationToken"]');
    return tokenEl ? tokenEl.value : '';
}

function showToast(message, type) {
    const toast = document.getElementById('actionToast');
    const toastBody = document.getElementById('actionToastBody');
    if (!toast || !toastBody) return;
    toastBody.textContent = message;
    toast.className = 'toast align-items-center border-0 text-white';
    toast.classList.add(type === 'success' ? 'bg-success' : 'bg-danger');
    const bsToast = bootstrap.Toast.getOrCreateInstance(toast, { delay: 3500 });
    bsToast.show();
}

// === Tinjau Modal logic ===
const tinjaModal = document.getElementById('tinjaModal');
const modalAction = document.getElementById('modalAction');
const commentGroup = document.getElementById('commentGroup');
const commentRequired = document.getElementById('commentRequired');
const btnSubmitTinja = document.getElementById('btnSubmitTinja');
const modalComment = document.getElementById('modalComment');

if (tinjaModal) {
    tinjaModal.addEventListener('show.bs.modal', function(event) {
        const btn = event.relatedTarget;
        if (!btn) return;
        document.getElementById('modalProgressId').value = btn.dataset.progressId || '';
        document.getElementById('modalRole').value = btn.dataset.role || '';
        document.getElementById('modalKompetensi').textContent = btn.dataset.kompetensi || '';
        document.getElementById('modalSubKompetensi').textContent = btn.dataset.subKompetensi || '';
        document.getElementById('modalDeliverableName').textContent = btn.dataset.deliverable || '';
        const evidenceUrl = btn.dataset.evidenceUrl || '';
        const evidenceLink = document.getElementById('modalEvidenceLink');
        if (evidenceUrl) {
            evidenceLink.href = evidenceUrl;
            evidenceLink.textContent = 'Lihat Evidence';
        } else {
            evidenceLink.href = '#';
            evidenceLink.textContent = 'Tidak ada evidence';
        }
        // Reset action dropdown and comment
        if (modalAction) modalAction.value = '';
        if (commentGroup) commentGroup.classList.add('d-none');
        if (modalComment) modalComment.value = '';
        if (btnSubmitTinja) btnSubmitTinja.disabled = true;
    });
}

if (modalAction) {
    modalAction.addEventListener('change', function() {
        const action = this.value;
        if (action === 'reject') {
            if (commentGroup) commentGroup.classList.remove('d-none');
            if (commentRequired) commentRequired.classList.remove('d-none');
        } else if (action === 'approve') {
            if (commentGroup) commentGroup.classList.remove('d-none');
            if (commentRequired) commentRequired.classList.add('d-none');
        } else {
            if (commentGroup) commentGroup.classList.add('d-none');
        }
        if (btnSubmitTinja) btnSubmitTinja.disabled = !action;
    });
}

if (btnSubmitTinja) {
    btnSubmitTinja.addEventListener('click', async function() {
        const progressId = document.getElementById('modalProgressId').value;
        const role = document.getElementById('modalRole').value;
        const action = modalAction ? modalAction.value : '';
        const comment = modalComment ? modalComment.value.trim() : '';

        if (!action) { showToast('Pilih aksi terlebih dahulu.', 'danger'); return; }
        if (action === 'reject' && !comment) { showToast('Alasan penolakan wajib diisi.', 'danger'); return; }

        const url = action === 'approve'
            ? '/CDP/ApproveFromProgress'
            : '/CDP/RejectFromProgress';

        const formData = new FormData();
        formData.append('progressId', progressId);
        formData.append('__RequestVerificationToken', getAntiForgeryToken());
        if (action === 'approve') {
            formData.append('comment', comment);
        } else {
            formData.append('rejectionReason', comment);
        }

        btnSubmitTinja.disabled = true;
        btnSubmitTinja.textContent = 'Menyimpan...';

        try {
            const resp = await fetch(url, { method: 'POST', body: formData });
            const data = await resp.json();

            // Dismiss modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('tinjaModal'));
            if (modal) modal.hide();

            if (data.success) {
                showToast(data.message, 'success');
                // Update badge in-place
                const colId = role === 'srspv' ? `srspv-${progressId}` : `sh-${progressId}`;
                const cell = document.getElementById(colId);
                if (cell) {
                    const tooltip = `${data.approverName} \u2014 ${data.approvedAt}`;
                    const badgeClass = data.newStatus === 'Approved' ? 'bg-success' : 'bg-danger';
                    cell.innerHTML = `<span class="badge ${badgeClass}" data-bs-toggle="tooltip" title="${tooltip}">${data.newStatus}</span>`;
                    // Re-init tooltip on new badge
                    const newBadge = cell.querySelector('[data-bs-toggle="tooltip"]');
                    if (newBadge) new bootstrap.Tooltip(newBadge);
                }
            } else {
                showToast(data.message || 'Terjadi kesalahan.', 'danger');
            }
        } catch (e) {
            showToast('Terjadi kesalahan jaringan.', 'danger');
        } finally {
            btnSubmitTinja.disabled = false;
            btnSubmitTinja.textContent = 'Submit';
        }
    });
}

// === HC Review buttons ===
document.querySelectorAll('.btnHcReview').forEach(btn => {
    btn.addEventListener('click', async function() {
        const progressId = this.dataset.progressId;
        if (!confirm('Tandai sebagai sudah direview?')) return;

        const formData = new FormData();
        formData.append('progressId', progressId);
        formData.append('__RequestVerificationToken', getAntiForgeryToken());

        this.disabled = true;
        try {
            const resp = await fetch('/CDP/HCReviewFromProgress', { method: 'POST', body: formData });
            const data = await resp.json();
            if (data.success) {
                showToast(data.message, 'success');
                const cell = document.getElementById(`hc-${progressId}`);
                if (cell) {
                    const tooltip = `${data.reviewerName} \u2014 ${data.reviewedAt}`;
                    cell.innerHTML = `<span class="badge bg-success" data-bs-toggle="tooltip" title="${tooltip}">Reviewed</span>`;
                    const newBadge = cell.querySelector('[data-bs-toggle="tooltip"]');
                    if (newBadge) new bootstrap.Tooltip(newBadge);
                }
            } else {
                showToast(data.message || 'Terjadi kesalahan.', 'danger');
                this.disabled = false;
            }
        } catch (e) {
            showToast('Terjadi kesalahan jaringan.', 'danger');
            this.disabled = false;
        }
    });
});

// === Initialize tooltips ===
document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
    new bootstrap.Tooltip(el);
});

// === Client-side search ===
let searchTimer;
const searchInput = document.getElementById('searchInput');
const searchClear = document.getElementById('searchClear');
const searchNoResults = document.getElementById('searchNoResults');
const searchQuerySpan = document.getElementById('searchQuery');

if (searchInput) {
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimer);
        const query = this.value.trim();

        if (searchClear) {
            searchClear.classList.toggle('d-none', !query);
        }

        searchTimer = setTimeout(() => {
            const q = query.toLowerCase();
            const rows = document.querySelectorAll('#progressTableBody tr');
            let visibleCount = 0;

            rows.forEach(row => {
                const kompetensi = (row.dataset.kompetensi || '').toLowerCase();
                const deliverable = (row.dataset.deliverable || '').toLowerCase();
                const match = !q || kompetensi.includes(q) || deliverable.includes(q);
                row.style.display = match ? '' : 'none';
                if (match) visibleCount++;
            });

            if (searchNoResults) {
                if (q && visibleCount === 0) {
                    searchNoResults.classList.remove('d-none');
                    if (searchQuerySpan) searchQuerySpan.textContent = query;
                } else {
                    searchNoResults.classList.add('d-none');
                }
            }
        }, 300);
    });
}

function clearSearch() {
    if (searchInput) {
        searchInput.value = '';
        searchInput.dispatchEvent(new Event('input'));
    }
}

// === Evidence + Coaching Modal (Plan 02) ===

// Build deliverable data from table rows
function buildDeliverableData() {
    const rows = document.querySelectorAll('#progressTableBody tr');
    const items = [];
    rows.forEach(row => {
        const btn = row.querySelector('.btnSubmitEvidence');
        if (btn) {
            items.push({
                progressId: btn.dataset.progressId,
                kompetensi: btn.dataset.kompetensi || '',
                subKompetensi: btn.dataset.subKompetensi || '',
                deliverable: btn.dataset.deliverable || '',
                status: btn.dataset.status || ''
            });
        }
    });
    return items;
}

// Render deliverable selector as nested checkboxes
function renderDeliverableSelector(items, preCheckId) {
    const container = document.getElementById('deliverableSelector');
    if (!container) return;
    container.innerHTML = '';

    // Group by Kompetensi > SubKompetensi > Deliverable
    const grouped = {};
    items.forEach(item => {
        if (!grouped[item.kompetensi]) grouped[item.kompetensi] = {};
        if (!grouped[item.kompetensi][item.subKompetensi]) grouped[item.kompetensi][item.subKompetensi] = [];
        grouped[item.kompetensi][item.subKompetensi].push(item);
    });

    Object.keys(grouped).forEach(komp => {
        const kompDiv = document.createElement('div');
        kompDiv.className = 'mb-1';
        kompDiv.innerHTML = `<strong class="d-block text-primary small">${komp}</strong>`;
        Object.keys(grouped[komp]).forEach(sub => {
            const subDiv = document.createElement('div');
            subDiv.className = 'ms-2 mb-1';
            subDiv.innerHTML = `<em class="d-block text-muted small">${sub}</em>`;
            grouped[komp][sub].forEach(item => {
                const checked = preCheckId && item.progressId == preCheckId ? 'checked' : '';
                const label = document.createElement('label');
                label.className = 'form-check ms-3 small';
                label.innerHTML = `<input type="checkbox" class="form-check-input deliverableCheck" value="${item.progressId}" ${checked}> <span class="form-check-label">${item.deliverable}</span>`;
                subDiv.appendChild(label);
            });
            kompDiv.appendChild(subDiv);
        });
        container.appendChild(kompDiv);
    });
}

// Show modal when Submit Evidence button is clicked
document.querySelectorAll('.btnSubmitEvidence').forEach(btn => {
    btn.addEventListener('click', function() {
        const progressId = this.dataset.progressId;
        const items = buildDeliverableData();
        renderDeliverableSelector(items, progressId);

        // Set today's date
        const today = new Date().toISOString().split('T')[0];
        const dateInput = document.getElementById('evidenceDate');
        if (dateInput) dateInput.value = today;

        // Clear all fields
        const koacheeComp = document.getElementById('evidenceKoacheeComp');
        const catatan = document.getElementById('evidenceCatatan');
        const kesimpulan = document.getElementById('evidenceKesimpulan');
        const resultSel = document.getElementById('evidenceResult');
        const fileInput = document.getElementById('evidenceFile');
        if (koacheeComp) koacheeComp.value = '';
        if (catatan) catatan.value = '';
        if (kesimpulan) kesimpulan.value = '';
        if (resultSel) resultSel.value = '';
        if (fileInput) fileInput.value = '';

        const modal = new bootstrap.Modal(document.getElementById('evidenceModal'));
        modal.show();
    });
});

// Submit handler
const btnSubmitEvidence = document.getElementById('btnSubmitEvidence');
if (btnSubmitEvidence) {
    btnSubmitEvidence.addEventListener('click', async function() {
        const checked = document.querySelectorAll('.deliverableCheck:checked');
        if (checked.length === 0) {
            showToast('Pilih minimal satu deliverable.', 'danger');
            return;
        }

        const kesimpulan = document.getElementById('evidenceKesimpulan').value;
        const result = document.getElementById('evidenceResult').value;
        if (!kesimpulan) { showToast('Kesimpulan wajib dipilih.', 'danger'); return; }
        if (!result) { showToast('Result wajib dipilih.', 'danger'); return; }

        const fileInput = document.getElementById('evidenceFile');
        if (fileInput && fileInput.files[0] && fileInput.files[0].size > 10 * 1024 * 1024) {
            showToast('Ukuran file melebihi 10MB.', 'danger');
            return;
        }

        const selectedIds = Array.from(checked).map(cb => parseInt(cb.value));
        const formData = new FormData();
        formData.append('progressIdsJson', JSON.stringify(selectedIds));
        formData.append('date', document.getElementById('evidenceDate').value);
        formData.append('koacheeCompetencies', document.getElementById('evidenceKoacheeComp').value);
        formData.append('catatanCoach', document.getElementById('evidenceCatatan').value);
        formData.append('kesimpulan', kesimpulan);
        formData.append('result', result);
        if (fileInput && fileInput.files[0]) {
            formData.append('evidenceFile', fileInput.files[0]);
        }

        // DO NOT set Content-Type header — browser sets multipart boundary automatically
        const token = getAntiForgeryToken();

        btnSubmitEvidence.disabled = true;
        btnSubmitEvidence.textContent = 'Menyimpan...';

        try {
            const resp = await fetch('/CDP/SubmitEvidenceWithCoaching', {
                method: 'POST',
                headers: { 'RequestVerificationToken': token },
                body: formData
            });
            const data = await resp.json();

            if (data.success) {
                // Dismiss modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('evidenceModal'));
                if (modal) modal.hide();

                showToast(data.message, 'success');

                // Update each submitted row in-place
                (data.submittedIds || []).forEach(id => {
                    // Update Evidence column
                    const evidenceCell = document.getElementById(`evidence-${id}`);
                    if (evidenceCell) {
                        evidenceCell.innerHTML = data.hasEvidence
                            ? '<span class="badge bg-success">Sudah Upload</span>'
                            : '<span class="badge bg-secondary">Belum Upload</span>';
                    }
                    // Update Status in SrSpv / SH cells — reset to Pending badge
                    const srspvCell = document.getElementById(`srspv-${id}`);
                    if (srspvCell) {
                        srspvCell.innerHTML = '<span class="badge bg-secondary">Pending</span>';
                    }
                    const shCell = document.getElementById(`sh-${id}`);
                    if (shCell) {
                        shCell.innerHTML = '<span class="badge bg-secondary">Pending</span>';
                    }
                });

                // Update stat cards
                updateStatCards();
            } else {
                showToast(data.message || 'Terjadi kesalahan.', 'danger');
            }
        } catch (e) {
            showToast('Terjadi kesalahan jaringan.', 'danger');
        } finally {
            btnSubmitEvidence.disabled = false;
            btnSubmitEvidence.textContent = 'Submit';
        }
    });
}

// Recalculate stat cards from table state
function updateStatCards() {
    const rows = document.querySelectorAll('#progressTableBody tr');
    let total = 0;
    let weightedSum = 0;
    let pendingEvidence = 0;
    let pendingApprovals = 0;

    rows.forEach(row => {
        // Only count rows that have an evidence cell (deliverable rows)
        const evidenceCell = row.querySelector('[id^="evidence-"]');
        if (!evidenceCell) return;
        total++;

        const srspvCell = row.querySelector('[id^="srspv-"]');
        const isApproved = srspvCell && srspvCell.querySelector('.badge.bg-success') !== null;
        const isSubmitted = srspvCell && srspvCell.querySelector('.badge.bg-secondary') !== null && !isApproved;

        if (isApproved) {
            weightedSum += 1.0;
        } else if (isSubmitted) {
            weightedSum += 0.5;
            pendingApprovals++;
        }

        // Pending evidence: if Submit Evidence button still present or no badge
        const submitBtn = evidenceCell.querySelector('.btnSubmitEvidence');
        if (submitBtn) pendingEvidence++;
    });

    const progressPercent = total > 0 ? Math.round(weightedSum / total * 100) : 0;

    // Update stat card display
    const progressEl = document.querySelector('.card .text-primary.mb-0');
    if (progressEl) {
        progressEl.textContent = progressPercent + '%';
        const progressBar = document.querySelector('.progress-bar');
        if (progressBar) progressBar.style.width = progressPercent + '%';
    }

    const pendingActionsEl = document.querySelector('.card .text-warning.mb-0');
    if (pendingActionsEl) pendingActionsEl.textContent = pendingEvidence;

    const pendingApprovalsEl = document.querySelector('.card .text-info.mb-0');
    if (pendingApprovalsEl) pendingApprovalsEl.textContent = pendingApprovals;
}
</script>
}
