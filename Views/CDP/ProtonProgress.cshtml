@model List<HcPortal.Models.TrackingItem>
@{
    ViewData["Title"] = "Proton Progress";
    var userLevel = (int)ViewBag.UserLevel;
    var allBagian = ViewBag.AllBagian as List<string> ?? new List<string>();
    var allUnits = ViewBag.AllUnits as List<string> ?? new List<string>();
    var allTracks = ViewBag.AllTracks as List<string> ?? new List<string>();
    var allTahun = ViewBag.AllTahun as List<string> ?? new List<string>();
    var coachees = ViewBag.Coachees as List<HcPortal.Models.ApplicationUser>;
    var selectedBagian = ViewBag.SelectedBagian as string ?? "";
    var selectedUnit = ViewBag.SelectedUnit as string ?? "";
    var selectedTrackType = ViewBag.SelectedTrackType as string ?? "";
    var selectedTahun = ViewBag.SelectedTahun as string ?? "";
    var selectedCoacheeId = ViewBag.SelectedCoacheeId as string ?? "";
    var progressPercent = (int)ViewBag.ProgressPercent;
    var pendingActions = (int)ViewBag.PendingActions;
    var pendingApprovals = (int)ViewBag.PendingApprovals;
    var showCoacheeColumn = string.IsNullOrEmpty(selectedCoacheeId) && userLevel < 6;

    // Pre-compute groupings for table rendering
    var coacheeGroups = Model
        .GroupBy(x => x.CoacheeName)
        .Select(cg => new {
            CoacheeName = cg.Key,
            RowCount = cg.Count(),
            KompGroups = cg.GroupBy(x => x.Kompetensi)
                .Select(kg => new {
                    Kompetensi = kg.Key,
                    RowCount = kg.Count(),
                    SubGroups = kg.GroupBy(x => x.SubKompetensi)
                        .Select(sg => new {
                            SubKompetensi = sg.Key,
                            RowCount = sg.Count(),
                            Items = sg.ToList()
                        }).ToList()
                }).ToList()
        }).ToList();

    var kompetensiGroups = Model
        .GroupBy(x => x.Kompetensi)
        .Select(g => new {
            Kompetensi = g.Key,
            RowCount = g.Count(),
            SubGroups = g.GroupBy(x => x.SubKompetensi)
                .Select(sg => new {
                    SubKompetensi = sg.Key,
                    RowCount = sg.Count(),
                    Items = sg.ToList()
                }).ToList()
        }).ToList();
}

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="bi bi-graph-up me-2"></i>Proton Progress</h2>
            <p class="text-muted mb-0">Monitor deliverable progress and approval status</p>
        </div>
        <a href="@Url.Action("Index", "CDP")" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>Kembali
        </a>
    </div>

    @* Filter bar — GET form, auto-submits on dropdown change *@
    <form method="get" asp-action="ProtonProgress" asp-controller="CDP" id="filterForm"
          class="d-flex flex-wrap gap-2 align-items-center mb-3">

        @* Bagian dropdown — HC/Admin only (Level 1-2) *@
        @if (userLevel <= 2)
        {
            <select name="bagian" class="form-select form-select-sm" style="width:auto;min-width:150px"
                    onchange="onBagianChange(this)">
                <option value="">Semua Bagian</option>
                @foreach (var b in allBagian)
                {
                    if (b == selectedBagian)
                    {
                        <option value="@b" selected>@b</option>
                    }
                    else
                    {
                        <option value="@b">@b</option>
                    }
                }
            </select>
        }

        @* Unit dropdown — HC/Admin (Level 1-2) and SrSpv/SectionHead (Level 4) *@
        @if (userLevel <= 2 || userLevel == 4)
        {
            <select name="unit" id="unitSelect" class="form-select form-select-sm" style="width:auto;min-width:180px"
                    onchange="this.form.submit()">
                <option value="">Semua Unit</option>
                @foreach (var u in allUnits)
                {
                    if (u == selectedUnit)
                    {
                        <option value="@u" selected>@u</option>
                    }
                    else
                    {
                        <option value="@u">@u</option>
                    }
                }
            </select>
        }

        @* Coachee dropdown — Coach (Level 5) and HC/Admin (Level 1-2) *@
        @if (coachees != null && (userLevel == 5 || userLevel <= 2))
        {
            <select name="coacheeId" class="form-select form-select-sm" style="width:auto;min-width:180px"
                    onchange="this.form.submit()">
                <option value="">Semua Coachee</option>
                @foreach (var c in coachees)
                {
                    if (c.Id == selectedCoacheeId)
                    {
                        <option value="@c.Id" selected>@c.FullName</option>
                    }
                    else
                    {
                        <option value="@c.Id">@c.FullName</option>
                    }
                }
            </select>
        }

        @* Track dropdown — all roles except Coachee (Level 6) *@
        @if (userLevel < 6)
        {
            <select name="trackType" class="form-select form-select-sm" style="width:auto;min-width:140px"
                    onchange="this.form.submit()">
                <option value="">Semua Track</option>
                @foreach (var t in allTracks)
                {
                    if (t == selectedTrackType)
                    {
                        <option value="@t" selected>@t</option>
                    }
                    else
                    {
                        <option value="@t">@t</option>
                    }
                }
            </select>
        }

        @* Tahun dropdown — all roles except Coachee (Level 6) *@
        @if (userLevel < 6)
        {
            <select name="tahun" class="form-select form-select-sm" style="width:auto;min-width:130px"
                    onchange="this.form.submit()">
                <option value="">Semua Tahun</option>
                @foreach (var th in allTahun)
                {
                    if (th == selectedTahun)
                    {
                        <option value="@th" selected>@th</option>
                    }
                    else
                    {
                        <option value="@th">@th</option>
                    }
                }
            </select>
        }

        @* Search box — client-side only, NOT a form field (no name attribute) *@
        @if (userLevel < 6)
        {
            <div class="position-relative" style="min-width:200px">
                <span class="position-absolute top-50 start-0 translate-middle-y ps-2 text-muted">
                    <i class="bi bi-search"></i>
                </span>
                <input type="text" id="searchInput" class="form-control form-control-sm ps-4"
                       placeholder="Cari kompetensi..." autocomplete="off">
                <button type="button" id="searchClear"
                        class="btn btn-sm position-absolute top-50 end-0 translate-middle-y d-none"
                        style="border:none;background:none;color:#6c757d"
                        onclick="clearSearch()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        }

        @* Reset button *@
        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">
            <i class="bi bi-arrow-counterclockwise"></i> Reset
        </button>
    </form>

    @* Result count *@
    <small class="text-muted mb-2 d-block">Menampilkan @ViewBag.FilteredCount dari @ViewBag.TotalCount data</small>

    @* Summary stat cards *@
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <h6 class="text-muted mb-1">Progress</h6>
                    <h3 class="mb-0 text-primary">@progressPercent%</h3>
                    <div class="progress mt-2" style="height: 6px;">
                        <div class="progress-bar" role="progressbar" style="width: @progressPercent%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <h6 class="text-muted mb-1">Pending Actions</h6>
                    <h3 class="mb-0 text-warning">@pendingActions</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <h6 class="text-muted mb-1">Pending Approvals</h6>
                    <h3 class="mb-0 text-info">@pendingApprovals</h3>
                </div>
            </div>
        </div>
    </div>

    @* Coachee info — when single coachee selected *@
    @if (!string.IsNullOrEmpty(ViewBag.SelectedCoacheeId as string))
    {
        <div class="card mb-3">
            <div class="card-body py-2">
                <strong>@ViewBag.CoacheeName</strong>
                @if (!string.IsNullOrEmpty(ViewBag.TrackLabel as string))
                {
                    <span class="badge bg-primary ms-2">@ViewBag.TrackLabel</span>
                }
            </div>
        </div>
    }

    @* Coachee info for Level 6 — own data *@
    @if (userLevel == 6)
    {
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="mb-1">@ViewBag.UserFullName</h5>
                @if (!string.IsNullOrEmpty(ViewBag.TrackLabel as string))
                {
                    <span class="badge bg-info">@ViewBag.TrackLabel</span>
                }
            </div>
        </div>
    }

    @* Empty state — no data matching current filters *@
    @if (Model.Count == 0 && !string.IsNullOrEmpty(ViewBag.EmptyMessage as string))
    {
        <div class="alert alert-info">@ViewBag.EmptyMessage</div>
    }

    @* Search no-results message (hidden by default, shown by JS) *@
    <div id="searchNoResults" class="alert alert-warning d-none">
        Tidak ditemukan kompetensi untuk '<span id="searchQuery"></span>'
    </div>

    @* Deliverable table *@
    @if (Model.Count > 0)
    {
        <div class="table-responsive">
            <table class="table table-bordered table-hover" id="progressTable">
                <thead class="table-light">
                    <tr>
                        @if (showCoacheeColumn)
                        {
                            <th>Coachee</th>
                        }
                        <th>Kompetensi</th>
                        <th>Sub Kompetensi</th>
                        <th>Deliverable</th>
                        <th>Evidence</th>
                        <th>Approval Sr. Spv</th>
                        <th>Approval Section Head</th>
                        <th>Approval HC</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="progressTableBody">
                    @if (showCoacheeColumn)
                    {
                        @* Multi-coachee view: group by CoacheeName, then Kompetensi, then SubKompetensi *@
                        @foreach (var coacheeGroup in coacheeGroups)
                        {
                            bool firstCoacheeRow = true;
                            foreach (var kompGroup in coacheeGroup.KompGroups)
                            {
                                bool firstKomp = true;
                                foreach (var subGroup in kompGroup.SubGroups)
                                {
                                    bool firstSub = true;
                                    foreach (var item in subGroup.Items)
                                    {
                                        <tr data-kompetensi="@item.Kompetensi" data-deliverable="@item.Deliverable">
                                            @if (firstCoacheeRow)
                                            {
                                                <td rowspan="@coacheeGroup.RowCount" class="align-middle fw-bold">@coacheeGroup.CoacheeName</td>
                                                firstCoacheeRow = false;
                                            }
                                            @if (firstKomp)
                                            {
                                                <td rowspan="@kompGroup.RowCount" class="align-middle fw-bold">@kompGroup.Kompetensi</td>
                                                firstKomp = false;
                                            }
                                            @if (firstSub)
                                            {
                                                <td rowspan="@subGroup.RowCount" class="align-middle">@subGroup.SubKompetensi</td>
                                                firstSub = false;
                                            }
                                            <td>@item.Deliverable</td>
                                            <td class="text-center">
                                                @if (item.EvidenceStatus == "Uploaded")
                                                {
                                                    <span class="badge bg-success">Uploaded</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary">Pending</span>
                                                }
                                            </td>
                                            <td class="text-center">@Html.Raw(GetApprovalBadge(item.ApprovalSrSpv))</td>
                                            <td class="text-center">@Html.Raw(GetApprovalBadge(item.ApprovalSectionHead))</td>
                                            <td class="text-center">@Html.Raw(GetApprovalBadge(item.ApprovalHC))</td>
                                            <td class="text-center">
                                                <div class="dropdown">
                                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                        <i class="bi bi-three-dots-vertical"></i>
                                                    </button>
                                                    <ul class="dropdown-menu">
                                                        <li><a class="dropdown-item" href="@Url.Action("Deliverable", "CDP", new { id = item.Id })"><i class="bi bi-eye me-1"></i>Lihat Detail</a></li>
                                                    </ul>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                }
                            }
                        }
                    }
                    else
                    {
                        @* Single-coachee view: group by Kompetensi, then SubKompetensi *@
                        @foreach (var kompGroup in kompetensiGroups)
                        {
                            bool firstKomp = true;
                            foreach (var subGroup in kompGroup.SubGroups)
                            {
                                bool firstSub = true;
                                foreach (var item in subGroup.Items)
                                {
                                    <tr data-kompetensi="@item.Kompetensi" data-deliverable="@item.Deliverable">
                                        @if (firstKomp)
                                        {
                                            <td rowspan="@kompGroup.RowCount" class="align-middle fw-bold">@kompGroup.Kompetensi</td>
                                            firstKomp = false;
                                        }
                                        @if (firstSub)
                                        {
                                            <td rowspan="@subGroup.RowCount" class="align-middle">@subGroup.SubKompetensi</td>
                                            firstSub = false;
                                        }
                                        <td>@item.Deliverable</td>
                                        <td class="text-center">
                                            @if (item.EvidenceStatus == "Uploaded")
                                            {
                                                <span class="badge bg-success">Uploaded</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">Pending</span>
                                            }
                                        </td>
                                        <td class="text-center">@Html.Raw(GetApprovalBadge(item.ApprovalSrSpv))</td>
                                        <td class="text-center">@Html.Raw(GetApprovalBadge(item.ApprovalSectionHead))</td>
                                        <td class="text-center">@Html.Raw(GetApprovalBadge(item.ApprovalHC))</td>
                                        <td class="text-center">
                                            <div class="dropdown">
                                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                    <i class="bi bi-three-dots-vertical"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><a class="dropdown-item" href="@Url.Action("Deliverable", "CDP", new { id = item.Id })"><i class="bi bi-eye me-1"></i>Lihat Detail</a></li>
                                                </ul>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            }
                        }
                    }
                </tbody>
            </table>
        </div>
    }

</div> @* end container-fluid *@

@functions {
    string GetApprovalBadge(string status)
    {
        return status switch
        {
            "Approved" => "<span class=\"badge bg-success\">Approved</span>",
            "Rejected" => "<span class=\"badge bg-danger\">Rejected</span>",
            "Pending" => "<span class=\"badge bg-warning text-dark\">Pending</span>",
            _ => "<span class=\"badge bg-secondary\">Not Started</span>",
        };
    }
}

@section Scripts {
<script>
// === Bagian -> Unit cascade ===
const unitsByBagian = {
    "RFCC": ["RFCC LPG Treating Unit (062)", "Propylene Recovery Unit (063)"],
    "DHT / HMU": ["Diesel Hydrotreating Unit I & II (054 & 083)", "Hydrogen Manufacturing Unit (068)", "Common DHT H2 Compressor (085)"],
    "NGP": ["Saturated Gas Concentration Unit (060)", "Saturated LPG Treating Unit (064)", "Isomerization Unit (082)", "Common Facilities For NLP (160)", "Naphtha Hydrotreating Unit II (084)"],
    "GAST": ["RFCC NHT (053)", "Alkylation Unit (065)", "Wet Gas Sulfuric Acid Unit (066)", "SWS RFCC & Non RFCC (067 & 167)", "Amine Regeneration Unit I & II (069 & 079)", "Flare System (319)", "Sulfur Recovery Unit (169)"]
};

function onBagianChange(select) {
    const unitSelect = document.getElementById('unitSelect');
    if (unitSelect) {
        // Clear unit selection to prevent stale cascade
        unitSelect.innerHTML = '<option value="">Semua Unit</option>';
        const bagian = select.value;
        if (bagian && unitsByBagian[bagian]) {
            unitsByBagian[bagian].forEach(u => {
                const opt = document.createElement('option');
                opt.value = u;
                opt.textContent = u;
                unitSelect.appendChild(opt);
            });
        }
    }
    select.form.submit();
}

// === Reset all filters ===
function clearFilters() {
    // Navigate to ProtonProgress with no params
    window.location.href = '@Url.Action("ProtonProgress", "CDP")';
}

// === Client-side search ===
let searchTimer;
const searchInput = document.getElementById('searchInput');
const searchClear = document.getElementById('searchClear');
const searchNoResults = document.getElementById('searchNoResults');
const searchQuerySpan = document.getElementById('searchQuery');

if (searchInput) {
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimer);
        const query = this.value.trim();

        // Toggle clear button visibility
        if (searchClear) {
            searchClear.classList.toggle('d-none', !query);
        }

        searchTimer = setTimeout(() => {
            const q = query.toLowerCase();
            const rows = document.querySelectorAll('#progressTableBody tr');
            let visibleCount = 0;

            rows.forEach(row => {
                const kompetensi = (row.dataset.kompetensi || '').toLowerCase();
                const deliverable = (row.dataset.deliverable || '').toLowerCase();
                const match = !q || kompetensi.includes(q) || deliverable.includes(q);
                row.style.display = match ? '' : 'none';
                if (match) visibleCount++;
            });

            // Show/hide no-results message
            if (searchNoResults) {
                if (q && visibleCount === 0) {
                    searchNoResults.classList.remove('d-none');
                    if (searchQuerySpan) searchQuerySpan.textContent = query;
                } else {
                    searchNoResults.classList.add('d-none');
                }
            }
        }, 300);
    });
}

function clearSearch() {
    if (searchInput) {
        searchInput.value = '';
        searchInput.dispatchEvent(new Event('input'));
    }
}
</script>
}
