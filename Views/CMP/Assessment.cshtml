@model List<HcPortal.Models.AssessmentSession>

@{
    ViewData["Title"] = "Assessment Center";
    // Categories for the dropdown
    var categories = new List<string> { "All", "OJT", "IHT", "Training Licencor", "OTS", "Mandatory HSSE Training", "Proton" };
}

<div class="container-fluid px-4 py-4">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-1">My Assessments</h2>
            <p class="text-muted mb-0">Track and manage your competency assessments</p>
        </div>
        
        <!-- Filter Dropdown -->
        <div class="d-flex align-items-center">
            <label class="me-2 fw-bold text-muted small">Filter by:</label>
            <select id="categoryFilter" class="form-select border-0 shadow-sm fw-bold" style="width: 250px; cursor: pointer;">
                @foreach (var cat in categories)
                {
                    <option value="@cat">@cat</option>
                }
            </select>
        </div>
    </div>

    <!-- Assessment Grid -->
    <div class="row g-4" id="assessmentGrid">
        @foreach (var item in Model)
        {
            <div class="col-12 col-md-6 col-lg-4 assessment-card-item" data-category="@item.Category">
                <div class="card h-100 border-0 shadow-sm hover-elevate">
                    <!-- Card Header / Banner -->
                    <div class="card-header border-0 @item.BannerColor text-white py-4 position-relative" style="min-height: 100px;">
                        <!-- Geometric Pattern Overlay (Optional CSS) -->
                        <div class="position-absolute top-0 start-0 w-100 h-100 opacity-25" 
                             style="background-image: radial-gradient(circle, rgba(255,255,255,0.2) 2px, transparent 2px); background-size: 20px 20px;"></div>
                        
                        <div class="position-relative z-index-1">
                            <span class="badge bg-white bg-opacity-25 backdrop-blur mb-2">@item.Category</span>
                            <h5 class="card-title fw-bold mb-0 text-truncate-2">@item.Title</h5>
                        </div>
                    </div>

                    <div class="card-body d-flex flex-column pt-3">
                        <div class="mb-auto">
                            <p class="card-text text-muted small mb-2">
                                <i class="bi bi-calendar3 me-1"></i> @item.Schedule.ToString("dd MMM yyyy") 
                                <span class="mx-1">•</span>
                                <i class="bi bi-clock me-1"></i> @item.DurationMinutes min
                            </p>
                            
                            @if(item.Status == "Completed")
                            {
                                <div class="d-flex align-items-center mb-3">
                                    <div class="flex-grow-1 me-3">
                                        <div class="progress" style="height: 6px;">
                                            <div class="progress-bar bg-success" role="progressbar" style="width: 100%"></div>
                                        </div>
                                    </div>
                                    <span class="badge bg-success rounded-pill">Completed</span>
                                </div>
                            }
                            else
                            {
                                <div class="d-flex align-items-center mb-3">
                                    <div class="flex-grow-1 me-3">
                                        <div class="progress" style="height: 6px;">
                                            <div class="progress-bar @item.BannerColor.Replace("bg-", "bg-")" role="progressbar" style="width: @item.Progress%"></div>
                                        </div>
                                    </div>
                                    <span class="small text-muted fw-bold">@item.Progress%</span>
                                </div>
                            }
                        </div>

                        <div class="mt-3">
                            @if (item.Status == "Open")
                            {
                                if (item.IsTokenRequired)
                                {
                                    <button class="btn btn-primary w-100 fw-bold" onclick="openTokenModal('@item.Title', '@item.Category')">
                                        <i class="bi bi-shield-lock me-2"></i> Start Assessment
                                    </button>
                                }
                                else
                                {
                                    <button class="btn btn-primary w-100 fw-bold" onclick="startStandardAssessment('@item.Title')">
                                        Start Assessment
                                    </button>
                                }
                            }
                            else if (item.Status == "Upcoming")
                            {
                                <button class="btn btn-light text-muted w-100 border" disabled>
                                    <i class="bi bi-lock me-1"></i> Locked
                                </button>
                            }
                            else // Completed
                            {
                                <button class="btn btn-outline-secondary w-100">
                                    View Certificate
                                </button>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
    
    <!-- Empty State -->
    <div id="emptyState" class="text-center py-5 d-none">
        <div class="mb-3">
            <i class="bi bi-journal-x text-muted" style="font-size: 3rem;"></i>
        </div>
        <h5 class="text-muted">No assessments found in this category.</h5>
    </div>
    
    <!-- Assessment History Section -->
    <div class="mt-5 pt-4 border-top">
        <h5 class="fw-bold mb-3"><i class="bi bi-clock-history"></i> Assessment History</h5>
        <div class="card shadow-sm border-0">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="p-3">Title</th>
                                <th class="p-3">Category</th>
                                <th class="p-3">Completion Date</th>
                                <th class="p-3 text-center">Score</th>
                                <th class="p-3 text-end">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                var historyItems = Model.Where(x => x.Status == "Completed").ToList();
                            }
                            
                            @if (historyItems.Count == 0)
                            {
                                <tr><td colspan="5" class="text-center p-4 text-muted">No completed assessments found.</td></tr>
                            }

                            @foreach (var item in historyItems)
                            {
                                <tr>
                                    <td class="p-3 fw-bold">@item.Title</td>
                                    <td class="p-3"><span class="badge bg-light text-dark border">@item.Category</span></td>
                                    <td class="p-3">@item.Schedule.ToString("dd MMM yyyy")</td>
                                    <td class="p-3 text-center">
                                        @if(item.Score >= 80) {
                                            <span class="badge bg-success fs-6 rounded-pill px-3">@item.Score</span>
                                        } else {
                                            <span class="badge bg-warning text-dark fs-6 rounded-pill px-3">@item.Score</span>
                                        }
                                    </td>
                                    <td class="p-3 text-end">
                                        <button class="btn btn-sm btn-outline-dark">View Detail</button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<!-- Token Verification Modal -->
<div class="modal fade" id="tokenModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold"><i class="bi bi-shield-lock me-2"></i>Security Check</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center py-4">
                <i class="bi bi-usb-symbol text-primary mb-3" style="font-size: 3rem;"></i>
                <h5 class="fw-bold" id="tokenModalTitle">Verification Required</h5>
                <p class="text-muted mb-4">
                    This assessment requires a security token.<br/>
                    Please enter the 6-digit token provided by your <br/><b>HC or Assessment Supervisor</b>.
                </p>
                
                <div class="alert alert-warning small d-none" id="protonWarning">
                    <i class="bi bi-exclamation-triangle-fill me-1"></i> 
                    <b>PROTON Restricted:</b> This assessment can ONLY be accessed from the <b>NSO Room</b>.
                </div>

                <input type="text" id="tokenInput" class="form-control form-control-lg text-center fw-bold fs-2 mb-4 text-primary" 
                       placeholder="• • • • • •" maxlength="6" style="letter-spacing: 0.5em; max-width: 300px; margin: 0 auto;">
                
            </div>
            <div class="modal-footer bg-light justify-content-center">
                <button type="button" class="btn btn-link text-decoration-none text-muted me-3" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary px-5 fw-bold shadow-sm" onclick="verifyToken()">
                    Verify & Launch <i class="bi bi-arrow-right ms-2"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const filter = document.getElementById('categoryFilter');
        const grid = document.getElementById('assessmentGrid');
        const cards = document.querySelectorAll('.assessment-card-item');
        const emptyState = document.getElementById('emptyState');

        // Initial Filter Logic (in case of params)
        filter.addEventListener('change', function() {
            const selected = this.value;
            let visibleCount = 0;

            cards.forEach(card => {
                const category = card.getAttribute('data-category');
                if (selected === "All" || category === selected) {
                    card.classList.remove('d-none');
                    visibleCount++;
                } else {
                    card.classList.add('d-none');
                }
            });

            // Show empty state if no items visible
            if (visibleCount === 0) {
                emptyState.classList.remove('d-none');
            } else {
                emptyState.classList.add('d-none');
            }
        });
    });

    var tokenModalObj;
    
    function openTokenModal(title, category) {
        // Initialize modal if not already done
        var modalEl = document.getElementById('tokenModal');
        tokenModalObj = new bootstrap.Modal(modalEl);
        
        // Custom UI based on Category
        document.getElementById('tokenModalTitle').innerText = title;
        document.getElementById('tokenInput').value = ""; // Clear input
        
        // Show NSO Warning only for Proton
        var protonAlert = document.getElementById('protonWarning');
        if (category === "Proton") {
            protonAlert.classList.remove('d-none');
        } else {
            protonAlert.classList.add('d-none');
        }

        tokenModalObj.show();
    }

    function verifyToken() {
        var token = document.getElementById('tokenInput').value;
        if (token.length === 6) {
            tokenModalObj.hide();
            // In real app, AJAX post to verify
            alert("Token Verified! Launching Assessment Environment...");
        } else {
            alert("Please enter a valid 6-digit token.");
        }
    }
    
    function startStandardAssessment(title) {
        if(confirm("Start " + title + " now?")) {
             alert("Assessment Started!");
        }
    }
</script>

<style>
    .hover-elevate {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .hover-elevate:hover {
        transform: translateY(-5px);
        box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
    }
    .text-truncate-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .backdrop-blur {
        backdrop-filter: blur(5px);
    }
    
    /* Custom Card Colors */
    .bg-purple {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    }
    .assessment-card-item[data-category="Proton"] .card-header .badge {
        color: #764ba2 !important; /* Make badge text purple */
    }
</style>