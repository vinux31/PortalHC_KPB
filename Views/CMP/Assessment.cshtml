@model List<HcPortal.Models.AssessmentSession>

@{
    ViewData["Title"] = "My Assessments";
    
    // Calculate summary statistics
    var totalAssessments = Model.Count;
    var openAssessments = Model.Count(x => x.Status == "Open");
    var completedAssessments = Model.Count(x => x.Status == "Completed");
    var upcomingAssessments = Model.Count(x => x.Status == "Upcoming");
    
    // Categories for filter
    var categories = new List<string> { "All", "OJT", "IHT", "Training Licencor", "OTS", "Mandatory HSSE Training", "Proton" };
}

<div class="container-fluid px-4 py-4">
    
    <!-- Header Section -->
    <div class="mb-4">
        <h2 class="fw-bold mb-1">My Assessments</h2>
        <p class="text-muted mb-0">Track and manage your competency assessments</p>
    </div>

    <!-- Summary Statistics Cards -->
    <div class="row g-3 mb-4">
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100 stat-card stat-card-primary">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon bg-primary bg-opacity-10 text-primary rounded-3 p-3 me-3">
                            <i class="bi bi-clipboard-check fs-3"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1 small">Total Assessments</h6>
                            <h3 class="fw-bold mb-0">@totalAssessments</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100 stat-card stat-card-success">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon bg-success bg-opacity-10 text-success rounded-3 p-3 me-3">
                            <i class="bi bi-play-circle-fill fs-3"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1 small">Open</h6>
                            <h3 class="fw-bold mb-0">@openAssessments</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100 stat-card stat-card-info">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon bg-info bg-opacity-10 text-info rounded-3 p-3 me-3">
                            <i class="bi bi-check-circle-fill fs-3"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1 small">Completed</h6>
                            <h3 class="fw-bold mb-0">@completedAssessments</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100 stat-card stat-card-warning">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon bg-warning bg-opacity-10 text-warning rounded-3 p-3 me-3">
                            <i class="bi bi-lock-fill fs-3"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1 small">Upcoming</h6>
                            <h3 class="fw-bold mb-0">@upcomingAssessments</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search & Filter Bar -->
    <div class="card border-0 shadow-sm mb-3">
        <div class="card-body">
            <div class="row g-3 align-items-center">
                <div class="col-12 col-md-5">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0">
                            <i class="bi bi-search text-muted"></i>
                        </span>
                        <input type="text" id="searchInput" class="form-control border-start-0 ps-0" placeholder="Search assessments by title...">
                    </div>
                </div>
                <div class="col-12 col-md-3">
                    <select id="categoryFilter" class="form-select">
                        <option value="">All Categories</option>
                        @foreach (var cat in categories.Skip(1))
                        {
                            <option value="@cat">@cat</option>
                        }
                    </select>
                </div>
                <div class="col-12 col-md-2">
                    <select id="statusFilter" class="form-select">
                        <option value="">All Status</option>
                        <option value="Open">Open</option>
                        <option value="Upcoming">Upcoming</option>
                        <option value="Completed">Completed</option>
                    </select>
                </div>
                <div class="col-12 col-md-2">
                    <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                        <i class="bi bi-x-circle me-1"></i> Clear
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Assessments Table -->
    <div class="card shadow-sm border-0 table-card mb-4">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0 assessments-table">
                    <thead class="sticky-header">
                        <tr>
                            <th class="p-3">Assessment Title</th>
                            <th class="p-3">Category</th>
                            <th class="p-3">Schedule</th>
                            <th class="p-3">Status</th>
                            <th class="p-3 text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if(Model.Count == 0) 
                        {
                            <tr>
                                <td colspan="5" class="text-center p-5">
                                    <div class="empty-state">
                                        <i class="bi bi-inbox text-muted mb-3" style="font-size: 3rem;"></i>
                                        <h5 class="text-muted">No assessments found</h5>
                                        <p class="text-muted small">Your assessments will appear here.</p>
                                    </div>
                                </td>
                            </tr>
                        }
                        
                        @foreach (var item in Model)
                        {
                            var daysUntil = (item.Schedule - DateTime.Now).Days;
                            
                            <tr class="assessment-row" data-title="@item.Title" data-category="@item.Category" data-status="@item.Status">
                                <td class="p-3">
                                    <div class="d-flex align-items-center">
                                        @if (item.IsTokenRequired)
                                        {
                                            <i class="bi bi-shield-lock text-primary me-2" title="Token Required"></i>
                                        }
                                        <div>
                                            <div class="fw-bold">@item.Title</div>
                                            @if (item.Status == "Upcoming" && daysUntil > 0)
                                            {
                                                <small class="text-muted">
                                                    <i class="bi bi-calendar-event me-1"></i>
                                                    Opens in @daysUntil day@(daysUntil != 1 ? "s" : "")
                                                </small>
                                            }
                                        </div>
                                    </div>
                                </td>
                                <td class="p-3">
                                    @{
                                        var badgeClass = item.Category switch
                                        {
                                            "OJT" => "bg-primary",
                                            "IHT" => "bg-success",
                                            "Training Licencor" => "bg-danger",
                                            "OTS" => "bg-warning text-dark",
                                            "Mandatory HSSE Training" => "bg-info",
                                            "Proton" => "bg-purple text-white",
                                            _ => "bg-secondary"
                                        };
                                    }
                                    <span class="badge @badgeClass">@item.Category</span>
                                </td>
                                <td class="p-3">
                                    <div>
                                        <i class="bi bi-calendar3 text-muted me-1"></i>
                                        <span>@item.Schedule.ToString("dd MMM yyyy")</span>
                                    </div>
                                </td>

                                <td class="p-3">
                                    @if(item.Status == "Open") 
                                    {
                                        <span class="badge bg-success px-3 py-2">
                                            <i class="bi bi-play-circle-fill me-1"></i>Open
                                        </span>
                                    } 
                                    else if(item.Status == "Upcoming")
                                    {
                                        <span class="badge bg-warning text-dark px-3 py-2">
                                            <i class="bi bi-lock-fill me-1"></i>Upcoming
                                        </span>
                                    }
                                    else if(item.Status == "Completed")
                                    {
                                        @if (item.Score.HasValue)
                                        {
                                            var scoreClass = item.Score >= 80 ? "bg-success" : "bg-warning text-dark";
                                            <span class="badge @scoreClass px-3 py-2">
                                                <i class="bi bi-check-circle-fill me-1"></i>Completed • Score: @item.Score
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-info px-3 py-2">
                                                <i class="bi bi-check-circle-fill me-1"></i>Completed
                                            </span>
                                        }
                                    }
                                </td>

                                <td class="p-3 text-center">
                                    @if (item.Status == "Open")
                                    {
                                        if (item.IsTokenRequired)
                                        {
                                            <button class="btn btn-sm btn-primary px-3" onclick="openTokenModal('@item.Title', '@item.Category')">
                                                <i class="bi bi-shield-lock me-1"></i>Start
                                            </button>
                                        }
                                        else
                                        {
                                            <button class="btn btn-sm btn-primary px-3" onclick="startStandardAssessment('@item.Title')">
                                                <i class="bi bi-play-fill me-1"></i>Start
                                            </button>
                                        }
                                    }
                                    else if (item.Status == "Upcoming")
                                    {
                                        <button class="btn btn-sm btn-outline-secondary" disabled>
                                            <i class="bi bi-lock-fill me-1"></i>Locked
                                        </button>
                                    }
                                    else if (item.Status == "Completed")
                                    {
                                        <button class="btn btn-sm btn-outline-info px-3" onclick="viewCertificate('@item.Title')">
                                            <i class="bi bi-file-earmark-text me-1"></i>View
                                        </button>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<!-- Token Verification Modal -->
<div class="modal fade" id="tokenModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold"><i class="bi bi-shield-lock me-2"></i>Security Check</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center py-4">
                <i class="bi bi-usb-symbol text-primary mb-3" style="font-size: 3rem;"></i>
                <h5 class="fw-bold" id="tokenModalTitle">Verification Required</h5>
                <p class="text-muted mb-4">
                    This assessment requires a security token.<br/>
                    Please enter the 6-digit token provided by your <br/><b>HC or Assessment Supervisor</b>.
                </p>
                
                <div class="alert alert-warning small d-none" id="protonWarning">
                    <i class="bi bi-exclamation-triangle-fill me-1"></i> 
                    <b>PROTON Restricted:</b> This assessment can ONLY be accessed from the <b>NSO Room</b>.
                </div>

                <input type="text" id="tokenInput" class="form-control form-control-lg text-center fw-bold fs-2 mb-4 text-primary" 
                       placeholder="• • • • • •" maxlength="6" style="letter-spacing: 0.5em; max-width: 300px; margin: 0 auto;">
                
            </div>
            <div class="modal-footer bg-light justify-content-center">
                <button type="button" class="btn btn-link text-decoration-none text-muted me-3" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary px-5 fw-bold shadow-sm" onclick="verifyToken()">
                    Verify & Launch <i class="bi bi-arrow-right ms-2"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Stat Cards */
.stat-card {
    transition: all 0.3s ease;
    overflow: hidden;
    position: relative;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, transparent, currentColor, transparent);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1) !important;
}

.stat-card:hover::before {
    opacity: 1;
}

.stat-card-primary::before { color: #0d6efd; }
.stat-card-success::before { color: #198754; }
.stat-card-info::before { color: #0dcaf0; }
.stat-card-warning::before { color: #ffc107; }

.stat-icon {
    transition: transform 0.3s ease;
}

.stat-card:hover .stat-icon {
    transform: scale(1.1) rotate(5deg);
}

/* Enhanced Table */
.table-card {
    overflow: hidden;
}

.assessments-table {
    margin-bottom: 0;
}

.assessments-table thead {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

.sticky-header {
    position: sticky;
    top: 0;
    z-index: 10;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.assessments-table tbody tr {
    transition: all 0.2s ease;
}

.assessments-table tbody tr:hover {
    background-color: #f8f9ff;
    transform: scale(1.005);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
}

/* Purple badge for Proton */
.bg-purple {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
}

/* Empty State */
.empty-state {
    padding: 2rem;
}

/* Smooth Animations */
.assessment-row {
    animation: fadeIn 0.3s ease;
}

@@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Responsive */
@@media (max-width: 768px) {
    .assessments-table {
        font-size: 0.875rem;
    }
    
    .assessments-table th,
    .assessments-table td {
        padding: 0.5rem !important;
    }
}
</style>

<script>
// Search functionality
document.getElementById('searchInput')?.addEventListener('input', function(e) {
    filterTable();
});

// Category filter
document.getElementById('categoryFilter')?.addEventListener('change', function() {
    filterTable();
});

// Status filter
document.getElementById('statusFilter')?.addEventListener('change', function() {
    filterTable();
});

// Filter table function
function filterTable() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const categoryFilter = document.getElementById('categoryFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    
    const rows = document.querySelectorAll('.assessment-row');
    
    rows.forEach(row => {
        const title = row.getAttribute('data-title').toLowerCase();
        const category = row.getAttribute('data-category');
        const status = row.getAttribute('data-status');
        
        const matchesSearch = title.includes(searchTerm);
        const matchesCategory = !categoryFilter || category === categoryFilter;
        const matchesStatus = !statusFilter || status === statusFilter;
        
        if (matchesSearch && matchesCategory && matchesStatus) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// Clear filters
function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('categoryFilter').value = '';
    document.getElementById('statusFilter').value = '';
    filterTable();
}

// Token modal
var tokenModalObj;

function openTokenModal(title, category) {
    var modalEl = document.getElementById('tokenModal');
    tokenModalObj = new bootstrap.Modal(modalEl);
    
    document.getElementById('tokenModalTitle').innerText = title;
    document.getElementById('tokenInput').value = '';
    
    var protonAlert = document.getElementById('protonWarning');
    if (category === "Proton") {
        protonAlert.classList.remove('d-none');
    } else {
        protonAlert.classList.add('d-none');
    }

    tokenModalObj.show();
}

function verifyToken() {
    var token = document.getElementById('tokenInput').value;
    if (token.length === 6) {
        tokenModalObj.hide();
        alert("Token Verified! Launching Assessment Environment...");
    } else {
        alert("Please enter a valid 6-digit token.");
    }
}

function startStandardAssessment(title) {
    if(confirm("Start " + title + " now?")) {
         alert("Assessment Started!");
    }
}

function viewCertificate(title) {
    alert("Viewing certificate for: " + title);
}
</script>