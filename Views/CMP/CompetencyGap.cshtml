@model HcPortal.Models.Competency.CompetencyGapViewModel
@{
    ViewData["Title"] = "Competency Gap Analysis";
}

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-0">
                <i class="bi bi-bar-chart-steps me-2"></i>Competency Gap Analysis
            </h2>
            <p class="text-muted mb-0">View competency levels vs position targets</p>
        </div>
    </div>

    <!-- HC/Admin User Selector -->
    @if (ViewBag.IsHcOrAdmin)
    {
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <label for="userSelect" class="form-label fw-bold">Select User to View</label>
                <select id="userSelect" class="form-select" onchange="window.location.href='/CMP/CompetencyGap?userId=' + this.value">
                    <option value="">-- Select a user --</option>
                    @foreach (var user in ViewBag.AllUsers)
                    {
                        <option value="@user.Id" selected="@(user.Id == ViewBag.SelectedUserId)">
                            @user.FullName (@user.Position ?? "No Position") - @user.Section
                        </option>
                    }
                </select>
            </div>
        </div>
    }

    <!-- User Info Card -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <h5 class="card-title mb-3">User Information</h5>
            <div class="row">
                <div class="col-md-4">
                    <strong>Name:</strong> @Model.UserName
                </div>
                <div class="col-md-4">
                    <strong>Position:</strong> @(Model.Position ?? "Not Set")
                </div>
                <div class="col-md-4">
                    <strong>Section:</strong> @(Model.Section ?? "Not Set")
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Statistics -->
    <div class="row g-3 mb-4">
        <div class="col-12 col-md-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <h6 class="text-muted mb-2">Total Competencies</h6>
                    <h2 class="text-primary mb-0">@Model.TotalCompetencies</h2>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <h6 class="text-muted mb-2">Met Target</h6>
                    <h2 class="text-success mb-0">@Model.CompetenciesMet</h2>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <h6 class="text-muted mb-2">Gap Detected</h6>
                    <h2 class="text-warning mb-0">@Model.CompetenciesGapped</h2>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <h6 class="text-muted mb-2">Overall Progress</h6>
                    <h2 class="mb-2">@Model.OverallProgress%</h2>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-primary" role="progressbar" style="width: @Model.OverallProgress%" aria-valuenow="@Model.OverallProgress" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Radar Chart -->
    @if (Model.Competencies.Any())
    {
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="bi bi-radar me-2"></i>Competency Profile (Top 8 Gaps)
                </h5>
            </div>
            <div class="card-body">
                <div style="height: 400px; position: relative;">
                    <canvas id="competencyRadarChart"></canvas>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-info mb-4">
            <i class="bi bi-info-circle me-2"></i>
            <strong>No competency data available.</strong> No competency targets are defined for your position "@(Model.Position ?? "Not Set")". Please contact HC.
        </div>
    }

    <!-- Gap Details Table -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white">
            <h5 class="mb-0">
                <i class="bi bi-table me-2"></i>Competency Details
            </h5>
        </div>
        <div class="card-body p-0">
            @if (Model.Competencies.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Competency</th>
                                <th>Skill Group</th>
                                <th class="text-center">Current</th>
                                <th class="text-center">Target</th>
                                <th class="text-center">Gap</th>
                                <th class="text-center">Status</th>
                                <th>Last Assessment</th>
                                <th>Suggested Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.Competencies)
                            {
                                <tr>
                                    <td>
                                        <strong>@item.Kompetensi</strong>
                                    </td>
                                    <td>
                                        <small class="text-muted">@item.SkillGroup</small>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-secondary">@item.CurrentLevel / 5</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-info">@item.TargetLevel / 5</span>
                                    </td>
                                    <td class="text-center">
                                        @if (item.Gap >= 3)
                                        {
                                            <span class="badge bg-danger">-@item.Gap</span>
                                        }
                                        else if (item.Gap == 2)
                                        {
                                            <span class="badge bg-warning text-dark">-@item.Gap</span>
                                        }
                                        else if (item.Gap == 1)
                                        {
                                            <span class="badge" style="background-color: #ffc107;">-@item.Gap</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-success">0</span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        @if (item.Status == "Met")
                                        {
                                            <span class="badge bg-success">Met</span>
                                        }
                                        else if (item.Status == "Gap")
                                        {
                                            <span class="badge bg-warning text-dark">Gap</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">Not Started</span>
                                        }
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(item.LastAssessmentTitle))
                                        {
                                            <small>@item.LastAssessmentTitle</small>
                                            <br />
                                            <small class="text-muted">
                                                @if (item.LastUpdated.HasValue)
                                                {
                                                    @item.LastUpdated.Value.ToString("dd MMM yyyy")
                                                }
                                            </small>
                                        }
                                        else
                                        {
                                            <small class="text-muted">No assessment yet</small>
                                        }
                                    </td>
                                    <td>
                                        @if (item.Gap > 0 && !string.IsNullOrEmpty(item.SuggestedAction))
                                        {
                                            <small class="text-dark">@item.SuggestedAction</small>
                                            @if (item.HasIdpActivity)
                                            {
                                                <br />
                                                <span class="badge bg-primary mt-1">
                                                    <i class="bi bi-check-circle me-1"></i>IDP Active
                                                </span>
                                            }
                                        }
                                        else
                                        {
                                            <small class="text-muted">Target met</small>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="p-4 text-center text-muted">
                    No competency targets found for your position. Please contact HC.
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Chart data from server
        const competencyData = {
            labels: @Html.Raw(Json.Serialize(Model.Competencies.Take(8).Select(c => c.Kompetensi))),
            current: @Html.Raw(Json.Serialize(Model.Competencies.Take(8).Select(c => c.CurrentLevel))),
            target: @Html.Raw(Json.Serialize(Model.Competencies.Take(8).Select(c => c.TargetLevel)))
        };

        // Only create chart if data exists
        if (competencyData.labels.length > 0) {
            const ctx = document.getElementById('competencyRadarChart').getContext('2d');
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: competencyData.labels,
                    datasets: [
                        {
                            label: 'Current Level',
                            data: competencyData.current,
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            pointBackgroundColor: 'rgb(54, 162, 235)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgb(54, 162, 235)'
                        },
                        {
                            label: 'Target Level',
                            data: competencyData.target,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            pointBackgroundColor: 'rgb(255, 99, 132)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgb(255, 99, 132)',
                            borderDash: [5, 5]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            min: 0,
                            max: 5,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
    </script>
}
