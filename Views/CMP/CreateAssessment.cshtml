@model HcPortal.Models.AssessmentSession

@{
    ViewData["Title"] = "Create Assessment";
    // Get list of categories for dropdown
    var categories = new List<SelectListItem>
    {
        new SelectListItem { Value = "OJT", Text = "OJT" },
        new SelectListItem { Value = "IHT", Text = "IHT" },
        new SelectListItem { Value = "Training Licencor", Text = "Training Licencor" },
        new SelectListItem { Value = "OTS", Text = "OTS" },
        new SelectListItem { Value = "Mandatory HSSE Training", Text = "Mandatory HSSE Training" },
        new SelectListItem { Value = "Proton", Text = "Proton" }
    };

    // Status options
    var statuses = new List<SelectListItem>
    {
        new SelectListItem { Value = "Open", Text = "Open" },
        new SelectListItem { Value = "Upcoming", Text = "Upcoming" },
        new SelectListItem { Value = "Completed", Text = "Completed" }
    };

    // Banner color options
    var bannerColors = new List<SelectListItem>
    {
        new SelectListItem { Value = "bg-primary", Text = "Blue" },
        new SelectListItem { Value = "bg-success", Text = "Green" },
        new SelectListItem { Value = "bg-danger", Text = "Red" },
        new SelectListItem { Value = "bg-warning", Text = "Yellow" },
        new SelectListItem { Value = "bg-info", Text = "Cyan" },
        new SelectListItem { Value = "bg-purple text-white", Text = "Purple" }
    };
}

<div class="container-fluid px-4 py-4">
    <!-- Page Header -->
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="fw-bold mb-1">Create New Assessment</h2>
                <p class="text-muted mb-0">Create a new competency assessment for employees</p>
            </div>
            <a asp-action="Assessment" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i> Back to Assessments
            </a>
        </div>
    </div>

    <!-- Success Message -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i>
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- Create Assessment Form -->
    <div class="card shadow-sm border-0">
        <div class="card-body">
            <form asp-action="CreateAssessment" method="post" class="needs-validation">

                <!-- User Selection (Multi-Select Checkboxes) -->
                <div class="row mb-3">
                    <div class="col-md-8">
                        <label class="form-label fw-semibold">
                            Assign to Users <span class="text-danger">*</span>
                        </label>
                        <!-- Search + Controls -->
                        <div class="d-flex gap-2 mb-2 align-items-center">
                            <input type="text" id="userSearchInput" class="form-control form-control-sm" placeholder="Search by name or email..." style="max-width: 300px;" />
                            <button type="button" class="btn btn-outline-primary btn-sm" id="selectAllBtn">Select All</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="deselectAllBtn">Deselect All</button>
                            <span class="badge bg-primary ms-auto" id="selectedCountBadge">0 selected</span>
                        </div>
                        <!-- Scrollable Checkbox Container -->
                        <div id="userCheckboxContainer" class="border rounded p-2" style="max-height: 300px; overflow-y: auto;">
                            @if (ViewBag.Users != null)
                            {
                                var selectedIds = (List<string>)ViewBag.SelectedUserIds;
                                @foreach (var user in ViewBag.Users)
                                {
                                    var isChecked = selectedIds != null && selectedIds.Contains((string)user.Id);
                                    <div class="form-check user-check-item mb-1" data-name="@user.FullName" data-email="@user.Email">
                                        <input class="form-check-input user-checkbox" type="checkbox" name="UserIds" value="@user.Id" id="user_@user.Id" @(isChecked ? "checked" : "") />
                                        <label class="form-check-label" for="user_@user.Id">
                                            <strong>@user.FullName</strong> <span class="text-muted">(@user.Email)</span>
                                        </label>
                                    </div>
                                }
                            }
                        </div>
                        <span class="text-danger" id="userIdsValidation">@(ViewBag.UserIdsError ?? "")</span>
                        @if (ViewData.ModelState.ContainsKey("UserIds"))
                        {
                            <span class="text-danger">@ViewData.ModelState["UserIds"]?.Errors.FirstOrDefault()?.ErrorMessage</span>
                        }
                        <div class="form-text">Select one or more users. Each user will get their own assessment session.</div>
                    </div>
                </div>

                <div class="row">
                    <!-- Title -->
                    <div class="col-md-6 mb-3">
                        <label asp-for="Title" class="form-label fw-semibold">
                            Assessment Title <span class="text-danger">*</span>
                        </label>
                        <input asp-for="Title" class="form-control" placeholder="Enter assessment title" required maxlength="255" />
                        <span asp-validation-for="Title" class="text-danger"></span>
                    </div>

                    <!-- Category -->
                    <div class="col-md-6 mb-3">
                        <label asp-for="Category" class="form-label fw-semibold">
                            Category <span class="text-danger">*</span>
                        </label>
                        <select asp-for="Category" class="form-select" asp-items="categories" required>
                            <option value="">-- Select Category --</option>
                        </select>
                        <span asp-validation-for="Category" class="text-danger"></span>
                    </div>
                </div>

                <div class="row">
                    <!-- Type -->
                    <div class="col-md-6 mb-3">
                        <label asp-for="Type" class="form-label fw-semibold">Type</label>
                        <input asp-for="Type" class="form-control" readonly id="TypeField" />
                        <div class="form-text text-muted">Auto-populated from Category</div>
                    </div>

                    <!-- Schedule -->
                    <div class="col-md-6 mb-3">
                        <label asp-for="Schedule" class="form-label fw-semibold">
                            Schedule Date <span class="text-danger">*</span>
                        </label>
                        <input asp-for="Schedule" type="date" class="form-control" required />
                        <span asp-validation-for="Schedule" class="text-danger"></span>
                    </div>
                </div>

                <div class="row">
                    <!-- Duration Minutes -->
                    <div class="col-md-6 mb-3">
                        <label asp-for="DurationMinutes" class="form-label fw-semibold">
                            Duration (Minutes) <span class="text-danger">*</span>
                        </label>
                        <input asp-for="DurationMinutes" type="number" class="form-control" min="1" max="480" required />
                        <span asp-validation-for="DurationMinutes" class="text-danger"></span>
                        <div class="form-text text-muted">Duration in minutes (1-480 minutes / max 8 hours)</div>
                    </div>

                    <!-- Status -->
                    <div class="col-md-6 mb-3">
                        <label asp-for="Status" class="form-label fw-semibold">Initial Status</label>
                        <select asp-for="Status" class="form-select">
                            <option value="Open">Open</option>
                            <option value="Upcoming">Upcoming</option>
                            <option value="Completed">Completed</option>
                        </select>
                        <div class="form-text text-muted">Default: Open (available immediately)</div>
                    </div>
                </div>

                <div class="row">
                    <!-- Banner Color -->
                    <div class="col-md-6 mb-3">
                        <label asp-for="BannerColor" class="form-label fw-semibold">Card Banner Color</label>
                        <select asp-for="BannerColor" class="form-select">
                            @foreach (var color in bannerColors)
                            {
                                <option value="@color.Value">@color.Text</option>
                            }
                        </select>
                    </div>

                    <div class="col-md-6 mb-3">
                        <div class="form-check form-switch mt-4">
                            <input class="form-check-input" type="checkbox" asp-for="IsTokenRequired" id="IsTokenRequired">
                            <label class="form-check-label fw-semibold" for="IsTokenRequired">
                                <i class="bi bi-shield-lock text-primary me-1"></i>
                                Requires Security Token
                            </label>
                        </div>
                        <div class="form-text text-muted mb-2">If checked, user must enter 6-digit token to start</div>
                        
                        <!-- Token Input (Hidden by default) -->
                        <div class="d-none" id="tokenInputContainer">
                            <label asp-for="AccessToken" class="form-label fw-semibold">Access Token</label>
                            <div class="input-group">
                                <input asp-for="AccessToken" class="form-control font-monospace" placeholder="e.g. A1B2C3" maxlength="6" id="AccessToken" style="text-transform: uppercase;" />
                                <button class="btn btn-outline-secondary" type="button" onclick="generateToken()">
                                    <i class="bi bi-shuffle"></i> Generate
                                </button>
                            </div>
                            <span asp-validation-for="AccessToken" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary px-4">
                                <i class="bi bi-plus-circle me-1"></i> Create Assessment
                            </button>
                            <a asp-action="Assessment" class="btn btn-outline-secondary px-4">
                                <i class="bi bi-x-circle me-1"></i> Cancel
                            </a>
                        </div>
                    </div>
                </div>

            </form>
        </div>
    </div>

    <!-- Success Modal (Batch) -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="successModalLabel">
                        <i class="bi bi-check-circle-fill me-2"></i> <span id="modal-header-text">Assessment Created Successfully</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <table class="table table-borderless mb-3">
                        <tbody>
                            <tr>
                                <td class="fw-semibold text-muted" style="width:140px;">Title</td>
                                <td id="modal-title"></td>
                            </tr>
                            <tr>
                                <td class="fw-semibold text-muted">Category</td>
                                <td id="modal-category"></td>
                            </tr>
                            <tr>
                                <td class="fw-semibold text-muted">Schedule</td>
                                <td id="modal-schedule"></td>
                            </tr>
                            <tr>
                                <td class="fw-semibold text-muted">Duration</td>
                                <td id="modal-duration"></td>
                            </tr>
                            <tr>
                                <td class="fw-semibold text-muted">Status</td>
                                <td id="modal-status"></td>
                            </tr>
                            <tr>
                                <td class="fw-semibold text-muted">Token</td>
                                <td id="modal-token"></td>
                            </tr>
                        </tbody>
                    </table>
                    <!-- Assigned Users Table -->
                    <h6 class="fw-semibold mb-2"><i class="bi bi-people-fill me-1"></i> Assigned Users</h6>
                    <div style="max-height: 200px; overflow-y: auto;">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="modal-users-tbody">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer d-flex justify-content-between">
                    <div>
                        <a id="modal-manage-btn" href="#" class="btn btn-primary">
                            <i class="bi bi-list-check me-1"></i> Manage Questions
                        </a>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" id="modal-create-another-btn">
                            <i class="bi bi-plus-circle me-1"></i> Create Another
                        </button>
                        <a asp-action="Assessment" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-1"></i> Back to List
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1090;">
        <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi bi-check-circle-fill me-1"></i> Assessment created successfully!
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <!-- Help Section -->
    <div class="card mt-4 border-0 bg-light">
        <div class="card-body">
            <h5 class="fw-bold mb-3">
                <i class="bi bi-info-circle text-primary me-2"></i> Assessment Creation Guide
            </h5>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <h6 class="fw-semibold">Category Types</h6>
                    <ul class="list-unstyled small mb-0">
                        <li><span class="badge bg-primary me-1">OJT</span> - On Job Training</li>
                        <li><span class="badge bg-success me-1">IHT</span> - Internal Training</li>
                        <li><span class="badge bg-danger me-1">Training Licencor</span> - Licensed Training</li>
                        <li><span class="badge bg-warning text-dark me-1">OTS</span> - Operator Training Simulator</li>
                        <li><span class="badge bg-info me-1">Mandatory HSSE</span> - Health & Safety Training</li>
                        <li><span class="badge bg-purple text-white me-1">Proton</span> - Specialized Assessment</li>
                    </ul>
                </div>
                <div class="col-md-6 mb-3">
                    <h6 class="fw-semibold">Status Options</h6>
                    <ul class="list-unstyled small mb-0">
                        <li><span class="badge bg-success me-1">Open</span> - Available immediately for users</li>
                        <li><span class="badge bg-warning text-dark me-1">Upcoming</span> - Scheduled for future, not yet available</li>
                        <li><span class="badge bg-primary me-1">Completed</span> - Finished, shows score</li>
                    </ul>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <h6 class="fw-semibold">Best Practices</h6>
                    <ul class="list-unstyled small mb-0">
                        <li><i class="bi bi-check2 text-success me-1"></i> Set schedule date in the future</li>
                        <li><i class="bi bi-check2 text-success me-1"></i> Duration: 15-480 minutes (max 8 hours)</li>
                        <li><i class="bi bi-check2 text-success me-1"></i> Use clear, descriptive titles</li>
                    </ul>
                </div>
                <div class="col-md-6 mb-3">
                    <h6 class="fw-semibold">Token Security</h6>
                    <ul class="list-unstyled small mb-0">
                        <li><i class="bi bi-shield-lock text-primary me-1"></i> Enable for sensitive assessments (Proton)</li>
                        <li><i class="bi bi-shield-lock text-primary me-1"></i> User must enter 6-digit token</li>
                        <li><i class="bi bi-info-circle text-info me-1"></i> NSO Room restriction for Proton</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .form-switch .form-check-input {
        width: 3em;
        height: 1.5em;
    }

    .form-check-label {
        cursor: pointer;
    }

    .form-switch {
        padding-left: 0;
    }

    .card {
        border-radius: 8px;
    }

    .alert {
        border-radius: 8px;
    }
</style>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // === Category â†’ Type auto-sync ===
            var categorySelect = document.getElementById('Category');
            var typeField = document.getElementById('TypeField');

            categorySelect.addEventListener('change', function() {
                typeField.value = this.value;
            });

            if (categorySelect.value) {
                typeField.value = categorySelect.value;
            }

            // === Token toggle ===
            var tokenCheckbox = document.getElementById('IsTokenRequired');
            var tokenContainer = document.getElementById('tokenInputContainer');
            var tokenInput = document.getElementById('AccessToken');

            toggleTokenInput();
            tokenCheckbox.addEventListener('change', toggleTokenInput);

            function toggleTokenInput() {
                if (tokenCheckbox.checked) {
                    tokenContainer.classList.remove('d-none');
                    tokenInput.setAttribute('required', 'required');
                } else {
                    tokenContainer.classList.add('d-none');
                    tokenInput.removeAttribute('required');
                    tokenInput.value = '';
                }
            }

            // === User checkbox: search filter ===
            var searchInput = document.getElementById('userSearchInput');
            searchInput.addEventListener('input', function() {
                var query = this.value.toLowerCase();
                document.querySelectorAll('.user-check-item').forEach(function(item) {
                    var name = (item.dataset.name || '').toLowerCase();
                    var email = (item.dataset.email || '').toLowerCase();
                    item.style.display = (name.includes(query) || email.includes(query)) ? '' : 'none';
                });
            });

            // === Select All / Deselect All ===
            document.getElementById('selectAllBtn').addEventListener('click', function() {
                document.querySelectorAll('.user-check-item').forEach(function(item) {
                    if (item.style.display !== 'none') {
                        item.querySelector('.user-checkbox').checked = true;
                    }
                });
                updateSelectedCount();
            });

            document.getElementById('deselectAllBtn').addEventListener('click', function() {
                document.querySelectorAll('.user-checkbox').forEach(function(cb) {
                    cb.checked = false;
                });
                updateSelectedCount();
            });

            // === Selected count badge ===
            document.getElementById('userCheckboxContainer').addEventListener('change', updateSelectedCount);
            updateSelectedCount(); // init on load

            function updateSelectedCount() {
                var count = document.querySelectorAll('.user-checkbox:checked').length;
                document.getElementById('selectedCountBadge').textContent = count + ' selected';
            }

            // === Client-side validation: at least 1 user ===
            var form = document.querySelector('form');
            form.addEventListener('submit', function(e) {
                var count = document.querySelectorAll('.user-checkbox:checked').length;
                var validationSpan = document.getElementById('userIdsValidation');
                if (count === 0) {
                    e.preventDefault();
                    validationSpan.textContent = 'Please select at least one user.';
                } else {
                    validationSpan.textContent = '';
                }
            });
        });

        function generateToken() {
            var chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
            var token = "";
            for (var i = 0; i < 6; i++) {
                token += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('AccessToken').value = token;
        }

        // === Auto-show success modal (batch) ===
        (function() {
            var createdData = '@Html.Raw(ViewBag.CreatedAssessment ?? "")';
            if (createdData) {
                try {
                    var a = JSON.parse(createdData);

                    // Header with count
                    var headerText = a.Count + ' assessment(s) created successfully';
                    document.getElementById('modal-header-text').textContent = headerText;

                    // Populate info fields
                    document.getElementById('modal-title').textContent = a.Title;
                    document.getElementById('modal-category').innerHTML = '<span class="badge bg-primary">' + a.Category + '</span>';
                    document.getElementById('modal-schedule').textContent = a.Schedule;
                    document.getElementById('modal-duration').textContent = a.DurationMinutes + ' minutes';
                    document.getElementById('modal-status').innerHTML = '<span class="badge bg-success">' + a.Status + '</span>';

                    if (a.IsTokenRequired && a.AccessToken) {
                        document.getElementById('modal-token').innerHTML =
                            '<i class="bi bi-shield-lock-fill text-primary me-1"></i> <code class="fs-6">' + a.AccessToken + '</code>';
                    } else {
                        document.getElementById('modal-token').innerHTML =
                            '<span class="text-muted">Not Required</span>';
                    }

                    // Populate users table
                    var tbody = document.getElementById('modal-users-tbody');
                    tbody.innerHTML = '';
                    if (a.Sessions && a.Sessions.length > 0) {
                        a.Sessions.forEach(function(s, idx) {
                            var tr = document.createElement('tr');
                            tr.innerHTML =
                                '<td>' + (idx + 1) + '</td>' +
                                '<td>' + s.UserName + '</td>' +
                                '<td class="text-muted">' + s.UserEmail + '</td>' +
                                '<td><a href="/CMP/ManageQuestions?id=' + s.Id + '" class="btn btn-sm btn-outline-primary">Manage Questions</a></td>';
                            tbody.appendChild(tr);
                        });

                        // Main "Manage Questions" button links to first session
                        var firstId = a.Sessions[0].Id;
                        var manageBtn = document.getElementById('modal-manage-btn');
                        manageBtn.href = '/CMP/ManageQuestions?id=' + firstId;
                        if (a.Sessions.length > 1) {
                            manageBtn.innerHTML = '<i class="bi bi-list-check me-1"></i> Manage Questions (First)';
                        }
                    }

                    // Show modal
                    var modal = new bootstrap.Modal(document.getElementById('successModal'));
                    modal.show();

                    // Show toast
                    var toast = new bootstrap.Toast(document.getElementById('successToast'), { delay: 4000 });
                    toast.show();

                    // Reset form + checkboxes on "Create Another"
                    document.getElementById('modal-create-another-btn').addEventListener('click', function() {
                        var form = document.querySelector('form');
                        if (form) form.reset();
                        document.getElementById('TypeField').value = '';
                        document.getElementById('tokenInputContainer').classList.add('d-none');
                        // Uncheck all user checkboxes and reset count
                        document.querySelectorAll('.user-checkbox').forEach(function(cb) { cb.checked = false; });
                        document.getElementById('selectedCountBadge').textContent = '0 selected';
                        document.getElementById('userSearchInput').value = '';
                        // Show all items again
                        document.querySelectorAll('.user-check-item').forEach(function(item) { item.style.display = ''; });
                    });
                } catch(e) {
                    console.error('Error parsing created assessment data:', e);
                }
            }
        })();
    </script>
}
