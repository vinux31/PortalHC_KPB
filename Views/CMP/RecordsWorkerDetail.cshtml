@model HcPortal.Models.WorkerTrainingStatus

@{
    ViewData["Title"] = $"Training Records - {Model.WorkerName}";
    
    // Calculate statistics
    var totalRecords = Model.TrainingRecords.Count;
    var validRecords = Model.TrainingRecords.Count(x => x.Status == "Passed" || x.Status == "Valid");
    var pendingRecords = Model.TrainingRecords.Count(x => x.Status == "Wait Certificate");
    var expiringRecords = Model.TrainingRecords.Count(x => x.IsExpiringSoon);
    
    // Get expiring certificates
    var expiringCerts = Model.TrainingRecords.Where(x => x.IsExpiringSoon).ToList();
    
    // Get unique values for filters
    var categories = Model.TrainingRecords.Select(x => x.Kategori).Distinct().OrderBy(c => c).ToList();
    var years = Model.TrainingRecords.Select(x => x.Tanggal.Year).Distinct().OrderByDescending(y => y).ToList();
    var statuses = Model.TrainingRecords.Select(x => x.Status).Distinct().OrderBy(s => s).ToList();
}

<div class="container-fluid px-4 py-4">
    
    <!-- Header with Back Button -->
    <div class="mb-4">
        <a href="javascript:history.back()" class="btn btn-outline-secondary mb-3">
            <i class="bi bi-arrow-left me-2"></i>Kembali ke Worker List
        </a>
    </div>

    <!-- Worker Info Card -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body p-4">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="d-flex align-items-center mb-3">
                        <div class="bg-primary bg-opacity-10 rounded-circle p-3 me-3">
                            <i class="bi bi-person-fill text-primary fs-1"></i>
                        </div>
                        <div>
                            <h2 class="fw-bold mb-1">@Model.WorkerName</h2>
                            <p class="text-muted mb-0">
                                <span class="me-3"><i class="bi bi-card-text me-1"></i>NIP: @Model.NIP</span>
                                <span class="me-3"><i class="bi bi-briefcase me-1"></i>@Model.Position</span>
                            </p>
                        </div>
                    </div>
                    <div class="row g-2">
                        <div class="col-auto">
                            <span class="badge bg-light text-dark border">
                                <i class="bi bi-building me-1"></i>Bagian: @Model.Section
                            </span>
                        </div>
                        <div class="col-auto">
                            <span class="badge bg-light text-dark border">
                                <i class="bi bi-gear me-1"></i>Unit: @Model.Unit
                            </span>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-md-end mt-3 mt-md-0">
                    <button class="btn btn-success" onclick="exportToPDF()">
                        <i class="bi bi-file-earmark-pdf me-2"></i>Export to PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Expiry Alert Banner -->
    @if (expiringCerts.Any())
    {
        <div class="alert alert-warning alert-dismissible fade show border-0 shadow-sm mb-4" role="alert">
            <div class="d-flex align-items-start">
                <i class="bi bi-exclamation-triangle-fill fs-3 me-3"></i>
                <div class="flex-grow-1">
                    <h5 class="alert-heading fw-bold mb-2">‚ö†Ô∏è Certificate Expiry Warning</h5>
                    <p class="mb-2">This worker has <strong>@expiringCerts.Count certificate(s)</strong> expiring within 30 days:</p>
                    <ul class="mb-0">
                        @foreach (var cert in expiringCerts)
                        {
                            <li><strong>@cert.Judul</strong> - Expires in <span class="badge bg-danger">@cert.DaysUntilExpiry days</span> (@cert.ValidUntil?.ToString("dd MMM yyyy"))</li>
                        }
                    </ul>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    }

    <!-- Training Statistics Cards -->
    <div class="row g-3 mb-4">
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100 stat-card stat-card-primary">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon bg-primary bg-opacity-10 text-primary rounded-3 p-3 me-3">
                            <i class="bi bi-journal-text fs-3"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1 small">Total Training</h6>
                            <h3 class="fw-bold mb-0">@totalRecords</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100 stat-card stat-card-success">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon bg-success bg-opacity-10 text-success rounded-3 p-3 me-3">
                            <i class="bi bi-check-circle-fill fs-3"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1 small">Valid/Passed</h6>
                            <h3 class="fw-bold mb-0">@validRecords</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100 stat-card stat-card-warning">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon bg-warning bg-opacity-10 text-warning rounded-3 p-3 me-3">
                            <i class="bi bi-hourglass-split fs-3"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1 small">Pending</h6>
                            <h3 class="fw-bold mb-0">@pendingRecords</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100 stat-card stat-card-danger">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon bg-danger bg-opacity-10 text-danger rounded-3 p-3 me-3">
                            <i class="bi bi-clock-history fs-3"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1 small">Expiring Soon</h6>
                            <h3 class="fw-bold mb-0">@expiringRecords</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Training Records Table (All Categories) -->
    <div class="card shadow-sm border-0 table-card">
        <div class="card-header bg-white border-bottom">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold">Training Records - All Categories</h5>
            </div>
        </div>
        
        <!-- Filter Bar -->
        <div class="card-body border-bottom bg-light">
            <div class="row g-2">
                <div class="col-md-3">
                    <select class="form-select" id="filterKategori">
                        <option value="">Semua Kategori</option>
                        @foreach (var cat in categories)
                        {
                            <option value="@cat">@cat</option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="filterTahun">
                        <option value="">Semua Tahun</option>
                        @foreach (var year in years)
                        {
                            <option value="@year">@year</option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="filterStatus">
                        <option value="">Semua Status</option>
                        @foreach (var status in statuses)
                        {
                            <option value="@status">@status</option>
                        }
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="text" class="form-control" id="searchTraining" placeholder="üîç Cari nama training...">
                </div>
                <div class="col-md-1">
                    <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0 records-table" id="trainingTable">
                    <thead class="sticky-header">
                        <tr>
                            <th class="p-3">Kategori</th>
                            <th class="p-3">Nama Training</th>
                            <th class="p-3">Tanggal</th>
                            <th class="p-3">Tipe Sertifikat</th>
                            <th class="p-3">Berlaku Sampai</th>
                            <th class="p-3">Status</th>
                            <th class="p-3 text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if(!Model.TrainingRecords.Any()) 
                        {
                            <tr>
                                <td colspan="7" class="text-center p-5">
                                    <div class="empty-state">
                                        <i class="bi bi-inbox text-muted mb-3" style="font-size: 3rem;"></i>
                                        <h5 class="text-muted">Belum ada training records</h5>
                                    </div>
                                </td>
                            </tr>
                        }
                        
                        @foreach (var item in Model.TrainingRecords.OrderBy(x => x.Kategori).ThenByDescending(x => x.Tanggal))
                        {
                            <tr class="training-row" 
                                data-kategori="@item.Kategori" 
                                data-tahun="@item.Tanggal.Year" 
                                data-status="@item.Status"
                                data-nama="@item.Judul.ToLower()">
                                <td class="p-3">
                                    <span class="badge bg-secondary">@item.Kategori</span>
                                </td>
                                <td class="p-3">
                                    <div class="fw-bold">@item.Judul</div>
                                </td>
                                <td class="p-3">
                                    <span class="text-muted">@item.Tanggal.ToString("dd MMM yyyy")</span>
                                </td>
                                <td class="p-3">
                                    @if (!string.IsNullOrEmpty(item.CertificateType))
                                    {
                                        <span class="badge bg-info">@item.CertificateType</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                                <td class="p-3">
                                    @if (item.ValidUntil.HasValue)
                                    {
                                        <div>
                                            <div class="fw-bold">@item.ValidUntil.Value.ToString("dd MMM yyyy")</div>
                                            @if (item.IsExpiringSoon)
                                            {
                                                <span class="badge bg-danger mt-1">
                                                    <i class="bi bi-exclamation-triangle-fill me-1"></i>
                                                    Expires in @item.DaysUntilExpiry days!
                                                </span>
                                            }
                                            else if (item.DaysUntilExpiry > 0)
                                            {
                                                <small class="text-success">
                                                    <i class="bi bi-check-circle me-1"></i>
                                                    @item.DaysUntilExpiry days remaining
                                                </small>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="text-muted">Permanent</span>
                                    }
                                </td>
                                <td class="p-3">
                                    @if(item.Status == "Passed" || item.Status == "Valid") 
                                    {
                                        <span class="badge bg-success px-3 py-2">
                                            <i class="bi bi-check-circle-fill me-1"></i>@item.Status
                                        </span>
                                    } 
                                    else 
                                    {
                                        <span class="badge bg-warning text-dark px-3 py-2">
                                            <i class="bi bi-hourglass-split me-1"></i>@item.Status
                                        </span>
                                    }
                                </td>
                                <td class="p-3 text-center">
                                    @if (!string.IsNullOrEmpty(item.SertifikatUrl))
                                    {
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-primary" onclick="downloadCertificate('@item.Judul')">
                                                <i class="bi bi-download me-1"></i>Download
                                            </button>
                                            <button class="btn btn-sm btn-outline-primary" onclick="viewCertificate('@item.Judul')">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                        </div>
                                    }
                                    else
                                    {
                                        <button class="btn btn-sm btn-outline-secondary" disabled>
                                            <i class="bi bi-hourglass-split me-1"></i>Pending
                                        </button>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
/* Stat Cards */
.stat-card {
    transition: all 0.3s ease;
    overflow: hidden;
    position: relative;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, transparent, currentColor, transparent);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1) !important;
}

.stat-card:hover::before {
    opacity: 1;
}

.stat-card-primary::before { color: #0d6efd; }
.stat-card-success::before { color: #198754; }
.stat-card-warning::before { color: #ffc107; }
.stat-card-danger::before { color: #dc3545; }

.stat-icon {
    transition: transform 0.3s ease;
}

.stat-card:hover .stat-icon {
    transform: scale(1.1) rotate(5deg);
}

/* Enhanced Table */
.table-card {
    overflow: hidden;
}

.records-table {
    margin-bottom: 0;
}

.records-table thead {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

.sticky-header {
    position: sticky;
    top: 0;
    z-index: 10;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.records-table tbody tr {
    transition: all 0.2s ease;
}

.records-table tbody tr:hover {
    background-color: #f8f9ff;
    transform: scale(1.01);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
}

/* Smooth Animations */
.training-row {
    animation: fadeIn 0.3s ease;
}

@@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>

<script>
function exportToPDF() {
    alert('Export to PDF feature - Coming soon!');
    // TODO: Implement actual PDF export
}

function downloadCertificate(title) {
    alert('Downloading certificate for: ' + title);
    // TODO: Implement actual download
}

function viewCertificate(title) {
    alert('Viewing certificate: ' + title);
    // TODO: Implement certificate viewer
}

// Filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const filterKategori = document.getElementById('filterKategori');
    const filterTahun = document.getElementById('filterTahun');
    const filterStatus = document.getElementById('filterStatus');
    const searchTraining = document.getElementById('searchTraining');
    const table = document.getElementById('trainingTable');
    const rows = table.querySelectorAll('tbody tr.training-row');
    
    function applyFilters() {
        const kategoriValue = filterKategori.value.toLowerCase();
        const tahunValue = filterTahun.value;
        const statusValue = filterStatus.value.toLowerCase();
        const searchValue = searchTraining.value.toLowerCase();
        
        rows.forEach(row => {
            const kategori = row.dataset.kategori.toLowerCase();
            const tahun = row.dataset.tahun;
            const status = row.dataset.status.toLowerCase();
            const nama = row.dataset.nama;
            
            const matchKategori = !kategoriValue || kategori === kategoriValue;
            const matchTahun = !tahunValue || tahun === tahunValue;
            const matchStatus = !statusValue || status === statusValue;
            const matchSearch = !searchValue || nama.includes(searchValue);
            
            if (matchKategori && matchTahun && matchStatus && matchSearch) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
    
    filterKategori.addEventListener('change', applyFilters);
    filterTahun.addEventListener('change', applyFilters);
    filterStatus.addEventListener('change', applyFilters);
    searchTraining.addEventListener('input', applyFilters);
});

function resetFilters() {
    document.getElementById('filterKategori').value = '';
    document.getElementById('filterTahun').value = '';
    document.getElementById('filterStatus').value = '';
    document.getElementById('searchTraining').value = '';
    
    const table = document.getElementById('trainingTable');
    const rows = table.querySelectorAll('tbody tr.training-row');
    rows.forEach(row => row.style.display = '');
}
</script>
