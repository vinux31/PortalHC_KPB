@model List<HcPortal.Models.WorkerTrainingStatus>

@{
    ViewData["Title"] = "Training Records - Worker List";

    var totalWorkers = Model.Count;

    // Get unique units for filter
    var availableUnits = Model.Select(w => w.Unit).Distinct().OrderBy(u => u).ToList();
}

<div class="container-fluid px-4 py-4">
    
    <!-- Header Section -->
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="fw-bold mb-1">Training Records - Worker List</h2>
                <p class="text-muted mb-0">
                    <i class="bi bi-building me-2"></i>Bagian: <strong>@(string.IsNullOrEmpty(ViewBag.SelectedSection as string) ? "Semua Bagian" : ViewBag.SelectedSection)</strong>
                    @if (!string.IsNullOrEmpty(ViewBag.SelectedUnit as string))
                    {
                        <text><span class="mx-2">|</span></text>
                        <text><i class="bi bi-gear me-2"></i>Unit: <strong>@ViewBag.SelectedUnit</strong></text>
                    }
                </p>
            </div>
            <div class="d-flex gap-2">
                <a href="@Url.Action("CreateTrainingRecord", "CMP")" class="btn btn-primary">
                    <i class="bi bi-plus-lg me-2"></i>Create Training Offline
                </a>
                <a href="@Url.Action("Index", "Home")" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-2"></i>Kembali ke Home
                </a>
            </div>
        </div>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle me-2"></i>@TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>@TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Filter and Export Section -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex gap-2">
            <!-- Unit Filter -->


        <!-- Advanced Filter Section -->
        <div class="card bg-light border-0 mb-4">
            <div class="card-body">
                <form method="get" action="@Url.Action("Records", "CMP")" id="filterForm">
                    <!-- Hidden flag to indicate filter has been applied (vs initial load) -->
                    <input type="hidden" name="isFiltered" value="true" />
                    
                    <div class="row g-3 align-items-end">
                        <!-- Dropdown 1: Section -->
                        <div class="col-12 col-md-3">
                            <label class="form-label fw-bold small">Bagian</label>
                            <!-- Logic Fix: Reset subCategory when Section changes -->
                            <select class="form-select form-select-sm" name="section" id="filterSection" onchange="document.getElementById('filterSubCategory').value=''; this.form.submit()">
                                <option value="">Semua Bagian</option>
                                <option value="GAST">GAST</option>
                                <option value="RFCC">RFCC</option>
                                <option value="NGP">NGP</option>
                                <option value="DHT / HMU">DHT / HMU</option>
                            </select>
                        </div>
                        
                        <!-- Dropdown 2: Category -->
                        <div class="col-12 col-md-3">
                            <label class="form-label fw-bold small">Kategori Training</label>
                            <select class="form-select form-select-sm" name="category" id="filterCategory" onchange="this.form.submit()">
                                <option value="">-- Pilih Kategori --</option>
                                <option value="OJT">OJT</option>
                                <option value="IHT">IHT</option>
                                <option value="Training Licencor">Training Licencor</option>
                                <option value="OTS">OTS</option>
                                <option value="MANDATORY">Mandatory HSSE Training</option>
                                <option value="Proton">Proton</option>
                                <option value="ISS">ISS</option>
                                <option value="OSS">OSS</option>
                            </select>
                        </div>



                        <!-- Dropdown 4: Status -->
                        <div class="col-12 col-md-2">
                            <label class="form-label fw-bold small">Status</label>
                            <select class="form-select form-select-sm" name="statusFilter" id="filterStatus" onchange="this.form.submit()">
                                <option value="">Semua</option>
                                <option value="Sudah">Sudah</option>
                                <option value="Belum">Belum</option>
                            </select>
                        </div>

                        <!-- Search -->
                        <div class="col-12 col-md-4">
                            <label class="form-label fw-bold small">Cari Nama/Nopeg</label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" name="search" placeholder="Cari nama atau nopeg..." value="@ViewBag.SearchTerm">
                                <button class="btn btn-primary" type="submit" title="Cari">
                                    <i class="bi bi-search"></i>
                                </button>
                                <a href="@Url.Action("Records", "CMP")" class="btn btn-secondary" title="Reset Filter">
                                    <i class="bi bi-arrow-counterclockwise"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </form>

            </div>
        </div>
        </div>
        

    </div>

                <!-- Workers Table -->
    <div class="card table-card shadow-sm border-0">
        <div class="card-header bg-white py-3">
            <h6 class="mb-0 fw-bold text-primary">
                <i class="bi bi-list-check me-2"></i>Daftar Pekerja
            </h6>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                
                @if (ViewBag.IsInitialState == true)
                {
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-funnel fs-1 d-block mb-3"></i>
                        <h5>Pilih filter untuk menampilkan data</h5>
                        <p class="small">Silakan pilih opsi pada filter di atas</p>
                    </div>
                }
                else if (Model.Count == 0)
                {
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-search fs-1 d-block mb-3"></i>
                        <h5>Data tidak ditemukan</h5>
                        <p class="small">Coba ubah filter pencarian Anda</p>
                    </div>
                }
                else
                {
                    <table class="table workers-table table-hover align-middle">
                        <thead class="sticky-header">
                        <tr>
                            <th class="p-3">Nama</th>
                            <th class="p-3">Nopeg</th>
                            <th class="p-3">Jabatan</th>
                             <th class="p-3 text-center">Unit</th>
                             <th class="p-3">Completion</th>
                             <th class="p-3 text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var worker in Model)
                        {
                            <tr class="worker-row clickable-row" style="cursor: pointer;" onclick="viewWorkerDetail('@worker.WorkerId', '@worker.WorkerName')">
                                <td class="p-3">
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-initial rounded-circle bg-primary text-white me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                            @worker.WorkerName.Substring(0, 1)
                                        </div>
                                        <div>
                                            <div class="fw-bold">@worker.WorkerName</div>
                                            <small class="text-danger" style="font-size: 0.75rem;">@worker.WorkerId</small>
                                        </div>
                                    </div>
                                </td>
                                <td class="p-3">@worker.NIP</td>
                                <td class="p-3">
                                    <span class="badge bg-light text-dark border">@worker.Position</span>
                                </td>
                                <td class="p-3">
                                    <small class="text-muted">@worker.Unit</small>
                                </td>
                                <td class="p-3">
                                    <small class="text-muted">@worker.CompletionDisplayText</small>
                                </td>
                                <td class="p-3 text-center">
                                    <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); viewWorkerDetail('@worker.WorkerId', '@worker.WorkerName')" title="Lihat Detail">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
                }
            </div>
        </div>
        
        <!-- Pagination Controls -->
        @if (Model.Count > 0)
        {
            <div class="card-footer bg-white border-top">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="text-muted small">
                        Showing <span id="showingStart">1</span> to <span id="showingEnd">10</span> of <span id="totalRecords">@Model.Count</span> entries
                    </div>
                    <nav aria-label="Page navigation">
                        <ul class="pagination pagination-sm mb-0" id="paginationControls">
                            <!-- Pagination buttons will be generated by JavaScript -->
                        </ul>
                    </nav>
                </div>
            </div>
        }
    </div>

    <div class="d-flex justify-content-end mt-3">
        <button class="btn btn-success" onclick="exportToExcel()">
            <i class="bi bi-file-earmark-excel me-2"></i>Export to Excel
        </button>
    </div>
</div>

<style>
/* Stat Cards */
.stat-card {
    transition: all 0.3s ease;
    overflow: hidden;
    position: relative;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, transparent, currentColor, transparent);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1) !important;
}

.stat-card:hover::before {
    opacity: 1;
}

.stat-card-primary::before { color: #0d6efd; }
.stat-card-success::before { color: #198754; }
.stat-card-warning::before { color: #ffc107; }
.stat-card-danger::before { color: #dc3545; }

.stat-icon {
    transition: transform 0.3s ease;
}

.stat-card:hover .stat-icon {
    transform: scale(1.1) rotate(5deg);
}

/* Enhanced Table */
.table-card {
    overflow: hidden;
}

.workers-table {
    margin-bottom: 0;
}

.workers-table thead {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

.sticky-header {
    position: sticky;
    top: 0;
    z-index: 10;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.workers-table tbody tr {
    transition: all 0.2s ease;
}

.workers-table tbody tr:hover {
    background-color: #f8f9ff;
    transform: scale(1.01);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
}

/* Clickable row styling */
.clickable-row {
    cursor: pointer;
}

.clickable-row:hover {
    background-color: #e8f0fe !important;
}

/* Smooth Animations */
.worker-row {
    animation: fadeIn 0.3s ease;
}

@@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>

<script>
    // --- Pagination Variables ---
    let currentPage = 1;
    const rowsPerPage = 10;
    let allRows = [];

    // Initialize on page load
    document.addEventListener("DOMContentLoaded", function() {
        // Set initial values from ViewBag
        const selectedSection = "@Html.Raw(ViewBag.SelectedSection)";
        const selectedCategory = "@Html.Raw(ViewBag.SelectedCategory)";
        const selectedStatus = "@Html.Raw(ViewBag.SelectedStatus)";
        
        if (selectedSection) document.getElementById("filterSection").value = selectedSection;
        if (selectedCategory) document.getElementById("filterCategory").value = selectedCategory;
        if (selectedStatus) document.getElementById("filterStatus").value = selectedStatus;

        // Initialize pagination
        initializePagination();
    });

    // Initialize pagination
    function initializePagination() {
        const table = document.querySelector('.workers-table tbody');
        if (!table) return;
        
        allRows = Array.from(table.querySelectorAll('.worker-row'));
        
        if (allRows.length > 0) {
            showPage(1);
            renderPaginationControls();
        }
    }

    // Show specific page
    function showPage(page) {
        currentPage = page;
        const start = (page - 1) * rowsPerPage;
        const end = start + rowsPerPage;

        // Hide all rows
        allRows.forEach((row, index) => {
            if (index >= start && index < end) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });

        // Update showing text
        const actualEnd = Math.min(end, allRows.length);
        document.getElementById('showingStart').textContent = allRows.length > 0 ? start + 1 : 0;
        document.getElementById('showingEnd').textContent = actualEnd;
        document.getElementById('totalRecords').textContent = allRows.length;

        // Update pagination controls
        renderPaginationControls();
    }

    // Render pagination controls
    function renderPaginationControls() {
        const totalPages = Math.ceil(allRows.length / rowsPerPage);
        const paginationContainer = document.getElementById('paginationControls');
        
        if (!paginationContainer || totalPages <= 1) {
            if (paginationContainer) paginationContainer.innerHTML = '';
            return;
        }

        let html = '';

        // Previous button
        html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="event.preventDefault(); showPage(${currentPage - 1})">Previous</a>
                 </li>`;

        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="event.preventDefault(); showPage(${i})">${i}</a>
                         </li>`;
            } else if (i === currentPage - 2 || i === currentPage + 2) {
                html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
        }

        // Next button
        html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="event.preventDefault(); showPage(${currentPage + 1})">Next</a>
                 </li>`;

        paginationContainer.innerHTML = html;
    }

    // View worker detail
    function viewWorkerDetail(workerId, workerName) {
        // Navigate to worker detail page (you can customize this URL)
        window.location.href = `/CMP/WorkerDetail?workerId=${encodeURIComponent(workerId)}&name=${encodeURIComponent(workerName)}`;
    }

    // Export to Excel
    function exportToExcel() {
        const table = document.querySelector('.workers-table');
        if (!table) {
            alert('No data to export');
            return;
        }

        // Get all visible rows (respecting current filters)
        const rows = Array.from(table.querySelectorAll('tbody .worker-row')).filter(row => row.style.display !== 'none');
        
        if (rows.length === 0) {
            alert('No data to export');
            return;
        }

        // Build CSV content
        let csv = 'Nama,NIP,Jabatan,Unit,Status\n';
        
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            const nama = cells[0].querySelector('.fw-bold').textContent.trim();
            const nip = cells[1].textContent.trim();
            const jabatan = cells[2].textContent.trim();
            const unit = cells[3].textContent.trim();
            const status = cells[4].textContent.trim();
            
            csv += `"${nama}","${nip}","${jabatan}","${unit}","${status}"\n`;
        });

        // Create download link
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', `Training_Records_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>
