@model HcPortal.Models.PackageExamViewModel

@{
    ViewData["Title"] = "Exam In Progress";
    const int questionsPerPage = 10;
    int totalPages = (int)Math.Ceiling((double)Model.TotalQuestions / questionsPerPage);
}

<!-- Sticky Header -->
<div class="sticky-top bg-white shadow-sm py-2 px-3 border-bottom" id="examHeader">
    <div class="d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-3">
            <h6 class="mb-0 fw-bold text-primary">@Model.Title</h6>
            <span class="text-muted small" id="answeredProgress">0/@Model.TotalQuestions answered</span>
        </div>
        <!-- Keluar Ujian button -->
        <div>
            <button type="button" class="btn btn-outline-danger btn-sm"
                    onclick="confirmAbandon()">
                <i class="bi bi-box-arrow-left me-1"></i>Keluar Ujian
            </button>
        </div>
        <div class="text-end">
            <span class="fw-bold fs-5" id="examTimer">--:--</span>
            <div class="small text-muted">Time Remaining</div>
        </div>
    </div>
</div>

<!-- Hidden form for abandon action -->
<form id="abandonForm" asp-action="AbandonExam" method="post" style="display:none">
    @Html.AntiForgeryToken()
    <input type="hidden" name="id" value="@Model.AssessmentSessionId" />
</form>

@if (!Model.Questions.Any())
{
    <div class="container py-5 text-center">
        <div class="alert alert-warning">
            <h4>No Questions Available</h4>
            <p>This assessment has no questions configured yet.</p>
            <a asp-action="Assessment" class="btn btn-outline-dark">Return to List</a>
        </div>
    </div>
}
else
{
    <div class="container-fluid py-3">
        <div class="row">
            <!-- Main exam area -->
            <div class="col-lg-9">

                <!-- Hidden main answer form (stores all answers; submitted to ExamSummary) -->
                <form id="examForm" asp-action="ExamSummary" method="post">
                    <input type="hidden" name="id" value="@Model.AssessmentSessionId" />
                    @if (Model.HasPackages && Model.AssignmentId.HasValue)
                    {
                        <input type="hidden" name="assignmentId" value="@Model.AssignmentId.Value" />
                    }

                    <!-- Per-question hidden answer inputs (updated by JS on radio change) -->
                    @foreach (var q in Model.Questions)
                    {
                        <input type="hidden" id="ans_@q.QuestionId" name="answers[@q.QuestionId]" value="" />
                    }

                    <!-- Pages: groups of 10 questions -->
                    @for (int page = 0; page < totalPages; page++)
                    {
                        var pageQuestions = Model.Questions
                            .Skip(page * questionsPerPage)
                            .Take(questionsPerPage)
                            .ToList();

                        <div class="exam-page" id="page_@(page)"
                             style="display: @(page == 0 ? "block" : "none")">

                            @foreach (var q in pageQuestions)
                            {
                                <div class="card shadow-sm mb-3 border-0" id="qcard_@q.QuestionId">
                                    <div class="card-body p-3">
                                        <p class="fw-bold mb-3">
                                            <span class="badge bg-primary me-2">@q.DisplayNumber</span>
                                            @q.QuestionText
                                        </p>
                                        <div class="list-group">
                                            @{
                                                string[] letters = { "A", "B", "C", "D" };
                                            }
                                            @for (int oi = 0; oi < q.Options.Count; oi++)
                                            {
                                                var opt = q.Options[oi];
                                                var letter = oi < letters.Length ? letters[oi] : (oi + 1).ToString();
                                                <label class="list-group-item list-group-item-action d-flex align-items-center gap-3"
                                                       style="cursor: pointer;"
                                                       id="lbl_@(q.QuestionId)_@opt.OptionId">
                                                    <input class="form-check-input flex-shrink-0 exam-radio"
                                                           type="radio"
                                                           name="radio_@q.QuestionId"
                                                           value="@opt.OptionId"
                                                           data-question-id="@q.QuestionId"
                                                           style="transform: scale(1.2);">
                                                    <span class="fw-bold me-1 text-secondary">@letter.</span>
                                                    <span>@opt.OptionText</span>
                                                </label>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }

                            <!-- Page navigation -->
                            <div class="d-flex justify-content-between mt-3 mb-4">
                                <button type="button" class="btn btn-outline-secondary"
                                        onclick="changePage(@(page - 1))"
                                        @(page == 0 ? "disabled" : "")>
                                    <i class="bi bi-chevron-left me-1"></i>Previous Page
                                </button>

                                @if (page < totalPages - 1)
                                {
                                    <button type="button" class="btn btn-primary"
                                            onclick="changePage(@(page + 1))">
                                        Next Page<i class="bi bi-chevron-right ms-1"></i>
                                    </button>
                                }
                                else
                                {
                                    <button type="submit" class="btn btn-success fw-bold"
                                            id="reviewSubmitBtn">
                                        <i class="bi bi-clipboard-check me-2"></i>Review and Submit
                                    </button>
                                }
                            </div>
                        </div>
                    }
                </form>
            </div>

            <!-- Question Number Panel (collapsible sidebar) -->
            <div class="col-lg-3" id="questionPanelWrapper">
                <div class="sticky-top" style="top: 70px;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted fw-bold">Questions this page</small>
                        <button class="btn btn-sm btn-outline-secondary" id="togglePanelBtn"
                                onclick="togglePanel()">
                            <i class="bi bi-layout-sidebar-reverse"></i>
                        </button>
                    </div>
                    <div id="questionPanel" class="card shadow-sm">
                        <div class="card-body py-2 px-2">
                            <div id="panelNumbers" class="d-flex flex-wrap gap-2">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<script>
    // -------- Constants --------
    const TOTAL_QUESTIONS = @Model.TotalQuestions;
    const QUESTIONS_PER_PAGE = @questionsPerPage;
    const TOTAL_PAGES = @totalPages;
    const DURATION_SECONDS = @Model.DurationMinutes * 60;
    const WARNING_THRESHOLD = 300; // 5 minutes

    // -------- State --------
    let currentPage = 0;
    let timeRemaining = DURATION_SECONDS;
    let answeredQuestions = new Set(); // tracks which question IDs have been answered

    // Mapping: page index -> array of question IDs on that page
    const pageQuestionIds = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
        Enumerable.Range(0, totalPages).Select(p =>
            Model.Questions.Skip(p * questionsPerPage).Take(questionsPerPage)
                .Select(q => q.QuestionId).ToList()
        ).ToList()
    ));

    // -------- Timer --------
    function updateTimer() {
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        const display = (minutes < 10 ? '0' + minutes : minutes) + ':' +
                        (seconds < 10 ? '0' + seconds : seconds);
        const el = document.getElementById('examTimer');
        el.innerText = display;
        if (timeRemaining <= WARNING_THRESHOLD) {
            el.className = 'fw-bold fs-5 text-danger';
        } else {
            el.className = 'fw-bold fs-5 text-dark';
        }
        if (timeRemaining <= 0) {
            clearInterval(timerInterval);
            alert('Time is up! Submitting your exam automatically.');
            document.getElementById('examForm').submit();
        }
        timeRemaining--;
    }
    var timerInterval = setInterval(updateTimer, 1000);
    updateTimer();

    // -------- Page switching --------
    function changePage(newPage) {
        if (newPage < 0 || newPage >= TOTAL_PAGES) return;
        document.getElementById('page_' + currentPage).style.display = 'none';
        currentPage = newPage;
        document.getElementById('page_' + currentPage).style.display = 'block';
        updatePanel();
        window.scrollTo(0, 0);
    }

    // -------- Answer tracking --------
    document.querySelectorAll('.exam-radio').forEach(function(radio) {
        radio.addEventListener('change', function() {
            const qId = this.getAttribute('data-question-id');
            const optId = this.value;
            // Update hidden input
            document.getElementById('ans_' + qId).value = optId;
            answeredQuestions.add(qId);
            updateAnsweredCount();
            // Visual: highlight selected label
            document.querySelectorAll('[id^="lbl_' + qId + '_"]').forEach(function(lbl) {
                lbl.classList.remove('option-selected');
            });
            document.getElementById('lbl_' + qId + '_' + optId).classList.add('option-selected');
        });
    });

    function updateAnsweredCount() {
        document.getElementById('answeredProgress').innerText =
            answeredQuestions.size + '/' + TOTAL_QUESTIONS + ' answered';
        updatePanel();
    }

    // -------- Collapsible panel --------
    let panelVisible = true;
    function togglePanel() {
        const panel = document.getElementById('questionPanel');
        panelVisible = !panelVisible;
        panel.style.display = panelVisible ? 'block' : 'none';
    }

    function updatePanel() {
        const container = document.getElementById('panelNumbers');
        container.innerHTML = '';
        const ids = pageQuestionIds[currentPage] || [];
        ids.forEach(function(qId) {
            const btn = document.createElement('div');
            const answered = answeredQuestions.has(String(qId));
            btn.className = 'badge rounded-pill ' + (answered ? 'bg-success' : 'bg-secondary');
            btn.style.cssText = 'font-size:0.85rem; padding:6px 10px; cursor:default;';
            // Find display number: use Q number embedded in the card badge
            const qcard = document.getElementById('qcard_' + qId);
            let displayNum = qId;
            if (qcard) {
                const badge = qcard.querySelector('.badge.bg-primary');
                if (badge) displayNum = badge.innerText.trim();
            }
            btn.innerText = displayNum;
            container.appendChild(btn);
        });
    }

    // -------- Init --------
    updatePanel();

    // -------- Abandon exam --------
    function confirmAbandon() {
        var confirmed = confirm(
            'Anda yakin ingin keluar dari ujian?\n\n' +
            'Status ujian Anda akan dicatat sebagai "Ditinggalkan".\n' +
            'Hubungi HC untuk mengulang ujian.'
        );
        if (confirmed) {
            // Bypass the onbeforeunload warning — user already confirmed
            window.onbeforeunload = null;
            document.getElementById('abandonForm').submit();
        }
    }

    // -------- Prevent accidental leave --------
    window.onbeforeunload = function() {
        return 'Are you sure you want to leave? Your progress will be lost.';
    };
    document.getElementById('examForm').addEventListener('submit', function() {
        window.onbeforeunload = null;
    });
</script>

<style>
    #examHeader { z-index: 1020; }
    .option-selected {
        background-color: #cfe2ff !important;
        border-color: #9ec5fe !important;
        color: #212529 !important;  /* keep text dark — Bootstrap .active overrides to white */
    }
    .option-selected .text-secondary { color: #0a58ca !important; }
    @@media (max-width: 991px) {
        #questionPanelWrapper { order: -1; margin-bottom: 1rem; }
    }
</style>
