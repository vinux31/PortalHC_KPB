@using HcPortal.Models
@{
    ViewData["Title"] = "Proton Catalog";
    var tracks = ViewBag.AllTracks as List<ProtonTrack> ?? new List<ProtonTrack>();
    var selectedTrackId = ViewBag.SelectedTrackId as int?;
    var kompetensiList = ViewBag.KompetensiList as List<ProtonKompetensi>;
}

<h2 class="fw-bold mb-4">
    <i class="bi bi-list-check text-primary me-2"></i>Proton Catalog
</h2>

<!-- Track selection card -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-8">
                <label for="trackDropdown" class="form-label fw-semibold mb-1">Select Track</label>
                <select class="form-select" id="trackDropdown">
                    <option value="">-- Select a track... --</option>
                    @foreach (var track in tracks)
                    {
                        if (track.Id == selectedTrackId)
                        {
                            <option value="@track.Id" selected>@track.DisplayName</option>
                        }
                        else
                        {
                            <option value="@track.Id">@track.DisplayName</option>
                        }
                    }
                </select>
            </div>
            <div class="col-md-4 text-end mt-3 mt-md-0">
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTrackModal">
                    Add Track
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Tree container card -->
<div class="card border-0 shadow-sm">
    <div id="treeContainer" class="card-body p-0">
        @if (kompetensiList != null)
        {
            @await Html.PartialAsync("_CatalogTree", kompetensiList)
        }
        else
        {
            <div class="text-center py-5 text-muted">
                <i class="bi bi-info-circle me-2"></i>Select a track to view kompetensi
            </div>
        }
    </div>
</div>

<!-- Add Track Modal -->
<div class="modal fade" id="addTrackModal" tabindex="-1" aria-labelledby="addTrackModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addTrackModalLabel">Add Track</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addTrackForm">
                <div class="modal-body">
                    @Html.AntiForgeryToken()

                    <div class="mb-3">
                        <label for="trackTypeSelect" class="form-label fw-semibold">Track Type</label>
                        <select class="form-select" id="trackTypeSelect" onchange="updateDisplayName()">
                            <option value="">-- Select type --</option>
                            <option value="Panelman">Panelman</option>
                            <option value="Operator">Operator</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="tahunKeSelect" class="form-label fw-semibold">Tahun Ke</label>
                        <select class="form-select" id="tahunKeSelect" onchange="updateDisplayName()">
                            <option value="">-- Select year --</option>
                            <option value="Tahun 1">Tahun 1</option>
                            <option value="Tahun 2">Tahun 2</option>
                            <option value="Tahun 3">Tahun 3</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="displayNamePreview" class="form-label fw-semibold">Display Name (auto-generated)</label>
                        <input type="text" class="form-control" id="displayNamePreview" readonly placeholder="Auto-generated">
                    </div>

                    <div id="addTrackError" class="alert alert-danger mt-2 d-none"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="addTrackSubmit">Add Track</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Catalog Item Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Delete Catalog Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Loading state -->
                <div id="deleteModalLoading" class="text-center py-3">
                    <div class="spinner-border spinner-border-sm text-secondary me-2" role="status"></div>
                    <span class="text-muted">Loading impact...</span>
                </div>
                <!-- Content state (populated by JS) -->
                <div id="deleteModalContent" class="d-none"></div>
                <!-- Error state -->
                <div id="deleteModalError" class="d-none"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger d-none" id="deleteConfirmBtn">Yes, Delete</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    // Live preview of DisplayName as user selects TrackType + TahunKe
    function updateDisplayName() {
        var type = document.getElementById('trackTypeSelect').value;
        var year = document.getElementById('tahunKeSelect').value;
        document.getElementById('displayNamePreview').value = (type && year) ? type + ' - ' + year : '';
    }

    // ── Catalog tree helpers ──────────────────────────────────────────────────

    function buildInlineInput(placeholderText, onSave, onCancel) {
        var wrapper = document.createElement('div');
        wrapper.className = 'd-flex align-items-center flex-wrap gap-1';

        var input = document.createElement('input');
        input.type = 'text';
        input.className = 'form-control form-control-sm d-inline-block';
        input.style.width = '60%';
        input.placeholder = placeholderText;

        var saveBtn = document.createElement('button');
        saveBtn.className = 'btn btn-sm btn-success ms-1 save-btn';
        saveBtn.textContent = '\u2713';
        saveBtn.disabled = true;

        var cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn btn-sm btn-secondary ms-1 cancel-btn';
        cancelBtn.textContent = '\u2717';

        input.addEventListener('input', function () {
            saveBtn.disabled = input.value.trim() === '';
        });
        saveBtn.addEventListener('click', function () { onSave(input.value.trim()); });
        cancelBtn.addEventListener('click', function () { onCancel(); });

        wrapper.appendChild(input);
        wrapper.appendChild(saveBtn);
        wrapper.appendChild(cancelBtn);
        return wrapper;
    }

    function postItem(url, params, onSuccess, onError) {
        var tokenEl = document.querySelector('input[name="__RequestVerificationToken"]');
        if (!tokenEl) { onError('Token tidak ditemukan.'); return; }
        var body = new URLSearchParams(Object.assign({}, params, { __RequestVerificationToken: tokenEl.value }));
        fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: body.toString()
        })
            .then(function (r) { return r.json(); })
            .then(function (result) {
                if (result.success) { onSuccess(result); }
                else { onError(result.error || 'Gagal.'); }
            })
            .catch(function () { onError('Terjadi kesalahan. Coba lagi.'); });
    }

    function showInlineError(container, msg) {
        var existing = container.querySelector('.inline-error');
        if (existing) existing.remove();
        var err = document.createElement('div');
        err.className = 'inline-error text-danger small mt-1';
        err.textContent = msg;
        container.appendChild(err);
    }

    function restoreNameSpan(nameSpan, widget) {
        nameSpan.style.display = '';
        if (widget.parentNode) widget.parentNode.removeChild(widget);
    }

    function reloadTree() {
        var trackId = document.getElementById('trackDropdown').value;
        if (!trackId) return;

        // Remember which collapse containers are currently open
        var openIds = [];
        document.querySelectorAll('#treeContainer .collapse.show').forEach(function(el) {
            if (el.id) openIds.push(el.id);
        });

        fetch('/ProtonCatalog/GetCatalogTree?trackId=' + trackId)
            .then(function (r) { return r.text(); })
            .then(function (html) {
                var container = document.getElementById('treeContainer');
                if (container) {
                    container.innerHTML = html;
                    initCatalogTree();
                    initDeleteGuards();
                    // Restore expanded state
                    openIds.forEach(function(id) {
                        var el = document.getElementById(id);
                        if (el) bootstrap.Collapse.getOrCreateInstance(el, { toggle: false }).show();
                    });
                }
            })
            .catch(function (err) { console.error('Tree reload error:', err); });
    }

    // ── initCatalogTree — call after every tree HTML injection ────────────────

    function initCatalogTree() {

        // Chevron rotation
        document.querySelectorAll('#treeContainer [data-bs-toggle="collapse"]').forEach(function (btn) {
            var targetId = btn.getAttribute('data-bs-target').replace('#', '');
            var target = document.getElementById(targetId);
            if (!target) return;
            target.addEventListener('show.bs.collapse', function (e) {
                if (e.target !== target) return;
                var icon = btn.querySelector('i.bi-chevron-right, i.bi-chevron-down');
                if (icon) icon.classList.replace('bi-chevron-right', 'bi-chevron-down');
            });
            target.addEventListener('hide.bs.collapse', function (e) {
                if (e.target !== target) return;
                var icon = btn.querySelector('i.bi-chevron-right, i.bi-chevron-down');
                if (icon) icon.classList.replace('bi-chevron-down', 'bi-chevron-right');
            });
        });

        // Pencil icon: show when row expanded, hide when collapsed
        document.querySelectorAll('#treeContainer [data-bs-toggle="collapse"]').forEach(function (btn) {
            var row = btn.closest('tr');
            if (!row) return;
            var pencil = row.querySelector('.pencil-btn');
            if (!pencil) return;
            var targetId = btn.getAttribute('data-bs-target').replace('#', '');
            var target = document.getElementById(targetId);
            if (!target) return;
            target.addEventListener('show.bs.collapse', function (e) {
                if (e.target !== target) return;
                pencil.classList.remove('d-none');
            });
            target.addEventListener('hide.bs.collapse', function (e) {
                if (e.target !== target) return;
                pencil.classList.add('d-none');
            });
        });

        // Add Kompetensi
        var addKompetensiLink = document.getElementById('addKompetensiLink');
        var addKompetensiContainer = document.getElementById('addKompetensiInput');
        if (addKompetensiLink && addKompetensiContainer) {
            addKompetensiLink.addEventListener('click', function (e) {
                e.preventDefault();
                if (!addKompetensiContainer.classList.contains('d-none')) return;
                var trackId = document.getElementById('trackDropdown').value;
                if (!trackId) return;
                addKompetensiContainer.classList.remove('d-none');
                var widget = buildInlineInput('Nama Kompetensi...', function (nama) {
                    postItem('/ProtonCatalog/AddKompetensi', { trackId: trackId, nama: nama }, function () {
                        addKompetensiContainer.classList.add('d-none');
                        addKompetensiContainer.innerHTML = '';
                        reloadTree();
                    }, function (err) { showInlineError(addKompetensiContainer, err); });
                }, function () {
                    addKompetensiContainer.classList.add('d-none');
                    addKompetensiContainer.innerHTML = '';
                });
                addKompetensiContainer.appendChild(widget);
                widget.querySelector('input').focus();
            });
        }

        // Add SubKompetensi
        document.querySelectorAll('#treeContainer .add-subkompetensi-trigger-row a[data-parent-id]').forEach(function (link) {
            link.addEventListener('click', function (e) {
                e.preventDefault();
                var kompetensiId = link.dataset.parentId;
                var container = document.getElementById('addSubKompetensiInput-' + kompetensiId);
                if (!container || !container.classList.contains('d-none')) return;
                container.classList.remove('d-none');
                var widget = buildInlineInput('Nama SubKompetensi...', function (nama) {
                    postItem('/ProtonCatalog/AddSubKompetensi', { kompetensiId: kompetensiId, nama: nama }, function () {
                        container.classList.add('d-none');
                        container.innerHTML = '';
                        reloadTree();
                    }, function (err) { showInlineError(container, err); });
                }, function () {
                    container.classList.add('d-none');
                    container.innerHTML = '';
                });
                container.appendChild(widget);
                widget.querySelector('input').focus();
            });
        });

        // Add Deliverable
        document.querySelectorAll('#treeContainer .add-deliverable-trigger-row a[data-parent-id]').forEach(function (link) {
            link.addEventListener('click', function (e) {
                e.preventDefault();
                var subKompetensiId = link.dataset.parentId;
                var container = document.getElementById('addDeliverableInput-' + subKompetensiId);
                if (!container || !container.classList.contains('d-none')) return;
                container.classList.remove('d-none');
                var widget = buildInlineInput('Nama Deliverable...', function (nama) {
                    postItem('/ProtonCatalog/AddDeliverable', { subKompetensiId: subKompetensiId, nama: nama }, function () {
                        container.classList.add('d-none');
                        container.innerHTML = '';
                        reloadTree();
                    }, function (err) { showInlineError(container, err); });
                }, function () {
                    container.classList.add('d-none');
                    container.innerHTML = '';
                });
                container.appendChild(widget);
                widget.querySelector('input').focus();
            });
        });

        // Edit (pencil click)
        document.querySelectorAll('#treeContainer .pencil-btn').forEach(function (btn) {
            btn.addEventListener('click', function () {
                var level = btn.dataset.level;
                var itemId = btn.dataset.id;
                var nameSpan = btn.closest('tr').querySelector('.item-name[data-id="' + itemId + '"]');
                if (!nameSpan || nameSpan.style.display === 'none') return;
                var originalName = nameSpan.textContent.trim();
                var widget = buildInlineInput(originalName, function (newName) {
                    postItem('/ProtonCatalog/EditCatalogItem', { level: level, itemId: itemId, nama: newName }, function () {
                        nameSpan.textContent = newName;
                        restoreNameSpan(nameSpan, widget);
                    }, function (err) {
                        showInlineError(widget.parentNode || nameSpan.parentNode, err);
                    });
                }, function () {
                    restoreNameSpan(nameSpan, widget);
                });
                widget.querySelector('input').value = originalName;
                widget.querySelector('.save-btn').disabled = false;
                nameSpan.style.display = 'none';
                nameSpan.parentNode.insertBefore(widget, nameSpan.nextSibling);
            });
        });

    }

    // ─────────────────────────────────────────────────────────────────────────

    function escapeHtml(str) {
        var div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function showDeleteError(msg) {
        var err = document.getElementById('deleteModalError');
        err.innerHTML = '<div class="alert alert-danger mb-0 py-2">' + escapeHtml(msg) + '</div>';
        err.classList.remove('d-none');
    }

    function initDeleteGuards() {
        // Extend collapse events to also show/hide trash-btn (alongside pencil-btn, same pattern)
        document.querySelectorAll('#treeContainer [data-bs-toggle="collapse"]').forEach(function (btn) {
            var row = btn.closest('tr');
            if (!row) return;
            var trash = row.querySelector('.trash-btn');
            if (!trash) return;
            var targetId = btn.getAttribute('data-bs-target').replace('#', '');
            var target = document.getElementById(targetId);
            if (!target) return;
            target.addEventListener('show.bs.collapse', function (e) { if (e.target !== target) return; trash.classList.remove('d-none'); });
            target.addEventListener('hide.bs.collapse', function (e) { if (e.target !== target) return; trash.classList.add('d-none'); });
        });

        // Wire trash-btn clicks
        document.querySelectorAll('#treeContainer .trash-btn').forEach(function (btn) {
            btn.addEventListener('click', function () {
                var level = btn.dataset.level;
                var itemId = btn.dataset.id;

                // Store pending delete info on modal element for the confirm button
                var modalEl = document.getElementById('deleteModal');
                modalEl.dataset.pendingLevel = level;
                modalEl.dataset.pendingItemId = itemId;

                // Reset modal to loading state
                document.getElementById('deleteModalLoading').classList.remove('d-none');
                document.getElementById('deleteModalContent').classList.add('d-none');
                document.getElementById('deleteModalContent').innerHTML = '';
                document.getElementById('deleteModalError').classList.add('d-none');
                document.getElementById('deleteModalError').innerHTML = '';
                document.getElementById('deleteConfirmBtn').classList.add('d-none');
                document.getElementById('deleteConfirmBtn').disabled = false;
                document.getElementById('deleteConfirmBtn').innerHTML = 'Yes, Delete';

                // Show modal
                bootstrap.Modal.getOrCreateInstance(modalEl).show();

                // Fetch impact
                fetch('/ProtonCatalog/GetDeleteImpact?level=' + encodeURIComponent(level) + '&itemId=' + encodeURIComponent(itemId))
                    .then(function (r) { return r.json(); })
                    .then(function (result) {
                        document.getElementById('deleteModalLoading').classList.add('d-none');
                        if (!result.success) {
                            showDeleteError(result.error || 'Gagal memuat data.');
                            return;
                        }

                        // Build modal content
                        var content = document.getElementById('deleteModalContent');
                        var html = '<p>Delete <strong>' + escapeHtml(result.itemName) + '</strong>?</p>';

                        if (level === 'Kompetensi') {
                            html += '<ul class="mb-2">';
                            html += '<li>' + result.subKompetensiCount + ' SubKompetensi will be deleted</li>';
                            html += '<li>' + result.deliverableCount + ' Deliverables will be deleted</li>';
                            html += '</ul>';
                        } else if (level === 'SubKompetensi') {
                            html += '<ul class="mb-2">';
                            html += '<li>' + result.deliverableCount + ' Deliverables will be deleted</li>';
                            html += '</ul>';
                        }

                        if (result.coacheeCount === 0) {
                            html += '<div class="alert alert-info mb-0 py-2"><i class="bi bi-info-circle me-1"></i>No active coachees affected.</div>';
                        } else {
                            html += '<div class="alert alert-warning mb-0 py-2"><i class="bi bi-exclamation-triangle me-1"></i>' + result.coacheeCount + ' active coachee(s) have progress on this item or its children.</div>';
                        }

                        content.innerHTML = html;
                        content.classList.remove('d-none');
                        document.getElementById('deleteConfirmBtn').classList.remove('d-none');
                    })
                    .catch(function () {
                        document.getElementById('deleteModalLoading').classList.add('d-none');
                        showDeleteError('Terjadi kesalahan. Coba lagi.');
                    });
            });
        });

        // Wire confirm button (single listener — replaces any prior listener by re-cloning the button)
        var confirmBtn = document.getElementById('deleteConfirmBtn');
        var freshBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(freshBtn, confirmBtn);
        freshBtn.addEventListener('click', function () {
            var modalEl = document.getElementById('deleteModal');
            var level = modalEl.dataset.pendingLevel;
            var itemId = modalEl.dataset.pendingItemId;

            freshBtn.disabled = true;
            freshBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status"></span>Deleting...';

            postItem('/ProtonCatalog/DeleteCatalogItem', { level: level, itemId: itemId }, function () {
                bootstrap.Modal.getInstance(modalEl).hide();
                reloadTree();
            }, function (err) {
                freshBtn.disabled = false;
                freshBtn.innerHTML = 'Yes, Delete';
                showDeleteError(err);
            });
        });
    }

    // ─────────────────────────────────────────────────────────────────────────

    document.addEventListener('DOMContentLoaded', function () {

        // Initialize tree interactions for server-side rendered tree
        initCatalogTree();
        initDeleteGuards();

        // Track dropdown change handler
        document.getElementById('trackDropdown').addEventListener('change', onTrackChanged);

        // Add Track form submit
        document.getElementById('addTrackForm').addEventListener('submit', function (e) {
            e.preventDefault();
            var trackType = document.getElementById('trackTypeSelect').value;
            var tahunKe = document.getElementById('tahunKeSelect').value;
            var token = document.querySelector('input[name="__RequestVerificationToken"]').value;
            var errorDiv = document.getElementById('addTrackError');
            errorDiv.classList.add('d-none');
            errorDiv.textContent = '';

            if (!trackType || !tahunKe) {
                errorDiv.textContent = 'Please select both Track Type and Year.';
                errorDiv.classList.remove('d-none');
                return;
            }

            var body = new URLSearchParams({ trackType: trackType, tahunKe: tahunKe, __RequestVerificationToken: token });
            fetch('/ProtonCatalog/AddTrack', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: body.toString()
            })
            .then(function (r) { return r.json(); })
            .then(function (result) {
                if (result.success) {
                    var dropdown = document.getElementById('trackDropdown');
                    var option = document.createElement('option');
                    option.value = result.trackId;
                    option.textContent = result.displayName;
                    dropdown.appendChild(option);
                    dropdown.value = result.trackId;
                    bootstrap.Modal.getInstance(document.getElementById('addTrackModal')).hide();
                    onTrackChanged();
                } else {
                    errorDiv.textContent = result.error;
                    errorDiv.classList.remove('d-none');
                }
            })
            .catch(function (err) { console.error('AddTrack error:', err); });
        });

        // Reset modal fields on close
        document.getElementById('addTrackModal').addEventListener('hidden.bs.modal', function () {
            document.getElementById('trackTypeSelect').value = '';
            document.getElementById('tahunKeSelect').value = '';
            document.getElementById('displayNamePreview').value = '';
            document.getElementById('addTrackError').classList.add('d-none');
            document.getElementById('addTrackError').textContent = '';
        });
    });

    // AJAX tree reload on track change
    function onTrackChanged() {
        var trackId = document.getElementById('trackDropdown').value;
        if (!trackId) {
            window.history.pushState(null, '', '/ProtonCatalog');
            document.getElementById('treeContainer').innerHTML =
                '<div class="text-center py-5 text-muted"><i class="bi bi-info-circle me-2"></i>Select a track to view kompetensi</div>';
            return;
        }
        window.history.pushState(null, '', '/ProtonCatalog?trackId=' + trackId);
        fetch('/ProtonCatalog/GetCatalogTree?trackId=' + trackId)
            .then(function (r) { return r.text(); })
            .then(function (html) {
                document.getElementById('treeContainer').innerHTML = html;
                initCatalogTree();
                initDeleteGuards();
            })
            .catch(function (err) { console.error('Tree load error:', err); });
    }
</script>
}
