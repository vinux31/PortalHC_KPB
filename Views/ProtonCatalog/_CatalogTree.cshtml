<style>
    .sortable-ghost {
        opacity: 0.3;
        background-color: #e8f4fd;
    }
    .sortable-chosen {
        opacity: 0.8;
    }
    .drag-handle:active {
        cursor: grabbing;
    }
</style>

@model List<HcPortal.Models.ProtonKompetensi>

@if (Model == null || !Model.Any())
{
    <div class="p-3">
        <div class="text-muted small fst-italic mb-2 ps-1">No Kompetensi yet</div>
        <!-- Add Kompetensi trigger row (always visible) -->
        <div class="add-trigger-row" id="addKompetensiTrigger" data-track-id="@ViewBag.SelectedTrackId">
            <a href="#" class="text-primary small text-decoration-none" id="addKompetensiLink">+ Add Kompetensi</a>
            <div class="add-input-row d-none mt-1" id="addKompetensiInput"></div>
        </div>
    </div>
}
else
{
    <table class="table table-bordered mb-0">
        <colgroup>
            <col style="width:24px;">
            <col style="width:50px;">
            <col>
            <col style="width:50px;">
        </colgroup>
        <tbody data-sortable-level="Kompetensi">
            @foreach (var kompetensi in Model.OrderBy(k => k.Urutan))
            {
                <!-- Level 1: Kompetensi row -->
                <tr class="sortable-row" data-id="@kompetensi.Id">
                    <td class="align-middle text-center">
                        <i class="bi bi-grip-vertical drag-handle text-secondary" style="cursor:grab; font-size:1rem;"></i>
                    </td>
                    <td class="align-middle text-center">
                        <button type="button" class="btn btn-link btn-sm p-0 text-secondary"
                                data-bs-toggle="collapse"
                                data-bs-target="#kompetensi-@kompetensi.Id"
                                aria-expanded="false"
                                aria-label="Toggle @kompetensi.NamaKompetensi">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </td>
                    <td class="align-middle fw-semibold ps-2">
                        <span class="item-name" data-level="Kompetensi" data-id="@kompetensi.Id">@kompetensi.NamaKompetensi</span>
                    </td>
                    <td class="align-middle text-end pe-2 text-nowrap">
                        <button type="button"
                                class="btn btn-link btn-sm p-0 text-muted pencil-btn d-none me-1"
                                data-level="Kompetensi"
                                data-id="@kompetensi.Id"
                                aria-label="Edit @kompetensi.NamaKompetensi">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button type="button"
                                class="btn btn-link btn-sm p-0 text-danger trash-btn d-none"
                                data-level="Kompetensi"
                                data-id="@kompetensi.Id"
                                aria-label="Delete @kompetensi.NamaKompetensi">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
                <!-- Level 1: Kompetensi collapse container -->
                <tr id="kompetensi-@kompetensi.Id" class="collapse">
                    <td colspan="4" class="p-0 ps-4">
                        <table class="table table-bordered mb-0">
                            <colgroup>
                                <col style="width:24px;">
                                <col style="width:50px;">
                                <col>
                                <col style="width:50px;">
                            </colgroup>
                            <tbody data-sortable-level="SubKompetensi" data-parent-id="@kompetensi.Id">
                                @if (!kompetensi.SubKompetensiList.Any())
                                {
                                    <tr>
                                        <td colspan="4" class="py-1">
                                            <div class="text-muted small fst-italic ps-1">No SubKompetensi yet</div>
                                        </td>
                                    </tr>
                                }
                                @foreach (var sub in kompetensi.SubKompetensiList.OrderBy(s => s.Urutan))
                                {
                                    <!-- Level 2: SubKompetensi row -->
                                    <tr class="sortable-row" data-id="@sub.Id">
                                        <td class="align-middle text-center">
                                            <i class="bi bi-grip-vertical drag-handle text-secondary" style="cursor:grab; font-size:1rem;"></i>
                                        </td>
                                        <td class="align-middle text-center">
                                            <button type="button" class="btn btn-link btn-sm p-0 text-secondary"
                                                    data-bs-toggle="collapse"
                                                    data-bs-target="#subkompetensi-@sub.Id"
                                                    aria-expanded="false"
                                                    aria-label="Toggle @sub.NamaSubKompetensi">
                                                <i class="bi bi-chevron-right"></i>
                                            </button>
                                        </td>
                                        <td class="align-middle ps-2">
                                            <span class="item-name" data-level="SubKompetensi" data-id="@sub.Id">@sub.NamaSubKompetensi</span>
                                        </td>
                                        <td class="align-middle text-end pe-2 text-nowrap">
                                            <button type="button"
                                                    class="btn btn-link btn-sm p-0 text-muted pencil-btn d-none me-1"
                                                    data-level="SubKompetensi"
                                                    data-id="@sub.Id"
                                                    aria-label="Edit @sub.NamaSubKompetensi">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button type="button"
                                                    class="btn btn-link btn-sm p-0 text-danger trash-btn d-none"
                                                    data-level="SubKompetensi"
                                                    data-id="@sub.Id"
                                                    aria-label="Delete @sub.NamaSubKompetensi">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <!-- Level 2: SubKompetensi collapse container -->
                                    <tr id="subkompetensi-@sub.Id" class="collapse">
                                        <td colspan="4" class="p-0 ps-4">
                                            <table class="table table-bordered mb-0">
                                                <colgroup>
                                                    <col style="width:24px;">
                                                    <col style="width:50px;">
                                                    <col>
                                                    <col style="width:50px;">
                                                </colgroup>
                                                <tbody data-sortable-level="Deliverable" data-parent-id="@sub.Id">
                                                    @if (!sub.Deliverables.Any())
                                                    {
                                                        <tr>
                                                            <td colspan="4" class="py-1">
                                                                <div class="text-muted small fst-italic ps-1">No Deliverables yet</div>
                                                            </td>
                                                        </tr>
                                                    }
                                                    @foreach (var deliverable in sub.Deliverables.OrderBy(d => d.Urutan))
                                                    {
                                                        <!-- Level 3: Deliverable (leaf, no chevron) -->
                                                        <tr class="sortable-row" data-id="@deliverable.Id">
                                                            <td class="align-middle text-center">
                                                                <i class="bi bi-grip-vertical drag-handle text-secondary" style="cursor:grab; font-size:1rem;"></i>
                                                            </td>
                                                            <td class="align-middle ps-2" colspan="2">
                                                                <span class="item-name" data-level="Deliverable" data-id="@deliverable.Id">@deliverable.NamaDeliverable</span>
                                                            </td>
                                                            <td class="align-middle text-end pe-2 text-nowrap">
                                                                <button type="button"
                                                                        class="btn btn-link btn-sm p-0 text-muted pencil-btn me-1"
                                                                        data-level="Deliverable"
                                                                        data-id="@deliverable.Id"
                                                                        aria-label="Edit @deliverable.NamaDeliverable">
                                                                    <i class="bi bi-pencil"></i>
                                                                </button>
                                                                <button type="button"
                                                                        class="btn btn-link btn-sm p-0 text-danger trash-btn"
                                                                        data-level="Deliverable"
                                                                        data-id="@deliverable.Id"
                                                                        aria-label="Delete @deliverable.NamaDeliverable">
                                                                    <i class="bi bi-trash"></i>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    }
                                                    <!-- Add Deliverable trigger (always visible) -->
                                                    <tr class="add-deliverable-trigger-row">
                                                        <td colspan="4" class="py-1">
                                                            <a href="#" class="text-primary small text-decoration-none ms-1"
                                                               data-parent-id="@sub.Id">+ Add Deliverable</a>
                                                            <div class="add-input-row d-none mt-1" id="addDeliverableInput-@sub.Id"></div>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </td>
                                    </tr>
                                }
                                <!-- Add SubKompetensi trigger (always visible, after last SubKompetensi row) -->
                                <tr class="add-subkompetensi-trigger-row">
                                    <td colspan="4" class="py-1">
                                        <a href="#" class="text-primary small text-decoration-none ms-1"
                                           data-parent-id="@kompetensi.Id">+ Add SubKompetensi</a>
                                        <div class="add-input-row d-none mt-1" id="addSubKompetensiInput-@kompetensi.Id"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <!-- Add Kompetensi trigger (always visible below the last Kompetensi row) -->
    <div class="p-2 ps-3" id="addKompetensiTrigger" data-track-id="@ViewBag.SelectedTrackId">
        <a href="#" class="text-primary small text-decoration-none"
           id="addKompetensiLink">+ Add Kompetensi</a>
        <div class="add-input-row d-none mt-1" id="addKompetensiInput"></div>
    </div>
}

