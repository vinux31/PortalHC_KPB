@using HcPortal.Models
@{
    ViewData["Title"] = "Silabus & Coaching Guidance";
    ViewData["ContainerClass"] = "container-fluid";

    var allTracks = ViewBag.AllTracks as List<ProtonTrack> ?? new List<ProtonTrack>();
    var selectedBagian = ViewBag.Bagian as string ?? "";
    var selectedUnit = ViewBag.Unit as string ?? "";
    var selectedTrackId = ViewBag.TrackId as int?;
    var silabusRowsJson = ViewBag.SilabusRowsJson as string ?? "[]";
}

<div class="d-flex align-items-start mb-4">
    <div>
        <h2 class="fw-bold text-dark mb-1"><i class="bi bi-book me-2 text-primary"></i>Silabus &amp; Coaching Guidance</h2>
        <p class="text-muted">Kelola silabus Proton dan file coaching guidance per Bagian, Unit, dan Track.</p>
    </div>
</div>

@* AntiForgeryToken for POST actions in Plans 02/03 *@
@Html.AntiForgeryToken()

@* Bootstrap Nav Tabs *@
<ul class="nav nav-tabs mb-4" id="protonDataTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="silabus-tab" data-bs-toggle="tab" data-bs-target="#silabusTabContent"
                type="button" role="tab" aria-controls="silabusTabContent" aria-selected="true">
            <i class="bi bi-list-ol me-1"></i>Silabus
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="guidance-tab" data-bs-toggle="tab" data-bs-target="#guidanceTabContent"
                type="button" role="tab" aria-controls="guidanceTabContent" aria-selected="false">
            <i class="bi bi-file-earmark-text me-1"></i>Coaching Guidance
        </button>
    </li>
</ul>

<div class="tab-content" id="protonDataTabContent">

    @* ====== SILABUS TAB ====== *@
    <div class="tab-pane fade show active" id="silabusTabContent" role="tabpanel" aria-labelledby="silabus-tab">
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <h6 class="fw-bold text-muted mb-3"><i class="bi bi-funnel me-1"></i>Filter Silabus</h6>
                <form method="get" action="@Url.Action("Index", "ProtonData")" id="silabusFilterForm">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label fw-semibold">Bagian</label>
                            <select class="form-select" id="silabusBagian" name="bagian" required>
                                <option value="">-- Pilih Bagian --</option>
                                @foreach (var bagian in OrganizationStructure.SectionUnits.Keys)
                                {
                                    <option value="@bagian" selected="@(selectedBagian == bagian ? "selected" : null)">@bagian</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-semibold">Unit</label>
                            <select class="form-select" id="silabusUnit" name="unit" required disabled="@(string.IsNullOrEmpty(selectedBagian) ? "disabled" : null)">
                                <option value="">-- Pilih Unit --</option>
                                @if (!string.IsNullOrEmpty(selectedBagian) && OrganizationStructure.SectionUnits.ContainsKey(selectedBagian))
                                {
                                    foreach (var unit in OrganizationStructure.SectionUnits[selectedBagian])
                                    {
                                        <option value="@unit" selected="@(selectedUnit == unit ? "selected" : null)">@unit</option>
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-semibold">Track</label>
                            <select class="form-select" id="silabusTrack" name="trackId" required>
                                <option value="">-- Pilih Track --</option>
                                @foreach (var track in allTracks)
                                {
                                    <option value="@track.Id" selected="@(selectedTrackId == track.Id ? "selected" : null)">@track.DisplayName</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-search me-1"></i>Muat Data
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        @* Silabus data display area — rendered by JS *@
        <div id="silabusTableContainer"></div>

        @* JSON data island for JS consumption *@
        <script type="application/json" id="silabusData">@Html.Raw(silabusRowsJson)</script>

        @* Filter state for JS *@
        <script type="application/json" id="silabusFilter">@Html.Raw(System.Text.Json.JsonSerializer.Serialize(new {
            bagian = selectedBagian,
            unit = selectedUnit,
            trackId = selectedTrackId,
            hasFilter = !string.IsNullOrEmpty(selectedBagian) && !string.IsNullOrEmpty(selectedUnit) && selectedTrackId.HasValue
        }))</script>
    </div>

    @* ====== Delete confirmation modal (shared for Silabus tab) ====== *@
    <div class="modal fade" id="silabusDeleteModal" tabindex="-1" aria-labelledby="silabusDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="silabusDeleteModalLabel">Konfirmasi Hapus</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Hapus deliverable <strong id="silabusDeleteName"></strong>?</p>
                    <p class="text-danger small">Tindakan ini tidak dapat dibatalkan.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-danger" id="btnConfirmSilabusDelete">Hapus</button>
                </div>
            </div>
        </div>
    </div>

    @* ====== COACHING GUIDANCE TAB ====== *@
    <div class="tab-pane fade" id="guidanceTabContent" role="tabpanel" aria-labelledby="guidance-tab">
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <h6 class="fw-bold text-muted mb-3"><i class="bi bi-funnel me-1"></i>Filter Coaching Guidance</h6>
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">Bagian</label>
                        <select class="form-select" id="guidanceBagian">
                            <option value="">-- Pilih Bagian --</option>
                            @foreach (var bagian in OrganizationStructure.SectionUnits.Keys)
                            {
                                <option value="@bagian">@bagian</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">Unit</label>
                        <select class="form-select" id="guidanceUnit" disabled>
                            <option value="">-- Pilih Unit --</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">Track</label>
                        <select class="form-select" id="guidanceTrack">
                            <option value="">-- Pilih Track --</option>
                            @foreach (var track in allTracks)
                            {
                                <option value="@track.Id">@track.DisplayName</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="btn btn-primary w-100" id="btnLoadGuidance">
                            <i class="bi bi-search me-1"></i>Muat Data
                        </button>
                    </div>
                </div>
            </div>
        </div>

        @* Placeholder for guidance file table and upload form — Plan 03 will implement *@
        <div id="guidanceTableContainer">
            <div class="text-center py-5 text-muted">
                <i class="bi bi-file-earmark-text fs-1 mb-3 d-block opacity-50"></i>
                <p>Pilih Bagian, Unit, dan Track kemudian klik <strong>Muat Data</strong> untuk menampilkan file coaching guidance.</p>
                @* Plan 03 will implement guidance file CRUD *@
            </div>
        </div>
    </div>

</div>

@section Scripts {
<script>
    // Organization structure from server
    const orgStructure = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
        HcPortal.Models.OrganizationStructure.SectionUnits));

    // ====== Silabus tab filter cascade ======
    document.getElementById('silabusBagian').addEventListener('change', function () {
        const bagian = this.value;
        const unitSelect = document.getElementById('silabusUnit');
        unitSelect.innerHTML = '<option value="">-- Pilih Unit --</option>';
        if (bagian && orgStructure[bagian]) {
            orgStructure[bagian].forEach(u => {
                const opt = document.createElement('option');
                opt.value = u;
                opt.textContent = u;
                unitSelect.appendChild(opt);
            });
        }
        unitSelect.disabled = !bagian;
    });

    // ====== Coaching Guidance tab filter cascade ======
    document.getElementById('guidanceBagian').addEventListener('change', function () {
        const bagian = this.value;
        const unitSelect = document.getElementById('guidanceUnit');
        unitSelect.innerHTML = '<option value="">-- Pilih Unit --</option>';
        if (bagian && orgStructure[bagian]) {
            orgStructure[bagian].forEach(u => {
                const opt = document.createElement('option');
                opt.value = u;
                opt.textContent = u;
                unitSelect.appendChild(opt);
            });
        }
        unitSelect.disabled = !bagian;
    });

    // ====== Silabus CRUD (Plan 02) ======
    (function () {
        // State
        let silabusRows = JSON.parse(document.getElementById('silabusData').textContent || '[]');
        let isEditMode = false;
        let deleteTargetIndex = -1;

        // Filter context
        const filterRaw = document.getElementById('silabusFilter').textContent;
        const silabusFilter = JSON.parse(filterRaw);
        const currentBagian = silabusFilter.bagian || '';
        const currentUnit = silabusFilter.unit || '';
        const currentTrackId = silabusFilter.trackId || 0;
        const hasFilter = silabusFilter.hasFilter;

        const container = document.getElementById('silabusTableContainer');

        // ---- Render: View mode with rowspan merge ----
        function renderViewTable() {
            if (!hasFilter) {
                container.innerHTML = `
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-funnel fs-1 mb-3 d-block opacity-50"></i>
                        <p>Pilih Bagian, Unit, dan Track kemudian klik <strong>Muat Data</strong> untuk menampilkan silabus.</p>
                    </div>`;
                return;
            }

            let html = `<div class="d-flex align-items-center justify-content-between mb-3">
                <span class="text-muted small">Menampilkan silabus untuk: <strong>${escHtml(currentUnit)}</strong></span>
                <button id="btnEdit" class="btn btn-warning btn-sm"><i class="bi bi-pencil me-1"></i>Edit</button>
            </div>`;

            if (silabusRows.length === 0) {
                html += `<div class="alert alert-info">Belum ada data silabus. Klik 'Edit' untuk mulai menambahkan data.</div>`;
            } else {
                html += `<div class="table-responsive"><table class="table table-bordered table-sm">
                    <thead class="table-light">
                        <tr>
                            <th style="width:60px">No</th>
                            <th>Kompetensi</th>
                            <th>Sub Kompetensi</th>
                            <th>Deliverable</th>
                        </tr>
                    </thead>
                    <tbody>`;

                let i = 0;
                while (i < silabusRows.length) {
                    const row = silabusRows[i];
                    // Compute kompetensi rowspan
                    let kompSpan = 1;
                    while (i + kompSpan < silabusRows.length && silabusRows[i + kompSpan].Kompetensi === row.Kompetensi) kompSpan++;

                    // Render rows for this kompetensi group
                    let j = i;
                    while (j < i + kompSpan) {
                        const subRow = silabusRows[j];
                        // Compute sub-kompetensi rowspan within this kompetensi group
                        let subSpan = 1;
                        while (j + subSpan < i + kompSpan && silabusRows[j + subSpan].SubKompetensi === subRow.SubKompetensi) subSpan++;

                        // Render rows for this sub-kompetensi group
                        for (let k = j; k < j + subSpan; k++) {
                            const dRow = silabusRows[k];
                            html += '<tr>';
                            if (k === i) {
                                html += `<td rowspan="${kompSpan}" class="align-middle fw-semibold text-center" style="background:#f8f9fa">${escHtml(dRow.No)}</td>`;
                                html += `<td rowspan="${kompSpan}" class="align-middle fw-semibold">${escHtml(dRow.Kompetensi)}</td>`;
                            }
                            if (k === j) {
                                html += `<td rowspan="${subSpan}" class="align-middle">${escHtml(dRow.SubKompetensi)}</td>`;
                            }
                            html += `<td>${escHtml(dRow.Deliverable)}</td>`;
                            html += '</tr>';
                        }
                        j += subSpan;
                    }
                    i += kompSpan;
                }

                html += `</tbody></table></div>`;
            }

            container.innerHTML = html;
            document.getElementById('btnEdit').addEventListener('click', function () {
                isEditMode = true;
                renderEditTable();
            });
        }

        // ---- Render: Edit mode (expanded rows with inputs) ----
        function renderEditTable() {
            let html = `<div class="d-flex align-items-center justify-content-between mb-3" id="silabusEditToolbar">
                <span class="text-muted small">Mode Edit — <strong>${escHtml(currentUnit)}</strong></span>
                <div class="d-flex gap-2">
                    <button id="btnBatal" class="btn btn-secondary btn-sm"><i class="bi bi-x-circle me-1"></i>Batal</button>
                    <button id="btnSaveAll" class="btn btn-success btn-sm"><i class="bi bi-save me-1"></i>Simpan Semua</button>
                </div>
            </div>`;

            html += `<div class="table-responsive"><table class="table table-bordered table-sm" id="silabusEditTable">
                <thead class="table-light">
                    <tr>
                        <th style="width:60px">No</th>
                        <th>Kompetensi</th>
                        <th>Sub Kompetensi</th>
                        <th>Deliverable</th>
                        <th style="width:90px">Aksi</th>
                    </tr>
                </thead>
                <tbody>`;

            if (silabusRows.length === 0) {
                html += `<tr id="emptyRow"><td colspan="5" class="text-center text-muted py-3">Belum ada baris. Klik tombol "Tambah Baris" di bawah.</td></tr>`;
            } else {
                silabusRows.forEach(function (row, idx) {
                    html += renderEditRow(row, idx);
                });
            }

            html += `</tbody></table></div>`;
            html += `<div class="mt-2">
                <button class="btn btn-outline-primary btn-sm" id="btnTambahBaris">
                    <i class="bi bi-plus-circle me-1"></i>Tambah Baris
                </button>
            </div>`;

            container.innerHTML = html;

            // Wire toolbar buttons
            document.getElementById('btnBatal').addEventListener('click', function () {
                isEditMode = false;
                // Reload original data from server
                window.location.reload();
            });

            document.getElementById('btnSaveAll').addEventListener('click', saveAll);

            document.getElementById('btnTambahBaris').addEventListener('click', function () {
                const lastIdx = silabusRows.length - 1;
                const newRow = {
                    KompetensiId: 0, Kompetensi: '',
                    SubKompetensiId: 0, SubKompetensi: '',
                    DeliverableId: 0, Deliverable: '', No: ''
                };
                silabusRows.push(newRow);
                renderEditTable();
            });

            // Wire row-level buttons
            wireEditTableEvents();
        }

        function renderEditRow(row, idx) {
            return `<tr data-idx="${idx}">
                <td><input type="text" class="form-control form-control-sm" data-field="No" value="${escAttr(row.No)}"></td>
                <td><input type="text" class="form-control form-control-sm" data-field="Kompetensi" value="${escAttr(row.Kompetensi)}"></td>
                <td><input type="text" class="form-control form-control-sm" data-field="SubKompetensi" value="${escAttr(row.SubKompetensi)}"></td>
                <td><input type="text" class="form-control form-control-sm" data-field="Deliverable" value="${escAttr(row.Deliverable)}"></td>
                <td class="text-center">
                    <button class="btn btn-sm btn-outline-primary btn-insert-row me-1" title="Sisipkan baris setelah ini" data-idx="${idx}">
                        <i class="bi bi-plus-circle"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger btn-delete-row" title="Hapus baris" data-idx="${idx}">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>`;
        }

        function wireEditTableEvents() {
            const tbody = document.querySelector('#silabusEditTable tbody');
            if (!tbody) return;

            // Input changes → update silabusRows array
            tbody.addEventListener('input', function (e) {
                const input = e.target;
                if (input.tagName !== 'INPUT') return;
                const tr = input.closest('tr');
                if (!tr) return;
                const idx = parseInt(tr.dataset.idx);
                const field = input.dataset.field;
                if (!isNaN(idx) && field && silabusRows[idx] !== undefined) {
                    silabusRows[idx][field] = input.value;
                }
            });

            // Insert row (+ button)
            tbody.addEventListener('click', function (e) {
                const btn = e.target.closest('.btn-insert-row');
                if (!btn) return;
                const idx = parseInt(btn.dataset.idx);
                const currRow = silabusRows[idx] || {};
                const newRow = {
                    KompetensiId: 0, Kompetensi: currRow.Kompetensi || '',
                    SubKompetensiId: 0, SubKompetensi: currRow.SubKompetensi || '',
                    DeliverableId: 0, Deliverable: '', No: ''
                };
                silabusRows.splice(idx + 1, 0, newRow);
                renderEditTable();
            });

            // Delete row (trash button)
            tbody.addEventListener('click', function (e) {
                const btn = e.target.closest('.btn-delete-row');
                if (!btn) return;
                const idx = parseInt(btn.dataset.idx);
                const row = silabusRows[idx];
                if (!row) return;

                if (row.DeliverableId > 0) {
                    // Saved row — show modal confirmation
                    deleteTargetIndex = idx;
                    document.getElementById('silabusDeleteName').textContent = row.Deliverable || '(tanpa nama)';
                    const modal = new bootstrap.Modal(document.getElementById('silabusDeleteModal'));
                    modal.show();
                } else {
                    // Unsaved row — remove directly
                    silabusRows.splice(idx, 1);
                    renderEditTable();
                }
            });
        }

        // ---- Delete modal confirm ----
        document.getElementById('btnConfirmSilabusDelete').addEventListener('click', async function () {
            const modal = bootstrap.Modal.getInstance(document.getElementById('silabusDeleteModal'));
            modal.hide();

            if (deleteTargetIndex < 0 || deleteTargetIndex >= silabusRows.length) return;
            const row = silabusRows[deleteTargetIndex];

            if (row.DeliverableId > 0) {
                try {
                    const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                    const resp = await fetch('/ProtonData/SilabusDelete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': token },
                        body: JSON.stringify({ DeliverableId: row.DeliverableId })
                    });
                    const data = await resp.json();
                    if (!data.success) {
                        alert('Gagal menghapus: ' + (data.message || 'Error tidak diketahui'));
                        return;
                    }
                } catch (err) {
                    alert('Terjadi kesalahan jaringan. Silakan coba lagi.');
                    return;
                }
            }

            silabusRows.splice(deleteTargetIndex, 1);
            deleteTargetIndex = -1;
            renderEditTable();
        });

        // ---- Save All ----
        async function saveAll() {
            // Read current input values from DOM into silabusRows
            const rows = document.querySelectorAll('#silabusEditTable tbody tr[data-idx]');
            rows.forEach(function (tr) {
                const idx = parseInt(tr.dataset.idx);
                if (isNaN(idx) || !silabusRows[idx]) return;
                tr.querySelectorAll('input[data-field]').forEach(function (inp) {
                    silabusRows[idx][inp.dataset.field] = inp.value;
                });
            });

            // Validate
            for (let i = 0; i < silabusRows.length; i++) {
                const r = silabusRows[i];
                if (!r.Kompetensi || !r.Kompetensi.trim()) {
                    alert(`Baris ${i + 1}: Kolom Kompetensi tidak boleh kosong.`);
                    return;
                }
                if (!r.Deliverable || !r.Deliverable.trim()) {
                    alert(`Baris ${i + 1}: Kolom Deliverable tidak boleh kosong.`);
                    return;
                }
            }

            // Enrich with filter context
            const payload = silabusRows.map(function (r) {
                return Object.assign({}, r, { Bagian: currentBagian, Unit: currentUnit, TrackId: currentTrackId });
            });

            const btn = document.getElementById('btnSaveAll');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Menyimpan...';

            try {
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                const resp = await fetch('/ProtonData/SilabusSave', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': token },
                    body: JSON.stringify(payload)
                });
                const data = await resp.json();
                if (data.success) {
                    window.location.href = `/ProtonData?bagian=${encodeURIComponent(currentBagian)}&unit=${encodeURIComponent(currentUnit)}&trackId=${currentTrackId}`;
                } else {
                    alert('Gagal menyimpan: ' + (data.message || 'Error tidak diketahui'));
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-save me-1"></i>Simpan Semua';
                }
            } catch (err) {
                alert('Terjadi kesalahan jaringan. Silakan coba lagi.');
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-save me-1"></i>Simpan Semua';
            }
        }

        // ---- Utilities ----
        function escHtml(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;');
        }
        function escAttr(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/"/g, '&quot;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        }

        // ---- Initial render ----
        if (isEditMode) {
            renderEditTable();
        } else {
            renderViewTable();
        }
    })();
</script>
}
